a:9:{s:6:"config";a:5:{s:10:"phpVersion";s:6:"5.6.24";s:10:"yiiVersion";s:6:"2.0.10";s:11:"application";a:5:{s:3:"yii";s:6:"2.0.10";s:4:"name";s:14:"My Application";s:7:"version";s:3:"1.0";s:3:"env";s:3:"dev";s:5:"debug";b:1;}s:3:"php";a:5:{s:7:"version";s:6:"5.6.24";s:6:"xdebug";b:0;s:3:"apc";b:0;s:8:"memcache";b:0;s:9:"memcached";b:0;}s:10:"extensions";a:39:{s:30:"kartik-v/yii2-widget-typeahead";a:3:{s:4:"name";s:30:"kartik-v/yii2-widget-typeahead";s:7:"version";s:7:"1.0.1.0";s:5:"alias";a:1:{s:17:"@kartik/typeahead";s:59:"D:\xampp\htdocs\dhdc2\vendor/kartik-v/yii2-widget-typeahead";}}s:28:"kartik-v/yii2-widget-spinner";a:3:{s:4:"name";s:28:"kartik-v/yii2-widget-spinner";s:7:"version";s:7:"1.0.0.0";s:5:"alias";a:1:{s:15:"@kartik/spinner";s:57:"D:\xampp\htdocs\dhdc2\vendor/kartik-v/yii2-widget-spinner";}}s:28:"kartik-v/yii2-widget-sidenav";a:3:{s:4:"name";s:28:"kartik-v/yii2-widget-sidenav";s:7:"version";s:7:"1.0.0.0";s:5:"alias";a:1:{s:15:"@kartik/sidenav";s:57:"D:\xampp\htdocs\dhdc2\vendor/kartik-v/yii2-widget-sidenav";}}s:31:"kartik-v/yii2-widget-rangeinput";a:3:{s:4:"name";s:31:"kartik-v/yii2-widget-rangeinput";s:7:"version";s:7:"1.0.1.0";s:5:"alias";a:1:{s:13:"@kartik/range";s:60:"D:\xampp\htdocs\dhdc2\vendor/kartik-v/yii2-widget-rangeinput";}}s:26:"kartik-v/yii2-widget-growl";a:3:{s:4:"name";s:26:"kartik-v/yii2-widget-growl";s:7:"version";s:7:"1.1.1.0";s:5:"alias";a:1:{s:13:"@kartik/growl";s:55:"D:\xampp\htdocs\dhdc2\vendor/kartik-v/yii2-widget-growl";}}s:28:"kartik-v/yii2-widget-depdrop";a:3:{s:4:"name";s:28:"kartik-v/yii2-widget-depdrop";s:7:"version";s:7:"1.0.1.0";s:5:"alias";a:1:{s:15:"@kartik/depdrop";s:57:"D:\xampp\htdocs\dhdc2\vendor/kartik-v/yii2-widget-depdrop";}}s:26:"kartik-v/yii2-widget-alert";a:3:{s:4:"name";s:26:"kartik-v/yii2-widget-alert";s:7:"version";s:7:"1.1.0.0";s:5:"alias";a:1:{s:13:"@kartik/alert";s:55:"D:\xampp\htdocs\dhdc2\vendor/kartik-v/yii2-widget-alert";}}s:26:"kartik-v/yii2-widget-affix";a:3:{s:4:"name";s:26:"kartik-v/yii2-widget-affix";s:7:"version";s:7:"1.0.0.0";s:5:"alias";a:1:{s:13:"@kartik/affix";s:55:"D:\xampp\htdocs\dhdc2\vendor/kartik-v/yii2-widget-affix";}}s:21:"kartik-v/yii2-widgets";a:3:{s:4:"name";s:21:"kartik-v/yii2-widgets";s:7:"version";s:7:"3.4.0.0";s:5:"alias";a:1:{s:15:"@kartik/widgets";s:50:"D:\xampp\htdocs\dhdc2\vendor/kartik-v/yii2-widgets";}}s:18:"yiisoft/yii2-faker";a:3:{s:4:"name";s:18:"yiisoft/yii2-faker";s:7:"version";s:7:"2.0.3.0";s:5:"alias";a:1:{s:10:"@yii/faker";s:47:"D:\xampp\htdocs\dhdc2\vendor/yiisoft/yii2-faker";}}s:30:"scotthuangzl/yii2-google-chart";a:3:{s:4:"name";s:30:"scotthuangzl/yii2-google-chart";s:7:"version";s:11:"9999999-dev";s:5:"alias";a:1:{s:25:"@scotthuangzl/googlechart";s:59:"D:\xampp\htdocs\dhdc2\vendor/scotthuangzl/yii2-google-chart";}}s:24:"yiisoft/yii2-swiftmailer";a:3:{s:4:"name";s:24:"yiisoft/yii2-swiftmailer";s:7:"version";s:7:"2.0.6.0";s:5:"alias";a:1:{s:16:"@yii/swiftmailer";s:53:"D:\xampp\htdocs\dhdc2\vendor/yiisoft/yii2-swiftmailer";}}s:22:"yiisoft/yii2-bootstrap";a:3:{s:4:"name";s:22:"yiisoft/yii2-bootstrap";s:7:"version";s:7:"2.0.6.0";s:5:"alias";a:1:{s:14:"@yii/bootstrap";s:51:"D:\xampp\htdocs\dhdc2\vendor/yiisoft/yii2-bootstrap";}}s:25:"kartik-v/yii2-krajee-base";a:3:{s:4:"name";s:25:"kartik-v/yii2-krajee-base";s:7:"version";s:11:"9999999-dev";s:5:"alias";a:1:{s:12:"@kartik/base";s:54:"D:\xampp\htdocs\dhdc2\vendor/kartik-v/yii2-krajee-base";}}s:31:"kartik-v/yii2-widget-timepicker";a:3:{s:4:"name";s:31:"kartik-v/yii2-widget-timepicker";s:7:"version";s:7:"1.0.1.0";s:5:"alias";a:1:{s:12:"@kartik/time";s:60:"D:\xampp\htdocs\dhdc2\vendor/kartik-v/yii2-widget-timepicker";}}s:17:"linslin/yii2-curl";a:3:{s:4:"name";s:17:"linslin/yii2-curl";s:7:"version";s:8:"1.0.10.0";s:5:"alias";a:1:{s:18:"@linslin/yii2/curl";s:46:"D:\xampp\htdocs\dhdc2\vendor/linslin/yii2-curl";}}s:24:"yiisoft/yii2-codeception";a:3:{s:4:"name";s:24:"yiisoft/yii2-codeception";s:7:"version";s:7:"2.0.5.0";s:5:"alias";a:1:{s:16:"@yii/codeception";s:53:"D:\xampp\htdocs\dhdc2\vendor/yiisoft/yii2-codeception";}}s:18:"yiisoft/yii2-debug";a:3:{s:4:"name";s:18:"yiisoft/yii2-debug";s:7:"version";s:7:"2.0.7.0";s:5:"alias";a:1:{s:10:"@yii/debug";s:47:"D:\xampp\htdocs\dhdc2\vendor/yiisoft/yii2-debug";}}s:16:"yiisoft/yii2-gii";a:3:{s:4:"name";s:16:"yiisoft/yii2-gii";s:7:"version";s:7:"2.0.5.0";s:5:"alias";a:1:{s:8:"@yii/gii";s:45:"D:\xampp\htdocs\dhdc2\vendor/yiisoft/yii2-gii";}}s:16:"yiisoft/yii2-jui";a:3:{s:4:"name";s:16:"yiisoft/yii2-jui";s:7:"version";s:7:"2.0.6.0";s:5:"alias";a:1:{s:8:"@yii/jui";s:45:"D:\xampp\htdocs\dhdc2\vendor/yiisoft/yii2-jui";}}s:31:"kartik-v/yii2-widget-activeform";a:3:{s:4:"name";s:31:"kartik-v/yii2-widget-activeform";s:7:"version";s:7:"1.4.8.0";s:5:"alias";a:1:{s:12:"@kartik/form";s:60:"D:\xampp\htdocs\dhdc2\vendor/kartik-v/yii2-widget-activeform";}}s:31:"kartik-v/yii2-widget-colorinput";a:3:{s:4:"name";s:31:"kartik-v/yii2-widget-colorinput";s:7:"version";s:7:"1.0.3.0";s:5:"alias";a:1:{s:13:"@kartik/color";s:60:"D:\xampp\htdocs\dhdc2\vendor/kartik-v/yii2-widget-colorinput";}}s:31:"kartik-v/yii2-widget-datepicker";a:3:{s:4:"name";s:31:"kartik-v/yii2-widget-datepicker";s:7:"version";s:7:"1.4.2.0";s:5:"alias";a:1:{s:12:"@kartik/date";s:60:"D:\xampp\htdocs\dhdc2\vendor/kartik-v/yii2-widget-datepicker";}}s:35:"kartik-v/yii2-widget-datetimepicker";a:3:{s:4:"name";s:35:"kartik-v/yii2-widget-datetimepicker";s:7:"version";s:7:"1.4.2.0";s:5:"alias";a:1:{s:16:"@kartik/datetime";s:64:"D:\xampp\htdocs\dhdc2\vendor/kartik-v/yii2-widget-datetimepicker";}}s:30:"kartik-v/yii2-widget-fileinput";a:3:{s:4:"name";s:30:"kartik-v/yii2-widget-fileinput";s:7:"version";s:7:"1.0.5.0";s:5:"alias";a:1:{s:12:"@kartik/file";s:59:"D:\xampp\htdocs\dhdc2\vendor/kartik-v/yii2-widget-fileinput";}}s:27:"kartik-v/yii2-widget-rating";a:3:{s:4:"name";s:27:"kartik-v/yii2-widget-rating";s:7:"version";s:7:"1.0.2.0";s:5:"alias";a:1:{s:14:"@kartik/rating";s:56:"D:\xampp\htdocs\dhdc2\vendor/kartik-v/yii2-widget-rating";}}s:28:"kartik-v/yii2-widget-select2";a:3:{s:4:"name";s:28:"kartik-v/yii2-widget-select2";s:7:"version";s:7:"2.0.8.0";s:5:"alias";a:1:{s:15:"@kartik/select2";s:57:"D:\xampp\htdocs\dhdc2\vendor/kartik-v/yii2-widget-select2";}}s:32:"kartik-v/yii2-widget-switchinput";a:3:{s:4:"name";s:32:"kartik-v/yii2-widget-switchinput";s:7:"version";s:7:"1.3.1.0";s:5:"alias";a:1:{s:19:"@kartik/switchinput";s:61:"D:\xampp\htdocs\dhdc2\vendor/kartik-v/yii2-widget-switchinput";}}s:30:"kartik-v/yii2-widget-touchspin";a:3:{s:4:"name";s:30:"kartik-v/yii2-widget-touchspin";s:7:"version";s:7:"1.2.1.0";s:5:"alias";a:1:{s:17:"@kartik/touchspin";s:59:"D:\xampp\htdocs\dhdc2\vendor/kartik-v/yii2-widget-touchspin";}}s:20:"kartik-v/yii2-tabs-x";a:3:{s:4:"name";s:20:"kartik-v/yii2-tabs-x";s:7:"version";s:11:"9999999-dev";s:5:"alias";a:1:{s:12:"@kartik/tabs";s:49:"D:\xampp\htdocs\dhdc2\vendor/kartik-v/yii2-tabs-x";}}s:20:"kartik-v/yii2-dialog";a:3:{s:4:"name";s:20:"kartik-v/yii2-dialog";s:7:"version";s:7:"1.0.1.0";s:5:"alias";a:1:{s:14:"@kartik/dialog";s:49:"D:\xampp\htdocs\dhdc2\vendor/kartik-v/yii2-dialog";}}s:19:"kartik-v/yii2-icons";a:3:{s:4:"name";s:19:"kartik-v/yii2-icons";s:7:"version";s:11:"9999999-dev";s:5:"alias";a:1:{s:13:"@kartik/icons";s:48:"D:\xampp\htdocs\dhdc2\vendor/kartik-v/yii2-icons";}}s:34:"miloschuman/yii2-highcharts-widget";a:3:{s:4:"name";s:34:"miloschuman/yii2-highcharts-widget";s:7:"version";s:11:"9999999-dev";s:5:"alias";a:1:{s:23:"@miloschuman/highcharts";s:67:"D:\xampp\htdocs\dhdc2\vendor/miloschuman/yii2-highcharts-widget/src";}}s:18:"kartik-v/yii2-mpdf";a:3:{s:4:"name";s:18:"kartik-v/yii2-mpdf";s:7:"version";s:11:"9999999-dev";s:5:"alias";a:1:{s:12:"@kartik/mpdf";s:47:"D:\xampp\htdocs\dhdc2\vendor/kartik-v/yii2-mpdf";}}s:18:"kartik-v/yii2-grid";a:3:{s:4:"name";s:18:"kartik-v/yii2-grid";s:7:"version";s:11:"9999999-dev";s:5:"alias";a:1:{s:12:"@kartik/grid";s:47:"D:\xampp\htdocs\dhdc2\vendor/kartik-v/yii2-grid";}}s:24:"yii2mod/yii2-array-query";a:3:{s:4:"name";s:24:"yii2mod/yii2-array-query";s:7:"version";s:7:"1.2.0.0";s:5:"alias";a:1:{s:14:"@yii2mod/query";s:53:"D:\xampp\htdocs\dhdc2\vendor/yii2mod/yii2-array-query";}}s:33:"2amigos/yii2-arrayquery-component";a:3:{s:4:"name";s:33:"2amigos/yii2-arrayquery-component";s:7:"version";s:7:"1.0.2.0";s:5:"alias";a:1:{s:21:"@dosamigos/arrayquery";s:66:"D:\xampp\htdocs\dhdc2\vendor/2amigos/yii2-arrayquery-component/src";}}s:22:"kartik-v/yii2-sortable";a:3:{s:4:"name";s:22:"kartik-v/yii2-sortable";s:7:"version";s:7:"1.2.0.0";s:5:"alias";a:1:{s:16:"@kartik/sortable";s:51:"D:\xampp\htdocs\dhdc2\vendor/kartik-v/yii2-sortable";}}s:22:"kartik-v/yii2-dynagrid";a:3:{s:4:"name";s:22:"kartik-v/yii2-dynagrid";s:7:"version";s:11:"9999999-dev";s:5:"alias";a:1:{s:16:"@kartik/dynagrid";s:51:"D:\xampp\htdocs\dhdc2\vendor/kartik-v/yii2-dynagrid";}}}}s:7:"request";a:14:{s:7:"flashes";a:0:{}s:10:"statusCode";i:500;s:14:"requestHeaders";a:10:{s:4:"host";s:14:"localhost:8000";s:10:"connection";s:10:"keep-alive";s:6:"accept";s:3:"*/*";s:12:"x-csrf-token";s:56:"bWVzMnRuUUEmSDpCHUMoBRk9OG0yPQMbXzBDZS0sNhUIIURBQENmEQ==";s:10:"user-agent";s:114:"Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36";s:16:"x-requested-with";s:14:"XMLHttpRequest";s:7:"referer";s:65:"http://localhost:8000/dhdc2/backend/web/index.php?r=hdcsql%2Fgate";s:15:"accept-encoding";s:23:"gzip, deflate, sdch, br";s:15:"accept-language";s:23:"en-US,en;q=0.8,th;q=0.6";s:6:"cookie";s:851:"_identity-frontend=d8813126e2c1576bed6e0eb5a437b64f68255a6b8b72015d77d3f4ffa391ef0da%3A2%3A%7Bi%3A0%3Bs%3A18%3A%22_identity-frontend%22%3Bi%3A1%3Bs%3A46%3A%22%5B2%2C%22hNwlkttkmrBwdlgn3XJtq5WhPS8n6Bse%22%2C2592000%5D%22%3B%7D; advanced-frontend=u727fq3ftd0l1q44sqdalukpb5; _csrf-frontend=90e14d1a942487ca5bcc83c46e045a59227eb5a8de82eb455320e9b553a8b844a%3A2%3A%7Bi%3A0%3Bs%3A14%3A%22_csrf-frontend%22%3Bi%3A1%3Bs%3A32%3A%22Q3QZ7FHEp0aHeFBSj5oBn96vXT1eJFsj%22%3B%7D; PHPSESSID=amrir95ev26imv4ssvskjchsd2; _identity=497dfe529d9d7d7be580aa7c13c4f7d3d1e750ea8d9e1de0d171812a2854078ba%3A2%3A%7Bi%3A0%3Bs%3A9%3A%22_identity%22%3Bi%3A1%3Bs%3A13%3A%22%5B65%2C%22%22%2C86400%5D%22%3B%7D; _csrf=d3b9d08041f3bd9dd57e89c3249b24ab931f5fa8f06e12b1e95c1ca1fb7ae602a%3A2%3A%7Bi%3A0%3Bs%3A5%3A%22_csrf%22%3Bi%3A1%3Bs%3A32%3A%22K-Ipi-yDtXK_FSRZ2U0WYBgTeD7s4-7P%22%3B%7D";}s:15:"responseHeaders";a:5:{s:12:"X-Powered-By";s:10:"PHP/5.6.24";s:12:"Content-Type";s:24:"text/html; charset=UTF-8";s:11:"X-Debug-Tag";s:13:"591bb50c4aa8e";s:16:"X-Debug-Duration";s:7:"122,718";s:12:"X-Debug-Link";s:71:"/dhdc2/backend/web/index.php?r=debug%2Fdefault%2Fview&tag=591bb50c4aa8e";}s:5:"route";s:11:"hdcsql/exec";s:6:"action";s:50:"backend\controllers\HdcsqlController::actionExec()";s:12:"actionParams";a:0:{}s:11:"requestBody";a:0:{}s:6:"SERVER";a:43:{s:7:"MIBDIRS";s:24:"D:/xampp/php/extras/mibs";s:10:"MYSQL_HOME";s:16:"\xampp\mysql\bin";s:12:"OPENSSL_CONF";s:31:"D:/xampp/apache/bin/openssl.cnf";s:20:"PHP_PEAR_SYSCONF_DIR";s:10:"\xampp\php";s:5:"PHPRC";s:10:"\xampp\php";s:3:"TMP";s:10:"\xampp\tmp";s:9:"HTTP_HOST";s:14:"localhost:8000";s:15:"HTTP_CONNECTION";s:10:"keep-alive";s:11:"HTTP_ACCEPT";s:3:"*/*";s:17:"HTTP_X_CSRF_TOKEN";s:56:"bWVzMnRuUUEmSDpCHUMoBRk9OG0yPQMbXzBDZS0sNhUIIURBQENmEQ==";s:15:"HTTP_USER_AGENT";s:114:"Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36";s:21:"HTTP_X_REQUESTED_WITH";s:14:"XMLHttpRequest";s:12:"HTTP_REFERER";s:65:"http://localhost:8000/dhdc2/backend/web/index.php?r=hdcsql%2Fgate";s:20:"HTTP_ACCEPT_ENCODING";s:23:"gzip, deflate, sdch, br";s:20:"HTTP_ACCEPT_LANGUAGE";s:23:"en-US,en;q=0.8,th;q=0.6";s:11:"HTTP_COOKIE";s:851:"_identity-frontend=d8813126e2c1576bed6e0eb5a437b64f68255a6b8b72015d77d3f4ffa391ef0da%3A2%3A%7Bi%3A0%3Bs%3A18%3A%22_identity-frontend%22%3Bi%3A1%3Bs%3A46%3A%22%5B2%2C%22hNwlkttkmrBwdlgn3XJtq5WhPS8n6Bse%22%2C2592000%5D%22%3B%7D; advanced-frontend=u727fq3ftd0l1q44sqdalukpb5; _csrf-frontend=90e14d1a942487ca5bcc83c46e045a59227eb5a8de82eb455320e9b553a8b844a%3A2%3A%7Bi%3A0%3Bs%3A14%3A%22_csrf-frontend%22%3Bi%3A1%3Bs%3A32%3A%22Q3QZ7FHEp0aHeFBSj5oBn96vXT1eJFsj%22%3B%7D; PHPSESSID=amrir95ev26imv4ssvskjchsd2; _identity=497dfe529d9d7d7be580aa7c13c4f7d3d1e750ea8d9e1de0d171812a2854078ba%3A2%3A%7Bi%3A0%3Bs%3A9%3A%22_identity%22%3Bi%3A1%3Bs%3A13%3A%22%5B65%2C%22%22%2C86400%5D%22%3B%7D; _csrf=d3b9d08041f3bd9dd57e89c3249b24ab931f5fa8f06e12b1e95c1ca1fb7ae602a%3A2%3A%7Bi%3A0%3Bs%3A5%3A%22_csrf%22%3Bi%3A1%3Bs%3A32%3A%22K-Ipi-yDtXK_FSRZ2U0WYBgTeD7s4-7P%22%3B%7D";s:4:"PATH";s:823:"C:\Program Files (x86)\Embarcadero\Studio\18.0\bin;C:\Users\Public\Documents\Embarcadero\Studio\18.0\Bpl;C:\Program Files (x86)\Embarcadero\Studio\18.0\bin64;C:\Users\Public\Documents\Embarcadero\Studio\18.0\Bpl\Win64;C:\ProgramData\Oracle\Java\javapath;C:\Windows\system32;C:\Windows;C:\Windows\System32\Wbem;C:\Windows\System32\WindowsPowerShell\v1.0\;C:\Program Files (x86)\NVIDIA Corporation\PhysX\Common;D:\composer\;C:\Program Files\Intel\WiFi\bin\;C:\Program Files\Common Files\Intel\WirelessCommon\;C:\Users\Public\Documents\RAD Studio\8.0\Bpl;D:\xampp\php\;D:\composer;C:\Users\JK2548\AppData\Local\atom\bin;C:\Program Files\Intel\WiFi\bin\;C:\Program Files\Common Files\Intel\WirelessCommon\;C:\Program Files (x86)\Embarcadero\RAD Studio\8.0\BPL;C:\Program Files (x86)\SSH Communications Security\SSH Secure Shell";s:10:"SystemRoot";s:10:"C:\Windows";s:7:"COMSPEC";s:27:"C:\Windows\system32\cmd.exe";s:7:"PATHEXT";s:53:".COM;.EXE;.BAT;.CMD;.VBS;.VBE;.JS;.JSE;.WSF;.WSH;.MSC";s:6:"WINDIR";s:10:"C:\Windows";s:16:"SERVER_SIGNATURE";s:97:"<address>Apache/2.4.23 (Win32) OpenSSL/1.0.2h PHP/5.6.24 Server at localhost Port 8000</address>
";s:15:"SERVER_SOFTWARE";s:47:"Apache/2.4.23 (Win32) OpenSSL/1.0.2h PHP/5.6.24";s:11:"SERVER_NAME";s:9:"localhost";s:11:"SERVER_ADDR";s:3:"::1";s:11:"SERVER_PORT";s:4:"8000";s:11:"REMOTE_ADDR";s:3:"::1";s:13:"DOCUMENT_ROOT";s:15:"D:/xampp/htdocs";s:14:"REQUEST_SCHEME";s:4:"http";s:14:"CONTEXT_PREFIX";s:0:"";s:21:"CONTEXT_DOCUMENT_ROOT";s:15:"D:/xampp/htdocs";s:12:"SERVER_ADMIN";s:20:"postmaster@localhost";s:15:"SCRIPT_FILENAME";s:43:"D:/xampp/htdocs/dhdc2/backend/web/index.php";s:11:"REMOTE_PORT";s:5:"50308";s:17:"GATEWAY_INTERFACE";s:7:"CGI/1.1";s:15:"SERVER_PROTOCOL";s:8:"HTTP/1.1";s:14:"REQUEST_METHOD";s:3:"GET";s:12:"QUERY_STRING";s:15:"r=hdcsql%2Fexec";s:11:"REQUEST_URI";s:44:"/dhdc2/backend/web/index.php?r=hdcsql%2Fexec";s:11:"SCRIPT_NAME";s:28:"/dhdc2/backend/web/index.php";s:8:"PHP_SELF";s:28:"/dhdc2/backend/web/index.php";s:18:"REQUEST_TIME_FLOAT";d:1494988044.26;s:12:"REQUEST_TIME";i:1494988044;}s:3:"GET";a:1:{s:1:"r";s:11:"hdcsql/exec";}s:4:"POST";a:0:{}s:6:"COOKIE";a:6:{s:18:"_identity-frontend";s:158:"d8813126e2c1576bed6e0eb5a437b64f68255a6b8b72015d77d3f4ffa391ef0da:2:{i:0;s:18:"_identity-frontend";i:1;s:46:"[2,"hNwlkttkmrBwdlgn3XJtq5WhPS8n6Bse",2592000]";}";s:17:"advanced-frontend";s:26:"u727fq3ftd0l1q44sqdalukpb5";s:14:"_csrf-frontend";s:140:"90e14d1a942487ca5bcc83c46e045a59227eb5a8de82eb455320e9b553a8b844a:2:{i:0;s:14:"_csrf-frontend";i:1;s:32:"Q3QZ7FHEp0aHeFBSj5oBn96vXT1eJFsj";}";s:9:"PHPSESSID";s:26:"amrir95ev26imv4ssvskjchsd2";s:9:"_identity";s:115:"497dfe529d9d7d7be580aa7c13c4f7d3d1e750ea8d9e1de0d171812a2854078ba:2:{i:0;s:9:"_identity";i:1;s:13:"[65,"",86400]";}";s:5:"_csrf";s:130:"d3b9d08041f3bd9dd57e89c3249b24ab931f5fa8f06e12b1e95c1ca1fb7ae602a:2:{i:0;s:5:"_csrf";i:1;s:32:"K-Ipi-yDtXK_FSRZ2U0WYBgTeD7s4-7P";}";}s:5:"FILES";a:0:{}s:7:"SESSION";a:0:{}}s:3:"log";a:1:{s:8:"messages";a:173:{i:0;a:5:{i:0;s:33:"Bootstrap with yii\log\Dispatcher";i:1;i:8;i:2;s:31:"yii\base\Application::bootstrap";i:3;d:1494988044.298806;i:4;a:0:{}}i:1;a:5:{i:0;s:21:"Loading module: debug";i:1;i:8;i:2;s:26:"yii\base\Module::getModule";i:3;d:1494988044.298806;i:4;a:0:{}}i:2;a:5:{i:0;s:44:"Bootstrap with yii\debug\Module::bootstrap()";i:1;i:8;i:2;s:31:"yii\base\Application::bootstrap";i:3;d:1494988044.3058059;i:4;a:0:{}}i:3;a:5:{i:0;s:19:"Loading module: gii";i:1;i:8;i:2;s:26:"yii\base\Module::getModule";i:3;d:1494988044.3068061;i:4;a:0:{}}i:4;a:5:{i:0;s:42:"Bootstrap with yii\gii\Module::bootstrap()";i:1;i:8;i:2;s:31:"yii\base\Application::bootstrap";i:3;d:1494988044.307806;i:4;a:0:{}}i:5;a:5:{i:0;s:56:"Pretty URL not enabled. Using default URL parsing logic.";i:1;i:8;i:2;s:32:"yii\web\UrlManager::parseRequest";i:3;d:1494988044.310806;i:4;a:0:{}}i:6;a:5:{i:0;s:30:"Route requested: 'hdcsql/exec'";i:1;i:8;i:2;s:34:"yii\web\Application::handleRequest";i:3;d:1494988044.310806;i:4;a:0:{}}i:7;a:5:{i:0;s:25:"Route to run: hdcsql/exec";i:1;i:8;i:2;s:30:"yii\base\Controller::runAction";i:3;d:1494988044.314806;i:4;a:0:{}}i:8;a:5:{i:0;s:66:"Running action: backend\controllers\HdcsqlController::actionExec()";i:1;i:8;i:2;s:36:"yii\base\InlineAction::runWithParams";i:3;d:1494988044.3158059;i:4;a:0:{}}i:9;a:5:{i:0;s:35:"SELECT * FROM `sys_process_running`";i:1;i:4;i:2;s:21:"yii\db\Command::query";i:3;d:1494988044.3318069;i:4;a:1:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:40;s:8:"function";s:3:"one";s:5:"class";s:18:"yii\db\ActiveQuery";s:4:"type";s:2:"->";}}}i:10;a:5:{i:0;s:68:"Opening DB connection: mysql:host=localhost;dbname=db_dhdc;port=3306";i:1;i:4;i:2;s:23:"yii\db\Connection::open";i:3;d:1494988044.3318069;i:4;a:1:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:40;s:8:"function";s:3:"one";s:5:"class";s:18:"yii\db\ActiveQuery";s:4:"type";s:2:"->";}}}i:15;a:5:{i:0;s:44:"SHOW FULL COLUMNS FROM `sys_process_running`";i:1;i:4;i:2;s:21:"yii\db\Command::query";i:3;d:1494988044.3474071;i:4;a:1:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:40;s:8:"function";s:3:"one";s:5:"class";s:18:"yii\db\ActiveQuery";s:4:"type";s:2:"->";}}}i:18;a:5:{i:0;s:625:"SELECT
    kcu.constraint_name,
    kcu.column_name,
    kcu.referenced_table_name,
    kcu.referenced_column_name
FROM information_schema.referential_constraints AS rc
JOIN information_schema.key_column_usage AS kcu ON
    (
        kcu.constraint_catalog = rc.constraint_catalog OR
        (kcu.constraint_catalog IS NULL AND rc.constraint_catalog IS NULL)
    ) AND
    kcu.constraint_schema = rc.constraint_schema AND
    kcu.constraint_name = rc.constraint_name
WHERE rc.constraint_schema = database() AND kcu.table_schema = database()
AND rc.table_name = 'sys_process_running' AND kcu.table_name = 'sys_process_running'";i:1;i:4;i:2;s:21:"yii\db\Command::query";i:3;d:1494988044.3474071;i:4;a:1:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:40;s:8:"function";s:3:"one";s:5:"class";s:18:"yii\db\ActiveQuery";s:4:"type";s:2:"->";}}}i:21;a:5:{i:0;s:335:" CREATE TABLE IF NOT EXISTS `sys_transform_all` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `t_name` varchar(100) DEFAULT NULL,
  `t_sql` longtext,
  `active` varchar(1) DEFAULT '1',
  `bycase` varchar(15) DEFAULT NULL,
  `version` varchar(14) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=MyISAM AUTO_INCREMENT=59 DEFAULT CHARSET=utf8; ";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988044.3474071;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:67;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:24;a:5:{i:0;s:27:"TRUNCATE sys_transform_all;";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988049.39604;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:71;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:27;a:5:{i:0;s:123:"INSERT INTO sys_transform_all (SELECT '',t.t_name,t.t_sql,t.active,t.bycase,t.version FROM sys_transform t  ORDER BY t.id);";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988049.4428401;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:73;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:30;a:5:{i:0;s:128:"INSERT INTO sys_transform_all (SELECT '',t.t_name,t.t_sql,t.active,t.bycase,t.version FROM sys_transform_plus t  ORDER BY t.id);";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988049.583241;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:75;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:33;a:5:{i:0;s:24:"SELECT DATABASE() as db;";i:1;i:4;i:2;s:21:"yii\db\Command::query";i:3;d:1494988049.676841;i:4;a:2:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:78;s:8:"function";s:8:"queryOne";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:36;a:5:{i:0;s:44:"select provcode from sys_config_main limit 1";i:1;i:4;i:2;s:21:"yii\db\Command::query";i:3;d:1494988049.676841;i:4;a:2:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:82;s:8:"function";s:8:"queryOne";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:39;a:5:{i:0;s:141:" select t.* from sys_transform_all t
WHERE  t.bycase NOT IN ('dbpop')
AND t.t_name NOT IN ('t_update_tb','count_43tables')
ORDER BY t.id ASC ";i:1;i:4;i:2;s:21:"yii\db\Command::query";i:3;d:1494988049.676841;i:4;a:2:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:90;s:8:"function";s:8:"queryAll";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:42;a:5:{i:0;s:33:"DROP PROCEDURE IF EXISTS t_person";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988049.692441;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:45;a:5:{i:0;s:14780:"CREATE PROCEDURE t_person()
 BEGIN 
SET @prov_c := '58';
SET @id :='3';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);

DROP TABLE IF EXISTS t_person_db;
CREATE TABLE t_person_db (
  HOSPCODE varchar(5) NOT NULL,
  CID varchar(13) DEFAULT NULL,
  PID varchar(15) NOT NULL,
  HID varchar(14) DEFAULT NULL,
  PRENAME varchar(3) NOT NULL DEFAULT '',
  NAME varchar(50) NOT NULL DEFAULT '',
  LNAME varchar(50) NOT NULL DEFAULT '',
  HN varchar(15) DEFAULT NULL,
  SEX varchar(1) NOT NULL DEFAULT '',
  BIRTH date NOT NULL DEFAULT '0000-00-00',
  MSTATUS char(1) DEFAULT NULL,
  OCCUPATION_OLD varchar(3) DEFAULT NULL,
  OCCUPATION_NEW varchar(4) DEFAULT NULL,
  RACE varchar(3) DEFAULT NULL,
  NATION varchar(3) NOT NULL DEFAULT '',
  RELIGION varchar(2) DEFAULT NULL,
  EDUCATION varchar(2) DEFAULT NULL,
  FSTATUS varchar(1) DEFAULT NULL,
  FATHER varchar(13) DEFAULT NULL,
  MOTHER varchar(13) DEFAULT NULL,
  COUPLE varchar(13) DEFAULT NULL,
  VSTATUS varchar(1) DEFAULT NULL,
  MOVEIN date DEFAULT NULL,
  DISCHARGE varchar(1) DEFAULT NULL,
  DDISCHARGE date DEFAULT NULL,
  ABOGROUP varchar(1) DEFAULT NULL,
  RHGROUP varchar(1) DEFAULT NULL,
  LABOR varchar(2) DEFAULT NULL,
  PASSPORT varchar(8) DEFAULT NULL,
  TYPEAREA varchar(1) NOT NULL DEFAULT '',
  D_UPDATE datetime NOT NULL DEFAULT '0000-00-00 00:00:00',
  check_hosp varchar(5) NOT NULL DEFAULT '',
  check_typearea varchar(1) NOT NULL DEFAULT '',
  addr varchar(100) DEFAULT NULL,
	vhid varchar(8) DEFAULT NULL,
  check_vhid varchar(8) DEFAULT NULL,
  maininscl varchar(5) DEFAULT NULL,
  inscl varchar(5) DEFAULT NULL,
	error_code varchar(255) DEFAULT NULL,
  PRIMARY KEY (HOSPCODE,PID),
	KEY (HOSPCODE,PID),
  KEY (HOSPCODE),
  KEY  (PID),
  KEY  (CID),
  KEY (TYPEAREA),
  KEY (check_typearea),
  KEY (vhid),
  KEY  (check_vhid),
  KEY (LABOR),
  KEY (NATION),
  KEY (BIRTH),
  KEY (error_code)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO t_person_db 
(
	HOSPCODE,CID,PID,HID,PRENAME,NAME,LNAME,HN,SEX,BIRTH,MSTATUS,OCCUPATION_OLD,OCCUPATION_NEW,RACE,NATION
	,RELIGION,EDUCATION,FSTATUS,FATHER,MOTHER,COUPLE,VSTATUS,MOVEIN,DISCHARGE,DDISCHARGE,ABOGROUP,RHGROUP,LABOR
	,PASSPORT,TYPEAREA,D_UPDATE,check_hosp,check_typearea,vhid,check_vhid,addr
)
(	SELECT SQL_BIG_RESULT 
				p.HOSPCODE,p.CID,p.PID,p.HID,p.PRENAME,p.NAME,p.LNAME,p.HN,p.SEX,p.BIRTH,p.MSTATUS,p.OCCUPATION_OLD,p.OCCUPATION_NEW
				,p.RACE,p.NATION,p.RELIGION,p.EDUCATION,p.FSTATUS,p.FATHER,p.MOTHER,p.COUPLE,p.VSTATUS,p.MOVEIN,p.DISCHARGE
				,p.DDISCHARGE,p.ABOGROUP,p.RHGROUP,p.LABOR,p.PASSPORT,p.TYPEAREA,p.D_UPDATE,p.HOSPCODE as check_hosp
				,p.TYPEAREA as check_typearea 
				,if(ho.CHANGWAT is not null,concat(ho.CHANGWAT,ho.AMPUR,ho.TAMBON,SUBSTR(CONCAT('00',ho.VILLAGE),-2)),null) as vhid
				,if(ho.CHANGWAT is not null,concat(ho.CHANGWAT,ho.AMPUR,ho.TAMBON,SUBSTR(CONCAT('00',ho.VILLAGE),-2)),null) as check_vhid
				,ho.house as addr
	FROM
		person as p 
		LEFT JOIN home ho ON p.HOSPCODE=ho.HOSPCODE AND p.HID=ho.HID
);


UPDATE t_person_db t,chospital h
			SET t.vhid=concat(h.provcode,h.distcode,h.subdistcode,SUBSTR(CONCAT('00',h.mu),-2))
			,t.check_vhid=concat(h.provcode,h.distcode,h.subdistcode,SUBSTR(CONCAT('00',h.mu),-2))
			,t.addr=h.address
WHERE t.hospcode=h.hoscode AND (t.vhid is null OR t.check_vhid is null) ;



UPDATE t_person_db 
SET error_code =IF(ISNULL(error_code),'PE0001',CONCAT(error_code,',','PE0001') ) 
WHERE  NATION in(99) AND DISCHARGE in(9) AND (cid is null or LENGTH(trim(cid))=0);

UPDATE t_person_db 
SET error_code =IF(ISNULL(error_code),'PE0002',CONCAT(error_code,',','PE0002') ) 
WHERE  NATION in(99) AND DISCHARGE in(9) AND mod11(cid)=0 AND (cid IS NOT null OR LENGTH(TRIM(cid)) >0 );


UPDATE t_person_db p LEFT JOIN chospital h ON p.HOSPCODE=h.hoscode 
SET error_code =IF(ISNULL(error_code),'PE0003',CONCAT(error_code,',','PE0003') ) 
WHERE  NATION in(99) AND DISCHARGE in(9) AND (
substr(cid,1,5) in(hoscode)
OR
CONCAT('0',substr(cid,2,5)) = CONCAT('0',hoscode)
);

UPDATE t_person_db p LEFT JOIN chospital h ON p.HOSPCODE=h.hoscode 
SET error_code =IF(ISNULL(error_code),'PE0004',CONCAT(error_code,',','PE0004') ) 
WHERE  NATION in(99) AND DISCHARGE in(9) 
AND (`NAME`  LIKE '%พม่า%' OR LNAME  LIKE '%พม่า%' 
					OR `NAME`  LIKE '%ลาว%' OR LNAME  LIKE '%ลาว%'  
				 OR `NAME`  LIKE '%เขมร%' OR LNAME  LIKE '%เขมร%'  
				 OR `NAME`  LIKE '%กัมพูชา%' OR LNAME  LIKE '%กัมพูชา%'  
				 OR `NAME`  LIKE '%มอญ%' OR LNAME  LIKE '%มอญ%'  
				 OR `NAME`  LIKE '%กระเหรี่ยง%' OR LNAME  LIKE '%กระเหรี่ยง%'  
				 OR `NAME`  LIKE '%กะเหรี่ยง%' OR LNAME  LIKE '%กะเหรี่ยง%'  
				 OR `NAME`  LIKE '%ญวน%' OR LNAME  LIKE '%ญวน%'  
				 OR `NAME`  LIKE '%อาข่า%' OR LNAME  LIKE '%อาข่า%'  
				 OR `NAME`  LIKE '%เวียดนาม%' OR LNAME  LIKE '%เวียดนาม%'  
				 OR `NAME`  LIKE '%ชาวเขา%' OR LNAME  LIKE '%ชาวเขา%'  
OR UPPER(`NAME`) REGEXP '^[A-Z]' OR UPPER(LNAME) REGEXP '^[A-Z]' 
				)
AND (
substr(cid,1,5) in(hoscode)
OR
CONCAT('0',substr(cid,2,5)) = CONCAT('0',hoscode)
);

UPDATE t_person_db p LEFT JOIN home h ON p.HOSPCODE=h.HOSPCODE AND p.HID=h.HID
SET error_code =IF(ISNULL(error_code),'PE0005',CONCAT(error_code,',','PE0005') ) 
WHERE   DISCHARGE in(9) AND TYPEAREA in(1,3) AND h.HOSPCODE is null;

UPDATE t_person_db 
SET error_code =IF(ISNULL(error_code),'PE0006',CONCAT(error_code,',','PE0006') ) 
WHERE   DISCHARGE in(9) AND (sex NOT in(1,2) OR sex is null);

UPDATE t_person_db 
SET error_code =IF(ISNULL(error_code),'PE0007',CONCAT(error_code,',','PE0007') ) 
WHERE   DISCHARGE in(9) AND TYPEAREA in(1,3)  
AND ( TIMESTAMPDIFF(year,BIRTH,NOW()) >100  
	OR BIRTH > NOW()  );

UPDATE t_person_db 
SET error_code =IF(ISNULL(error_code),'PE0008',CONCAT(error_code,',','PE0008') ) 
WHERE   DISCHARGE in(9) AND NATION NOT IN(99) AND (LENGTH(TRIM(LABOR)) =0   OR LABOR is null);

UPDATE t_person_db p LEFT JOIN chospital h ON p.HOSPCODE=h.hoscode 
SET error_code =IF(ISNULL(error_code),'PE0009',CONCAT(error_code,',','PE0009') ) 
WHERE   h.hoscode is null;

UPDATE t_person_db p 
SET error_code =IF(ISNULL(error_code),'PE0011',CONCAT(error_code,',','PE0011') ) 
WHERE   mstatus  in(6) AND  p.prename NOT BETWEEN 800 AND  959;

UPDATE t_person_db p 
SET error_code =IF(ISNULL(error_code),'PE0012',CONCAT(error_code,',','PE0012') ) 
WHERE   mstatus not in(6) AND (p.prename BETWEEN 800 AND 862 OR  p.prename BETWEEN 865 AND 959);

UPDATE t_person_db p 
SET error_code =IF(ISNULL(error_code),'PE0013',CONCAT(error_code,',','PE0013') ) 
WHERE   sex not in(1) AND (p.prename BETWEEN 800 AND 862 OR  p.prename BETWEEN 865 AND 959);

UPDATE t_person_db p 
SET error_code =IF(ISNULL(error_code),'PE0014',CONCAT(error_code,',','PE0014') ) 
WHERE  sex not in(1) AND mstatus  in(6);

DROP TABLE IF EXISTS t_person_cid;
CREATE TABLE t_person_cid (
  HOSPCODE varchar(5) NOT NULL DEFAULT '',
  CID varchar(13) not null,
  PID varchar(15) NOT NULL DEFAULT '',
  HID varchar(14) DEFAULT NULL,
  PRENAME varchar(3) NOT NULL DEFAULT '',
  NAME varchar(50) NOT NULL DEFAULT '',
  LNAME varchar(50) NOT NULL DEFAULT '',
  HN varchar(15) DEFAULT NULL,
  SEX varchar(1) NOT NULL DEFAULT '',
  BIRTH date NOT NULL DEFAULT '0000-00-00',
  MSTATUS char(1) DEFAULT NULL,
  OCCUPATION_OLD varchar(3) DEFAULT NULL,
  OCCUPATION_NEW varchar(4) DEFAULT NULL,
  RACE varchar(3) DEFAULT NULL,
  NATION varchar(3) NOT NULL DEFAULT '',
  RELIGION varchar(2) DEFAULT NULL,
  EDUCATION varchar(2) DEFAULT NULL,
  FSTATUS varchar(1) DEFAULT NULL,
  FATHER varchar(13) DEFAULT NULL,
  MOTHER varchar(13) DEFAULT NULL,
  COUPLE varchar(13) DEFAULT NULL,
  VSTATUS varchar(1) DEFAULT NULL,
  MOVEIN date DEFAULT NULL,
  DISCHARGE varchar(1) DEFAULT NULL,
  DDISCHARGE date DEFAULT NULL,
  ABOGROUP varchar(1) DEFAULT NULL,
  RHGROUP varchar(1) DEFAULT NULL,
  LABOR varchar(2) DEFAULT NULL,
  PASSPORT varchar(8) DEFAULT NULL,
  TYPEAREA varchar(1) NOT NULL DEFAULT '',
  D_UPDATE datetime NOT NULL DEFAULT '0000-00-00 00:00:00',
  check_hosp varchar(5) NOT NULL DEFAULT '',
  check_typearea varchar(1) NOT NULL DEFAULT '',
  vhid varchar(8) DEFAULT NULL,
  check_vhid varchar(8) DEFAULT NULL,
  maininscl varchar(5) DEFAULT NULL,
  inscl varchar(5) DEFAULT NULL,
  age_y int(3) DEFAULT NULL,
	addr varchar(100) DEFAULT NULL,
  PRIMARY KEY (CID),
  KEY HOSPCODE_PID (HOSPCODE,PID),
  KEY HOSPCODE (HOSPCODE),
  KEY PID (PID),
  KEY TYPEAREA (TYPEAREA),
  KEY vhid (vhid),
  KEY check_vhid (check_vhid),
  KEY check_typearea (check_typearea),
  KEY check_hosp (check_hosp),
  KEY BIRTH (BIRTH),
  KEY LABOR (LABOR),
  KEY NATION (NATION)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;


INSERT IGNORE INTO t_person_cid
(
		SELECT SQL_BIG_RESULT 
				p.HOSPCODE,p.CID,p.PID,p.HID,p.PRENAME,p.NAME,p.LNAME,p.HN,p.SEX,p.BIRTH
				,p.MSTATUS,p.OCCUPATION_OLD,p.OCCUPATION_NEW,p.RACE,p.NATION,p.RELIGION,p.EDUCATION,p.FSTATUS
				,p.FATHER,p.MOTHER,p.COUPLE,p.VSTATUS,p.MOVEIN,p.DISCHARGE
				,p.DDISCHARGE,p.ABOGROUP,p.RHGROUP,p.LABOR,p.PASSPORT,p.TYPEAREA,p.D_UPDATE,
				p.HOSPCODE as check_hosp	,p.TYPEAREA as check_typearea ,vhid,check_vhid,maininscl,inscl
				,age(DATE_FORMAT(CONCAT(@b_year,'0101'),'%Y%m%d'),birth,'y') as age_y,p.addr
				
		FROM
			t_person_db p
		WHERE LENGTH(TRIM(p.cid))=13 AND p.TYPEAREA in('1','3')
		ORDER BY  p.D_UPDATE DESC ,p.TYPEAREA ASC
);

INSERT IGNORE INTO t_person_cid
(
		SELECT SQL_BIG_RESULT 
				p.HOSPCODE,p.CID,p.PID,p.HID,p.PRENAME,p.NAME,p.LNAME,p.HN,p.SEX,p.BIRTH
				,p.MSTATUS,p.OCCUPATION_OLD,p.OCCUPATION_NEW,p.RACE,p.NATION,p.RELIGION,p.EDUCATION,p.FSTATUS
				,p.FATHER,p.MOTHER,p.COUPLE,p.VSTATUS,p.MOVEIN,p.DISCHARGE
				,p.DDISCHARGE,p.ABOGROUP,p.RHGROUP,p.LABOR,p.PASSPORT,p.TYPEAREA,p.D_UPDATE,
				p.HOSPCODE as check_hosp	,p.TYPEAREA as check_typearea ,vhid,check_vhid,maininscl,inscl
				,age(DATE_FORMAT(CONCAT(@b_year,'0101'),'%Y%m%d'),birth,'y') as age_y,p.addr
		FROM
			t_person_db p
		WHERE LENGTH(TRIM(p.cid))=13 AND p.TYPEAREA in('2','4','5')
		ORDER BY p.TYPEAREA ASC
);

#################################
UPDATE  t_person_db  pd INNER JOIN t_person_cid p ON pd.CID=p.CID 
LEFT JOIN address a ON pd.HOSPCODE=a.HOSPCODE AND pd.PID=a.PID
SET pd.error_code =IF(ISNULL(pd.error_code),'PE0015',CONCAT(pd.error_code,',','PE0015') ) 
WHERE  p.check_typearea in(4,5) AND p.DISCHARGE in(9) AND a.CHANGWAT in(@prov_c);

DROP TABLE IF EXISTS tmpz_error_person;
CREATE TABLE IF NOT EXISTS tmpz_error_person (error_name text ,KEY (hospcode,pid),KEY(cid),key(error_code) )
ENGINE=myisam DEFAULT CHARSET=utf8 as(
SELECT
HOSPCODE,PID,cid
,SUBSTRING_INDEX(p.error_code,',',1) error_code
,null as error_name
FROM t_person_db p WHERE 
error_code is not null
);
INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',2),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*2)+1 ;

INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',3),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*3)+2 ;
 
INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',4),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*4)+3 ;

INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',5),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*5)+4 ;

INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',6),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*6)+5 ;

INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',7),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*7)+6 ;

INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',8),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*8)+7 ;

INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',9),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*9)+8 ;

INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',10),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*10)+9 ;

INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',11),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*11)+10 ;

INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',12),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*12)+11 ;

INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',13),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*13)+12 ;

INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',14),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*14)+13 ;

INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',15),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*15)+14 ;

UPDATE tmpz_error_person p INNER JOIN cerror_new c ON p.error_code=c.err_code 
SET p.error_name=c.err_name;

DROP TABLE IF EXISTS tmp_exchange_person;
CREATE TABLE IF NOT EXISTS tmp_exchange_person (error_code VARCHAR(255),KEY (hospcode,pid),KEY(cid),KEY(error_code))
ENGINE=myisam DEFAULT CHARSET=utf8 as(
SELECT
HOSPCODE,PID,cid,GROUP_CONCAT(error_code separator ' :: ') error_code, GROUP_CONCAT(error_name separator ' :: ') error_name
FROM tmpz_error_person 
GROUP BY HOSPCODE,PID
);
DROP TABLE IF EXISTS tmpz_error_person;


 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988049.7392409;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:48;a:5:{i:0;s:37:"DROP PROCEDURE IF EXISTS t_person_anc";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988049.8484409;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:51;a:5:{i:0;s:5429:"CREATE PROCEDURE t_person_anc()
 BEGIN 
SET @prov_c := '58';
SET @id := '4';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
SET	@date_3:=concat(@b_year-2,'1001');

DROP TABLE IF EXISTS tmp_anc;

CREATE TABLE IF NOT EXISTS tmp_anc (
KEY (cid),
KEY (hospcode,pid),
KEY (date_serv),
KEY (ga),
KEY (gravida)
)ENGINE=MyISAM  AS(
SELECT  SQL_BIG_RESULT 
		tt.HOSPCODE,tt.PID,tt.SEQ,tt.DATE_SERV,tt.GRAVIDA,tt.ancno,tt.GA,tt.ANCRESULT,tt.ANCPLACE,tt.PROVIDER,tt.D_UPDATE,pe.cid,pe.nation,pe.birth,pe.sex
FROM
			anc tt LEFT JOIN person pe ON tt.HOSPCODE=pe.HOSPCODE AND tt.pid=pe.pid 
WHERE
		tt.date_serv BETWEEN @date_3 AND @end_d
);

DROP TABLE IF EXISTS tmp_labor;
CREATE TABLE IF NOT EXISTS tmp_labor (
KEY (cid),
KEY (hospcode,pid),
KEY (bdate)
) ENGINE=MyISAM  AS(
SELECT  SQL_BIG_RESULT 
		lb.*,pe.cid,pe.birth,age(lb.bdate,pe.birth,'y') as age_y
FROM
			labor lb  LEFT JOIN person pe ON lb.HOSPCODE=pe.HOSPCODE AND lb.pid=pe.pid 
WHERE
		 lb.bdate BETWEEN @date_3 AND @end_d
);

DROP TABLE IF EXISTS t_labor;
CREATE TABLE IF NOT EXISTS t_labor (
PRIMARY KEY (CID,BDATE)
) ENGINE=MyISAM  IGNORE AS
SELECT l.* FROM tmp_labor l INNER JOIN chospital h ON l.hospcode=h.hoscode WHERE  h.hostype in(5,6,7,11);

INSERT IGNORE t_labor (SELECT * FROM tmp_labor);



DROP TABLE IF EXISTS t_person_anc;

CREATE TABLE IF NOT EXISTS t_person_anc(
		id int(15) NOT NULL AUTO_INCREMENT
		,hospcode varchar(5) NOT NULL
	  ,pid varchar(15) NOT NULL 
		,typearea varchar(1) NOT NULL 
		,cid VARCHAR(13) NOT NULL
		,birth date
		,sex VARCHAR(1) DEFAULT NULL 
		,nation VARCHAR(3) DEFAULT NULL 
		,occupat_new VARCHAR(4) DEFAULT NULL 
		,gravida VARCHAR(2) DEFAULT NULL 
		,bdate date
		,bhosp VARCHAR(5) DEFAULT NULL
		,input_bhosp VARCHAR(5) DEFAULT NULL 
		,g1_ga VARCHAR(2) DEFAULT NULL 
		,g1_date date
		,g1_hospcode VARCHAR(5) DEFAULT NULL 
		,g1_input_hosp VARCHAR(5) DEFAULT NULL 
		
		,g2_ga VARCHAR(2) DEFAULT NULL 
		,g2_date date
		,g2_hospcode VARCHAR(5) DEFAULT NULL 
		,g2_input_hosp VARCHAR(5) DEFAULT NULL 

		,g3_ga VARCHAR(2) DEFAULT NULL 
		,g3_date date
		,g3_hospcode VARCHAR(5) DEFAULT NULL 
		,g3_input_hosp VARCHAR(5) DEFAULT NULL 

		,g4_ga VARCHAR(2) DEFAULT NULL 
		,g4_date date
		,g4_hospcode VARCHAR(5) DEFAULT NULL 
		,g4_input_hosp VARCHAR(5) DEFAULT NULL 

		,g5_ga VARCHAR(2) DEFAULT NULL 
		,g5_date date
		,g5_hospcode VARCHAR(5) DEFAULT NULL 
		,g5_input_hosp VARCHAR(5) DEFAULT NULL 
	
	,PRIMARY KEY (id)
	,KEY cid (cid)
,KEY  (hospcode)
,KEY  (pid)
,KEY  (typearea)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

TRUNCATE TABLE t_person_anc;

/*GROUP BY CID Gravida */
INSERT IGNORE INTO t_person_anc
(
hospcode,pid,typearea,cid,birth,sex,nation,occupat_new,gravida
)
(
SELECT	pe.hospcode,pe.pid,pe.check_typearea,pe.cid,pe.BIRTH,pe.SEX,pe.NATION,pe.OCCUPATION_NEW,tt.GRAVIDA
FROM		tmp_anc as tt LEFT JOIN t_person_cid as pe ON tt.CID=pe.CID 
WHERE	 tt.DATE_SERV BETWEEN @date_3 AND @end_d AND LENGTH(pe.cid) = 13
GROUP BY pe.CID,tt.GRAVIDA
ORDER BY  pe.CID
);

UPDATE t_person_anc a INNER JOIN
	(
	SELECT 			cid,date_serv ,gravida,ancplace,ga,hospcode
	FROM		tmp_anc	WHERE			ga <= 12 
	GROUP BY cid,gravida
	)	 as g ON a.cid=g.cid AND g.gravida=a.gravida
SET a.g1_ga= g.ga 		,a.g1_date=g.date_serv ,a.g1_hospcode =g.ancplace 			,a.g1_input_hosp= g.hospcode;

UPDATE t_person_anc a INNER JOIN
	(
	SELECT 	cid,date_serv ,gravida,ancplace,ga,hospcode
	FROM		tmp_anc	WHERE		ga BETWEEN 16 AND 20 
	GROUP BY cid,gravida
	)	 as g ON a.cid=g.cid AND g.gravida=a.gravida
SET a.g2_ga= g.ga  ,a.g2_date=g.date_serv 	,a.g2_hospcode =g.ancplace 		,a.g2_input_hosp= g.hospcode;

UPDATE t_person_anc a INNER JOIN
	(
	SELECT 	cid,date_serv ,gravida,ancplace,ga,hospcode
	FROM		tmp_anc	WHERE		ga BETWEEN 24 AND 28 
	GROUP BY cid,gravida
	)	 as g ON a.cid=g.cid AND g.gravida=a.gravida
SET a.g3_ga= g.ga  	,a.g3_date=g.date_serv 	,a.g3_hospcode =g.ancplace 		,a.g3_input_hosp= g.hospcode;

UPDATE t_person_anc a INNER JOIN
	(
	SELECT 	cid,date_serv ,gravida,ancplace,ga,hospcode
	FROM		tmp_anc	WHERE		 ga BETWEEN 30 AND 34 
	GROUP BY cid,gravida
	)	 as g ON a.cid=g.cid AND g.gravida=a.gravida
SET a.g4_ga= g.ga 	,a.g4_date=g.date_serv 		,a.g4_hospcode =g.ancplace 		,a.g4_input_hosp= g.hospcode;

UPDATE t_person_anc a INNER JOIN
	(	
  SELECT 			cid,date_serv ,gravida,ancplace,ga,hospcode
	FROM		tmp_anc	WHERE			ga BETWEEN 36 AND 40 
	GROUP BY cid,gravida
	)	 as g ON a.cid=g.cid AND g.gravida=a.gravida
SET a.g5_ga= g.ga  	,a.g5_date=g.date_serv 		,a.g5_hospcode =g.ancplace 		,a.g5_input_hosp= g.hospcode;

UPDATE t_person_anc a INNER JOIN
	(
	SELECT cid,bdate,gravida,bhosp,hospcode 	FROM	tmp_labor l INNER JOIN chospital h ON l.hospcode=h.hoscode AND h.hostype IN(5,6,7,11)
	WHERE	bdate BETWEEN @start_d AND @end_d AND  BHOSP=HOSPCODE
	GROUP BY cid,gravida
	)	 as g ON a.cid=g.cid AND g.gravida=a.gravida
SET a.bdate=g.bdate	,a.bhosp=g.bhosp	,a.input_bhosp=g.hospcode;

UPDATE t_person_anc a INNER JOIN
	(
	SELECT cid,bdate,gravida,bhosp,hospcode 	FROM	tmp_labor
	WHERE	bdate BETWEEN @start_d AND @end_d 
	GROUP BY cid,gravida
	)	 as g ON a.cid=g.cid AND g.gravida=a.gravida
SET a.bdate=g.bdate	,a.bhosp=g.bhosp	,a.input_bhosp=g.hospcode
WHERE ISNULL(a.bdate);


 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988049.9576409;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:54;a:5:{i:0;s:37:"DROP PROCEDURE IF EXISTS t_person_epi";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.035641;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:57;a:5:{i:0;s:17586:"CREATE PROCEDURE t_person_epi()
 BEGIN 
SET @prov_c := '58';
SET @id := '5';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
SET	@date_3:=concat(@b_year-14,'1001');

DROP TABLE IF EXISTS tmp_epi;
CREATE TABLE tmp_epi (
KEY (cid),
KEY (hospcode,pid),
KEY (vaccinetype)
) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		tt.HOSPCODE,tt.PID,tt.SEQ,tt.DATE_SERV,tt.VACCINETYPE,tt.VACCINEPLACE,tt.PROVIDER,tt.D_UPDATE,pe.cid
FROM
			epi tt LEFT JOIN  t_person_db pe ON tt.HOSPCODE=pe.HOSPCODE AND tt.pid=pe.pid 
WHERE
tt.date_serv BETWEEN @date_3 AND @end_d
);

DROP TABLE IF EXISTS tmp_newborn;
CREATE TABLE tmp_newborn (
KEY (cid),
KEY (hospcode,pid),
KEY (bweight)
) ENGINE=MyISAM  AS(
SELECT t.HOSPCODE,t.PID,t.MPID,t.GRAVIDA,t.GA,t.BDATE,t.BTIME,t.BPLACE,t.bhosp,t.BIRTHNO,t.btype
,t.bdoctor,t.BWEIGHT,t.ASPHYXIA,t.VITK,t.TSH,t.TSHRESULT,t.D_UPDATE
,p.CID,p.nation,p.sex,p.check_hosp,p.check_vhid,p.check_typearea,p.vhid,p.typearea
FROM		newborn t LEFT JOIN t_person_db p ON t.HOSPCODE=p.HOSPCODE AND t.pid=p.pid 
WHERE t.bdate BETWEEN @date_3 AND @end_d
);

DROP TABLE IF EXISTS tmp_nutrition;
CREATE TABLE tmp_nutrition (
error_code varchar(255) DEFAULT NULL,
KEY (cid),
KEY (hospcode,pid),
KEY (food,childdevelop)
) ENGINE=MyISAM  AS(
SELECT 
		t.HOSPCODE,t.PID,t.SEQ,t.DATE_SERV,t.NUTRITIONPLACE,t.WEIGHT,t.HEIGHT,t.HEADCIRCUM,t.CHILDDEVELOP,t.FOOD,t.BOTTLE,t.PROVIDER,t.D_UPDATE,pe.cid,null as error_code
FROM
			nutrition t LEFT JOIN t_person_db pe ON t.HOSPCODE=pe.HOSPCODE AND t.pid=pe.pid 
WHERE
t.date_serv BETWEEN @date_3 AND @end_d
);
UPDATE tmp_nutrition n INNER JOIN person p  ON n.HOSPCODE=p.HOSPCODE AND n.PID=p.PID
SET error_code =IF(ISNULL(n.error_code),'NU0001',CONCAT(n.error_code,',','NU0001') ) 
WHERE  DATE_SERV BETWEEN @start_d AND @end_d AND n.DATE_SERV < p.BIRTH;


DROP TABLE IF EXISTS t_person_epi;
CREATE TABLE IF NOT EXISTS t_person_epi (
		id int(15) NOT NULL AUTO_INCREMENT
		,hospcode varchar(5) NOT NULL
	  ,pid varchar(15) NOT NULL 
		,typearea varchar(1) NOT NULL 
		,vhid varchar(8) DEFAULT NULL 
		,cid VARCHAR(13) NOT NULL
		,birth date
		,sex VARCHAR(1) DEFAULT NULL 
		,nation VARCHAR(3) DEFAULT NULL 
		,bweight int(4) DEFAULT 0
		,bw_input_hosp VARCHAR(5) DEFAULT NULL 
		,food VARCHAR(1) DEFAULT NULL 
		,food_date date
		,food_input_hosp VARCHAR(5) DEFAULT NULL 

		,childdevelop VARCHAR(1) DEFAULT NULL 
		,childdevelop_date date
		,childdevelop_input_hosp VARCHAR(5) DEFAULT NULL 
		
		,bcg_date date
		,bcg_hospcode VARCHAR(5) DEFAULT NULL
		,bcg_input_hosp VARCHAR(5) DEFAULT NULL 

		,hbv1_date date
		,hbv1_hospcode VARCHAR(5) DEFAULT NULL
		,hbv1_input_hosp VARCHAR(5) DEFAULT NULL 
		,hbv2_date date
		,hbv2_hospcode VARCHAR(5) DEFAULT NULL
		,hbv2_input_hosp VARCHAR(5) DEFAULT NULL 
		,hbv3_date date
		,hbv3_hospcode VARCHAR(5) DEFAULT NULL
		,hbv3_input_hosp VARCHAR(5) DEFAULT NULL 
	
		,opv1_date date
		,opv1_hospcode VARCHAR(5) DEFAULT NULL
		,opv1_input_hosp VARCHAR(5) DEFAULT NULL 
		,opv2_date date
		,opv2_hospcode VARCHAR(5) DEFAULT NULL
		,opv2_input_hosp VARCHAR(5) DEFAULT NULL 
		,opv3_date date
		,opv3_hospcode VARCHAR(5) DEFAULT NULL
		,opv3_input_hosp VARCHAR(5) DEFAULT NULL 
		,opv4_date date
		,opv4_hospcode VARCHAR(5) DEFAULT NULL
		,opv4_input_hosp VARCHAR(5) DEFAULT NULL 
		,opv5_date date
		,opv5_hospcode VARCHAR(5) DEFAULT NULL
		,opv5_input_hosp VARCHAR(5) DEFAULT NULL 

		,opvs1_date date
		,opvs1_hospcode VARCHAR(5) DEFAULT NULL
		,opvs1_input_hosp VARCHAR(5) DEFAULT NULL 
		,opvs2_date date
		,opvs2_hospcode VARCHAR(5) DEFAULT NULL
		,opvs2_input_hosp VARCHAR(5) DEFAULT NULL 
		,opvs3_date date
		,opvs3_hospcode VARCHAR(5) DEFAULT NULL
		,opvs3_input_hosp VARCHAR(5) DEFAULT NULL 

		,dtp1_date date
		,dtp1_hospcode VARCHAR(5) DEFAULT NULL
		,dtp1_input_hosp VARCHAR(5) DEFAULT NULL 
		,dtp2_date date
		,dtp2_hospcode VARCHAR(5) DEFAULT NULL
		,dtp2_input_hosp VARCHAR(5) DEFAULT NULL 
		,dtp3_date date
		,dtp3_hospcode VARCHAR(5) DEFAULT NULL
		,dtp3_input_hosp VARCHAR(5) DEFAULT NULL 
		,dtp4_date date
		,dtp4_hospcode VARCHAR(5) DEFAULT NULL
		,dtp4_input_hosp VARCHAR(5) DEFAULT NULL 
		,dtp5_date date
		,dtp5_hospcode VARCHAR(5) DEFAULT NULL
		,dtp5_input_hosp VARCHAR(5) DEFAULT NULL 

		,bcgs_date date
		,bcgs_hospcode VARCHAR(5) DEFAULT NULL
		,bcgs_input_hosp VARCHAR(5) DEFAULT NULL 

		,dts1_date date
		,dts1_hospcode VARCHAR(5) DEFAULT NULL
		,dts1_input_hosp VARCHAR(5) DEFAULT NULL 
		,dts2_date date
		,dts2_hospcode VARCHAR(5) DEFAULT NULL
		,dts2_input_hosp VARCHAR(5) DEFAULT NULL 
		,dts3_date date
		,dts3_hospcode VARCHAR(5) DEFAULT NULL
		,dts3_input_hosp VARCHAR(5) DEFAULT NULL 
		,dts4_date date
		,dts4_hospcode VARCHAR(5) DEFAULT NULL
		,dts4_input_hosp VARCHAR(5) DEFAULT NULL 

		,je1_date date
		,je1_hospcode VARCHAR(5) DEFAULT NULL
		,je1_input_hosp VARCHAR(5) DEFAULT NULL 
		,je2_date date
		,je2_hospcode VARCHAR(5) DEFAULT NULL
		,je2_input_hosp VARCHAR(5) DEFAULT NULL 
		,je3_date date
		,je3_hospcode VARCHAR(5) DEFAULT NULL
		,je3_input_hosp VARCHAR(5) DEFAULT NULL 

		,j11_date date
		,j11_hospcode VARCHAR(5) DEFAULT NULL
		,j11_input_hosp VARCHAR(5) DEFAULT NULL 
		,j12_date date
		,j12_hospcode VARCHAR(5) DEFAULT NULL
		,j12_input_hosp VARCHAR(5) DEFAULT NULL 

		,mmr1_date date
		,mmr1_hospcode VARCHAR(5) DEFAULT NULL
		,mmr1_input_hosp VARCHAR(5) DEFAULT NULL 
		,mmr2_date date
		,mmr2_hospcode VARCHAR(5) DEFAULT NULL
		,mmr2_input_hosp VARCHAR(5) DEFAULT NULL 
		,mmrs_date date
		,mmrs_hospcode VARCHAR(5) DEFAULT NULL
		,mmrs_input_hosp VARCHAR(5) DEFAULT NULL 
		,mrs_date date
		,mrs_hospcode VARCHAR(5) DEFAULT NULL
		,mrs_input_hosp VARCHAR(5) DEFAULT NULL 
		,mrc_date date
		,mrc_hospcode VARCHAR(5) DEFAULT NULL
		,mrc_input_hosp VARCHAR(5) DEFAULT NULL 
		,mmrc_date date
		,mmrc_hospcode VARCHAR(5) DEFAULT NULL
		,mmrc_input_hosp VARCHAR(5) DEFAULT NULL 

		,hpv1_date date
		,hpv1_hospcode VARCHAR(5) DEFAULT NULL
		,hpv1_input_hosp VARCHAR(5) DEFAULT NULL 
		,hpv2_date date
		,hpv2_hospcode VARCHAR(5) DEFAULT NULL
		,hpv2_input_hosp VARCHAR(5) DEFAULT NULL 
		,hpv3_date date
		,hpv3_hospcode VARCHAR(5) DEFAULT NULL
		,hpv3_input_hosp VARCHAR(5) DEFAULT NULL 

		,ipv2_date date
		,ipv2_hospcode VARCHAR(5) DEFAULT NULL
		,ipv2_input_hosp VARCHAR(5) DEFAULT NULL 

		,rv21_date date
		,rv21_hospcode VARCHAR(5) DEFAULT NULL
		,rv21_input_hosp VARCHAR(5) DEFAULT NULL 
		,rv22_date date
		,rv22_hospcode VARCHAR(5) DEFAULT NULL
		,rv22_input_hosp VARCHAR(5) DEFAULT NULL 

		,rv31_date date
		,rv31_hospcode VARCHAR(5) DEFAULT NULL
		,rv31_input_hosp VARCHAR(5) DEFAULT NULL 
		,rv32_date date
		,rv32_hospcode VARCHAR(5) DEFAULT NULL
		,rv32_input_hosp VARCHAR(5) DEFAULT NULL 
		,rv33_date date
		,rv33_hospcode VARCHAR(5) DEFAULT NULL
		,rv33_input_hosp VARCHAR(5) DEFAULT NULL 


	,PRIMARY KEY (id)
	,KEY cid (cid)
,KEY  (hospcode)
,KEY  (typearea)

) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO t_person_epi (cid,hospcode,pid,typearea,BIRTH,SEX,NATION,vhid)
(	SELECT 
					pe.cid,pe.check_hosp,pe.pid,pe.check_typearea,pe.BIRTH,pe.SEX,pe.NATION,check_vhid
	FROM
					tmp_epi as tt
				LEFT JOIN t_person_cid as pe ON tt.CID=pe.CID
	WHERE pe.age_y < 14	
	GROUP BY pe.CID
);

/****BCG******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.bcg_date =e.DATE_SERV, p.bcg_hospcode =e.VACCINEPLACE, p.bcg_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('010');

/****HBV1******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.hbv1_date =e.DATE_SERV, p.hbv1_hospcode =e.VACCINEPLACE, p.hbv1_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('041','091','D51','H31');
/****HBV2******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.hbv2_date =e.DATE_SERV, p.hbv2_hospcode =e.VACCINEPLACE, p.hbv2_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('042','092','D52','H32');
/****HBV3******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.hbv3_date =e.DATE_SERV, p.hbv3_hospcode =e.VACCINEPLACE, p.hbv3_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('043','093','H33','D23','D53');

/****OPV1******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.opv1_date =e.DATE_SERV, p.opv1_hospcode =e.VACCINEPLACE, p.opv1_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('081','D31','D41','D51','I11');
/****OPV2******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.opv2_date =e.DATE_SERV, p.opv2_hospcode =e.VACCINEPLACE, p.opv2_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('082','D32','D42','D52','I12');
/****OPV3******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.opv3_date =e.DATE_SERV, p.opv3_hospcode =e.VACCINEPLACE, p.opv3_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('083','D33','D43','D53','I13');
/****OPV4******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.opv4_date =e.DATE_SERV, p.opv4_hospcode =e.VACCINEPLACE, p.opv4_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('084','D34','D44','D54','I14');
/****OPV5******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.opv5_date =e.DATE_SERV, p.opv5_hospcode =e.VACCINEPLACE, p.opv5_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('085','D35','D45','D55','I15');
/****OPVS1******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.opvs1_date =e.DATE_SERV, p.opvs1_hospcode =e.VACCINEPLACE, p.opvs1_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('086');
/****OPVS2******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.opvs2_date =e.DATE_SERV, p.opvs2_hospcode =e.VACCINEPLACE, p.opvs2_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('087');
/****OPVS3******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.opvs3_date =e.DATE_SERV, p.opvs3_hospcode =e.VACCINEPLACE, p.opvs3_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('088');

/****DTP1******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.dtp1_date =e.DATE_SERV, p.dtp1_hospcode =e.VACCINEPLACE, p.dtp1_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('031','091','D11','D21','D31','D41','D51');
/****DTP2******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.dtp2_date =e.DATE_SERV, p.dtp2_hospcode =e.VACCINEPLACE, p.dtp2_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('032','092','D12','D22','D32','D42','D52');
/****DTP3******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.dtp3_date =e.DATE_SERV, p.dtp3_hospcode =e.VACCINEPLACE, p.dtp3_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('033','093','D13','D23','D33','D43','D53');
/****DTP4******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.dtp4_date =e.DATE_SERV, p.dtp4_hospcode =e.VACCINEPLACE, p.dtp4_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('034','D14','D24','D34','D44','D54');
/****DTP5******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.dtp5_date =e.DATE_SERV, p.dtp5_hospcode =e.VACCINEPLACE, p.dtp5_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('035','D35','D45','D55');

/****BCGS******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.bcgs_date =e.DATE_SERV, p.bcgs_hospcode =e.VACCINEPLACE, p.bcgs_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('011');

/****DTS1******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.dts1_date =e.DATE_SERV, p.dts1_hospcode =e.VACCINEPLACE, p.dts1_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('021');
/****DTS2******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.dts2_date =e.DATE_SERV, p.dts2_hospcode =e.VACCINEPLACE, p.dts2_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('022');
/****DTS3******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.dts3_date =e.DATE_SERV, p.dts3_hospcode =e.VACCINEPLACE, p.dts3_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('023');
/****DTS4******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.dts4_date =e.DATE_SERV, p.dts4_hospcode =e.VACCINEPLACE, p.dts4_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('024');

/****JE1******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.je1_date =e.DATE_SERV, p.je1_hospcode =e.VACCINEPLACE, p.je1_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('051');
/****JE2******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.je2_date =e.DATE_SERV, p.je2_hospcode =e.VACCINEPLACE, p.je2_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('052');
/****JE3******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.je3_date =e.DATE_SERV, p.je3_hospcode =e.VACCINEPLACE, p.je3_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('053');

/****J11******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.j11_date =e.DATE_SERV, p.j11_hospcode =e.VACCINEPLACE, p.j11_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('J11');
/****J12******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.j12_date =e.DATE_SERV, p.j12_hospcode =e.VACCINEPLACE, p.j12_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('J12');

/****MMR1=MMR 9 เดือน******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.mmr1_date =e.DATE_SERV, p.mmr1_hospcode =e.VACCINEPLACE, p.mmr1_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('061','M11');
/****MMR2* 2ปี /หรือห่าง mmr1 6wks*****/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.mmr2_date =e.DATE_SERV, p.mmr2_hospcode =e.VACCINEPLACE, p.mmr2_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('073','M12');

/****MMRS ป1******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.mmrs_date =e.DATE_SERV, p.mmrs_hospcode =e.VACCINEPLACE, p.mmrs_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('072');
/****MRS ป1******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.mrs_date =e.DATE_SERV, p.mrs_hospcode =e.VACCINEPLACE, p.mrs_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('075');

/****MRC******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.mrc_date =e.DATE_SERV, p.mrc_hospcode =e.VACCINEPLACE, p.mrc_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('074');

/****MMRC******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.mmrc_date =e.DATE_SERV, p.mmrc_hospcode =e.VACCINEPLACE, p.mmrc_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('076');


/****HPV1******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.hpv1_date =e.DATE_SERV, p.hpv1_hospcode =e.VACCINEPLACE, p.hpv1_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('H31','310');
/****HPV2******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.hpv2_date =e.DATE_SERV, p.hpv2_hospcode =e.VACCINEPLACE, p.hpv2_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('H32','320');
/****HPV3******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.hpv3_date =e.DATE_SERV, p.hpv3_hospcode =e.VACCINEPLACE, p.hpv3_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('H33','311');

/****IPV2******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.ipv2_date =e.DATE_SERV, p.ipv2_hospcode =e.VACCINEPLACE, p.ipv2_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('401','D32','D42','D52','I12');

/****RV21******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.rv21_date =e.DATE_SERV, p.rv21_hospcode =e.VACCINEPLACE, p.rv21_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('R11');
/****RV22******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.rv22_date =e.DATE_SERV, p.rv22_hospcode =e.VACCINEPLACE, p.rv22_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('R12');
/****RV31******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.rv31_date =e.DATE_SERV, p.rv31_hospcode =e.VACCINEPLACE, p.rv31_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('R21');
/****RV32******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.rv32_date =e.DATE_SERV, p.rv32_hospcode =e.VACCINEPLACE, p.rv32_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('R22');
/****RV33******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.rv33_date =e.DATE_SERV, p.rv33_hospcode =e.VACCINEPLACE, p.rv33_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('R23');

/****food******/
UPDATE  t_person_epi p INNER JOIN (
	SELECT cid,food,DATE_SERV,hospcode FROM tmp_nutrition WHERE food in(1,2,3,4) ORDER BY CONCAT(cid,DATE_SERV) DESC 
) n ON p.cid=n.cid 
SET p.food_date =n.DATE_SERV, p.food =n.food, p.food_input_hosp =n.hospcode;
/****childdev******/
UPDATE  t_person_epi p INNER JOIN (
	SELECT cid,childdevelop,DATE_SERV,hospcode FROM tmp_nutrition WHERE childdevelop in(1,2,3) ORDER BY CONCAT(cid,DATE_SERV) DESC 
) n ON p.cid=n.cid 
SET p.childdevelop_date =n.DATE_SERV, p.childdevelop =n.childdevelop, p.childdevelop_input_hosp =n.hospcode;

/****newborn******/
UPDATE  t_person_epi p INNER JOIN 
(SELECT n.* FROM tmp_newborn  n INNER JOIN chospital h ON n.hospcode=h.hoscode 
WHERE h.hostype IN(5,6,7,11) AND n.HOSPCODE= n.BHOSP 
) n ON p.cid=n.cid 
SET p.bweight =n.BWEIGHT, p.bw_input_hosp =n.hospcode;

UPDATE  t_person_epi p INNER JOIN tmp_newborn  n ON p.cid=n.cid 
SET p.bweight =n.BWEIGHT, p.bw_input_hosp =n.hospcode
WHERE ISNULL(p.bweight);

 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.129241;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:60;a:5:{i:0;s:34:"DROP PROCEDURE IF EXISTS t_village";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.222842;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:63;a:5:{i:0;s:642:"CREATE PROCEDURE t_village()
 BEGIN 
SET @prov_c := '58';
SET @id := '6';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS t_village ;

CREATE TABLE t_village (
KEY (hospcode,vid)
) ENGINE=MyISAM  AS(

SELECT
*
FROM
(
	(SELECT 
		v.HOSPCODE,v.VID
	FROM
		village v
	GROUP BY v.HOSPCODE,v.VID
	)
	UNION
	(SELECT 
		v.HOSPCODE,CONCAT(h.provcode,h.distcode,h.subdistcode,'00')
	FROM
		village v ,chospital h
	WHERE v.HOSPCODE=h.hoscode
	GROUP BY v.HOSPCODE
	) 
) as vv
ORDER BY hospcode,vid
);


 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.2852421;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:66;a:5:{i:0;s:34:"DROP PROCEDURE IF EXISTS t_surveil";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.3476419;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:69;a:5:{i:0;s:2675:"CREATE PROCEDURE t_surveil()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '7';
SET @b_year:=IF(MONTH(NOW())=1 AND DAY(NOW())<=5,year(NOW())-1,year(NOW()));
SET @start_d:=concat(@b_year,'0101');
SET @end_d:=concat(@b_year,'1231');

DROP TABLE IF EXISTS t_surveil;
CREATE TABLE IF NOT EXISTS t_surveil (
  `hospcode` varchar(5) not null,
  `pid` varchar(15) not null,
  `cid` varchar(13) not null,
	`seq` varchar(16) not null,
	`fname` varchar(100) not null,
	`lname` varchar(100) not null,
	`sex` varchar(1) not null,
	`areacode` varchar(8) not null,
	`birth` date not null,
	`age_y` int(3) not null,
	`age_m` int(3) not null,
	`age_d` int(3) not null,
  `date_serv` date not null,
  `an` varchar(9) default null,
  `datetime_admit` datetime default null,
  `diagcode` varchar(6) not null,
  `diagcodelast` varchar(6) default null,
  `code506` varchar(2) not null,
  `code506last` varchar(2) default null,
  `illdate` date not null,
  `illhouse` varchar(75) default null,
  `ill_areacode` varchar(8) default null,
  `ptstatus` char(1) not null,
  `date_death` date default null,
  `groupname1560` varchar(50) default null,
	`groupname190` varchar(50) default null,		
	`groupname506` varchar(255) default null,  
	key (`hospcode`,`pid`,`seq`,`code506`),
	key (`code506`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO t_surveil
(
`hospcode`,`pid`,`cid`,`seq`,`fname`,`lname`,`sex`,`areacode`,`birth`
,`age_y`,`age_m`,`age_d`,`date_serv`,`an`,`datetime_admit`,`diagcode`
,`diagcodelast`,`code506`,`code506last`,`illdate`,`illhouse`,`ill_areacode`
,`ptstatus`,`date_death`,`groupname1560`,`groupname190`,`groupname506`
)
(
SELECT SQL_BIG_RESULT 
	t1.*,a.groupname1560,a.groupname190
	,if(l.group506code is not null,l.group506name
	,if(l.group506code is null,r.group506name,NULL
	))
FROM
(SELECT
	s.HOSPCODE,s.PID,p.CID,s.SEQ,p.`NAME` as fname,p.LNAME,p.SEX,concat(h.provcode,h.distcode,h.subdistcode,SUBSTR(CONCAT('00',h.mu),-2))
	,p.BIRTH,age(s.ILLDATE,p.BIRTH,'y') as yy ,age(s.ILLDATE,p.BIRTH,'m') as mm , age(s.ILLDATE,p.BIRTH,'d') as dd,s.DATE_SERV
	,s.AN,s.DATETIME_ADMIT,s.DIAGCODE,s.DIAGCODELAST,s.CODE506,s.CODE506LAST,s.ILLDATE,s.ILLHOUSE
	,CONCAT(s.ILLCHANGWAT,s.ILLAMPUR,s.ILLTAMBON,SUBSTR(CONCAT('00',s.ILLVILLAGE),-2)) as ill_areacode,s.PTSTATUS,s.DATE_DEATH
 
FROM
		surveillance s 
		LEFT JOIN t_person_db p  ON s.HOSPCODE=p.HOSPCODE AND s.PID=p.PID 
		LEFT JOIN chospital h ON  s.HOSPCODE=h.hoscode
WHERE 
 (s.DATE_SERV BETWEEN @start_d AND @end_d)
) as t1 ,cage a,cdisease506 r,cdisease506 l
WHERE  t1.yy=a.age AND t1.CODE506=r.group506code AND t1.CODE506LAST=l.group506code
);


 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.410042;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:72;a:5:{i:0;s:37:"DROP PROCEDURE IF EXISTS t_pt_surveil";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.4724419;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:75;a:5:{i:0;s:1648:"CREATE PROCEDURE t_pt_surveil()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '8';
SET @b_year:=IF(MONTH(NOW())=1 AND DAY(NOW())<=5,year(NOW())-1,year(NOW()));
SET @start_d:=concat(@b_year,'0101');
SET @end_d:=concat(@b_year,'1231');

#DROP TABLE IF EXISTS t_pt_surveil;
CREATE TABLE IF NOT EXISTS t_pt_surveil (
  `id` varchar(32) not null,
  `code506` varchar(2) not null,
	`groupname506` varchar(255) default null,  
  `hospcode` varchar(5) not null,
	`pt_areacode` varchar(8) not null,
	`sex` varchar(1) not null,
	`age_y` int(3) not null,
  `groupname1560` varchar(50) default null,
  `yymm` varchar(50) default null,
  `wks` int(2) default 0,
	`seq` int(9) default 0,
  `pid` int(9) default 0,
  `death` int(9) default 0,
	key (groupname506,hospcode,pt_areacode,sex,groupname1560,wks)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

DELETE FROM t_pt_surveil WHERE (SUBSTR(yymm,1,4)-543)=year(now());

INSERT IGNORE INTO t_pt_surveil
(
`id`,`code506`,`groupname506`,`hospcode`,`pt_areacode`,`sex`,`age_y`,`groupname1560`,`yymm`,`wks`,`seq`,`pid`,`death`)
(
SELECT  SQL_BIG_RESULT 
	@id,if(code506last is not null,code506last,if(code506last is null,code506,NULL)) as code506
	,groupname506,hospcode,ill_areacode,sex,age_y
	,groupname1560,CONCAT((DATE_FORMAT(illdate,'%Y')+543),DATE_FORMAT(illdate,'%m')) as yymm
	,epid_wks(epiddate,illdate)
	,COUNT(seq) as seq,COUNT(DISTINCT pid) as pid
	,SUM(CASE WHEN ptstatus=2 THEN 1 ELSE 0 END) as death
FROM
	t_surveil ,sys_config
WHERE
	SUBSTR(illdate,1,4) = @b_year
GROUP BY 
	groupname506,hospcode,areacode,sex,groupname1560,yymm
ORDER BY 
groupname506,hospcode
);
 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.534842;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:78;a:5:{i:0;s:41:"DROP PROCEDURE IF EXISTS t_person_sex_age";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.5972421;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:81;a:5:{i:0;s:7125:"CREATE PROCEDURE t_person_sex_age()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '9';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);

DROP TABLE IF EXISTS tmp_person_agegroup;

CREATE TABLE tmp_person_agegroup (
KEY (hospcode),
KEY (vhid)
) ENGINE=MyISAM  AS(
	SELECT SQL_BIG_RESULT 
			check_hosp as hospcode,check_vhid as vhid,sex,age_y as age
		,ca.groupcode190,ca.groupname190,ca.groupcode1560,ca.groupname1560,ca.groupcode060,ca.groupname060
		,ca.groupcode3560,ca.groupname3560
	FROM 
		t_person_cid p,cage ca
	WHERE
		ca.age=age_y AND p.check_typearea in(1,3)
		AND p.DISCHARGE=9 AND nation=99 
);


DROP TABLE IF EXISTS tmp_labor_agegroup;

CREATE TABLE tmp_labor_agegroup (
KEY (hospcode),
KEY (vhid)
) ENGINE=MyISAM  AS(
	SELECT SQL_BIG_RESULT 
			check_hosp as hospcode,check_vhid as vhid,sex,age_y as age
		,ca.groupcode190,ca.groupname190,ca.groupcode1560,ca.groupname1560,ca.groupcode060,ca.groupname060
		,ca.groupcode3560,ca.groupname3560
	FROM 
		t_person_cid p,cage ca
	WHERE
		ca.age=age_y AND p.check_typearea in(1,3)
		AND p.DISCHARGE=9 AND (p.labor >= 1 OR p.nation !='099')
);



DROP TABLE IF EXISTS t_person_sex_age190 ;

CREATE TABLE IF NOT EXISTS t_person_sex_age190  (
  `id` varchar(32) not null default '',
	`year` varchar(4) not null default '',
	`hospcode` varchar(5) not null default '',
  `areacode` varchar(8) not null default '',
  `sex` varchar(15) not null default '',
  `groupcode` int(2) not null default 0,
  `groupname` varchar(255) not null default '',
  `result` int(9) not null default 0,
  KEY `hospcode` (`hospcode`),
  KEY `areacode` (`areacode`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

#DELETE FROM t_person_sex_age190 WHERE year= year(now())+543;

INSERT INTO t_person_sex_age190
(
`id`,`year`,`hospcode`,`areacode`,`sex`,`groupcode`,`groupname`,`result`
)
(
	SELECT SQL_BIG_RESULT 
	@id as id,(@b_year+543) as year,ag.hospcode,ag.vhid,ag.sex,ag.groupcode,ag.groupname,ag.result
	FROM
			(SELECT
			hospcode,vhid,if(sex=1,'ชาย',if(sex=2,'หญิง','ระบุไม่ได้' )) as sex ,groupcode190 as groupcode,groupname190 as groupname,COUNT(*) as result
			FROM
			tmp_person_agegroup
			GROUP BY
			hospcode,vhid,sex,groupcode190 
			ORDER BY hospcode,vhid
			) as ag
);

DROP TABLE IF EXISTS t_labor_sex_age190 ;

CREATE TABLE IF NOT EXISTS t_labor_sex_age190 (
  `id` varchar(32) not null default '',
	`year` varchar(4) not null default '',
	`hospcode` varchar(5) not null default '',
  `areacode` varchar(8) not null default '',
  `sex` varchar(15) not null default '',
  `groupcode` int(2) not null default 0,
  `groupname` varchar(255) not null default '',
  `result` int(9) not null default 0,
  KEY `hospcode` (`hospcode`),
  KEY `areacode` (`areacode`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

#DELETE FROM t_labor_sex_age190 WHERE year= year(now())+543;

INSERT INTO t_labor_sex_age190
(
`id`,`year`,`hospcode`,`areacode`,`sex`,`groupcode`,`groupname`,`result`
)
(
	SELECT SQL_BIG_RESULT 
	@id as id,(@b_year+543) as year,ag.hospcode,ag.vhid,ag.sex,ag.groupcode,ag.groupname,ag.result
	FROM
			(SELECT
			hospcode,vhid,if(sex=1,'ชาย',if(sex=2,'หญิง','ระบุไม่ได้' )) as sex ,groupcode190 as groupcode,groupname190 as groupname,COUNT(*) as result
			FROM
			tmp_labor_agegroup
			GROUP BY
			hospcode,vhid,sex,groupcode190 
			ORDER BY hospcode,vhid
			) as ag
);


DROP TABLE IF EXISTS t_person_sex_age1560 ;

CREATE TABLE IF NOT EXISTS t_person_sex_age1560 (
  `id` varchar(32) not null default '',
	`year` varchar(4) not null default '',
	`hospcode` varchar(5) not null default '',
  `areacode` varchar(8) not null default '',
  `sex` varchar(15) not null default '',
  `groupcode` int(2) not null default 0,
  `groupname` varchar(255) not null default '',
  `result` int(9) not null default 0,
  KEY `hospcode` (`hospcode`),
  KEY `areacode` (`areacode`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

#DELETE FROM t_person_sex_age1560 WHERE year= year(now())+543;


INSERT INTO t_person_sex_age1560
(
`id`,`year`,`hospcode`,`areacode`,`sex`,`groupcode`,`groupname`,`result`
)
(
	SELECT SQL_BIG_RESULT 
	@id as id,(@b_year+543) as year,ag.hospcode,ag.vhid,ag.sex,ag.groupcode,ag.groupname,ag.result
	FROM
			(SELECT
			hospcode,vhid,if(sex=1,'ชาย',if(sex=2,'หญิง','ระบุไม่ได้' )) as sex ,groupcode1560 as groupcode ,groupname1560 as groupname,COUNT(*) as result
			FROM
			tmp_person_agegroup
			GROUP BY
			hospcode,vhid,sex,groupcode1560
			ORDER BY hospcode,vhid
			) as ag
);


DROP TABLE IF EXISTS t_person_sex_age060 ;

CREATE TABLE IF NOT EXISTS t_person_sex_age060 (
  `id` varchar(32) not null default '',
	`year` varchar(4) not null default '',
	`hospcode` varchar(5) not null default '',
  `areacode` varchar(8) not null default '',
  `sex` varchar(15) not null default '',
  `groupcode` int(2) not null default 0,
  `groupname` varchar(255) not null default '',
  `result` int(9) not null default 0,
  KEY `hospcode` (`hospcode`),
  KEY `areacode` (`areacode`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

#DELETE FROM t_person_sex_age060 WHERE year= year(now())+543;


INSERT INTO t_person_sex_age060
(
`id`,`year`,`hospcode`,`areacode`,`sex`,`groupcode`,`groupname`,`result`
)
(
	SELECT SQL_BIG_RESULT 
	@id as id,(@b_year+543) as year,ag.hospcode,ag.vhid,ag.sex,ag.groupcode,ag.groupname,ag.result
	FROM
			(SELECT
			hospcode,vhid,if(sex=1,'ชาย',if(sex=2,'หญิง','ระบุไม่ได้' )) as sex ,groupcode060 as groupcode ,groupname060 as groupname,COUNT(*) as result
			FROM
			tmp_person_agegroup
			GROUP BY
			hospcode,vhid,sex,groupcode060
			ORDER BY hospcode,vhid
			) as ag
);


DROP TABLE IF EXISTS t_person_sex_age3560 ;

CREATE TABLE IF NOT EXISTS t_person_sex_age3560 (
  `id` varchar(32) not null default '',
	`year` varchar(4) not null default '',
	`hospcode` varchar(5) not null default '',
  `areacode` varchar(8) not null default '',
  `sex` varchar(15) not null default '',
  `groupcode` int(2) not null default 0,
  `groupname` varchar(255) not null default '',
  `result` int(9) not null default 0,
  KEY `hospcode` (`hospcode`),
  KEY `areacode` (`areacode`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

#DELETE FROM t_person_sex_age3560 WHERE year= year(now())+543;


INSERT INTO t_person_sex_age3560
(
`id`,`year`,`hospcode`,`areacode`,`sex`,`groupcode`,`groupname`,`result`
)
(
	SELECT SQL_BIG_RESULT 
	@id as id,(@b_year+543) as year,ag.hospcode,ag.vhid,ag.sex,ag.groupcode,ag.groupname,ag.result
	FROM
			(SELECT
			hospcode,vhid,if(sex=1,'ชาย',if(sex=2,'หญิง','ระบุไม่ได้' )) as sex ,groupcode3560 as groupcode ,groupname3560 as groupname,COUNT(*) as result
			FROM
			tmp_person_agegroup
			GROUP BY
			hospcode,vhid,sex,groupcode3560
			ORDER BY hospcode,vhid
			) as ag
);

DROP TABLE IF EXISTS tmp_person_agegroup;
DROP TABLE IF EXISTS tmp_labor_agegroup;

 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.659642;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:84;a:5:{i:0;s:34:"DROP PROCEDURE IF EXISTS t_diagopd";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.7064431;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:87;a:5:{i:0;s:2357:"CREATE PROCEDURE t_diagopd()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '10';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'0701');
SET @end_d:=concat(@b_year,'0930');

DROP TABLES IF EXISTS tmp_diag_opd;
CREATE TABLE IF NOT EXISTS tmp_diag_opd (
KEY(cid),KEY(hospcode),KEY(pid),KEY(seq),KEY(date_serv),KEY(diagcode),KEY(diagtype),KEY(hospcode,pid,seq)
) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		o.*,p.CID
FROM
	diagnosis_opd o 
	LEFT JOIN t_person_db p ON o.HOSPCODE=p.HOSPCODE AND o.PID=p.PID
WHERE	DATE_SERV BETWEEN @start_d AND @end_d
);


DROP TABLES IF EXISTS tmp_procedure_opd;
CREATE TABLE IF NOT EXISTS tmp_procedure_opd(
KEY(cid),KEY(hospcode),KEY(pid),KEY(seq),KEY(date_serv),KEY(procedcode),KEY(hospcode,pid,seq),KEY(hospcode,pid,procedcode)
) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		o.HOSPCODE,o.PID,o.SEQ,o.DATE_SERV,o.CLINIC,o.PROCEDCODE,o.serviceprice,o.PROVIDER,o.D_UPDATE,p.CID
FROM
	procedure_opd o 
	LEFT JOIN t_person_db p ON o.HOSPCODE=p.HOSPCODE AND o.PID=p.PID
WHERE	DATE_SERV BETWEEN @start_d AND @end_d
);

DROP TABLES IF EXISTS tmp_diag_opd1;
CREATE TABLE IF NOT EXISTS tmp_diag_opd1 ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
	o.HOSPCODE,p.CID,p.SEX,p.BIRTH,age(o.DATE_SERV,p.BIRTH,'y') as age_y
	,p.NATION,SUBSTR(DATE_FORMAT(DATE_SERV,'%Y%m'),1,6) as yymm,o.diagcode,d.code298
FROM
	tmp_diag_opd o 
	LEFT JOIN cdisease d ON o.diagcode=d.diagcode
	LEFT JOIN t_person_db p ON o.hospcode=p.hospcode AND o.pid=p.pid
WHERE o.diagtype in('1')
);

DROP TABLES IF EXISTS t_diag_opd;
CREATE TABLE IF NOT EXISTS t_diag_opd ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
	o.HOSPCODE,concat(h.provcode,h.distcode,h.subdistcode,SUBSTR(CONCAT('00',h.mu),-2)) as areacode,o.CID,o.SEX,age_y,o.NATION,o.yymm,o.diagcode
	,o.code298,groupcode190,groupcode1560,groupcode060,groupcode3560
FROM
	tmp_diag_opd1 o 
	LEFT JOIN cage c ON o.age_y=c.age
	LEFT JOIN chospital h ON o.hospcode=h.hoscode
WHERE h.provcode =@prov_c
);

DROP TABLES IF EXISTS t_diag_opd_sex;
CREATE TABLE IF NOT EXISTS t_diag_opd_sex ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
	hospcode,areacode, sex,code298,COUNT(*) as result
FROM 
	t_diag_opd 
GROUP BY 
hospcode,areacode,sex,code298
);

DROP TABLES IF EXISTS tmp_diag_opd1;
#DROP TABLES IF EXISTS tmp_diag_opd;
 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.7688429;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:90;a:5:{i:0;s:34:"DROP PROCEDURE IF EXISTS t_diagipd";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.831243;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:93;a:5:{i:0;s:2498:"CREATE PROCEDURE t_diagipd()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '11';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLES IF EXISTS tmp_diag_ipd;
CREATE TABLE IF NOT EXISTS tmp_diag_ipd (
KEY(cid), KEY(hospcode), KEY(datetime_admit), KEY(datetime_disch), KEY(diagcode), KEY(diagtype),KEY(an),KEY(hospcode,an)
)ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		i.*,p.CID,a.datetime_disch
FROM
	diagnosis_ipd i 
	LEFT JOIN t_person_db p ON  i.HOSPCODE=p.HOSPCODE AND i.PID=p.PID
	LEFT JOIN admission a ON i.HOSPCODE=a.HOSPCODE AND i.pid=a.pid AND i.an=a.an
WHERE	(DATE_FORMAT(i.DATETIME_ADMIT,'%Y%m%d') BETWEEN @start_d AND @end_d OR DATE_FORMAT(a.DATETIME_DISCH,'%Y%m%d') BETWEEN @start_d AND @end_d)
);



DROP TABLES IF EXISTS tmp_procedure_ipd;
CREATE TABLE IF NOT EXISTS tmp_procedure_ipd (
KEY(cid), KEY(hospcode), KEY(datetime_admit), KEY(procedcode) ,KEY(an),KEY(hospcode,an),KEY(hospcode,an,procedcode)
) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		i.*,p.CID
FROM
	procedure_ipd i 
	LEFT JOIN t_person_db p ON i.HOSPCODE=p.HOSPCODE AND i.PID=p.PID
WHERE	DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d') BETWEEN @start_d AND @end_d
);

DROP TABLES IF EXISTS tmp_diag_ipd1;
CREATE TABLE IF NOT EXISTS tmp_diag_ipd1 ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
	o.HOSPCODE,p.CID,p.SEX,p.BIRTH,age(o.DATETIME_DISCH,p.BIRTH,'y') as age_y
	,p.NATION,SUBSTR(DATE_FORMAT(DATETIME_DISCH,'%Y%m'),1,6) as yymm,o.diagcode,d.code298
FROM
	tmp_diag_ipd o LEFT JOIN cdisease d ON o.diagcode=d.diagcode 
  LEFT JOIN t_person_db p ON o.hospcode=p.hospcode AND o.pid=p.pid
WHERE o.diagtype in('1')
);

DROP TABLES IF EXISTS t_diag_ipd;
CREATE TABLE IF NOT EXISTS t_diag_ipd ENGINE=MyISAM  AS(
SELECT
	o.HOSPCODE,concat(h.provcode,h.distcode,h.subdistcode,SUBSTR(CONCAT('00',h.mu),-2)) as areacode,o.CID,o.SEX,age_y,o.NATION,o.yymm,o.diagcode
	,o.code298,groupcode190,groupcode1560,groupcode060,groupcode3560
FROM
	tmp_diag_ipd1 o 
	LEFT JOIN cage c ON o.age_y=c.age
  LEFT JOIN chospital h ON o.hospcode=h.hoscode
WHERE h.provcode =@prov_c
);

DROP TABLES IF EXISTS t_diag_ipd_sex;
CREATE TABLE IF NOT EXISTS t_diag_ipd_sex ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
	hospcode,areacode, sex,code298,COUNT(*) as result
FROM 
	t_diag_ipd 
GROUP BY 
hospcode,areacode,sex,code298
);

DROP TABLES IF EXISTS tmp_diag_ipd1;
#DROP TABLES IF EXISTS tmp_diag_ipd;

 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.8780429;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:96;a:5:{i:0;s:34:"DROP PROCEDURE IF EXISTS t_chronic";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.9248431;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:99;a:5:{i:0;s:5259:"CREATE PROCEDURE t_chronic()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '12';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'0701');
SET @end_d:=concat(@b_year,'0930');


DROP TABLES IF EXISTS tmp_chronic;

CREATE TABLE IF NOT EXISTS tmp_chronic (
KEY(cid),
KEY(chronic)
) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		c.*,p.CID
FROM
		chronic c
		INNER JOIN t_person_db  p on p.HOSPCODE=c.HOSPCODE AND p.PID=c.PID
WHERE 
	c.CHRONIC in(SELECT id_chronic FROM cchronic )
  AND c.typedisch between 1 and 9
ORDER BY c.DATE_DIAG
);

DROP TABLES IF EXISTS tmp_chronic_opd;
CREATE TABLE IF NOT EXISTS tmp_chronic_opd (
KEY(cid),
KEY(diagcode)
) ENGINE=MyISAM  AS(
SELECT
		c.*
FROM
	tmp_diag_opd c
WHERE c.DATE_SERV BETWEEN @start_d AND @end_d
	AND c.DIAGCODE in(SELECT id_chronic FROM cchronic )
GROUP BY c.HOSPCODE,c.PID,c.DIAGCODE
ORDER BY c.DATE_SERV
);

DROP TABLES IF EXISTS tmp_chronic_ipd;
CREATE TABLE IF NOT EXISTS tmp_chronic_ipd (
KEY(cid),
KEY(diagcode)
) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		c.*
FROM
	tmp_diag_ipd c
WHERE DATE_FORMAT(c.DATETIME_ADMIT,'%Y%m%d') BETWEEN @start_d AND @end_d
		AND c.DIAGCODE in(SELECT id_chronic FROM cchronic )
GROUP BY c.HOSPCODE,c.PID,c.DIAGCODE
ORDER BY DATETIME_ADMIT
);


DROP TABLES IF EXISTS t_chronic;
CREATE TABLE IF NOT EXISTS t_chronic(
		cid VARCHAR(13) NOT NULL
		,birth date
		,age_y INT(3) DEFAULT 0
		,age_y_dx INT(3) DEFAULT 0
		,groupcode INT(3) DEFAULT 0
		,sex VARCHAR(1) DEFAULT NULL 
		,nation VARCHAR(3) DEFAULT NULL 
		,p_hospcode VARCHAR(5) DEFAULT NULL 
		,d_hospcode VARCHAR(5) DEFAULT NULL 
		,p_pt_vhid VARCHAR(8) DEFAULT NULL 
		,d_pt_vhid VARCHAR(8) DEFAULT NULL 
		,p_typearea VARCHAR(1) DEFAULT NULL 
		,d_typearea VARCHAR(1) DEFAULT NULL 
		,input_hosp VARCHAR(5) DEFAULT NULL 
		,input_pid VARCHAR(15) DEFAULT NULL 
		,source_tb VARCHAR(20) DEFAULT NULL 
		,diagcode VARCHAR(10) NOT NULL
		,date_dx date DEFAULT NULL 
		,hosp_dx VARCHAR(5) DEFAULT NULL 
		,hosp_rx VARCHAR(5) DEFAULT NULL 
		,typedisch VARCHAR(2) DEFAULT NULL 
		,datedisch date DEFAULT NULL 
		,minscl VARCHAR(5) DEFAULT NULL 
		,inscl VARCHAR(3) DEFAULT NULL 
	,PRIMARY KEY (cid,diagcode)
	,KEY (cid)
	,KEY (diagcode)

) ENGINE=MyISAM DEFAULT CHARSET=utf8;

/*import from chronic*/
INSERT IGNORE INTO t_chronic
(
	cid,birth,age_y,age_y_dx,sex,nation,p_hospcode,d_hospcode,p_pt_vhid,d_pt_vhid
	,p_typearea,d_typearea,input_hosp,input_pid,source_tb,diagcode,date_dx
	,hosp_dx,hosp_rx,typedisch,datedisch,minscl,inscl
)
(
SELECT SQL_BIG_RESULT 
	p.CID,p.BIRTH,age(NOW(),p.BIRTH,'y'),age(t.date_diag,p.BIRTH,'y'),p.SEX,p.NATION
	,p.HOSPCODE,p.check_hosp,p.vhid,p.check_vhid,p.TYPEAREA,p.check_typearea
	,t.hosp_input,t.pid_input,t.pt_from,t.diagcode,t.date_diag,t.hosp_dx,t.hosp_rx,t.typedisch,t.datedisch
	,p.maininscl,p.inscl

FROM
	(     SELECT
			c.cid,c.HOSPCODE as hosp_input,c.pid as pid_input,date_diag,c.CHRONIC as diagcode
			,IFNULL(c.HOSP_DX,'00000') as HOSP_DX,c.HOSP_RX,c.TYPEDISCH,c.DATE_DISCH as datedisch,'chronic' as pt_from
		FROM
			tmp_chronic c
		GROUP BY c.CID,c.CHRONIC
	) as t INNER JOIN t_person_cid p ON p.cid=t.cid
);

/*import from diagopd*/
INSERT IGNORE INTO t_chronic
(
	cid,birth,age_y,age_y_dx,sex,nation,p_hospcode,d_hospcode,p_pt_vhid,d_pt_vhid
	,p_typearea,d_typearea,input_hosp,input_pid,source_tb,diagcode,date_dx
	,hosp_dx,hosp_rx,minscl,inscl
)
(
SELECT SQL_BIG_RESULT 
	p.CID,p.BIRTH,age(NOW(),p.BIRTH,'y'),age(t.date_diag,p.BIRTH,'y'),p.SEX,p.NATION
	,p.HOSPCODE,p.check_hosp,p.vhid,p.check_vhid,p.TYPEAREA,p.check_typearea
	,t.hosp_input,t.pid_input,t.pt_from,t.diagcode,t.date_diag,t.hosp_dx,t.hosp_rx
	,p.maininscl,p.inscl

FROM
	(
		SELECT
			o.cid,o.HOSPCODE hosp_input,o.pid pid_input,o.date_serv date_diag,o.diagcode
			,o.HOSPCODE hosp_dx,o.HOSPCODE hosp_rx,'diag_opd' as pt_from
		FROM
			tmp_chronic_opd o
		GROUP BY o.cid,o.diagcode
	) as t INNER JOIN t_person_cid p ON p.cid=t.cid
);

/*import from diagipd*/
INSERT IGNORE INTO t_chronic
(
	cid,birth,age_y,age_y_dx,sex,nation,p_hospcode,d_hospcode,p_pt_vhid,d_pt_vhid
	,p_typearea,d_typearea,input_hosp,input_pid,source_tb,diagcode,date_dx
	,hosp_dx,hosp_rx,minscl,inscl
)
(
SELECT SQL_BIG_RESULT 
	p.CID,p.BIRTH,age(NOW(),p.BIRTH,'y'),age(t.date_diag,p.BIRTH,'y'),p.SEX,p.NATION
	,p.HOSPCODE,p.check_hosp,p.vhid,p.check_vhid,p.TYPEAREA,p.check_typearea
	,t.hosp_input,t.pid_input,t.pt_from,t.diagcode,t.date_diag,t.hosp_dx,t.hosp_rx
	,p.maininscl,p.inscl

FROM
	(
		SELECT
			i.cid,i.HOSPCODE hosp_input,i.pid pid_input,DATE_FORMAT(i.DATETIME_ADMIT,'%Y-%m-%d') date_diag,i.diagcode
			,i.HOSPCODE hosp_dx,i.HOSPCODE hosp_rx,'diag_ipd' as pt_from
		FROM
			tmp_chronic_ipd i
		GROUP BY i.cid,i.diagcode
	) as t INNER JOIN t_person_cid p ON p.cid=t.cid
);





UPDATE t_chronic t ,cage  ag SET t.groupcode=ag.groupcode1560
WHERE t.age_y=ag.age ;

/*
UPDATE t_chronic c,tmp_chronic tc
		SET c.typedisch=tc.typedisch,c.date_dx=tc.DATE_DIAG
WHERE c.cid = tc.cid AND c.diagcode=tc.chronic;
*/

UPDATE t_chronic c,t_person_cid p SET c.typedisch='02'  
WHERE c.cid=p.cid AND p.DISCHARGE=1;

 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.0028429;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:102;a:5:{i:0;s:31:"DROP PROCEDURE IF EXISTS t_dmht";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.049643;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:105;a:5:{i:0;s:17166:"CREATE PROCEDURE t_dmht()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '13';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-2,'1001');
SET	@start_d1:=concat(@b_year-1,'0701');
SET	@start_d2:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLES IF EXISTS tmp_labfu;
CREATE TABLE IF NOT EXISTS tmp_labfu( 
  `HOSPCODE` varchar(5) NOT NULL,
  `PID` varchar(15) NOT NULL,
  `SEQ` varchar(16) NOT NULL,
  `DATE_SERV` date NOT NULL,
  `LABTEST` varchar(7) NOT NULL DEFAULT '',
  `LABRESULT` double(6,2) NOT NULL,
  `D_UPDATE` datetime NOT NULL,
  `CID` varchar(13) DEFAULT NULL,
  `LABTEST_SEND` varchar(7) DEFAULT NULL,
  `LABTEST_NEW` varchar(7) DEFAULT NULL,
PRIMARY KEY (HOSPCODE,PID,SEQ,LABTEST_SEND),
KEY (hospcode),KEY (pid),KEY (seq),KEY (cid),
KEY (date_serv),KEY (labtest),KEY (labresult),
KEY (LABTEST_SEND), KEY (LABTEST_NEW)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO tmp_labfu (HOSPCODE,PID,SEQ,DATE_SERV,LABTEST_SEND,LABRESULT,D_UPDATE,CID)
(SELECT SQL_BIG_RESULT 
				l.HOSPCODE,l.PID,l.SEQ,l.DATE_SERV,l.LABTEST,l.LABRESULT,l.D_UPDATE,p.CID
FROM
	labfu l LEFT JOIN t_person_db p ON  l.HOSPCODE=p.HOSPCODE AND l.PID=p.PID
WHERE	DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY HOSPCODE,PID,SEQ,LABTEST
);

UPDATE tmp_labfu l SET l.LABTEST=l.LABTEST_SEND WHERE LENGTH(TRIM(l.LABTEST_SEND)) =2;

UPDATE tmp_labfu l INNER JOIN clabtest_new c ON l.LABTEST=c.old_code 
SET l.LABTEST_NEW=c.`code`
WHERE LENGTH(TRIM(l.LABTEST)) =2;

UPDATE tmp_labfu l INNER JOIN clabtest_new c ON l.LABTEST_SEND=c.`code` 
SET l.LABTEST=c.old_code , l.LABTEST_NEW=c.`code`
WHERE LENGTH(TRIM(l.LABTEST_SEND)) > 2;


DROP TABLES IF EXISTS tmp_chronicfu;
CREATE TABLE IF NOT EXISTS tmp_chronicfu (
KEY (hospcode),
KEY (pid),
KEY (seq),
KEY (cid),
KEY (date_serv),
KEY (sbp),
KEY (dbp),
KEY (foot),
KEY (retina)
)ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		c.*,p.CID
FROM
	chronicfu c LEFT JOIN t_person_db p ON c.HOSPCODE=p.HOSPCODE AND c.PID=p.PID
WHERE	DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY HOSPCODE,PID,SEQ
	);

DROP TABLE IF EXISTS t_chronicfu;
CREATE  TABLE IF NOT EXISTS t_chronicfu(
hospcode VARCHAR(5) NOT NULL,
pid VARCHAR(15) NOT NULL,
cid VARCHAR(13) NOT NULL,
ld_bp1 date DEFAULT NULL,
ld_bp2 date DEFAULT NULL,
sbp_1 VARCHAR(10) DEFAULT NULL,
dbp_1 VARCHAR(10) DEFAULT NULL,
sbp_2 VARCHAR(10) DEFAULT NULL,
dbp_2 VARCHAR(10) DEFAULT NULL,
ld_hba1c date DEFAULT NULL,
hba1c  VARCHAR(10) DEFAULT NULL,
ld_foot date DEFAULT NULL ,
foot VARCHAR(10)  DEFAULT NULL,
ld_retina date DEFAULT NULL, 
retina VARCHAR(10)  DEFAULT NULL ,
control_dm int(1) DEFAULT '0',
control_ht int(1) DEFAULT '0',
PRIMARY KEY (cid,hospcode),
KEY (cid),
KEY (hospcode)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 AS
(
SELECT hospcode,pid,cid,null as sbp_1 ,null as dbp_1,null as sbp_2,null as dbp_2,null as hba1c
,null as ld_foot,null as foot,null as ld_retina,null as retina,0 as control_dm ,0 as control_ht
FROM tmp_chronicfu 
WHERE LENGTH(cid)=13  AND DATE_SERV BETWEEN @start_d2 AND @end_d
GROUP BY HOSPCODE,cid
);
UPDATE t_chronicfu f INNER JOIN (
	SELECT hospcode , pid ,max(date_serv) date_serv 
	FROM tmp_labfu WHERE labtest in(5) 
	GROUP BY hospcode,PID
) l ON f.hospcode=l.hospcode AND f.pid=l.pid
SET f.ld_hba1c=l.date_serv;

UPDATE t_chronicfu f INNER JOIN tmp_labfu l ON f.hospcode=l.hospcode AND f.pid=l.pid AND f.ld_hba1c=l.DATE_SERV 
SET f.hba1c=l.LABRESULT
WHERE l.LABTEST in(5);

UPDATE t_chronicfu SET control_dm='1' WHERE  (hba1c BETWEEN 0.1  AND 6.99)	AND ld_hba1c BETWEEN @start_d2 AND @end_d	;

UPDATE t_chronicfu d ,	
								(SELECT c.HOSPCODE, c.PID ,c.DATE_SERV,c.SBP,c.DBP
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV =
								(SELECT c1.DATE_SERV FROM tmp_chronicfu c1 WHERE c1.HOSPCODE=c.HOSPCODE  AND c1.pid=c.pid 
									and c1.SBP >0 AND c1.DBP>0  GROUP BY c1.HOSPCODE,c1.PID,c1.DATE_SERV 
									ORDER BY c1.date_serv desc LIMIT 0,1)
								GROUP BY hospcode,PID) as t
		SET ld_bp1 =t.DATE_SERV,sbp_1 =t.SBP,dbp_1 =t.DBP
WHERE		d.HOSPCODE=t.HOSPCODE  AND d.pid=t.pid  ;
/*last_bp2*/
UPDATE t_chronicfu d ,	
								(SELECT c.HOSPCODE, c.PID ,c.DATE_SERV,c.SBP,c.DBP
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV =
								(SELECT c1.DATE_SERV FROM tmp_chronicfu c1 WHERE c1.HOSPCODE=c.HOSPCODE  AND c1.pid=c.pid 
									and c1.SBP >0 AND c1.DBP>0  GROUP BY c1.HOSPCODE,c1.PID,c1.DATE_SERV 
									ORDER BY c1.date_serv desc LIMIT 1,1)
								GROUP BY hospcode,PID) as t
		SET ld_bp2 =t.DATE_SERV,sbp_2 =t.SBP,dbp_2 =t.DBP
WHERE		d.HOSPCODE=t.HOSPCODE  AND d.pid=t.pid  ;

UPDATE t_chronicfu SET control_ht ='1'	 WHERE 		
 (sbp_1  > 50 AND sbp_1 <= 139) AND (sbp_2 > 50 AND sbp_2 <=139 )
AND (dbp_1 > 50 AND dbp_1 <= 89) AND (dbp_1 > 50 AND dbp_1 <= 89) AND ld_bp1 BETWEEN @start_d2 AND @end_d ;

UPDATE t_chronicfu f INNER JOIN (
	SELECT hospcode , pid ,max(date_serv) date_serv 
	FROM tmp_chronicfu WHERE foot in(1,3) 
	GROUP BY hospcode,PID
) l ON f.hospcode=l.hospcode AND f.pid=l.pid
SET f.ld_foot=l.date_serv;

UPDATE t_chronicfu f INNER JOIN tmp_chronicfu l ON f.hospcode=l.hospcode AND f.pid=l.pid AND f.ld_foot=l.DATE_SERV 
SET f.foot=l.foot;

UPDATE t_chronicfu f INNER JOIN (
	SELECT hospcode , pid ,max(date_serv) date_serv 
	FROM tmp_chronicfu WHERE retina in(1,2,3,4) 
	GROUP BY hospcode,PID
) l ON f.hospcode=l.hospcode AND f.pid=l.pid
SET f.ld_retina=l.date_serv;

UPDATE t_chronicfu f INNER JOIN tmp_chronicfu l ON f.hospcode=l.hospcode AND f.pid=l.pid AND f.ld_retina=l.DATE_SERV 
SET f.retina=l.retina;


DROP TABLES IF EXISTS t_dmht;
CREATE TABLE IF NOT EXISTS t_dmht (
		id int(15) NOT NULL AUTO_INCREMENT
		,hospcode VARCHAR(5) DEFAULT NULL 
		,pid VARCHAR(15)  DEFAULT NULL 
		,vhid VARCHAR(8) DEFAULT NULL 
		,typearea VARCHAR(1) DEFAULT NULL 
		,cid VARCHAR(13) NOT NULL
		,birth date
		,age_y INT(3) DEFAULT 0
		,groupcode1560 VARCHAR(100) DEFAULT NULL 
		,groupname1560 VARCHAR(100) DEFAULT NULL 
		,sex VARCHAR(1) DEFAULT NULL 
		,nation VARCHAR(3) DEFAULT NULL 
		,source_tb VARCHAR(255) DEFAULT NULL 
		,mix_dx VARCHAR(255) DEFAULT NULL 	
		,t_mix_dx VARCHAR(255) DEFAULT NULL 	
		,type_dx VARCHAR(2) DEFAULT NULL 
		,date_dx VARCHAR(255) DEFAULT NULL 
		,hosp_dx varchar(255) DEFAULT NULL 
		,minscl VARCHAR(5) DEFAULT NULL 
		,inscl VARCHAR(3) DEFAULT NULL 
		,ld_hba1c date  DEFAULT NULL 
		,rs_hba1c VARCHAR(10)  DEFAULT NULL
		,ih_hba1c  VARCHAR(5)  DEFAULT NULL
		,ld_fpg1 date DEFAULT NULL 
		,rs_fpg1 VARCHAR(10)  DEFAULT NULL 
		,ih_fpg1  VARCHAR(5)  DEFAULT NULL
		,ld_fpg2 date DEFAULT NULL 
		,rs_fpg2 VARCHAR(10)  DEFAULT NULL 
		,ih_fpg2  VARCHAR(5)  DEFAULT NULL
		,ld_fpg3 date DEFAULT NULL 
		,rs_fpg3 VARCHAR(10)  DEFAULT NULL 
		,ih_fpg3  VARCHAR(5)  DEFAULT NULL
		,ld_creatinine date DEFAULT NULL 
		,rs_creatinine VARCHAR(10)  DEFAULT NULL 
		,ih_creatinine VARCHAR(5)  DEFAULT NULL
		,ld_lipid date DEFAULT NULL 
		,rs_lipid VARCHAR(10)  DEFAULT NULL 
		,ih_lipid VARCHAR(5)  DEFAULT NULL
		,ld_foot date DEFAULT NULL 
		,rs_foot VARCHAR(10)  DEFAULT NULL
		,ih_foot VARCHAR(5)  DEFAULT NULL 
		,ld_retina date DEFAULT NULL 
		,rs_retina VARCHAR(10)  DEFAULT NULL 
		,ih_retina VARCHAR(5)  DEFAULT NULL 
		,ld_bp1 date DEFAULT NULL 
		,ih_bp1 VARCHAR(5)  DEFAULT NULL 
		,rs_bps1 VARCHAR(10)  DEFAULT NULL 
		,rs_bpd1 VARCHAR(10)  DEFAULT NULL 
		,ld_bp2 date  DEFAULT NULL 
		,ih_bp2 VARCHAR(5)  DEFAULT NULL 
		,rs_bps2 VARCHAR(10)  DEFAULT NULL 
		,rs_bpd2 VARCHAR(10)  DEFAULT NULL 
		,`complication_dm` varchar(20) DEFAULT '0',
  `complication_ht` varchar(20) DEFAULT '0',
  `control_dm` int(1) DEFAULT '0',
  `control_ht` int(1) DEFAULT '0',
  `bmi` decimal(10,2) DEFAULT '0',
  `obes` int(1) DEFAULT '0',
  `height` smallint(6) DEFAULT '0',
  `weight` mediumint(9) DEFAULT '0',
	`waist_cm`  smallint(6) NULL DEFAULT 0 ,
	PRIMARY KEY (cid)
	,KEY (cid)
  ,KEY (id)
	,KEY (type_dx)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO t_dmht(
	hospcode,vhid,typearea,cid,birth,age_y,groupcode1560,groupname1560,sex,nation,minscl,inscl,source_tb,hosp_dx,mix_dx,t_mix_dx,date_dx
)
(
	SELECT SQL_BIG_RESULT 
			p.check_hosp,p.check_vhid,p.check_typearea,p.cid,p.birth,p.age_y,a.groupcode1560,a.groupname1560,p.sex,p.nation
			,p.maininscl,p.inscl
			,GROUP_CONCAT(c.source_tb ORDER BY c.date_dx ) source_tb
			,GROUP_CONCAT(c.hosp_dx ORDER BY c.date_dx ) hosp_dx
			,GROUP_CONCAT(c.diagcode ORDER BY c.date_dx  ) diagcode
			,GROUP_CONCAT(DISTINCT  substr(c.diagcode,1,1) ORDER BY SUBSTR(c.diagcode,1,1)  ) 
			,GROUP_CONCAT(c.date_dx  ORDER BY c.date_dx ) date_dx
FROM
(SELECT * FROM t_chronic 
WHERE  (SUBSTR(UPPER(diagcode),1,3) BETWEEN  'E10' and 'E14'  OR 	SUBSTR(UPPER(diagcode),1,3) BETWEEN  'I10' and 'I15')  
GROUP BY concat(cid,'-',diagcode) ) c 
INNER JOIN t_person_cid  p ON c.cid = p.cid
LEFT JOIN cage a ON	 p.age_y=a.age
WHERE p.nation IN(99)  AND p.DISCHARGE  IN(9)
GROUP BY p.cid
);

/*update pid*/
UPDATE t_dmht d,t_person_cid p  SET d.pid=p.pid WHERE d.cid=p.cid AND d.hospcode=p.hospcode;

/*up_mixdiag*/
UPDATE t_dmht 
	SET type_dx = if(t_mix_dx ='I' ,'01'  
							,if(t_mix_dx ='E' ,'02'
							,if(t_mix_dx ='E,I','03',NULL)));


/*up_hba1c*/
UPDATE IGNORE t_dmht d INNER JOIN 
(SELECT cid,MAX(date_serv) date_serv FROM  tmp_labfu WHERE labtest IN(5) GROUP BY cid) l ON d.cid=l.cid 
SET d.ld_hba1c =l.date_serv;

UPDATE IGNORE t_dmht d INNER JOIN tmp_labfu l ON d.cid=l.cid  AND d.ld_hba1c =l.date_serv
SET d.rs_hba1c =l.labresult ,d.ih_hba1c=l.HOSPCODE
WHERE l.labtest IN(5);


/*up_fpg1*/
UPDATE t_dmht d ,
								(SELECT l.cid,l.HOSPCODE,l.DATE_SERV,l.LABRESULT 
								FROM tmp_labfu l
								WHERE l.labtest in(1,3) 
								    AND l.DATE_SERV =
								(SELECT l1.DATE_SERV FROM tmp_labfu l1 WHERE l1.labtest in(1,3) AND l1.cid=l.cid GROUP BY l1.cid,l1.DATE_SERV ORDER BY l1.date_serv desc LIMIT 0,1)
								GROUP BY cid) as t
		SET ld_fpg1 =t.DATE_SERV,rs_fpg1 =t.LABRESULT ,ih_fpg1=t.hospcode
WHERE
		d.cid=t.cid ;

/*up_fpg2*/
UPDATE t_dmht d ,
								(SELECT l.cid,l.DATE_SERV,l.LABRESULT,l.HOSPCODE
								FROM tmp_labfu l
								WHERE l.labtest in(1,3) 
								    AND l.DATE_SERV =
								(SELECT l1.DATE_SERV FROM tmp_labfu l1 WHERE l1.labtest in(1,3) AND l1.cid=l.cid GROUP BY l1.cid,l1.DATE_SERV ORDER BY l1.date_serv desc LIMIT 1,1)
								GROUP BY cid) as t
		SET ld_fpg2 =t.DATE_SERV,rs_fpg2 =t.LABRESULT ,ih_fpg2=t.hospcode
WHERE
		d.cid=t.cid ;

/*up_fpg3*/
UPDATE t_dmht d ,
								(SELECT l.cid,l.DATE_SERV,l.LABRESULT,l.HOSPCODE
								FROM tmp_labfu l
								WHERE l.labtest in(1,3) 
								    AND l.DATE_SERV =
								(SELECT l1.DATE_SERV FROM tmp_labfu l1 WHERE l1.labtest in(1,3) AND l1.cid=l.cid GROUP BY l1.cid,l1.DATE_SERV ORDER BY l1.date_serv desc LIMIT 2,1)
								GROUP BY cid) as t
		SET ld_fpg3 =t.DATE_SERV,rs_fpg3 =t.LABRESULT,ih_fpg3=t.hospcode
WHERE
		d.cid=t.cid ;
/*Creatinine*/ 
UPDATE t_dmht d ,	
								(SELECT l.cid,l.DATE_SERV,l.LABRESULT,l.HOSPCODE
								FROM tmp_labfu l
								WHERE l.labtest in(11,13) 
								    AND l.DATE_SERV =
								(SELECT l1.DATE_SERV FROM tmp_labfu l1 WHERE l1.labtest in(11,13) AND l1.cid=l.cid GROUP BY l1.cid,l1.DATE_SERV ORDER BY l1.date_serv desc LIMIT 0,1)
								GROUP BY cid) as t
		SET ld_creatinine =t.DATE_SERV,rs_creatinine =t.LABRESULT,ih_creatinine=t.hospcode 
WHERE
		d.cid=t.cid ;

/*lipid TotalCholesterol*/
UPDATE t_dmht d ,	
								(SELECT l.cid,l.DATE_SERV,l.LABRESULT,l.HOSPCODE 
								FROM tmp_labfu l
								WHERE l.labtest in(7) 
								    AND l.DATE_SERV =
								(SELECT l1.DATE_SERV FROM tmp_labfu l1 WHERE l1.labtest in(7) AND l1.cid=l.cid GROUP BY l1.cid,l1.DATE_SERV ORDER BY l1.date_serv desc LIMIT 0,1)
								GROUP BY cid) as t
		SET ld_lipid =t.DATE_SERV,rs_lipid =t.LABRESULT ,ih_lipid=t.hospcode 
WHERE
		d.cid=t.cid ;

/*foot*/
UPDATE t_dmht d ,	
								(SELECT c.cid,c.DATE_SERV,c.FOOT,c.HOSPCODE
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV =
								(SELECT c1.DATE_SERV FROM tmp_chronicfu c1 WHERE c1.cid=c.cid and c1.foot in(1,3) GROUP BY c1.cid,c1.DATE_SERV ORDER BY c1.date_serv desc LIMIT 0,1)
								GROUP BY cid) as t
		SET ld_foot =t.DATE_SERV,rs_foot =t.FOOT,ih_foot=t.hospcode
WHERE
		d.cid=t.cid ;

/*retina*/ 
UPDATE t_dmht d ,	
								(SELECT c.cid,c.DATE_SERV,c.RETINA,c.HOSPCODE
								FROM tmp_chronicfu c
								WHERE c.RETINA in(1,2,3,4)  AND c.DATE_SERV =
								(SELECT c1.DATE_SERV FROM tmp_chronicfu c1 WHERE c1.cid=c.cid and c1.RETINA in(1,2,3,4) GROUP BY c1.cid,c1.DATE_SERV ORDER BY c1.date_serv desc LIMIT 0,1)
								GROUP BY cid) as t
		SET ld_retina =t.DATE_SERV,rs_retina =t.RETINA ,ih_retina=t.hospcode
WHERE
		d.cid=t.cid ;

/*last_bp1*/ 
UPDATE t_dmht d ,	
								(SELECT c.cid,c.DATE_SERV,c.SBP,c.DBP,c.HOSPCODE
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV =
								(SELECT c1.DATE_SERV FROM tmp_chronicfu c1 WHERE c1.cid=c.cid and c1.SBP >0 AND c1.DBP>0  GROUP BY c1.cid,c1.DATE_SERV ORDER BY c1.date_serv desc LIMIT 0,1)
								GROUP BY cid) as t
		SET ld_bp1 =t.DATE_SERV,rs_bps1 =t.SBP,rs_bpd1 =t.DBP,ih_bp1=t.hospcode
WHERE
		d.cid=t.cid ;

/*last_bp2*/
UPDATE t_dmht d ,	
								(SELECT c.cid,c.DATE_SERV,c.SBP,c.DBP,c.HOSPCODE
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV =
								(SELECT c1.DATE_SERV FROM tmp_chronicfu c1 WHERE c1.cid=c.cid and c1.SBP >0 AND c1.DBP>0 GROUP BY c1.cid,c1.DATE_SERV ORDER BY c1.date_serv desc LIMIT 1,1)
								GROUP BY cid) as t
		SET ld_bp2 =t.DATE_SERV,rs_bps2 =t.SBP,rs_bpd2 =t.DBP,ih_bp2=t.hospcode
WHERE
		d.cid=t.cid ;

/*ภาวะแทรกซ้อนทางตา*/
UPDATE t_dmht t , (
					SELECT 
							cid
					FROM
					tmp_chronic_opd 
					WHERE diagcode in('E103','E113','E123','E133','E143','H360','H280')
)  d SET complication_dm='1' WHERE t.cid=d.cid AND d.cid is not null AND t.type_dx in(2,3);
/*ไต*/
UPDATE t_dmht t , (
					SELECT 
							cid
					FROM
					tmp_chronic_opd 
					WHERE diagcode in('E102','E112','E122','E132','E142','N083')
)  d SET complication_dm='2' WHERE t.cid=d.cid AND d.cid is not null AND t.type_dx in(2,3);

/*เท้า*/
UPDATE t_dmht t , (
					SELECT 
							cid
					FROM
					tmp_chronic_opd 
					WHERE diagcode in('E104','E114','E124','E134','E144','I792','E105','E115','E125','E135','E145' )
)  d SET complication_dm='3' WHERE t.cid=d.cid AND d.cid is not null AND t.type_dx in(2,3);

/*หลายอย่าง*/
UPDATE t_dmht t , (
					SELECT 
							cid
					FROM
					tmp_chronic_opd 
					WHERE diagcode in('E107','E117','E127','E137','E147')
)  d SET complication_dm='4' WHERE t.cid=d.cid AND d.cid is not null AND t.type_dx in(2,3);
/*ภาวะนำ้ตาลตำ่*/
UPDATE t_dmht t , (
					SELECT 
							cid
					FROM
					tmp_chronic_opd 
					WHERE diagcode in('E16')
)  d SET complication_dm='5' WHERE t.cid=d.cid AND d.cid is not null AND t.type_dx in(2,3);

UPDATE t_dmht t , (
					SELECT 
							cid
					FROM
					tmp_chronic_opd 
					WHERE diagcode in('E131')
)  d SET complication_dm='6' WHERE t.cid=d.cid AND d.cid is not null AND t.type_dx in(2,3);
/*หัวใจ*/
UPDATE t_dmht t , (
					SELECT 
							cid
					FROM
					tmp_chronic_opd 
					WHERE diagcode in('I110','I119')
)  d SET complication_ht='1' WHERE t.cid=d.cid AND d.cid is not null AND t.type_dx in(1,3);
/*ไต*/
UPDATE t_dmht t , (
					SELECT 
							cid
					FROM
					tmp_chronic_opd 
					WHERE diagcode in('I120','I129')
)  d SET complication_ht='2' WHERE t.cid=d.cid AND d.cid is not null AND t.type_dx in(1,3);

/*ไตหัวใจ*/
UPDATE t_dmht t , (
					SELECT 
							cid
					FROM
					tmp_chronic_opd 
					WHERE diagcode in('I130','I131','I132','I139')
)  d SET complication_ht='3' WHERE t.cid=d.cid AND d.cid is not null AND t.type_dx in(1,3);

/*w,h*/
UPDATE t_dmht t , (
				SELECT
				*
				FROM
				(SELECT 
							cid,weight,height,WAIST_CM
					FROM
					tmp_chronicfu
					WHERE  weight is not null  and height is not null
					ORDER BY DATE_SERV DESC
					) pre
					GROUP BY cid
)  d SET t.weight=d.weight ,t.height=d.height,t.waist_cm=d.waist_cm  WHERE t.cid=d.cid AND d.cid is not null ;

/*up control dm 1 ok 0 not ok*/
UPDATE t_dmht SET control_dm='1' WHERE type_dx in(2,3) AND 
			(rs_hba1c BETWEEN 0.1  AND 6.99)	AND ld_hba1c BETWEEN @start_d2 AND @end_d	;
/*bp control*/
UPDATE t_dmht SET control_ht ='1'	 WHERE 		
type_dx in(1,3) AND (rs_bps1  > 50 AND rs_bps1 <= 139) AND (rs_bps2 > 50 AND rs_bps2 <=139 )
AND (rs_bpd1 > 50 AND rs_bpd1 <= 89) AND (rs_bpd2 > 50 AND rs_bpd2 <= 89) AND ld_bp1 BETWEEN @start_d2 AND @end_d ;

UPDATE t_dmht SET bmi=round(WEIGHT/((HEIGHT/100)*(HEIGHT/100)),2) ;


UPDATE t_dmht SET obes =1 WHERE
(sex='1' AND round(WAIST_CM)>90) OR (sex='2' AND round(WAIST_CM)>80)
OR bmi>=25;

 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.1432431;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:108;a:5:{i:0;s:36:"DROP PROCEDURE IF EXISTS t_ncdscreen";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.2056429;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:111;a:5:{i:0;s:7505:"CREATE PROCEDURE t_ncdscreen()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '14';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-2,'1001');
SET	@start_d1:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
SET @end_d1:=concat(@b_year-1,'0930');

DROP TABLES IF EXISTS tmp_ncdscreen;
CREATE TABLE IF NOT EXISTS tmp_ncdscreen (error_code varchar(255) DEFAULT NULL, KEY(cid)) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		n.*,p.CID,null as error_code
FROM
	ncdscreen n left join t_person_db p ON n.HOSPCODE=p.HOSPCODE AND n.PID=p.PID
WHERE	DATE_SERV BETWEEN @start_d AND @end_d
);

UPDATE tmp_ncdscreen 
SET error_code =IF(ISNULL(error_code),'NCD0001',CONCAT(error_code,',','NCD0001') ) 
WHERE  DATE_SERV BETWEEN @start_d1 AND @end_d AND HEIGHT NOT BETWEEN 90 AND 250;

UPDATE tmp_ncdscreen 
SET error_code =IF(ISNULL(error_code),'NCD0002',CONCAT(error_code,',','NCD0002') ) 
WHERE  DATE_SERV BETWEEN @start_d1 AND @end_d AND WEIGHT NOT BETWEEN  10 AND 300;

UPDATE tmp_ncdscreen n INNER JOIN person p  ON n.HOSPCODE=p.HOSPCODE AND n.PID=p.PID
SET error_code =IF(ISNULL(n.error_code),'NCD0003',CONCAT(n.error_code,',','NCD0003') ) 
WHERE  DATE_SERV BETWEEN @start_d1 AND @end_d AND n.DATE_SERV < p.BIRTH;


DROP TABLES IF EXISTS t_ncdscreen;
CREATE TABLE IF NOT EXISTS t_ncdscreen (
KEY(hospcode),KEY(check_hosp),KEY(cid),KEY(date_serv),KEY(bslevel),KEY(bstest),KEY(sbp_1,dbp_1),KEY(sbp_2,dbp_2),KEY(sex)
) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
ns.*,c.groupcode3560,c.groupname3560
FROM
		(SELECT
				n.*,age(n.DATE_SERV,p.BIRTH,'y') as age_y,p.check_hosp,p.check_typearea,p.TYPEAREA,p.check_vhid,p.vhid,p.nation,p.sex
		FROM
			tmp_ncdscreen n LEFT JOIN t_person_cid p ON n.cid=p.cid
		WHERE	DATE_SERV BETWEEN @start_d AND @end_d
		) as ns,cage c 
WHERE ns.age_y=c.age
);
/*เบาหวาน*/
DROP  TABLE IF EXISTS  t_person_dm_screen;
CREATE  TABLE IF NOT EXISTS t_person_dm_screen (
  hospcode varchar(5) DEFAULT NULL,
  areacode varchar(8) DEFAULT NULL,
  cid varchar(13) NOT NULL DEFAULT '',
  pid varchar(15) DEFAULT NULL,
	age_y int(3) DEFAULT '0',
	typearea  varchar(1) DEFAULT NULL,
	date_screen date ,
  bslevel int(6)  DEFAULT '0',
	bstest  varchar(1) DEFAULT NULL,
  ill varchar(1) default null,
  risk varchar(1) default null,
PRIMARY KEY (cid),
	KEY (hospcode),
	KEY (areacode),
	KEY (pid),
	KEY (typearea),
  KEY (risk)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO t_person_dm_screen(
  hospcode,areacode,cid,pid,age_y,typearea
)
SELECT pe.check_hosp HOSPCODE
								,pe.check_vhid as areacode
								,pe.CID,pe.PID,pe.age_y,pe.check_typearea TYPEAREA
				FROM
						t_person_cid pe
				WHERE
						substr(pe.check_vhid,1,2)=@prov_c
						AND pe.nation=99 
						AND pe.DISCHARGE=9 
						AND pe.age_y>=15 
						AND pe.check_typearea in(1,3)
						AND cid not in(SELECT cid FROM t_dmht WHERE type_dx in(2,3))
ORDER BY check_hosp,check_typearea
;

UPDATE t_person_dm_screen p,t_ncdscreen n SET p.date_screen=n.DATE_SERV  ,p.bslevel=n.BSLEVEL, p.bstest=n.bstest
WHERE p.cid=n.cid AND n.DATE_SERV BETWEEN @start_d1 AND @end_d;

update t_person_dm_screen p inner join t_dmht d 
SET ill='1'
WHERE p.cid=d.cid AND d.type_dx in(2,3);

update t_person_dm_screen SET risk='0'
where (((bstest in('1','3') OR bstest is null) AND bslevel >= 70 AND bslevel <= 100 ) OR
(bstest in('2','4') AND bslevel >= 70 AND bslevel <= 140));

update t_person_dm_screen SET risk='1'
where (((bstest in('1','3') OR bstest is null) AND bslevel > 100 AND bslevel <= 125 ) OR 
(bstest in('2','4')   AND bslevel > 140 AND bslevel <= 200 ));

update t_person_dm_screen SET risk='2'
where (((bstest in('1','3') OR bstest is null) AND bslevel > 125) OR
(bstest in('2','4') AND bslevel > 200));


/*ความดัน*/
DROP  TABLE IF EXISTS  t_person_ht_screen;
CREATE  TABLE IF NOT EXISTS t_person_ht_screen (
  hospcode varchar(5) DEFAULT NULL,
  areacode varchar(8) DEFAULT NULL,
  cid varchar(13) NOT NULL DEFAULT '',
  pid varchar(15) DEFAULT NULL,
	age_y int(3) DEFAULT '0',
	typearea  varchar(1) DEFAULT NULL,
	date_screen date ,
  sbp_1 int(3)  DEFAULT 0,
	dbp_1 int(3)  DEFAULT 0,
	sbp_2 int(3)  DEFAULT 0,
	dbp_2 int(3)  DEFAULT 0,
  ill varchar(1) default null,
	sbp int(3)  DEFAULT 0,
	dbp int(3)  DEFAULT 0,
	risk varchar(1) default null,
PRIMARY KEY (cid),
	KEY (hospcode),
	KEY (areacode),
	KEY (pid),
	KEY (typearea),
	KEY (risk)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO t_person_ht_screen(
  hospcode,areacode,cid,pid,age_y,typearea
)
SELECT pe.check_hosp HOSPCODE
								,pe.check_vhid as areacode
								,pe.CID,pe.PID,pe.age_y,pe.check_typearea TYPEAREA
				FROM
						t_person_cid pe
				WHERE
						substr(pe.check_vhid,1,2)=@prov_c
						AND pe.nation=99 
						AND pe.DISCHARGE=9 
						AND pe.age_y>=15 
						AND pe.check_typearea in(1,3)
						AND cid not in(SELECT cid FROM t_dmht WHERE type_dx in(1,3))
ORDER BY check_hosp,check_typearea
;

UPDATE t_person_ht_screen p,t_ncdscreen n SET p.date_screen=n.DATE_SERV  ,p.sbp_1=n.SBP_1,p.sbp_2=n.SBP_2,p.dbp_1=n.dBP_1,p.dbp_2=n.dBP_2
WHERE p.cid=n.cid AND n.DATE_SERV BETWEEN @start_d1 AND @end_d;

update t_person_ht_screen p inner join t_dmht d 
SET ill='1'
WHERE p.cid=d.cid AND d.type_dx in(1,3);

update t_person_ht_screen SET sbp=sbp_2 ,dbp=dbp_2
WHERE sbp_2 >0  ; 

update t_person_ht_screen SET sbp=sbp_1 ,dbp=dbp_1
WHERE sbp =0 and sbp_1 >0  ;

update t_person_ht_screen SET risk='0'
where (sbp  > 50 AND sbp < 120) and  (dbp > 50 AND dbp < 80);

update t_person_ht_screen SET risk='1'
where (sbp BETWEEN 120 AND 139) OR (dbp BETWEEN 80 AND 89);

update t_person_ht_screen SET risk='2'
where sbp >=140 OR dbp >=90;

DROP TABLE IF EXISTS tmp_ncdscreen_last;
CREATE TABLE IF NOT EXISTS tmp_ncdscreen_last(
  `HOSPCODE` varchar(5) DEFAULT NULL,
  `PID` varchar(15)  DEFAULT NULL,
  `SEQ` varchar(16) DEFAULT NULL,
  `DATE_SERV` date NOT NULL,
  `BSLEVEL` int(6) DEFAULT NULL,
  `BSTEST` char(1) DEFAULT NULL,
  `SCREENPLACE` varchar(5) DEFAULT NULL,
  `CID` varchar(13) DEFAULT NULL,
  `age_y` int(3) DEFAULT NULL,
  `pcheck_hosp` varchar(5) DEFAULT '',
  `pcheck_typearea` varchar(1) DEFAULT '',
  `pcheck_vhid` varchar(8) DEFAULT NULL,
  `nation` varchar(3) DEFAULT '',
  `sex` varchar(1) DEFAULT '',
	diagcode VARCHAR(8) DEFAULT NULL,
	diag_hospcode VARCHAR(5) DEFAULT NULL,
	diag_date date DEFAULT NULL,
PRIMARY KEY (cid),
	KEY (hospcode),
	KEY (pcheck_hosp),
	KEY (pcheck_typearea),
	KEY (pcheck_vhid)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;
INSERT INTO tmp_ncdscreen_last (cid,date_serv)
(SELECT cid,max(DATE_SERV) DATE_SERV  
FROM t_ncdscreen WHERE DATE_SERV BETWEEN @start_d AND @end_d1 AND BSLEVEL > 70
GROUP BY cid
);

UPDATE tmp_ncdscreen_last l INNER JOIN t_ncdscreen n ON l.cid=n.cid AND l.date_serv=n.date_serv
SET l.HOSPCODE = n.HOSPCODE ,l.PID=n.PID ,l.SEQ =n.SEQ ,l.BSLEVEL=n.BSLEVEL ,l.BSTEST=.n.BSTEST
,l.SCREENPLACE=n.SCREENPLACE,l.age_y=n.age_y ,l.pcheck_hosp =n.check_hosp , l.pcheck_typearea=n.check_typearea 
,l.pcheck_vhid = n.check_vhid,l.nation=n.nation,l.sex=n.sex;

UPDATE tmp_ncdscreen_last l INNER JOIN  t_chronic  c ON l.cid=c.cid
SET l.diagcode=c.diagcode , l.diag_hospcode=IFNULL(c.hosp_dx,c.input_hosp) ,l.diag_date=c.date_dx
WHERE  SUBSTR(c.diagcode ,1,3) BETWEEN 'E10' AND 'E14' AND c.date_dx>l.date_serv;
 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.283644;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:114;a:5:{i:0;s:34:"DROP PROCEDURE IF EXISTS t_service";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.3304441;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:117;a:5:{i:0;s:954:"CREATE PROCEDURE t_service()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '15';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');


DROP TABLES IF EXISTS tmp_service;
CREATE TABLE IF NOT EXISTS tmp_service (
KEY(cid),KEY(hospcode),KEY(pid),KEY(seq),
KEY(date_serv),KEY(instype),KEY(typein),
KEY(typeout),KEY(CAUSEIN),KEY(hospcode,pid),
KEY(hospcode,pid,seq),KEY(hospcode,pid,instype),
KEY(hospcode,pid,typein)
) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		s.hospcode,s.pid,s.seq,s.date_serv,s.intime,s.location,s.instype,s.main,s.typein,s.referinhosp
		,s.causein,s.servplace,s.sbp,s.dbp,s.typeout,s.referouthosp,s.causeout,s.cost,s.price
,s.payprice,s.actualpay,p.CID,p.nation
FROM
	service s LEFT JOIN t_person_db p ON s.HOSPCODE=p.HOSPCODE AND s.PID=p.PID
WHERE	DATE_SERV BETWEEN @start_d AND @end_d
);
#DROP TABLES IF EXISTS tmp_diag_ipd;

 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.392844;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:120;a:5:{i:0;s:36:"DROP PROCEDURE IF EXISTS t_admission";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.4396441;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:123;a:5:{i:0;s:936:"CREATE PROCEDURE t_admission()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '16';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'0701');
SET @end_d:=concat(@b_year,'0930');


DROP TABLES IF EXISTS tmp_admission;
CREATE TABLE IF NOT EXISTS tmp_admission (
KEY (cid),
KEY (hospcode),
KEY (pid),
KEY (datetime_admit),
KEY (datetime_disch),
KEY (instype),
KEY (TYPEIN),
KEY (REFERINHOSP),
KEY (DISCHSTATUS),
KEY (DISCHTYPE),
KEY (REFEROUTHOSP),
KEY (an),
KEY (hospcode,an)
) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		a.*,IF(DATEDIFF(DATETIME_DISCH,DATETIME_ADMIT)!=0,DATEDIFF(DATETIME_DISCH,DATETIME_ADMIT),1) as day,p.CID,p.nation
FROM
	admission a LEFT JOIN t_person_db p ON a.HOSPCODE=p.HOSPCODE AND a.PID=p.PID
WHERE	(DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d') BETWEEN @start_d AND @end_d OR DATE_FORMAT(DATETIME_DISCH,'%Y%m%d') BETWEEN @start_d AND @end_d)
);



 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.502044;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:126;a:5:{i:0;s:32:"DROP PROCEDURE IF EXISTS t_death";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.5644441;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:129;a:5:{i:0;s:4295:"CREATE PROCEDURE t_death()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '17';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLES IF EXISTS tmp_death;
CREATE TABLE IF NOT EXISTS tmp_death (
error_code varchar(255) DEFAULT null,
correct_cause varchar(9)  DEFAULT null,
KEY(cid),
KEY(hospcode),
KEY(pid),
KEY(DDEATH),
KEY(CDEATH)
) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		a.HOSPCODE,a.PID,a.HOSPDEATH,a.AN,a.SEQ,a.ddeath,a.cdeath_a,a.CDEATH_B,a.CDEATH_C,a.CDEATH_D,a.ODISEASE,a.cdeath,a.PREGDEATH,a.pdeath,a.PROVIDER,a.d_update,p.CID,p.nation,age(a.ddeath,p.birth,'y') as age_y,p.sex,p.check_hosp,p.check_vhid,p.check_typearea,p.vhid,p.typearea,null as error_code,null as correct_cause
FROM
	death a LEFT JOIN t_person_db p ON a.HOSPCODE=p.HOSPCODE AND a.PID=p.PID 
WHERE	DDEATH BETWEEN @start_d AND @end_d 
		);

UPDATE tmp_death d INNER JOIN person p ON d.HOSPCODE=p.HOSPCODE AND d.PID=p.PID
SET error_code =IF(ISNULL(error_code),'DE0001',CONCAT(error_code,',','DE0001') ) 
WHERE   p.DISCHARGE NOT IN(1) ;

UPDATE tmp_death d INNER JOIN chronic c ON d.HOSPCODE=c.HOSPCODE AND d.PID=c.PID
SET error_code =IF(ISNULL(error_code),'DE0002',CONCAT(error_code,',','DE0002') ) 
WHERE  c.date_disch is null  AND c.typedisch NOT IN(2)   ;

UPDATE tmp_death d INNER JOIN ncdscreen n ON d.HOSPCODE=n.HOSPCODE AND d.PID=n.PID
SET error_code =IF(ISNULL(error_code),'DE0003',CONCAT(error_code,',','DE0003') ) 
WHERE    n.DATE_SERV > d.DDEATH ;

UPDATE tmp_death d INNER JOIN tmp_service s ON d.HOSPCODE=s.HOSPCODE AND d.PID=s.PID
SET error_code =IF(ISNULL(error_code),'DE0004',CONCAT(error_code,',','DE0004') ) 
WHERE    s.DATE_SERV > d.DDEATH ;

UPDATE tmp_death d  SET correct_cause = cdeath_a;
UPDATE tmp_death d  SET correct_cause = cdeath_b
WHERE  cdeath_b is not null AND TRIM(cdeath_b) !='';
UPDATE tmp_death d  SET correct_cause = cdeath_c
WHERE  cdeath_c is not null AND TRIM(cdeath_c) !='';
UPDATE tmp_death d  SET correct_cause = cdeath_d
WHERE  cdeath_d is not null AND TRIM(cdeath_d) !='';

UPDATE tmp_death d 
SET error_code =IF(ISNULL(error_code),'DE0005',CONCAT(error_code,',','DE0005') ) 
WHERE  trim(correct_cause) != trim(cdeath);

UPDATE tmp_death d 
SET error_code =IF(ISNULL(error_code),'DE0006',CONCAT(error_code,',','DE0006') ) 
WHERE  SUBSTR(d.CDEATH,1,3) BETWEEN 'R00' AND 'R99' OR
					SUBSTR(d.CDEATH,1,3) BETWEEN 'Y10' AND 'Y34' OR
					SUBSTR(d.CDEATH,1,3) IN('C80','C97','I46','I50') OR
					SUBSTR(d.CDEATH,1,4) IN('I490','I709') OR
					d.CDEATH IN('Y872','I472','I514','I515','I516','I519');

UPDATE tmp_death d 
SET error_code =IF(ISNULL(error_code),'DE0008',CONCAT(error_code,',','DE0008') ) 
WHERE  pdeath IN(1) AND (LENGTH(TRIM(HOSPDEATH)) != 5 OR HOSPDEATH IS NULL) ;


DROP TABLES IF EXISTS t_death;
CREATE TABLE IF NOT EXISTS t_death (
KEY(cid),
KEY(hospcode),
KEY(pid),
KEY(DDEATH),
KEY(CDEATH)
) ENGINE=MyISAM  AS(
SELECT
		a.*,g.groupcode1560,groupcode3560,groupcode190,g.groupname1560,groupname3560,groupname190
FROM
	tmp_death a,cage g
WHERE	 a.age_y=g.age AND check_typearea in(1,3)
);


DROP TABLES IF EXISTS t_death_sex_age1560;
CREATE TABLE IF NOT EXISTS t_death_sex_age1560 (
  `id` varchar(32) not null default '',
	`year` varchar(4) not null default '',
	`hospcode` varchar(5) not null default '',
  `areacode` varchar(8) not null default '',
  `sex` varchar(15) not null default '',
  `diagcode` varchar(9) not null default '',
  `groupcode` int(2) not null default 0,
  `groupname` varchar(255) not null default '',
  `result` int(9) not null default 0,
  KEY `hospcode` (`hospcode`),
  KEY `areacode` (`areacode`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

DELETE FROM t_death_sex_age1560 WHERE year= year(now())+543;

INSERT IGNORE INTO t_death_sex_age1560
(
	SELECT
	@id ,(@b_year+543) as year,ag.hospcode,ag.vhid,ag.sex,cdeath,ag.groupcode,ag.groupname,ag.result
	FROM
			(SELECT
			check_hosp as hospcode,check_vhid as vhid,sex,cdeath ,groupcode1560 as groupcode ,groupname1560 as groupname,COUNT(*) as result
			FROM
			t_death
			GROUP BY
			check_hosp,check_vhid,sex,cdeath,groupcode1560
			ORDER BY check_hosp,check_vhid
			) as ag
);


 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.6580441;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:132;a:5:{i:0;s:34:"DROP PROCEDURE IF EXISTS t_newborn";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.704844;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:135;a:5:{i:0;s:519:"CREATE PROCEDURE t_newborn()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '18';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS t_newborn;
CREATE TABLE IF NOT EXISTS t_newborn (
PRIMARY KEY (CID,BDATE)
) ENGINE=MyISAM  IGNORE AS
SELECT n.* FROM tmp_newborn n INNER JOIN chospital h ON n.hospcode=h.hoscode WHERE  h.hostype in(5,6,7,11);

INSERT IGNORE t_newborn (SELECT * FROM tmp_newborn);



 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.798444;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:138;a:5:{i:0;s:31:"DROP PROCEDURE IF EXISTS t_card";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.8608451;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:141;a:5:{i:0;s:675:"CREATE PROCEDURE t_card()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '19';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
DROP TABLES IF EXISTS tmp_card;
CREATE TABLE IF NOT EXISTS tmp_card (
KEY(cid),
KEY(hospcode),
KEY(pid)
) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
	c.*
FROM
		(SELECT 
				a.*,p.CID,p.nation,p.sex,p.check_hosp,p.check_vhid,p.check_typearea,p.vhid,p.typearea
		FROM
			card a LEFT JOIN t_person_db p ON a.HOSPCODE=p.HOSPCODE AND a.PID=p.PID 
		WHERE	 p.check_typearea in(1,3)
		ORDER BY cid ASC,d_update DESC
		) as c
GROUP BY cid
);



 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.907645;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:144;a:5:{i:0;s:35:"DROP PROCEDURE IF EXISTS t_drug_opd";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.9544449;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:147;a:5:{i:0;s:3018:"CREATE PROCEDURE t_drug_opd()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '20';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLES IF EXISTS tmp_drug_opd;
CREATE TABLE IF NOT EXISTS tmp_drug_opd (
  `HOSPCODE` varchar(5) NOT NULL,
  `PID` varchar(15) NOT NULL,
  `SEQ` varchar(16) NOT NULL,
  `DATE_SERV` date NOT NULL,
  `CLINIC` varchar(5) NOT NULL,
  `DIDSTD` varchar(24) NOT NULL,
  `DNAME` varchar(255) DEFAULT NULL,
  `AMOUNT` int(12) DEFAULT NULL,
  `UNIT` varchar(3) DEFAULT NULL,
  `UNIT_PACKING` varchar(20) DEFAULT NULL,
  `DRUGPRICE` decimal(11,2) DEFAULT NULL,
  `DRUGCOST` decimal(11,2) DEFAULT NULL,
  `PROVIDER` varchar(15) DEFAULT NULL,
  `D_UPDATE` datetime NOT NULL,
  `CID` varchar(13) DEFAULT NULL,
	`nation` varchar(4) DEFAULT NULL,
	`sex` varchar(1) DEFAULT NULL,
	`check_hosp` varchar(5) DEFAULT NULL,
	`check_vhid` varchar(8) DEFAULT NULL,
	`check_typearea` varchar(1) DEFAULT NULL,
	`vhid` varchar(8) DEFAULT NULL,
	`typearea` varchar(1) DEFAULT NULL,
	`drug_name` varchar(255) DEFAULT NULL,
	`drug_type` varchar(50) DEFAULT NULL,
	`ed` varchar(1) DEFAULT NULL,
	`age_y` int(3) DEFAULT 0,
	`instype` varchar(4) DEFAULT NULL,
	`instypegroup` int(3) DEFAULT 0,
	`groupcode060` int(3) DEFAULT 0,
  PRIMARY KEY (`HOSPCODE`,`PID`,`SEQ`,`DIDSTD`),
  KEY `idx1` (`HOSPCODE`,`PID`),
  KEY `idx2` (`DATE_SERV`),
  KEY `idx3` (`HOSPCODE`),
  KEY `idx4` (`DIDSTD`),
  KEY `idx5` (`HOSPCODE`,`PROVIDER`),
  KEY `idx6` (`cid`),
  KEY `idx7` (`seq`),
  KEY `idx8` (`pid`),
  KEY `idx9` (`check_typearea`),
  KEY `idx10` (`check_vhid`),
  KEY `idx11` (`drug_type`),
  KEY `idx13` (`ed`),
	KEY `idx14` (`age_y`),
	KEY `idx15` (`instype`),
	KEY `idx16` (`instypegroup`),
	KEY `idx17` (`groupcode060`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO tmp_drug_opd
(
	HOSPCODE,PID,SEQ,DATE_SERV,CLINIC,DIDSTD,DNAME,AMOUNT,UNIT,UNIT_PACKING,DRUGPRICE,DRUGCOST,PROVIDER,D_UPDATE
	,CID,nation,sex,check_hosp,check_vhid,check_typearea,vhid,typearea,age_y
)
(
SELECT SQL_BIG_RESULT 
		a.HOSPCODE,a.PID,a.SEQ,a.DATE_SERV,a.CLINIC,a.DIDSTD,a.DNAME,a.amount,a.unit,a.unit_packing,a.drugprice,a.drugcost,a.PROVIDER,a.D_UPDATE,pe.CID,pe.nation,pe.sex,pe.check_hosp,pe.check_vhid,pe.check_typearea,pe.vhid,pe.typearea,age(a.date_serv,pe.birth,'y')
FROM
	drug_opd a LEFT JOIN t_person_db pe ON  a.HOSPCODE=pe.HOSPCODE AND a.PID=pe.PID
WHERE	date_serv BETWEEN @start_d AND @end_d 
);

UPDATE tmp_drug_opd d,cage ag SET d.groupcode060=ag.groupcode060
WHERE d.age_y=ag.age; 

UPDATE tmp_drug_opd d,tmp_service s SET d.instype=s.instype
WHERE d.HOSPCODE=s.HOSPCODE AND d.PID=s.PID AND d.seq=s.seq ; 

UPDATE tmp_drug_opd d,cinstype_new i SET d.instypegroup=i.instypegroup
WHERE d.instype=i.instypecode; 


UPDATE tmp_drug_opd d,cdrug_planthai p SET d.drug_name=p.drug_name ,d.drug_type=p.drug_type ,d.ed=p.ed
WHERE d.didstd=p.DIDSTD; 


 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.016845;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:150;a:5:{i:0;s:35:"DROP PROCEDURE IF EXISTS t_planthai";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.0636449;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:153;a:5:{i:0;s:4017:"CREATE PROCEDURE t_planthai()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '21';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLES IF EXISTS t_planthai_proced;
CREATE TABLE IF NOT EXISTS t_planthai_proced(
	`hospcode` varchar(5) NOT null,
  `pid` varchar(15) NOT null,
	`seq` varchar(16) NOT null,
	`date_serv` date NOT NULL,
	`procedcode` varchar(8) default null,
	`instype` varchar(4) default null,
	`instypegroup` varchar(2) default null,
	`tmtype` varchar(1)  default null,
	`servplace` varchar(1)  default null,
	`age_y` int(3)  default 0,
	`cid` varchar(13)  default null,
  KEY `hospcode` (`hospcode`),
  KEY `pid` (`pid`),
	KEY `cid` (`cid`),
  KEY `seq` (`seq`),
  KEY `date_serv` (`date_serv`),
	KEY `procedcode` (`procedcode`),
	KEY `instype` (`instype`),
	KEY `instypegroup` (`instypegroup`),
	KEY `tmtype` (`tmtype`),
	KEY `servplace` (`servplace`),
  KEY `HOSPCODE_PID` (`hospcode`,`pid`,`seq`)
)ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT INTO t_planthai_proced
(
		hospcode,pid,seq,date_serv,procedcode,tmtype
)
(
SELECT SQL_BIG_RESULT  p.hospcode,p.pid,p.seq,p.date_serv,PROCEDCODE,tmtype
FROM
		tmp_procedure_opd p 
		INNER JOIN cicd9ttm_planthai t ON p.PROCEDCODE= t.code
	WHERE
		t.code is not null
		AND p.date_serv BETWEEN @start_d AND @end_d 
);

INSERT INTO t_planthai_proced
(
		hospcode,pid,seq,date_serv,procedcode
)
(
SELECT SQL_BIG_RESULT  p.hospcode,p.pid,p.seq,p.date_serv,PROCEDCODE
FROM
		tmp_procedure_opd p 
WHERE
PROCEDCODE IN ('9991','9992','9335') 
AND p.date_serv BETWEEN @start_d AND @end_d 
);

UPDATE t_planthai_proced p,tmp_service s SET p.instype=s.instype,p.servplace=s.servplace
WHERE 
	s.hospcode = p.hospcode AND s.pid = p.pid AND s.seq = p.seq ;

UPDATE t_planthai_proced p,cinstype_new i SET p.instypegroup=i.instypegroup
WHERE 
	p.instype = i.instypecode ;

UPDATE t_planthai_proced p,t_person_db pe  SET p.age_y= age(p.date_serv,pe.BIRTH,'y'),p.cid=pe.cid
WHERE 
	p.hospcode=pe.hospcode AND p.pid=pe.pid  ;

/**************/

DROP TABLES IF EXISTS t_planthai_diag_proced;

CREATE TABLE IF NOT EXISTS t_planthai_diag_proced(
	`hospcode` varchar(5) NOT null,
  `pid` varchar(15) NOT null,
	`seq` varchar(16) NOT null,
	`date_serv` date NOT NULL,
	`diagcode` varchar(8) default null,
	`diagtype` varchar(1) default null,
	`procedcode` varchar(8) default null,
	`instype` varchar(4) default null,
	`instypegroup` varchar(2) default null,
	`diseasethai` varchar(255) default null,
	`tmtype` varchar(1)  default null,
	`servplace` varchar(1)  default null,
	`age_y` int(3)  default 0,
`cid` varchar(13)  default null,
  KEY `hospcode` (`hospcode`),
  KEY `pid` (`pid`),
KEY `cid` (`cid`),
  KEY `seq` (`seq`),
  KEY `date_serv` (`date_serv`),
	KEY `diagcode` (`diagcode`),
	KEY `diagtype` (`diagtype`),
	KEY `procedcode` (`procedcode`),
	KEY `instype` (`instype`),
	KEY `instypegroup` (`instypegroup`),
	KEY `tmtype` (`tmtype`),
	KEY `servplace` (`servplace`),
	KEY `age_y` (`age_y`),
  KEY `HOSPCODE_PID` (`hospcode`,`pid`,`seq`)
)ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT INTO t_planthai_diag_proced
(
		hospcode,pid,seq,date_serv,diagcode,diagtype,procedcode,tmtype,servplace,instype,instypegroup
)
(
		SELECT SQL_BIG_RESULT  a.hospcode,a.pid,a.seq,a.date_serv,a.diagcode,a.diagtype,p.PROCEDCODE,p.tmtype,p.servplace,p.instype,p.instypegroup
		FROM
			tmp_diag_opd a
			LEFT JOIN t_planthai_proced p ON a.hospcode=p.hospcode AND a.pid=p.pid AND a.seq=p.seq AND a.date_serv=p.date_serv
		WHERE	a.date_serv BETWEEN @start_d AND @end_d 
		AND SUBSTR(a.diagcode,1,1)='U'
);

UPDATE t_planthai_diag_proced p,cdisease d  SET p.diseasethai=d.diseasethai
WHERE 
	d.diagcode = p.diagcode  ;


UPDATE t_planthai_diag_proced p,t_person_db pe  SET p.age_y= age(p.date_serv,pe.BIRTH,'y'),p.cid=pe.cid
WHERE 
	p.hospcode=pe.hospcode AND p.pid=pe.pid  ;

 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.1270449;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:156;a:5:{i:0;s:36:"DROP PROCEDURE IF EXISTS t_planthai1";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.195446;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:159;a:5:{i:0;s:2120:"CREATE PROCEDURE t_planthai1()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '22';
SET	@send :=  IF((SELECT active FROM sys_report WHERE cat_id = @cat_id and id = @id )=1,0,2);
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS tmp_diag_no_z;
CREATE  TABLE IF NOT EXISTS  tmp_diag_no_z(index (hospcode,pid,seq)) ENGINE MyIsam
AS
(
SELECT hospcode,pid,seq FROM tmp_diag_opd 
WHERE  substr(diagcode ,1,1)  != 'Z' AND DATE_SERV BETWEEN @start_d AND @end_d 
GROUP BY hospcode,pid,seq
);

DROP TABLE IF EXISTS t_planthai1;
CREATE TABLE IF NOT EXISTS t_planthai1(
hospcode VARCHAR(5) NOT NULL,
pid VARCHAR(18) NOT NULL,
seq VARCHAR(18) NOT NULL,
date_serv date,
instypegroup INT(2) DEFAULT NULL,
planthai INT(1) DEFAULT NULL,
KEY hospcode (hospcode),
KEY pid (pid),
KEY seq (seq),
KEY date_serv (date_serv),
KEY planthai (planthai),
KEY instypegroup (instypegroup)

)ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT INTO t_planthai1
(
	HOSPCODE,PID,SEQ,DATE_SERV,instypegroup
)
(
SELECT SQL_BIG_RESULT s.HOSPCODE,s.PID,s.SEQ,s.DATE_SERV,i.instypegroup
FROM tmp_service s LEFT JOIN cinstype_new i ON s.instype = i.instypecode
INNER JOIN tmp_diag_no_z d ON s.hospcode=d.hospcode AND s.pid=d.pid AND s.seq=d.seq
WHERE s.DATE_SERV BETWEEN @start_d AND @end_d
);

UPDATE
	t_planthai1 p1,
	(
			SELECT SQL_BIG_RESULT 
			e3.*
			FROM
			(
			SELECT HOSPCODE,PID,SEQ,DATE_SERV,instypegroup
			FROM t_planthai_diag_proced 
			WHERE DATE_SERV BETWEEN @start_d AND @end_d
			AND LEFT(DIAGCODE,1) = 'U'

			UNION
			SELECT HOSPCODE,PID,SEQ,DATE_SERV,instypegroup 
			FROM tmp_drug_opd
			WHERE DATE_SERV BETWEEN @start_d AND @end_d
			AND LEFT(DIDSTD,2) IN ('41','42') 
			
			UNION
			SELECT HOSPCODE,PID,SEQ,DATE_SERV,instypegroup 
			FROM t_planthai_proced
			WHERE DATE_SERV BETWEEN @start_d AND @end_d
			) as e3
			GROUP BY HOSPCODE,PID,SEQ,DATE_SERV,instypegroup

	) p2
		SET planthai=1 
WHERE p1.hospcode=p2.hospcode AND p1.pid=p2.pid AND p1.seq=p2.seq;
	
 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.248647;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:162;a:5:{i:0;s:31:"DROP PROCEDURE IF EXISTS t_cmi1";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.2954471;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:165;a:5:{i:0;s:3727:"CREATE PROCEDURE t_cmi1()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '23';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLES IF EXISTS tmp_cmiadmission;
CREATE TABLE IF NOT EXISTS tmp_cmiadmission(
SELECT SQL_BIG_RESULT t.hospcode, t.drg, count(t.an) as cntan, sum(t.adjrw) as sumadj
, count(if(month(t.datetime_disch)=10 and t.ERROR=0,t.an,null)) as cntm10
, sum(if(month(t.datetime_disch)=10 and t.ERROR=0,t.adjrw,0)) as adjm10
, count(if(month(t.datetime_disch)=11 and t.ERROR=0,t.an,null)) as cntm11
, sum(if(month(t.datetime_disch)=11 and t.ERROR=0,t.adjrw,0)) as adjm11
, count(if(month(t.datetime_disch)=12 and t.ERROR=0,t.an,null)) as cntm12
, sum(if(month(t.datetime_disch)=12 and t.ERROR=0,t.adjrw,0)) as adjm12
, count(if(month(t.datetime_disch)=1 and t.ERROR=0,t.an,null)) as cntm01
, sum(if(month(t.datetime_disch)=1 and t.ERROR=0,t.adjrw,0)) as adjm01
, count(if(month(t.datetime_disch)=2 and t.ERROR=0,t.an,null)) as cntm02
, sum(if(month(t.datetime_disch)=2 and t.ERROR=0,t.adjrw,0)) as adjm02
, count(if(month(t.datetime_disch)=3 and t.ERROR=0,t.an,null)) as cntm03
, sum(if(month(t.datetime_disch)=3 and t.ERROR=0,t.adjrw,0)) as adjm03
, count(if(month(t.datetime_disch)=4 and t.ERROR=0,t.an,null)) as cntm04
, sum(if(month(t.datetime_disch)=4 and t.ERROR=0,t.adjrw,0)) as adjm04
, count(if(month(t.datetime_disch)=5 and t.ERROR=0,t.an,null)) as cntm05
, sum(if(month(t.datetime_disch)=5 and t.ERROR=0,t.adjrw,0)) as adjm05
, count(if(month(t.datetime_disch)=6 and t.ERROR=0,t.an,null)) as cntm06
, sum(if(month(t.datetime_disch)=6 and t.ERROR=0,t.adjrw,0)) as adjm06
, count(if(month(t.datetime_disch)=7 and t.ERROR=0,t.an,null)) as cntm07
, sum(if(month(t.datetime_disch)=7 and t.ERROR=0,t.adjrw,0)) as adjm07
, count(if(month(t.datetime_disch)=8 and t.ERROR=0,t.an,null)) as cntm08
, sum(if(month(t.datetime_disch)=8 and t.ERROR=0, t.adjrw,0)) as adjm08
, count(if(month(t.datetime_disch)=9 and t.ERROR=0,t.an,null)) as cntm09
, sum(if(month(t.datetime_disch)=9 and t.ERROR=0,t.adjrw,0)) as adjm09
, count(if(t.error=0, t.HOSPCODE,null)) as cntok
FROM admission t
WHERE date_format(t.datetime_disch,'%Y%m%d') BETWEEN @start_d and @end_d
GROUP BY t.hospcode, t.drg
);
ALTER TABLE tmp_cmiadmission ADD KEY(hospcode);

DROP TABLES IF EXISTS tmp_ccmihosp;
CREATE TABLE IF NOT EXISTS tmp_ccmihosp(
SELECT
t.hcode, t.hname, t.chwcode, t.chwname, t.region, t.regbed, t.actbed, t.splevel
FROM ccmihosp t
WHERE t.byear=@b_year+543
);
ALTER TABLE tmp_ccmihosp ADD KEY(hcode);
ALTER TABLE tmp_ccmihosp ADD KEY(splevel);

DROP TABLES IF EXISTS tmp_ccmistd;
CREATE TABLE IF NOT EXISTS tmp_ccmistd(
SELECT
t.splevel, t.refcmi, t.pctlowcmi
FROM ccmistd t
WHERE t.byear=@b_year+543
);
ALTER TABLE tmp_ccmistd ADD KEY(splevel);

DROP TABLES IF EXISTS t_cmi_admission;
CREATE TABLE IF NOT EXISTS t_cmi_admission(
SELECT SQL_BIG_RESULT
t.hospcode, t.drg, t.cntan, t.sumadj
, h.hname, h.chwcode, h.chwname, h.region, h.regbed, h.actbed, h.splevel
, s.refcmi, s.pctlowcmi, @b_year as byear
, t.cntm10, t.adjm10, t.cntm11, t.adjm11, t.cntm12, t.adjm12, t.cntm01, t.adjm01
, t.cntm02, t.adjm02, t.cntm03, t.adjm03, t.cntm04, t.adjm04, t.cntm05, t.adjm05
, t.cntm06, t.adjm06, t.cntm07, t.adjm07, t.cntm08, t.adjm08, t.cntm09, t.adjm09
, t.cntok
FROM tmp_cmiadmission t JOIN tmp_ccmihosp h ON t.hospcode = h.hcode
JOIN tmp_ccmistd s ON h.splevel = s.splevel
);
ALTER TABLE tmp_ccmistd ADD KEY(splevel);

DROP TABLES IF EXISTS tmp_cmiadmission;
#DROP TABLES IF EXISTS tmp_diag_ipd;
DROP TABLES IF EXISTS tmp_ccmihosp;
DROP TABLES IF EXISTS tmp_ccmistd;
 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.342247;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:168;a:5:{i:0;s:29:"DROP PROCEDURE IF EXISTS t_bp";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.3998489;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:171;a:5:{i:0;s:5446:"CREATE PROCEDURE t_bp()
 BEGIN 
SET	@prov_c := '58';
SET @id := '24';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d1:=concat(@b_year-1,'1001');
SET @end_d1:=concat(@b_year-1,'1231');
SET	@start_d2:=concat(@b_year,'0101');
SET @end_d2:=concat(@b_year,'0331');
SET	@start_d3:=concat(@b_year,'0401');
SET @end_d3:=concat(@b_year,'0630');
SET	@start_d4:=concat(@b_year,'0701');
SET @end_d4:=concat(@b_year,'0930');

DROP  TABLE IF EXISTS tmp_bp;
CREATE  TABLE IF NOT EXISTS tmp_bp  (
		cid  VARCHAR(13) not null 
		,bp_date1_tr1 date
		,sbp1_tr1 int(3) DEFAULT 0
		,dbp1_tr1 int(3) DEFAULT 0
		,bp_date2_tr1 date
		,sbp2_tr1 int(3) DEFAULT 0
		,dbp2_tr1 int(3) DEFAULT 0

		,bp_date1_tr2 date
		,sbp1_tr2 int(3) DEFAULT 0
		,dbp1_tr2 int(3) DEFAULT 0
		,bp_date2_tr2 date
		,sbp2_tr2 int(3) DEFAULT 0
		,dbp2_tr2 int(3) DEFAULT 0

		,bp_date1_tr3 date
		,sbp1_tr3 int(3) DEFAULT 0
		,dbp1_tr3 int(3) DEFAULT 0
		,bp_date2_tr3 date
		,sbp2_tr3 int(3) DEFAULT 0
		,dbp2_tr3 int(3) DEFAULT 0

		,bp_date1_tr4 date
		,sbp1_tr4 int(3) DEFAULT 0
		,dbp1_tr4 int(3) DEFAULT 0
		,bp_date2_tr4 date
		,sbp2_tr4 int(3) DEFAULT 0
		,dbp2_tr4 int(3) DEFAULT 0
		
,INDEX(CID)
) ENGINE=MyISAM  ;

INSERT INTO tmp_bp (
cid
)
(
	SELECT c.cid
	FROM tmp_chronicfu c
	INNER JOIN (SELECT cid,type_dx FROM t_dmht WHERE type_dx in('01','03')) dh ON dh.cid=c.CID
	WHERE  LENGTH(TRIM(c.cid))=13 AND c.DATE_SERV BETWEEN @start_d1 AND @end_d4
	GROUP BY c.cid
);

UPDATE tmp_bp bp,( SELECT c.cid,c.DATE_SERV,c.SBP,c.DBP
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV<=@end_d1 AND c.DATE_SERV =
								(SELECT c1.DATE_SERV 
								FROM tmp_chronicfu c1
								WHERE c1.cid=c.cid AND c1.DATE_SERV <=@end_d1
								GROUP BY c1.cid,c1.DATE_SERV 
								ORDER BY c1.date_serv desc LIMIT 0,1)
								GROUP BY cid
										) tbp
	SET bp.bp_date1_tr1=tbp.DATE_SERV ,bp.sbp1_tr1=tbp.sbp , bp.dbp1_tr1=tbp.dbp 
WHERE bp.cid=tbp.cid
;

UPDATE tmp_bp bp,( SELECT c.cid,c.DATE_SERV,c.SBP,c.DBP
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV<=@end_d1 AND c.DATE_SERV =
								(SELECT c1.DATE_SERV 
								FROM tmp_chronicfu c1
								WHERE c1.cid=c.cid AND c1.DATE_SERV <=@end_d1
								GROUP BY c1.cid,c1.DATE_SERV 
								ORDER BY c1.date_serv desc LIMIT 1,1)
								GROUP BY cid
										) tbp
	SET bp.bp_date2_tr1=tbp.DATE_SERV ,bp.sbp2_tr1=tbp.sbp , bp.dbp2_tr1=tbp.dbp 
WHERE bp.cid=tbp.cid
;

UPDATE tmp_bp bp,( SELECT c.cid,c.DATE_SERV,c.SBP,c.DBP
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV<=@end_d2 AND c.DATE_SERV =
								(SELECT c1.DATE_SERV 
								FROM tmp_chronicfu c1
								WHERE c1.cid=c.cid AND c1.DATE_SERV <=@end_d2
								GROUP BY c1.cid,c1.DATE_SERV 
								ORDER BY c1.date_serv desc LIMIT 0,1)
								GROUP BY cid
										) tbp
	SET bp.bp_date1_tr2=tbp.DATE_SERV ,bp.sbp1_tr2=tbp.sbp , bp.dbp1_tr2=tbp.dbp 
WHERE bp.cid=tbp.cid
;

UPDATE tmp_bp bp,( SELECT c.cid,c.DATE_SERV,c.SBP,c.DBP
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV<=@end_d2 AND c.DATE_SERV =
								(SELECT c1.DATE_SERV 
								FROM tmp_chronicfu c1
								WHERE c1.cid=c.cid AND c1.DATE_SERV <=@end_d2
								GROUP BY c1.cid,c1.DATE_SERV 
								ORDER BY c1.date_serv desc LIMIT 1,1)
								GROUP BY cid
										) tbp
	SET bp.bp_date2_tr2=tbp.DATE_SERV ,bp.sbp2_tr2=tbp.sbp , bp.dbp2_tr2=tbp.dbp 
WHERE bp.cid=tbp.cid
;


UPDATE tmp_bp bp,( SELECT c.cid,c.DATE_SERV,c.SBP,c.DBP
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV<=@end_d3 AND c.DATE_SERV =
								(SELECT c1.DATE_SERV 
								FROM tmp_chronicfu c1
								WHERE c1.cid=c.cid AND c1.DATE_SERV <=@end_d3
								GROUP BY c1.cid,c1.DATE_SERV 
								ORDER BY c1.date_serv desc LIMIT 0,1)
								GROUP BY cid
										) tbp
	SET bp.bp_date1_tr3=tbp.DATE_SERV ,bp.sbp1_tr3=tbp.sbp , bp.dbp1_tr3=tbp.dbp 
WHERE bp.cid=tbp.cid
;

UPDATE tmp_bp bp,( SELECT c.cid,c.DATE_SERV,c.SBP,c.DBP
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV<=@end_d3 AND c.DATE_SERV =
								(SELECT c1.DATE_SERV 
								FROM tmp_chronicfu c1
								WHERE c1.cid=c.cid AND c1.DATE_SERV <=@end_d3
								GROUP BY c1.cid,c1.DATE_SERV 
								ORDER BY c1.date_serv desc LIMIT 1,1)
								GROUP BY cid
										) tbp
	SET bp.bp_date2_tr3=tbp.DATE_SERV ,bp.sbp2_tr3=tbp.sbp , bp.dbp2_tr3=tbp.dbp 
WHERE bp.cid=tbp.cid
;


UPDATE tmp_bp bp,( SELECT c.cid,c.DATE_SERV,c.SBP,c.DBP
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV<=@end_d4 AND c.DATE_SERV =
								(SELECT c1.DATE_SERV 
								FROM tmp_chronicfu c1
								WHERE c1.cid=c.cid AND c1.DATE_SERV <=@end_d4
								GROUP BY c1.cid,c1.DATE_SERV 
								ORDER BY c1.date_serv desc LIMIT 0,1)
								GROUP BY cid
										) tbp
	SET bp.bp_date1_tr4=tbp.DATE_SERV ,bp.sbp1_tr4=tbp.sbp , bp.dbp1_tr4=tbp.dbp 
WHERE bp.cid=tbp.cid
;

UPDATE tmp_bp bp,( SELECT c.cid,c.DATE_SERV,c.SBP,c.DBP
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV<=@end_d4 AND c.DATE_SERV =
								(SELECT c1.DATE_SERV 
								FROM tmp_chronicfu c1
								WHERE c1.cid=c.cid AND c1.DATE_SERV <=@end_d4
								GROUP BY c1.cid,c1.DATE_SERV 
								ORDER BY c1.date_serv desc LIMIT 1,1)
								GROUP BY cid
										) tbp
	SET bp.bp_date2_tr4=tbp.DATE_SERV ,bp.sbp2_tr4=tbp.sbp , bp.dbp2_tr4=tbp.dbp 
WHERE bp.cid=tbp.cid
;

 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.4440501;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:174;a:5:{i:0;s:29:"DROP PROCEDURE IF EXISTS t_fp";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.5064499;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:177;a:5:{i:0;s:1249:"CREATE PROCEDURE t_fp()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '25';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-2,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP  TABLE IF EXISTS tmp_fp;
CREATE TABLE IF NOT EXISTS tmp_fp(
  `HOSPCODE` varchar(5) NOT NULL,
  `PID` varchar(15) NOT NULL,
  `SEQ` varchar(16) DEFAULT NULL,
  `DATE_SERV` date NOT NULL,
  `FPTYPE` char(1) NOT NULL,
  `FPPLACE` varchar(5) DEFAULT NULL,
  `PROVIDER` varchar(15) DEFAULT NULL,
  `D_UPDATE` datetime NOT NULL,
	 cid varchar(13) DEFAULT NULL,
	 nation varchar(3)  DEFAULT NULL,
	 age_y int(3)  DEFAULT 0,
  PRIMARY KEY (`HOSPCODE`,`PID`,`DATE_SERV`,`FPTYPE`),
  KEY `idx1` (`HOSPCODE`,`PID`),
  KEY `idx2` (`HOSPCODE`),
  KEY `idx3` (`DATE_SERV`),
  KEY `idx4` (`FPTYPE`),
  KEY `idx5` (`FPPLACE`),
  KEY `idx6` (`HOSPCODE`,`PROVIDER`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT INTO tmp_fp 
(
SELECT SQL_BIG_RESULT 
	fp.HOSPCODE,fp.PID,fp.SEQ,fp.DATE_SERV,fp.FPTYPE,fp.FPPLACE,fp.PROVIDER,fp.D_UPDATE,p.cid,p.nation,age(fp.date_serv,p.birth,'y') age_y
FROM
	fp LEFT JOIN person p ON fp.HOSPCODE=p.HOSPCODE AND fp.PID=p.PID
WHERE 
	fp.date_serv BETWEEN @start_d AND @end_d
);


 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.56885;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:180;a:5:{i:0;s:37:"DROP PROCEDURE IF EXISTS t_charge_opd";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.6156509;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:183;a:5:{i:0;s:1347:"CREATE PROCEDURE t_charge_opd()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '26';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLES IF EXISTS tmp_charge_opd;
CREATE TABLE IF NOT EXISTS tmp_charge_opd (
KEY(cid),
KEY(hospcode),
KEY(pid),
KEY(date_serv),
KEY(chargeitem),
KEY(hospcode,pid),
KEY(hospcode,pid,seq)
) ENGINE=MyISAM  AS(
		SELECT 
				a.*,p.CID,p.nation,p.sex,p.check_hosp,p.check_vhid,p.check_typearea,p.vhid,p.typearea
		FROM
			charge_opd a LEFT JOIN t_person_db p ON a.HOSPCODE=p.HOSPCODE AND a.PID=p.PID 
		WHERE a.DATE_SERV BETWEEN  @start_d AND @end_d
);

DROP TABLES IF EXISTS t_charge_opd;
CREATE TABLE IF NOT EXISTS t_charge_opd (
KEY(cid),
KEY(hospcode),
KEY(pid),
KEY(date_serv),
KEY(chargeitem),
KEY(hospcode,pid),
KEY(hospcode,pid,seq)
) ENGINE=MyISAM  AS(
		SELECT 
				HOSPCODE,PID,SEQ,DATE_SERV,CLINIC,CHARGEITEM,CHARGELIST
				,INSTYPE
				,SUM(QUANTITY)  QUANTITY
				,SUM(COST) COST
				,SUM(PRICE) PRICE
				,SUM(PAYPRICE) PAYPRICE
				,D_UPDATE
				,CID, nation, sex, check_hosp, check_vhid, check_typearea, vhid, typearea
		FROM
			tmp_charge_opd a
		WHERE a.DATE_SERV BETWEEN  @start_d AND @end_d
		GROUP BY a.HOSPCODE,a.PID,a.SEQ,CLINIC,a.CHARGEITEM,INSTYPE
);


 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.678051;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:186;a:5:{i:0;s:39:"DROP PROCEDURE IF EXISTS t_nation_labor";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.7248509;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:189;a:5:{i:0;s:4417:"CREATE PROCEDURE t_nation_labor()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '27';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP  TABLE IF EXISTS  t_admission_labor;
CREATE  TABLE IF NOT EXISTS t_admission_labor (INDEX(HOSPCODE,AN)) 
ENGINE=MyISAM  AS 
(
SELECT 
 a.HOSPCODE,a.AN,p.cid,p.sex,a.DATETIME_ADMIT,a.DATETIME_DISCH,a.INSTYPE,a.PRICE,a.PAYPRICE,a.ACTUALPAY,(a.PRICE-a.ACTUALPAY) as fee ,p.LABOR, p.NATION,nationcodeaec,
		IF(LABOR IN('12','14','22','38') ,1
			,IF(LABOR IN('24') ,2
			,IF(LABOR IN('36','37') ,3
			,IF(LABOR IN('22','38') AND SUBSTR(p.CID,1,1) IN(0,3,4,5,6,7,8) ,4
			,IF(LABOR IN('01','02','03','11','15','16','17','18') AND SUBSTR(p.CID,1,1) IN(0,3,4,5,6,7,8) ,5
			,IF(LABOR IN('01','02','03','11','15','16','17','18') ,6,0
		))))))  as labor_group ,'        ' diagcode ,' ' diagtype
FROM tmp_admission a
				INNER JOIN t_person_db p ON a.HOSPCODE =p.HOSPCODE AND a.PID=p.PID
				INNER JOIN cnation n ON a.nation =n.nationcode
WHERE p.nation != 99     AND a.DATETIME_DISCH BETWEEN @start_d AND @end_d  
);
update t_admission_labor	a	LEFT JOIN tmp_diag_ipd d ON a.HOSPCODE =d.HOSPCODE AND a.AN=d.AN   
SET a.diagcode=d.diagcode , a.diagtype=d.diagtype
WHERE d.diagtype in(1);

DROP  TABLE IF EXISTS  t_service_labor;
CREATE  TABLE IF NOT EXISTS t_service_labor (INDEX(HOSPCODE,pid,seq)) 
ENGINE=MyISAM  AS 
(
SELECT 
 a.HOSPCODE,a.pid,p.cid,p.sex,a.seq,a.date_serv,a.INSTYPE,a.PRICE,a.PAYPRICE,a.ACTUALPAY,(a.PRICE-a.ACTUALPAY) as fee ,p.LABOR, p.NATION,nationcodeaec,
		IF(LABOR IN('12','14','22','38') ,1
			,IF(LABOR IN('24') ,2
			,IF(LABOR IN('36','37') ,3
			,IF(LABOR IN('22','38') AND SUBSTR(p.CID,1,1) IN(0,3,4,5,6,7,8) ,4
			,IF(LABOR IN('01','02','03','11','15','16','17','18') AND SUBSTR(p.CID,1,1) IN(0,3,4,5,6,7,8) ,5
			,IF(LABOR IN('01','02','03','11','15','16','17','18') ,6,0
		))))))  as labor_group  ,'        ' diagcode ,' ' diagtype
FROM tmp_service a
					INNER JOIN t_person_db p ON a.HOSPCODE =p.HOSPCODE AND a.PID=p.PID
					INNER JOIN cnation n ON a.nation =n.nationcode
WHERE p.nation != 99     AND a.date_serv BETWEEN @start_d AND @end_d 
);
update t_service_labor	a	LEFT JOIN tmp_diag_opd d ON a.HOSPCODE =d.HOSPCODE AND a.PID=d.PID AND a.SEQ=d.SEQ  
SET a.diagcode=d.diagcode , a.diagtype=d.diagtype
WHERE d.diagtype in(1);



DROP  TABLE IF EXISTS  t_anc_labor;
CREATE  TABLE IF NOT EXISTS t_anc_labor (INDEX(HOSPCODE,pid,seq)) 
ENGINE=MyISAM  AS 
(
SELECT 
 a.HOSPCODE,a.pid,s.cid,s.sex,a.seq,a.date_serv,s.INSTYPE,s.LABOR, s.NATION,nationcodeaec,s.labor_group
FROM tmp_anc a 
				INNER JOIN t_service_labor s ON a.HOSPCODE =s.HOSPCODE AND a.PID=s.PID	AND a.SEQ=s.SEQ	
	WHERE  a.date_serv BETWEEN @start_d AND @end_d 
);


DROP  TABLE IF EXISTS  tmp_postnatal;
CREATE  TABLE IF NOT EXISTS tmp_postnatal (INDEX(HOSPCODE,pid,seq)) 
ENGINE=MyISAM  AS 
(
SELECT po.*,p.cid,p.nation,p.occupation_new occupat,p.birth,p.check_vhid vhid
FROM postnatal po LEFT JOIN t_person_db p ON po.hospcode=p.hospcode and po.pid=p.pid
WHERE po.BDATE BETWEEN @start_d AND @end_d
);

DROP  TABLE IF EXISTS  t_postnatal_labor;
CREATE  TABLE IF NOT EXISTS t_postnatal_labor (INDEX(HOSPCODE,pid,seq)) 
ENGINE=MyISAM  AS 
(
SELECT 
 a.HOSPCODE,a.pid,s.cid,s.sex,a.seq,a.BDATE,s.INSTYPE,s.LABOR, s.NATION,nationcodeaec,s.labor_group
FROM tmp_postnatal a 
				INNER JOIN t_service_labor s ON a.HOSPCODE =s.HOSPCODE AND a.PID=s.PID	AND a.SEQ=s.SEQ	
WHERE a.BDATE BETWEEN @start_d AND @end_d 
);

DROP  TABLE IF EXISTS  t_epi_labor;
CREATE  TABLE IF NOT EXISTS t_epi_labor (INDEX(HOSPCODE,pid,seq)) 
ENGINE=MyISAM  AS 
(
SELECT 
	a.HOSPCODE,a.pid,s.cid,s.sex,a.seq,a.date_serv,s.INSTYPE,s.LABOR, s.NATION,nationcodeaec,s.labor_group
FROM tmp_epi a 
				INNER JOIN t_service_labor s ON a.HOSPCODE =s.HOSPCODE AND a.PID=s.PID	AND a.SEQ=s.SEQ	
	WHERE a.date_serv BETWEEN @start_d AND @end_d 
);

DROP  TABLE IF EXISTS  t_fp_labor;
CREATE  TABLE IF NOT EXISTS t_fp_labor (INDEX(HOSPCODE,pid,seq)) 
ENGINE=MyISAM  AS 
(
SELECT 
 a.HOSPCODE,a.pid,s.cid,s.sex,a.seq,a.date_serv,s.INSTYPE,s.LABOR, s.NATION,nationcodeaec,s.labor_group
FROM tmp_fp a 
				INNER JOIN t_service_labor s ON a.HOSPCODE =s.HOSPCODE AND a.PID=s.PID	AND a.SEQ=s.SEQ	
WHERE a.date_serv BETWEEN @start_d AND @end_d
);
 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.802851;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:192;a:5:{i:0;s:32:"DROP PROCEDURE IF EXISTS t_refer";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.8496511;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:195;a:5:{i:0;s:2406:"CREATE PROCEDURE t_refer()
 BEGIN 
SET @prov_c :='58';
SET	@id:= '28';
SET	@year_start:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@year_start-1,'1001');
SET @end_d:=concat(@year_start,'0930');

DROP TABLE IF EXISTS t_refer;
CREATE TABLE IF NOT EXISTS t_refer (INDEX(HOSPCODE,PID,date_serv)) 
ENGINE=MyISAM  AS 
(SELECT
hospcode,h.provcode prov ,c.zonecode zone,pid,cid,date_serv, 'opd' source,causeout,typeout,referouthosp,ho.provcode referoutprov ,c1.zonecode referzone
FROM
(
SELECT
s.hospcode,s.pid,s.date_serv,s.causeout,s.typeout,s.REFEROUTHOSP,CID
FROM
tmp_service s  
 WHERE s.typeout  in(3) 
AND DATE_FORMAT(s.date_serv,'%Y%m%d') BETWEEN @start_d AND @end_d
) o
INNER JOIN chospital h ON o.hospcode=h.hoscode
LEFT JOIN chospital ho ON o.referouthosp =ho.hoscode
LEFT JOIN cchangwat c ON h.provcode =c.changwatcode
LEFT JOIN cchangwat c1 ON ho.provcode =c1.changwatcode
WHERE
		h.hostype in(5,6,7,11,12,15) AND h.hdc_regist in(1)
);


DROP TABLES IF EXISTS tmpz_admission;
CREATE TABLE IF NOT EXISTS tmpz_admission (
KEY (cid),
KEY (hospcode),
KEY (pid),
KEY (datetime_admit),
KEY (datetime_disch),
KEY (instype),
KEY (TYPEIN),
KEY (REFERINHOSP),
KEY (DISCHSTATUS),
KEY (DISCHTYPE),
KEY (REFEROUTHOSP),
KEY (an),
KEY (hospcode,an)
) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		a.*,IF(DATEDIFF(DATETIME_DISCH,DATETIME_ADMIT)!=0,DATEDIFF(DATETIME_DISCH,DATETIME_ADMIT),1) as day,p.CID,p.nation
FROM
	admission a LEFT JOIN t_person_db p ON a.HOSPCODE=p.HOSPCODE AND a.PID=p.PID
WHERE	(DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d') BETWEEN @start_d1 AND @end_d OR DATE_FORMAT(DATETIME_DISCH,'%Y%m%d') BETWEEN @start_d1 AND @end_d)
);


INSERT IGNORE INTO t_refer(
SELECT
hospcode,h.provcode prov,c.zonecode,pid,cid,date_serv,'ipd',causeout,typeout,referouthosp,ho.provcode referoutprov ,c1.zonecode
FROM
(
SELECT
s.hospcode,s.AN pid,s.DATETIME_DISCH date_serv,s.causeout,s.DISCHTYPE typeout,s.REFEROUTHOSP,CID
FROM
tmpz_admission s  
 WHERE s.DISCHTYPE  in(4) 
AND DATE_FORMAT(s.DATETIME_DISCH,'%Y%m%d') BETWEEN @start_d1 AND @end_d
) o
INNER JOIN chospital h ON o.hospcode=h.hoscode
LEFT JOIN chospital ho ON o.referouthosp =ho.hoscode
LEFT JOIN cchangwat c ON h.provcode =c.changwatcode
LEFT JOIN cchangwat c1 ON ho.provcode =c1.changwatcode
WHERE
		h.hostype in(5,6,7,11,12,15) AND h.hdc_regist in(1)
);

 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.912051;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:198;a:5:{i:0;s:39:"DROP PROCEDURE IF EXISTS t_childdev1830";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.9744511;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:201;a:5:{i:0;s:5594:"CREATE PROCEDURE t_childdev1830()
 BEGIN 
SET @prov_c :='58';
SET	@id:= '29';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
SET @begin_d=DATE_ADD(@start_d,INTERVAL -30 month);
SET @begin_d1=DATE_ADD(@start_d,INTERVAL -1 month);
SET @end_d1:=concat(@b_year,'1030');

DROP TABLE IF EXISTS t_childdev1830;
CREATE TABLE  IF NOT EXISTS t_childdev1830(INDEX (hospcode,pid,cid)) ENGINE=MyISAM  AS  
(SELECT
 p.HOSPCODE,p.PID,p.CID,p.BIRTH,p.check_vhid AREACODE,p.check_typearea TYPEAREA
, if(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d) in(18,30),1,0) M10
, IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 1 MONTH) in(18,30),1,0) M11
, if(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 2 MONTH) in(18,30),1,0) M12
, if(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 3 MONTH) in(18,30),1,0) M01
, if(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 4 MONTH) in(18,30),1,0) M02
, if(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 5 MONTH) in(18,30),1,0) M03
, if(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 6 MONTH) in(18,30),1,0) M04
, if(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 7 MONTH) in(18,30),1,0) M05
, if(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 8 MONTH) in(18,30),1,0) M06
, if(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 9 MONTH) in(18,30),1,0) M07
, if(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 10 MONTH) in(18,30),1,0) M08
, if(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 11 MONTH) in(18,30),1,0) M09

,IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d) in(18),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 1 MONTH) in(18),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 2 MONTH) in(18),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 3 MONTH) in(18),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 4 MONTH) in(18),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 5 MONTH) in(18),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 6 MONTH) in(18),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 7 MONTH) in(18),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 8 MONTH) in(18),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 9 MONTH) in(18),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 10 MONTH) in(18),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 11 MONTH) in(18),1,
   0))))))))))))  AGE_18
,IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d) in(30),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 1 MONTH) in(30),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 2 MONTH) in(30),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 3 MONTH) in(30),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 4 MONTH) in(30),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 5 MONTH) in(30),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 6 MONTH) in(30),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 7 MONTH) in(30),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 8 MONTH) in(30),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 9 MONTH) in(30),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 10 MONTH) in(30),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 11 MONTH) in(30),1,
   0))))))))))))  AGE_30

, STR_TO_DATE('0000000','%Y%m%d') DATE_SERV
,0 AGE_SERV
,0 PASS
, STR_TO_DATE('0000000','%Y%m%d') DATE_START
, STR_TO_DATE('0000000','%Y%m%d') DATE_END
FROM t_person_cid  p
WHERE BIRTH BETWEEN @begin_d AND @end_d AND
						check_typearea in('1','3') AND p.DISCHARGE='9' AND LENGTH(trim(p.CID))=13 AND  
						(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d) IN(18,30) OR 
							TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d + INTERVAL 1 MONTH) IN(18,30) OR 
							TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d + INTERVAL 2 MONTH) IN(18,30) OR 
							TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d + INTERVAL 3 MONTH) IN(18,30) OR 
							TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d + INTERVAL 4 MONTH) IN(18,30) OR 
							TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d + INTERVAL 5 MONTH) IN(18,30) OR 
							TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d + INTERVAL 6 MONTH) IN(18,30) OR 
							TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d + INTERVAL 7 MONTH) IN(18,30) OR 
							TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d + INTERVAL 8 MONTH) IN(18,30) OR 
							TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d + INTERVAL 9 MONTH) IN(18,30) OR 
							TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d + INTERVAL 10 MONTH) IN(18,30) OR 
							TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d + INTERVAL 11 MONTH) IN(18,30) 
						)
);
UPDATE t_childdev1830 SET date_serv=NULL , date_start=NULL ,date_end=NULL  WHERE DATE_FORMAT(date_serv,'%Y%m%d')='00000000';
UPDATE  t_childdev1830 SET date_start=DATE_ADD(BIRTH,INTERVAL 18 month) ,date_end=DATE_ADD(DATE_ADD(BIRTH,INTERVAL 19 month),INTERVAL -1 DAY)  WHERE age_18=1;
UPDATE  t_childdev1830 SET date_start=DATE_ADD(BIRTH,INTERVAL 30 month) ,date_end=DATE_ADD(DATE_ADD(BIRTH,INTERVAL 31 month),INTERVAL -1 DAY)  WHERE age_30=1;

DROP TEMPORARY  TABLE IF EXISTS tmz_nutrition;
CREATE TEMPORARY TABLE tmz_nutrition(INDEX (cid)) ENGINE=MyISAM  AS  
(SELECT p.HOSPCODE,p.PID,p.cid,n1.DATE_SERV
		FROM nutrition n1 INNER JOIN person p ON  p.HOSPCODE =n1.HOSPCODE AND p.PID=n1.PID
		WHERE  n1.CHILDDEVELOP in(SELECT id_childdevelop FROM cchilddevelop)  
		AND n1.date_serv  BETWEEN @begin_d1  AND @end_d1
);
UPDATE  t_childdev1830 c INNER JOIN tmz_nutrition	n ON n.cid=c.cid  SET c.date_serv=n.DATE_SERV 
,c.age_serv=TIMESTAMPDIFF(MONTH,c.BIRTH,n.DATE_SERV),c.pass=1
WHERE  TIMESTAMPDIFF(MONTH,c.BIRTH,n.DATE_SERV) IN(18,30) ; 

DROP TEMPORARY TABLE tmz_nutrition;

 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.021251;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:204;a:5:{i:0;s:38:"DROP PROCEDURE IF EXISTS t_cmi_referin";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.0836511;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:207;a:5:{i:0;s:1231:"CREATE PROCEDURE t_cmi_referin()
 BEGIN 
SET @prov_c :='58';
SET @id:= '30';
SET @year_start:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@year_start-1,'1001');
SET @end_d:=concat(@year_start,'0930');


DROP TABLE IF EXISTS t_cmi_referin;
CREATE TABLE IF NOT EXISTS t_cmi_referin (INDEX(monthly,hospcode,referin,drg)) 
		ENGINE=MyISAM  AS 
		(select @year_start as byear,DATE_FORMAT(t.DATETIME_DISCH,'%Y%m')  as monthly,t.HOSPCODE as hospcode, 
						a.chwcode, a.region, a.splevel, 
						t.REFERINHOSP as referin, b.hostype as refer_hostype, b.provcode as refer_prov, c.zonecode as refer_region,
						t.DRG as drg, count(t.AN) as cases, sum(t.ADJRW) as sum_adjrw,
						sum(if(t.ADJRW=0,1,0)) as adjrw0, t.RW as rw
						from tmp_admission t join (select t.hcode, t.hname, t.chwcode, t.chwname, t.region, t.splevel
										from ccmihosp t where t.byear = @year_start+543) a on t.HOSPCODE = a.hcode
										join chospital b on t.REFERINHOSP = b.hoscode
										join cchangwat c on b.provcode=c.changwatcode
						where t.REFERINHOSP != ''	AND DATE_FORMAT(t.DATETIME_DISCH,'%Y%m%d') BETWEEN @start_d AND @end_d
						group by t.HOSPCODE,monthly, t.REFERINHOSP, t.DRG
) ;

 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.1460509;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:210;a:5:{i:0;s:39:"DROP PROCEDURE IF EXISTS ws_person_dmht";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.192852;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:213;a:5:{i:0;s:3370:"CREATE PROCEDURE ws_person_dmht()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '31';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

CREATE TABLE IF NOT EXISTS ws_person_dmht(
  provcode varchar(2) not null,
  cid varchar(13) not null,
  flag_sent varchar(1) DEFAULT '0',
  type_dx int(1) DEFAULT '0',
	last_hba1c decimal(10,2) DEFAULT 0.00,
  date_serv_hba1c date,
  hba1c_hosp VARCHAR(5),
	last_fpg decimal(10,2) DEFAULT 0.00,
  date_serv_fpg date,
	fpg_hosp VARCHAR(5),
  last_sbp int(3) DEFAULT 0,
  last_dbp int(3) DEFAULT 0,
  date_serv_bp date,
	bp_hosp VARCHAR(5),
PRIMARY KEY (provcode,cid),
KEY (cid)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

CREATE TABLE IF NOT EXISTS ws_delete(
  provcode varchar(2) not null,
  cid varchar(13) not null,
  flag_sent varchar(1) DEFAULT '0',
  ws_table varchar(150) not null,
PRIMARY KEY (provcode,cid,ws_table),
KEY (provcode),
KEY (cid),
KEY (ws_table)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

DELETE FROM ws_delete WHERE flag_sent='2';

#ลบกรณีเปลี่ยนการวินิจฉัย;
DROP TEMPORARY TABLE IF EXISTS tmz_ws_cid_del;
CREATE TEMPORARY TABLE  IF NOT EXISTS tmz_ws_cid_del (PRIMARY KEY (CID)) 
ENGINE=MyISAM  AS 
(
SELECT
m.cid
FROM ws_person_dmht m LEFT JOIN t_dmht d ON m.cid=d.cid 
WHERE  d.cid is NULL
);

INSERT IGNORE INTO  ws_delete (SELECT @prov_c,cid,'0','ws_person_dmht' FROM  tmz_ws_cid_del);
DELETE FROM ws_person_dmht  WHERE cid in(SELECT cid FROM tmz_ws_cid_del ) ;

#สร้างตัวเปรียบเทียบเฉพาะที่ข้อมูลไม่ตรงกันให้แทนที่ หากเท่ากันทุก filed ไม่ต้องทำอะไร;
DROP TEMPORARY TABLE IF EXISTS tmz_ws_cid_prompt;
CREATE TEMPORARY TABLE  IF NOT EXISTS tmz_ws_cid_prompt (PRIMARY KEY (CID)) 
ENGINE=MyISAM  AS 
(
SELECT SQL_BIG_RESULT 
			@prov_c provcode
			,cid
			,type_dx 
			,rs_hba1c last_hba1c 
			,ld_hba1c date_serv_hba1c 
			,ih_hba1c  hba1c_hosp
			,rs_fpg1 last_fpg 
			,ld_fpg1 date_serv_fpg 
			,ih_fpg1  fpg_hosp
			,rs_bps1 last_sbp
			,rs_bpd1 last_dbp
			,ld_bp1 date_serv_bp
			,ih_bp1  bp_hosp
FROM 
		t_dmht
WHERE mod11(cid)=1 
				AND (SUBSTR(cid,1,6) not in(SELECT CONCAT('0',hoscode) FROM chospital WHERE provcode in(@prov_c))  
				AND SUBSTR(cid,1,5) not in(SELECT hoscode FROM chospital WHERE provcode in(@prov_c)))
);
#REPLACE ON Change OR Not found;
REPLACE  INTO ws_person_dmht (
SELECT SQL_BIG_RESULT
			p.provcode
			,p.cid
			,'0'
			,p.type_dx 
			,p.last_hba1c 
			,p.date_serv_hba1c 
			,p.hba1c_hosp
			,p.last_fpg 
			,p.date_serv_fpg 
			,p.fpg_hosp
			,p.last_sbp
			,p.last_dbp
			,p.date_serv_bp
			,p.bp_hosp
FROM
		tmz_ws_cid_prompt p LEFT JOIN ws_person_dmht d ON p.cid=d.cid
WHERE 
		d.cid IS NULL
		OR p.type_dx != d.type_dx  
		OR p.last_hba1c != d.last_hba1c 
		OR p.date_serv_hba1c != d.date_serv_hba1c 
		OR p.hba1c_hosp != d.hba1c_hosp 		
		OR p.last_fpg != d.last_fpg 
		OR p.date_serv_fpg != d.date_serv_fpg 
		OR p.fpg_hosp != d.fpg_hosp 		
		OR p.last_sbp != d.last_sbp 
		OR p.last_dbp != d.last_dbp
		OR p.date_serv_bp != d.date_serv_bp
		OR p.bp_hosp != d.bp_hosp 		

 );
 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.2552519;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:216;a:5:{i:0;s:44:"DROP PROCEDURE IF EXISTS ws_person_nutrition";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.317652;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:219;a:5:{i:0;s:4575:"CREATE PROCEDURE ws_person_nutrition()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '32';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
DROP TABLE IF EXISTS t_obes;
CREATE TABLE IF NOT EXISTS t_obes 
(
cid VARCHAR(13) NOT NULL,
sex VARCHAR(1) NOT NULL DEFAULT '0',
birth date,
age_y VARCHAR(3) NOT NULL DEFAULT '0',
hospcode VARCHAR(5) DEFAULT NULL,
date_serv date ,
weight decimal(5,1) NOT NULL DEFAULT '0',
height int(3) NOT NULL DEFAULT '0',
waist_cm int(3) NOT NULL DEFAULT '0',
bmi decimal(10,1) NOT NULL DEFAULT '0',
nutri_level int(1) NOT NULL DEFAULT '0',
bmi_id int(1) NOT NULL DEFAULT '0',
PRIMARY KEY (cid)
) ENGINE MyISAM DEFAULT CHARACTER SET=utf8 ;

/*INSERT*/
INSERT IGNORE INTO  t_obes(cid)
SELECT
n.cid
FROM
tmp_nutrition n
WHERE
mod11(n.cid) =1 AND TIMESTAMPDIFF(YEAR,DATE_SERV,now()) <6;

INSERT IGNORE INTO  t_obes(cid)
SELECT
n.cid
FROM
t_ncdscreen n
WHERE
mod11(n.cid) =1 AND TIMESTAMPDIFF(YEAR,DATE_SERV,now()) <6;

INSERT IGNORE INTO  t_obes(cid)
SELECT
n.cid
FROM
tmp_chronicfu n
WHERE
mod11(n.cid) =1 AND TIMESTAMPDIFF(YEAR,DATE_SERV,now()) <6;

/*update from nutrition*/
UPDATE  t_obes o , (
SELECT
cid,hospcode,date_serv,height,weight
FROM
tmp_nutrition 
WHERE
mod11(cid) =1 AND TIMESTAMPDIFF(YEAR,DATE_SERV,now()) <6
ORDER BY date_serv DESC 
 )  n  
SET  o.hospcode=n.hospcode ,o.date_serv=n.date_serv,o.height=n.height,o.weight=n.weight
WHERE o.cid=n.cid;


/*UPDATE FROM ncdscreen*/
UPDATE  t_obes o , (
SELECT
cid,hospcode,date_serv,height,weight,waist_cm
FROM
t_ncdscreen 
WHERE
mod11(cid) =1 AND TIMESTAMPDIFF(YEAR,DATE_SERV,now()) <6
ORDER BY date_serv DESC 
 )  n 
SET  o.hospcode=n.hospcode ,o.date_serv=n.date_serv,o.height=n.height,o.weight=n.weight,o.waist_cm=n.waist_cm
WHERE o.cid=n.cid;

/*INSERT FROM chronicfu*/
UPDATE  t_obes o , (
SELECT
cid,hospcode,date_serv,height,weight,waist_cm
FROM
tmp_chronicfu 
WHERE
mod11(cid) =1 AND TIMESTAMPDIFF(YEAR,DATE_SERV,now()) <6
ORDER BY date_serv DESC 
 )  n 
SET  o.hospcode=n.hospcode ,o.date_serv=n.date_serv,o.height=n.height,o.weight=n.weight,o.waist_cm=n.waist_cm
WHERE o.cid=n.cid;

UPDATE t_obes  o INNER JOIN person  p ON o.cid=p.cid SET o.sex=p.sex
,o.age_y=TIMESTAMPDIFF(year,p.BIRTH,o.date_serv)
,o.birth=p.BIRTH
WHERE p.BIRTH < NOW() AND p.DISCHARGE =9;

DELETE FROM t_obes WHERE sex not in(1,2);

UPDATE t_obes o ,(
SELECT
cid
,IFNULL(nutri_cal(TIMESTAMPDIFF(MONTH,birth,date_serv),SEX,3,height,weight),0) nutri_level
FROM
t_obes
WHERE age_y BETWEEN 0 AND 18
) w SET o.nutri_level=w.nutri_level
WHERE o.cid=w.cid;


UPDATE t_obes SET  BMI= IFNULL(round(weight/((height/100)*(height/100)),2),0)
WHERE age_y>18;

UPDATE t_obes SET  BMI= IFNULL(round(weight/((height/100)*(height/100)),2),0)
WHERE nutri_level=0 OR bmi=0;

DELETE FROM t_obes WHERE height=0 OR weight=0;
DELETE FROM t_obes WHERE date_serv < birth;
DELETE FROM t_obes WHERE TIMESTAMPDIFF(YEAR,birth,NOW()) > 120;
DELETE FROM t_obes WHERE bmi >200;
DELETE FROM t_obes WHERE substr(cid,2,5) in(SELECT hoscode FROM chospital WHERE provcode =@prov_c);
DELETE FROM t_obes WHERE substr(cid,1,5) in(SELECT hoscode FROM chospital WHERE provcode =@prov_c);

UPDATE t_obes o , cbmi_result r  SET o.bmi_id = r.bmi_id  WHERE o.bmi BETWEEN  r.min AND r.max ;
CREATE TABLE IF NOT EXISTS ws_person_nutrition
(
provcode VARCHAR(2) NOT NULL,
cid VARCHAR(13) NOT NULL,
flag_sent VARCHAR(1) NOT NULL DEFAULT '0',
sex VARCHAR(1) NOT NULL,
birth date,
age_y VARCHAR(3) NOT NULL,
hospcode VARCHAR(5) DEFAULT NULL,
date_serv date ,
weight decimal(5,1) NOT NULL DEFAULT '0',
height int(3) NOT NULL DEFAULT '0',
waist_cm int(3) NOT NULL DEFAULT '0',
bmi decimal(10,1) NOT NULL DEFAULT '0',
bmi_result varchar(255) NOT NULL DEFAULT '',
nutri_level int(1) NOT NULL DEFAULT '0',
nutri_result varchar(255) NOT NULL DEFAULT '',
PRIMARY KEY (provcode,cid)
) ENGINE MyISAM DEFAULT CHARACTER SET=utf8 ;

DELETE w  FROM ws_person_nutrition w INNER JOIN t_obes o ON w.cid=o.cid 
WHERE o.hospcode !=w.hospcode OR o.date_serv != w.date_serv OR o.bmi !=w.bmi OR o.nutri_level != w.nutri_level;

INSERT IGNORE INTO ws_person_nutrition 
(
SELECT
@prov_c,o.cid,'0',o.sex,o.birth,o.age_y,o.hospcode,o.date_serv,o.weight,o.height,o.waist_cm,o.bmi, b.bmi_result ,o.nutri_level,n.nutri_name
FROM
	t_obes  o 
	LEFT JOIN cbmi_result b on o.bmi_id=b.bmi_id
	LEFT JOIN cnutri_result n on o.nutri_level=n.nutri_level
);

 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.3800521;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:222;a:5:{i:0;s:46:"DROP PROCEDURE IF EXISTS ws_person_drugallergy";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.442452;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:225;a:5:{i:0;s:2708:"CREATE PROCEDURE ws_person_drugallergy()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '33';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS t_drugallergy;
CREATE TABLE IF NOT EXISTS t_drugallergy (PRIMARY KEY (cid,drugallergy), KEY (cid)) ENGINE MyISAM AS
(SELECT DISTINCT
CID
,DRUGALLERGY
,c.Generic_Name DNAME_STD
/*,IF(INSTR(c.Generic_Name,'MG') ,SUBSTR(c.Generic_Name,1,INSTR(c.Generic_Name,'MG')+1),c.Generic_Name   ) DNAMEP*/
,SPACE(100) DNAMEP
,SPACE(100) DNAME
,DATERECORD
,d.HOSPCODE
FROM
drugallergy d INNER JOIN person p ON d.HOSPCODE=p.HOSPCODE AND d.PID=p.PID
INNER JOIN cdrug_std c ON d.DRUGALLERGY=c.didstd
WHERE mod11(cid)=1  
GROUP BY p.cid,c.didstd
);


UPDATE t_drugallergy SET DNAME_STD = REPLACE(DNAME_STD,' ','#');
UPDATE t_drugallergy SET DNAMEP = IF(INSTR(DNAME_STD,'MG') ,SUBSTR(DNAME_STD,1,INSTR(DNAME_STD,'MG')+1),DNAME_STD );
UPDATE t_drugallergy SET dnamep = repl_digits_pipe(DNAMEP);
UPDATE t_drugallergy SET DNAME = if(INSTR(DNAMEP,'|'),SUBSTR(DNAMEP ,1, INSTR(DNAMEP,'|')-1),DNAMEP);
UPDATE t_drugallergy SET DNAME = if(SUBSTR(DNAME,-1)='(', SUBSTR(DNAME,1,LENGTH(DNAME)-1) ,DNAME);




UPDATE t_drugallergy SET DNAME_STD = REPLACE(DNAME_STD,'#',' ') , DNAME =REPLACE(DNAME,'#',' ');

CREATE TABLE IF NOT EXISTS ws_person_drugallergy
(
provcode VARCHAR(2) NOT NULL,
cid VARCHAR(13) NOT NULL,
flag_sent VARCHAR(1) NOT NULL DEFAULT '0',
hospcode VARCHAR(5) DEFAULT NULL,
daterecode DATE,
didcode VARCHAR(24) NOT NULL DEFAULT ' ',
didname varchar(255) NOT NULL DEFAULT ' ',
PRIMARY KEY (provcode,cid,didcode)
) ENGINE MyISAM DEFAULT CHARACTER SET=utf8 ;

CREATE TABLE IF NOT EXISTS ws_delete(
  provcode varchar(2) not null,
  cid varchar(13) not null,
  flag_sent varchar(1) DEFAULT '0',
  ws_table varchar(150) not null,
PRIMARY KEY (provcode,cid,ws_table),
KEY (provcode),
KEY (cid),
KEY (ws_table)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

DELETE FROM ws_delete WHERE flag_sent='2';

#ลบกรณีลบ;
DROP TEMPORARY TABLE IF EXISTS tmz_ws_cid_del;
CREATE TEMPORARY TABLE  IF NOT EXISTS tmz_ws_cid_del (PRIMARY KEY (CID)) 
ENGINE=MyISAM  AS 
(
SELECT DISTINCT
m.cid
FROM ws_person_drugallergy m LEFT JOIN t_drugallergy d ON m.cid=d.cid 
WHERE  d.cid is NULL
);

INSERT IGNORE INTO  ws_delete (SELECT @prov_c,cid,'0','ws_person_drugallergy' FROM  tmz_ws_cid_del);

DELETE FROM ws_person_drugallergy  WHERE cid in(SELECT cid FROM tmz_ws_cid_del ) ;

INSERT IGNORE INTO ws_person_drugallergy 
(
SELECT
@prov_c,cid,'0',hospcode,DATERECORD,DRUGALLERGY,DNAME
FROM
	t_drugallergy 
);
 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.4892521;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:228;a:5:{i:0;s:35:"DROP PROCEDURE IF EXISTS t_cmi_dead";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.551652;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:231;a:5:{i:0;s:1277:"CREATE PROCEDURE t_cmi_dead()
 BEGIN 
SET @prov_c :='58';
SET @id:= '34';
SET @year_start:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@year_start-1,'1001');
SET @end_d:=concat(@year_start,'0930');

DROP TABLE IF EXISTS t_cmi_dead;
CREATE TABLE IF NOT EXISTS t_cmi_dead (INDEX(monthly,hospcode,drg)) 
		ENGINE=MyISAM  AS 
		(select @year_start as byear,DATE_FORMAT(t.DATETIME_DISCH,'%Y%m') as monthly,t.HOSPCODE as hospcode, 
							a.chwcode, a.region, a.splevel, substr(t.drg,1,2) as mdc,
							t.DRG as drg, count(t.AN) as cases, sum(t.ADJRW) as sum_adjrw,
							sum(t.price) as price,sum(if(t.price=0,1,0)) as price0,sum(t.day) as los,
							sum(if(t.ADJRW=0,1,0)) as adjrw0, t.RW as rw,
							sum(if(t.REFERINHOSP != '' ,1,0)) as referin,
							sum(if(t.REFERINHOSP !='' and t.adjrw=0,1,0)) as referin_adjrw0,
							sum(if(t.REFERINHOSP !='',t.adjrw,0)) as referin_adjrw
						from tmp_admission t join (select t.hcode, t.hname, t.chwcode, t.chwname, t.region, t.splevel
										from ccmihosp t where t.byear = @year_start+543) a on t.HOSPCODE = a.hcode
						where DATE_FORMAT(t.DATETIME_DISCH,'%Y%m%d') BETWEEN @start_d AND @end_d
							AND t.DISCHSTATUS in (8,9)
						group by t.HOSPCODE,monthly, t.drg
) ;
 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.5984521;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:234;a:5:{i:0;s:40:"DROP PROCEDURE IF EXISTS t_procedure_ipd";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.660852;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:237;a:5:{i:0;s:4196:"CREATE PROCEDURE t_procedure_ipd()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '35';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

#รายงานเพื่อใช้ใน Service Plan สาขาการส่งต่อ ใช้ในการพัฒนา Node ให้มีศักยภาพในการรักษาโรคที่ไม่ยากจนเกินไป
DROP TABLES IF EXISTS t_procedure_ipd;
CREATE TABLE IF NOT EXISTS t_procedure_ipd (
	`prov` varchar(2) NOT null,
	`hospcode` varchar(5) NOT null,
	`hosp_level` varchar(2) NOT null,
  `cid` varchar(15) not null,
	`an` varchar(16) NOT null,
  `pid` varchar(15) NOT null,
	`seq` varchar(16) NOT null,
	`sex` TINYINT,
	`age_y` int,
	`age_m` int,
	`typearea` TINYINT,
	`datetime_admit` datetime NOT NULL,
	`datetime_disc` datetime NOT NULL,
	`actlos` INT,
	`procedcode` varchar(8) default null,
  `dischstatus` char(1),
  `dischtype` char(1),
	`typein` char(1),
	`timestart` datetime,
	`timefinish` datetime,
	`timediff` time,
	`timeused` int(6),
	`provider` varchar(16),
	`drg` varchar(5),
	`rw` float,
	`adjrw` float,
	`price` float,
	`referin` VARCHAR(5),
	`ipd_referin` VARCHAR(5),
	`ipd_referout` VARCHAR(5),
	`opd_referin` VARCHAR(5),
	`referin_level` VARCHAR(2),
	`lastupdate` TIMESTAMP,
  KEY `hospcode` (`hospcode`),
  KEY `an` (`an`),
  KEY `pid` (`pid`),
	KEY `cid` (`cid`),
  KEY `seq` (`seq`),
  KEY `referin` (`referin`),
  KEY `datetime_admit` (`datetime_admit`),
	KEY `procedcode` (`procedcode`),
	KEY `timestart` (`timestart`),
  KEY `HOSPCODE_PID` (`hospcode`,`pid`,`seq`)
)ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT INTO t_procedure_ipd 
SELECT @prov_c as prov,op.HOSPCODE, '' as hosplevel, p.CID, op.AN, ipd.PID, ipd.SEQ, p.sex, 
			age(ipd.DATETIME_ADMIT,p.BIRTH,'y') as age_y,
			age(ipd.DATETIME_ADMIT,p.BIRTH,'m') as age_m,
			p.TYPEAREA,
			ipd.DATETIME_ADMIT, ipd.DATETIME_DISCH, ipd.ACTLOS , op.procedcode, 
      ipd.DISCHSTATUS , ipd.DISCHTYPE , ipd.TYPEIN,
      op.TIMESTART, op.TIMEFINISH, TIMEDIFF(op.TIMESTART,ipd.DATETIME_ADMIT) as timediff,
			IF(TIME_TO_SEC(TIMEDIFF(op.TIMESTART,ipd.DATETIME_ADMIT))>0,TIME_TO_SEC(TIMEDIFF(op.TIMESTART,ipd.DATETIME_ADMIT))/60,0) as timeued,
			op.PROVIDER, ipd.DRG, ipd.RW, ipd.ADJRW, ipd.price,
      ipd.REFERINHOSP as ipdreferin, ipd.REFERINHOSP as ipdreferin, ipd.REFEROUTHOSP as ipdreferout,
			'' as opdreferin, '' as referin_level, CURRENT_TIMESTAMP() as lastupdate
	FROM procedure_ipd op
		LEFT JOIN admission ipd on op.HOSPCODE=ipd.HOSPCODE and op.AN=ipd.AN
		LEFT JOIN person p on op.HOSPCODE=p.HOSPCODE and op.PID=p.PID
	WHERE DATE_FORMAT(ipd.DATETIME_DISCH,'%Y%m%d') BETWEEN @start_d and @end_d
 ;

#ค้นสถานพยาบาลที่ส่ง refer มา ในกรณีที่ HIS ไม่ได้บันทึกไว้ใน admission แต่มีใน service
UPDATE t_procedure_ipd op,tmp_service opd SET op.opd_referin=opd.referinhosp
	WHERE op.hospcode = opd.hospcode AND op.seq = opd.seq and substr(op.datetime_admit,1,10)=opd.date_serv and op.pid=opd.pid;

UPDATE t_procedure_ipd op SET op.referin = op.opd_referin
	where op.referin='' and op.opd_referin!='' ;

#กรณีวัน admit=วันจำหน่าย ให้แทนค่าเป็น 1
UPDATE t_procedure_ipd op SET op.actlos = 1 
	where op.actlos=0 and op.datetime_admit=op.datetime_disc ;

#กรณีวัน admit < วันจำหน่าย ให้คำนวณหา DATEDIFF
UPDATE t_procedure_ipd op SET op.actlos = DATEDIFF(op.datetime_disc,op.datetime_admit)
	where op.actlos=0 ;

#ค้นหาประเภทสถานพยาบาล A-F
UPDATE t_procedure_ipd op,ccmihosp h SET op.hosp_level=h.splevel WHERE op.hospcode=h.hcode ;
UPDATE t_procedure_ipd op,ccmihosp h SET op.referin_level=h.splevel WHERE op.referin!='' and op.referin=h.hcode ;
UPDATE t_procedure_ipd op SET op.referin_level='NA' WHERE op.referin!='' and (op.referin_level='' or ISNULL(op.referin_level)) ;

 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.7232521;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:240;a:5:{i:0;s:38:"DROP PROCEDURE IF EXISTS t_ckd_ill_all";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.816853;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:243;a:5:{i:0;s:3874:"CREATE PROCEDURE t_ckd_ill_all()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '36';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

CREATE TABLE IF NOT EXISTS t_ckd_ill_all (
  cid varchar(13) NOT NULL,
  group_diag text,
  group_date text,
  group_hos_dx text,
  min_date_dx date DEFAULT NULL,
  hospcode varchar(5) NOT NULL DEFAULT '',
  PRIMARY KEY (cid)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO  t_ckd_ill_all (
			SELECT cid 
						,GROUP_CONCAT(trim(diagcode) ORDER BY SUBSTR(diagcode,1,1),date_dx) group_diag
						,GROUP_CONCAT(date_dx ORDER BY SUBSTR(diagcode,1,1),date_dx) group_date
							,GROUP_CONCAT(IF(LENGTH(trim(hosp_dx))=0 OR ISNULL(hosp_dx),input_hosp,hosp_dx) ORDER BY SUBSTR(diagcode,1,1),date_dx)
						,min(date_dx) min_date_dx, space(5) hospcode
  FROM t_chronic 
   WHERE UPPER(diagcode) in('E102', 'E112', 'E122', 'E132', 'E142','I151') 
					OR UPPER(substr(diagcode,1,3)) in('I12','I13','N18')  
	GROUP BY cid
	ORDER BY date_dx  );

UPDATE t_ckd_ill_all  c,t_person_cid p SET c.hospcode=p.check_hosp WHERE c.cid=p.cid;

DROP TABLE IF  EXISTS t_ckd_screen;
CREATE TABLE IF NOT EXISTS t_ckd_screen (
lab12_date date default null,
lab12_hosp VARCHAR(5) DEFAULT NULL,
lab12_result VARCHAR(10) DEFAULT NULL,

lab14_date date default null,
lab14_hosp VARCHAR(5) DEFAULT NULL,
lab14_result VARCHAR(10) DEFAULT NULL,
lab11_date date default null,
lab11_hosp VARCHAR(5) DEFAULT NULL,
lab11_result VARCHAR(10) DEFAULT NULL,
lab15_date date default null,
lab15_hosp VARCHAR(5) DEFAULT NULL,
lab15_result VARCHAR(10) DEFAULT NULL,
lab15_ok_result VARCHAR(10) DEFAULT NULL,
minlab_date date default null,
PRIMARY KEY(cid) ) ENGINE MyIsam as(
SELECT
t.hospcode,t.pid,t.cid,t.vhid,t.typearea,t.birth,t.age_y,t.sex,t.nation,t.mix_dx,t.date_dx,t.hosp_dx
,null as lab12_date 
,null as lab12_hosp
,null as  lab12_result
,null as lab14_date
,null as lab14_hosp
,null as lab14_result
,null as lab11_date
,null as lab11_hosp
,null as lab11_result
,null as lab15_date
,null as lab15_hosp
,null as lab15_result
,null as lab15_ok_result
,null as minlab_date
FROM
t_dmht  t 
	LEFT JOIN (SELECT cid FROM t_ckd_ill_all WHERE min_date_dx < @start_d ) c ON t.cid=c.cid 
WHERE
t.nation in('099') AND t.typearea in(1,3)
AND (c.cid is null ));

UPDATE t_ckd_screen s ,tmp_labfu l SET s.lab12_date=l.DATE_SERV,s.lab12_hosp=l.HOSPCODE ,s.lab12_result=l.LABRESULT
WHERE s.cid=l.cid AND l.LABTEST=12 AND l.DATE_SERV  BETWEEN @start_d AND @end_d;

UPDATE t_ckd_screen s ,tmp_labfu l SET s.lab14_date=l.DATE_SERV,s.lab14_hosp=l.HOSPCODE ,s.lab14_result=l.LABRESULT
WHERE s.cid=l.cid AND l.LABTEST=14 AND l.DATE_SERV  BETWEEN @start_d AND @end_d;

UPDATE t_ckd_screen s ,tmp_labfu l SET s.lab11_date=l.DATE_SERV,s.lab11_hosp=l.HOSPCODE ,s.lab11_result=l.LABRESULT
WHERE s.cid=l.cid AND l.LABTEST=11 AND l.DATE_SERV  BETWEEN @start_d AND @end_d;

UPDATE t_ckd_screen s ,tmp_labfu l SET s.lab15_date=l.DATE_SERV,s.lab15_hosp=l.HOSPCODE ,s.lab15_result=l.LABRESULT
WHERE s.cid=l.cid AND l.LABTEST=15 AND l.DATE_SERV  BETWEEN @start_d AND @end_d;

UPDATE t_ckd_screen SET lab15_ok_result =lab15_result;

UPDATE t_ckd_screen SET lab15_ok_result =egfr_fnc(lab11_result,age_y,sex)
WHERE lab11_result IS NOT NULL AND lab11_result>0 ;

UPDATE t_ckd_screen SET minlab_date =IF(lab12_date is NULL OR lab14_date is NULL 
			,COALESCE(lab12_date,lab14_date),LEAST(lab12_date,lab14_date));

UPDATE t_ckd_screen SET minlab_date =IF(lab15_date is NULL OR minlab_date is NULL 
			,COALESCE(lab15_date,minlab_date),LEAST(lab15_date,minlab_date));

UPDATE t_ckd_screen SET minlab_date =IF(lab11_date is NULL OR minlab_date is NULL 
			,COALESCE(lab11_date,minlab_date),LEAST(lab11_date,minlab_date));

 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.8948531;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:246;a:5:{i:0;s:32:"DROP PROCEDURE IF EXISTS t_influ";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.941653;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:249;a:5:{i:0;s:2251:"CREATE PROCEDURE t_influ()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '37';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF  EXISTS t_influ;
CREATE TABLE IF NOT EXISTS t_influ(key (cid) ) ENGINE MyISAM as
(SELECT DISTINCT
p.cid,p.sex,p.BIRTH,e.DATE_SERV,e.VACCINETYPE,e.VACCINEPLACE
,'0' type_1,'0' type_2,'0' type_3,'0' type_4,'0' type_5,'0' type_6,'0' type_7,'0' type_8,'0' type_9
FROM
epi e  INNER JOIN person p ON p.HOSPCODE=e.HOSPCODE AND p.PID=e.pid
WHERE 
e.DATE_SERV BETWEEN @start_d AND @end_d
AND VACCINETYPE in('815')
);
UPDATE t_influ i INNER JOIN provider p    SET type_1 =1 WHERE  i.cid=p.CID ;
UPDATE t_influ i INNER JOIN tmp_anc a    SET type_2 =1 WHERE  i.cid=a.cid AND  TIMESTAMPDIFF(week,DATE_ADD(a.DATE_SERV,INTERVAL -(a.GA) WEEK),i.DATE_SERV)>4;
UPDATE t_influ   SET type_3 =1 WHERE TIMESTAMPDIFF(MONTH,BIRTH,DATE_SERV)  BETWEEN 6 and 24;
UPDATE t_influ   SET type_4 =1 WHERE TIMESTAMPDIFF(YEAR,BIRTH,DATE_SERV)  > 65;
UPDATE t_influ i INNER JOIN t_chronic c   SET type_5 =1  WHERE i.cid=c.cid 
	AND (substr(c.diagcode,1,3) in('J44','J45','J46','I20','I21','I22','I23','I24','I25','I60','I61','I62','I63','I64','I65','I66','I67','N17','N18','N19','E10','E11','E12','E13','E14')
or substr(c.diagcode,1,1) in('C')) AND c.date_dx <= i.DATE_SERV;
UPDATE t_influ i INNER JOIN tmp_diag_opd d   SET type_6 =1 WHERE  i.cid=d.CID AND substr(d.diagcode,1,3) in('Q00','Q01','Q02','Q03','Q04','F84') AND d.DATE_SERV <= i.DATE_SERV;
UPDATE t_influ i INNER JOIN t_chronic c   SET type_7 =1  WHERE i.cid=c.cid AND substr(c.diagcode,1,3) in('B20','B21','B22','B23','B24') AND c.date_dx <= i.DATE_SERV;
UPDATE t_influ i INNER JOIN tmp_diag_opd d   SET type_7 =1 WHERE  i.cid=d.CID AND substr(d.diagcode,1,3) in('D56') AND d.DATE_SERV <= i.DATE_SERV;
UPDATE t_influ i INNER JOIN tmp_diag_opd d   SET type_8 =1 WHERE  i.cid=d.CID AND substr(d.diagcode,1,3) in('E66') AND d.DATE_SERV <= i.DATE_SERV;
UPDATE t_influ SET type_4=0 WHERE type_5 =1 OR type_7 =1 OR type_8 =1;
UPDATE t_influ SET type_9=1 WHERE type_1 =0 AND type_2 =0 AND type_3 =0 AND type_4 =0 AND type_5 =0 AND type_6 =0 AND type_7 =0 AND type_8 =0;

 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.0040531;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:252;a:5:{i:0;s:38:"DROP PROCEDURE IF EXISTS t_ckd_service";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.050853;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:255;a:5:{i:0;s:6112:"CREATE PROCEDURE t_ckd_service()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '38';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF  EXISTS t_ckd_service;
CREATE TABLE IF NOT EXISTS t_ckd_service (
sex varchar(1),
age varchar(3),
nation varchar(3),
sbp int(3),
dbp int(3),
egfr varchar(20),
creatinine varchar(20),
egfr_ok varchar(20),
hb varchar(20),
hba1c varchar(20),
serum_k varchar(20),
serum_hco3 varchar(20),
urine_protein int(1),
upcr varchar(20),
serum_po4 varchar(20),
serum_ipth varchar(20),
acei_arb int(1),
statin int(1),
KEY(hospcode),KEY(PID),KEY(DATE_SERV)
) ENGINE MyISAM as
(SELECT
HOSPCODE,PID,SEQ,DATE_SERV,DIAGCODE,cid
,0 as 'sex'
,'' as 'nation'
,0 as 'age'
,0 as 'sbp'
,0 as 'dbp'
,0 as 'egfr'
,0 as 'creatinine'
,0 as 'egfr_ok'
,0 as 'hb'
,0 as 'hba1c'
,0 as 'serum_k'
,0 as 'serum_hco3'
,0 as 'urine_protein'
,0 as 'upcr'
,0 as 'serum_po4'
,0 as 'serum_ipth'
,0 as 'acei_arb'
,0 as 'statin'
FROM
tmp_diag_opd o LEFT JOIN chospital h ON o.HOSPCODE=h.hoscode
WHERE 
(substr(diagcode,1,4) IN ('N181','N182','N183','N184','N189','E102','E112','E122','E132','E142','I151') OR substr(diagcode,1,3) IN ('I12','I13'))
AND h.hostype in(5,6,7) AND o.DATE_SERV BETWEEN @start_d AND  @end_d
ORDER BY HOSPCODE ASC ,PID ASC, DATE_SERV DESC);


/*up sex for egfr*/
UPDATE  t_ckd_service c INNER JOIN  t_person_db p ON c.HOSPCODE=p.hospcode 	AND c.PID=p.pid
SET c.sex=p.SEX, c.age=TIMESTAMPDIFF(year,p.BIRTH,c.DATE_SERV),c.nation=p.NATION;
/*up bp from service*/
UPDATE t_ckd_service c INNER JOIN  tmp_service s ON c.HOSPCODE=s.hospcode 
							AND c.PID=s.pid AND c.seq=s.seq AND c.DATE_SERV=s.date_serv
SET c.sbp = s.sbp , c.dbp = s.dbp
WHERE s.sbp BETWEEN 10 AND 300 AND s.dbp BETWEEN 10 AND 300; 
/*up bp from chronicfu where bp <10*/
UPDATE t_ckd_service c INNER JOIN  tmp_chronicfu f ON c.HOSPCODE=f.hospcode 
							AND c.PID=f.pid AND c.seq=f.seq AND c.DATE_SERV=f.date_serv
SET c.sbp=f.sbp , c.dbp=f.dbp
WHERE c.sbp <10 AND f.sbp BETWEEN 10 AND 300 AND f.dbp BETWEEN 10 AND 300; 
/*up egfr*/
UPDATE t_ckd_service c INNER JOIN  tmp_labfu l ON c.HOSPCODE=l.hospcode 
							AND c.PID=l.pid AND c.seq=l.seq AND c.DATE_SERV=l.date_serv
SET c.egfr = l.LABRESULT
WHERE l.LABTEST=15;
/*up egfr_ok*/
UPDATE t_ckd_service c SET c.egfr_ok = c.egfr;
/*up creatinine*/
UPDATE t_ckd_service c INNER JOIN  tmp_labfu l ON c.HOSPCODE=l.hospcode 
							AND c.PID=l.pid AND c.seq=l.seq AND c.DATE_SERV=l.date_serv
SET c.creatinine = l.LABRESULT
WHERE l.LABTEST=11;
/*up hb*/
UPDATE t_ckd_service c INNER JOIN  tmp_labfu l ON c.HOSPCODE=l.hospcode 
							AND c.PID=l.pid AND c.seq=l.seq AND c.DATE_SERV=l.date_serv
SET c.hb = l.LABRESULT
WHERE l.LABTEST=16;
/*up hba1c*/
UPDATE t_ckd_service c INNER JOIN  tmp_labfu l ON c.HOSPCODE=l.hospcode 
							AND c.PID=l.pid AND c.seq=l.seq AND c.DATE_SERV=l.date_serv
SET c.hba1c = l.LABRESULT
WHERE l.LABTEST=5;
/*up serum_k*/
UPDATE t_ckd_service c INNER JOIN  tmp_labfu l ON c.HOSPCODE=l.hospcode 
							AND c.PID=l.pid AND c.seq=l.seq AND c.DATE_SERV=l.date_serv
SET c.serum_k = l.LABRESULT
WHERE l.LABTEST=18;
/*up serum_hco3*/
UPDATE t_ckd_service c INNER JOIN  tmp_labfu l ON c.HOSPCODE=l.hospcode 
							AND c.PID=l.pid AND c.seq=l.seq AND c.DATE_SERV=l.date_serv
SET c.serum_hco3 = l.LABRESULT
WHERE l.LABTEST=19;
/*up urine_protein*/
UPDATE t_ckd_service c INNER JOIN  tmp_labfu l ON c.HOSPCODE=l.hospcode 
							AND c.PID=l.pid AND c.seq=l.seq AND c.DATE_SERV=l.date_serv
SET c.urine_protein = 1
WHERE (l.LABTEST=12 AND l.LABRESULT >=0 ) OR (l.LABTEST=14 AND l.LABRESULT >=0 )  ;
/*up upcr*/
UPDATE t_ckd_service c INNER JOIN  tmp_labfu l ON c.HOSPCODE=l.hospcode 
							AND c.PID=l.pid AND c.seq=l.seq AND c.DATE_SERV=l.date_serv
SET c.upcr = l.LABRESULT
WHERE l.LABTEST=17;
/*up serum_po4*/
UPDATE t_ckd_service c INNER JOIN  tmp_labfu l ON c.HOSPCODE=l.hospcode 
							AND c.PID=l.pid AND c.seq=l.seq AND c.DATE_SERV=l.date_serv
SET c.serum_po4 = l.LABRESULT
WHERE l.LABTEST=20;
/*up serum_ipth*/
UPDATE t_ckd_service c INNER JOIN  tmp_labfu l ON c.HOSPCODE=l.hospcode 
							AND c.PID=l.pid AND c.seq=l.seq AND c.DATE_SERV=l.date_serv
SET c.serum_ipth = l.LABRESULT
WHERE l.LABTEST=21;
/*up egfr_ok*/
UPDATE t_ckd_service c SET c.egfr_ok = egfr_fnc(c.creatinine,c.age,c.sex) WHERE c.creatinine > 0 ;
/*up acei_arb*/
UPDATE t_ckd_service c INNER JOIN  tmp_drug_opd d ON c.HOSPCODE=d.hospcode 
							AND c.PID=d.pid AND c.seq=d.seq AND c.DATE_SERV=d.date_serv
SET c.acei_arb = 1
WHERE 
(     d.DIDSTD REGEXP '^[0-9]0061[7-9]'
      OR d.DIDSTD REGEXP '^[0-9]0062[1-3]'
      OR d.DIDSTD REGEXP '^[0-9]23171'
      OR d.DIDSTD REGEXP '^[0-9]24354'
      OR d.DIDSTD REGEXP '^[0-9]24432'
      OR d.DIDSTD REGEXP '^[0-9]24831'
      OR d.DIDSTD REGEXP '^[0-9]24843'
      OR d.DIDSTD REGEXP '^[0-9]24860'
      OR d.DIDSTD REGEXP '^[0-9]24889'
      OR d.DIDSTD REGEXP '^[0-9]24976'
      OR d.DIDSTD REGEXP '^[0-9]44080'
      OR d.DIDSTD REGEXP '^[0-9]030902500[39]'
      OR d.DIDSTD REGEXP '^[0-9]03090[1-2]0001'
      OR d.DIDSTD REGEXP '^[0-9]0309025005'
      OR d.DIDSTD REGEXP '^[0-9]0309040005'
      OR d.DIDSTD REGEXP '^[0-9]0309025007'
      OR d.DIDSTD REGEXP '^[0-9]0309040001'
      OR d.DIDSTD REGEXP '^[0-9]0309025008'
      OR d.DIDSTD REGEXP '^[0-9]030902500[1246]'
      OR d.DIDSTD REGEXP '^[0-9]0309040003'
      OR d.DIDSTD REGEXP '^[0-9]0309023001'
      );
/*up statin*/
UPDATE t_ckd_service c INNER JOIN  tmp_drug_opd d ON c.HOSPCODE=d.hospcode 
							AND c.PID=d.pid AND c.seq=d.seq AND c.DATE_SERV=d.date_serv
SET c.statin = 1
WHERE 
(    d.DIDSTD REGEXP '^[0-9]05573'
     OR d.DIDSTD REGEXP '^[0-9]12482'
     OR d.DIDSTD REGEXP '^[0-9]24868'
     OR d.DIDSTD REGEXP '^[0-9]24922'
     OR d.DIDSTD REGEXP '^[0-9]43383'
     OR d.DIDSTD REGEXP '^[0-9]45714'
     OR d.DIDSTD REGEXP '^[0-9]0204011001'
     OR d.DIDSTD REGEXP '^[0-9]0204011002'
      );
 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.1132531;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:258;a:5:{i:0;s:35:"DROP PROCEDURE IF EXISTS t_ckd_egfr";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.160053;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:261;a:5:{i:0;s:6521:"CREATE PROCEDURE t_ckd_egfr()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '39';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
SET @start_d1:=concat(@b_year-2,'1001');
SET @end_d1:=concat(@b_year-1,'0930');

DROP TABLE IF  EXISTS t_lab_egfr;
CREATE TABLE IF NOT EXISTS t_lab_egfr(
sex varchar(1),
age varchar(3),
nation varchar(3),
egfr varchar(20),
creatinine varchar(20),
egfr_ok varchar(20),
KEY(hospcode),KEY(PID),KEY(DATE_SERV)
) ENGINE MyISAM as
(SELECT
HOSPCODE,PID,SEQ,DATE_SERV,cid
,0 as 'sex'
,'' as 'nation'
,0 as 'age'
,0 as 'egfr'
,0 as 'creatinine'
,0 as 'egfr_ok'
FROM
tmp_labfu
WHERE
LABTEST in(11,15) AND LENGTH(TRIM(LABRESULT)) >0
);
/*up sex for egfr*/
UPDATE  t_lab_egfr c INNER JOIN  t_person_db p ON c.HOSPCODE=p.hospcode 	AND c.PID=p.pid
SET c.sex=p.SEX, c.age=TIMESTAMPDIFF(year,p.BIRTH,c.DATE_SERV),c.nation=p.NATION;

/*up egfr*/
UPDATE t_lab_egfr c INNER JOIN  tmp_labfu l ON c.HOSPCODE=l.hospcode 
							AND c.PID=l.pid AND c.seq=l.seq AND c.DATE_SERV=l.date_serv
SET c.egfr = l.LABRESULT
WHERE l.LABTEST=15;
/*up egfr_ok*/
UPDATE t_lab_egfr c SET c.egfr_ok = c.egfr;
/*up creatinine*/
UPDATE t_lab_egfr c INNER JOIN  tmp_labfu l ON c.HOSPCODE=l.hospcode 
							AND c.PID=l.pid AND c.seq=l.seq AND c.DATE_SERV=l.date_serv
SET c.creatinine = l.LABRESULT
WHERE l.LABTEST=11;
/*up egfr_ok*/
UPDATE t_lab_egfr c SET c.egfr_ok = egfr_fnc(c.creatinine,c.age,c.sex) WHERE c.creatinine > 0 ;

DROP TABLE IF  EXISTS t_ckd_egfr;
CREATE TABLE IF NOT EXISTS t_ckd_egfr (
egfr_r1 varchar(20) default '0',
egfr_d1 date default null,
egfr_r2 varchar(20) default '0',
egfr_d2 date default null,
egfr_r3 varchar(20) default '0',
egfr_d3 date default null,
egfr_r4 varchar(20) default '0',
egfr_d4 date default null,
day1 int(2) default 0,
day2 int(2) default 0,
day3 int(2) default 0,
sumseq int(2) default 0,
egfr_avg VARCHAR(20) DEFAULT null,
KEY(hospcode),
KEY(pid)
) ENGINE MyISAM as
(SELECT
HOSPCODE,PID,cid,sex,nation,
'0' as 'egfr_r1',
null as egfr_d1,
'0' as 'egfr_r2',
null as egfr_d2,
'0' as 'egfr_r3',
null as egfr_d3,
'0' as 'egfr_r4',
null as egfr_d4,
0 as 'day1',
0 as 'day2',
0 as 'day3',
0 as 'sumseq',
null as 'egfr_avg'
FROM
t_ckd_service
WHERE 
(
      DIAGCODE IN ('N181','N182','N183','N184')
		 OR  (DIAGCODE IN ('N189') AND ( egfr_ok=0 OR  egfr_ok>=15))
     OR (( DIAGCODE IN ('E102','E112','E122','E132','E142')
       OR LEFT( DIAGCODE,3) IN ('I12','I13')
       OR  DIAGCODE='I151')
      AND  egfr_ok>=15)
  ) 
AND DATE_SERV BETWEEN @start_d AND  @end_d
GROUP BY HOSPCODE ,PID
);
/*sumseq*/
UPDATE t_ckd_egfr e  
INNER JOIN (
		SELECT HOSPCODE,PID,COUNT(DISTINCT HOSPCODE ,PID,DATE_SERV) as sumseq
		FROM	t_lab_egfr 
	 WHERE egfr_ok>0		
	  GROUP BY HOSPCODE,PID
) c
SET e.sumseq=c.sumseq
WHERE  e.hospcode=c.HOSPCODE AND e.pid=c.PID;
/*egfr_1*/
UPDATE t_ckd_egfr e  
	INNER JOIN (
		SELECT HOSPCODE,PID,DATE_SERV,egfr_ok 
		FROM t_lab_egfr s 
		WHERE egfr_ok>0 
			AND DATE_SERV =(SELECT DATE_SERV FROM t_lab_egfr s1 WHERE s1.egfr_ok>0 AND s1.HOSPCODE=s.HOSPCODE AND s1.PID=s.PID
																		GROUP BY s1.cid,s1.DATE_SERV ORDER BY s1.date_serv DESC LIMIT 0,1)
		GROUP BY HOSPCODE,PID
		) c
SET e.egfr_r1=c.egfr_ok , e.egfr_d1=c.DATE_SERV
WHERE  e.hospcode=c.HOSPCODE AND e.pid=c.PID;
/*egfr_2*/
UPDATE t_ckd_egfr e  
	INNER JOIN (
		SELECT HOSPCODE,PID,DATE_SERV,egfr_ok 
		FROM t_lab_egfr s 
		WHERE egfr_ok>0 
			AND DATE_SERV =(SELECT DATE_SERV FROM t_lab_egfr s1 WHERE s1.egfr_ok>0 AND s1.HOSPCODE=s.HOSPCODE AND s1.PID=s.PID
																		GROUP BY s1.cid,s1.DATE_SERV ORDER BY s1.date_serv DESC LIMIT 1,1)
		GROUP BY HOSPCODE,PID
		) c
SET e.egfr_r2=c.egfr_ok , e.egfr_d2=c.DATE_SERV
WHERE  e.hospcode=c.HOSPCODE AND e.pid=c.PID;
/*egfr_3*/
UPDATE t_ckd_egfr e  
	INNER JOIN (
		SELECT HOSPCODE,PID,DATE_SERV,egfr_ok 
		FROM t_lab_egfr s 
		WHERE egfr_ok>0 
			AND DATE_SERV =(SELECT DATE_SERV FROM t_lab_egfr s1 WHERE s1.egfr_ok>0 AND s1.HOSPCODE=s.HOSPCODE AND s1.PID=s.PID
																		GROUP BY s1.cid,s1.DATE_SERV ORDER BY s1.date_serv DESC LIMIT 2,1)
		GROUP BY HOSPCODE,PID
		) c
SET e.egfr_r3=c.egfr_ok , e.egfr_d3=c.DATE_SERV
WHERE  e.hospcode=c.HOSPCODE AND e.pid=c.PID;
/*egfr_4*/
UPDATE t_ckd_egfr e  
	INNER JOIN (
		SELECT HOSPCODE,PID,DATE_SERV,egfr_ok 
		FROM t_lab_egfr s 
		WHERE egfr_ok>0 
			AND DATE_SERV =(SELECT DATE_SERV FROM t_lab_egfr s1 WHERE s1.egfr_ok>0 AND s1.HOSPCODE=s.HOSPCODE AND s1.PID=s.PID
																		GROUP BY s1.cid,s1.DATE_SERV ORDER BY s1.date_serv DESC LIMIT 3,1)
		GROUP BY HOSPCODE,PID
		) c
SET e.egfr_r4=c.egfr_ok , e.egfr_d4=c.DATE_SERV
WHERE  e.hospcode=c.HOSPCODE AND e.pid=c.PID;
/*day*/
UPDATE  t_ckd_egfr e   SET e.day1=TIMESTAMPDIFF(day,e.egfr_d2,e.egfr_d1)
,e.day2=TIMESTAMPDIFF(day,e.egfr_d3,e.egfr_d2)
,e.day3=TIMESTAMPDIFF(day,e.egfr_d4,e.egfr_d3);
/*egfr_avg*/
UPDATE  t_ckd_egfr e   SET e.egfr_avg= ROUND((((egfr_r2-egfr_r1) /day1))*365,2)
WHERE e.sumseq = 2;

UPDATE  t_ckd_egfr e   SET e.egfr_avg= ROUND(( ( ((egfr_r3-egfr_r2) /day2) + ((egfr_r2-egfr_r1) /day1) )/2 )*365,2)
WHERE e.sumseq = 3;

UPDATE  t_ckd_egfr e   SET e.egfr_avg= ROUND((( ((egfr_r4-egfr_r3) /day3)  + ((egfr_r3-egfr_r2) /day2) + ((egfr_r2-egfr_r1) /day1) )/3)*365,2)
WHERE e.sumseq > 3;

DROP TABLE IF  EXISTS t_ckd_stage;
CREATE TABLE IF NOT EXISTS t_ckd_stage(
egfr_r2 varchar(20) default '0',
egfr_d2 date default null,
stage_now int DEFAULT 0,
stage_lastyear int DEFAULT 0,
PRIMARY KEY(hospcode,pid)
,KEY(hospcode,pid)
,KEY(cid) 
) ENGINE MyISAM as
(
SELECT 
hospcode,pid,cid,sex,nation,egfr_r1,egfr_d1,null as egfr_r2 ,null as egfr_d2,0 as stage_now,0 as stage_lastyear
FROM
t_ckd_egfr
WHERE  egfr_r1 >0
);

UPDATE t_ckd_stage t INNER JOIN (
SELECT * FROM
(SELECT * FROM t_lab_egfr WHERE date_serv BETWEEN @start_d1 AND @end_d1 ORDER BY date_serv DESC) d1
GROUP BY hospcode,pid
) l ON t.hospcode=l.hospcode AND t.pid=l.pid
SET t.egfr_r2=l.egfr_ok,t.egfr_d2=l.date_serv;

UPDATE t_ckd_stage SET stage_now=IF(egfr_r1 >=90,1,
IF(egfr_r1 BETWEEN 60 AND 89.99,2
,IF(egfr_r1 BETWEEN 30 AND 59.99,3
,IF(egfr_r1 BETWEEN 15 AND 29.99,4
,IF(egfr_r1 <15,5,0
)))))
,
stage_lastyear=IF(egfr_r2 >=90,1,
IF(egfr_r2 BETWEEN 60 AND 89.99,2
,IF(egfr_r2 BETWEEN 30 AND 59.99,3
,IF(egfr_r2 BETWEEN 15 AND 29.99,4
,IF(egfr_r2 <15,5,0
)))))
;
 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.2380531;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:264;a:5:{i:0;s:37:"DROP PROCEDURE IF EXISTS t_death_hosp";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.3004529;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:267;a:5:{i:0;s:1895:"CREATE PROCEDURE t_death_hosp()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '40';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
DROP TABLE IF EXISTS t_death_hosp;
CREATE TABLE IF NOT EXISTS t_death_hosp( 
pt_type VARCHAR(1) DEFAULT NULL,
pdx_opd VARCHAR(7) DEFAULT NULL,
pdx_ipd VARCHAR(7) DEFAULT NULL,
code298 VARCHAR(7) DEFAULT NULL,
PRIMARY KEY(hospcode,pid),
KEY(hospcode),
KEY(pid),
KEY(cid),
KEY(date)
 ) ENGINE=MyISAM  AS(

		SELECT DISTINCT
			s.hospcode,s.pid,s.CID,date_serv as date, '1' as pt_type,NULL as pdx_opd,NULL as pdx_ipd,null as code298
			FROM
			tmp_service s 
			WHERE s.typeout in(4,5,6) AND date_serv BETWEEN @start_d AND @end_d
			GROUP BY s.hospcode,s.pid
);

INSERT IGNORE INTO t_death_hosp (hospcode,pid,CID,DATE,pt_type)
(	SELECT
			a.hospcode,a.pid,a.CID,DATE_FORMAT(DATETIME_DISCH,'%Y%m%d'), '2' as pt_type
			FROM
			tmp_admission a
			WHERE (a.DISCHSTATUS in(8,9)  OR a.DISCHTYPE in(8,9)) 
					AND DATE_FORMAT(DATETIME_DISCH,'%Y%m%d') BETWEEN @start_d AND @end_d 
);

UPDATE t_death_hosp t INNER JOIN (
		SELECT HOSPCODE,PID,DATE_SERV,DIAGCODE
		FROM tmp_diag_opd WHERE DIAGTYPE in(1) 
		GROUP BY HOSPCODE,PID,DATE_SERV
)  d SET pdx_opd=d.DIAGCODE WHERE t.hospcode=d.HOSPCODE and t.pid=d.PID AND t.date=d.DATE_SERV;

UPDATE t_death_hosp t INNER JOIN (
		SELECT HOSPCODE,PID,DATE_FORMAT(datetime_disch,'%Y%m%d') date,DIAGCODE
		FROM tmp_diag_ipd WHERE DIAGTYPE in(1) 
		GROUP BY HOSPCODE,PID,date
)  d SET pdx_ipd=d.DIAGCODE WHERE t.hospcode=d.HOSPCODE and t.pid=d.PID AND t.date=d.date;

UPDATE t_death_hosp t INNER JOIN cicd298group i ON t.pdx_ipd=i.icd10 
SET t.code298=i.groupcode298;

UPDATE t_death_hosp t INNER JOIN cicd298group i ON t.pdx_opd=i.icd10 
SET t.code298=i.groupcode298 
WHERE t.code298 is NULL;

 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.347254;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:270;a:5:{i:0;s:38:"DROP PROCEDURE IF EXISTS t_labor_abort";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.3940539;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:273;a:5:{i:0;s:2784:"CREATE PROCEDURE t_labor_abort()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '41';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS t_labor_abort;
CREATE TABLE IF NOT EXISTS t_labor_abort(
lmp date DEFAULT NULL,
edc date DEFAULT NULL,
nation VARCHAR(3) DEFAULT NULL,
bdate date DEFAULT NULL,
teen VARCHAR(1) DEFAULT NULL,
abort VARCHAR(1) DEFAULT NULL,
date_disch date DEFAULT NULL,
fp_date date DEFAULT NULL,
fp VARCHAR(1) DEFAULT NULL,
fptype VARCHAR(1) DEFAULT NULL,
PRIMARY KEY(hospcode,pid),
KEY(hospcode),
KEY(pid),
KEY(cid),
KEY(bdate),
KEY(bhosp),
KEY(bresult),
KEY(lborn),
KEY(age_y)
) ENGINE MyIsam  as
SELECT 
l.*,null as nation ,null as teen,null as abort,null date_disch,null fp_date,null as fp,null as fptype
FROM
tmp_labor l
WHERE l.BDATE BETWEEN @start_d AND @end_d 
GROUP BY hospcode,pid;

UPDATE t_labor_abort l 
INNER JOIN (
SELECT * FROM tmp_diag_ipd 
WHERE ((SUBSTR(diagcode,1,3)  BETWEEN 'O03' AND 'O07')  
		OR (SUBSTR(diagcode,1,3) BETWEEN 'O62' AND 'O84') 
		OR diagcode in('O601','O602','O603'))
GROUP BY HOSPCODE,PID
) d ON l.hospcode=d.hospcode AND l.pid=d.pid 
SET l.BRESULT=d.diagcode
WHERE ((SUBSTR(diagcode,1,3) not BETWEEN 'O03' AND 'O07')  OR
(SUBSTR(diagcode,1,3) not BETWEEN 'O62' AND 'O84') OR diagcode not in('O601','O602','O603'));

INSERT IGNORE INTO t_labor_abort(
	HOSPCODE,PID,BRESULT, BHOSP,D_UPDATE,cid,birth,age_y ,date_disch,nation
)  
(
SELECT
	d.HOSPCODE,d.PID,DIAGCODE  as BRESULT,d.HOSPCODE as BHOSP,d.D_UPDATE, d.cid , p.birth 
	, TIMESTAMPDIFF(year,BIRTH,datetime_disch)  ,DATE_FORMAT(datetime_disch,'%Y%m%d'),p.NATION
FROM
tmp_diag_ipd d INNER JOIN t_person_db p ON d.HOSPCODE=p.HOSPCODE AND d.PID=p.PID
WHERE ((SUBSTR(diagcode,1,3)  BETWEEN 'O03' AND 'O07')  
		OR (SUBSTR(diagcode,1,3) BETWEEN 'O62' AND 'O84') 
		OR diagcode in('O601','O602','O603'))
GROUP BY HOSPCODE,PID
);

UPDATE t_labor_abort SET LBORN=1 
WHERE LBORN=0 AND SBORN=0 AND SUBSTR(BRESULT,1,3) BETWEEN 'O80' AND 'O84';


UPDATE t_labor_abort l INNER JOIN t_person_db p ON p.HOSPCODE=l.HOSPCODE AND p.PID=l.PID 
SET l.nation=p.NATION;

UPDATE t_labor_abort SET teen=1 WHERE age_y < 19;

UPDATE t_labor_abort SET abort=1  WHERE lborn =0 
AND (bresult in('O021','O364') OR  SUBSTR(bresult,1,3) in('O03','O06','O08')) ;

DELETE FROM t_labor_abort WHERE age_y <10 OR age_y is NULL;

UPDATE t_labor_abort l INNER JOIN tmp_fp f ON f.HOSPCODE=l.HOSPCODE AND f.PID=l.PID   
SET fp_date= f.DATE_SERV, l.fptype=f.fptype;

UPDATE t_labor_abort SET fp=1
WHERE   fp_date BETWEEN BDATE and  date_disch ;

UPDATE t_labor_abort SET fp=1
WHERE   TIMESTAMPDIFF(day,BDATE,fp_date) < 15;
 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.4408541;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:276;a:5:{i:0;s:38:"DROP PROCEDURE IF EXISTS t_nutrition05";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.5032539;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:279;a:5:{i:0;s:5814:"CREATE PROCEDURE t_nutrition05()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '42';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
SET @start_t1=concat(@b_year-1,'1001');
SET @start_t2=concat(@b_year,'0101');
SET @start_t3=concat(@b_year,'0401');
SET @start_t4=concat(@b_year,'0701');
SET @end_t1=concat(@b_year-1,'1231');
SET @end_t2=concat(@b_year,'0331');
SET @end_t3=concat(@b_year,'0630');
SET @end_t4=concat(@b_year,'0930');

DROP TABLE IF EXISTS t_nutrition05;
CREATE TABLE IF NOT EXISTS t_nutrition05( 
		CID VARCHAR(13) NOT NULL,
		SEX VARCHAR(1) NOT NULL,
		BIRTH DATE  DEFAULT NULL,
		AGE_T1 VARCHAR(5)  DEFAULT NULL,
		AGE_T2 VARCHAR(5)  DEFAULT NULL,
		AGE_T3 VARCHAR(5)  DEFAULT NULL,
		AGE_T4 VARCHAR(5)  DEFAULT NULL,
		DATE_SERV1 DATE DEFAULT NULL,
		DATE_SERV2 DATE DEFAULT NULL,
		DATE_SERV3 DATE DEFAULT NULL,
		DATE_SERV4 DATE DEFAULT NULL,
		AGE_MS1 VARCHAR(5)  DEFAULT NULL,
		AGE_MS2 VARCHAR(5)  DEFAULT NULL,
		AGE_MS3 VARCHAR(5)  DEFAULT NULL,
		AGE_MS4 VARCHAR(5)  DEFAULT NULL,
		WEIGHT1 DECIMAL(5,1)  DEFAULT 0,
		WEIGHT2 DECIMAL(5,1)  DEFAULT 0,
		WEIGHT3 DECIMAL(5,1)  DEFAULT 0,
		WEIGHT4 DECIMAL(5,1)  DEFAULT 0,
		HEIGHT1 INT(3)  DEFAULT 0,
		HEIGHT2 INT(3)  DEFAULT 0,
		HEIGHT3 INT(3)  DEFAULT 0,
		HEIGHT4 INT(3)  DEFAULT 0,
		W_S1 VARCHAR(1)  DEFAULT NULL,
		W_S2 VARCHAR(1)  DEFAULT NULL,
		W_S3 VARCHAR(1)  DEFAULT NULL,
		W_S4 VARCHAR(1)  DEFAULT NULL,
		H_S1 VARCHAR(1)  DEFAULT NULL,
		H_S2 VARCHAR(1)  DEFAULT NULL,
		H_S3 VARCHAR(1)  DEFAULT NULL,
		H_S4 VARCHAR(1)  DEFAULT NULL,
		WH1 VARCHAR(1)  DEFAULT NULL,
		WH2 VARCHAR(1)  DEFAULT NULL,
		WH3 VARCHAR(1)  DEFAULT NULL,
		WH4 VARCHAR(1)  DEFAULT NULL,
		hospcode VARCHAR(5)  DEFAULT NULL,
		typearea VARCHAR(1)  DEFAULT NULL,
		PRIMARY KEY (CID)
) ENGINE MyISAM DEFAULT CHARACTER SET=utf8;
/*เพิ่มข้อมูลคน*/
INSERT IGNORE INTO t_nutrition05 (cid,birth,sex,AGE_T1,AGE_T2,AGE_T3,AGE_T4,hospcode,typearea)
SELECT
		p.cid,p.BIRTH,p.SEX
		,TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@end_t1,'%Y%m%d')) AGE_T1
		,TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@end_t2,'%Y%m%d')) AGE_T2
		,TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@end_t3,'%Y%m%d')) AGE_T3
		,TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@end_t4,'%Y%m%d')) AGE_T4
		,check_hosp,check_typearea
FROM  t_person_cid p 
WHERE   TIMESTAMPDIFF(day,p.BIRTH,NOW())>1  AND 
		(
			TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@end_t1,'%Y%m%d'))  <6 OR
			TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@end_t2,'%Y%m%d'))  <6 OR
			TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@end_t3,'%Y%m%d'))  <6 OR
			TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@end_t4,'%Y%m%d'))  <6 
		)
GROUP BY p.cid;

/*เพิ่มบริการตามไตรมาส*/
UPDATE t_nutrition05 p INNER JOIN 
(SELECT * FROM 
			(SELECT cid,DATE_SERV,WEIGHT,HEIGHT FROM tmp_nutrition 
				WHERE DATE_SERV BETWEEN @start_t1 AND @end_t1 
				ORDER BY DATE_SERV DESC ) as t1 GROUP BY cid) as n
ON p.cid=n.cid  SET p.DATE_SERV1=n.DATE_SERV ,p.HEIGHT1=n.height ,p.WEIGHT1=n.weight;

UPDATE t_nutrition05 p INNER JOIN 
(SELECT * FROM 
			(SELECT cid,DATE_SERV,WEIGHT,HEIGHT FROM tmp_nutrition 
				WHERE DATE_SERV BETWEEN @start_t2 AND @end_t2
				ORDER BY DATE_SERV DESC ) as t1 GROUP BY cid) as n
ON p.cid=n.cid  SET p.DATE_SERV2=n.DATE_SERV ,p.HEIGHT2=n.height ,p.WEIGHT2=n.weight;

UPDATE t_nutrition05 p INNER JOIN 
(SELECT * FROM 
			(SELECT cid,DATE_SERV,WEIGHT,HEIGHT FROM tmp_nutrition 
				WHERE DATE_SERV BETWEEN @start_t3 AND @end_t3
				ORDER BY DATE_SERV DESC ) as t1 GROUP BY cid) as n
ON p.cid=n.cid  SET p.DATE_SERV3=n.DATE_SERV ,p.HEIGHT3=n.height ,p.WEIGHT3=n.weight;

UPDATE t_nutrition05 p INNER JOIN 
(SELECT * FROM 
			(SELECT cid,DATE_SERV,WEIGHT,HEIGHT FROM tmp_nutrition 
				WHERE DATE_SERV BETWEEN @start_t4 AND @end_t4
				ORDER BY DATE_SERV DESC ) as t1 GROUP BY cid) as n
ON p.cid=n.cid  SET p.DATE_SERV4=n.DATE_SERV ,p.HEIGHT4=n.height ,p.WEIGHT4=n.weight;
/*คำนวนอายุเป็นเดือนณวันรับบริการ*/
UPDATE t_nutrition05  SET AGE_MS1 = TIMESTAMPDIFF(MONTH,BIRTH,DATE_SERV1)
		,AGE_MS2 = TIMESTAMPDIFF(MONTH,BIRTH,DATE_SERV2)
		,AGE_MS3 = TIMESTAMPDIFF(MONTH,BIRTH,DATE_SERV3)
		,AGE_MS4 = TIMESTAMPDIFF(MONTH,BIRTH,DATE_SERV4);
/*คำนวน Nutrition_CAL*/
UPDATE t_nutrition05 SET W_S1=nutri_cal(AGE_MS1,SEX,'1',HEIGHT1,WEIGHT1) WHERE AGE_MS1 >0 AND WEIGHT1 >0;
UPDATE t_nutrition05 SET W_S2=nutri_cal(AGE_MS2,SEX,'1',HEIGHT2,WEIGHT2) WHERE AGE_MS2 >0 AND WEIGHT2 >0;
UPDATE t_nutrition05 SET W_S3=nutri_cal(AGE_MS3,SEX,'1',HEIGHT3,WEIGHT3) WHERE AGE_MS3 >0 AND WEIGHT3 >0;
UPDATE t_nutrition05 SET W_S4=nutri_cal(AGE_MS4,SEX,'1',HEIGHT4,WEIGHT4) WHERE AGE_MS4 >0 AND WEIGHT4 >0;

UPDATE t_nutrition05 SET H_S1=nutri_cal(AGE_MS1,SEX,'2',HEIGHT1,WEIGHT1) WHERE AGE_MS1 >0  AND HEIGHT1 >0;
UPDATE t_nutrition05 SET H_S2=nutri_cal(AGE_MS2,SEX,'2',HEIGHT2,WEIGHT2) WHERE AGE_MS2 >0  AND HEIGHT2 >0;
UPDATE t_nutrition05 SET H_S3=nutri_cal(AGE_MS3,SEX,'2',HEIGHT3,WEIGHT3) WHERE AGE_MS3 >0  AND HEIGHT3 >0;
UPDATE t_nutrition05 SET H_S4=nutri_cal(AGE_MS4,SEX,'2',HEIGHT4,WEIGHT4) WHERE AGE_MS4 >0  AND HEIGHT4 >0;

UPDATE t_nutrition05 SET WH1=nutri_cal(AGE_MS1,SEX,'3',HEIGHT1,WEIGHT1) WHERE AGE_MS1 >0 AND WEIGHT1 >0 AND HEIGHT1 >0 ; 
UPDATE t_nutrition05 SET WH2=nutri_cal(AGE_MS2,SEX,'3',HEIGHT2,WEIGHT2) WHERE AGE_MS2 >0 AND WEIGHT2 >0 AND HEIGHT2 >0 ; 
UPDATE t_nutrition05 SET WH3=nutri_cal(AGE_MS3,SEX,'3',HEIGHT3,WEIGHT3) WHERE AGE_MS3 >0 AND WEIGHT3 >0 AND HEIGHT3 >0 ; 
UPDATE t_nutrition05 SET WH4=nutri_cal(AGE_MS4,SEX,'3',HEIGHT4,WEIGHT4) WHERE AGE_MS4 >0 AND WEIGHT4 >0 AND HEIGHT4 >0 ; 

 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.5500541;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:282;a:5:{i:0;s:37:"DROP PROCEDURE IF EXISTS t_nutrition6";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.6124539;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:285;a:5:{i:0;s:3318:"CREATE PROCEDURE t_nutrition6()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '43';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
SET @start_te1=concat(@b_year-1,'1001');
SET @start_te2=concat(@b_year,'0501');
SET @end_te1=concat(@b_year-1,'1231');
SET @end_te2=concat(@b_year,'0731');

DROP TABLE IF EXISTS t_nutrition6up;
CREATE TABLE IF NOT EXISTS t_nutrition6up( 
		CID VARCHAR(13) NOT NULL,
		SEX VARCHAR(1) NOT NULL,
		BIRTH DATE  DEFAULT NULL,
		AGE_T1 VARCHAR(5)  DEFAULT NULL,
		AGE_T2 VARCHAR(5)  DEFAULT NULL,
		DATE_SERV1 DATE DEFAULT NULL,
		DATE_SERV2 DATE DEFAULT NULL,
		AGE_MS1 VARCHAR(5)  DEFAULT NULL,
		AGE_MS2 VARCHAR(5)  DEFAULT NULL,
		WEIGHT1 DECIMAL(5,1)  DEFAULT 0,
		WEIGHT2 DECIMAL(5,1)  DEFAULT 0,
		HEIGHT1 INT(3)  DEFAULT 0,
		HEIGHT2 INT(3)  DEFAULT 0,
		W_S1 VARCHAR(1)  DEFAULT NULL,
		W_S2 VARCHAR(1)  DEFAULT NULL,
		H_S1 VARCHAR(1)  DEFAULT NULL,
		H_S2 VARCHAR(1)  DEFAULT NULL,
		WH1 VARCHAR(1)  DEFAULT NULL,
		WH2 VARCHAR(1)  DEFAULT NULL,
		hospcode VARCHAR(5)  DEFAULT NULL,
		typearea VARCHAR(1)  DEFAULT NULL,
		PRIMARY KEY (CID)
) ENGINE MyISAM DEFAULT CHARACTER SET=utf8;
/*เพิ่มข้อมูลคน*/
INSERT IGNORE INTO t_nutrition6up (cid,birth,sex,AGE_T1,AGE_T2,hospcode,typearea)
SELECT
		p.cid,p.BIRTH,p.SEX
		,TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@end_te1,'%Y%m%d')) AGE_T1
		,TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@end_te2,'%Y%m%d')) AGE_T2
		,check_hosp,check_typearea
FROM  t_person_cid p 
WHERE  
		(
			TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@end_te1,'%Y%m%d'))  BETWEEN 6 AND 18 OR
			TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@end_te2,'%Y%m%d'))  BETWEEN 6 AND 18 
		)
 GROUP BY p.cid;

/*เพิ่มบริการตามไตรมาส*/
UPDATE t_nutrition6up p INNER JOIN 
(SELECT * FROM 
			(SELECT cid,DATE_SERV,WEIGHT,HEIGHT FROM tmp_nutrition 
				WHERE DATE_SERV BETWEEN @start_te1 AND @end_te1 
				ORDER BY DATE_SERV DESC ) as t1 GROUP BY cid) as n
ON p.cid=n.cid  SET p.DATE_SERV1=n.DATE_SERV ,p.HEIGHT1=n.height ,p.WEIGHT1=n.weight ;


UPDATE t_nutrition6up p INNER JOIN 
(SELECT * FROM 
			(SELECT cid,DATE_SERV,WEIGHT,HEIGHT FROM tmp_nutrition 
				WHERE DATE_SERV BETWEEN @start_te2 AND @end_te2
				ORDER BY DATE_SERV DESC ) as t1 GROUP BY cid) as n
ON p.cid=n.cid  SET p.DATE_SERV2=n.DATE_SERV ,p.HEIGHT2=n.height ,p.WEIGHT2=n.weight;

/*คำนวนอายุเป็นเดือนณวันรับบริการ*/
UPDATE t_nutrition6up  SET AGE_MS1 = TIMESTAMPDIFF(MONTH,BIRTH,DATE_SERV1)
		,AGE_MS2 = TIMESTAMPDIFF(MONTH,BIRTH,DATE_SERV2);
/*คำนวน Nutrition_CAL*/
UPDATE t_nutrition6up SET W_S1=nutri_cal(AGE_MS1,SEX,'1',HEIGHT1,WEIGHT1) WHERE AGE_MS1 >1;
UPDATE t_nutrition6up SET W_S2=nutri_cal(AGE_MS2,SEX,'1',HEIGHT2,WEIGHT2) WHERE AGE_MS2 >1;

UPDATE t_nutrition6up SET H_S1=nutri_cal(AGE_MS1,SEX,'2',HEIGHT1,WEIGHT1) WHERE AGE_MS1 >1;
UPDATE t_nutrition6up SET H_S2=nutri_cal(AGE_MS2,SEX,'2',HEIGHT2,WEIGHT2) WHERE AGE_MS2 >1;

UPDATE t_nutrition6up SET WH1=nutri_cal(AGE_MS1,SEX,'3',HEIGHT1,WEIGHT1) WHERE AGE_MS1 >1;
UPDATE t_nutrition6up SET WH2=nutri_cal(AGE_MS2,SEX,'3',HEIGHT2,WEIGHT2) WHERE AGE_MS2 >1;

 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.6592541;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:288;a:5:{i:0;s:38:"DROP PROCEDURE IF EXISTS t_nutrition15";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.7216539;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:291;a:5:{i:0;s:2321:"CREATE PROCEDURE t_nutrition15()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '44';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS t_nutrition15up;
CREATE TABLE IF NOT EXISTS t_nutrition15up( 
		CID VARCHAR(13) NOT NULL,
		SEX VARCHAR(1) NOT NULL,
		BIRTH DATE  DEFAULT NULL,
		AGE_Y VARCHAR(5)  DEFAULT NULL,
		AGE_YS VARCHAR(5)  DEFAULT NULL,
		DATE_SERV DATE DEFAULT NULL,		
		WEIGHT DECIMAL(5,1)  DEFAULT 0,
		HEIGHT INT(3)  DEFAULT 0,
		L_BMI DECIMAL(10,1)  DEFAULT 0,
		L_WAIST INT(3)  DEFAULT 0,
		hospcode VARCHAR(5)  DEFAULT NULL,
		typearea VARCHAR(1)  DEFAULT NULL,
		PRIMARY KEY (CID)
) ENGINE MyISAM DEFAULT CHARACTER SET=utf8;
/*เพิ่มข้อมูลคน*/
INSERT IGNORE INTO t_nutrition15up (cid,birth,sex,age_y,hospcode,typearea)
SELECT
		p.cid,p.BIRTH,p.SEX,age_y	,check_hosp,check_typearea
FROM  t_person_cid p 
WHERE  TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@start_d,'%Y%m%d'))  >=15 
 GROUP BY p.cid;

UPDATE t_nutrition15up p INNER JOIN 
(SELECT * FROM 
			(SELECT cid,DATE_SERV,WEIGHT,HEIGHT FROM tmp_nutrition 
				WHERE DATE_SERV BETWEEN @start_d AND @end_d
				ORDER BY DATE_SERV DESC ) as t1 GROUP BY cid) as n
ON p.cid=n.cid  SET p.DATE_SERV=n.DATE_SERV , p.HEIGHT=n.height , p.WEIGHT=n.weight;

UPDATE t_nutrition15up p INNER JOIN 
(SELECT * FROM 
			(SELECT cid,DATE_SERV,WEIGHT,HEIGHT,WAIST_CM FROM tmp_ncdscreen 
				WHERE DATE_SERV BETWEEN @start_d AND @end_d
				ORDER BY DATE_SERV DESC ) as t1 GROUP BY cid) as n
ON p.cid=n.cid  SET p.DATE_SERV=n.DATE_SERV ,p.HEIGHT=n.height ,p.WEIGHT=n.weight,p.L_WAIST=n.WAIST_CM
WHERE p.WEIGHT in(0) OR p.HEIGHT in(0) OR p.date_serv < n.date_serv;


UPDATE t_nutrition15up p INNER JOIN 
(SELECT * FROM 
			(SELECT cid,DATE_SERV,WEIGHT,HEIGHT,WAIST_CM FROM tmp_ncdscreen 
				WHERE DATE_SERV BETWEEN @start_d AND @end_d
				ORDER BY DATE_SERV DESC ) as t1 GROUP BY cid) as n
ON p.cid=n.cid  SET p.DATE_SERV=n.DATE_SERV ,p.HEIGHT=n.height ,p.WEIGHT=n.weight,p.L_WAIST=n.WAIST_CM
WHERE p.L_WAIST in(0) AND n.WAIST_CM >0;

UPDATE t_nutrition15up SET AGE_YS=TIMESTAMPDIFF(YEAR,birth,date_serv);

UPDATE t_nutrition15up SET L_BMI=round(WEIGHT/((HEIGHT/100)*(HEIGHT/100)),2) ;
 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.784054;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:294;a:5:{i:0;s:29:"DROP PROCEDURE IF EXISTS t_tb";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.8308539;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:297;a:5:{i:0;s:5636:"CREATE PROCEDURE t_tb()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '45';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d1:=concat(@b_year-1,'0701');
SET @end_d1:=concat(@b_year-1,'0930');
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF  EXISTS tmp_tb;
CREATE TABLE IF NOT EXISTS tmp_tb (
  HOSPCODE varchar(5) NOT NULL,
  PID varchar(15) NOT NULL,
  CID varchar(13) DEFAULT NULL,
  BIRTH date,
  SEX varchar(1),
  NATION varchar(3),
	date_dx date,
  DIAGCODE varchar(6),
  DIAGTYPE char(1) NOT NULL,
	PERIOD VARCHAR(1),
	source_tb VARCHAR(20) DEFAULT NULL,
	group_tb VARCHAR(1) DEFAULT NULL,
PRIMARY KEY (hospcode,pid,date_dx,diagcode),
KEY (hospcode),
KEY (pid),
KEY (cid),
KEY (date_dx),
KEY (diagcode),
KEY (source_tb)
)ENGINE=MyISAM  AS(
SELECT
 i.HOSPCODE,i.PID,p.CID,p.BIRTH,p.SEX,p.NATION,DATE_FORMAT(i.datetime_disch,'%Y%m%d') date_dx
 ,i.DIAGCODE,i.DIAGTYPE,'diag_ipd' as source_tb,NULL as PERIOD,NULL as group_tb
FROM
tmp_diag_ipd i 
 LEFT JOIN tmp_admission a ON a.HOSPCODE=i.HOSPCODE AND a.AN=i.AN
 LEFT JOIN person p ON  i.HOSPCODE=p.HOSPCODE AND i.PID=p.PID
WHERE
	substr(diagcode,1,3)  in('A15','A16','A17','A18','A19','U88','U89')
AND DATE_FORMAT(i.datetime_disch,'%Y%m%d')  BETWEEN @start_d1 AND @end_d
GROUP BY hospcode,pid,date_dx,diagcode
);

INSERT IGNORE INTO tmp_tb (
SELECT
 o.HOSPCODE,o.PID,p.CID,p.BIRTH,p.SEX,p.NATION,o.date_serv date_dx
 ,o.DIAGCODE,o.DIAGTYPE,'diag_opd' as source_tb,NULL as PERIOD,NULL as group_tb
FROM
tmp_diag_opd o 
 LEFT JOIN person p ON  o.HOSPCODE=p.HOSPCODE AND o.PID=p.PID
WHERE
	substr(diagcode,1,3)  in('A15','A16','A17','A18','A19','U88','U89')
AND o.DATE_SERV  BETWEEN @start_d1 AND @end_d
GROUP BY hospcode,pid,date_dx,diagcode
);

/*up period*/
UPDATE tmp_tb SET PERIOD='0'
WHERE date_dx BETWEEN @start_d1 AND  @end_d1;
UPDATE tmp_tb SET PERIOD='1'
WHERE date_dx BETWEEN  concat(@b_year-1,'1001') AND  concat(@b_year-1,'1231');
UPDATE tmp_tb SET PERIOD='2'
WHERE date_dx BETWEEN  concat(@b_year,'0101') AND  concat(@b_year,'0331');
UPDATE tmp_tb SET PERIOD='3'
WHERE date_dx BETWEEN  concat(@b_year,'0401') AND  concat(@b_year,'0630');
UPDATE tmp_tb SET PERIOD='4'
WHERE date_dx BETWEEN  concat(@b_year,'0701') AND  concat(@b_year,'0930');

/*upgroup*/
UPDATE tmp_tb SET group_tb='1'
WHERE diagcode in('A150','A151','A157');
UPDATE tmp_tb SET group_tb='2'
WHERE diagcode in('A160','A161','A152','A153','A162','A169');
UPDATE tmp_tb SET group_tb='3'
WHERE diagcode in('A154','A155','A156','A158','A159','A163','A164','A165','A167','A168') 
		OR substr(diagcode,1,3) in('A17','A18');

/*ทะเบียน TB สะสม*/
CREATE TABLE IF NOT EXISTS t_person_tb (
HOSPCODE  VARCHAR(5) DEFAULT NULL,
PID  VARCHAR(20) DEFAULT NULL,
CID  VARCHAR(13),
BIRTH DATE DEFAULT NULL,
SEX VARCHAR(1) DEFAULT NULL,
NATION VARCHAR(3) DEFAULT NULL,
DATE_DX DATE DEFAULT NULL,
DIAGCODE VARCHAR(7),
SOURCE_TB VARCHAR(20) DEFAULT NULL,
GROUP_tb  VARCHAR(1) DEFAULT NULL,
HOSP_DX  VARCHAR(5) DEFAULT NULL,
PRIMARY KEY (cid,diagcode),
KEY (hospcode),
KEY (pid),
KEY (cid),
KEY (date_dx),
KEY (diagcode),
KEY (GROUP_tb),
KEY (source_tb)
)ENGINE=MyISAM DEFAULT CHARSET=utf8;
REPLACE  INTO t_person_tb (
SELECT
 input_hosp,input_pid,cid,birth,sex,nation,date_dx 
,diagcode, source_tb,'0' as group_tb,hosp_dx
FROM
t_chronic
WHERE substr(diagcode,1,3)  in('A15','A16','A17','A18','A19','U88','U89') 
);
/*upgroup*/
UPDATE t_person_tb SET group_tb='1'
WHERE diagcode in('A150','A151','A157');
UPDATE t_person_tb SET group_tb='2'
WHERE diagcode in('A160','A161','A152','A153','A162','A169');
UPDATE t_person_tb SET group_tb='3'
WHERE diagcode in('A154','A155','A156','A158','A159','A163','A164','A165','A167','A168') 
		OR substr(diagcode,1,3) in('A17','A18');

/*ทะเบียนผู้ป่วยใหม่*/
DROP TABLE IF  EXISTS t_tb;
CREATE TABLE IF NOT EXISTS t_tb (
HOSPCODE  VARCHAR(5) DEFAULT NULL,
PID  VARCHAR(20) DEFAULT NULL,
CID  VARCHAR(13),
BIRTH DATE DEFAULT NULL,
SEX VARCHAR(1) DEFAULT NULL,
NATION VARCHAR(3) DEFAULT NULL,
DATE_DX DATE DEFAULT NULL,
DIAGCODE VARCHAR(7) DEFAULT NULL,
DIAGTYPE VARCHAR(1) DEFAULT NULL,
SOURCE_TB VARCHAR(20) DEFAULT NULL,
PERIOD VARCHAR(1),
GROUP_tb  VARCHAR(1) DEFAULT NULL,
PRIMARY KEY (cid,PERIOD),
KEY (hospcode),
KEY (pid),
KEY (cid),
KEY (date_dx),
KEY (diagcode),
KEY (GROUP_tb),
KEY (source_tb)
)ENGINE=MyISAM DEFAULT CHARSET=utf8;
/*จากผู้ป่วยเดิมที่มีอยู่เพื่อตัดรายเก่าออกมาเป็นกลับเป็นซ้ำ*/
INSERT IGNORE INTO t_tb (
SELECT
 hospcode,pid,cid,birth,sex,nation,date_dx 
,diagcode, null DIAGTYPE, source_tb,'0' as PERIOD ,group_tb
FROM
t_person_tb
WHERE  date_dx <  @end_d1
);
/*นำเข้า โดยให้ความสำคัญ diag_ipd ก่อน*/
INSERT IGNORE INTO t_tb (
SELECT
HOSPCODE,PID,CID,BIRTH,SEX,NATION,date_dx
 ,DIAGCODE,DIAGTYPE,source_tb,PERIOD,group_tb
FROM
tmp_tb
WHERE  date_dx BETWEEN  @start_d AND  @end_d AND source_tb='diag_ipd' AND group_tb in(1,2,3)
ORDER BY PERIOD,DATE_DX,CID
);

/*นำเข้า โดยให้ความสำคัญ diag_ipd ก่อน*/
INSERT IGNORE INTO t_tb (
SELECT
HOSPCODE,PID,CID,BIRTH,SEX,NATION,date_dx
 ,DIAGCODE,DIAGTYPE,source_tb,PERIOD,group_tb
FROM
tmp_tb
WHERE  date_dx BETWEEN  @start_d AND  @end_d AND source_tb='diag_opd' AND group_tb in(1,2,3)
ORDER BY PERIOD,DATE_DX,CID
);
 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.893255;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:300;a:5:{i:0;s:36:"DROP PROCEDURE IF EXISTS t_refer_sp5";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.9556551;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:303;a:5:{i:0;s:3868:"CREATE PROCEDURE t_refer_sp5()
 BEGIN 
SET @prov_c := '58';
SET @id := '46';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-2,'1001');
SET @end_d:=concat(@b_year,'0930');
DROP TABLE IF EXISTS t_refer_sp5;
CREATE TABLE IF NOT EXISTS t_refer_sp5 (
hospcode VARCHAR(5),
splevel VARCHAR(2) DEFAULT NULL,
pid VARCHAR(15),
cid VARCHAR(13) DEFAULT NULL,
seq VARCHAR(15) DEFAULT NULL,
an VARCHAR(15) DEFAULT NULL,
date_serv date,
sp_code VARCHAR(7) DEFAULT NULL,
source VARCHAR(15) DEFAULT NULL,
referin_hospcode VARCHAR(5) DEFAULT NULL,
referin_splevel VARCHAR(2) DEFAULT NULL,
typein VARCHAR(2) DEFAULT NULL,
clinic VARCHAR(3) DEFAULT NULL,
PRIMARY KEY (hospcode,pid,date_serv),
KEY (sp_code),
KEY (referin_hospcode),
KEY (typein)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;
/*สูติกรรม  */
INSERT IGNORE INTO  t_refer_sp5 
( 
hospcode,pid,an,date_serv,sp_code,source,clinic
)
(
SELECT HOSPCODE,PID,AN,DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d'),PROCEDCODE,'proced_ipd','1'
FROM procedure_ipd
WHERE DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d')  BETWEEN @start_d AND @end_d
	AND (SUBSTR(PROCEDCODE,1,3) BETWEEN '740' AND '744' 
	OR PROCEDCODE in('7491','7499'))
);
/*ศัลยกรรม*/
INSERT IGNORE INTO  t_refer_sp5 
( 
hospcode,pid,an,date_serv,sp_code,source,clinic
)
(
SELECT HOSPCODE,PID,AN,DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d'),PROCEDCODE,'proced_ipd','2'
FROM procedure_ipd
WHERE DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d')  BETWEEN @start_d AND @end_d
	AND PROCEDCODE BETWEEN '4701' AND '4719'
);

/*อายุรกรรม*/
INSERT IGNORE INTO  t_refer_sp5 
( 
hospcode,pid,an,date_serv,sp_code,source,clinic
)
(
SELECT HOSPCODE,PID,AN,DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d'),DIAGCODE,'diag_ipd','3'
FROM diagnosis_ipd
WHERE DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d')  BETWEEN @start_d AND @end_d
	AND (SUBSTR(DIAGCODE,1,3) BETWEEN 'A40' AND 'A41' 
	OR SUBSTR(DIAGCODE,1,3) in('R65'))
);

/*กุมารเวชกรรม*/
INSERT IGNORE INTO  t_refer_sp5 
( 
hospcode,pid,an,date_serv,sp_code,source,clinic
)
(
SELECT HOSPCODE,PID,AN,DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d'),PROCEDCODE,'proced_ipd','4'
FROM procedure_ipd
WHERE DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d')  BETWEEN @start_d AND @end_d
	AND PROCEDCODE in('9671','9672','939')
	);

/*ออโธปิดิกส์*/
INSERT IGNORE INTO  t_refer_sp5 
( 
hospcode,pid,an,date_serv,sp_code,source,clinic
)
(
SELECT HOSPCODE,PID,AN,DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d'),DIAGCODE,'diag_ipd','5'
FROM diagnosis_ipd
WHERE DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d')  BETWEEN @start_d AND @end_d
	AND DIAGCODE in('S42000','S42100','S42200','S42300','S42400','S42700','S42800','S42900'
	,'S52000','S52100','S52200','S52300','S52400','S52500','S52600','S52700','S52800','S52900'
	,'S62000','S62100','S62200','S62300','S62400','S6250','S6260','S6270','S6280','S9200','S9210'
	,'S9220','S9230','S9240','S9250','S9270','S9290')
);
/*update cid*/
UPDATE t_refer_sp5 s INNER JOIN person p ON s.hospcode=p.hospcode AND s.pid=p.pid 
SET s.cid=p.cid;
/*update refer*/
UPDATE t_refer_sp5 s INNER JOIN admission a ON a.hospcode=s.hospcode AND a.an=s.an
SET s.referin_hospcode=a.referinhosp , s.typein=a.TYPEIN;
/*update refer*/
UPDATE t_refer_sp5 s INNER JOIN service a ON a.hospcode=s.hospcode AND a.pid=s.pid AND a.DATE_SERV=s.date_serv
SET s.referin_hospcode=a.referinhosp, s.typein=a.TYPEIN,s.seq=a.seq ;

/*update level*/
UPDATE t_refer_sp5 s INNER JOIN (SELECT hcode,splevel FROM ccmihosp WHERE byear = (@b_year+543) GROUP BY hcode) a 
	ON a.hcode=s.hospcode SET s.splevel=a.splevel;

/*update level*/
UPDATE t_refer_sp5 s INNER JOIN (SELECT hcode,splevel FROM ccmihosp WHERE byear = (@b_year+543) GROUP BY hcode) a 
	ON a.hcode=s.referin_hospcode SET s.referin_splevel=a.splevel;

 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.018055;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:306;a:5:{i:0;s:35:"DROP PROCEDURE IF EXISTS t_accident";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.0804551;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:309;a:5:{i:0;s:602:"CREATE PROCEDURE t_accident()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '47';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF  EXISTS tmp_accident;
CREATE TABLE IF NOT EXISTS tmp_accident (
KEY (cid),
KEY (hospcode,pid),
KEY (hospcode,pid,seq),
KEY (DATETIME_SERV)
)ENGINE=MyISAM  AS(
SELECT
a.*,p.CID,p.BIRTH,p.SEX,p.NATION
FROM
accident a 
LEFT JOIN person p ON a.HOSPCODE=p.HOSPCODE AND a.PID=p.PID
WHERE DATE_FORMAT(a.DATETIME_SERV,'%Y%m%d') BETWEEN @start_d AND @end_d
);
 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.127255;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:312;a:5:{i:0;s:33:"DROP PROCEDURE IF EXISTS t_dental";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.190655;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:315;a:5:{i:0;s:2160:"CREATE PROCEDURE t_dental()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '48';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-2,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF  EXISTS tmp_dental;
CREATE TABLE IF NOT EXISTS tmp_dental 
(
PRIMARY KEY (HOSPCODE,PID,SEQ),
KEY (HOSPCODE ,PID),
KEY (HOSPCODE),
KEY (DATE_SERV),
KEY (DENTTYPE),
KEY (CLASS),
KEY (HOSPCODE,PROVIDER),
KEY (CID)
)ENGINE=MyISAM  AS(
SELECT
		d.*,p.cid
FROM
		dental d 
		LEFT JOIN person p ON d.HOSPCODE=p.HOSPCODE AND d.PID=p.PID
 WHERE
			DATE_FORMAT(d.date_serv,'%Y%m%d')  BETWEEN @start_d AND @end_d
GROUP BY HOSPCODE,PID,SEQ
);

DROP TABLE IF  EXISTS tmp_dental_last;
CREATE TABLE IF NOT EXISTS tmp_dental_last 
(
 HOSPCODE varchar(5) NOT NULL,
  PID varchar(15) NOT NULL,
  SEQ varchar(16) NOT NULL,
  DATE_SERV date NOT NULL,
  DENTTYPE varchar(1) NOT NULL,
  SERVPLACE varchar(1) NOT NULL,
  PTEETH int(2) DEFAULT NULL,
  PCARIES int(2) DEFAULT NULL,
  PFILLING int(2) DEFAULT NULL,
  PEXTRACT int(2) DEFAULT NULL,
  DTEETH int(2) DEFAULT NULL,
  DCARIES int(2) DEFAULT NULL,
  DFILLING int(2) DEFAULT NULL,
  DEXTRACT int(2) DEFAULT NULL,
  NEED_FLUORIDE char(1) DEFAULT NULL,
  NEED_SCALING char(1) DEFAULT NULL,
  NEED_SEALANT int(2) DEFAULT NULL,
  NEED_PFILLING int(2) DEFAULT NULL,
  NEED_DFILLING int(2) DEFAULT NULL,
  NEED_PEXTRACT int(2) DEFAULT NULL,
  NEED_DEXTRACT int(2) DEFAULT NULL,
  NPROSTHESIS char(1) DEFAULT NULL,
  PERMANENT_PERMANENT smallint(6) DEFAULT NULL,
  PERMANENT_PROSTHESIS smallint(6) DEFAULT NULL,
  PROSTHESIS_PROSTHESIS smallint(6) DEFAULT NULL,
  GUM varchar(6) DEFAULT NULL,
  SCHOOLTYPE char(1) DEFAULT NULL,
  CLASS char(1) DEFAULT NULL,
  PROVIDER varchar(15) DEFAULT NULL,
  D_UPDATE datetime NOT NULL,
CID varchar(13) DEFAULT NULL,
PRIMARY KEY (HOSPCODE,PID),
KEY (HOSPCODE ,PID),
KEY (HOSPCODE),
KEY (DATE_SERV),
KEY (DENTTYPE),
KEY (CLASS),
KEY (HOSPCODE,PROVIDER),
KEY (CID)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO tmp_dental_last (
	SELECT * FROM tmp_dental ORDER BY DATE_SERV DESC
);
 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.2374549;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:318;a:5:{i:0;s:36:"DROP PROCEDURE IF EXISTS t_all_alien";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.299855;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:321;a:5:{i:0;s:1672:"CREATE PROCEDURE t_all_alien()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '49';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
DROP TABLE IF EXISTS t_all_labor;
CREATE TABLE IF NOT EXISTS t_all_labor(
  HOSPCODE varchar(5) NOT NULL,
  PID varchar(15) NOT NULL,
	SEQ_AN varchar(15) NOT NULL,
  cid varchar(13) DEFAULT NULL,
  sex varchar(1) NOT NULL DEFAULT '',
  DATE_SERV date NOT NULL,
  INSTYPE varchar(4) NOT NULL,
  PRICE decimal(11,2) NOT NULL,
  PAYPRICE decimal(11,2) NOT NULL,
  ACTUALPAY decimal(11,2) NOT NULL,
  fee decimal(12,2) NOT NULL DEFAULT '0.00',
  LABOR varchar(2) DEFAULT NULL,
  NATION varchar(3) NOT NULL DEFAULT '',
	NATIONCODEAEC varchar(3) NOT NULL DEFAULT '',
  labor_group int(1) NOT NULL DEFAULT '0',
  diagcode varchar(8) NOT NULL DEFAULT '',
  diagtype varchar(1) NOT NULL DEFAULT '',
	source VARCHAR(50) DEFAULT NULL,
  KEY  (HOSPCODE,PID,SEQ_AN,DATE_SERV)
) ENGINE = myisam DEFAULT CHARSET=utf8;

INSERT IGNORE INTO t_all_labor (
SELECT
HOSPCODE,pid,seq,cid,sex,date_serv,INSTYPE,PRICE,PAYPRICE,ACTUALPAY,fee,LABOR,NATION,nationcodeaec,labor_group,diagcode,diagtype,'service' as 'source'
FROM t_service_labor 
);
INSERT IGNORE INTO  t_all_labor (
SELECT
HOSPCODE,'' as 'pid',an,cid,sex,DATE_FORMAT(DATETIME_DISCH,'%Y%m%d'),INSTYPE,PRICE,PAYPRICE,ACTUALPAY,fee,LABOR,NATION,nationcodeaec,labor_group,diagcode,diagtype,'admission' as 'source'
FROM t_admission_labor  
);
UPDATE t_all_labor l INNER JOIN tmp_admission a ON l.hospcode=a.hospcode AND l.seq_an=a.an 
SET l.pid=a.pid
WHERE l.source='admission';

 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.3466549;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:324;a:5:{i:0;s:36:"DROP PROCEDURE IF EXISTS t_alcoholic";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.393455;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:327;a:5:{i:0;s:710:"CREATE PROCEDURE t_alcoholic()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '50';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS t_alcoholic;
CREATE TABLE IF NOT EXISTS t_alcoholic (province varchar(2),PRIMARY KEY (province,hospcode,cid,date_serv,diagcode) ,KEY (cid)) ENGINE=myisam as (
SELECT
@prov_c province,HOSPCODE,pid,cid,DATE_SERV,DIAGCODE
FROM
tmp_diag_opd
WHERE substr(DIAGCODE,1,3) in('F10') OR DIAGCODE in('F171','F172') OR DIAGCODE in('Z508')
AND DATE_SERV BETWEEN @start_d AND  @end_d
GROUP BY province,hospcode,cid,date_serv,diagcode
ORDER BY HOSPCODE,CID,DIAGCODE
);
 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.4402561;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:330;a:5:{i:0;s:33:"DROP PROCEDURE IF EXISTS t_envocc";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.487056;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:333;a:5:{i:0;s:6444:"CREATE PROCEDURE t_envocc()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '51';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

/*external cause*/
DROP TABLE  IF EXISTS t_envocc_ext;
CREATE TABLE  IF NOT EXISTS t_envocc_ext(
PRIMARY KEY (hospcode,pid,seq_an,date_serv,DIAGCODE)
,KEY(cid)
,KEY (hospcode,pid)
,KEY (hospcode,pid,seq_an)
,KEY (date_serv)
,KEY (DIAGCODE)
) ENGINE = MyISAM as (
SELECT
HOSPCODE,PID,CID,SEQ as seq_an,DATE_SERV,DIAGCODE,DIAGTYPE,'diag_opd' as 'source'
FROM
tmp_diag_opd
WHERE DIAGCODE IN('Y96') 
   OR (SUBSTR(DIAGCODE,1,1) IN('V','W','X')  AND SUBSTR(DIAGCODE,5,1) in('2')) AND DATE_SERV BETWEEN @start_d AND @end_d
);
INSERT IGNORE INTO t_envocc_ext(
SELECT
HOSPCODE,PID,CID,AN as seq_an,DATE_FORMAT(datetime_disch,'%Y%m%d') as DATE_SERV
,DIAGCODE,DIAGTYPE,'diag_ipd' as 'source'
FROM
tmp_diag_ipd
WHERE DIAGCODE IN('Y96') 
   OR (SUBSTR(DIAGCODE,1,1) IN('V','W','X')  AND SUBSTR(DIAGCODE,5,1) in('2'))  AND DATE_FORMAT(datetime_disch,'%Y%m%d') BETWEEN @start_d AND @end_d
);
/*envocc_diag*/
DROP TABLE  IF EXISTS t_envocc;
CREATE TABLE  IF NOT EXISTS t_envocc(
PRIMARY KEY (hospcode,pid,seq_an,date_serv,DIAGCODE)
,KEY(cid)
,KEY (hospcode,pid)
,KEY (hospcode,pid,seq_an)
,KEY (date_serv)
,KEY (DIAGCODE)
) ENGINE = MyISAM as (
SELECT
HOSPCODE,PID,CID,SEQ as seq_an,DATE_SERV,DIAGCODE,DIAGTYPE,'diag_opd' as 'source'
FROM
tmp_diag_opd
WHERE  DATE_SERV BETWEEN @start_d AND @end_d 
AND (DIAGCODE  IN('J628','J61','J920','H833','H903','H904' ,'H905')
OR SUBSTR(DIAGCODE,1,3) IN('I20','I28')
OR SUBSTR(DIAGCODE,1,3) IN('C45','T52','T67')
OR SUBSTR(DIAGCODE,1,3)  BETWEEN  'J00' AND 'J39' 
OR SUBSTR(DIAGCODE,1,3)  BETWEEN  'J40' AND 'J47' 
OR SUBSTR(DIAGCODE,1,3)  BETWEEN  'J60' AND 'J99' )
);


INSERT IGNORE INTO  t_envocc (
SELECT
HOSPCODE,PID,CID,SEQ as seq_an,DATE_SERV,DIAGCODE,DIAGTYPE,'diag_opd' as 'source'
FROM
tmp_diag_opd
WHERE DATE_SERV BETWEEN @start_d AND  @end_d 
AND  DIAGCODE  IN('T600','T601','T602','T603','T604','T608','T609','T560')
AND CONCAT(HOSPCODE,'-',PID,'-',SEQ)  not in(
					SELECT
					CONCAT(HOSPCODE,'-',PID,'-',SEQ_an) 
					FROM t_envocc_ext 
					WHERE DIAGCODE in('X68') AND source in('diag_opd')
					)
);

INSERT IGNORE INTO  t_envocc (
SELECT
HOSPCODE,PID,CID,SEQ as seq_an,DATE_SERV,DIAGCODE,DIAGTYPE,'diag_opd' as 'source'
FROM
tmp_diag_opd
WHERE DATE_SERV BETWEEN @start_d AND  @end_d 
AND SUBSTR(DIAGCODE,1,3)  BETWEEN 'M00' AND 'M99'  
AND CONCAT(HOSPCODE,'-',PID,'-',SEQ)  in(
					SELECT
					CONCAT(HOSPCODE,'-',PID,'-',SEQ_an) 
					FROM t_envocc_ext 
					WHERE DIAGCODE in('Y96') AND source in('diag_opd')
					)
);
INSERT IGNORE INTO  t_envocc (
SELECT
HOSPCODE,PID,CID,SEQ as seq_an,DATE_SERV,DIAGCODE,DIAGTYPE,'diag_opd' as 'source'
FROM
tmp_diag_opd
WHERE DATE_SERV BETWEEN @start_d AND  @end_d 
AND SUBSTR(DIAGCODE,1,3)  IN('G56')
AND CONCAT(HOSPCODE,'-',PID,'-',SEQ)  in(
					SELECT
					CONCAT(HOSPCODE,'-',PID,'-',SEQ_an) 
					FROM t_envocc_ext 
					WHERE DIAGCODE in('Y96') AND source in('diag_opd')
					)
);


INSERT IGNORE INTO  t_envocc (
SELECT
HOSPCODE,PID,CID,SEQ as seq_an,DATE_SERV,DIAGCODE,DIAGTYPE,'diag_opd' as 'source'
FROM
tmp_diag_opd
WHERE DATE_SERV BETWEEN @start_d AND @end_d 
AND (SUBSTR(DIAGCODE,1,1)  IN('S') OR  SUBSTR(DIAGCODE,1,2)  IN('T0','T1','T2') )
AND CONCAT(HOSPCODE,'-',PID,'-',SEQ)  in(
					SELECT
					CONCAT(HOSPCODE,'-',PID,'-',SEQ_an) 
					FROM t_envocc_ext 
					WHERE (SUBSTR(DIAGCODE,1,1) IN('V','W','X')  AND SUBSTR(DIAGCODE,5,1) in('2'))
						AND source in('diag_opd')
					)
);

/*insert from diag_ipd*/
INSERT IGNORE INTO  t_envocc (
SELECT
HOSPCODE,PID,CID,AN as seq_an,DATE_FORMAT(datetime_disch,'%Y%m%d') as DATE_SERV
,DIAGCODE,DIAGTYPE,'diag_ipd' as 'source'
FROM
tmp_diag_ipd
WHERE DATE_FORMAT(datetime_disch,'%Y%m%d') BETWEEN @start_d AND @end_d 
AND (DIAGCODE  IN('J628','J61','J920','H833','H903','H904' ,'H905')
OR SUBSTR(DIAGCODE,1,3) IN('I20','I28')
OR SUBSTR(DIAGCODE,1,3) IN('C45','T52','T67')
OR SUBSTR(DIAGCODE,1,3)  BETWEEN  'J00' AND 'J39' 
OR SUBSTR(DIAGCODE,1,3)  BETWEEN  'J40' AND 'J47' 
OR SUBSTR(DIAGCODE,1,3)  BETWEEN  'J60' AND 'J99' )
);

INSERT IGNORE INTO  t_envocc (
SELECT
HOSPCODE,PID,CID,AN as seq_an,DATE_FORMAT(datetime_disch,'%Y%m%d') as DATE_SERV
,DIAGCODE,DIAGTYPE,'diag_ipd' as 'source'
FROM
tmp_diag_ipd
WHERE DATE_FORMAT(datetime_disch,'%Y%m%d') BETWEEN @start_d AND @end_d 
AND DIAGCODE  IN('T600','T601','T602','T603','T604','T608','T609','T560')
AND CONCAT(HOSPCODE,'-',PID,'-',AN)  not in(
					SELECT
					CONCAT(HOSPCODE,'-',PID,'-',SEQ_an) 
					FROM t_envocc_ext 
					WHERE DIAGCODE in('X68') AND source in('diag_ipd')
					)
);

INSERT IGNORE INTO  t_envocc (
SELECT
HOSPCODE,PID,CID,AN as seq_an,DATE_FORMAT(datetime_disch,'%Y%m%d') as DATE_SERV
,DIAGCODE,DIAGTYPE,'diag_ipd' as 'source'
FROM
tmp_diag_ipd
WHERE DATE_FORMAT(datetime_disch,'%Y%m%d') BETWEEN @start_d AND @end_d 
AND SUBSTR(DIAGCODE,1,3)  BETWEEN 'M00' AND 'M99'  
AND CONCAT(HOSPCODE,'-',PID,'-',AN)  in(
					SELECT
					CONCAT(HOSPCODE,'-',PID,'-',SEQ_an) 
					FROM t_envocc_ext 
					WHERE DIAGCODE in('Y96') AND source in('diag_ipd')
					)
);

INSERT IGNORE INTO  t_envocc (
SELECT
HOSPCODE,PID,CID,AN as seq_an,DATE_FORMAT(datetime_disch,'%Y%m%d') as DATE_SERV
,DIAGCODE,DIAGTYPE,'diag_ipd' as 'source'
FROM
tmp_diag_ipd
WHERE DATE_FORMAT(datetime_disch,'%Y%m%d') BETWEEN @start_d AND @end_d 
AND SUBSTR(DIAGCODE,1,3)  IN('G56')  
AND CONCAT(HOSPCODE,'-',PID,'-',AN)  in(
					SELECT
					CONCAT(HOSPCODE,'-',PID,'-',SEQ_an) 
					FROM t_envocc_ext 
					WHERE DIAGCODE in('Y96') AND source in('diag_ipd')
					)
);

INSERT IGNORE INTO  t_envocc (
SELECT
HOSPCODE,PID,CID,AN as seq_an,DATE_FORMAT(datetime_disch,'%Y%m%d') as DATE_SERV
,DIAGCODE,DIAGTYPE,'diag_ipd' as 'source'
FROM
tmp_diag_ipd
WHERE DATE_FORMAT(datetime_disch,'%Y%m%d') BETWEEN @start_d AND @end_d 
AND (SUBSTR(DIAGCODE,1,2)  IN('T0','T1','T2')  OR SUBSTR(DIAGCODE,1,1)  IN('S')   )
AND CONCAT(HOSPCODE,'-',PID,'-',AN)  in(
					SELECT
					CONCAT(HOSPCODE,'-',PID,'-',SEQ_an) 
					FROM t_envocc_ext 
					WHERE (SUBSTR(DIAGCODE,1,1) IN('V','W','X')  AND SUBSTR(DIAGCODE,5,1) in('2'))
						AND source in('diag_ipd')
					)
);

 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.5338559;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:336;a:5:{i:0;s:36:"DROP PROCEDURE IF EXISTS t_refer_4pa";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.596256;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:339;a:5:{i:0;s:4403:"CREATE PROCEDURE t_refer_4pa()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '52';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
SET @my_zone:=(SELECT zonecode FROM sys_config LIMIT 1);

DROP TABLE IF EXISTS tmz_person;
CREATE TEMPORARY TABLE IF NOT EXISTS tmz_person (PRIMARY KEY (hospcode,pid,birth),KEY (birth)  ) ENGINE=myisam as
(
SELECT * FROM person WHERE BIRTH BETWEEN concat(@b_year-1,'0701') AND @end_d
);
/*opdcase typeout=3*/
DROP TABLE IF  EXISTS t_refer_4pa;
CREATE TABLE IF NOT EXISTS t_refer_4pa (PRIMARY KEY(hospcode,pid,seq_an,diagcode) ,KEY (causeout),KEY (typeout) ) ENGINE=myisam as
(SELECT
s.HOSPCODE,s.pid,s.seq seq_an,s.date_serv,s.typeout,s.causeout,referouthosp,d.DIAGCODE,d.DIAGTYPE, 'opdcase' source
FROM tmp_service s 
	INNER JOIN tmp_diag_opd d ON s.HOSPCODE=d.HOSPCODE AND s.pid=d.PID AND s.seq=d.SEQ
	INNER JOIN (
		SELECT hcode FROM ccmihosp 
		WHERE byear in(@b_year+543)  AND chwcode in(@prov_c) 	AND hcode NOT IN (SELECT HOSPCODE FROM chospital_boat)
		GROUP BY hcode 
	) c ON s.HOSPCODE=c.hcode
	INNER JOIN (
		SELECT hcode FROM ccmihosp WHERE byear in(@b_year+543)  AND region NOT in(@my_zone) GROUP BY hcode 
	) z ON s.referouthosp=z.hcode
WHERE s.date_serv BETWEEN @start_d AND @end_d AND LENGTH(TRIM(s.referouthosp)) = 5 
		AND ( SUBSTR(DIAGCODE,1,1) in('C')
			OR SUBSTR(DIAGCODE,1,2) in('D0')
			OR SUBSTR(DIAGCODE,1,3) BETWEEN 'I20' AND 'I25'
			OR SUBSTR(DIAGCODE,1,3) BETWEEN 'V01' AND 'Y98'
		)
);

INSERT IGNORE INTO t_refer_4pa (
SELECT
s.HOSPCODE,s.pid,s.seq,s.date_serv,s.typeout,s.causeout,referouthosp,d.DIAGCODE,d.DIAGTYPE, 'opdcase' source
FROM tmp_service s 
	INNER JOIN tmp_diag_opd d ON s.HOSPCODE=d.HOSPCODE AND s.pid=d.PID AND s.seq=d.SEQ
	INNER JOIN (
		SELECT hcode FROM ccmihosp 
		WHERE byear in(@b_year+543)  AND chwcode in(@prov_c) 	AND hcode NOT IN (SELECT HOSPCODE FROM chospital_boat)
		GROUP BY hcode 
	) c ON s.HOSPCODE=c.hcode
	INNER JOIN (
		SELECT hcode FROM ccmihosp WHERE byear in(@b_year+543)  AND region NOT in(@my_zone) GROUP BY hcode 
	) z ON s.referouthosp=z.hcode
  INNER JOIN tmz_person p ON s.hospcode=p.HOSPCODE AND s.pid=p.PID
WHERE s.date_serv BETWEEN @start_d AND @end_d AND LENGTH(TRIM(s.referouthosp)) = 5 
	AND TIMESTAMPDIFF(day,p.BIRTH,s.date_serv) <= 28
	);

/*ipdcase DISCHTYPE=4*/
INSERT IGNORE INTO t_refer_4pa (
SELECT
s.HOSPCODE,s.pid,s.AN,DATE_FORMAT(s.DATETIME_DISCH,'%Y%m%d'),s.DISCHTYPE,s.causeout,referouthosp,d.DIAGCODE,d.DIAGTYPE, 'ipdcase' source
FROM tmp_admission s 
	INNER JOIN tmp_diag_ipd d ON s.HOSPCODE=d.HOSPCODE AND s.AN=d.AN
	INNER JOIN (
		SELECT hcode FROM ccmihosp 
		WHERE byear in(@b_year+543)  AND chwcode in(@prov_c) 	AND hcode NOT IN (SELECT HOSPCODE FROM chospital_boat)
		GROUP BY hcode 
	) c ON s.HOSPCODE=c.hcode
	INNER JOIN (
		SELECT hcode FROM ccmihosp WHERE byear in(@b_year+543)  AND region NOT in(@my_zone) GROUP BY hcode 
	) z ON s.referouthosp=z.hcode
WHERE DATE_FORMAT(s.DATETIME_DISCH,'%Y%m%d') BETWEEN @start_d AND @end_d AND LENGTH(TRIM(s.referouthosp)) = 5 
		AND ( SUBSTR(DIAGCODE,1,1) in('C')
			OR SUBSTR(DIAGCODE,1,2) in('D0')
			OR SUBSTR(DIAGCODE,1,3) BETWEEN 'I20' AND 'I25'
			OR SUBSTR(DIAGCODE,1,3) BETWEEN 'V01' AND 'Y98'
		)
);

INSERT IGNORE INTO t_refer_4pa (
SELECT
s.HOSPCODE,s.pid,s.AN,DATE_FORMAT(s.DATETIME_DISCH,'%Y%m%d'),s.DISCHTYPE,s.causeout,referouthosp,d.DIAGCODE,d.DIAGTYPE, 'ipdcase' source
FROM tmp_admission s 
	INNER JOIN tmp_diag_ipd d ON s.HOSPCODE=d.HOSPCODE AND s.AN=d.AN
	INNER JOIN (
		SELECT hcode FROM ccmihosp 
		WHERE byear in(@b_year+543)  AND chwcode in(@prov_c) 	AND hcode NOT IN (SELECT HOSPCODE FROM chospital_boat)
		GROUP BY hcode 
	) c ON s.HOSPCODE=c.hcode
	INNER JOIN (
		SELECT hcode FROM ccmihosp WHERE byear in(@b_year+543)  AND region NOT in(@my_zone) GROUP BY hcode 
	) z ON s.referouthosp=z.hcode
	INNER JOIN tmz_person p ON s.hospcode=p.HOSPCODE AND s.pid=p.PID
WHERE DATE_FORMAT(s.DATETIME_DISCH,'%Y%m%d') BETWEEN @start_d AND @end_d AND LENGTH(TRIM(s.referouthosp)) = 5 
	AND TIMESTAMPDIFF(day,p.BIRTH,s.DATETIME_DISCH) <= 28
	);

DELETE FROM t_refer_4pa WHERE hospcode in(
SELECT hcode  FROM ccmihosp WHERE byear in(@b_year+543)  AND region in(3) GROUP BY hcode 
) AND SUBSTR(DIAGCODE,1,3) BETWEEN 'I20' AND 'I25' ;

 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.6586559;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:342;a:5:{i:0;s:36:"DROP PROCEDURE IF EXISTS t_death28pa";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.721056;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:345;a:5:{i:0;s:2015:"CREATE PROCEDURE t_death28pa()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '53';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');


DROP TABLE IF EXISTS tmp_labor_hosp;
CREATE  TABLE IF NOT EXISTS tmp_labor_hosp(PRIMARY KEY (cid,bdate)) ENGINE= myisam as
(SELECT l.HOSPCODE,l.PID,l.BDATE,l.BHOSP,l.LBORN,p.NATION,p.CID
FROM tmp_labor l 
			INNER JOIN chospital c ON l.HOSPCODE=c.hoscode and c.hostype IN(5,6,7,11)
			INNER JOIN person p ON l.HOSPCODE=p.HOSPCODE AND l.pid=p.PID
WHERE l.BDATE BETWEEN @start_d AND @end_d 
AND  l.BHOSP IN(SELECT hoscode FROM chospital WHERE hostype IN(5,6,7,11) )
GROUP BY p.cid,l.bdate
);

INSERT IGNORE INTO tmp_labor_hosp (
SELECT l.HOSPCODE,l.PID,l.BDATE,l.BHOSP,l.LBORN,p.NATION,p.CID
FROM tmp_labor l 
			INNER JOIN person p ON l.HOSPCODE=p.HOSPCODE AND l.pid=p.PID
WHERE l.BDATE BETWEEN @start_d AND @end_d 
AND  l.BHOSP IN(SELECT hoscode FROM chospital WHERE hostype IN(5,6,7,11) ) 
GROUP BY p.cid,l.bdate
);


DROP TABLE IF EXISTS t_death28;
CREATE  TABLE IF NOT EXISTS t_death28(
date_death date,
DISCHARGE VARCHAR(2),
source VARCHAR(20),
PRIMARY KEY (hospcode,pid)) ENGINE= myisam as
(
SELECT s.HOSPCODE,s.pid,s.CID,p.`NAME`,p.LNAME,p.BIRTH,DATE_FORMAT(s.DATETIME_DISCH,'%Y%m%d') date_death 
,s.DISCHTYPE as DISCHARGE, 'admission' as source
FROM  tmp_admission s INNER JOIN person p ON s.HOSPCODE=p.HOSPCODE AND s.pid=p.PID
WHERE DATE_FORMAT(s.DATETIME_DISCH,'%Y%m%d') BETWEEN @start_d AND @end_d  
AND (s.DISCHTYPE in(8,9) OR s.DISCHSTATUS in(8,9))
AND TIMESTAMPDIFF(day,p.BIRTH,s.DATETIME_DISCH) <=28
);
INSERT IGNORE INTO t_death28 (
SELECT s.HOSPCODE,s.pid,s.CID,p.`NAME`,p.LNAME,p.BIRTH,date_serv,typeout, 'service' as source
FROM  tmp_service s INNER JOIN person p ON s.HOSPCODE=p.HOSPCODE AND s.pid=p.PID
WHERE s.date_serv BETWEEN @start_d AND @end_d  AND s.typeout in(4,5,6) 
AND TIMESTAMPDIFF(day,p.BIRTH,s.date_serv) <=28
);

 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.7678559;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:348;a:5:{i:0;s:38:"DROP PROCEDURE IF EXISTS t_occupat_new";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.830256;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:351;a:5:{i:0;s:1206:"CREATE PROCEDURE t_occupat_new()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '54';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF  EXISTS t_occupat_new;
CREATE TABLE IF NOT EXISTS t_occupat_new(
  id varchar(32) NOT NULL,
  hospcode varchar(5) NOT NULL,
  areacode varchar(8) NOT NULL,
  b_year varchar(4) NOT NULL,
	occupation_new varchar(4) NOT NULL,
	result int(9) DEFAULT 0,
	PRIMARY KEY (id,hospcode,areacode,b_year,occupation_new),
	KEY (hospcode),
	KEY (areacode),
	KEY (b_year)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO t_occupat_new (
SELECT @id,p.check_hosp hospcode ,p.check_vhid  areacode	
	  ,@b_year+543 as b_year
		,p.OCCUPATION_NEW
		,COUNT(DISTINCT p.cid) target
		FROM  t_person_cid p
	  WHERE SUBSTR(p.check_vhid,1,2) in(@prov_c)  
       AND p.check_typearea in(1,3) AND p.NATION in(99) 
       AND (p.DISCHARGE  in(2,3,9) OR (p.DISCHARGE  in(1)  AND p.DDISCHARGE > @start_d))
       AND TIMESTAMPDIFF(year,p.birth,CONCAT(@b_year,'0101')) BETWEEN 0 AND 199
		GROUP BY CONCAT(p.check_hosp ,'-' , p.check_vhid ,'-',p.OCCUPATION_NEW)
);
 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.8770559;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:354;a:5:{i:0;s:40:"DROP PROCEDURE IF EXISTS t_person_envocc";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.939456;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:357;a:5:{i:0;s:1372:"CREATE PROCEDURE t_person_envocc()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '55';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF  EXISTS t_person_envocc;
CREATE TABLE IF NOT EXISTS t_person_envocc(
PRIMARY KEY (hospcode,areacode)
,KEY (hospcode)
,KEY (areacode)
) ENGINE = myisam AS
(SELECT
	p.check_hosp hospcode,p.vhid areacode
	,COUNT(DISTINCT IF(TIMESTAMPDIFF(year,p.birth,CONCAT(@b_year,'0101')) BETWEEN 0 AND  4,  p.CID,NULL)) result04
	,COUNT(DISTINCT IF(TIMESTAMPDIFF(year,p.birth,CONCAT(@b_year,'0101')) BETWEEN 5 AND  9,  p.CID,NULL)) result59
	,COUNT(DISTINCT IF(TIMESTAMPDIFF(year,p.birth,CONCAT(@b_year,'0101')) BETWEEN 10 AND  14,  p.CID,NULL)) result1014
	,COUNT(DISTINCT IF(TIMESTAMPDIFF(year,p.birth,CONCAT(@b_year,'0101')) BETWEEN 15 AND  59,  p.CID,NULL)) result1559
	,COUNT(DISTINCT IF(TIMESTAMPDIFF(year,p.birth,CONCAT(@b_year,'0101')) BETWEEN 60 AND  199,  p.CID,NULL)) result60
FROM
t_person_cid p
WHERE SUBSTR(p.vhid,1,2) in(@prov_c)  AND (p.cid is null OR p.cid is not null) 
AND p.check_typearea in(1,3) AND p.NATION in(99) 
AND (p.DISCHARGE  in(2,3,9) OR (p.DISCHARGE  in(1)  AND p.DDISCHARGE > @start_d))
AND TIMESTAMPDIFF(year,p.birth,CONCAT(@b_year,'0101')) BETWEEN 0 AND 199
GROUP BY p.check_hosp,p.vhid
);
 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.001857;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:360;a:5:{i:0;s:38:"DROP PROCEDURE IF EXISTS tmp_specialpp";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.0642569;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:363;a:5:{i:0;s:11130:"CREATE PROCEDURE tmp_specialpp()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '56';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
SET @begin_d=DATE_ADD(@start_d,INTERVAL -43 month);
SET @begin_d1=DATE_ADD(@start_d,INTERVAL -1 month);
SET @end_d1:=concat(@b_year,'1030');


/*เตรียมข้อมูล*/
DROP TABLE IF EXISTS tmp_specialpp;
CREATE TABLE IF NOT EXISTS tmp_specialpp(
PRIMARY KEY (HOSPCODE,PID,DATE_SERV,PPSPECIAL) 
,KEY (cid)
,KEY (hospcode,pid)
,KEY (date_serv)
,KEY (ppspecial)
)(
SELECT 
s.*,p.CID
FROM specialpp s LEFT JOIN person p ON s.HOSPCODE=p.HOSPCODE AND s.PID=p.PID
WHERE DATE_SERV BETWEEN @begin_d1 AND @end_d1
);

/*หาเด็กกลุ่มเป้าหมาย*/
DROP TABLE IF EXISTS t_childdev;
CREATE TABLE  IF NOT EXISTS t_childdev(
  `HOSPCODE` varchar(5) NOT NULL DEFAULT '',
  `PID` varchar(15) NOT NULL DEFAULT '',
  `CID` varchar(13) NOT NULL,
  `BIRTH` date  DEFAULT NULL,
  `SEX` varchar(1) NOT NULL DEFAULT '',
  `AREACODE` varchar(8) DEFAULT NULL,
  `TYPEAREA` varchar(1) NOT NULL DEFAULT '',
  `AGE_9` int(1) NOT NULL DEFAULT '0',
  `AGE_18` int(1) NOT NULL DEFAULT '0',
  `AGE_30` int(1) NOT NULL DEFAULT '0',
  `AGE_42` int(1) NOT NULL DEFAULT '0',
PRIMARY KEY (`HOSPCODE`,`PID`),
 KEY (`HOSPCODE`,`PID`,`CID`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;
INSERT IGNORE INTO t_childdev (SELECT
 p.HOSPCODE,p.PID,p.CID,p.BIRTH,p.SEX,p.check_vhid AREACODE,p.check_typearea TYPEAREA,0,0,0,0
FROM t_person_cid  p
WHERE BIRTH BETWEEN @begin_d AND @end_d AND
						check_typearea in('1','3') AND p.DISCHARGE='9' AND LENGTH(trim(p.CID))=13 AND  NATION in(99) 
);

UPDATE t_childdev SET AGE_9=1 WHERE (DATE_ADD(BIRTH,INTERVAL 9 month)  BETWEEN @start_d AND @end_d) 
			OR (DATE_ADD(BIRTH,INTERVAL 10 month)  BETWEEN @start_d AND @end_d);
UPDATE t_childdev SET AGE_18=1 WHERE (DATE_ADD(BIRTH,INTERVAL 18 month)  BETWEEN @start_d AND @end_d)
			OR (DATE_ADD(BIRTH,INTERVAL 19 month)  BETWEEN @start_d AND @end_d);
UPDATE t_childdev SET AGE_30=1 WHERE (DATE_ADD(BIRTH,INTERVAL 30 month)  BETWEEN @start_d AND @end_d)
			OR (DATE_ADD(BIRTH,INTERVAL 31 month)  BETWEEN @start_d AND @end_d);
UPDATE t_childdev SET AGE_42=1 WHERE (DATE_ADD(BIRTH,INTERVAL 42 month)  BETWEEN @start_d AND @end_d)
			OR (DATE_ADD(BIRTH,INTERVAL 43 month)  BETWEEN @start_d AND @end_d);

/*นำเด็กกลุ่มเป้าหมายเข้าตารางคำนวน*/
DROP TABLE IF EXISTS t_childdev_specialpp;
CREATE TABLE  IF NOT EXISTS t_childdev_specialpp(
hospcode VARCHAR(5) NOT NULL,
pid VARCHAR(15) NOT NULL,
cid VARCHAR(15) NOT NULL DEFAULT '',
birth date,
sex VARCHAR(1) NOT NULL,
areacode VARCHAR(8) NOT NULL,
typearea VARCHAR(1) DEFAULT NULL,
agemonth VARCHAR(3) NOT NULL DEFAULT '',
date_start date,
date_end date,
date_serv_first date,
status1 VARCHAR(1) DEFAULT NULL,
date_serv2 date,
sp_first text,
sp_last text,
date_serv_last date,
status2 VARCHAR(1) DEFAULT NULL,
status21 VARCHAR(1) DEFAULT NULL,
status22 VARCHAR(1) DEFAULT NULL,
status23 VARCHAR(1) DEFAULT NULL,
status24 VARCHAR(1) DEFAULT NULL,
status25 VARCHAR(1) DEFAULT NULL,
 PRIMARY KEY(hospcode,pid,cid,agemonth)
,KEY (hospcode,pid,cid)
) ENGINE=MyISAM ;

INSERT IGNORE INTO t_childdev_specialpp (hospcode,pid,cid,birth,sex,areacode,typearea,agemonth)
(
SELECT
p.hospcode,p.pid,p.cid,p.birth,p.sex,p.areacode,p.typearea,'42'
FROM t_childdev p
WHERE AGE_42=1
);
INSERT IGNORE INTO t_childdev_specialpp (hospcode,pid,cid,birth,sex,areacode,typearea,agemonth)
(
SELECT
p.hospcode,p.pid,p.cid,p.birth,p.sex,p.areacode,p.typearea,'30'
FROM t_childdev p
WHERE AGE_30=1
);
INSERT IGNORE INTO t_childdev_specialpp (hospcode,pid,cid,birth,sex,areacode,typearea,agemonth)
(
SELECT
p.hospcode,p.pid,p.cid,p.birth,p.sex,p.areacode,p.typearea,'18'
FROM t_childdev p
WHERE AGE_18=1
);
INSERT IGNORE INTO t_childdev_specialpp (hospcode,pid,cid,birth,sex,areacode,typearea,agemonth)
(
SELECT
p.hospcode,p.pid,p.cid,p.birth,p.sex,p.areacode,p.typearea,'9'
FROM t_childdev p
WHERE AGE_9=1
);



INSERT IGNORE INTO t_childdev_specialpp (hospcode,pid,cid,birth,sex,areacode,typearea,agemonth)
(SELECT
p.hospcode,p.pid,p.cid,p.birth,p.sex,p.areacode,p.typearea
,IF(age_18=1 AND age_9=1 , 18 ,0)
FROM t_childdev p
);
INSERT IGNORE INTO t_childdev_specialpp (hospcode,pid,cid,birth,sex,areacode,typearea,agemonth)
(SELECT
p.hospcode,p.pid,p.cid,p.birth,p.sex,p.areacode,p.typearea
,IF(age_18=1 AND age_9=1 , 9 ,0)
FROM t_childdev p
);
DELETE FROM t_childdev_specialpp WHERE agemonth=0;

/*อัพเดทช่วงวันที่ที่ทำแล้วถือว่าได้รับการคัดกรอง*/
UPDATE  t_childdev_specialpp SET date_start=DATE_ADD(BIRTH,INTERVAL 9 month) ,date_end=DATE_ADD(DATE_ADD(BIRTH,INTERVAL 10 month),INTERVAL -1 DAY)  WHERE agemonth=9;
UPDATE  t_childdev_specialpp SET date_start=DATE_ADD(BIRTH,INTERVAL 18 month) ,date_end=DATE_ADD(DATE_ADD(BIRTH,INTERVAL 19 month),INTERVAL -1 DAY)  WHERE agemonth=18;
UPDATE  t_childdev_specialpp SET date_start=DATE_ADD(BIRTH,INTERVAL 30 month) ,date_end=DATE_ADD(DATE_ADD(BIRTH,INTERVAL 31 month),INTERVAL -1 DAY)  WHERE agemonth=30;
UPDATE  t_childdev_specialpp SET date_start=DATE_ADD(BIRTH,INTERVAL 42 month) ,date_end=DATE_ADD(DATE_ADD(BIRTH,INTERVAL 43 month),INTERVAL -1 DAY)  WHERE agemonth=42;

/*หาวันที่วันแรกที่ได้รับการตรวจเอาวันน้อยที่สุดจากวันเกิดที่มีรหัสที่กำหนด*/
UPDATE t_childdev_specialpp s INNER JOIN 
(
			SELECT s1.cid,s1.date_start, s1.date_end ,MIN(t1.date_serv) min_date_serv
			FROM tmp_specialpp  t1 INNER JOIN t_childdev_specialpp s1 ON  t1.cid=s1.cid
			WHERE t1.date_serv BETWEEN s1.date_start AND s1.date_end 
			AND PPSPECIAL in('1B260','1B261','1B262' ,'1B200'
			,'1B201','1B202','1B209','1B210','1B211','1B212'
			,'1B219','1B220','1B221','1B222','1B229','1B230'
			,'1B231','1B232','1B239','1B240','1B241','1B242','1B249')
			GROUP BY t1.cid,s1.date_start
)
t  ON s.cid=t.cid   AND s.date_start=t.date_start
SET s.date_serv_first= t.min_date_serv
WHERE t.min_date_serv BETWEEN s.date_start AND s.date_end ;

/*อัพเดททgroup รหัสที่ทำวันแรกทั้งหมด*/
UPDATE t_childdev_specialpp s INNER JOIN 
(
			SELECT s1.cid,s1.date_serv_first ,GROUP_CONCAT(t1.PPSPECIAL ORDER BY t1.PPSPECIAL) gr_sp
			FROM tmp_specialpp  t1 INNER JOIN t_childdev_specialpp s1 ON  t1.cid=s1.cid
			WHERE t1.date_serv in(s1.date_serv_first)
			GROUP BY t1.cid,s1.date_serv_first
)
t  ON s.cid=t.cid  AND s.date_serv_first=t.date_serv_first
SET s.sp_first= t.gr_sp	 ;

/*สรุปผลครั้งแรกตามเงื่อนไข*/
UPDATE t_childdev_specialpp SET status1=IF(INSTR(sp_first,'1B260'),1
,IF(INSTR(sp_first,'1B261'),2
,IF(INSTR(sp_first,'1B262'),3
,NULL
)))
WHERE date_serv_first IS NOT NULL;

/*สรุปผลครั้งแรกถ้าลงรหัสแบบที่ละด้านแบบเดิม*/
UPDATE t_childdev_specialpp SET status1=IF(INSTR(sp_first,'1B200,1B210,1B220,1B230,1B240'),1,NULL)
WHERE date_serv_first IS NOT NULL AND status1 IS NULL;

UPDATE t_childdev_specialpp SET status1=IF(
instr(sp_first,'1B201') 
OR instr(sp_first,'1B211') 
OR instr(sp_first,'1B221') 
OR instr(sp_first,'1B231') 
OR instr(sp_first,'1B241') 
,2,NULL)
WHERE date_serv_first IS NOT NULL AND status1 IS NULL;

UPDATE t_childdev_specialpp SET status1=IF(
instr(sp_first,'1B202') 
OR instr(sp_first,'1B212') 
OR instr(sp_first,'1B222') 
OR instr(sp_first,'1B232') 
OR instr(sp_first,'1B242') 
,3,NULL)
WHERE date_serv_first IS NOT NULL AND status1 IS NULL;


/*อัพเดทวันที่ติดตามนับจากวันครั้งแรกถึงวันสุดท้ายที่ไม่เกิน 30 วันที่เป็นไปได้ กรณีผิดปกติ*/
UPDATE  t_childdev_specialpp SET date_serv2=DATE_ADD(date_serv_first,INTERVAL 30 day) 
WHERE date_serv_first  IS NOT NULL AND status1 in(2) ;


/*หาวันที่วันสุดท้ายที่มาตรวจ  ตามช่วง 30 วันที่กำหนด เปลี่ยนได้ตลอดจนกว่าจะเลย 30 วัน*/
UPDATE t_childdev_specialpp s INNER JOIN 
(
			SELECT s1.cid,s1.date_serv_first, s1.date_serv2 ,MAX(t1.date_serv) max_date_serv
			FROM tmp_specialpp  t1 INNER JOIN t_childdev_specialpp s1 ON  t1.cid=s1.cid
			WHERE t1.date_serv BETWEEN s1.date_serv_first AND s1.date_serv2 
			AND PPSPECIAL in('1B260','1B261','1B262' ,'1B200'
			,'1B201','1B202','1B209','1B210','1B211','1B212'
			,'1B219','1B220','1B221','1B222','1B229','1B230'
			,'1B231','1B232','1B239','1B240','1B241','1B242','1B249')
			GROUP BY t1.cid,s1.date_serv2
)
t  ON s.cid=t.cid  AND s.date_serv2=t.date_serv2
SET s.date_serv_last= t.max_date_serv
WHERE t.max_date_serv BETWEEN s.date_serv_first AND s.date_serv2 
AND t.max_date_serv > s.date_serv_first AND s.date_serv2 is not null;


/*อัพเดททgroup รหัสวันสุดท้ายกรณีที่ติดตาม จะเปลี่ยนแปลงได้ตลอดจนกว่าจะเลย 30 วันจึงจะสรุปได้จริง*/
UPDATE t_childdev_specialpp s INNER JOIN 
(
			SELECT s1.cid,s1.date_serv_last ,GROUP_CONCAT(t1.PPSPECIAL) gr_sp
			FROM tmp_specialpp  t1 INNER JOIN t_childdev_specialpp s1 ON  t1.cid=s1.cid
			WHERE t1.date_serv in(s1.date_serv_last)
			GROUP BY t1.cid,s1.date_serv_last
)
t  ON s.cid=t.cid   AND s.date_serv_last=t.date_serv_last
SET s.sp_last= t.gr_sp
WHERE  s.date_serv2 is not null	 ;
/*สรุปผลครั้งสุดท้าย*/
UPDATE t_childdev_specialpp SET status21=IF(INSTR(sp_last,'1B202'),1,null),
status22=IF(INSTR(sp_last,'1B212'),1,null),
status23=IF(INSTR(sp_last,'1B222'),1,null),
status24=IF(INSTR(sp_last,'1B232'),1,null),
status25= IF(INSTR(sp_last,'1B242'),1,null)
WHERE date_serv_last IS NOT NULL AND  INSTR(sp_last,'1B260')=0  
AND date_serv_last > date_serv_first  
AND NOW() > date_serv2 
AND date_serv2 is not null;

UPDATE t_childdev_specialpp SET status2=IF(INSTR(sp_last,'1B260'),1,NULL)
 WHERE date_serv_last IS NOT NULL AND date_serv_last > date_serv_first AND status2 IS NULL
AND date_serv2 is not null;

/*สรุปผลครั้งสุดท้ายถ้าลงรหัสแบบที่ละด้านแบบเดิม*/
UPDATE t_childdev_specialpp SET status2=IF(INSTR(sp_first,'1B200,1B210,1B220,1B230,1B240'),1,NULL)
WHERE date_serv_last IS NOT NULL AND date_serv_last > date_serv_first AND status2 IS NULL
AND date_serv2 is not null;
 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.111057;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:366;a:5:{i:0;s:44:"DROP PROCEDURE IF EXISTS t_nutrition_service";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.1734569;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:369;a:5:{i:0;s:3554:"CREATE PROCEDURE t_nutrition_service()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '57';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS t_nutrition_service;
CREATE TABLE IF NOT EXISTS t_nutrition_service(
hospcode VARCHAR(5) NOT NULL,
pid VARCHAR(15) NOT NULL,
seq VARCHAR(16) NOT NULL,
date_serv date,
weight decimal(5,1) NOT NULL,
height  int(3) NOT NULL,
HEADCIRCUM int(3) DEFAULT NULL,
FOOD varchar(1) DEFAULT NULL,
BOTTLE varchar(1) DEFAULT NULL,
BIRTH date,
SEX varchar(1) NOT NULL,
NATION varchar(3) DEFAULT NULL,
quarter_m int(1) DEFAULT 0,
nutri1 int(1) DEFAULT 0,
nutri2 int(1) DEFAULT 0,
nutri3 int(1) DEFAULT 0,
PRIMARY KEY (hospcode,pid,quarter_m)
)  ENGINE MyISAM DEFAULT CHARACTER SET=utf8;

INSERT IGNORE INTO t_nutrition_service (HOSPCODE,PID,SEQ,DATE_SERV,WEIGHT,HEIGHT,HEADCIRCUM,FOOD,BOTTLE
,BIRTH,SEX,NATION,quarter_m)
(
SELECT n.HOSPCODE,n.PID,n.SEQ,n.DATE_SERV,n.WEIGHT,n.HEIGHT,n.HEADCIRCUM,FOOD,BOTTLE
,p.BIRTH,p.SEX,p.NATION, IF(DATE_FORMAT(n.DATE_SERV,'%m') BETWEEN 10 AND 12,1,
IF(DATE_FORMAT(n.DATE_SERV,'%m') BETWEEN 1 AND 3,2,
IF(DATE_FORMAT(n.DATE_SERV,'%m') BETWEEN 4 AND 6,3,
IF(DATE_FORMAT(n.DATE_SERV,'%m') BETWEEN 7 AND 9,4,0
 )))) as quarter_m
FROM
tmp_nutrition n INNER JOIN t_person_db p ON n.HOSPCODE=p.HOSPCODE AND n.PID=p.PID
WHERE WEIGHT BETWEEN 0.1  AND 300 AND HEIGHT   BETWEEN 40 AND 250 
AND n.DATE_SERV >= p.birth
AND n.DATE_SERV BETWEEN  @start_d AND @end_d
AND p.NATION in(99) 
ORDER BY n.HOSPCODE ASC ,n.PID ASC ,n.DATE_SERV DESC 
);

UPDATE t_nutrition_service SET nutri1=nutri_cal(TIMESTAMPDIFF(month,birth,date_serv),sex,1,height,weight)
,nutri2=nutri_cal(TIMESTAMPDIFF(month,birth,date_serv),sex,2,height,weight)
,nutri3=nutri_cal(TIMESTAMPDIFF(month,birth,date_serv),sex,3,height,weight);

DROP TABLE IF EXISTS t_nutrition_service6_14;
CREATE TABLE IF NOT EXISTS t_nutrition_service6_14(
hospcode VARCHAR(5) NOT NULL,
pid VARCHAR(15) NOT NULL,
seq VARCHAR(16) NOT NULL,
date_serv date,
weight decimal(5,1) NOT NULL,
height  int(3) NOT NULL,
HEADCIRCUM int(3) DEFAULT NULL,
FOOD varchar(1) DEFAULT NULL,
BOTTLE varchar(1) DEFAULT NULL,
BIRTH date,
SEX varchar(1) NOT NULL,
NATION varchar(3) DEFAULT NULL,
quarter_m int(1) DEFAULT 0,
nutri1 int(1) DEFAULT 0,
nutri2 int(1) DEFAULT 0,
nutri3 int(1) DEFAULT 0,
PRIMARY KEY (hospcode,pid,quarter_m)
)  ENGINE MyISAM DEFAULT CHARACTER SET=utf8;

INSERT IGNORE INTO t_nutrition_service6_14 (HOSPCODE,PID,SEQ,DATE_SERV,WEIGHT,HEIGHT,HEADCIRCUM,FOOD,BOTTLE
,BIRTH,SEX,NATION,quarter_m)
(
SELECT n.HOSPCODE,n.PID,n.SEQ,n.DATE_SERV,n.WEIGHT,n.HEIGHT,n.HEADCIRCUM,FOOD,BOTTLE
,p.BIRTH,p.SEX,p.NATION, IF(DATE_FORMAT(n.DATE_SERV,'%m') BETWEEN 10 AND 11,2,
IF(DATE_FORMAT(n.DATE_SERV,'%m') BETWEEN 5 AND 6,1,0
 )) as quarter_m
FROM
tmp_nutrition n INNER JOIN t_person_db p ON n.HOSPCODE=p.HOSPCODE AND n.PID=p.PID
WHERE WEIGHT BETWEEN 0.1  AND 300 AND HEIGHT   BETWEEN 40 AND 250 
AND n.DATE_SERV >= p.birth AND TIMESTAMPDIFF(YEAR,p.BIRTH,n.DATE_SERV) BETWEEN 6 AND 14
AND  n.DATE_SERV BETWEEN  @start_d AND @end_d
AND p.NATION in(99) 
ORDER BY n.HOSPCODE ASC ,n.PID ASC ,n.DATE_SERV DESC 
);

UPDATE t_nutrition_service6_14 SET nutri1=nutri_cal(TIMESTAMPDIFF(month,birth,date_serv),sex,1,height,weight)
,nutri2=nutri_cal(TIMESTAMPDIFF(month,birth,date_serv),sex,2,height,weight)
,nutri3=nutri_cal(TIMESTAMPDIFF(month,birth,date_serv),sex,3,height,weight);


 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.251457;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:372;a:5:{i:0;s:34:"DROP PROCEDURE IF EXISTS t_cvdrisk";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.3138571;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:375;a:5:{i:0;s:18289:"CREATE PROCEDURE t_cvdrisk()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '58';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'0701');
SET	@start_d10:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
SET @end_d12:=concat(@b_year-1,'1231');

DROP TABLE IF EXISTS t_cvd_ill;
CREATE TABLE IF NOT EXISTS t_cvd_ill(
 CID varchar(13) NOT NULL
 ,`BIRTH` date
 ,`SEX` varchar(1) NOT NULL
 ,source_tb VARCHAR(255) DEFAULT NULL 
 ,mix_dx VARCHAR(255) DEFAULT NULL 	
 ,date_dx VARCHAR(255) DEFAULT NULL 
 ,hosp_dx varchar(255) DEFAULT NULL 
 ,hosp_input varchar(255) DEFAULT NULL 
,PRIMARY KEY (`CID`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;
INSERT IGNORE INTO 	t_cvd_ill (
SELECT cid,birth,sex
,GROUP_CONCAT(source_tb ORDER BY date_dx)
,GROUP_CONCAT(diagcode ORDER BY date_dx)
,GROUP_CONCAT(date_dx ORDER BY date_dx)
,GROUP_CONCAT(IFNULL(hosp_dx,input_hosp) ORDER BY date_dx)
,GROUP_CONCAT(input_hosp ORDER BY date_dx)
FROM t_chronic WHERE SUBSTR(UPPER(diagcode),1,4) IN ('E105','E115','E125','E135','E145','I110','I119') 
OR SUBSTR(UPPER(diagcode),1,3) BETWEEN  'I60' AND 'I64' 
OR SUBSTR(UPPER(diagcode),1,3) IN ('I13') 
GROUP BY cid
);

DROP TABLE IF EXISTS tmp_fu_screen;
CREATE TABLE IF NOT EXISTS tmp_fu_screen(
 `HOSPCODE` varchar(5) NOT NULL,
 `CID` varchar(13) DEFAULT NULL,
 `PID` varchar(15) NOT NULL,
	`SEQ` varchar(16) NOT NULL,
 `DATE_SERV` date NOT NULL,
 `SBP` int(3) NOT NULL DEFAULT  0,
 `SBP_SOURCE` VARCHAR(20) DEFAULT NULL,
 `WAIST_CM` int(3) NOT NULL DEFAULT 0,
 `WAIST_SOURCE` VARCHAR(20) DEFAULT NULL,
 `HEIGHT` int(3) NOT NULL DEFAULT 0,
 `HEIGHT_SOURCE` VARCHAR(20) DEFAULT NULL,
 `QUARTERM` VARCHAR(1) DEFAULT NULL,
PRIMARY KEY (`HOSPCODE`,`PID`,`DATE_SERV`),
  KEY  (`HOSPCODE`,`PID`),
  KEY  (`HOSPCODE`),
  KEY  (`DATE_SERV`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO tmp_fu_screen (
SELECT  HOSPCODE,CID,PID,SEQ,DATE_SERV,SBP,'CHRONICFU',WAIST_CM,'CHRONICFU',HEIGHT,'CHRONICFU',NULL
FROM tmp_chronicfu
WHERE date_serv BETWEEN @start_d AND @end_d
);
INSERT IGNORE INTO tmp_fu_screen (
SELECT  HOSPCODE,CID,PID,SEQ,DATE_SERV,IF(SBP_2>0,SBP_2,SBP_1) SBP,'NCDSCREEN',WAIST_CM,'NCDSCREEN',HEIGHT,'NCDSCREEN',NULL
FROM tmp_ncdscreen
WHERE date_serv BETWEEN @start_d AND @end_d
);
UPDATE tmp_fu_screen SET QUARTERM=IF( DATE_SERV < concat(@b_year-1,'1001'),0,
IF(DATE_SERV BETWEEN concat(@b_year-1,'1001') AND concat(@b_year-1,'1231'),1,
IF(DATE_SERV BETWEEN concat(@b_year,'0101') AND concat(@b_year,'0331'),2,
IF(DATE_SERV BETWEEN concat(@b_year,'0401') AND concat(@b_year,'0630'),3,
IF(DATE_SERV BETWEEN concat(@b_year,'0701') AND concat(@b_year,'0930'),4,null
)))));

/*LAB TOTAL CHOL*/
DROP TABLE IF EXISTS tmz_labcvd;
CREATE TABLE IF NOT EXISTS tmz_labcvd(
 `QUARTERM` VARCHAR(1) DEFAULT NULL,
PRIMARY KEY (HOSPCODE,PID,SEQ,LABTEST),KEY (CID) ,KEY (DATE_SERV), KEY (HOSPCODE,PID,DATE_SERV)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 AS
(SELECT *,null as QUARTERM FROM tmp_labfu WHERE LABTEST in(7) AND LABRESULT >0 GROUP BY HOSPCODE,PID,SEQ,LABTEST);

UPDATE tmz_labcvd SET QUARTERM=IF( DATE_SERV < concat(@b_year-1,'1001'),0,
IF(DATE_SERV BETWEEN concat(@b_year-1,'1001') AND concat(@b_year-1,'1231'),1,
IF(DATE_SERV BETWEEN concat(@b_year,'0101') AND concat(@b_year,'0331'),2,
IF(DATE_SERV BETWEEN concat(@b_year,'0401') AND concat(@b_year,'0630'),3,
IF(DATE_SERV BETWEEN concat(@b_year,'0701') AND concat(@b_year,'0930'),4,null
)))));

/*SMOKE */
DROP TABLE IF EXISTS tmp_smoke;
CREATE TABLE IF NOT EXISTS tmp_smoke(
 `HOSPCODE` varchar(5) NOT NULL,
 `PID` varchar(15) NOT NULL,
 `CID` varchar(13) DEFAULT NULL,
 `DATE_SERV` date NOT NULL,
 `SMOKE_SOURCE`  VARCHAR(50) DEFAULT NULL,
 `RESULT` VARCHAR(1) DEFAULT NULL COMMENT '1=สูบ,0=ไม่สูบ',
 `QUARTERM` VARCHAR(1) DEFAULT NULL,
PRIMARY KEY (HOSPCODE,PID,DATE_SERV),KEY (CID) ,KEY (DATE_SERV), KEY (HOSPCODE,PID,DATE_SERV)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 ;

INSERT IGNORE INTO tmp_smoke(
SELECT HOSPCODE,PID,CID,DATE_SERV,'NCDSCREEN',IF(SMOKE=1,0,1) ,NULL 
FROM tmp_ncdscreen WHERE SMOKE in(1,2,3,4)
);
INSERT IGNORE INTO tmp_smoke(
SELECT  HOSPCODE,PID,CID,DATE_SERV,'SPECIALPP',1 ,NULL 
FROM tmp_specialpp 
WHERE SUBSTR(PPSPECIAL,1,4) IN('1B50','1B53','1B54','1B55','1B56')
);
INSERT IGNORE INTO tmp_smoke(
SELECT  HOSPCODE,PID,CID,DATE_SERV,'SPECIALPP',0 ,NULL 
FROM tmp_specialpp WHERE PPSPECIAL in('1B51','1B52') 
);
UPDATE tmp_smoke SET QUARTERM=IF( DATE_SERV < concat(@b_year-1,'1001'),0,
IF(DATE_SERV BETWEEN concat(@b_year-1,'1001') AND concat(@b_year-1,'1231'),1,
IF(DATE_SERV BETWEEN concat(@b_year,'0101') AND concat(@b_year,'0331'),2,
IF(DATE_SERV BETWEEN concat(@b_year,'0401') AND concat(@b_year,'0630'),3,
IF(DATE_SERV BETWEEN concat(@b_year,'0701') AND concat(@b_year,'0930'),4,null
)))));

/*T_CVD*/
DROP TABLE IF EXISTS t_cvdrisk;
CREATE TABLE IF NOT EXISTS t_cvdrisk(
 `CID` varchar(13) DEFAULT NULL
 ,`BIRTH` date
 ,`SEX` varchar(1) NOT NULL
 ,`TYPEAREA` varchar(1) NOT NULL
 ,`nation` varchar(3) DEFAULT NULL
,source_tb VARCHAR(255) DEFAULT NULL 
 ,mix_dx VARCHAR(255) DEFAULT NULL 	
 ,t_mix_dx VARCHAR(255) DEFAULT NULL 	
 ,type_dx VARCHAR(2) DEFAULT NULL 
 ,date_dx VARCHAR(255) DEFAULT NULL 
 ,hosp_dx varchar(255) DEFAULT NULL 
	,`AGE_Y` int(3) NOT NULL DEFAULT '0' 
	,`SEX_CVD` varchar(1) DEFAULT NULL
 ,`QUARTERM` VARCHAR(1) DEFAULT NULL
 ,`SMOKING` varchar(1) DEFAULT NULL
 ,`SMOKE_DATE` date DEFAULT NULL
 ,`SMOKE_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`SMOKE_SOURCE` VARCHAR(20) DEFAULT NULL
 ,`DM` varchar(1) DEFAULT NULL
 ,`SBP` int(3) NOT NULL DEFAULT  0
 ,`SBP_DATE` date DEFAULT NULL
 ,`SBP_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`SBP_SOURCE` VARCHAR(20) DEFAULT NULL
 ,`CHOL` double(6,2) NOT NULL DEFAULT 0
 ,`CHOL_DATE` date DEFAULT NULL
 ,`CHOL_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`WAIST_CM` int(3) NOT NULL DEFAULT 0
 ,`WAIST_DATE` date DEFAULT NULL
 ,`WAIST_HOSPCODE` VARCHAR(5) DEFAULT NULL
  ,`WAIST_SOURCE` VARCHAR(20) DEFAULT NULL
 ,`HEIGHT` int(3) NOT NULL DEFAULT 0
 ,`HEIGHT_DATE` date DEFAULT NULL
 ,`HEIGHT_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`HEIGHT_SOURCE` VARCHAR(20) DEFAULT NULL
 ,`RISK_SCORE` DECIMAL(5,2) NOT NULL DEFAULT 0.00
,PRIMARY KEY (`CID`, `QUARTERM` )
	,KEY  (`CID`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

SET @x=0;
SET @max= 5;
WHILE @x<@max DO
INSERT IGNORE INTO t_cvdrisk(
	cid,birth,sex,typearea,age_y,nation,source_tb,hosp_dx,mix_dx,t_mix_dx,date_dx,QUARTERM
)
(
	SELECT SQL_BIG_RESULT 
			p.cid,p.birth,p.sex,p.typearea, p.age_y,p.nation
			,GROUP_CONCAT(c.source_tb order by date_dx) source_tb
			,GROUP_CONCAT(hosp_dx order by date_dx) hosp_dx
			,GROUP_CONCAT(diagcode order by date_dx ) diagcode
			,GROUP_CONCAT(DISTINCT  substr(diagcode,1,1) order by  substr(diagcode,1,1) ) 
			,GROUP_CONCAT(date_dx order by date_dx) date_dx
			,@x
FROM
(SELECT c.* FROM t_chronic c LEFT JOIN t_cvd_ill i ON c.cid=i.cid
WHERE  (SUBSTR(UPPER(c.diagcode),1,3) BETWEEN  'E10' and 'E14'  OR 	SUBSTR(UPPER(c.diagcode),1,3) BETWEEN  'I10' and 'I15')  
AND ISNULL(i.cid)
GROUP BY concat(c.cid,'-',c.diagcode) ) c 
INNER JOIN t_person_cid  p ON c.cid = p.cid
WHERE p.nation in(99) AND p.DISCHARGE in(9) AND c.typedisch NOT in(2)
GROUP BY p.cid
);

SET  @x = @x + 1; 
END WHILE;
/*up_mixdiag*/
UPDATE t_cvdrisk 
	SET type_dx = if(t_mix_dx ='I' ,'01'  
							,if(t_mix_dx ='E' ,'02'
							,if(t_mix_dx ='E,I','03',NULL)));
/*up sex cvd*/
UPDATE t_cvdrisk SET SEX_CVD = IF(SEX=2,0,1);
/*up DM*/
UPDATE  t_cvdrisk SET DM=IF(type_dx in(2,3),1,0);
/*dele QUARTER BEFORE date_dx*/
DELETE FROM t_cvdrisk 
WHERE DATE_FORMAT(SUBSTR(date_dx,1,10),'%Y%m') > DATE_FORMAT(concat(@b_year,'0630'),'%Y%m')
AND QUARTERM < 4;

DELETE FROM t_cvdrisk 
WHERE DATE_FORMAT(SUBSTR(date_dx,1,10),'%Y%m') > DATE_FORMAT(concat(@b_year,'0331'),'%Y%m')
AND QUARTERM < 3;

DELETE FROM t_cvdrisk 
WHERE DATE_FORMAT(SUBSTR(date_dx,1,10),'%Y%m') > DATE_FORMAT(concat((@b_year-1),'1231'),'%Y%m')
AND QUARTERM < 2;

DELETE FROM t_cvdrisk 
WHERE DATE_FORMAT(SUBSTR(date_dx,1,10),'%Y%m') > DATE_FORMAT(concat((@b_year-1),'0930'),'%Y%m')
AND QUARTERM < 1;

/*last date sbp*/
SET @x=0;
SET @max= 5;
WHILE @x<@max DO
UPDATE  t_cvdrisk c INNER JOIN 
(SELECT cid,MAX(DATE_SERV) date_serv 
FROM tmp_fu_screen  WHERE SBP BETWEEN 50 AND 300 AND QUARTERM in(@x) GROUP BY CID)  f ON c.cid=f.cid 
SET c.SBP_DATE=f.DATE_SERV WHERE c.QUARTERM in(@x);
SET  @x = @x + 1; 
END WHILE;
/*up last sbp*/
UPDATE  t_cvdrisk c INNER JOIN tmp_fu_screen f ON c.cid=f.cid AND c.SBP_DATE=f.DATE_SERV  
SET c.SBP=f.SBP ,c.SBP_SOURCE=f.SBP_SOURCE,c.SBP_HOSPCODE=f.HOSPCODE
WHERE f.SBP BETWEEN 50 AND 300 ;
/*last date height*/
SET @x=0;
SET @max= 5;
WHILE @x<@max DO
UPDATE  t_cvdrisk c INNER JOIN 
(SELECT cid,MAX(DATE_SERV) date_serv 
FROM tmp_fu_screen  WHERE HEIGHT BETWEEN 90 AND 300 AND QUARTERM in(@x) GROUP BY CID)  f ON c.cid=f.cid 
SET c.HEIGHT_DATE=f.DATE_SERV WHERE c.QUARTERM in(@x);
SET  @x = @x + 1; 
END WHILE;
/*up last height*/
UPDATE  t_cvdrisk c INNER JOIN tmp_fu_screen f ON c.cid=f.cid AND c.HEIGHT_DATE=f.DATE_SERV  
SET c.HEIGHT=f.HEIGHT ,c.HEIGHT_SOURCE=f.HEIGHT_SOURCE,c.HEIGHT_HOSPCODE=f.HOSPCODE
WHERE f.HEIGHT BETWEEN 90 AND 300 ;
/*last date waist*/
SET @x=0;
SET @max= 5;
WHILE @x<@max DO
UPDATE  t_cvdrisk c INNER JOIN 
(SELECT cid,MAX(DATE_SERV) date_serv 
FROM tmp_fu_screen  WHERE WAIST_CM  BETWEEN 40 AND 300 AND QUARTERM in(@x) GROUP BY CID)  f ON c.cid=f.cid 
SET c.WAIST_DATE=f.DATE_SERV WHERE c.QUARTERM in(@x);
SET  @x = @x + 1; 
END WHILE;
/*up last waist*/
UPDATE  t_cvdrisk c INNER JOIN tmp_fu_screen f ON c.cid=f.cid AND c.WAIST_DATE=f.DATE_SERV  
SET c.WAIST_CM=f.WAIST_CM ,c.WAIST_SOURCE=f.WAIST_SOURCE,c.WAIST_HOSPCODE=f.HOSPCODE
WHERE f.WAIST_CM  BETWEEN 40 AND 300 ;

/*last date CHOL*/
SET @x=0;
SET @max= 5;
WHILE @x<@max DO
UPDATE  t_cvdrisk c INNER JOIN 
(SELECT cid,MAX(DATE_SERV) date_serv 
FROM tmz_labcvd  WHERE  QUARTERM in(@x) GROUP BY CID)  f ON c.cid=f.cid 
SET c.CHOL_DATE=f.DATE_SERV WHERE c.QUARTERM in(@x);
SET  @x = @x + 1; 
END WHILE;
/*up last CHOL*/
UPDATE  t_cvdrisk c INNER JOIN tmz_labcvd f ON c.cid=f.cid AND c.CHOL_DATE=f.DATE_SERV  
SET c.CHOL=f.labresult ,c.CHOL_HOSPCODE=f.HOSPCODE;

/*SMOKE*/
UPDATE t_cvdrisk c INNER JOIN (
SELECT cid,RESULT,SMOKE_SOURCE ,HOSPCODE,DATE_SERV
FROM tmp_smoke WHERE DATE_SERV BETWEEN @start_d AND @end_d AND RESULT IN(1)
GROUP BY cid
) f ON c.cid=f.cid
SET c.SMOKE_DATE=f.DATE_SERV,c.SMOKING=f.RESULT ,c.SMOKE_SOURCE=f.SMOKE_SOURCE,c.SMOKE_HOSPCODE=f.HOSPCODE;

UPDATE t_cvdrisk c INNER JOIN (
SELECT cid,RESULT,SMOKE_SOURCE ,HOSPCODE,DATE_SERV
FROM tmp_smoke WHERE DATE_SERV BETWEEN @start_d AND @end_d AND RESULT IN(0)
GROUP BY cid
) f ON c.cid=f.cid
SET c.SMOKE_DATE=f.DATE_SERV,c.SMOKING=f.RESULT ,c.SMOKE_SOURCE=f.SMOKE_SOURCE,c.SMOKE_HOSPCODE=f.HOSPCODE
WHERE ISNULL(c.SMOKING);

/*calc*/
UPDATE t_cvdrisk SET RISK_SCORE=cvd_func(AGE_Y,SEX_CVD,SBP,DM,SMOKING,CHOL,WAIST_CM,HEIGHT)
WHERE AGE_Y >0 AND SEX_CVD is not null  AND DM is not null  AND SMOKING is not null  AND SBP >0 
AND (CHOL >0 OR (WAIST_CM >0 AND HEIGHT >0)) ;

DROP TABLE IF EXISTS t_cvdrisk_fl;
CREATE TABLE IF NOT EXISTS t_cvdrisk_fl(
 `CID` varchar(13) DEFAULT NULL
 ,`BIRTH` date
 ,`SEX` varchar(1) NOT NULL
 ,`TYPEAREA` varchar(1) NOT NULL
 ,`nation` varchar(3) DEFAULT NULL
 ,source_tb VARCHAR(255) DEFAULT NULL 
 ,mix_dx VARCHAR(255) DEFAULT NULL 	
 ,t_mix_dx VARCHAR(255) DEFAULT NULL 	
 ,type_dx VARCHAR(2) DEFAULT NULL 
 ,date_dx VARCHAR(255) DEFAULT NULL 
 ,hosp_dx varchar(255) DEFAULT NULL 
	,`AGE_Y` int(3) NOT NULL DEFAULT '0' 
	,`SEX_CVD` varchar(1) DEFAULT NULL
,`DM` varchar(1) DEFAULT NULL
 ,`F_SMOKING` varchar(1) DEFAULT NULL
 ,`F_SMOKE_DATE` date DEFAULT NULL
 ,`F_SMOKE_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`F_SMOKE_SOURCE` VARCHAR(20) DEFAULT NULL
 ,`L_SMOKING` varchar(1) DEFAULT NULL
 ,`L_SMOKE_DATE` date DEFAULT NULL
 ,`L_SMOKE_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`L_SMOKE_SOURCE` VARCHAR(20) DEFAULT NULL
 ,`F_SBP` int(3) NOT NULL DEFAULT  0
 ,`F_SBP_DATE` date DEFAULT NULL
 ,`F_SBP_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`F_SBP_SOURCE` VARCHAR(20) DEFAULT NULL
 ,`L_SBP` int(3) NOT NULL DEFAULT  0
 ,`L_SBP_DATE` date DEFAULT NULL
 ,`L_SBP_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`L_SBP_SOURCE` VARCHAR(20) DEFAULT NULL
 ,`F_CHOL` double(6,2) NOT NULL DEFAULT 0
 ,`F_CHOL_DATE` date DEFAULT NULL
 ,`F_CHOL_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`L_CHOL` double(6,2) NOT NULL DEFAULT 0
 ,`L_CHOL_DATE` date DEFAULT NULL
 ,`L_CHOL_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`F_WAIST_CM` int(3) NOT NULL DEFAULT 0
 ,`F_WAIST_DATE` date DEFAULT NULL
 ,`F_WAIST_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`F_WAIST_SOURCE` VARCHAR(20) DEFAULT NULL
,`L_WAIST_CM` int(3) NOT NULL DEFAULT 0
 ,`L_WAIST_DATE` date DEFAULT NULL
 ,`L_WAIST_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`L_WAIST_SOURCE` VARCHAR(20) DEFAULT NULL
 ,`F_HEIGHT` int(3) NOT NULL DEFAULT 0
 ,`F_HEIGHT_DATE` date DEFAULT NULL
 ,`F_HEIGHT_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`F_HEIGHT_SOURCE` VARCHAR(20) DEFAULT NULL
 ,`L_HEIGHT` int(3) NOT NULL DEFAULT 0
 ,`L_HEIGHT_DATE` date DEFAULT NULL
 ,`L_HEIGHT_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`L_HEIGHT_SOURCE` VARCHAR(20) DEFAULT NULL
 ,`F_RISK_SCORE` DECIMAL(5,2) NOT NULL DEFAULT 0.00
 ,`L_RISK_SCORE` DECIMAL(5,2) NOT NULL DEFAULT 0.00
,PRIMARY KEY (`CID`)
	,KEY  (`CID`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;
INSERT IGNORE INTO t_cvdrisk_fl (cid,birth,sex,typearea,age_y,nation,source_tb,hosp_dx,mix_dx,t_mix_dx,date_dx,dm,sex_cvd,type_dx)
(
SELECT cid,birth,sex,typearea,age_y,nation,source_tb,hosp_dx,mix_dx,t_mix_dx,date_dx,dm,sex_cvd,type_dx
FROM t_cvdrisk 
);

UPDATE  t_cvdrisk_fl c INNER JOIN 
(SELECT cid,MIN(SMOKE_DATE) date_serv 
FROM t_cvdrisk  WHERE SMOKE_DATE BETWEEN @start_d AND @end_d
 GROUP BY CID)  f ON c.cid=f.cid 
SET c.F_SMOKE_DATE=f.DATE_SERV;
UPDATE  t_cvdrisk_fl c INNER JOIN t_cvdrisk f ON c.cid=f.cid AND c.F_SMOKE_DATE=f.SMOKE_DATE  
SET c.F_SMOKING=f.SMOKING ,c.F_SMOKE_SOURCE=f.SMOKE_SOURCE,c.F_SMOKE_HOSPCODE=f.SMOKE_HOSPCODE;

UPDATE  t_cvdrisk_fl c INNER JOIN 
(SELECT cid,MAX(SMOKE_DATE) date_serv 
FROM t_cvdrisk  WHERE SMOKE_DATE BETWEEN @start_d AND @end_d
GROUP BY CID)  f ON c.cid=f.cid 
SET c.L_SMOKE_DATE=f.DATE_SERV;
UPDATE  t_cvdrisk_fl c INNER JOIN t_cvdrisk f ON c.cid=f.cid AND c.L_SMOKE_DATE=f.SMOKE_DATE  
SET c.L_SMOKING=f.SMOKING ,c.L_SMOKE_SOURCE=f.SMOKE_SOURCE,c.L_SMOKE_HOSPCODE=f.SMOKE_HOSPCODE;

UPDATE  t_cvdrisk_fl c INNER JOIN 
(SELECT cid,MIN(SBP_DATE) date_serv 
FROM t_cvdrisk  WHERE SBP_DATE  BETWEEN @start_d AND @end_d12
GROUP BY CID)  f ON c.cid=f.cid 
SET c.F_SBP_DATE=f.DATE_SERV;
UPDATE  t_cvdrisk_fl c INNER JOIN t_cvdrisk f ON c.cid=f.cid AND c.F_SBP_DATE=f.SBP_DATE  
SET c.F_SBP=f.SBP ,c.F_SBP_SOURCE=f.SBP_SOURCE,c.F_SBP_HOSPCODE=f.SBP_HOSPCODE;

UPDATE  t_cvdrisk_fl c INNER JOIN 
(SELECT cid,MAX(SBP_DATE) date_serv 
FROM t_cvdrisk  WHERE  SBP_DATE BETWEEN @start_d10 AND @end_d
GROUP BY CID)  f ON c.cid=f.cid 
SET c.L_SBP_DATE=f.DATE_SERV;
UPDATE  t_cvdrisk_fl c INNER JOIN t_cvdrisk f ON c.cid=f.cid AND c.L_SBP_DATE=f.SBP_DATE  
SET c.L_SBP=f.SBP ,c.L_SBP_SOURCE=f.SBP_SOURCE,c.L_SBP_HOSPCODE=f.SBP_HOSPCODE;

UPDATE  t_cvdrisk_fl c INNER JOIN 
(SELECT cid,MIN(CHOL_DATE) date_serv 
FROM t_cvdrisk  WHERE CHOL_DATE BETWEEN @start_d AND @end_d12
GROUP BY CID)  f ON c.cid=f.cid 
SET c.F_CHOL_DATE=f.DATE_SERV;
UPDATE  t_cvdrisk_fl c INNER JOIN t_cvdrisk f ON c.cid=f.cid AND c.F_CHOL_DATE=f.CHOL_DATE  
SET c.F_CHOL=f.CHOL ,c.F_CHOL_HOSPCODE=f.CHOL_HOSPCODE;

UPDATE  t_cvdrisk_fl c INNER JOIN 
(SELECT cid,MAX(CHOL_DATE) date_serv 
FROM t_cvdrisk  WHERE  CHOL_DATE BETWEEN @start_d10 AND @end_d
GROUP BY CID)  f ON c.cid=f.cid 
SET c.L_CHOL_DATE=f.DATE_SERV;
UPDATE  t_cvdrisk_fl c INNER JOIN t_cvdrisk f ON c.cid=f.cid AND c.L_CHOL_DATE=f.CHOL_DATE  
SET c.L_CHOL=f.CHOL ,c.L_CHOL_HOSPCODE=f.CHOL_HOSPCODE;

UPDATE  t_cvdrisk_fl c INNER JOIN 
(SELECT cid,MIN(WAIST_DATE) date_serv 
FROM t_cvdrisk  WHERE WAIST_DATE BETWEEN @start_d AND @end_d12
GROUP BY CID)  f ON c.cid=f.cid 
SET c.F_WAIST_DATE=f.DATE_SERV;
UPDATE  t_cvdrisk_fl c INNER JOIN t_cvdrisk f ON c.cid=f.cid AND c.F_WAIST_DATE=f.WAIST_DATE  
SET c.F_WAIST_CM=f.WAIST_CM ,c.F_WAIST_SOURCE=f.WAIST_SOURCE,c.F_WAIST_HOSPCODE=f.WAIST_HOSPCODE;

UPDATE  t_cvdrisk_fl c INNER JOIN 
(SELECT cid,MAX(WAIST_DATE) date_serv 
FROM t_cvdrisk  WHERE WAIST_DATE BETWEEN @start_d10 AND @end_d 
GROUP BY CID)  f ON c.cid=f.cid 
SET c.L_WAIST_DATE=f.DATE_SERV;
UPDATE  t_cvdrisk_fl c INNER JOIN t_cvdrisk f ON c.cid=f.cid AND c.L_WAIST_DATE=f.WAIST_DATE  
SET c.L_WAIST_CM=f.WAIST_CM ,c.L_WAIST_SOURCE=f.WAIST_SOURCE,c.L_WAIST_HOSPCODE=f.WAIST_HOSPCODE;

UPDATE  t_cvdrisk_fl c INNER JOIN 
(SELECT cid,MIN(HEIGHT_DATE) date_serv 
FROM t_cvdrisk  WHERE HEIGHT_DATE BETWEEN @start_d AND @end_d12
GROUP BY CID)  f ON c.cid=f.cid 
SET c.F_HEIGHT_DATE=f.DATE_SERV;
UPDATE  t_cvdrisk_fl c INNER JOIN t_cvdrisk f ON c.cid=f.cid AND c.F_HEIGHT_DATE=f.HEIGHT_DATE  
SET c.F_HEIGHT=f.HEIGHT ,c.F_HEIGHT_SOURCE=f.HEIGHT_SOURCE,c.F_HEIGHT_HOSPCODE=f.HEIGHT_HOSPCODE;

UPDATE  t_cvdrisk_fl c INNER JOIN 
(SELECT cid,MAX(HEIGHT_DATE) date_serv 
FROM t_cvdrisk  WHERE HEIGHT_DATE BETWEEN @start_d AND @end_d
GROUP BY CID)  f ON c.cid=f.cid 
SET c.L_HEIGHT_DATE=f.DATE_SERV;
UPDATE  t_cvdrisk_fl c INNER JOIN t_cvdrisk f ON c.cid=f.cid AND c.L_HEIGHT_DATE=f.HEIGHT_DATE  
SET c.L_HEIGHT=f.HEIGHT ,c.L_HEIGHT_SOURCE=f.HEIGHT_SOURCE,c.L_HEIGHT_HOSPCODE=f.HEIGHT_HOSPCODE;

UPDATE t_cvdrisk_fl SET F_RISK_SCORE=cvd_func(AGE_Y,SEX_CVD,F_SBP,DM,F_SMOKING,F_CHOL,F_WAIST_CM,F_HEIGHT)
WHERE AGE_Y >0 AND SEX_CVD is not null  AND DM is not null  AND F_SMOKING is not null  AND F_SBP >0 
AND (F_CHOL >0 OR (F_WAIST_CM >0 AND F_HEIGHT >0)) ;

UPDATE t_cvdrisk_fl SET L_RISK_SCORE=cvd_func(AGE_Y,SEX_CVD,L_SBP,DM,L_SMOKING,L_CHOL,L_WAIST_CM,L_HEIGHT) 
WHERE AGE_Y >0 AND SEX_CVD is not null  AND DM is not null  AND L_SMOKING is not null  AND L_SBP >0 
AND (L_CHOL >0 OR (L_WAIST_CM >0 AND L_HEIGHT >0)) ;

 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.3918569;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:378;a:5:{i:0;s:38:"DROP PROCEDURE IF EXISTS t_screen_last";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.454257;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:381;a:5:{i:0;s:1902:"CREATE PROCEDURE t_screen_last()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '59';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS t_screen_last;
CREATE TABLE IF NOT EXISTS t_screen_last(
 `HOSPCODE` varchar(5) NOT NULL,
 `CID` varchar(13) DEFAULT NULL,
 `PID` varchar(15) NOT NULL,
	`SEQ` varchar(16) NOT NULL,
 `DATE_SERV` date NOT NULL,
 `WAIST_CM` int(3) NOT NULL DEFAULT 0,
	weight decimal(5,1) NOT NULL DEFAULT '0',
 `HEIGHT` int(3) NOT NULL DEFAULT 0,
  `SMOKE` varchar(1) DEFAULT NULL,
  `ALCOHOL` varchar(1) DEFAULT NULL,
 `SBP_1` int(3) NOT NULL,
  `DBP_1` int(3) NOT NULL,
  `SBP_2` int(3) DEFAULT NULL,
  `DBP_2` int(3) DEFAULT NULL,
  `BSLEVEL` int(6) DEFAULT NULL,
  `BSTEST` char(1) DEFAULT NULL,
  `SCREENPLACE` varchar(5) DEFAULT NULL,
 `QUARTERM` VARCHAR(1) DEFAULT NULL,
	bmi decimal(10,1) NOT NULL DEFAULT '0',
PRIMARY KEY (`HOSPCODE`,`PID`,`QUARTERM`),
  KEY  (`HOSPCODE`,`PID`),
  KEY  (`HOSPCODE`),
  KEY  (`DATE_SERV`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;


INSERT IGNORE INTO t_screen_last (
SELECT  
HOSPCODE,CID,PID,SEQ,DATE_SERV,WAIST_CM,WEIGHT,HEIGHT,SMOKE,ALCOHOL,SBP_1,DBP_1,SBP_2,DBP_2,BSLEVEL,BSTEST,SCREENPLACE
,IF( DATE_SERV < concat(@b_year-1,'1001'),0,
IF(DATE_SERV BETWEEN concat(@b_year-1,'1001') AND concat(@b_year-1,'1231'),1,
IF(DATE_SERV BETWEEN concat(@b_year,'0101') AND concat(@b_year,'0331'),2,
IF(DATE_SERV BETWEEN concat(@b_year,'0401') AND concat(@b_year,'0630'),3,
IF(DATE_SERV BETWEEN concat(@b_year,'0701') AND concat(@b_year,'0930'),4,null
))))),0
FROM tmp_ncdscreen
WHERE date_serv BETWEEN @start_d AND @end_d
ORDER BY DATE_SERV DESC
);
UPDATE t_screen_last SET  BMI= IFNULL(round(weight/((height/100)*(height/100)),2),0)
WHERE weight BETWEEN 10 AND 300 AND height BETWEEN 30 AND 250;

 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.5166571;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:384;a:5:{i:0;s:30:"DROP PROCEDURE IF EXISTS t_adl";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.5790579;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:387;a:5:{i:0;s:9324:"CREATE PROCEDURE t_adl()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '60';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
/*ประวัติการรับบริการตรวจ ADL ประชากรทุกคนไม่เฉพาะในเขต*/
#DROP TABLE IF EXISTS t_adl_last_regist;
CREATE TABLE IF NOT EXISTS t_adl_last_regist(
 `CID` varchar(13) DEFAULT NULL,
 `DATE_SERV` date DEFAULT NULL,
 `PPSPECIAL` VARCHAR(6) DEFAULT NULL,
  `PPSPLACE` VARCHAR(5) DEFAULT NULL,	
PRIMARY KEY (`CID`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

REPLACE INTO t_adl_last_regist 
(SELECT CID,NULL,NULL,NULL
FROM
tmp_specialpp 
WHERE LENGTH(cid)=13 AND PPSPECIAL IN('1B1280','1B1281','1B1282') 
GROUP BY CID
);

UPDATE t_adl_last_regist  t INNER JOIN
(
SELECT s1.hospcode,s1.CID,s1.DATE_SERV,s1.PPSPECIAL,s1.PPSPLACE
FROM tmp_specialpp s1 INNER JOIN tmp_specialpp s2 ON s1.CID=s2.CID AND s2.DATE_SERV >= s1.DATE_SERV
WHERE s1.PPSPECIAL  IN('1B1280','1B1281','1B1282') AND s2.PPSPECIAL  IN('1B1280','1B1281','1B1282')
		AND s1.DATE_SERV BETWEEN @start_d AND @end_d
		AND s2.DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY s1.CID,s1.DATE_SERV
HAVING COUNT(*) = 1
) s ON t.cid = s.cid AND s.date_serv BETWEEN @start_d AND @end_d
SET t.DATE_SERV = s.date_serv , t.PPSPECIAL= s.PPSPECIAL
, t.PPSPLACE=IF(ISNULL(s.PPSPLACE) OR LENGTH(s.PPSPLACE) !=5 ,s.hospcode,s.PPSPLACE);

/*ประวัติการรับบริการตรวจ ADL ประชากรทุกคนเฉพาะในเขตและผลครั้งสุดท้ายของรอบนั้นๆ*/
DROP TABLE IF EXISTS t_adl;
CREATE TABLE IF NOT EXISTS t_adl(
 `HOSPCODE` varchar(5) NOT NULL,
 `CID` varchar(13) DEFAULT NULL,
 `PID` varchar(15) NOT NULL,
 `BIRTH` DATE,
 `AGE_Y` varchar(3) DEFAULT '0',
 `TYPEAREA` varchar(1) DEFAULT NULL,
 `DATE_SERV1` date DEFAULT NULL,
 `PPSPECIAL1` VARCHAR(6) DEFAULT NULL,
  `PP_HOSP1` VARCHAR(5) DEFAULT NULL,	
 `DATE_SERV2` date DEFAULT NULL,
 `PPSPECIAL2` VARCHAR(6) DEFAULT NULL,
  `PP_HOSP2` VARCHAR(5) DEFAULT NULL,	
PRIMARY KEY (`CID`),
  KEY  (`HOSPCODE`,`PID`),
  KEY  (`HOSPCODE`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO t_adl (HOSPCODE,CID,PID,BIRTH,AGE_Y,TYPEAREA)
(
SELECT check_hosp,CID,PID,BIRTH,AGE_Y,check_typearea 
FROM t_person_cid 
WHERE LENGTH(cid)=13  AND check_typearea in(1,3) AND NATION in(99) AND age_y >=60 AND age_y < 200 AND DISCHARGE in(9)
);
/*max date_serv1*/
UPDATE t_adl t INNER JOIN
(SELECT s1.hospcode,s1.CID,s1.DATE_SERV,s1.PPSPECIAL
FROM tmp_specialpp s1 INNER JOIN tmp_specialpp s2 ON s1.CID=s2.CID AND s2.DATE_SERV >= s1.DATE_SERV
WHERE s1.PPSPECIAL  IN('1B1280','1B1281','1B1282') AND s2.PPSPECIAL  IN('1B1280','1B1281','1B1282')
		AND s1.DATE_SERV BETWEEN  CONCAT(@b_year-1,'1001') AND CONCAT(@b_year,'0331') 
		AND s2.DATE_SERV BETWEEN  CONCAT(@b_year-1,'1001') AND CONCAT(@b_year,'0331') 
GROUP BY s1.CID,s1.DATE_SERV
HAVING COUNT(*) = 1
)
s ON t.cid=s.cid SET t.DATE_SERV1=s.date_serv ,t.PPSPECIAL1=s.PPSPECIAL ,t.PP_HOSP1=s.hospcode;

UPDATE t_adl t INNER JOIN
(SELECT s1.hospcode,s1.CID,s1.DATE_SERV,s1.PPSPECIAL
FROM tmp_specialpp s1 INNER JOIN tmp_specialpp s2 ON s1.CID=s2.CID AND s2.DATE_SERV >= s1.DATE_SERV
WHERE s1.PPSPECIAL  IN('1B1280','1B1281','1B1282') AND s2.PPSPECIAL  IN('1B1280','1B1281','1B1282')
		AND s1.DATE_SERV BETWEEN   CONCAT(@b_year,'0401') AND CONCAT(@b_year,'0930') 
		AND s2.DATE_SERV BETWEEN   CONCAT(@b_year,'0401') AND CONCAT(@b_year,'0930')  
GROUP BY s1.CID,s1.DATE_SERV
HAVING COUNT(*) = 1
)
s ON t.cid=s.cid SET t.DATE_SERV2=s.date_serv ,t.PPSPECIAL2=s.PPSPECIAL ,t.PP_HOSP2=s.hospcode;

DROP  TABLE IF EXISTS t_aged;
CREATE  TABLE IF NOT EXISTS t_aged(
  `HOSPCODE` varchar(5) NOT NULL,
  `PID` varchar(15) NOT NULL,
  `CID` varchar(13) NOT NULL,
  `SEX` varchar(1) NOT NULL ,
  `BIRTH` date  DEFAULT NULL,
	`NATION` varchar(3)  DEFAULT NULL,
	`DISCHARGE` varchar(1) DEFAULT NULL,
	`TYPEAREA` varchar(1)  DEFAULT NULL,
	`AGE_Y` int(3) DEFAULT NULL,
	`VHID` varchar(8) DEFAULT NULL,
	 ht_date DATE,
	 ht_risk int(1) DEFAULT NULL,
	 dm_date DATE DEFAULT NULL,
	 dm_risk int(1) DEFAULT NULL,
	 cvd_score decimal(5,2) NOT NULL DEFAULT '0.00',
	 dent_date DATE DEFAULT NULL,
	 dent_code varchar(6) DEFAULT NULL,
	 amt_date DATE DEFAULT NULL,
	 amt_code varchar(6) DEFAULT NULL,
	 2q_date DATE DEFAULT NULL,
	 2q_code varchar(6) DEFAULT NULL,
	 knee_date DATE DEFAULT NULL,
	 knee_code varchar(6) DEFAULT NULL,
	 fall_date DATE DEFAULT NULL,
	 fall_code varchar(6) DEFAULT NULL,
	 adl_date DATE DEFAULT NULL,
	 adl_code varchar(6) DEFAULT NULL,
	 bmi_date DATE DEFAULT NULL,
	 bmi decimal(5,2) NOT NULL DEFAULT '0.00',
		PRIMARY KEY (cid),
		KEY (cid),
		KEY (hospcode,pid)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;
INSERT IGNORE INTO t_aged (hospcode,pid,cid,sex,birth,nation,discharge,typearea,age_y,vhid)
SELECT
check_hosp,pid,cid , sex,birth ,nation,discharge, check_typearea,age_y ,check_vhid
FROM t_person_cid p  
WHERE  p.check_typearea in(1,3) AND p.NATION in(99) AND p.DISCHARGE in(9) AND LENGTH(TRIM(p.CID)) = 13
AND p.age_y >= 60 AND p.age_y < 200;
/**ht**/
UPDATE t_aged t INNER JOIN t_person_ht_screen s ON t.cid = s.cid AND s.date_screen BETWEEN @start_d AND @end_d
SET t.ht_date = s.date_screen , t.ht_risk= s.risk;
/**dm**/
UPDATE t_aged t INNER JOIN t_person_dm_screen s ON t.cid = s.cid AND s.date_screen BETWEEN @start_d AND @end_d
SET t.dm_date = s.date_screen , t.dm_risk= s.risk;
/**cvd**/
UPDATE t_aged t INNER JOIN t_cvdrisk_fl s ON t.cid = s.cid 
SET  t.cvd_score= s.L_RISK_SCORE;
/**dental**/
UPDATE t_aged t INNER JOIN 
(
SELECT
s1.CID,s1.DATE_SERV,s1.PPSPECIAL
FROM
tmp_specialpp s1 INNER JOIN tmp_specialpp s2 ON s1.CID=s2.CID AND s2.DATE_SERV >= s1.DATE_SERV
WHERE s1.PPSPECIAL  IN('1B1260','1B1261','1B1269') AND s2.PPSPECIAL  IN('1B1260','1B1261','1B1269')
AND s1.DATE_SERV BETWEEN @start_d AND @end_d
AND s2.DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY s1.CID,s1.DATE_SERV
HAVING COUNT(*) = 1
)
s ON t.cid = s.cid AND s.date_serv BETWEEN @start_d AND @end_d
SET t.dent_date = s.date_serv , t.dent_code= s.PPSPECIAL;
/**amt**/
UPDATE t_aged t INNER JOIN 
(
SELECT
s1.CID,s1.DATE_SERV,s1.PPSPECIAL
FROM
tmp_specialpp s1 INNER JOIN tmp_specialpp s2 ON s1.CID=s2.CID AND s2.DATE_SERV >= s1.DATE_SERV
WHERE s1.PPSPECIAL  IN('1B1220','1B1221','1B1223','1B1229') AND s2.PPSPECIAL  IN('1B1220','1B1221','1B1223','1B1229')
AND s1.DATE_SERV BETWEEN @start_d AND @end_d
AND s2.DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY s1.CID,s1.DATE_SERV
HAVING COUNT(*) = 1
)
s ON t.cid = s.cid AND s.date_serv BETWEEN @start_d AND @end_d
SET t.amt_date = s.date_serv , t.amt_code= s.PPSPECIAL;
/**2q**/
UPDATE t_aged t INNER JOIN 
(
SELECT s1.CID,s1.DATE_SERV,s1.PPSPECIAL
FROM tmp_specialpp s1 INNER JOIN tmp_specialpp s2 ON s1.CID=s2.CID AND s2.DATE_SERV >= s1.DATE_SERV
WHERE s1.PPSPECIAL  IN('1B0280','1B0281') AND s2.PPSPECIAL  IN('1B0280','1B0281')
		AND s1.DATE_SERV BETWEEN @start_d AND @end_d
		AND s2.DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY s1.CID,s1.DATE_SERV
HAVING COUNT(*) = 1
) s ON t.cid = s.cid AND s.date_serv BETWEEN @start_d AND @end_d
SET t.2q_date = s.date_serv , t.2q_code= s.PPSPECIAL;
/**knee**/
UPDATE t_aged t INNER JOIN 
(
SELECT s1.CID,s1.DATE_SERV,s1.PPSPECIAL
FROM tmp_specialpp s1 INNER JOIN tmp_specialpp s2 ON s1.CID=s2.CID AND s2.DATE_SERV >= s1.DATE_SERV
WHERE s1.PPSPECIAL  IN('1B1270','1B1271','1B1272','1B1279') AND s2.PPSPECIAL  IN('1B1270','1B1271','1B1272','1B1279')
		AND s1.DATE_SERV BETWEEN @start_d AND @end_d
		AND s2.DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY s1.CID,s1.DATE_SERV
HAVING COUNT(*) = 1
) s ON t.cid = s.cid AND s.date_serv BETWEEN @start_d AND @end_d
SET t.knee_date = s.date_serv , t.knee_code= s.PPSPECIAL;
/**fall**/
UPDATE t_aged t INNER JOIN 
(
SELECT s1.CID,s1.DATE_SERV,s1.PPSPECIAL
FROM tmp_specialpp s1 INNER JOIN tmp_specialpp s2 ON s1.CID=s2.CID AND s2.DATE_SERV >= s1.DATE_SERV
WHERE s1.PPSPECIAL  IN('1B1200','1B1201','1B1202','1B1209') AND s2.PPSPECIAL  IN('1B1200','1B1201','1B1202','1B1209')
		AND s1.DATE_SERV BETWEEN @start_d AND @end_d
		AND s2.DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY s1.CID,s1.DATE_SERV
HAVING COUNT(*) = 1
) s ON t.cid = s.cid AND s.date_serv BETWEEN @start_d AND @end_d
SET t.fall_date = s.date_serv , t.fall_code= s.PPSPECIAL;
/**adl**/
UPDATE t_aged t INNER JOIN 
(
SELECT s1.CID,s1.DATE_SERV,s1.PPSPECIAL
FROM tmp_specialpp s1 INNER JOIN tmp_specialpp s2 ON s1.CID=s2.CID AND s2.DATE_SERV >= s1.DATE_SERV
WHERE s1.PPSPECIAL  IN('1B1280','1B1281','1B1282') AND s2.PPSPECIAL  IN('1B1280','1B1281','1B1282')
		AND s1.DATE_SERV BETWEEN @start_d AND @end_d
		AND s2.DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY s1.CID,s1.DATE_SERV
HAVING COUNT(*) = 1
) s ON t.cid = s.cid AND s.date_serv BETWEEN @start_d AND @end_d
SET t.adl_date = s.date_serv , t.adl_code= s.PPSPECIAL;
/**bmi**/
UPDATE  t_aged t INNER JOIN  ws_person_nutrition n ON t.cid=n.cid  AND n.date_serv BETWEEN @start_d AND @end_d
SET  t.bmi_date = n.date_serv , t.bmi= n.bmi;

 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.641458;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:390;a:5:{i:0;s:36:"DROP PROCEDURE IF EXISTS t_postnatal";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.7194581;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:393;a:5:{i:0;s:2793:"CREATE PROCEDURE t_postnatal()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '61';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS t_postnatal;
CREATE TABLE IF NOT EXISTS t_postnatal(
`HOSPCODE` varchar(5) NOT NULL,
  `PID` varchar(15) NOT NULL,
  `GRAVIDA` varchar(2) NOT NULL,
  `BDATE` date NOT NULL,
  `cid` varchar(13) DEFAULT NULL,
  `nation` varchar(3) DEFAULT '',
  `occupat` varchar(4) DEFAULT NULL,
  `birth` date DEFAULT NULL,
  `vhid` varchar(8) DEFAULT NULL,
  `ppcare1` date DEFAULT NULL,
  `ppcare1_hosp` varchar(5) DEFAULT NULL,
	`ppcare1_input_hosp` varchar(5) DEFAULT NULL,
  `ppcare2` date DEFAULT NULL,
  `ppcare2_hosp` varchar(5) DEFAULT NULL,
	`ppcare2_input_hosp` varchar(5) DEFAULT NULL,
  `ppcare3` date DEFAULT NULL,
  `ppcare3_hosp` varchar(5) DEFAULT NULL,
	`ppcare3_input_hosp` varchar(5) DEFAULT NULL,
  PRIMARY KEY (`CID`,bdate),
  KEY  (`cid`),
	KEY `HOSPCODE` (`HOSPCODE`,`PID`),
  KEY `BDATE` (`BDATE`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO t_postnatal (HOSPCODE,PID,GRAVIDA,BDATE,cid,nation,occupat,birth,vhid)
(SELECT 
HOSPCODE,PID,GRAVIDA,BDATE,cid,nation,occupat,birth,vhid
FROM	tmp_postnatal p
WHERE  p.BDATE BETWEEN @start_d AND @end_d
GROUP BY cid,BDATE
);

UPDATE IGNORE  t_postnatal p INNER JOIN (
SELECT min(PPCARE) PPCARE,BDATE,cid 
FROM tmp_postnatal WHERE TIMESTAMPDIFF(day,bdate,ppcare) <=7
GROUP BY cid,BDATE
) l ON p.cid=l.cid AND p.bdate=l.bdate 
SET p.ppcare1=l.ppcare;

UPDATE IGNORE  t_postnatal p INNER JOIN (
SELECT PPCARE,PPPLACE,BDATE,HOSPCODE,cid FROM tmp_postnatal 
) l ON p.cid=l.cid AND p.bdate=l.bdate AND  p.ppcare1=l.ppcare
SET p.ppcare1_hosp=l.PPPLACE , p.ppcare1_input_hosp=l.HOSPCODE;

UPDATE IGNORE  t_postnatal p INNER JOIN (
SELECT min(PPCARE) PPCARE,BDATE,cid 
FROM tmp_postnatal WHERE TIMESTAMPDIFF(day,bdate,ppcare) BETWEEN 8 AND 15
GROUP BY cid,BDATE
) l ON p.cid=l.cid AND p.bdate=l.bdate 
SET p.ppcare2=l.ppcare;

UPDATE IGNORE  t_postnatal p INNER JOIN (
SELECT PPCARE,PPPLACE,BDATE,HOSPCODE,cid FROM tmp_postnatal 
) l ON p.cid=l.cid AND p.bdate=l.bdate AND  p.ppcare2=l.ppcare
SET p.ppcare2_hosp=l.PPPLACE , p.ppcare2_input_hosp=l.HOSPCODE;

UPDATE IGNORE  t_postnatal p INNER JOIN (
SELECT min(PPCARE) PPCARE,BDATE,cid 
FROM tmp_postnatal WHERE TIMESTAMPDIFF(day,bdate,ppcare) BETWEEN 16 AND 42
GROUP BY cid,BDATE
) l ON p.cid=l.cid AND p.bdate=l.bdate 
SET p.ppcare3=l.ppcare;

UPDATE IGNORE  t_postnatal p INNER JOIN (
SELECT PPCARE,PPPLACE,BDATE,HOSPCODE,cid FROM tmp_postnatal 
) l ON p.cid=l.cid AND p.bdate=l.bdate AND  p.ppcare3=l.ppcare
SET p.ppcare3_hosp=l.PPPLACE , p.ppcare3_input_hosp=l.HOSPCODE;
 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.781858;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:396;a:5:{i:0;s:36:"DROP PROCEDURE IF EXISTS t_cigarette";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.8286581;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:399;a:5:{i:0;s:909:"CREATE PROCEDURE t_cigarette()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '62';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'0701');
SET @end_d:=concat(@b_year,'0930');


DROP TABLE IF EXISTS t_cigarette;
CREATE TABLE IF NOT EXISTS t_cigarette(
 `CID` varchar(13) NOT NULL,
 `HOSPCODE` varchar(5) NOT NULL,
 `PID` varchar(15) NOT NULL,
 `DATE_SERV` date NOT NULL,
 `SOURCE` varchar(30) NOT NULL,
PRIMARY KEY (cid)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO t_cigarette (
SELECT CID,HOSPCODE,PID,DATE_SERV,'SPECIALPP'
FROM tmp_specialpp 
WHERE DATE_SERV BETWEEN @start_d AND @end_d
AND SUBSTR(PPSPECIAL,1,4) IN('1B50','1B53','1B54','1B55','1B56')
);

INSERT IGNORE INTO t_cigarette (
SELECT CID,HOSPCODE,PID,DATE_SERV,'NCDSCREEN'
FROM tmp_ncdscreen 
WHERE DATE_SERV BETWEEN @start_d AND @end_d
AND smoke in(2,3,4)
);
 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.891058;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:402;a:5:{i:0;s:40:"DROP PROCEDURE IF EXISTS t_breast_screen";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.9378581;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:405;a:5:{i:0;s:2217:"CREATE PROCEDURE t_breast_screen()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '63';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');


DROP TABLE IF EXISTS tmp_breast_screen;
CREATE TABLE IF NOT EXISTS tmp_breast_screen(
PRIMARY KEY (HOSPCODE,PID,DATE_SERV,PPSPECIAL) 
,KEY (cid)
,KEY (hospcode,pid)
,KEY (date_serv)
,KEY (ppspecial)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 AS (
SELECT 
*
FROM tmp_specialpp s 
WHERE s.DATE_SERV BETWEEN @start_d AND @end_d AND SUBSTR(s.ppspecial,1,5) IN('1B003')
);

DROP TABLE IF EXISTS tmp_breast_screen_doctor;
CREATE TABLE IF NOT EXISTS tmp_breast_screen_doctor(
PRIMARY KEY (HOSPCODE,PID,DATE_SERV,DIAGCODE) 
,KEY (cid)
,KEY (hospcode,pid)
,KEY (date_serv)
,KEY (DIAGCODE)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 AS (
SELECT hospcode,pid,seq,date_serv,diagcode,cid 
FROM tmp_diag_opd 
WHERE date_serv BETWEEN @start_d AND @end_d AND SUBSTR(DIAGCODE,1,4) IN('Z123')
GROUP BY HOSPCODE,PID,DATE_SERV,DIAGCODE
);

DROP TABLE IF EXISTS t_breast_screen;
CREATE TABLE IF NOT EXISTS t_breast_screen(
CID varchar(13) NOT NULL,
self_screen varchar(6) DEFAULT NULL,
self_screen_date date DEFAULT NULL,
self_screen_hospcode varchar(5) DEFAULT NULL,
self_screen_input varchar(5) DEFAULT NULL,
doctor_screen varchar(7) DEFAULT NULL,
doctor_screen_date date DEFAULT NULL,
doctor_screen_hospcode varchar(5) DEFAULT NULL,
PRIMARY KEY (CID) 
) ENGINE=MyISAM DEFAULT CHARSET=utf8 ;

INSERT IGNORE INTO t_breast_screen (cid)
(SELECT cid FROM tmp_breast_screen GROUP BY cid);

INSERT IGNORE INTO t_breast_screen (cid)
(SELECT cid FROM tmp_breast_screen_doctor GROUP BY cid);

UPDATE IGNORE t_breast_screen t INNER JOIN (SELECT * FROM tmp_breast_screen ORDER BY DATE_SERV DESC) s ON  t.cid=s.cid
SET t.self_screen=s.PPSPECIAL ,t.self_screen_date =s.date_serv , t.self_screen_hospcode=s.PPSPLACE,t.self_screen_input=s.hospcode;

UPDATE IGNORE t_breast_screen t INNER JOIN (SELECT * FROM tmp_breast_screen_doctor ORDER BY DATE_SERV DESC) s ON  t.cid=s.cid
SET t.doctor_screen=s.diagcode ,t.doctor_screen_date =s.date_serv , t.doctor_screen_hospcode=s.hospcode;
 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.000258;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:408;a:5:{i:0;s:40:"DROP PROCEDURE IF EXISTS t_cervix_screen";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.0470581;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:411;a:5:{i:0;s:1658:"CREATE PROCEDURE t_cervix_screen()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '64';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @year_start:=(SELECT `year` FROM ccervix_year WHERE  `year` <= @b_year LIMIT 1);
SET @start_d:=concat(@year_start,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS tmp_cervix_diag5;
CREATE TABLE IF NOT EXISTS tmp_cervix_diag5(
PRIMARY KEY (HOSPCODE,PID,SEQ)
,KEY (cid)
,KEY (date_serv)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 AS
(SELECT o.hospcode,o.pid,o.seq,o.date_serv,o.diagcode,p.cid
FROM diagnosis_opd o  INNER JOIN person p ON o.hospcode=p.hospcode AND o.pid=p.pid
WHERE o.DATE_SERV  BETWEEN @start_d AND @end_d 
AND SUBSTR(o.DIAGCODE,1,4) IN('Z014','Z124')
GROUP BY o.HOSPCODE,o.PID,o.SEQ
);

DROP TABLE IF EXISTS t_cervix_screen;
CREATE TABLE IF NOT EXISTS t_cervix_screen(
CID varchar(13) NOT NULL,
screen_code varchar(7) DEFAULT NULL,
screen_date date DEFAULT NULL,
screen_source varchar(30) DEFAULT NULL,
screen_hospcode varchar(5) DEFAULT NULL,
screen_input varchar(5) DEFAULT NULL,
PRIMARY KEY (CID,screen_date) 
,KEY (cid)
,KEY (screen_date)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 ;

INSERT IGNORE INTO t_cervix_screen (
SELECT cid,PPSPECIAL,DATE_SERV,'SPECIALPP',PPSPLACE,HOSPCODE
FROM tmp_specialpp s 
WHERE s.DATE_SERV BETWEEN @start_d AND @end_d 
AND SUBSTR(s.ppspecial,1,5) IN('1B004') AND LENGTH(cid)=13
GROUP BY CID
);

INSERT IGNORE INTO t_cervix_screen (
SELECT cid,DIAGCODE,DATE_SERV,'DIAGNOSIS_OPD',HOSPCODE,HOSPCODE
FROM tmp_cervix_diag5 s 
WHERE s.DATE_SERV BETWEEN @start_d AND @end_d  AND LENGTH(cid)=13
GROUP BY CID
);
 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.109458;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:414;a:5:{i:0;s:33:"DROP PROCEDURE IF EXISTS t_ttm1_5";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.1562591;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:417;a:5:{i:0;s:12670:"CREATE PROCEDURE t_ttm1_5()
 BEGIN 
SET @provid = '58';
SET@id:= '65';
SET @rep_year = (SELECT yearprocess FROM sys_config LIMIT 1);

/**********ttm1*****************/
DROP TEMPORARY TABLE IF  EXISTS mother_service;
CREATE TEMPORARY TABLE IF NOT EXISTS 
mother_service (INDEX(CID)) 
ENGINE=MYISAM IGNORE AS 
SELECT 
e.HOSPCODE, 
e.PID, 
e.SEQ, 
e.DATE_SERV,
s.INSTYPE,
GROUP_CONCAT(e.PROCEDCODE) PROCEDCODE,
p.BIRTH,
p.CID,
LENGTH(GROUP_CONCAT(e.PROCEDCODE)) length_str
FROM tmp_procedure_opd e 
LEFT JOIN tmp_service s ON e.HOSPCODE = s.HOSPCODE AND e.PID = s.PID AND e.SEQ = s.SEQ 
LEFT JOIN person p ON e.HOSPCODE = p.HOSPCODE AND e.PID = p.PID AND s.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
WHERE e.PROCEDCODE IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND 
e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') AND 
p.SEX = 2 
GROUP BY e.HOSPCODE, e.PID, e.SEQ 
;

DROP TEMPORARY TABLE IF  EXISTS labor_rep;
CREATE TEMPORARY TABLE IF NOT EXISTS 
labor_rep (INDEX(CID)) 
ENGINE=MYISAM IGNORE AS 
SELECT 
p.CID,
l.BDATE
FROM 
tmp_labor l
LEFT JOIN person p ON l.HOSPCODE = p.HOSPCODE AND l.PID = p.PID  
WHERE 
l.BDATE BETWEEN CONCAT((@rep_year-1),'0701') AND CONCAT(@rep_year,'0930') AND 
p.CID IS NOT NULL 
GROUP BY p.CID 
;

DROP TABLE IF  EXISTS t_ttm_opd_1;
CREATE TABLE IF NOT EXISTS t_ttm_opd_1( 
PRIMARY KEY (hospcode,code_rep ),
KEY (hospcode)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT SQL_BIG_RESULT
e.HOSPCODE ,
CONCAT(e.HOSPCODE,'-',e.PID) code_rep,
@rep_year year_rep,
TIMESTAMPDIFF(YEAR,e.BIRTH,e.DATE_SERV) age,
MIN(e.DATE_SERV) begin_date_serv,
COUNT(DISTINCT   l.CID) all_mother,
COUNT(IF(e.length_str=39,1,NULL)) have_service,
COUNT(1) all_service,
COUNT(IF(e.PROCEDCODE LIKE '%9007712%',1,NULL)) ttm_service,
IF(DATEDIFF(MIN(e.DATE_SERV),l.BDATE) BETWEEN 0 AND 45,0,1) not_in_time,
IF(DATEDIFF(MAX(e.DATE_SERV),MIN(e.DATE_SERV)) BETWEEN 0 AND 90,0,1) not_less90days,

COUNT(DISTINCT IF(e.INSTYPE='0100',l.CID,NULL)) all_uc_mother,
COUNT(IF(e.length_str=39 AND e.INSTYPE='0100',1,NULL)) uc_have_service,
COUNT(IF(e.INSTYPE='0100',1,NULL)) uc_all_service,
IF(e.INSTYPE='0100',IF(DATEDIFF(MIN(e.DATE_SERV),l.BDATE) BETWEEN 0 AND 45,0,1),0) uc_not_in_time,
IF(e.INSTYPE='0100',IF(DATEDIFF(MAX(e.DATE_SERV),MIN(e.DATE_SERV)) BETWEEN 0 AND 90,0,1),0) uc_not_less90days 
FROM mother_service e 
LEFT JOIN labor_rep l ON l.CID = e.CID
LEFT JOIN chospital i ON e.HOSPCODE = i.hoscode 
WHERE 
i.provcode=@provid 
GROUP BY e.HOSPCODE, e.PID ;

/**********ttm2*****************/
DROP TABLE IF  EXISTS tmp_planthai_drug_use;
CREATE  TABLE IF NOT EXISTS 
tmp_planthai_drug_use (INDEX(HOSPCODE),INDEX(PID),INDEX(SEQ)) 
ENGINE=MYISAM IGNORE AS 
SELECT
e.HOSPCODE,
e.PID,
e.SEQ,
e.DATE_SERV,
e.DIDSTD,
e.AMOUNT,
e.DRUGPRICE,
e.DRUGCOST,
d.didstd PASS,
d.drug_name,
d.drug_type ,
d.ed
FROM 
tmp_drug_opd e 
LEFT JOIN cdrug_planthai d ON d.didstd=e.DIDSTD 
WHERE
e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIDSTD,2) IN ('41','42') 
;

DROP TABLE IF  EXISTS t_ttm_opd_2;
CREATE TABLE IF NOT EXISTS t_ttm_opd_2( 
PRIMARY KEY (hospcode,code_rep ),
KEY (hospcode)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
e.HOSPCODE ,
IFNULL(e.code_rep,CONCAT(@rep_year,'-07')) code_rep,
IFNULL(
IF(e.code_name=1,'มกราคม',
IF(e.code_name=2,'กุมภาพันธ์',
IF(e.code_name=3,'มีนาคม',
IF(e.code_name=4,'เมษายน',
IF(e.code_name=5,'พฤษภาคม',
IF(e.code_name=6,'มิถุนายน',
IF(e.code_name=7,'กรกฏาคม',
IF(e.code_name=8,'สิงหาคม',
IF(e.code_name=9,'กันยายน',
IF(e.code_name=10,'ตุลาคม',
IF(e.code_name=11,'พฤศจิกายน',
'ธันวาคม')))))))))))
,'กรกฏาคม') code_name,
IFNULL(e.year_rep,@rep_year) year_rep,
IFNULL(e.all_visit,0) all_visit,
IFNULL(e.all_drug,0) all_drug,
IFNULL(e.uc_visit,0) uc_visit,
IFNULL(e.uc_drug,0) uc_drug,
IFNULL(e.all_visit_error,0) all_visit_error,
IFNULL(e.all_drug_error,0) all_drug_error,
IFNULL(e.uc_visit_error,0) uc_visit_error,
IFNULL(e.uc_drug_error,0) uc_drug_error
FROM chospital o 
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE, 
LEFT(DATE(e.DATE_SERV),7) code_rep,
MONTH(e.DATE_SERV) code_name,
@rep_year year_rep, 
COUNT(DISTINCT CONCAT(e.PID,'-',e.SEQ)) as all_visit, 
COUNT(*) as all_drug, 
COUNT(DISTINCT (IF(s.INSTYPE='0100',CONCAT(e.PID,'-',e.SEQ),NULL))) as uc_visit , 
COUNT(IF(s.INSTYPE='0100',1,NULL)) as uc_drug,
COUNT(DISTINCT IF(e.PASS IS NULL,CONCAT(e.PID,'-',e.SEQ),NULL)) as all_visit_error, 
COUNT(IF(e.PASS IS NULL,CONCAT(e.PID,'-',e.SEQ),NULL)) as all_drug_error, 
COUNT(DISTINCT (IF(s.INSTYPE='0100' AND e.PASS IS NULL,CONCAT(e.PID,'-',e.SEQ),NULL))) as uc_visit_error , 
COUNT(IF(s.INSTYPE='0100' AND e.PASS IS NULL,1,NULL)) as uc_drug_error  
FROM 
tmp_planthai_drug_use e
LEFT JOIN tmp_service s ON e.HOSPCODE = s.HOSPCODE AND e.PID = s.PID AND e.SEQ = s.SEQ 
GROUP BY e.HOSPCODE, MONTH(e.DATE_SERV) 
) e ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid  AND e.code_rep IS NOT NULL ;

/***************ttm3****************/
DROP TABLE IF  EXISTS t_ttm_opd_3;
CREATE TABLE IF NOT EXISTS t_ttm_opd_3( 
PRIMARY KEY (hospcode,servplace,age,sex),
KEY (hospcode),
KEY (servplace),
KEY (age),
KEY (sex)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
e.HOSPCODE ,
e.servplace,
e.age,
e.sex,
@rep_year year_rep,
IFNULL(e.total_pt_q1,0) total_pt_q1,	
IFNULL(e.total_q1,0) total_q1,
IFNULL(e.didstd_q1,0) didstd_q1,
IFNULL(e.total_pt_q2,0) total_pt_q2,	
IFNULL(e.total_q2,0) total_q2,
IFNULL(e.didstd_q2,0) didstd_q2,
IFNULL(e.total_pt_q3,0) total_pt_q3,	
IFNULL(e.total_q3,0) total_q3,
IFNULL(e.didstd_q3,0) didstd_q3,	
IFNULL(e.total_pt_q4,0) total_pt_q4,	
IFNULL(e.total_q4,0) total_q4,
IFNULL(e.didstd_q4,0) didstd_q4
FROM chospital o 
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE, 
e.DATE_SERV,
s.SERVPLACE servplace,
TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'1001')) age,
p.SEX sex,
@rep_year year_rep, 
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) total_pt_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ,'-',e.DIDSTD),NULL)) didstd_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) total_pt_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ,'-',e.DIDSTD),NULL)) didstd_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) total_pt_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ,'-',e.DIDSTD),NULL)) didstd_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) total_pt_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ,'-',e.DIDSTD),NULL)) didstd_q4 
FROM 
tmp_planthai_drug_use e
LEFT JOIN tmp_service s ON e.HOSPCODE = s.HOSPCODE AND e.PID = s.PID AND e.SEQ = s.SEQ 
LEFT JOIN person p ON e.HOSPCODE = p.HOSPCODE AND e.PID = p.PID 
GROUP BY e.HOSPCODE, s.SERVPLACE, p.SEX, TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'1001'))
) e ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.servplace IN ('1','2') AND e.HOSPCODE IS NOT NULL ;

/*********************ttm4**************/
DROP TABLE IF  EXISTS t_ttm_opd_4;
CREATE TABLE IF NOT EXISTS t_ttm_opd_4( 
PRIMARY KEY (hospcode,didstd),
KEY (hospcode),
KEY (didstd)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
o.hoscode hospcode ,
e.didstd,
IFNULL(CONCAT(e.drug_name,', ',e.drug_type),e.didstd) code_name,
@rep_year year_rep,
IFNULL(e.all_visit,0) all_visit,
IFNULL(e.all_drug,0) all_drug,
IFNULL(e.uc_visit,0) uc_visit,
IFNULL(e.uc_drug,0) uc_drug,
IFNULL(e.all_visit_error,0) all_visit_error,
IFNULL(e.all_drug_error,0) all_drug_error,
IFNULL(e.uc_visit_error,0) uc_visit_error,
IFNULL(e.uc_drug_error,0) uc_drug_error
FROM chospital o 
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE, 
e.DIDSTD didstd,
e.drug_name, 
e.drug_type,
@rep_year year_rep, 
COUNT(DISTINCT CONCAT(e.PID,'-',e.SEQ)) as all_visit, 
COUNT(*) as all_drug, 
COUNT(DISTINCT (IF(s.INSTYPE='0100',CONCAT(e.PID,'-',e.SEQ),NULL))) as uc_visit , 
COUNT(IF(s.INSTYPE='0100',1,NULL)) as uc_drug,
COUNT(DISTINCT IF(e.PASS IS NULL,CONCAT(e.PID,'-',e.SEQ),NULL)) as all_visit_error, 
COUNT(IF(e.PASS IS NULL,CONCAT(e.PID,'-',e.SEQ),NULL)) as all_drug_error, 
COUNT(DISTINCT (IF(s.INSTYPE='0100' AND e.PASS IS NULL,CONCAT(e.PID,'-',e.SEQ),NULL))) as uc_visit_error , 
COUNT(IF(s.INSTYPE='0100' AND e.PASS IS NULL,1,NULL)) as uc_drug_error  
FROM 
tmp_planthai_drug_use e
LEFT JOIN tmp_service s ON e.HOSPCODE = s.HOSPCODE AND e.PID = s.PID AND e.SEQ = s.SEQ 
GROUP BY e.HOSPCODE, e.DIDSTD ) e ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.didstd IS NOT NULL ;

/**************ttm5**********************/
DROP TABLE IF  EXISTS t_ttm_opd_5;
CREATE TABLE IF NOT EXISTS t_ttm_opd_5( 
PRIMARY KEY (hospcode,didstd,instype),
KEY (hospcode),
KEY (didstd),
KEY (instype)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
o.hoscode hospcode , 
e.didstd, 
IFNULL(CONCAT(e.drug_name,', ',e.drug_type),e.didstd) code_name, 
IF(e.INSTYPE='0100','UC','OTHER') instype, 
@rep_year year_rep, 
IFNULL(e.total_pt_q1,0) total_pt_q1, 
IFNULL(e.total_q1,0) total_q1, 
IFNULL(e.total_amount_q1,0) total_amount_q1, 
IFNULL(e.total_price_q1,0) total_price_q1, 
IFNULL(e.total_cost_q1,0) total_cost_q1, 
IFNULL(e.total_pt_q2,0) total_pt_q2, 
IFNULL(e.total_q2,0) total_q2, 
IFNULL(e.total_amount_q2,0) total_amount_q2, 
IFNULL(e.total_price_q2,0) total_price_q2, 
IFNULL(e.total_cost_q2,0) total_cost_q2, 
IFNULL(e.total_pt_q3,0) total_pt_q3, 
IFNULL(e.total_q3,0) total_q3, 
IFNULL(e.total_amount_q3,0) total_amount_q3, 
IFNULL(e.total_price_q3,0) total_price_q3, 
IFNULL(e.total_cost_q3,0) total_cost_q3, 
IFNULL(e.total_pt_q4,0) total_pt_q4, 
IFNULL(e.total_q4,0) total_q4, 
IFNULL(e.total_amount_q4,0) total_amount_q4, 
IFNULL(e.total_price_q4,0) total_price_q4, 
IFNULL(e.total_cost_q4,0) total_cost_q4 
FROM chospital o 
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE, 
e.DIDSTD didstd,
e.drug_name, 
e.drug_type,
s.INSTYPE,
@rep_year year_rep, 
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) total_pt_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q1,
SUM(IF(MONTH(e.DATE_SERV) IN (10,11,12),e.AMOUNT,0)) total_amount_q1,
SUM(IF(MONTH(e.DATE_SERV) IN (10,11,12),e.AMOUNT*e.DRUGPRICE,0)) total_price_q1,
SUM(IF(MONTH(e.DATE_SERV) IN (10,11,12),e.AMOUNT*e.DRUGCOST,0)) total_cost_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) total_pt_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q2,
SUM(IF(MONTH(e.DATE_SERV) IN (1,2,3),e.AMOUNT,0)) total_amount_q2,
SUM(IF(MONTH(e.DATE_SERV) IN (1,2,3),e.AMOUNT*e.DRUGPRICE,0)) total_price_q2,
SUM(IF(MONTH(e.DATE_SERV) IN (1,2,3),e.AMOUNT*e.DRUGCOST,0)) total_cost_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) total_pt_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q3,
SUM(IF(MONTH(e.DATE_SERV) IN (4,5,6),e.AMOUNT,0)) total_amount_q3,
SUM(IF(MONTH(e.DATE_SERV) IN (4,5,6),e.AMOUNT*e.DRUGPRICE,0)) total_price_q3,
SUM(IF(MONTH(e.DATE_SERV) IN (4,5,6),e.AMOUNT*e.DRUGCOST,0)) total_cost_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) total_pt_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q4,
SUM(IF(MONTH(e.DATE_SERV) IN (7,8,9),e.AMOUNT,0)) total_amount_q4,
SUM(IF(MONTH(e.DATE_SERV) IN (7,8,9),e.AMOUNT*e.DRUGPRICE,0)) total_price_q4,
SUM(IF(MONTH(e.DATE_SERV) IN (7,8,9),e.AMOUNT*e.DRUGCOST,0)) total_cost_q4
FROM 
tmp_planthai_drug_use e
LEFT JOIN tmp_service s ON e.HOSPCODE = s.HOSPCODE AND e.PID = s.PID AND e.SEQ = s.SEQ 
GROUP BY e.HOSPCODE,IF(s.INSTYPE='0100','UC','OTHER'), e.DIDSTD ) e ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.HOSPCODE IS NOT NULL  AND e.didstd IS NOT NULL ;

 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.23106;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:420;a:5:{i:0;s:34:"DROP PROCEDURE IF EXISTS t_ttm6_10";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.2778599;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:423;a:5:{i:0;s:40399:"CREATE PROCEDURE t_ttm6_10()
 BEGIN 
SET @provid = '58';
SET@id:= '66';
SET @rep_year = (SELECT yearprocess FROM sys_config LIMIT 1);
/*************ttm6*************/
DROP TEMPORARY TABLE IF  EXISTS tmp_planthai_diag_clinic;
CREATE TEMPORARY TABLE IF NOT EXISTS 
tmp_planthai_diag_clinic (INDEX(HOSPCODE),INDEX(PID),INDEX(SEQ)) 
ENGINE=MYISAM IGNORE AS 
SELECT 
e.HOSPCODE, 
e.PID, 
e.SEQ, 
e.DATE_SERV, 
e.DIAGCODE
FROM 
tmp_diag_opd e 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND (e.DIAGCODE IN ('U5750', 'U5752', 'U5753', 'U5755', 'U5759', 'U7141', 'U7142', 'U610', 'U611', 'U6110', 'U6111', 'U6112', 'U6113', 'U6114', 'U6115', 'U6118', 'U6119', 'U612', 'U743', 'U5943')
OR e.DIAGCODE BETWEEN 'M17' AND 'M179'
OR e.DIAGCODE BETWEEN 'G81' AND 'G839'
OR e.DIAGCODE BETWEEN 'J301' AND 'J304'
OR e.DIAGCODE BETWEEN 'G43' AND 'G439')
;

DROP TEMPORARY TABLE IF  EXISTS tmp_planthai_diag_clinic_u;
CREATE TEMPORARY TABLE IF NOT EXISTS 
tmp_planthai_diag_clinic_u (INDEX(HOSPCODE),INDEX(PID),INDEX(SEQ)) 
ENGINE=MYISAM IGNORE AS 
SELECT 
e.HOSPCODE, 
e.PID, 
e.SEQ, 
e.DATE_SERV, 
e.DIAGCODE
FROM 
tmp_diag_opd e 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND e.DIAGCODE IN ('U5750', 'U5752', 'U5753', 'U5755', 'U5759', 'U7141', 'U7142', 'U610', 'U611', 'U6110', 'U6111', 'U6112', 'U6113', 'U6114', 'U6115', 'U6118', 'U6119', 'U612', 'U743', 'U5943')
;

DROP TABLE IF  EXISTS t_ttm_opd_6;
CREATE TABLE IF NOT EXISTS t_ttm_opd_6( 
PRIMARY KEY (hospcode,instype),
KEY (hospcode),
KEY (instype)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT SQL_BIG_RESULT 
e.HOSPCODE , 
IF(s.INSTYPE='0100','UC','OTHER') instype,
@rep_year year_rep,  

COUNT(DISTINCT IF(e.DIAGCODE='U5750' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u5750_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U5750' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u5750_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U5750' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u5750_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U5750' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u5750_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U5752' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u5752_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U5752' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u5752_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U5752' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u5752_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U5752' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u5752_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U5753' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u5753_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U5753' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u5753_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U5753' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u5753_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U5753' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u5753_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U5755' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u5755_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U5755' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u5755_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U5755' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u5755_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U5755' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u5755_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U5759' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u5759_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U5759' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u5759_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U5759' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u5759_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U5759' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u5759_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U7141' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u7141_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U7141' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u7141_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U7141' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u7141_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U7141' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u7141_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U7142' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u7142_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U7142' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u7142_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U7142' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u7142_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U7142' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u7142_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U612' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u612_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U612' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u612_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U612' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u612_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U612' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u612_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U743' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u743_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U743' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u743_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U743' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u743_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U743' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u743_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U5943' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u5943_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U5943' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u5943_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U5943' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u5943_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U5943' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u5943_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U610' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u610_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U610' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u610_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U610' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u610_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U610' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u610_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U611' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u611_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U611' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u611_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U611' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u611_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U611' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u611_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U6110' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u6110_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U6110' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u6110_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U6110' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u6110_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U6110' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u6110_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U6111' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u6111_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U6111' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u6111_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U6111' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u6111_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U6111' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u6111_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U6112' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u6112_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U6112' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u6112_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U6112' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u6112_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U6112' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u6112_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U6113' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u6113_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U6113' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u6113_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U6113' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u6113_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U6113' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u6113_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U6114' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u6114_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U6114' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u6114_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U6114' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u6114_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U6114' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u6114_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U6115' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u6115_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U6115' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u6115_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U6115' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u6115_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U6115' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u6115_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U6118' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u6118_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U6118' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u6118_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U6118' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u6118_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U6118' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u6118_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U6119' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u6119_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U6119' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u6119_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U6119' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u6119_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U6119' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u6119_q4,

COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'M17' AND 'M179' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) m179_q1,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'M17' AND 'M179' AND e2.DIAGCODE IN ('U5750', 'U5752', 'U5753', 'U5755', 'U5759', 'U7141', 'U7142') AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_m179_q1,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'M17' AND 'M179' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) m179_q2,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'M17' AND 'M179' AND e2.DIAGCODE IN ('U5750', 'U5752', 'U5753', 'U5755', 'U5759', 'U7141', 'U7142') AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_m179_q2,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'M17' AND 'M179' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) m179_q3,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'M17' AND 'M179' AND e2.DIAGCODE IN ('U5750', 'U5752', 'U5753', 'U5755', 'U5759', 'U7141', 'U7142') AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_m179_q3,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'M17' AND 'M179' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) m179_q4,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'M17' AND 'M179' AND e2.DIAGCODE IN ('U5750', 'U5752', 'U5753', 'U5755', 'U5759', 'U7141', 'U7142') AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_m179_q4,


COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G81' AND 'G839' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) g431_q1,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G81' AND 'G839' AND e2.DIAGCODE = 'U612' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_g431_q1,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G81' AND 'G839' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) g431_q2,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G81' AND 'G839' AND e2.DIAGCODE = 'U612' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_g431_q2,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G81' AND 'G839' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) g431_q3,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G81' AND 'G839' AND e2.DIAGCODE = 'U612' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_g431_q3,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G81' AND 'G839' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) g431_q4,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G81' AND 'G839' AND e2.DIAGCODE = 'U612' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_g431_q4,

COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'J301' AND 'J304' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) j304_q1,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'J301' AND 'J304' AND e2.DIAGCODE IN ('U743','UU5943') AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_j304_q1,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'J301' AND 'J304' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) j304_q2,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'J301' AND 'J304' AND e2.DIAGCODE IN ('U743','UU5943') AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_j304_q2,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'J301' AND 'J304' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) j304_q3,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'J301' AND 'J304' AND e2.DIAGCODE IN ('U743','UU5943') AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_j304_q3,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'J301' AND 'J304' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) j304_q4,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'J301' AND 'J304' AND e2.DIAGCODE IN ('U743','UU5943') AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_j304_q4,

COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G43' AND 'G439' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) g819_q1,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G43' AND 'G439' AND e2.DIAGCODE IN ('U610', 'U611', 'U6110', 'U6111', 'U6112', 'U6113', 'U6114', 'U6115', 'U6118', 'U6119') AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_g819_q1,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G43' AND 'G439' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) g819_q2,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G43' AND 'G439' AND e2.DIAGCODE IN ('U610', 'U611', 'U6110', 'U6111', 'U6112', 'U6113', 'U6114', 'U6115', 'U6118', 'U6119') AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_g819_q2,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G43' AND 'G439' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) g819_q3,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G43' AND 'G439' AND e2.DIAGCODE IN ('U610', 'U611', 'U6110', 'U6111', 'U6112', 'U6113', 'U6114', 'U6115', 'U6118', 'U6119') AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_g819_q3,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G43' AND 'G439' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) g819_q4,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G43' AND 'G439' AND e2.DIAGCODE IN ('U610', 'U611', 'U6110', 'U6111', 'U6112', 'U6113', 'U6114', 'U6115', 'U6118', 'U6119') AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_g819_q4
FROM 
tmp_planthai_diag_clinic e 
LEFT JOIN tmp_service s ON s.HOSPCODE = e.HOSPCODE AND s.PID = e.PID AND s.SEQ = e.SEQ 
LEFT JOIN tmp_planthai_diag_clinic_u e2 ON e.HOSPCODE = e2.HOSPCODE AND e.PID = e2.PID AND e.SEQ = e2.SEQ 
LEFT JOIN chospital o ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.HOSPCODE IS NOT NULL 
GROUP BY e.HOSPCODE, IF(s.INSTYPE='0100','UC','OTHER') ;

/****************ttm7*************/
DROP TABLE IF  EXISTS t_ttm_opd_7;
CREATE TABLE IF NOT EXISTS t_ttm_opd_7( 
PRIMARY KEY (hospcode,code_rep),
KEY (hospcode),
KEY (code_rep),
KEY (code_name)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS

SELECT SQL_BIG_RESULT
e.HOSPCODE ,
LEFT(DATE(e.DATE_SERV),7) code_rep,
IF(MONTH(e.DATE_SERV)=1,'มกราคม',
IF(MONTH(e.DATE_SERV)=2,'กุมภาพันธ์',
IF(MONTH(e.DATE_SERV)=3,'มีนาคม',
IF(MONTH(e.DATE_SERV)=4,'เมษายน',
IF(MONTH(e.DATE_SERV)=5,'พฤษภาคม',
IF(MONTH(e.DATE_SERV)=6,'มิถุนายน',
IF(MONTH(e.DATE_SERV)=7,'กรกฏาคม',
IF(MONTH(e.DATE_SERV)=8,'สิงหาคม',
IF(MONTH(e.DATE_SERV)=9,'กันยายน',
IF(MONTH(e.DATE_SERV)=10,'ตุลาคม',
IF(MONTH(e.DATE_SERV)=11,'พฤศจิกายน',
'ธันวาคม'))))))))))) code_name,
@rep_year year_rep,
SUM(IF(LEFT(e.DIDSTD,2) <> '41' AND LEFT(e.DIDSTD,2) <> '42',e.AMOUNT*e.DRUGPRICE,0))  price_drug ,
SUM(IF(LEFT(e.DIDSTD,2) = '41' OR LEFT(e.DIDSTD,2) = '42',e.AMOUNT*e.DRUGPRICE,0))  price_planthai_drug
FROM 
tmp_drug_opd e 
LEFT JOIN chospital i ON e.HOSPCODE = i.hoscode 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930')  AND i.provcode=@provid 
GROUP BY e.HOSPCODE, MONTH(e.DATE_SERV);

/*************ttm8*****************/
DROP TEMPORARY TABLE IF  EXISTS tmp_planthai_procedure;
CREATE TEMPORARY TABLE IF NOT EXISTS 
tmp_planthai_procedure (INDEX(HOSPCODE),INDEX(PID),INDEX(SEQ)) 
ENGINE=MYISAM IGNORE AS 
SELECT 
e.HOSPCODE, 
e.PID, 
e.SEQ, 
e.DATE_SERV, 
e.PROCEDCODE, 
icd.tmtype 
FROM 
tmp_procedure_opd e 
LEFT JOIN cicd9ttm_planthai icd ON icd.`code` = e.PROCEDCODE 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND icd.`code`IS NOT NULL 
;

DROP TABLE IF  EXISTS t_ttm_opd_8;
CREATE TABLE IF NOT EXISTS t_ttm_opd_8( 
PRIMARY KEY (hospcode,instype),
KEY (hospcode),
KEY (instype)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
e.HOSPCODE ,
IF(e.INSTYPE='0100','UC','OTHER') instype,
IFNULL(e.year_rep,@rep_year) year_rep,

IFNULL(e.pt_nod_q1,0) pt_nod_q1,
IFNULL(e.service_nod_q1,0) service_nod_q1,
IFNULL(e.pt_obb_q1,0) pt_obb_q1,
IFNULL(e.service_obb_q1,0) service_obb_q1,
IFNULL(e.pt_cop_q1,0) pt_cop_q1,
IFNULL(e.service_cop_q1,0) service_cop_q1,
IFNULL(e.pt_other_q1,0) pt_other_q1,
IFNULL(e.service_other_q1,0) service_other_q1,
IFNULL(e.pt_total_q1,0) pt_total_q1,
IFNULL(e.service_total_q1,0) service_total_q1,

IFNULL(e.out_pt_nod_q1,0) out_pt_nod_q1,
IFNULL(e.out_service_nod_q1,0) out_service_nod_q1,
IFNULL(e.out_pt_obb_q1,0) out_pt_obb_q1,
IFNULL(e.out_service_obb_q1,0) out_service_obb_q1,
IFNULL(e.out_pt_cop_q1,0) out_pt_cop_q1,
IFNULL(e.out_service_cop_q1,0) out_service_cop_q1,
IFNULL(e.out_pt_other_q1,0) out_pt_other_q1,
IFNULL(e.out_service_other_q1,0) out_service_other_q1,
IFNULL(e.out_pt_total_q1,0) out_pt_total_q1,
IFNULL(e.out_service_total_q1,0) out_service_total_q1,

IFNULL(e.pt_nod_q2,0) pt_nod_q2,
IFNULL(e.service_nod_q2,0) service_nod_q2,
IFNULL(e.pt_obb_q2,0) pt_obb_q2,
IFNULL(e.service_obb_q2,0) service_obb_q2,
IFNULL(e.pt_cop_q2,0) pt_cop_q2,
IFNULL(e.service_cop_q2,0) service_cop_q2,
IFNULL(e.pt_other_q2,0) pt_other_q2,
IFNULL(e.service_other_q2,0) service_other_q2,
IFNULL(e.pt_total_q2,0) pt_total_q2,
IFNULL(e.service_total_q2,0) service_total_q2,

IFNULL(e.out_pt_nod_q2,0) out_pt_nod_q2,
IFNULL(e.out_service_nod_q2,0) out_service_nod_q2,
IFNULL(e.out_pt_obb_q2,0) out_pt_obb_q2,
IFNULL(e.out_service_obb_q2,0) out_service_obb_q2,
IFNULL(e.out_pt_cop_q2,0) out_pt_cop_q2,
IFNULL(e.out_service_cop_q2,0) out_service_cop_q2,
IFNULL(e.out_pt_other_q2,0) out_pt_other_q2,
IFNULL(e.out_service_other_q2,0) out_service_other_q2,
IFNULL(e.out_pt_total_q2,0) out_pt_total_q2,
IFNULL(e.out_service_total_q2,0) out_service_total_q2,

IFNULL(e.pt_nod_q3,0) pt_nod_q3,
IFNULL(e.service_nod_q3,0) service_nod_q3,
IFNULL(e.pt_obb_q3,0) pt_obb_q3,
IFNULL(e.service_obb_q3,0) service_obb_q3,
IFNULL(e.pt_cop_q3,0) pt_cop_q3,
IFNULL(e.service_cop_q3,0) service_cop_q3,
IFNULL(e.pt_other_q3,0) pt_other_q3,
IFNULL(e.service_other_q3,0) service_other_q3,
IFNULL(e.pt_total_q3,0) pt_total_q3,
IFNULL(e.service_total_q3,0) service_total_q3,

IFNULL(e.out_pt_nod_q3,0) out_pt_nod_q3,
IFNULL(e.out_service_nod_q3,0) out_service_nod_q3,
IFNULL(e.out_pt_obb_q3,0) out_pt_obb_q3,
IFNULL(e.out_service_obb_q3,0) out_service_obb_q3,
IFNULL(e.out_pt_cop_q3,0) out_pt_cop_q3,
IFNULL(e.out_service_cop_q3,0) out_service_cop_q3,
IFNULL(e.out_pt_other_q3,0) out_pt_other_q3,
IFNULL(e.out_service_other_q3,0) out_service_other_q3,
IFNULL(e.out_pt_total_q3,0) out_pt_total_q3,
IFNULL(e.out_service_total_q3,0) out_service_total_q3,

IFNULL(e.pt_nod_q4,0) pt_nod_q4,
IFNULL(e.service_nod_q4,0) service_nod_q4,
IFNULL(e.pt_obb_q4,0) pt_obb_q4,
IFNULL(e.service_obb_q4,0) service_obb_q4,
IFNULL(e.pt_cop_q4,0) pt_cop_q4,
IFNULL(e.service_cop_q4,0) service_cop_q4,
IFNULL(e.pt_other_q4,0) pt_other_q4,
IFNULL(e.service_other_q4,0) service_other_q4,
IFNULL(e.pt_total_q4,0) pt_total_q4,
IFNULL(e.service_total_q4,0) service_total_q4,

IFNULL(e.out_pt_nod_q4,0) out_pt_nod_q4,
IFNULL(e.out_service_nod_q4,0) out_service_nod_q4,
IFNULL(e.out_pt_obb_q4,0) out_pt_obb_q4,
IFNULL(e.out_service_obb_q4,0) out_service_obb_q4,
IFNULL(e.out_pt_cop_q4,0) out_pt_cop_q4,
IFNULL(e.out_service_cop_q4,0) out_service_cop_q4,
IFNULL(e.out_pt_other_q4,0) out_pt_other_q4,
IFNULL(e.out_service_other_q4,0) out_service_other_q4,
IFNULL(e.out_pt_total_q4,0) out_pt_total_q4,
IFNULL(e.out_service_total_q4,0) out_service_total_q4
FROM chospital o
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE, 
s.INSTYPE,
s.SERVPLACE,
@rep_year year_rep,  

COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) pt_nod_q1,
COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) service_nod_q1,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) pt_obb_q1,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) service_obb_q1,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) pt_cop_q1,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) service_cop_q1,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) pt_other_q1,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) service_other_q1,
COUNT(DISTINCT IF(s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) pt_total_q1,
COUNT(DISTINCT IF(s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) service_total_q1,

COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) out_pt_nod_q1,
COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_nod_q1,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) out_pt_obb_q1,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_obb_q1,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) out_pt_cop_q1,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_cop_q1,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) out_pt_other_q1,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_other_q1,
COUNT(DISTINCT IF(s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) out_pt_total_q1,
COUNT(DISTINCT IF(s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_total_q1,

COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) pt_nod_q2,
COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) service_nod_q2,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) pt_obb_q2,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) service_obb_q2,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) pt_cop_q2,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) service_cop_q2,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) pt_other_q2,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) service_other_q2,
COUNT(DISTINCT IF(s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) pt_total_q2,
COUNT(DISTINCT IF(s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) service_total_q2,

COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) out_pt_nod_q2,
COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_nod_q2,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) out_pt_obb_q2,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_obb_q2,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) out_pt_cop_q2,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_cop_q2,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) out_pt_other_q2,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_other_q2,
COUNT(DISTINCT IF(s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) out_pt_total_q2,
COUNT(DISTINCT IF(s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_total_q2,

COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) pt_nod_q3,
COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) service_nod_q3,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) pt_obb_q3,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) service_obb_q3,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) pt_cop_q3,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) service_cop_q3,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) pt_other_q3,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) service_other_q3,
COUNT(DISTINCT IF(s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) pt_total_q3,
COUNT(DISTINCT IF(s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) service_total_q3,

COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) out_pt_nod_q3,
COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_nod_q3,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) out_pt_obb_q3,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_obb_q3,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) out_pt_cop_q3,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_cop_q3,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) out_pt_other_q3,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_other_q3,
COUNT(DISTINCT IF(s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) out_pt_total_q3,
COUNT(DISTINCT IF(s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_total_q3,

COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) pt_nod_q4,
COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) service_nod_q4,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) pt_obb_q4,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) service_obb_q4,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) pt_cop_q4,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) service_cop_q4,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) pt_other_q4,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) service_other_q4,
COUNT(DISTINCT IF(s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) pt_total_q4,
COUNT(DISTINCT IF(s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) service_total_q4,

COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) out_pt_nod_q4,
COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_nod_q4,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) out_pt_obb_q4,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_obb_q4,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) out_pt_cop_q4,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_cop_q4,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) out_pt_other_q4,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_other_q4,
COUNT(DISTINCT IF(s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) out_pt_total_q4,
COUNT(DISTINCT IF(s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_total_q4,
NOW() 
FROM 
tmp_planthai_procedure e 
LEFT JOIN tmp_service s ON s.HOSPCODE = e.HOSPCODE AND s.PID = e.PID AND s.SEQ = e.SEQ 
WHERE s.SERVPLACE IN ('1','2') 
GROUP BY e.HOSPCODE,  IF(s.INSTYPE='0100','UC','OTHER') 
) e ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.HOSPCODE IS NOT NULL ;

/*********************ttm9**************************/
DROP TEMPORARY TABLE IF  EXISTS tmp_planthai_diag_u;
CREATE TEMPORARY TABLE IF NOT EXISTS 
tmp_planthai_diag_u (INDEX(HOSPCODE),INDEX(PID),INDEX(SEQ)) 
ENGINE=MYISAM IGNORE AS 
SELECT 
e.HOSPCODE, 
e.PID, 
e.SEQ, 
e.DATE_SERV, 
e.DIAGCODE, 
d.SEQ DRUG ,
TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'1001')) age,
p.SEX 
FROM 
tmp_diag_opd e 
LEFT JOIN person p ON e.HOSPCODE = p.HOSPCODE AND e.PID = p.PID 
LEFT JOIN tmp_drug_opd d ON d.HOSPCODE = e.HOSPCODE AND d.PID = e.PID AND d.SEQ = e.SEQ AND LEFT(d.DIDSTD,2) IN ('41','42') 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIAGCODE,1) = 'U' AND LEFT(e.DIAGCODE,3)<>'U77' 
;

DROP TABLE IF  EXISTS t_ttm_opd_9;
CREATE TABLE IF NOT EXISTS t_ttm_opd_9( 
PRIMARY KEY (hospcode,instype,diagcode,age,sex),
KEY (hospcode),
KEY (instype),
KEY (diagcode),
KEY (age),
KEY (sex)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS

SELECT 
e.HOSPCODE ,
IF(e.INSTYPE='0100','UC','OTHER') instype,
e.DIAGCODE diagcode,
e.diseasename,
IFNULL(e.year_rep,@rep_year) year_rep,
IFNULL(e.age,0) age,
e.sex,

IFNULL(e.total_pt_q1,0) total_pt_q1,	
IFNULL(e.total_q1,0) total_q1,

IFNULL(e.total_pt_q2,0) total_pt_q2,	
IFNULL(e.total_q2,0) total_q2,

IFNULL(e.total_pt_q3,0) total_pt_q3,	
IFNULL(e.total_q3,0) total_q3,

IFNULL(e.total_pt_q4,0) total_pt_q4,	
IFNULL(e.total_q4,0) total_q4,
IFNULL(e.total_drug,0) total_drug
FROM chospital o
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE, 
s.INSTYPE,
e.DIAGCODE,
IFNULL(d.diseasethai,e.DIAGCODE) diseasename,
@rep_year year_rep,  
e.age age,
e.SEX sex,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) total_pt_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q1,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) total_pt_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q2,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) total_pt_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q3,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) total_pt_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q4,

COUNT(DISTINCT e.DRUG) total_drug
FROM 
tmp_planthai_diag_u e 
LEFT JOIN tmp_service s ON s.HOSPCODE = e.HOSPCODE AND s.PID = e.PID AND s.SEQ = e.SEQ 
LEFT JOIN cdisease d ON d.diagcode = e.DIAGCODE 
WHERE e.SEX IN (1,2)
GROUP BY e.HOSPCODE, IF(s.INSTYPE='0100','UC','OTHER'), e.DIAGCODE , e.age , e.SEX 
) e ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.HOSPCODE IS NOT NULL ;

/***********************ttm10******************/
DROP TABLE IF  EXISTS t_ttm_opd_10;
CREATE TABLE IF NOT EXISTS t_ttm_opd_10( 
PRIMARY KEY (hospcode,instype),
KEY (hospcode),
KEY (instype)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS

SELECT SQL_BIG_RESULT 
e.HOSPCODE ,
IF(s.INSTYPE='0100','UC','OTHER') instype,
@rep_year year_rep,

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) ed_pt_q1,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) non_ed_pt_q1,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) other_pt_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) total_pt_q1,	

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) ed_q1,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) non_ed_q1,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) other_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q1,	

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) ed_pt_q2,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) non_ed_pt_q2,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) other_pt_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) total_pt_q2,	

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) ed_q2,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) non_ed_q2,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) other_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q2,	

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) ed_pt_q3,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) non_ed_pt_q3,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) other_pt_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) total_pt_q3,	

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) ed_q3,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) non_ed_q3,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) other_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q3,	
 
COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) ed_pt_q4,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) non_ed_pt_q4,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) other_pt_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) total_pt_q4,	

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) ed_q4,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) non_ed_q4,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) other_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q4 
FROM 
tmp_planthai_drug_use e
LEFT JOIN tmp_service s ON e.HOSPCODE = s.HOSPCODE AND e.PID = s.PID AND e.SEQ = s.SEQ 
LEFT JOIN chospital o ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.HOSPCODE IS NOT NULL  AND e.DIDSTD IS NOT NULL 
GROUP BY e.HOSPCODE, IF(s.INSTYPE='0100','UC','OTHER');


 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.34026;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:426;a:5:{i:0;s:35:"DROP PROCEDURE IF EXISTS t_ttm11_15";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.406863;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:429;a:5:{i:0;s:18100:"CREATE PROCEDURE t_ttm11_15()
 BEGIN 
SET @provid = '58';
SET@id:= '67';
SET @rep_year = (SELECT yearprocess FROM sys_config LIMIT 1);
/**********************ttm11***************/
DROP TEMPORARY TABLE IF  EXISTS diag_u77;
CREATE TEMPORARY TABLE IF NOT EXISTS 
diag_u77 (INDEX(pcucode,instype,age)) 
ENGINE=MYISAM IGNORE AS 
SELECT SQL_BIG_RESULT
e.HOSPCODE pcucode, 
IF(s.INSTYPE='0100','UC','OTHER') instype, 
TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'1001')) age,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12) ,CONCAT(e.PID,'-',e.SEQ),NULL)) total_u77_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3) ,CONCAT(e.PID,'-',e.SEQ),NULL)) total_u77_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6) ,CONCAT(e.PID,'-',e.SEQ),NULL)) total_u77_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9) ,CONCAT(e.PID,'-',e.SEQ),NULL)) total_u77_q4,
COUNT(DISTINCT CONCAT(e.PID,'-',e.SEQ)) total_u77
FROM 
tmp_diag_opd e 
LEFT JOIN tmp_service s ON s.HOSPCODE = e.HOSPCODE AND s.PID = e.PID AND s.SEQ = e.SEQ 
LEFT JOIN person p ON e.HOSPCODE = p.HOSPCODE AND e.PID = p.PID 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIAGCODE,3) = 'U77' 
GROUP BY e.HOSPCODE,  IF(s.INSTYPE='0100','UC','OTHER'), TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'1001'))
;

DROP TEMPORARY TABLE IF  EXISTS proced_u77;
CREATE TEMPORARY TABLE IF NOT EXISTS 
proced_u77 (INDEX(pcucode,instype,age)) 
ENGINE=MYISAM  IGNORE AS 
SELECT SQL_BIG_RESULT 
e.HOSPCODE pcucode, 
IF(s.INSTYPE='0100','UC','OTHER') instype, 
TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'-10-01')) age,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,e.PID,NULL)) total_planthai_pt_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,CONCAT(e.PID,'-',e.SEQ),NULL)) total_planthai_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),e.PID,NULL)) total_pt_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,e.PID,NULL)) total_planthai_pt_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,CONCAT(e.PID,'-',e.SEQ),NULL)) total_planthai_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),e.PID,NULL)) total_pt_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,e.PID,NULL)) total_planthai_pt_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,CONCAT(e.PID,'-',e.SEQ),NULL)) total_planthai_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),e.PID,NULL)) total_pt_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,e.PID,NULL)) total_planthai_pt_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,CONCAT(e.PID,'-',e.SEQ),NULL)) total_planthai_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),e.PID,NULL)) total_pt_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q4
FROM 
(
SELECT 
e.HOSPCODE, 
e.PID, 
e.SEQ, 
e.DATE_SERV, 
e.PROCEDCODE 
FROM 
tmp_procedure_opd e 
LEFT JOIN tmp_diag_opd d ON d.HOSPCODE = e.HOSPCODE AND d.PID = e.PID AND d.SEQ = e.SEQ 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007903','9007904','9007998','9007999') 
AND LEFT(d.DIAGCODE,3) = 'U77' 
) e 
LEFT JOIN tmp_service s ON s.HOSPCODE = e.HOSPCODE AND s.PID = e.PID AND s.SEQ = e.SEQ 
LEFT JOIN person p ON e.HOSPCODE = p.HOSPCODE AND e.PID = p.PID 
WHERE e.HOSPCODE IS NOT NULL 
GROUP BY e.HOSPCODE,  IF(s.INSTYPE='0100','UC','OTHER'), TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'1001'))
;

DROP TABLE IF  EXISTS t_ttm_opd_11;
CREATE TABLE IF NOT EXISTS t_ttm_opd_11( 
PRIMARY KEY (hospcode,instype,age),
KEY (hospcode),
KEY (instype),
KEY (age)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE  AS

SELECT SQL_BIG_RESULT 
e.pcucode hospcode, 
e.instype, 
e.age,
@rep_year year_rep, 
e.total_u77_q1,
IFNULL(p.total_planthai_pt_q1,0) total_planthai_pt_q1,
IFNULL(p.total_planthai_q1,0) total_planthai_q1,
IFNULL(p.total_pt_q1,0) total_pt_q1,
IFNULL(p.total_q1,0) total_q1,
e.total_u77_q2,
IFNULL(p.total_planthai_pt_q2,0) total_planthai_pt_q2,
IFNULL(p.total_planthai_q2,0) total_planthai_q2,
IFNULL(p.total_pt_q2,0) total_pt_q2,
IFNULL(p.total_q2,0) total_q2,
e.total_u77_q3,
IFNULL(p.total_planthai_pt_q3,0) total_planthai_pt_q3,
IFNULL(p.total_planthai_q3,0) total_planthai_q3,
IFNULL(p.total_pt_q3,0) total_pt_q3,
IFNULL(p.total_q3,0) total_q3,
e.total_u77_q4,
IFNULL(p.total_planthai_pt_q4,0) total_planthai_pt_q4,
IFNULL(p.total_planthai_q4,0) total_planthai_q4,
IFNULL(p.total_pt_q4,0) total_pt_q4,
IFNULL(p.total_q4,0) total_q4,
(IFNULL(p.total_planthai_q1,0)+IFNULL(p.total_planthai_q2,0)+IFNULL(p.total_planthai_q3,0)+IFNULL(p.total_planthai_q4,0)) total_planthai,
(IFNULL(p.total_q1,0)+IFNULL(p.total_q2,0)+IFNULL(p.total_q3,0)+IFNULL(p.total_q4,0)) total_choice,
e.total_u77
FROM 
diag_u77 e 
LEFT JOIN proced_u77 p ON p.pcucode = e.pcucode AND p.instype = e.instype AND p.age = e.age 
LEFT JOIN chospital o ON e.pcucode = o.hoscode 
WHERE o.provcode=@provid ;

/***********************ttm12*******************/

DROP TEMPORARY TABLE IF  EXISTS tmp_planthai_opd_no_z;
CREATE TEMPORARY TABLE IF NOT EXISTS 
tmp_planthai_opd_no_z (INDEX(HOSPCODE),INDEX(code_rep)) 
ENGINE=MYISAM IGNORE AS
SELECT SQL_BIG_RESULT
e.HOSPCODE,
LEFT(DATE(e.DATE_SERV),7) code_rep,
COUNT(DISTINCT CONCAT(e.PID,'-',e.SEQ)) OP_SERVICE,
COUNT(DISTINCT e.PID) OP_SERVICE_PT
FROM tmp_service e 
LEFT JOIN tmp_diag_opd d ON d.HOSPCODE = e.HOSPCODE AND d.PID = e.PID AND d.SEQ = e.SEQ AND d.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(d.DIAGCODE,1) <> 'Z' 
GROUP BY e.HOSPCODE, MONTH(e.DATE_SERV)
;

DROP TEMPORARY TABLE IF  EXISTS tmp_ttm_service;
CREATE TEMPORARY TABLE IF NOT EXISTS 
tmp_ttm_service (
`HOSPCODE`  char(5) NOT NULL ,
`PID`  varchar(16) NOT NULL ,
`SEQ`  varchar(16) NOT NULL ,
`DATE_SERV`  date NULL ,
PRIMARY KEY (`HOSPCODE`, `PID`, `SEQ`)
);

REPLACE INTO tmp_ttm_service 
SELECT e.HOSPCODE, 
e.PID,
e.SEQ, 
e.DATE_SERV 
FROM tmp_diag_opd e 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIAGCODE,1) = 'U';

REPLACE INTO tmp_ttm_service
SELECT e.HOSPCODE, 
e.PID,
e.SEQ, 
e.DATE_SERV 
FROM tmp_drug_opd e 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIDSTD,2) IN ('41','42') ;

REPLACE INTO tmp_ttm_service
SELECT e.HOSPCODE, 
e.PID,
e.SEQ, 
e.DATE_SERV 
FROM tmp_procedure_opd  e 
LEFT JOIN cicd9ttm_planthai p ON e.PROCEDCODE=p.`code` 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND p.code IS NOT NULL ;


DROP TABLE IF  EXISTS t_ttm_opd_12;
CREATE TABLE IF NOT EXISTS t_ttm_opd_12( 
PRIMARY KEY (hospcode),
KEY (hospcode)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
o.hoscode hospcode,
e.code_rep quarterly,
@rep_year year_rep,
IFNULL(e.OP_SERVICE_PT,0) op_service_pt,
IFNULL(e.OP_SERVICE,0) op_service,
IFNULL(t.TM_SERVICE_PT,0) tm_service_pt,
IFNULL(t.TM_SERVICE,0) tm_service
FROM chospital o 
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE,
'' code_rep,
SUM(e.OP_SERVICE_PT) OP_SERVICE_PT, 
SUM(e.OP_SERVICE) OP_SERVICE  
FROM tmp_planthai_opd_no_z e 
GROUP BY e.HOSPCODE 
) e ON e.HOSPCODE = o.hoscode 

LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE,
e.PID,
'' code_rep,
COUNT(DISTINCT e.PID) TM_SERVICE_PT, 
COUNT(DISTINCT CONCAT(e.PID,'-',e.SEQ)) TM_SERVICE 
FROM
tmp_ttm_service e
GROUP BY e.HOSPCODE 
) t ON t.HOSPCODE = e.HOSPCODE AND t.code_rep = e.code_rep
WHERE o.provcode=@provid AND e.HOSPCODE IS NOT NULL;

/******************************ttm13*******************/
DROP TEMPORARY TABLE IF  EXISTS tmp_planthai_opd_no_z;
CREATE TEMPORARY TABLE IF NOT EXISTS 
tmp_planthai_opd_no_z (INDEX(HOSPCODE),INDEX(code_rep)) 
ENGINE=MYISAM IGNORE AS 
SELECT SQL_BIG_RESULT
e.HOSPCODE,
LEFT(DATE(e.DATE_SERV),7) code_rep,
IF(MONTH(e.DATE_SERV)=1,'มกราคม',
IF(MONTH(e.DATE_SERV)=2,'กุมภาพันธ์',
IF(MONTH(e.DATE_SERV)=3,'มีนาคม',
IF(MONTH(e.DATE_SERV)=4,'เมษายน',
IF(MONTH(e.DATE_SERV)=5,'พฤษภาคม',
IF(MONTH(e.DATE_SERV)=6,'มิถุนายน',
IF(MONTH(e.DATE_SERV)=7,'กรกฏาคม',
IF(MONTH(e.DATE_SERV)=8,'สิงหาคม',
IF(MONTH(e.DATE_SERV)=9,'กันยายน',
IF(MONTH(e.DATE_SERV)=10,'ตุลาคม',
IF(MONTH(e.DATE_SERV)=11,'พฤศจิกายน',
'ธันวาคม'))))))))))) code_name, 
COUNT(DISTINCT CONCAT(e.PID,'-',e.SEQ)) OP_SERVICE,
COUNT(DISTINCT e.PID) OP_SERVICE_PT
FROM tmp_service e 
LEFT JOIN tmp_diag_opd d ON d.HOSPCODE = e.HOSPCODE AND d.PID = e.PID AND d.SEQ = e.SEQ AND d.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(d.DIAGCODE,1) <> 'Z'
GROUP BY e.HOSPCODE, MONTH(e.DATE_SERV)
;

DROP TEMPORARY TABLE IF  EXISTS tmp_ttm_service;
CREATE TEMPORARY TABLE IF NOT EXISTS 
tmp_ttm_service (
`HOSPCODE`  char(5) NOT NULL ,
`PID`  varchar(16) NOT NULL ,
`SEQ`  varchar(16) NOT NULL ,
`DATE_SERV`  date NULL ,
PRIMARY KEY (`HOSPCODE`, `PID`, `SEQ`)
);

INSERT IGNORE INTO tmp_ttm_service 
SELECT e.HOSPCODE, 
e.PID,
e.SEQ, 
e.DATE_SERV 
FROM tmp_diag_opd e 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIAGCODE,1) = 'U';

INSERT IGNORE INTO tmp_ttm_service
SELECT e.HOSPCODE, 
e.PID,
e.SEQ, 
e.DATE_SERV 
FROM tmp_drug_opd e 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIDSTD,2) IN ('41','42') ;

INSERT IGNORE INTO tmp_ttm_service
SELECT e.HOSPCODE, 
e.PID,
e.SEQ, 
e.DATE_SERV 
FROM tmp_procedure_opd e 
LEFT JOIN cicd9ttm_planthai p ON e.PROCEDCODE=p.`code` 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND p.code IS NOT NULL ;

DROP TABLE IF  EXISTS t_ttm_opd_13;
CREATE TABLE IF NOT EXISTS t_ttm_opd_13( 
PRIMARY KEY (hospcode,code_rep),
KEY (hospcode),
KEY (code_rep)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
o.hoscode hospcode,
IFNULL(e.code_rep,CONCAT(@rep_year,'-10')) code_rep,
IFNULL(e.code_name,'ตุลาคม') code_name,
@rep_year year_rep,
IFNULL(e.OP_SERVICE_PT,0) op_service_pt,
IFNULL(e.OP_SERVICE,0) op_service,
IFNULL(t.TM_SERVICE_PT,0) tm_service_pt,
IFNULL(t.TM_SERVICE,0) tm_service
FROM chospital o 
LEFT JOIN 
tmp_planthai_opd_no_z e ON e.HOSPCODE = o.hoscode 
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE,
LEFT(DATE(e.DATE_SERV),7) code_rep,
COUNT(DISTINCT CONCAT(e.PID,'-',e.SEQ)) TM_SERVICE, 
COUNT(DISTINCT e.PID) TM_SERVICE_PT 
FROM
tmp_ttm_service e
GROUP BY e.HOSPCODE, LEFT(DATE(e.DATE_SERV),7)
) t ON t.HOSPCODE = e.HOSPCODE AND t.code_rep = e.code_rep
WHERE o.provcode=@provid 
HAVING op_service<>0  ; 

/***********************ttm14*****************/
DROP TEMPORARY TABLE IF  EXISTS ttm_service_tmp;
CREATE TEMPORARY TABLE IF NOT EXISTS 
ttm_service_tmp (
`HOSPCODE`  char(5) NOT NULL ,
`SEQ`  varchar(16) NOT NULL ,
`DATE_SERV`  date NULL ,
PRIMARY KEY (`HOSPCODE`, `SEQ`)
);

REPLACE INTO ttm_service_tmp 
SELECT e.HOSPCODE, 
e.SEQ, 
e.DATE_SERV 
FROM tmp_diag_opd e 
LEFT JOIN tmp_service s ON  s.HOSPCODE = e.HOSPCODE AND s.PID = e.PID AND s.SEQ = e.SEQ 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIAGCODE,1) = 'U' AND e.DIAGCODE<>'U77' AND s.INSTYPE='0100';

REPLACE INTO ttm_service_tmp
SELECT e.HOSPCODE, 
e.SEQ, 
e.DATE_SERV 
FROM tmp_drug_opd e 
LEFT JOIN tmp_service s ON  s.HOSPCODE = e.HOSPCODE AND s.PID = e.PID AND s.SEQ = e.SEQ 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIDSTD,2) IN ('41','42') AND s.INSTYPE='0100' ;

REPLACE INTO ttm_service_tmp
SELECT e.HOSPCODE, 
e.SEQ, 
e.DATE_SERV 
FROM tmp_procedure_opd e 
LEFT JOIN tmp_service s ON  s.HOSPCODE = e.HOSPCODE AND s.PID = e.PID AND s.SEQ = e.SEQ 
LEFT JOIN cicd9ttm_planthai p ON e.PROCEDCODE=p.`code` AND p.code NOT IN ('9007900','9007901','9007902','9007903','9007904','9007998','9007999')
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND p.code IS NOT NULL AND s.INSTYPE='0100' ;


DROP TABLE IF  EXISTS t_ttm_opd_14;
CREATE TABLE IF NOT EXISTS t_ttm_opd_14( 
PRIMARY KEY (hospcode,code_rep),
KEY (hospcode),
KEY (code_rep)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
o.hoscode hospcode,
IFNULL(e.code_rep,CONCAT(@rep_year,'-10')) code_rep,
IFNULL(e.code_name,'ตุลาคม') code_name,
@rep_year year_rep,
IFNULL(e.OP_SERVICE,0) op_service,
IFNULL(t.TM_SERVICE,0) tm_service
FROM chospital o 
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE,
LEFT(DATE(e.DATE_SERV),7) code_rep,
IF(MONTH(e.DATE_SERV)=1,'มกราคม',
IF(MONTH(e.DATE_SERV)=2,'กุมภาพันธ์',
IF(MONTH(e.DATE_SERV)=3,'มีนาคม',
IF(MONTH(e.DATE_SERV)=4,'เมษายน',
IF(MONTH(e.DATE_SERV)=5,'พฤษภาคม',
IF(MONTH(e.DATE_SERV)=6,'มิถุนายน',
IF(MONTH(e.DATE_SERV)=7,'กรกฏาคม',
IF(MONTH(e.DATE_SERV)=8,'สิงหาคม',
IF(MONTH(e.DATE_SERV)=9,'กันยายน',
IF(MONTH(e.DATE_SERV)=10,'ตุลาคม',
IF(MONTH(e.DATE_SERV)=11,'พฤศจิกายน',
'ธันวาคม'))))))))))) code_name, 
COUNT(DISTINCT CONCAT(e.PID,'-',e.SEQ)) OP_SERVICE 
FROM tmp_service e 
LEFT JOIN tmp_diag_opd d ON d.HOSPCODE = e.HOSPCODE AND d.PID = e.PID AND d.SEQ = e.SEQ AND d.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(d.DIAGCODE,1) <> 'Z' AND e.INSTYPE='0100'
GROUP BY e.HOSPCODE, MONTH(e.DATE_SERV)
) e ON e.HOSPCODE = o.hoscode 

LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE,
LEFT(DATE(e.DATE_SERV),7) code_rep,
COUNT(e.SEQ) TM_SERVICE 
FROM ttm_service_tmp e
GROUP BY e.HOSPCODE, MONTH(e.DATE_SERV)
) t ON t.HOSPCODE = e.HOSPCODE AND t.code_rep = e.code_rep

WHERE o.provcode=@provid 
HAVING op_service<>0  ;

/***********************ttm15*****************/
DROP TEMPORARY TABLE IF  EXISTS mother_service_ipd;
CREATE TEMPORARY TABLE IF NOT EXISTS 
mother_service_ipd (INDEX(CID)) 
ENGINE=MYISAM IGNORE AS 
SELECT 
e.HOSPCODE, 
e.PID, 
e.AN SEQ, 
DATE(e.TIMESTART) DATE_SERV,
a.INSTYPE,
GROUP_CONCAT(e.PROCEDCODE) PROCEDCODE,
p.BIRTH,
p.CID,
LENGTH(GROUP_CONCAT(e.PROCEDCODE)) length_str
FROM tmp_procedure_ipd e 
LEFT JOIN tmp_admission a ON e.HOSPCODE = a.HOSPCODE AND e.PID = a.PID AND e.AN = a.AN 
LEFT JOIN person p ON e.HOSPCODE = p.HOSPCODE AND e.PID = p.PID 
WHERE e.PROCEDCODE IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND 
DATE(e.TIMESTART) BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') AND 
p.SEX = 2 
GROUP BY e.HOSPCODE, e.PID, e.AN 
;

DROP TEMPORARY TABLE IF  EXISTS labor_rep;
CREATE TEMPORARY TABLE IF NOT EXISTS 
labor_rep (INDEX(CID)) 
ENGINE=MYISAM  IGNORE AS 
SELECT 
p.CID,
l.BDATE
FROM 
tmp_labor l
LEFT JOIN person p ON l.HOSPCODE = p.HOSPCODE AND l.PID = p.PID  
WHERE 
l.BDATE BETWEEN CONCAT((@rep_year-1),'0701') AND CONCAT(@rep_year,'0930') AND 
p.CID IS NOT NULL 
GROUP BY p.CID 
;

DROP TABLE IF  EXISTS t_ttm_ipd_15;
CREATE TABLE IF NOT EXISTS t_ttm_ipd_15( 
PRIMARY KEY (hospcode,code_rep),
KEY (hospcode),
KEY (code_rep)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT SQL_BIG_RESULT
e.HOSPCODE ,
CONCAT(e.HOSPCODE,'-',e.PID) code_rep,
@rep_year year_rep,
TIMESTAMPDIFF(YEAR,e.BIRTH,e.DATE_SERV) age,
MIN(e.DATE_SERV) begin_date_serv,
COUNT(DISTINCT l.CID) all_mother,
COUNT(IF(e.length_str=39,1,NULL)) have_service,
COUNT(1) all_service,
COUNT(IF(e.PROCEDCODE LIKE '%9007712%',1,NULL)) ttm_service,
IF(DATEDIFF(MIN(e.DATE_SERV),l.BDATE) BETWEEN 0 AND 45,0,1) not_in_time,
IF(DATEDIFF(MAX(e.DATE_SERV),MIN(e.DATE_SERV)) BETWEEN 0 AND 90,0,1) not_less90days,

COUNT(DISTINCT IF(e.INSTYPE='0100',l.CID,NULL)) all_uc_mother,
COUNT(IF(e.length_str=39 AND e.INSTYPE='0100',1,NULL)) uc_have_service,
COUNT(IF(e.INSTYPE='0100',1,NULL)) uc_all_service,
IF(e.INSTYPE='0100',IF(DATEDIFF(MIN(e.DATE_SERV),l.BDATE) BETWEEN 0 AND 45,0,1),0) uc_not_in_time,
IF(e.INSTYPE='0100',IF(DATEDIFF(MAX(e.DATE_SERV),MIN(e.DATE_SERV)) BETWEEN 0 AND 90,0,1),0) uc_not_less90days 
FROM mother_service_ipd e 
LEFT JOIN labor_rep l ON l.CID = e.CID
LEFT JOIN chospital i ON e.HOSPCODE = i.hoscode 
WHERE 
i.provcode=@provid 
GROUP BY e.HOSPCODE, e.PID ;


 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.4586639;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:432;a:5:{i:0;s:35:"DROP PROCEDURE IF EXISTS t_ttm16_20";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.521064;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:435;a:5:{i:0;s:15882:"CREATE PROCEDURE t_ttm16_20()
 BEGIN 
SET @provid = '58';
SET @id:= '68';
SET @rep_year = (SELECT yearprocess FROM sys_config LIMIT 1);
/*************************ttmp16***************/

DROP TABLE IF  EXISTS tmp_drug_ipd;
CREATE TABLE IF NOT EXISTS tmp_drug_ipd(
PRIMARY KEY (`HOSPCODE`,`PID`,`AN`,`DATETIME_ADMIT`,`TYPEDRUG`,`DIDSTD`),
  KEY  (`HOSPCODE`,`PID`),
  KEY (`HOSPCODE`),
  KEY (`DATETIME_ADMIT`),
  KEY (`WARDSTAY`),
  KEY (`TYPEDRUG`),
  KEY (`DIDSTD`),
  KEY (`DATESTART`),
  KEY  (`DATEFINISH`),
  KEY  (`HOSPCODE`,`AN`),
  KEY  (`AN`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT i.*,p.cid FROM drug_ipd i INNER JOIN person p ON i.HOSPCODE=p.HOSPCODE AND i.PID=p.PID
WHERE  DATESTART BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') ;

DROP TABLE IF  EXISTS tmp_planthai_drug_use_ipd;
CREATE  TABLE IF NOT EXISTS 
tmp_planthai_drug_use_ipd (INDEX(HOSPCODE),INDEX(PID),INDEX(SEQ)) 
ENGINE=MYISAM IGNORE AS 
SELECT
e.HOSPCODE,
e.PID,
e.AN SEQ,
e.DATESTART DATE_SERV,
e.DIDSTD,
e.AMOUNT,
e.DRUGPRICE,
e.DRUGCOST,
d.didstd PASS,
d.drug_name,
d.drug_type ,
d.ed
FROM 
tmp_drug_ipd  e 
LEFT JOIN cdrug_planthai d ON d.didstd=e.DIDSTD 
WHERE
e.DATESTART BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIDSTD,2) IN ('41','42') 
;

DROP TABLE IF  EXISTS t_ttm_ipd_16;
CREATE TABLE IF NOT EXISTS t_ttm_ipd_16( 
PRIMARY KEY (hospcode,code_rep),
KEY (hospcode),
KEY (code_rep)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
e.HOSPCODE ,
IFNULL(e.code_rep,CONCAT(@rep_year,'-07')) code_rep,
IFNULL(
IF(e.code_name=1,'มกราคม',
IF(e.code_name=2,'กุมภาพันธ์',
IF(e.code_name=3,'มีนาคม',
IF(e.code_name=4,'เมษายน',
IF(e.code_name=5,'พฤษภาคม',
IF(e.code_name=6,'มิถุนายน',
IF(e.code_name=7,'กรกฏาคม',
IF(e.code_name=8,'สิงหาคม',
IF(e.code_name=9,'กันยายน',
IF(e.code_name=10,'ตุลาคม',
IF(e.code_name=11,'พฤศจิกายน',
'ธันวาคม')))))))))))
,'กรกฏาคม') code_name,
IFNULL(e.year_rep,@rep_year) year_rep,
IFNULL(e.all_visit,0) all_visit,
IFNULL(e.all_drug,0) all_drug,
IFNULL(e.uc_visit,0) uc_visit,
IFNULL(e.uc_drug,0) uc_drug,
IFNULL(e.all_visit_error,0) all_visit_error,
IFNULL(e.all_drug_error,0) all_drug_error,
IFNULL(e.uc_visit_error,0) uc_visit_error,
IFNULL(e.uc_drug_error,0) uc_drug_error
FROM chospital o 
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE, 
LEFT(DATE(e.DATE_SERV),7) code_rep,
MONTH(e.DATE_SERV) code_name,
@rep_year year_rep, 
COUNT(DISTINCT e.SEQ) as all_visit, 
COUNT(*) as all_drug, 
COUNT(DISTINCT (IF(s.INSTYPE='0100',e.SEQ,NULL))) as uc_visit , 
COUNT(IF(s.INSTYPE='0100',1,NULL)) as uc_drug,
COUNT(DISTINCT IF(e.PASS IS NULL,e.SEQ,NULL)) as all_visit_error, 
COUNT(IF(e.PASS IS NULL,e.SEQ,NULL)) as all_drug_error, 
COUNT(DISTINCT (IF(s.INSTYPE='0100' AND e.PASS IS NULL,e.SEQ,NULL))) as uc_visit_error , 
COUNT(IF(s.INSTYPE='0100' AND e.PASS IS NULL,1,NULL)) as uc_drug_error  
FROM 
tmp_planthai_drug_use_ipd e
LEFT JOIN tmp_admission s ON e.HOSPCODE = s.HOSPCODE AND e.PID = s.PID AND e.SEQ = s.AN 
GROUP BY e.HOSPCODE, MONTH(e.DATE_SERV) ) e ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid  AND e.code_rep IS NOT NULL ;

/*************************ttmp17***************/
DROP TABLE IF  EXISTS t_ttm_ipd_17;
CREATE TABLE IF NOT EXISTS t_ttm_ipd_17( 
PRIMARY KEY (hospcode,servplace,age,sex),
KEY (hospcode),
KEY (servplace),
KEY (age),
KEY (sex)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
e.HOSPCODE ,
e.servplace,
e.age,
e.sex,
@rep_year year_rep,

IFNULL(e.total_pt_q1,0) total_pt_q1,	
IFNULL(e.total_q1,0) total_q1,
IFNULL(e.didstd_q1,0) didstd_q1,

IFNULL(e.total_pt_q2,0) total_pt_q2,	
IFNULL(e.total_q2,0) total_q2,
IFNULL(e.didstd_q2,0) didstd_q2,

IFNULL(e.total_pt_q3,0) total_pt_q3,	
IFNULL(e.total_q3,0) total_q3,
IFNULL(e.didstd_q3,0) didstd_q3,	

IFNULL(e.total_pt_q4,0) total_pt_q4,	
IFNULL(e.total_q4,0) total_q4,
IFNULL(e.didstd_q4,0) didstd_q4
FROM chospital o 
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE, 
e.DATE_SERV,
1 servplace,
TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'1001')) age,
p.SEX sex,
@rep_year year_rep, 

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) total_pt_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.SEQ,NULL)) total_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.SEQ,'-',e.DIDSTD),NULL)) didstd_q1,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) total_pt_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.SEQ,NULL)) total_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.SEQ,'-',e.DIDSTD),NULL)) didstd_q2,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) total_pt_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.SEQ,NULL)) total_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.SEQ,'-',e.DIDSTD),NULL)) didstd_q3,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) total_pt_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.SEQ,NULL)) total_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.SEQ,'-',e.DIDSTD),NULL)) didstd_q4 
FROM 
tmp_planthai_drug_use_ipd e
LEFT JOIN tmp_admission s ON e.HOSPCODE = s.HOSPCODE AND e.PID = s.PID AND e.SEQ = s.AN 
INNER JOIN person p ON e.HOSPCODE = p.HOSPCODE AND e.PID = p.PID 
GROUP BY e.HOSPCODE, p.SEX, TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'1001'))
) e ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.HOSPCODE IS NOT NULL ;

/*************************ttmp18***************/
DROP TABLE IF  EXISTS t_ttm_ipd_18;
CREATE TABLE IF NOT EXISTS t_ttm_ipd_18( 
PRIMARY KEY (hospcode,code_rep),
KEY (hospcode),
KEY (code_rep)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
o.hoscode hospcode,
e.didstd code_rep,
IFNULL(CONCAT(e.drug_name,', ',e.drug_type),e.didstd) code_name,
@rep_year year_rep,
IFNULL(e.all_visit,0) all_visit,
IFNULL(e.all_drug,0) all_drug,
IFNULL(e.uc_visit,0) uc_visit,
IFNULL(e.uc_drug,0) uc_drug,
IFNULL(e.all_visit_error,0) all_visit_error,
IFNULL(e.all_drug_error,0) all_drug_error,
IFNULL(e.uc_visit_error,0) uc_visit_error,
IFNULL(e.uc_drug_error,0) uc_drug_error
FROM chospital o 
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE, 
e.DIDSTD didstd,
e.drug_name, 
e.drug_type,
@rep_year year_rep, 
COUNT(DISTINCT e.SEQ) as all_visit, 
COUNT(*) as all_drug, 
COUNT(DISTINCT (IF(s.INSTYPE='0100',e.SEQ,NULL))) as uc_visit , 
COUNT(IF(s.INSTYPE='0100',1,NULL)) as uc_drug,
COUNT(DISTINCT IF(e.PASS IS NULL,e.SEQ,NULL)) as all_visit_error, 
COUNT(IF(e.PASS IS NULL,e.SEQ,NULL)) as all_drug_error, 
COUNT(DISTINCT (IF(s.INSTYPE='0100' AND e.PASS IS NULL,e.SEQ,NULL))) as uc_visit_error , 
COUNT(IF(s.INSTYPE='0100' AND e.PASS IS NULL,1,NULL)) as uc_drug_error  
FROM 
tmp_planthai_drug_use_ipd e
LEFT JOIN tmp_admission s ON e.HOSPCODE = s.HOSPCODE AND e.PID = s.PID AND e.SEQ = s.AN 
GROUP BY e.HOSPCODE, e.DIDSTD 
) e ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.didstd IS NOT NULL ;

/****************ttm19******************/
DROP TABLE IF  EXISTS t_ttm_ipd_19;
CREATE TABLE IF NOT EXISTS t_ttm_ipd_19( 
PRIMARY KEY (hospcode,code_rep),
KEY (hospcode),
KEY (code_rep)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT SQL_BIG_RESULT
e.HOSPCODE ,
LEFT(DATE(e.DATESTART),7) code_rep,
IF(MONTH(e.DATESTART)=1,'มกราคม',
IF(MONTH(e.DATESTART)=2,'กุมภาพันธ์',
IF(MONTH(e.DATESTART)=3,'มีนาคม',
IF(MONTH(e.DATESTART)=4,'เมษายน',
IF(MONTH(e.DATESTART)=5,'พฤษภาคม',
IF(MONTH(e.DATESTART)=6,'มิถุนายน',
IF(MONTH(e.DATESTART)=7,'กรกฏาคม',
IF(MONTH(e.DATESTART)=8,'สิงหาคม',
IF(MONTH(e.DATESTART)=9,'กันยายน',
IF(MONTH(e.DATESTART)=10,'ตุลาคม',
IF(MONTH(e.DATESTART)=11,'พฤศจิกายน',
'ธันวาคม'))))))))))) code_name,
@rep_year year_rep,
SUM(IF(LEFT(e.DIDSTD,2) <> '41' AND LEFT(e.DIDSTD,2) <> '42',e.AMOUNT*e.DRUGPRICE,0))  price_drug ,
SUM(IF(LEFT(e.DIDSTD,2) = '41' OR LEFT(e.DIDSTD,2) = '42',e.AMOUNT*e.DRUGPRICE,0))  price_planthai_drug
FROM 
tmp_drug_ipd e 
LEFT JOIN chospital i ON e.HOSPCODE = i.hoscode 
WHERE e.DATESTART BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930')  AND i.provcode=@provid 
GROUP BY e.HOSPCODE, MONTH(e.DATESTART);

/******************************ttm20******************/
DROP TEMPORARY TABLE IF  EXISTS tmp_planthai_procedure_ipd;
CREATE TEMPORARY TABLE IF NOT EXISTS 
tmp_planthai_procedure_ipd (INDEX(HOSPCODE),INDEX(PID),INDEX(SEQ)) 
ENGINE=MYISAM IGNORE  AS 
SELECT 
e.HOSPCODE, 
e.PID, 
e.AN SEQ, 
DATE(e.TIMESTART) DATE_SERV, 
e.PROCEDCODE, 
icd.tmtype 
FROM 
tmp_procedure_ipd e 
LEFT JOIN cicd9ttm_planthai icd ON icd.`code` = e.PROCEDCODE 
WHERE DATE(e.TIMESTART) BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND icd.`code`IS NOT NULL 
;

DROP TABLE IF  EXISTS t_ttm_ipd_20;
CREATE TABLE IF NOT EXISTS t_ttm_ipd_20( 
PRIMARY KEY (hospcode,instype),
KEY (hospcode),
KEY (instype)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
e.HOSPCODE ,
IF(e.INSTYPE='0100','UC','OTHER') instype,
IFNULL(e.year_rep,@rep_year) year_rep,

IFNULL(e.pt_nod_q1,0) pt_nod_q1,
IFNULL(e.service_nod_q1,0) service_nod_q1,
IFNULL(e.pt_obb_q1,0) pt_obb_q1,
IFNULL(e.service_obb_q1,0) service_obb_q1,
IFNULL(e.pt_cop_q1,0) pt_cop_q1,
IFNULL(e.service_cop_q1,0) service_cop_q1,
IFNULL(e.pt_other_q1,0) pt_other_q1,
IFNULL(e.service_other_q1,0) service_other_q1,
IFNULL(e.pt_total_q1,0) pt_total_q1,
IFNULL(e.service_total_q1,0) service_total_q1,

IFNULL(e.pt_nod_q2,0) pt_nod_q2,
IFNULL(e.service_nod_q2,0) service_nod_q2,
IFNULL(e.pt_obb_q2,0) pt_obb_q2,
IFNULL(e.service_obb_q2,0) service_obb_q2,
IFNULL(e.pt_cop_q2,0) pt_cop_q2,
IFNULL(e.service_cop_q2,0) service_cop_q2,
IFNULL(e.pt_other_q2,0) pt_other_q2,
IFNULL(e.service_other_q2,0) service_other_q2,
IFNULL(e.pt_total_q2,0) pt_total_q2,
IFNULL(e.service_total_q2,0) service_total_q2,

IFNULL(e.pt_nod_q3,0) pt_nod_q3,
IFNULL(e.service_nod_q3,0) service_nod_q3,
IFNULL(e.pt_obb_q3,0) pt_obb_q3,
IFNULL(e.service_obb_q3,0) service_obb_q3,
IFNULL(e.pt_cop_q3,0) pt_cop_q3,
IFNULL(e.service_cop_q3,0) service_cop_q3,
IFNULL(e.pt_other_q3,0) pt_other_q3,
IFNULL(e.service_other_q3,0) service_other_q3,
IFNULL(e.pt_total_q3,0) pt_total_q3,
IFNULL(e.service_total_q3,0) service_total_q3,

IFNULL(e.pt_nod_q4,0) pt_nod_q4,
IFNULL(e.service_nod_q4,0) service_nod_q4,
IFNULL(e.pt_obb_q4,0) pt_obb_q4,
IFNULL(e.service_obb_q4,0) service_obb_q4,
IFNULL(e.pt_cop_q4,0) pt_cop_q4,
IFNULL(e.service_cop_q4,0) service_cop_q4,
IFNULL(e.pt_other_q4,0) pt_other_q4,
IFNULL(e.service_other_q4,0) service_other_q4,
IFNULL(e.pt_total_q4,0) pt_total_q4,
IFNULL(e.service_total_q4,0) service_total_q4
FROM chospital o
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE, 
s.INSTYPE,
1 SERVPLACE,
@rep_year year_rep,  

COUNT(DISTINCT IF(e.tmtype=1 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) pt_nod_q1,
COUNT(DISTINCT IF(e.tmtype=1 AND MONTH(e.DATE_SERV) IN (10,11,12),e.SEQ,NULL)) service_nod_q1,
COUNT(DISTINCT IF(e.tmtype=2 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) pt_obb_q1,
COUNT(DISTINCT IF(e.tmtype=2 AND MONTH(e.DATE_SERV) IN (10,11,12),e.SEQ,NULL)) service_obb_q1,
COUNT(DISTINCT IF(e.tmtype=3 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) pt_cop_q1,
COUNT(DISTINCT IF(e.tmtype=3 AND MONTH(e.DATE_SERV) IN (10,11,12),e.SEQ,NULL)) service_cop_q1,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) pt_other_q1,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND MONTH(e.DATE_SERV) IN (10,11,12),e.SEQ,NULL)) service_other_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) pt_total_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.SEQ,NULL)) service_total_q1,


COUNT(DISTINCT IF(e.tmtype=1 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) pt_nod_q2,
COUNT(DISTINCT IF(e.tmtype=1 AND MONTH(e.DATE_SERV) IN (1,2,3),e.SEQ,NULL)) service_nod_q2,
COUNT(DISTINCT IF(e.tmtype=2 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) pt_obb_q2,
COUNT(DISTINCT IF(e.tmtype=2 AND MONTH(e.DATE_SERV) IN (1,2,3),e.SEQ,NULL)) service_obb_q2,
COUNT(DISTINCT IF(e.tmtype=3 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) pt_cop_q2,
COUNT(DISTINCT IF(e.tmtype=3 AND MONTH(e.DATE_SERV) IN (1,2,3),e.SEQ,NULL)) service_cop_q2,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) pt_other_q2,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND MONTH(e.DATE_SERV) IN (1,2,3),e.SEQ,NULL)) service_other_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) pt_total_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.SEQ,NULL)) service_total_q2,


COUNT(DISTINCT IF(e.tmtype=1 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) pt_nod_q3,
COUNT(DISTINCT IF(e.tmtype=1 AND MONTH(e.DATE_SERV) IN (4,5,6),e.SEQ,NULL)) service_nod_q3,
COUNT(DISTINCT IF(e.tmtype=2 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) pt_obb_q3,
COUNT(DISTINCT IF(e.tmtype=2 AND MONTH(e.DATE_SERV) IN (4,5,6),e.SEQ,NULL)) service_obb_q3,
COUNT(DISTINCT IF(e.tmtype=3 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) pt_cop_q3,
COUNT(DISTINCT IF(e.tmtype=3 AND MONTH(e.DATE_SERV) IN (4,5,6),e.SEQ,NULL)) service_cop_q3,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) pt_other_q3,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND MONTH(e.DATE_SERV) IN (4,5,6),e.SEQ,NULL)) service_other_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) pt_total_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.SEQ,NULL)) service_total_q3,


COUNT(DISTINCT IF(e.tmtype=1 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) pt_nod_q4,
COUNT(DISTINCT IF(e.tmtype=1 AND MONTH(e.DATE_SERV) IN (7,8,9),e.SEQ,NULL)) service_nod_q4,
COUNT(DISTINCT IF(e.tmtype=2 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) pt_obb_q4,
COUNT(DISTINCT IF(e.tmtype=2 AND MONTH(e.DATE_SERV) IN (7,8,9),e.SEQ,NULL)) service_obb_q4,
COUNT(DISTINCT IF(e.tmtype=3 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) pt_cop_q4,
COUNT(DISTINCT IF(e.tmtype=3 AND MONTH(e.DATE_SERV) IN (7,8,9),e.SEQ,NULL)) service_cop_q4,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) pt_other_q4,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND MONTH(e.DATE_SERV) IN (7,8,9),e.SEQ,NULL)) service_other_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) pt_total_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.SEQ,NULL)) service_total_q4,

NOW() 
FROM 
tmp_planthai_procedure_ipd e 
LEFT JOIN tmp_admission s ON s.HOSPCODE = e.HOSPCODE AND s.PID = e.PID AND s.AN = e.SEQ 
GROUP BY e.HOSPCODE,  IF(s.INSTYPE='0100','UC','OTHER') 
) e ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.HOSPCODE IS NOT NULL;


 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.5834639;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:438;a:5:{i:0;s:35:"DROP PROCEDURE IF EXISTS t_ttm21_25";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.630264;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:441;a:5:{i:0;s:19458:"CREATE PROCEDURE t_ttm21_25()
 BEGIN 
SET @provid = '58';
SET @id:= '69';
SET @rep_year = (SELECT yearprocess FROM sys_config LIMIT 1);

/*******************ttm21***********************/
DROP TEMPORARY TABLE IF  EXISTS tmp_planthai_diag_u_ipd;
CREATE TEMPORARY TABLE IF NOT EXISTS 
tmp_planthai_diag_u_ipd (INDEX(HOSPCODE),INDEX(PID),INDEX(SEQ)) 
ENGINE=MYISAM  IGNORE AS 
SELECT 
e.HOSPCODE, 
e.PID, 
e.AN SEQ, 
DATE(e.DATETIME_ADMIT) DATE_SERV, 
e.DIAGCODE, 
d.AN DRUG ,
TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'1001')) age,
p.SEX 
FROM 
tmp_diag_ipd e 
LEFT JOIN person p ON e.HOSPCODE = p.HOSPCODE AND e.PID = p.PID 
LEFT JOIN tmp_drug_ipd d ON d.HOSPCODE = e.HOSPCODE AND d.PID = e.PID AND d.AN = e.AN AND LEFT(d.DIDSTD,2) IN ('41','42') 
WHERE DATE(e.DATETIME_ADMIT) BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIAGCODE,1) = 'U' AND LEFT(e.DIAGCODE,3)<>'U77' 
;

DROP TABLE IF  EXISTS t_ttm_ipd_21;
CREATE TABLE IF NOT EXISTS t_ttm_ipd_21( 
PRIMARY KEY (hospcode,instype,diagcode,age,sex),
KEY (hospcode),
KEY (instype),
KEY (diagcode),
KEY (age),
KEY (sex)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
e.HOSPCODE ,
IF(e.INSTYPE='0100','UC','OTHER') instype,
e.DIAGCODE diagcode,
e.diseasename,
IFNULL(e.year_rep,@rep_year) year_rep,
IFNULL(e.age,0) age,
e.sex,

IFNULL(e.total_pt_q1,0) total_pt_q1,	
IFNULL(e.total_q1,0) total_q1,

IFNULL(e.total_pt_q2,0) total_pt_q2,	
IFNULL(e.total_q2,0) total_q2,

IFNULL(e.total_pt_q3,0) total_pt_q3,	
IFNULL(e.total_q3,0) total_q3,

IFNULL(e.total_pt_q4,0) total_pt_q4,	
IFNULL(e.total_q4,0) total_q4,
IFNULL(e.total_drug,0) total_drug
FROM chospital o
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE, 
s.INSTYPE,
e.DIAGCODE,
IFNULL(d.diseasethai,e.DIAGCODE) diseasename,
@rep_year year_rep,  
e.age age,
e.SEX sex,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) total_pt_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.SEQ,NULL)) total_q1,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) total_pt_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.SEQ,NULL)) total_q2,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) total_pt_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.SEQ,NULL)) total_q3,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) total_pt_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.SEQ,NULL)) total_q4,

COUNT(DISTINCT e.DRUG) total_drug
FROM 
tmp_planthai_diag_u_ipd e 
LEFT JOIN tmp_admission s ON s.HOSPCODE = e.HOSPCODE AND s.PID = e.PID AND s.AN = e.SEQ 
LEFT JOIN cdisease d ON d.diagcode = e.DIAGCODE 
WHERE e.SEX IN (1,2)
GROUP BY e.HOSPCODE, IF(s.INSTYPE='0100','UC','OTHER'), e.DIAGCODE , e.age , e.SEX 
) e ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.HOSPCODE IS NOT NULL ;

/****************************ttm22*********************/
DROP TABLE IF  EXISTS t_ttm_ipd_22;
CREATE TABLE IF NOT EXISTS t_ttm_ipd_22( 
PRIMARY KEY (hospcode,instype),
KEY (hospcode),
KEY (instype)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT SQL_BIG_RESULT 
e.HOSPCODE ,
IF(s.INSTYPE='0100','UC','OTHER') instype,
@rep_year year_rep,

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) ed_pt_q1,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) non_ed_pt_q1,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) other_pt_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) total_pt_q1,	

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (10,11,12),e.SEQ,NULL)) ed_q1,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (10,11,12),e.SEQ,NULL)) non_ed_q1,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (10,11,12),e.SEQ,NULL)) other_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.SEQ,NULL)) total_q1,	

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) ed_pt_q2,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) non_ed_pt_q2,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) other_pt_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) total_pt_q2,	

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (1,2,3),e.SEQ,NULL)) ed_q2,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (1,2,3),e.SEQ,NULL)) non_ed_q2,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (1,2,3),e.SEQ,NULL)) other_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.SEQ,NULL)) total_q2,	

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) ed_pt_q3,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) non_ed_pt_q3,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) other_pt_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) total_pt_q3,	

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (4,5,6),e.SEQ,NULL)) ed_q3,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (4,5,6),e.SEQ,NULL)) non_ed_q3,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (4,5,6),e.SEQ,NULL)) other_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.SEQ,NULL)) total_q3,	
 
COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) ed_pt_q4,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) non_ed_pt_q4,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) other_pt_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) total_pt_q4,	

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (7,8,9),e.SEQ,NULL)) ed_q4,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (7,8,9),e.SEQ,NULL)) non_ed_q4,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (7,8,9),e.SEQ,NULL)) other_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.SEQ,NULL)) total_q4 
FROM 
(
SELECT
e.HOSPCODE,
e.PID,
e.AN SEQ,
e.DATESTART DATE_SERV,
e.DIDSTD,
d.didstd PASS,
d.drug_name,
d.drug_type,
d.ed   
FROM 
tmp_drug_ipd e 
LEFT JOIN cdrug_planthai d ON d.didstd=e.DIDSTD 
WHERE 
e.DATESTART BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIDSTD,2) IN ('41','42') 
) e
LEFT JOIN tmp_admission s ON e.HOSPCODE = s.HOSPCODE AND e.PID = s.PID AND e.SEQ = s.AN 
LEFT JOIN chospital o ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.HOSPCODE IS NOT NULL  AND e.DIDSTD IS NOT NULL 
GROUP BY e.HOSPCODE, IF(s.INSTYPE='0100','UC','OTHER');

/**************************ttm23********************/
DROP TEMPORARY TABLE IF  EXISTS diag_u77_ipd;
CREATE TEMPORARY TABLE IF NOT EXISTS 
diag_u77_ipd (INDEX(pcucode,instype,age)) 
ENGINE=MYISAM IGNORE AS 
SELECT SQL_BIG_RESULT
e.HOSPCODE pcucode, 
IF(s.INSTYPE='0100','UC','OTHER') instype, 
TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'1001')) age,
COUNT(DISTINCT IF(MONTH(e.DATETIME_ADMIT) IN (10,11,12) ,e.AN,NULL)) total_u77_q1,
COUNT(DISTINCT IF(MONTH(e.DATETIME_ADMIT) IN (1,2,3) ,e.AN,NULL)) total_u77_q2,
COUNT(DISTINCT IF(MONTH(e.DATETIME_ADMIT) IN (4,5,6) ,e.AN,NULL)) total_u77_q3,
COUNT(DISTINCT IF(MONTH(e.DATETIME_ADMIT) IN (7,8,9) ,e.AN,NULL)) total_u77_q4,
COUNT(DISTINCT e.AN) total_u77
FROM 
tmp_diag_ipd e 
LEFT JOIN tmp_admission s ON s.HOSPCODE = e.HOSPCODE AND s.PID = e.PID AND s.AN = e.AN 
LEFT JOIN person p ON e.HOSPCODE = p.HOSPCODE AND e.PID = p.PID 
WHERE DATE(e.DATETIME_ADMIT) BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIAGCODE,3) = 'U77' 
GROUP BY e.HOSPCODE,  IF(s.INSTYPE='0100','UC','OTHER'), TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'1001'))
;

DROP TEMPORARY TABLE IF  EXISTS proced_u77_ipd;
CREATE TEMPORARY TABLE IF NOT EXISTS 
proced_u77_ipd (INDEX(pcucode,instype,age)) 
ENGINE=MYISAM IGNORE AS 
SELECT SQL_BIG_RESULT 
e.HOSPCODE pcucode, 
IF(s.INSTYPE='0100','UC','OTHER') instype, 
TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'-10-01')) age,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,e.PID,NULL)) total_planthai_pt_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,e.SEQ,NULL)) total_planthai_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),e.PID,NULL)) total_pt_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),e.SEQ,NULL)) total_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,e.PID,NULL)) total_planthai_pt_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,e.SEQ,NULL)) total_planthai_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),e.PID,NULL)) total_pt_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),e.SEQ,NULL)) total_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,e.PID,NULL)) total_planthai_pt_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,e.SEQ,NULL)) total_planthai_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),e.PID,NULL)) total_pt_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),e.SEQ,NULL)) total_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,e.PID,NULL)) total_planthai_pt_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,e.SEQ,NULL)) total_planthai_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),e.PID,NULL)) total_pt_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),e.SEQ,NULL)) total_q4
FROM 
(
SELECT 
e.HOSPCODE, 
e.PID, 
e.AN SEQ, 
DATE(e.TIMESTART) DATE_SERV, 
e.PROCEDCODE 
FROM 
tmp_procedure_ipd e 
LEFT JOIN tmp_diag_ipd d ON d.HOSPCODE = e.HOSPCODE AND d.PID = e.PID AND d.AN = e.AN 
WHERE DATE(e.TIMESTART) BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007903','9007904','9007998','9007999') 
AND LEFT(d.DIAGCODE,3) = 'U77' 
) e 
LEFT JOIN tmp_admission s ON s.HOSPCODE = e.HOSPCODE AND s.PID = e.PID AND s.AN = e.SEQ 
LEFT JOIN person p ON e.HOSPCODE = p.HOSPCODE AND e.PID = p.PID 
WHERE e.HOSPCODE IS NOT NULL 
GROUP BY e.HOSPCODE,  IF(s.INSTYPE='0100','UC','OTHER'), TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'1001'))
;

DROP TABLE IF  EXISTS t_ttm_ipd_23;
CREATE TABLE IF NOT EXISTS t_ttm_ipd_23( 
PRIMARY KEY (hospcode,instype,age),
KEY (hospcode),
KEY (instype),
KEY (age)
) ENGINE=MyISAM DEFAULT CHARSET=utf8  IGNORE AS
SELECT SQL_BIG_RESULT 
e.pcucode hospcode, 
e.instype, 
e.age,
@rep_year year_rep, 
e.total_u77_q1,
IFNULL(p.total_planthai_pt_q1,0) total_planthai_pt_q1,
IFNULL(p.total_planthai_q1,0) total_planthai_q1,
IFNULL(p.total_pt_q1,0) total_pt_q1,
IFNULL(p.total_q1,0) total_q1,
e.total_u77_q2,
IFNULL(p.total_planthai_pt_q2,0) total_planthai_pt_q2,
IFNULL(p.total_planthai_q2,0) total_planthai_q2,
IFNULL(p.total_pt_q2,0) total_pt_q2,
IFNULL(p.total_q2,0) total_q2,
e.total_u77_q3,
IFNULL(p.total_planthai_pt_q3,0) total_planthai_pt_q3,
IFNULL(p.total_planthai_q3,0) total_planthai_q3,
IFNULL(p.total_pt_q3,0) total_pt_q3,
IFNULL(p.total_q3,0) total_q3,
e.total_u77_q4,
IFNULL(p.total_planthai_pt_q4,0) total_planthai_pt_q4,
IFNULL(p.total_planthai_q4,0) total_planthai_q4,
IFNULL(p.total_pt_q4,0) total_pt_q4,
IFNULL(p.total_q4,0) total_q4,
(IFNULL(p.total_planthai_q1,0)+IFNULL(p.total_planthai_q2,0)+IFNULL(p.total_planthai_q3,0)+IFNULL(p.total_planthai_q4,0)) total_planthai,
(IFNULL(p.total_q1,0)+IFNULL(p.total_q2,0)+IFNULL(p.total_q3,0)+IFNULL(p.total_q4,0)) total_choice,
e.total_u77
FROM 
diag_u77_ipd e 
LEFT JOIN proced_u77_ipd p ON p.pcucode = e.pcucode AND p.instype = e.instype AND p.age = e.age 
LEFT JOIN chospital o ON e.pcucode = o.hoscode 
WHERE o.provcode=@provid ;

/**********************ttm24***************************/
DROP TEMPORARY TABLE IF  EXISTS tmp_planthai_ipd_no_z;
CREATE TEMPORARY TABLE IF NOT EXISTS 
tmp_planthai_ipd_no_z (INDEX(HOSPCODE),INDEX(code_rep)) 
ENGINE=MYISAM IGNORE AS 
SELECT SQL_BIG_RESULT
e.HOSPCODE,
LEFT(DATE(e.DATETIME_ADMIT),7) code_rep,
IF(MONTH(e.DATETIME_ADMIT)=1,'มกราคม',
IF(MONTH(e.DATETIME_ADMIT)=2,'กุมภาพันธ์',
IF(MONTH(e.DATETIME_ADMIT)=3,'มีนาคม',
IF(MONTH(e.DATETIME_ADMIT)=4,'เมษายน',
IF(MONTH(e.DATETIME_ADMIT)=5,'พฤษภาคม',
IF(MONTH(e.DATETIME_ADMIT)=6,'มิถุนายน',
IF(MONTH(e.DATETIME_ADMIT)=7,'กรกฏาคม',
IF(MONTH(e.DATETIME_ADMIT)=8,'สิงหาคม',
IF(MONTH(e.DATETIME_ADMIT)=9,'กันยายน',
IF(MONTH(e.DATETIME_ADMIT)=10,'ตุลาคม',
IF(MONTH(e.DATETIME_ADMIT)=11,'พฤศจิกายน',
'ธันวาคม'))))))))))) code_name, 
COUNT(DISTINCT e.SEQ) OP_SERVICE,
COUNT(DISTINCT e.PID) OP_SERVICE_PT
FROM tmp_admission e 
LEFT JOIN tmp_diag_ipd d ON d.HOSPCODE = e.HOSPCODE AND d.PID = e.PID AND d.AN = e.AN AND DATE(d.DATETIME_ADMIT) BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
WHERE DATE(e.DATETIME_ADMIT) BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(d.DIAGCODE,1) <> 'Z'
GROUP BY e.HOSPCODE, MONTH(e.DATETIME_ADMIT)
;

DROP TEMPORARY TABLE IF  EXISTS tmp_ttm_service_ipd;
CREATE TEMPORARY TABLE IF NOT EXISTS 
tmp_ttm_service_ipd (
`HOSPCODE`  char(5) NOT NULL ,
`PID`  varchar(16) NOT NULL ,
`SEQ`  varchar(16) NOT NULL ,
`DATE_SERV`  date NULL ,
PRIMARY KEY (`HOSPCODE`, `PID`, `SEQ`)
);

INSERT IGNORE INTO tmp_ttm_service_ipd 
SELECT e.HOSPCODE, 
e.PID,
e.AN SEQ, 
DATE(e.DATETIME_ADMIT) DATE_SERV 
FROM tmp_diag_ipd e 
WHERE DATE(e.DATETIME_ADMIT) BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIAGCODE,1) = 'U';

INSERT IGNORE INTO tmp_ttm_service_ipd
SELECT e.HOSPCODE, 
e.PID,
e.AN SEQ, 
e.DATESTART DATE_SERV 
FROM drug_ipd e 
WHERE e.DATESTART BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIDSTD,2) IN ('41','42') ;

INSERT IGNORE INTO tmp_ttm_service_ipd
SELECT e.HOSPCODE, 
e.PID,
e.AN SEQ, 
DATE(e.TIMESTART) DATE_SERV 
FROM tmp_procedure_ipd  e 
LEFT JOIN cicd9ttm_planthai p ON e.PROCEDCODE=p.`code` 
WHERE DATE(e.TIMESTART) BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND p.code IS NOT NULL ;

DROP TABLE IF  EXISTS t_ttm_ipd_24;
CREATE TABLE IF NOT EXISTS t_ttm_ipd_24( 
PRIMARY KEY (hospcode,code_rep),
KEY (hospcode),
KEY (code_rep)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
o.hoscode hospcode,
IFNULL(e.code_rep,CONCAT(@rep_year,'-10')) code_rep,
IFNULL(e.code_name,'ตุลาคม') code_name,
@rep_year year_rep,
IFNULL(e.OP_SERVICE_PT,0) op_service_pt,
IFNULL(e.OP_SERVICE,0) op_service,
IFNULL(t.TM_SERVICE_PT,0) tm_service_pt,
IFNULL(t.TM_SERVICE,0) tm_service
FROM chospital o 
LEFT JOIN 
tmp_planthai_ipd_no_z e ON e.HOSPCODE = o.hoscode 
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE,
LEFT(DATE(e.DATE_SERV),7) code_rep,
COUNT(DISTINCT e.SEQ) TM_SERVICE, 
COUNT(DISTINCT e.PID) TM_SERVICE_PT 
FROM
tmp_ttm_service_ipd e
GROUP BY e.HOSPCODE, LEFT(DATE(e.DATE_SERV),7)
) t ON t.HOSPCODE = e.HOSPCODE AND t.code_rep = e.code_rep

WHERE o.provcode=@provid 
HAVING op_service<>0  ; 

/****************************************ttm25********************/
DROP TABLE IF  EXISTS t_ttm_ipd_25;
CREATE TABLE IF NOT EXISTS t_ttm_ipd_25( 
PRIMARY KEY (hospcode,instype,didstd),
KEY (hospcode),
KEY (instype),
KEY (didstd)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS

SELECT 
o.hoscode hospcode, 
e.didstd, 
IFNULL(CONCAT(e.drug_name,', ',e.drug_type),e.didstd) code_name, 
IF(e.INSTYPE='0100','UC','OTHER') instype, 
@rep_year year_rep, 

IFNULL(e.total_pt_q1,0) total_pt_q1, 
IFNULL(e.total_q1,0) total_q1, 
IFNULL(e.total_amount_q1,0) total_amount_q1, 
IFNULL(e.total_price_q1,0) total_price_q1, 
IFNULL(e.total_cost_q1,0) total_cost_q1, 

IFNULL(e.total_pt_q2,0) total_pt_q2, 
IFNULL(e.total_q2,0) total_q2, 
IFNULL(e.total_amount_q2,0) total_amount_q2, 
IFNULL(e.total_price_q2,0) total_price_q2, 
IFNULL(e.total_cost_q2,0) total_cost_q2, 

IFNULL(e.total_pt_q3,0) total_pt_q3, 
IFNULL(e.total_q3,0) total_q3, 
IFNULL(e.total_amount_q3,0) total_amount_q3, 
IFNULL(e.total_price_q3,0) total_price_q3, 
IFNULL(e.total_cost_q3,0) total_cost_q3, 

IFNULL(e.total_pt_q4,0) total_pt_q4, 
IFNULL(e.total_q4,0) total_q4, 
IFNULL(e.total_amount_q4,0) total_amount_q4, 
IFNULL(e.total_price_q4,0) total_price_q4, 
IFNULL(e.total_cost_q4,0) total_cost_q4 
FROM chospital o 
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE, 
e.DIDSTD didstd,
e.drug_name, 
e.drug_type,
s.INSTYPE,
@rep_year year_rep, 

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) total_pt_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.SEQ,NULL)) total_q1,
SUM(IF(MONTH(e.DATE_SERV) IN (10,11,12),e.AMOUNT,0)) total_amount_q1,
SUM(IF(MONTH(e.DATE_SERV) IN (10,11,12),e.AMOUNT*e.DRUGPRICE,0)) total_price_q1,
SUM(IF(MONTH(e.DATE_SERV) IN (10,11,12),e.AMOUNT*e.DRUGCOST,0)) total_cost_q1,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) total_pt_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.SEQ,NULL)) total_q2,
SUM(IF(MONTH(e.DATE_SERV) IN (1,2,3),e.AMOUNT,0)) total_amount_q2,
SUM(IF(MONTH(e.DATE_SERV) IN (1,2,3),e.AMOUNT*e.DRUGPRICE,0)) total_price_q2,
SUM(IF(MONTH(e.DATE_SERV) IN (1,2,3),e.AMOUNT*e.DRUGCOST,0)) total_cost_q2,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) total_pt_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.SEQ,NULL)) total_q3,
SUM(IF(MONTH(e.DATE_SERV) IN (4,5,6),e.AMOUNT,0)) total_amount_q3,
SUM(IF(MONTH(e.DATE_SERV) IN (4,5,6),e.AMOUNT*e.DRUGPRICE,0)) total_price_q3,
SUM(IF(MONTH(e.DATE_SERV) IN (4,5,6),e.AMOUNT*e.DRUGCOST,0)) total_cost_q3,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) total_pt_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.SEQ,NULL)) total_q4,
SUM(IF(MONTH(e.DATE_SERV) IN (7,8,9),e.AMOUNT,0)) total_amount_q4,
SUM(IF(MONTH(e.DATE_SERV) IN (7,8,9),e.AMOUNT*e.DRUGPRICE,0)) total_price_q4,
SUM(IF(MONTH(e.DATE_SERV) IN (7,8,9),e.AMOUNT*e.DRUGCOST,0)) total_cost_q4

FROM 
 tmp_planthai_drug_use_ipd e
LEFT JOIN tmp_admission s ON e.HOSPCODE = s.HOSPCODE AND e.PID = s.PID AND e.SEQ = s.AN 
GROUP BY e.HOSPCODE,IF(s.INSTYPE='0100','UC','OTHER'), e.DIDSTD 
) e ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.HOSPCODE IS NOT NULL  AND e.didstd IS NOT NULL 



;
 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.6926639;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:444;a:5:{i:0;s:30:"DROP PROCEDURE IF EXISTS t_rdu";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.8018639;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:447;a:5:{i:0;s:2531:"CREATE PROCEDURE t_rdu()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '70';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS tmp_diag_asu;
CREATE TABLE IF NOT EXISTS tmp_diag_asu (
PRIMARY KEY (`HOSPCODE`,`PID`,`SEQ`,`GROUP_ASU_PROJECT`),
KEY(hospcode,pid,seq),
KEY (GROUP_ASU_PROJECT),
KEY(cid),KEY(hospcode),KEY(pid),KEY(seq),KEY(date_serv),KEY(diagcode),KEY(diagtype)
) ENGINE=MyISAM IGNORE  AS
SELECT o.*,a.GROUP_ASU_PROJECT FROM	tmp_diag_opd o INNER JOIN cdiag_asu a 
   ON (SUBSTR(o.DIAGCODE,1,3)=a.`CODE` OR SUBSTR(o.DIAGCODE,1,4)=a.`CODE`)
WHERE	DATE_SERV BETWEEN  @start_d AND @end_d 
GROUP BY HOSPCODE,PID,SEQ,GROUP_ASU_PROJECT;

/***ตรวจสอบการจ่ายยา ไม่มีไม่นับ****/
DELETE o  FROM tmp_diag_asu o LEFT JOIN tmp_drug_opd d ON o.hospcode=d.HOSPCODE AND o.pid=d.pid AND o.seq=d.SEQ
WHERE  d.HOSPCODE is NULL;
/**หาเฉพาะ visit ที่มีการจ่ายยาปฏิชีวนะจะมีกี่ตัวก็แล้วแต่นับมา 1 visit**/
DROP TABLE IF EXISTS tmp_drug_asu;
CREATE TABLE IF NOT EXISTS tmp_drug_asu (
	cid VARCHAR(13) DEFAULT NULL,
	PRIMARY KEY (`HOSPCODE`,`PID`,`SEQ`), 
  KEY (`HOSPCODE`,`PID`,`SEQ`),
  KEY `idx1` (`HOSPCODE`,`PID`),
  KEY `idx2` (`DATE_SERV`),
  KEY `idx4` (`DIDSTD`),
	KEY (cid)
	) ENGINE=MyISAM  AS(
SELECT y.* FROM	tmp_drug_opd y INNER JOIN cdrug_asu s ON SUBSTR(y.DIDSTD,1,19) =SUBSTR(s.drugcode,1,19)
WHERE	DATE_SERV BETWEEN  @start_d AND @end_d
GROUP BY HOSPCODE,PID,SEQ
);

/**หาเฉพาะ AN ที่มีการจ่ายยาปฏิชีวนะตามวันที่จ่ายเพื่อไป mapping กับวันที่คลอด**/
DROP TABLE IF EXISTS tmp_drug_asu_ipd;
CREATE TABLE IF NOT EXISTS tmp_drug_asu_ipd (
	cid VARCHAR(13) DEFAULT NULL,
	PRIMARY KEY (`HOSPCODE`,`PID`,`AN`,`DATETIME_ADMIT`,`TYPEDRUG`,`DIDSTD`),
  KEY (`HOSPCODE`,`PID`,`AN`),
	KEY (`HOSPCODE`,`AN`),
  KEY  (`HOSPCODE`,`PID`),
  KEY  (`DATESTART`),
  KEY  (`DATEFINISH`),
  KEY  (`DIDSTD`),
	KEY (cid)
	) ENGINE=MyISAM  AS(
SELECT y.* FROM	tmp_drug_ipd y INNER JOIN cdrug_asu s ON SUBSTR(y.DIDSTD,1,19) =SUBSTR(s.drugcode,1,19)
WHERE	(DATETIME_ADMIT BETWEEN  @start_d AND @end_d) OR (DATEFINISH  BETWEEN  @start_d AND @end_d)
GROUP BY HOSPCODE,PID,AN,DATETIME_ADMIT,TYPEDRUG,DIDSTD
);

 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.848664;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:450;a:5:{i:0;s:38:"DROP PROCEDURE IF EXISTS t_person_home";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.9110651;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:453;a:5:{i:0;s:414:"CREATE PROCEDURE t_person_home()
 BEGIN 
DROP TABLE IF EXISTS t_person_home;

CREATE TABLE t_person_home (
KEY (cid),
KEY (hospcode,cid),
KEY (hid)
)ENGINE=MyISAM  AS(
SELECT  SQL_BIG_RESULT 
 t.HOSPCODE,t.PID,t.CID ,CONCAT(t.HOSPCODE,t.HID) HID ,h.HOUSE_ID,h.LATITUDE,h.LONGITUDE
FROM t_person_cid t 
LEFT JOIN home h ON t.HOSPCODE = h.HOSPCODE AND t.HID = h.HID
WHERE t.TYPEAREA in (1,3,5)
);
 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.051465;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:456;a:5:{i:0;s:36:"DROP PROCEDURE IF EXISTS t_house_gis";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.0982649;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:459;a:5:{i:0;s:533:"CREATE PROCEDURE t_house_gis()
 BEGIN 
DROP TABLE IF EXISTS t_house_gis;
CREATE TABLE IF NOT EXISTS t_house_gis (
SELECT h.HOSPCODE,h.HID,h.HOUSE_ID,CONCAT(h.CHANGWAT,h.AMPUR,h.TAMBON,h.VILLAGE) AREACODE,h.HEADID
,'' HEAD_NAME,h.HOUSE,h.VILLAGE,h.TAMBON,tmb.tambonname TAMBON_NAMT,h.LATITUDE,h.LONGITUDE 
,if((h.LATITUDE BETWEEN 4 AND 25) and (h.LONGITUDE BETWEEN 95 AND 108),'Y',NULL) GIS
from home h 
LEFT JOIN ctambon_amp tmb on tmb.tamboncodefull = CONCAT(h.CHANGWAT,h.AMPUR,h.TAMBON)
GROUP BY h.HOSPCODE,h.HID
);
 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.1450651;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:462;a:5:{i:0;s:35:"DROP PROCEDURE IF EXISTS t_home_gis";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.191865;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:465;a:5:{i:0;s:197:"CREATE PROCEDURE t_home_gis()
 BEGIN 
REPLACE INTO t_home_gis (
SELECT t.HOSPCODE,CONCAT(t.CHANGWAT,t.AMPUR,t.TAMBON,t.VILLAGE) VCODE,t.HID,t.HOUSE,t.LATITUDE,t.LONGITUDE 
FROM home t
);
 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.2386651;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:468;a:5:{i:0;s:32:"DROP PROCEDURE IF EXISTS tst_pop";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.301065;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:471;a:5:{i:0;s:5601:"CREATE PROCEDURE tst_pop()
 BEGIN 
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS tst_pop;

CREATE TABLE `tst_pop` (
  `cid` varchar(255) NOT NULL,
  `birth` varchar(255) DEFAULT NULL,
  `sex` varchar(255) DEFAULT NULL,
  `s_age` decimal(11,2) DEFAULT NULL,
  `e_age` decimal(11,2) DEFAULT NULL,
  `pop_group` varchar(255) DEFAULT NULL,
  PRIMARY KEY (`cid`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;


REPLACE INTO tst_pop (
SELECT t.CID,t.BIRTH,t.SEX
,TIMESTAMPDIFF(MONTH,t.BIRTH,@start_d)/12
,TIMESTAMPDIFF(MONTH,t.BIRTH,@end_d)/12
,'' FROM t_person_cid t WHERE t.TYPEAREA in (1,3)
AND t.DISCHARGE =9
);

#1
UPDATE tst_pop t,tmp_labor a set t.pop_group = CONCAT(t.pop_group,',',1)
WHERE (a.cid = t.cid) AND (a.BDATE BETWEEN @start_d AND @end_d);

#2
UPDATE tst_pop t,tmp_labor a set t.pop_group = CONCAT(t.pop_group,',',2)
WHERE (a.cid = t.cid) AND a.BTYPE <> '6' AND  (a.BDATE BETWEEN @start_d AND @end_d);

#3
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',3)
WHERE  t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 6 MONTH) AND DATE_SUB(@end_d,INTERVAL 0 MONTH);

#4
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',4)
WHERE  t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 4 MONTH) AND DATE_SUB(@end_d,INTERVAL 4 MONTH);

#5
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',5)
WHERE  t.birth BETWEEN DATE_SUB(@start_d,INTERVAL 5 YEAR) AND DATE_SUB(@end_d,INTERVAL 0 YEAR);

#6
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',6)
WHERE  t.birth > DATE_SUB(@start_d,INTERVAL 7 YEAR);

#7
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',7)
WHERE  t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 1 YEAR) AND DATE_SUB(@end_d,INTERVAL 1 YEAR);

#8
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',8)
WHERE  t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 2 YEAR) AND DATE_SUB(@end_d,INTERVAL 2 YEAR);

#9
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',9)
WHERE  t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 3 YEAR) AND DATE_SUB(@end_d,INTERVAL 3 YEAR);

#10
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',10)
WHERE  t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 5 YEAR) AND DATE_SUB(@end_d,INTERVAL 5 YEAR);

#11
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',11)
WHERE   t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 12 YEAR) AND DATE_SUB(@end_d,INTERVAL 6 YEAR);

#12
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',12)
WHERE   t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 7 YEAR) AND DATE_SUB(@end_d,INTERVAL 7 YEAR);

#13
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',13)
WHERE   t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 8 YEAR) AND DATE_SUB(@end_d,INTERVAL 8 YEAR);

#14
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',14)
WHERE   t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 12 YEAR) AND DATE_SUB(@end_d,INTERVAL 12 YEAR);

#15
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',15)
WHERE   t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 12 YEAR) AND DATE_SUB(@end_d,INTERVAL 6 YEAR);

#16
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',16)
WHERE   t.birth >  DATE_SUB(@start_d,INTERVAL 12 YEAR);

#17
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',17)
WHERE   t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 18 YEAR) AND DATE_SUB(@end_d,INTERVAL 18 YEAR);

#18
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',18)
WHERE   t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 19 YEAR) AND DATE_SUB(@end_d,INTERVAL 15 YEAR)
AND t.sex=2;

#19
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',19)
WHERE   t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 20 YEAR) AND DATE_SUB(@end_d,INTERVAL 15 YEAR)
AND t.sex=2;

#20
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',20)
WHERE   t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 60 YEAR) AND DATE_SUB(@end_d,INTERVAL 30 YEAR)
AND t.sex=2;

#21
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',21)
WHERE   t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 70 YEAR) AND DATE_SUB(@end_d,INTERVAL 30 YEAR)
AND t.sex=2;

#22
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',22)
WHERE   t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 120 YEAR) AND DATE_SUB(@end_d,INTERVAL 35 YEAR);

#23
UPDATE tst_pop t,(
SELECT o.CID,d.codemental FROM tmp_diag_opd o, cdisease d WHERE o.diagcode= d.diagcode AND d.codemental is not NULL
) a SET t.pop_group = CONCAT(t.pop_group,',',23)
WHERE t.cid = a.CID;

#24
UPDATE tst_pop t,(
SELECT t.cid from t_dmht t WHERE  FIND_IN_SET('E',t.t_mix_dx) AND NOT FIND_IN_SET('I',t.t_mix_dx)
) a SET t.pop_group = CONCAT(t.pop_group,',',24)
WHERE t.cid = a.CID;

#25
UPDATE tst_pop t,(
SELECT t.cid from t_dmht t WHERE  FIND_IN_SET('I',t.t_mix_dx) AND NOT FIND_IN_SET('E',t.t_mix_dx)
) a SET t.pop_group = CONCAT(t.pop_group,',',25)
WHERE t.cid = a.CID;

#26
UPDATE tst_pop t,(
SELECT t.cid from t_dmht t WHERE  FIND_IN_SET('E',t.t_mix_dx) AND  FIND_IN_SET('I',t.t_mix_dx)
) a SET t.pop_group = CONCAT(t.pop_group,',',26)
WHERE t.cid = a.CID;

#27
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',27)
WHERE   t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 120 YEAR) AND DATE_SUB(@end_d,INTERVAL 60 YEAR);

#28
UPDATE tst_pop t,(

SELECT t.HOSPCODE,t.PID,p.CID from disability t
LEFT JOIN t_person_cid p on p.HOSPCODE = t.HOSPCODE AND p.PID = t.PID

) a SET t.pop_group = CONCAT(t.pop_group,',',28)
WHERE t.cid = a.CID;
 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.3654649;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:474;a:5:{i:0;s:43:"DROP PROCEDURE IF EXISTS tst_add_cid_to_kpi";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.427866;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:477;a:5:{i:0;s:12947:"CREATE PROCEDURE tst_add_cid_to_kpi()
 BEGIN 
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

#1
DROP TABLE IF EXISTS tst_kpi1;
CREATE TABLE tst_kpi1 (
SELECT @b_year+543 as byear,l.cid ,CURDATE() dupdate
FROM	tmp_labor l  INNER JOIN t_person_anc a ON l.cid=a.cid AND l.bdate =a.bdate AND a.g1_ga <=12
WHERE l.BDATE BETWEEN @start_d AND @end_d  GROUP BY l.cid
);

#2
DROP TABLE IF EXISTS tst_kpi2;
CREATE TABLE tst_kpi2 (
SELECT @b_year+543 as byear,l.cid ,CURDATE() dupdate
FROM	tmp_labor l  INNER JOIN t_person_anc a ON l.cid=a.cid AND l.bdate =a.bdate 
AND a.g1_date is not null AND a.g2_date is not null AND a.g3_date is not null 
AND a.g4_date is not null AND a.g5_date is not null
WHERE l.BDATE BETWEEN @start_d AND @end_d  GROUP BY l.cid
);

#3
DROP TABLE IF EXISTS tst_kpi3;
CREATE TABLE tst_kpi3 (
SELECT @b_year+543 as byear,a.cid ,CURDATE() dupdate
FROM tmp_anc a 
INNER JOIN tmp_drug_opd d on a.cid = d.CID 
AND d.DIDSTD in('201120320037726221781506','201110100019999920381199','101110000003082121781506'
,'201110100019999920381341','201110100019999921881341')
WHERE a.DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY a.cid
);

#4
DROP TABLE IF EXISTS tst_kpi4;
CREATE TABLE tst_kpi4 (
SELECT @b_year+543 as byear,'' cid ,CURDATE() dupdate
);

#5
DROP TABLE IF EXISTS tst_kpi5;
CREATE TABLE tst_kpi5 (
SELECT @b_year+543 as byear,p.cid ,CURDATE() dupdate
FROM prenatal t 
INNER JOIN t_person_cid p ON p.hospcode = t.hospcode AND p.pid = t.pid
WHERE t.HCT_RESULT <= 33  AND t.DATE_HCT BETWEEN @start_d AND @end_d
GROUP BY p.CID
);

#6
DROP TABLE IF EXISTS tst_kpi6;
CREATE TABLE tst_kpi6 (
SELECT @b_year+543 as byear,a.cid ,CURDATE() dupdate
FROM  t_postnatal a 
INNER JOIN tmp_labor l on l.cid = a.cid AND l.BDATE BETWEEN @start_d AND @end_d AND l.BTYPE NOT IN(6)
WHERE a.ppcare1 is not null AND a.ppcare2 is not null AND a.ppcare3 is not null 
GROUP BY l.cid
);

#7
DROP TABLE IF EXISTS tst_kpi7;
CREATE TABLE tst_kpi7 (
SELECT @b_year+543 as byear,t.cid ,CURDATE() dupdate
FROM (
SELECT n.HOSPCODE,n.PID,p.CID,p.BIRTH,n.DATE_SERV,n.FOOD,DATE_FORMAT(n.DATE_SERV,'%m') m
FROM nutrition n INNER JOIN person p ON n.HOSPCODE=p.HOSPCODE AND n.PID=p.PID 
WHERE n.DATE_SERV BETWEEN @start_d AND @end_d AND n.FOOD in('1')
GROUP BY n.HOSPCODE,n.PID
HAVING TIMESTAMPDIFF(MONTH,p.BIRTH,n.DATE_SERV) BETWEEN 0 AND 6 
ORDER BY n.DATE_SERV DESC
) t GROUP BY t.CID
);

#8
DROP TABLE IF EXISTS tst_kpi8;
CREATE TABLE tst_kpi8 (
SELECT @b_year+543 as byear,e.cid ,CURDATE() dupdate
FROM tmp_epi e WHERE e.VACCINETYPE in('401')
AND e.DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY e.cid
);

#9
DROP TABLE IF EXISTS tst_kpi9;
CREATE TABLE tst_kpi9 (
SELECT @b_year+543 as byear,t.cid ,CURDATE() dupdate
FROM t_childdev_specialpp t WHERE (INSTR(t.status1,'1') or INSTR(t.status2,'1'))
AND t.date_serv_first BETWEEN @start_d AND @end_d 
GROUP BY t.cid

);

#10
DROP TABLE IF EXISTS tst_kpi10;
CREATE TABLE tst_kpi10 (
SELECT @b_year+543 as byear,p.cid ,CURDATE() dupdate
FROM t_nutrition_service n 
INNER JOIN t_person_cid p ON p.HOSPCODE = n.hospcode AND p.PID = n.pid
WHERE TIMESTAMPDIFF(YEAR,n.birth,n.DATE_SERV) <= 5
AND nutri2 in(3,4,5) AND nutri3 in(3)
);

#11
DROP TABLE IF EXISTS tst_kpi11;
CREATE TABLE tst_kpi11 (
SELECT @b_year+543 as byear,t.cid ,CURDATE() dupdate
FROM t_childdev_specialpp t 
WHERE t.sp_first ='1B261'
AND t.status2 is not NULL AND t.date_serv_first BETWEEN @start_d AND @end_d 
);

#12
DROP TABLE IF EXISTS tst_kpi12;
CREATE TABLE tst_kpi12 (
SELECT @b_year+543 as byear,n.cid ,CURDATE() dupdate
from t_nutrition05 n
WHERE n.DATE_SERV1  BETWEEN @start_d AND @end_d 
);

#13
DROP TABLE IF EXISTS tst_kpi13;
CREATE TABLE tst_kpi13 (
SELECT @b_year+543 as byear,'' cid ,CURDATE() dupdate
);

#14
DROP TABLE IF EXISTS tst_kpi14;
CREATE TABLE tst_kpi14 (
SELECT @b_year+543 as byear,t1.cid ,CURDATE() dupdate
FROM t_person_epi t1
WHERE t1.bcg_date is not null AND t1.hbv1_date is not null AND t1.opv3_date is not null AND t1.dtp3_date is not null 
AND t1.mmr1_date is not null AND t1.hbv3_date is not null AND t1.ipv2_date is not null
);

#15
DROP TABLE IF EXISTS tst_kpi15;
CREATE TABLE tst_kpi15 (
SELECT @b_year+543 as byear,t1.cid ,CURDATE() dupdate
 FROM t_person_epi t1
WHERE t1.dtp4_date is not null AND t1.opv4_date is not null 
AND ((je1_date is not null and je2_date is not null and je2_date > je1_date) or (j11_date is not null)) 
);

#16
DROP TABLE IF EXISTS tst_kpi16;
CREATE TABLE tst_kpi16 (
SELECT @b_year+543 as byear,t1.cid ,CURDATE() dupdate
 FROM t_person_epi t1
WHERE t1.mmr2_date is not null 
AND ((je1_date is not null AND je2_date is not null AND je3_date is not null 
AND je3_date > je2_date AND je2_date > je1_date)
or (je1_date is not null AND je2_date is not null AND j11_date is not null AND je2_date > je1_date AND j11_date > je2_date)
or (j11_date is not null AND j12_date is not null AND j12_date > j11_date)
or (j11_date is not null AND je1_date is not null AND je1_date > j11_date ))
);

#17
DROP TABLE IF EXISTS tst_kpi17;
CREATE TABLE tst_kpi17 (
SELECT @b_year+543 as byear,t1.cid ,CURDATE() dupdate
 FROM t_person_epi t1
WHERE t1.opv5_date is not null AND t1.dtp5_date is not null 
);

#18
DROP TABLE IF EXISTS tst_kpi18;
CREATE TABLE tst_kpi18 (
SELECT @b_year+543 as byear,p.cid ,CURDATE() dupdate
FROM t_nutrition_service n
INNER JOIN t_person_cid p on p.HOSPCODE= n.hospcode AND p.PID = n.pid
WHERE n.nutri3 in (6)
);

#19
DROP TABLE IF EXISTS tst_kpi19;
CREATE TABLE tst_kpi19 (
SELECT @b_year+543 as byear,p.cid ,CURDATE() dupdate
FROM t_nutrition_service n
INNER JOIN t_person_cid p on p.HOSPCODE= n.hospcode AND p.PID = n.pid
WHERE  nutri2 in(3,4,5) AND nutri3 in(3)

);

#20
DROP TABLE IF EXISTS tst_kpi20;
CREATE TABLE tst_kpi20 (
SELECT @b_year+543 as byear,p.cid ,CURDATE() dupdate
from dental t
INNER JOIN t_person_cid p on p.HOSPCODE = t.HOSPCODE AND p.PID = t.PID
WHERE t.DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY p.CID
);

#21
DROP TABLE IF EXISTS tst_kpi21;
CREATE TABLE tst_kpi21 (
SELECT @b_year+543 as byear,p.cid ,CURDATE() dupdate
FROM procedure_opd t
INNER JOIN t_person_cid p on p.HOSPCODE = t.HOSPCODE AND p.PID = t.PID
WHERE t.DATE_SERV BETWEEN @start_d AND @end_d  
AND t.PROCEDCODE = '2387030'
GROUP BY p.CID
);

#22
DROP TABLE IF EXISTS tst_kpi22;
CREATE TABLE tst_kpi22 (
SELECT @b_year+543 as byear,t1.cid ,CURDATE() dupdate
FROM t_person_epi t1
WHERE t1.mmrs_date IS NOT NULL
);

#23
DROP TABLE IF EXISTS tst_kpi23;
CREATE TABLE tst_kpi23(
SELECT @b_year+543 as byear,'' cid ,CURDATE() dupdate

);

#24
DROP TABLE IF EXISTS tst_kpi24;
CREATE TABLE tst_kpi24(
SELECT @b_year+543 as byear,t1.cid ,CURDATE() dupdate
FROM t_person_epi t1
WHERE t1.dts4_date IS NOT NULL
);

#25
DROP TABLE IF EXISTS tst_kpi25;
CREATE TABLE tst_kpi25(
SELECT @b_year+543 as byear,p.cid ,CURDATE() dupdate
FROM tmp_procedure_opd p
INNER JOIN cwh_dent_icd10tm i ON p.PROCEDCODE=i.ICD10TM 
WHERE DATE_SERV BETWEEN @start_d AND @end_d AND p.CID is not NULL
GROUP BY p.CID 
);

#26
DROP TABLE IF EXISTS tst_kpi26;
CREATE TABLE tst_kpi26(
SELECT @b_year+543 as byear,t.cid ,CURDATE() dupdate
from tmp_diag_opd t WHERE t.DIAGCODE LIKE 'K02%'
AND DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY t.CID
);

#27
DROP TABLE IF EXISTS tst_kpi27;
CREATE TABLE tst_kpi27(
SELECT @b_year+543 as byear,cid ,CURDATE() dupdate
from t_nutrition6up n
WHERE age_ms1 BETWEEN 72 AND 228
AND DATE_SERV1 BETWEEN @start_d AND @end_d
GROUP BY CID
);

#28
DROP TABLE IF EXISTS tst_kpi28;
CREATE TABLE tst_kpi28(
SELECT @b_year+543 as byear,'' cid ,CURDATE() dupdate

);

#29
DROP TABLE IF EXISTS tst_kpi29;
CREATE TABLE tst_kpi29(
SELECT @b_year+543 as byear,'' cid ,CURDATE() dupdate

);

#30
DROP TABLE IF EXISTS tst_kpi30;
CREATE TABLE tst_kpi30(
SELECT @b_year+543 as byear,cid ,CURDATE() dupdate
from (
SELECT d.HOSPCODE,d.PID,d.DIAGCODE,d.DATE_SERV from diagnosis_opd d WHERE LEFT(d.DIAGCODE,4) in ('Z014','Z124') 
AND d.DATE_SERV  BETWEEN DATE_SUB(@start_d,INTERVAL 5 YEAR) AND DATE_SUB(@end_d,INTERVAL 0 YEAR)
) t  INNER JOIN t_person_cid p ON p.HOSPCODE = t.hospcode AND p.PID = t.pid
GROUP BY p.CID
);

#31
DROP TABLE IF EXISTS tst_kpi31;
CREATE TABLE tst_kpi31(
SELECT @b_year+543 as byear,cid ,CURDATE() dupdate
 from (
SELECT d.HOSPCODE,d.PID,d.DIAGCODE,d.DATE_SERV from diagnosis_opd d WHERE LEFT(d.DIAGCODE,4) in ('Z123') 
AND d.DATE_SERV  BETWEEN DATE_SUB(@start_d,INTERVAL 0 YEAR) AND DATE_SUB(@end_d,INTERVAL 0 YEAR)
) t  INNER JOIN t_person_cid p ON p.HOSPCODE = t.hospcode AND p.PID = t.pid
GROUP BY p.CID
);

#32
DROP TABLE IF EXISTS tst_kpi32;
CREATE TABLE tst_kpi32(
SELECT @b_year+543 as byear,cid ,CURDATE() dupdate
from (
SELECT p.HOSPCODE,p.PID,p.CID,p.SEX,n.DATE_SERV,round(n.WAIST_CM) WAIST_CM
,n.WEIGHT,n.HEIGHT,round(n.WEIGHT/((n.HEIGHT/100)*(n.HEIGHT/100)),2) bmi
,if(p.sex='1' AND round(n.WAIST_CM)<=90,1,if(p.sex='2' AND round(n.WAIST_CM)<=80,1,0)) fat
,DATE_FORMAT(n.DATE_SERV,'%m') m
FROM t_ncdscreen n 
INNER JOIN t_person_db p ON n.HOSPCODE=p.HOSPCODE AND n.PID=p.PID 
WHERE 
n.DATE_SERV BETWEEN @start_d AND @end_d 
AND TIMESTAMPDIFF(YEAR,p.BIRTH,n.DATE_SERV)>=35 
GROUP BY p.HOSPCODE,p.PID 
HAVING fat=1
ORDER BY n.DATE_SERV
) t GROUP BY cid
);

#33
DROP TABLE IF EXISTS tst_kpi33;
CREATE TABLE tst_kpi33(
SELECT @b_year+543 as byear,cid ,CURDATE() dupdate
FROM t_person_dm_screen 
WHERE date_screen is not null AND bslevel >70
AND date_screen BETWEEN @start_d AND @end_d
GROUP BY cid
);

#34
DROP TABLE IF EXISTS tst_kpi34;
CREATE TABLE tst_kpi34(
SELECT @b_year+543 as byear,cid ,CURDATE() dupdate
FROM t_person_ht_screen   
WHERE sbp_1>50 AND dbp_1 >50
AND date_screen BETWEEN @start_d AND @end_d
GROUP BY cid
);

#35
DROP TABLE IF EXISTS tst_kpi35;
CREATE TABLE tst_kpi35(
SELECT @b_year+543 as byear,t.cid ,CURDATE() dupdate
FROM tst_pop t 
INNER JOIN tmp_diag_opd d on d.CID = t.cid  AND d.DATE_SERV BETWEEN @start_d AND @end_d
INNER JOIN cdisease c ON d.DIAGCODE = c.diagcode AND c.codemental IS NOT NULL
WHERE FIND_IN_SET('23',t.pop_group)
GROUP BY t.cid
);


#36
DROP TABLE IF EXISTS tst_kpi36;
CREATE TABLE tst_kpi36(
SELECT @b_year+543 as byear,t.cid ,CURDATE() dupdate
from t_chronic t
WHERE date_dx BETWEEN @start_d AND @end_d
AND t.diagcode LIKE 'E%'
GROUP BY t.cid
);

#37
DROP TABLE IF EXISTS tst_kpi37;
CREATE TABLE tst_kpi37(
SELECT @b_year+543 as byear,f.cid ,CURDATE() dupdate
FROM t_chronicfu f 
INNER JOIN t_dmht d ON f.cid=d.cid
WHERE  f.control_dm IN(1) AND f.ld_hba1c BETWEEN @start_d AND @end_d
GROUP BY f.cid
);

#38
DROP TABLE IF EXISTS tst_kpi38;
CREATE TABLE tst_kpi38(
SELECT @b_year+543 as byear,p.cid ,CURDATE() dupdate
FROM tmp_procedure_opd p
INNER JOIN cwh_dent_icd10tm i ON p.PROCEDCODE=i.ICD10TM 
INNER JOIN tst_pop tp ON tp.cid = p.CID AND  FIND_IN_SET('24',tp.pop_group)
WHERE DATE_SERV BETWEEN @start_d AND @end_d AND p.CID is not NULL
GROUP BY p.CID 
);

#39
DROP TABLE IF EXISTS tst_kpi39;
CREATE TABLE tst_kpi39(
SELECT @b_year+543 as byear,t.cid ,CURDATE() dupdate
 FROM t_chronicfu t
INNER JOIN tst_pop p ON p.cid = t.cid AND FIND_IN_SET('24',p.pop_group)
AND t.ld_foot BETWEEN @start_d AND @end_d
GROUP BY t.cid
);


#40
DROP TABLE IF EXISTS tst_kpi40;
CREATE TABLE tst_kpi40(
SELECT @b_year+543 as byear,t.cid ,CURDATE() dupdate
FROM t_chronicfu t
INNER JOIN tst_pop p ON p.cid = t.cid AND FIND_IN_SET('24',p.pop_group)
AND t.ld_retina BETWEEN @start_d AND @end_d
GROUP BY t.cid
);

#41
DROP TABLE IF EXISTS tst_kpi41;
CREATE TABLE tst_kpi41(
SELECT @b_year+543 as byear,t.cid ,CURDATE() dupdate
from t_chronic t
WHERE date_dx BETWEEN @start_d AND @end_d
AND t.diagcode LIKE 'I%'
GROUP BY t.cid
);

#42
DROP TABLE IF EXISTS tst_kpi42;
CREATE TABLE tst_kpi42(
SELECT @b_year+543 as byear,f.cid ,CURDATE() dupdate
FROM t_chronicfu f 
INNER JOIN t_dmht d ON f.cid=d.cid
WHERE  f.control_ht IN(1) AND f.ld_bp1 BETWEEN @start_d AND @end_d
GROUP BY f.cid
);

#43
DROP TABLE IF EXISTS tst_kpi43;
CREATE TABLE tst_kpi43(
SELECT @b_year+543 as byear,t.CID ,CURDATE() dupdate

from t_cvdrisk_fl t WHERE t.L_RISK_SCORE > 0
GROUP BY t.CID

);

#44
DROP TABLE IF EXISTS tst_kpi44;
CREATE TABLE tst_kpi44(
SELECT @b_year+543 as byear,t.CID ,CURDATE() dupdate
FROM t_adl_last_regist t
WHERE t.DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY t.CID

);

#45
DROP TABLE IF EXISTS tst_kpi45;
CREATE TABLE tst_kpi45(
SELECT @b_year+543 as byear,''CID ,CURDATE() dupdate


);

#46
DROP TABLE IF EXISTS tst_kpi46;
CREATE TABLE tst_kpi46(
SELECT @b_year+543 as byear,'' CID ,CURDATE() dupdate


);
 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.4902661;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:480;a:5:{i:0;s:41:"DROP PROCEDURE IF EXISTS t_version_update";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.537066;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:483;a:5:{i:0;s:102:"CREATE PROCEDURE t_version_update()
 BEGIN 
UPDATE sys_version t SET t.version = '2017.01.27';
 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.5994661;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:486;a:5:{i:0;s:35:"DROP PROCEDURE IF EXISTS hdc_all_t;";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.646266;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:150;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:489;a:5:{i:0;s:6477:"CREATE PROCEDURE hdc_all_t()
 BEGIN
# build at 2017-05-17 09:27:29
CALL start_process;
UPDATE sys_check_process t set t.fnc_name = 'hdc_all_t' , t.time = NOW();
TRUNCATE hdc_log;
INSERT INTO hdc_log(p_date,p_name)values(now(),'start');
#start here

INSERT INTO hdc_log(p_date,p_name)values(now(),'t_person');
CALL t_person;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_person_anc');
CALL t_person_anc;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_person_epi');
CALL t_person_epi;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_village');
CALL t_village;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_surveil');
CALL t_surveil;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_pt_surveil');
CALL t_pt_surveil;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_person_sex_age');
CALL t_person_sex_age;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_diagopd');
CALL t_diagopd;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_diagipd');
CALL t_diagipd;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_chronic');
CALL t_chronic;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_dmht');
CALL t_dmht;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_ncdscreen');
CALL t_ncdscreen;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_service');
CALL t_service;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_admission');
CALL t_admission;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_death');
CALL t_death;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_newborn');
CALL t_newborn;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_card');
CALL t_card;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_drug_opd');
CALL t_drug_opd;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_planthai');
CALL t_planthai;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_planthai1');
CALL t_planthai1;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_cmi1');
CALL t_cmi1;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_bp');
CALL t_bp;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_fp');
CALL t_fp;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_charge_opd');
CALL t_charge_opd;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_nation_labor');
CALL t_nation_labor;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_refer');
CALL t_refer;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_childdev1830');
CALL t_childdev1830;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_cmi_referin');
CALL t_cmi_referin;
INSERT INTO hdc_log(p_date,p_name)values(now(),'ws_person_dmht');
CALL ws_person_dmht;
INSERT INTO hdc_log(p_date,p_name)values(now(),'ws_person_nutrition');
CALL ws_person_nutrition;
INSERT INTO hdc_log(p_date,p_name)values(now(),'ws_person_drugallergy');
CALL ws_person_drugallergy;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_cmi_dead');
CALL t_cmi_dead;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_procedure_ipd');
CALL t_procedure_ipd;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_ckd_ill_all');
CALL t_ckd_ill_all;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_influ');
CALL t_influ;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_ckd_service');
CALL t_ckd_service;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_ckd_egfr');
CALL t_ckd_egfr;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_death_hosp');
CALL t_death_hosp;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_labor_abort');
CALL t_labor_abort;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_nutrition05');
CALL t_nutrition05;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_nutrition6');
CALL t_nutrition6;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_nutrition15');
CALL t_nutrition15;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_tb');
CALL t_tb;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_refer_sp5');
CALL t_refer_sp5;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_accident');
CALL t_accident;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_dental');
CALL t_dental;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_all_alien');
CALL t_all_alien;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_alcoholic');
CALL t_alcoholic;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_envocc');
CALL t_envocc;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_refer_4pa');
CALL t_refer_4pa;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_death28pa');
CALL t_death28pa;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_occupat_new');
CALL t_occupat_new;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_person_envocc');
CALL t_person_envocc;
INSERT INTO hdc_log(p_date,p_name)values(now(),'tmp_specialpp');
CALL tmp_specialpp;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_nutrition_service');
CALL t_nutrition_service;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_cvdrisk');
CALL t_cvdrisk;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_screen_last');
CALL t_screen_last;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_adl');
CALL t_adl;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_postnatal');
CALL t_postnatal;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_cigarette');
CALL t_cigarette;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_breast_screen');
CALL t_breast_screen;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_cervix_screen');
CALL t_cervix_screen;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_ttm1_5');
CALL t_ttm1_5;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_ttm6_10');
CALL t_ttm6_10;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_ttm11_15');
CALL t_ttm11_15;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_ttm16_20');
CALL t_ttm16_20;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_ttm21_25');
CALL t_ttm21_25;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_rdu');
CALL t_rdu;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_person_home');
CALL t_person_home;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_house_gis');
CALL t_house_gis;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_home_gis');
CALL t_home_gis;
INSERT INTO hdc_log(p_date,p_name)values(now(),'tst_pop');
CALL tst_pop;
INSERT INTO hdc_log(p_date,p_name)values(now(),'tst_add_cid_to_kpi');
CALL tst_add_cid_to_kpi;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_version_update');
CALL t_version_update;

#end here
INSERT INTO hdc_log(p_date,p_name)values(now(),'end');
CALL end_process; 

 END";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.7086661;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:151;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:492;a:5:{i:0;s:34:"CALL zz_sys_process_running_false;";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.755466;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:152;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:495;a:5:{i:0;s:17:"call hdc_all_t();";i:1;i:4;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988063.76948;i:4;a:1:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:49;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}}}i:497;a:5:{i:0;s:249:"exception 'yii\base\ErrorException' with message 'Maximum execution time of 30 seconds exceeded' in D:\xampp\htdocs\dhdc2\vendor\yiisoft\yii2\db\Command.php:845
Stack trace:
#0 [internal function]: yii\base\ErrorHandler->handleFatalError()
#1 {main}";i:1;i:1;i:2;s:25:"yii\base\ErrorException:1";i:3;d:1494988166.9984879;i:4;a:0:{}}}}s:9:"profiling";a:3:{s:6:"memory";i:7210032;s:4:"time";d:122.73228287696838;s:8:"messages";a:325:{i:11;a:5:{i:0;s:68:"Opening DB connection: mysql:host=localhost;dbname=db_dhdc;port=3306";i:1;i:80;i:2;s:23:"yii\db\Connection::open";i:3;d:1494988044.3318069;i:4;a:1:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:40;s:8:"function";s:3:"one";s:5:"class";s:18:"yii\db\ActiveQuery";s:4:"type";s:2:"->";}}}i:12;a:5:{i:0;s:68:"Opening DB connection: mysql:host=localhost;dbname=db_dhdc;port=3306";i:1;i:96;i:2;s:23:"yii\db\Connection::open";i:3;d:1494988044.3474071;i:4;a:1:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:40;s:8:"function";s:3:"one";s:5:"class";s:18:"yii\db\ActiveQuery";s:4:"type";s:2:"->";}}}i:13;a:5:{i:0;s:35:"SELECT * FROM `sys_process_running`";i:1;i:80;i:2;s:21:"yii\db\Command::query";i:3;d:1494988044.3474071;i:4;a:1:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:40;s:8:"function";s:3:"one";s:5:"class";s:18:"yii\db\ActiveQuery";s:4:"type";s:2:"->";}}}i:14;a:5:{i:0;s:35:"SELECT * FROM `sys_process_running`";i:1;i:96;i:2;s:21:"yii\db\Command::query";i:3;d:1494988044.3474071;i:4;a:1:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:40;s:8:"function";s:3:"one";s:5:"class";s:18:"yii\db\ActiveQuery";s:4:"type";s:2:"->";}}}i:16;a:5:{i:0;s:44:"SHOW FULL COLUMNS FROM `sys_process_running`";i:1;i:80;i:2;s:21:"yii\db\Command::query";i:3;d:1494988044.3474071;i:4;a:1:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:40;s:8:"function";s:3:"one";s:5:"class";s:18:"yii\db\ActiveQuery";s:4:"type";s:2:"->";}}}i:17;a:5:{i:0;s:44:"SHOW FULL COLUMNS FROM `sys_process_running`";i:1;i:96;i:2;s:21:"yii\db\Command::query";i:3;d:1494988044.3474071;i:4;a:1:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:40;s:8:"function";s:3:"one";s:5:"class";s:18:"yii\db\ActiveQuery";s:4:"type";s:2:"->";}}}i:19;a:5:{i:0;s:625:"SELECT
    kcu.constraint_name,
    kcu.column_name,
    kcu.referenced_table_name,
    kcu.referenced_column_name
FROM information_schema.referential_constraints AS rc
JOIN information_schema.key_column_usage AS kcu ON
    (
        kcu.constraint_catalog = rc.constraint_catalog OR
        (kcu.constraint_catalog IS NULL AND rc.constraint_catalog IS NULL)
    ) AND
    kcu.constraint_schema = rc.constraint_schema AND
    kcu.constraint_name = rc.constraint_name
WHERE rc.constraint_schema = database() AND kcu.table_schema = database()
AND rc.table_name = 'sys_process_running' AND kcu.table_name = 'sys_process_running'";i:1;i:80;i:2;s:21:"yii\db\Command::query";i:3;d:1494988044.3474071;i:4;a:1:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:40;s:8:"function";s:3:"one";s:5:"class";s:18:"yii\db\ActiveQuery";s:4:"type";s:2:"->";}}}i:20;a:5:{i:0;s:625:"SELECT
    kcu.constraint_name,
    kcu.column_name,
    kcu.referenced_table_name,
    kcu.referenced_column_name
FROM information_schema.referential_constraints AS rc
JOIN information_schema.key_column_usage AS kcu ON
    (
        kcu.constraint_catalog = rc.constraint_catalog OR
        (kcu.constraint_catalog IS NULL AND rc.constraint_catalog IS NULL)
    ) AND
    kcu.constraint_schema = rc.constraint_schema AND
    kcu.constraint_name = rc.constraint_name
WHERE rc.constraint_schema = database() AND kcu.table_schema = database()
AND rc.table_name = 'sys_process_running' AND kcu.table_name = 'sys_process_running'";i:1;i:96;i:2;s:21:"yii\db\Command::query";i:3;d:1494988044.3474071;i:4;a:1:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:40;s:8:"function";s:3:"one";s:5:"class";s:18:"yii\db\ActiveQuery";s:4:"type";s:2:"->";}}}i:22;a:5:{i:0;s:335:" CREATE TABLE IF NOT EXISTS `sys_transform_all` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `t_name` varchar(100) DEFAULT NULL,
  `t_sql` longtext,
  `active` varchar(1) DEFAULT '1',
  `bycase` varchar(15) DEFAULT NULL,
  `version` varchar(14) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=MyISAM AUTO_INCREMENT=59 DEFAULT CHARSET=utf8; ";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988044.3474071;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:67;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:23;a:5:{i:0;s:335:" CREATE TABLE IF NOT EXISTS `sys_transform_all` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `t_name` varchar(100) DEFAULT NULL,
  `t_sql` longtext,
  `active` varchar(1) DEFAULT '1',
  `bycase` varchar(15) DEFAULT NULL,
  `version` varchar(14) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=MyISAM AUTO_INCREMENT=59 DEFAULT CHARSET=utf8; ";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988044.394208;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:67;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:25;a:5:{i:0;s:27:"TRUNCATE sys_transform_all;";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988049.39604;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:71;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:26;a:5:{i:0;s:27:"TRUNCATE sys_transform_all;";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988049.4428401;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:71;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:28;a:5:{i:0;s:123:"INSERT INTO sys_transform_all (SELECT '',t.t_name,t.t_sql,t.active,t.bycase,t.version FROM sys_transform t  ORDER BY t.id);";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988049.4428401;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:73;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:29;a:5:{i:0;s:123:"INSERT INTO sys_transform_all (SELECT '',t.t_name,t.t_sql,t.active,t.bycase,t.version FROM sys_transform t  ORDER BY t.id);";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988049.583241;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:73;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:31;a:5:{i:0;s:128:"INSERT INTO sys_transform_all (SELECT '',t.t_name,t.t_sql,t.active,t.bycase,t.version FROM sys_transform_plus t  ORDER BY t.id);";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988049.583241;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:75;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:32;a:5:{i:0;s:128:"INSERT INTO sys_transform_all (SELECT '',t.t_name,t.t_sql,t.active,t.bycase,t.version FROM sys_transform_plus t  ORDER BY t.id);";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988049.676841;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:75;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:34;a:5:{i:0;s:24:"SELECT DATABASE() as db;";i:1;i:80;i:2;s:21:"yii\db\Command::query";i:3;d:1494988049.676841;i:4;a:2:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:78;s:8:"function";s:8:"queryOne";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:35;a:5:{i:0;s:24:"SELECT DATABASE() as db;";i:1;i:96;i:2;s:21:"yii\db\Command::query";i:3;d:1494988049.676841;i:4;a:2:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:78;s:8:"function";s:8:"queryOne";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:37;a:5:{i:0;s:44:"select provcode from sys_config_main limit 1";i:1;i:80;i:2;s:21:"yii\db\Command::query";i:3;d:1494988049.676841;i:4;a:2:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:82;s:8:"function";s:8:"queryOne";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:38;a:5:{i:0;s:44:"select provcode from sys_config_main limit 1";i:1;i:96;i:2;s:21:"yii\db\Command::query";i:3;d:1494988049.676841;i:4;a:2:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:82;s:8:"function";s:8:"queryOne";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:40;a:5:{i:0;s:141:" select t.* from sys_transform_all t
WHERE  t.bycase NOT IN ('dbpop')
AND t.t_name NOT IN ('t_update_tb','count_43tables')
ORDER BY t.id ASC ";i:1;i:80;i:2;s:21:"yii\db\Command::query";i:3;d:1494988049.676841;i:4;a:2:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:90;s:8:"function";s:8:"queryAll";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:41;a:5:{i:0;s:141:" select t.* from sys_transform_all t
WHERE  t.bycase NOT IN ('dbpop')
AND t.t_name NOT IN ('t_update_tb','count_43tables')
ORDER BY t.id ASC ";i:1;i:96;i:2;s:21:"yii\db\Command::query";i:3;d:1494988049.692441;i:4;a:2:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:90;s:8:"function";s:8:"queryAll";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:43;a:5:{i:0;s:33:"DROP PROCEDURE IF EXISTS t_person";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988049.692441;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:44;a:5:{i:0;s:33:"DROP PROCEDURE IF EXISTS t_person";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988049.7392409;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:46;a:5:{i:0;s:14780:"CREATE PROCEDURE t_person()
 BEGIN 
SET @prov_c := '58';
SET @id :='3';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);

DROP TABLE IF EXISTS t_person_db;
CREATE TABLE t_person_db (
  HOSPCODE varchar(5) NOT NULL,
  CID varchar(13) DEFAULT NULL,
  PID varchar(15) NOT NULL,
  HID varchar(14) DEFAULT NULL,
  PRENAME varchar(3) NOT NULL DEFAULT '',
  NAME varchar(50) NOT NULL DEFAULT '',
  LNAME varchar(50) NOT NULL DEFAULT '',
  HN varchar(15) DEFAULT NULL,
  SEX varchar(1) NOT NULL DEFAULT '',
  BIRTH date NOT NULL DEFAULT '0000-00-00',
  MSTATUS char(1) DEFAULT NULL,
  OCCUPATION_OLD varchar(3) DEFAULT NULL,
  OCCUPATION_NEW varchar(4) DEFAULT NULL,
  RACE varchar(3) DEFAULT NULL,
  NATION varchar(3) NOT NULL DEFAULT '',
  RELIGION varchar(2) DEFAULT NULL,
  EDUCATION varchar(2) DEFAULT NULL,
  FSTATUS varchar(1) DEFAULT NULL,
  FATHER varchar(13) DEFAULT NULL,
  MOTHER varchar(13) DEFAULT NULL,
  COUPLE varchar(13) DEFAULT NULL,
  VSTATUS varchar(1) DEFAULT NULL,
  MOVEIN date DEFAULT NULL,
  DISCHARGE varchar(1) DEFAULT NULL,
  DDISCHARGE date DEFAULT NULL,
  ABOGROUP varchar(1) DEFAULT NULL,
  RHGROUP varchar(1) DEFAULT NULL,
  LABOR varchar(2) DEFAULT NULL,
  PASSPORT varchar(8) DEFAULT NULL,
  TYPEAREA varchar(1) NOT NULL DEFAULT '',
  D_UPDATE datetime NOT NULL DEFAULT '0000-00-00 00:00:00',
  check_hosp varchar(5) NOT NULL DEFAULT '',
  check_typearea varchar(1) NOT NULL DEFAULT '',
  addr varchar(100) DEFAULT NULL,
	vhid varchar(8) DEFAULT NULL,
  check_vhid varchar(8) DEFAULT NULL,
  maininscl varchar(5) DEFAULT NULL,
  inscl varchar(5) DEFAULT NULL,
	error_code varchar(255) DEFAULT NULL,
  PRIMARY KEY (HOSPCODE,PID),
	KEY (HOSPCODE,PID),
  KEY (HOSPCODE),
  KEY  (PID),
  KEY  (CID),
  KEY (TYPEAREA),
  KEY (check_typearea),
  KEY (vhid),
  KEY  (check_vhid),
  KEY (LABOR),
  KEY (NATION),
  KEY (BIRTH),
  KEY (error_code)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO t_person_db 
(
	HOSPCODE,CID,PID,HID,PRENAME,NAME,LNAME,HN,SEX,BIRTH,MSTATUS,OCCUPATION_OLD,OCCUPATION_NEW,RACE,NATION
	,RELIGION,EDUCATION,FSTATUS,FATHER,MOTHER,COUPLE,VSTATUS,MOVEIN,DISCHARGE,DDISCHARGE,ABOGROUP,RHGROUP,LABOR
	,PASSPORT,TYPEAREA,D_UPDATE,check_hosp,check_typearea,vhid,check_vhid,addr
)
(	SELECT SQL_BIG_RESULT 
				p.HOSPCODE,p.CID,p.PID,p.HID,p.PRENAME,p.NAME,p.LNAME,p.HN,p.SEX,p.BIRTH,p.MSTATUS,p.OCCUPATION_OLD,p.OCCUPATION_NEW
				,p.RACE,p.NATION,p.RELIGION,p.EDUCATION,p.FSTATUS,p.FATHER,p.MOTHER,p.COUPLE,p.VSTATUS,p.MOVEIN,p.DISCHARGE
				,p.DDISCHARGE,p.ABOGROUP,p.RHGROUP,p.LABOR,p.PASSPORT,p.TYPEAREA,p.D_UPDATE,p.HOSPCODE as check_hosp
				,p.TYPEAREA as check_typearea 
				,if(ho.CHANGWAT is not null,concat(ho.CHANGWAT,ho.AMPUR,ho.TAMBON,SUBSTR(CONCAT('00',ho.VILLAGE),-2)),null) as vhid
				,if(ho.CHANGWAT is not null,concat(ho.CHANGWAT,ho.AMPUR,ho.TAMBON,SUBSTR(CONCAT('00',ho.VILLAGE),-2)),null) as check_vhid
				,ho.house as addr
	FROM
		person as p 
		LEFT JOIN home ho ON p.HOSPCODE=ho.HOSPCODE AND p.HID=ho.HID
);


UPDATE t_person_db t,chospital h
			SET t.vhid=concat(h.provcode,h.distcode,h.subdistcode,SUBSTR(CONCAT('00',h.mu),-2))
			,t.check_vhid=concat(h.provcode,h.distcode,h.subdistcode,SUBSTR(CONCAT('00',h.mu),-2))
			,t.addr=h.address
WHERE t.hospcode=h.hoscode AND (t.vhid is null OR t.check_vhid is null) ;



UPDATE t_person_db 
SET error_code =IF(ISNULL(error_code),'PE0001',CONCAT(error_code,',','PE0001') ) 
WHERE  NATION in(99) AND DISCHARGE in(9) AND (cid is null or LENGTH(trim(cid))=0);

UPDATE t_person_db 
SET error_code =IF(ISNULL(error_code),'PE0002',CONCAT(error_code,',','PE0002') ) 
WHERE  NATION in(99) AND DISCHARGE in(9) AND mod11(cid)=0 AND (cid IS NOT null OR LENGTH(TRIM(cid)) >0 );


UPDATE t_person_db p LEFT JOIN chospital h ON p.HOSPCODE=h.hoscode 
SET error_code =IF(ISNULL(error_code),'PE0003',CONCAT(error_code,',','PE0003') ) 
WHERE  NATION in(99) AND DISCHARGE in(9) AND (
substr(cid,1,5) in(hoscode)
OR
CONCAT('0',substr(cid,2,5)) = CONCAT('0',hoscode)
);

UPDATE t_person_db p LEFT JOIN chospital h ON p.HOSPCODE=h.hoscode 
SET error_code =IF(ISNULL(error_code),'PE0004',CONCAT(error_code,',','PE0004') ) 
WHERE  NATION in(99) AND DISCHARGE in(9) 
AND (`NAME`  LIKE '%พม่า%' OR LNAME  LIKE '%พม่า%' 
					OR `NAME`  LIKE '%ลาว%' OR LNAME  LIKE '%ลาว%'  
				 OR `NAME`  LIKE '%เขมร%' OR LNAME  LIKE '%เขมร%'  
				 OR `NAME`  LIKE '%กัมพูชา%' OR LNAME  LIKE '%กัมพูชา%'  
				 OR `NAME`  LIKE '%มอญ%' OR LNAME  LIKE '%มอญ%'  
				 OR `NAME`  LIKE '%กระเหรี่ยง%' OR LNAME  LIKE '%กระเหรี่ยง%'  
				 OR `NAME`  LIKE '%กะเหรี่ยง%' OR LNAME  LIKE '%กะเหรี่ยง%'  
				 OR `NAME`  LIKE '%ญวน%' OR LNAME  LIKE '%ญวน%'  
				 OR `NAME`  LIKE '%อาข่า%' OR LNAME  LIKE '%อาข่า%'  
				 OR `NAME`  LIKE '%เวียดนาม%' OR LNAME  LIKE '%เวียดนาม%'  
				 OR `NAME`  LIKE '%ชาวเขา%' OR LNAME  LIKE '%ชาวเขา%'  
OR UPPER(`NAME`) REGEXP '^[A-Z]' OR UPPER(LNAME) REGEXP '^[A-Z]' 
				)
AND (
substr(cid,1,5) in(hoscode)
OR
CONCAT('0',substr(cid,2,5)) = CONCAT('0',hoscode)
);

UPDATE t_person_db p LEFT JOIN home h ON p.HOSPCODE=h.HOSPCODE AND p.HID=h.HID
SET error_code =IF(ISNULL(error_code),'PE0005',CONCAT(error_code,',','PE0005') ) 
WHERE   DISCHARGE in(9) AND TYPEAREA in(1,3) AND h.HOSPCODE is null;

UPDATE t_person_db 
SET error_code =IF(ISNULL(error_code),'PE0006',CONCAT(error_code,',','PE0006') ) 
WHERE   DISCHARGE in(9) AND (sex NOT in(1,2) OR sex is null);

UPDATE t_person_db 
SET error_code =IF(ISNULL(error_code),'PE0007',CONCAT(error_code,',','PE0007') ) 
WHERE   DISCHARGE in(9) AND TYPEAREA in(1,3)  
AND ( TIMESTAMPDIFF(year,BIRTH,NOW()) >100  
	OR BIRTH > NOW()  );

UPDATE t_person_db 
SET error_code =IF(ISNULL(error_code),'PE0008',CONCAT(error_code,',','PE0008') ) 
WHERE   DISCHARGE in(9) AND NATION NOT IN(99) AND (LENGTH(TRIM(LABOR)) =0   OR LABOR is null);

UPDATE t_person_db p LEFT JOIN chospital h ON p.HOSPCODE=h.hoscode 
SET error_code =IF(ISNULL(error_code),'PE0009',CONCAT(error_code,',','PE0009') ) 
WHERE   h.hoscode is null;

UPDATE t_person_db p 
SET error_code =IF(ISNULL(error_code),'PE0011',CONCAT(error_code,',','PE0011') ) 
WHERE   mstatus  in(6) AND  p.prename NOT BETWEEN 800 AND  959;

UPDATE t_person_db p 
SET error_code =IF(ISNULL(error_code),'PE0012',CONCAT(error_code,',','PE0012') ) 
WHERE   mstatus not in(6) AND (p.prename BETWEEN 800 AND 862 OR  p.prename BETWEEN 865 AND 959);

UPDATE t_person_db p 
SET error_code =IF(ISNULL(error_code),'PE0013',CONCAT(error_code,',','PE0013') ) 
WHERE   sex not in(1) AND (p.prename BETWEEN 800 AND 862 OR  p.prename BETWEEN 865 AND 959);

UPDATE t_person_db p 
SET error_code =IF(ISNULL(error_code),'PE0014',CONCAT(error_code,',','PE0014') ) 
WHERE  sex not in(1) AND mstatus  in(6);

DROP TABLE IF EXISTS t_person_cid;
CREATE TABLE t_person_cid (
  HOSPCODE varchar(5) NOT NULL DEFAULT '',
  CID varchar(13) not null,
  PID varchar(15) NOT NULL DEFAULT '',
  HID varchar(14) DEFAULT NULL,
  PRENAME varchar(3) NOT NULL DEFAULT '',
  NAME varchar(50) NOT NULL DEFAULT '',
  LNAME varchar(50) NOT NULL DEFAULT '',
  HN varchar(15) DEFAULT NULL,
  SEX varchar(1) NOT NULL DEFAULT '',
  BIRTH date NOT NULL DEFAULT '0000-00-00',
  MSTATUS char(1) DEFAULT NULL,
  OCCUPATION_OLD varchar(3) DEFAULT NULL,
  OCCUPATION_NEW varchar(4) DEFAULT NULL,
  RACE varchar(3) DEFAULT NULL,
  NATION varchar(3) NOT NULL DEFAULT '',
  RELIGION varchar(2) DEFAULT NULL,
  EDUCATION varchar(2) DEFAULT NULL,
  FSTATUS varchar(1) DEFAULT NULL,
  FATHER varchar(13) DEFAULT NULL,
  MOTHER varchar(13) DEFAULT NULL,
  COUPLE varchar(13) DEFAULT NULL,
  VSTATUS varchar(1) DEFAULT NULL,
  MOVEIN date DEFAULT NULL,
  DISCHARGE varchar(1) DEFAULT NULL,
  DDISCHARGE date DEFAULT NULL,
  ABOGROUP varchar(1) DEFAULT NULL,
  RHGROUP varchar(1) DEFAULT NULL,
  LABOR varchar(2) DEFAULT NULL,
  PASSPORT varchar(8) DEFAULT NULL,
  TYPEAREA varchar(1) NOT NULL DEFAULT '',
  D_UPDATE datetime NOT NULL DEFAULT '0000-00-00 00:00:00',
  check_hosp varchar(5) NOT NULL DEFAULT '',
  check_typearea varchar(1) NOT NULL DEFAULT '',
  vhid varchar(8) DEFAULT NULL,
  check_vhid varchar(8) DEFAULT NULL,
  maininscl varchar(5) DEFAULT NULL,
  inscl varchar(5) DEFAULT NULL,
  age_y int(3) DEFAULT NULL,
	addr varchar(100) DEFAULT NULL,
  PRIMARY KEY (CID),
  KEY HOSPCODE_PID (HOSPCODE,PID),
  KEY HOSPCODE (HOSPCODE),
  KEY PID (PID),
  KEY TYPEAREA (TYPEAREA),
  KEY vhid (vhid),
  KEY check_vhid (check_vhid),
  KEY check_typearea (check_typearea),
  KEY check_hosp (check_hosp),
  KEY BIRTH (BIRTH),
  KEY LABOR (LABOR),
  KEY NATION (NATION)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;


INSERT IGNORE INTO t_person_cid
(
		SELECT SQL_BIG_RESULT 
				p.HOSPCODE,p.CID,p.PID,p.HID,p.PRENAME,p.NAME,p.LNAME,p.HN,p.SEX,p.BIRTH
				,p.MSTATUS,p.OCCUPATION_OLD,p.OCCUPATION_NEW,p.RACE,p.NATION,p.RELIGION,p.EDUCATION,p.FSTATUS
				,p.FATHER,p.MOTHER,p.COUPLE,p.VSTATUS,p.MOVEIN,p.DISCHARGE
				,p.DDISCHARGE,p.ABOGROUP,p.RHGROUP,p.LABOR,p.PASSPORT,p.TYPEAREA,p.D_UPDATE,
				p.HOSPCODE as check_hosp	,p.TYPEAREA as check_typearea ,vhid,check_vhid,maininscl,inscl
				,age(DATE_FORMAT(CONCAT(@b_year,'0101'),'%Y%m%d'),birth,'y') as age_y,p.addr
				
		FROM
			t_person_db p
		WHERE LENGTH(TRIM(p.cid))=13 AND p.TYPEAREA in('1','3')
		ORDER BY  p.D_UPDATE DESC ,p.TYPEAREA ASC
);

INSERT IGNORE INTO t_person_cid
(
		SELECT SQL_BIG_RESULT 
				p.HOSPCODE,p.CID,p.PID,p.HID,p.PRENAME,p.NAME,p.LNAME,p.HN,p.SEX,p.BIRTH
				,p.MSTATUS,p.OCCUPATION_OLD,p.OCCUPATION_NEW,p.RACE,p.NATION,p.RELIGION,p.EDUCATION,p.FSTATUS
				,p.FATHER,p.MOTHER,p.COUPLE,p.VSTATUS,p.MOVEIN,p.DISCHARGE
				,p.DDISCHARGE,p.ABOGROUP,p.RHGROUP,p.LABOR,p.PASSPORT,p.TYPEAREA,p.D_UPDATE,
				p.HOSPCODE as check_hosp	,p.TYPEAREA as check_typearea ,vhid,check_vhid,maininscl,inscl
				,age(DATE_FORMAT(CONCAT(@b_year,'0101'),'%Y%m%d'),birth,'y') as age_y,p.addr
		FROM
			t_person_db p
		WHERE LENGTH(TRIM(p.cid))=13 AND p.TYPEAREA in('2','4','5')
		ORDER BY p.TYPEAREA ASC
);

#################################
UPDATE  t_person_db  pd INNER JOIN t_person_cid p ON pd.CID=p.CID 
LEFT JOIN address a ON pd.HOSPCODE=a.HOSPCODE AND pd.PID=a.PID
SET pd.error_code =IF(ISNULL(pd.error_code),'PE0015',CONCAT(pd.error_code,',','PE0015') ) 
WHERE  p.check_typearea in(4,5) AND p.DISCHARGE in(9) AND a.CHANGWAT in(@prov_c);

DROP TABLE IF EXISTS tmpz_error_person;
CREATE TABLE IF NOT EXISTS tmpz_error_person (error_name text ,KEY (hospcode,pid),KEY(cid),key(error_code) )
ENGINE=myisam DEFAULT CHARSET=utf8 as(
SELECT
HOSPCODE,PID,cid
,SUBSTRING_INDEX(p.error_code,',',1) error_code
,null as error_name
FROM t_person_db p WHERE 
error_code is not null
);
INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',2),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*2)+1 ;

INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',3),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*3)+2 ;
 
INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',4),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*4)+3 ;

INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',5),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*5)+4 ;

INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',6),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*6)+5 ;

INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',7),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*7)+6 ;

INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',8),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*8)+7 ;

INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',9),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*9)+8 ;

INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',10),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*10)+9 ;

INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',11),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*11)+10 ;

INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',12),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*12)+11 ;

INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',13),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*13)+12 ;

INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',14),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*14)+13 ;

INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',15),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*15)+14 ;

UPDATE tmpz_error_person p INNER JOIN cerror_new c ON p.error_code=c.err_code 
SET p.error_name=c.err_name;

DROP TABLE IF EXISTS tmp_exchange_person;
CREATE TABLE IF NOT EXISTS tmp_exchange_person (error_code VARCHAR(255),KEY (hospcode,pid),KEY(cid),KEY(error_code))
ENGINE=myisam DEFAULT CHARSET=utf8 as(
SELECT
HOSPCODE,PID,cid,GROUP_CONCAT(error_code separator ' :: ') error_code, GROUP_CONCAT(error_name separator ' :: ') error_name
FROM tmpz_error_person 
GROUP BY HOSPCODE,PID
);
DROP TABLE IF EXISTS tmpz_error_person;


 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988049.7392409;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:47;a:5:{i:0;s:14780:"CREATE PROCEDURE t_person()
 BEGIN 
SET @prov_c := '58';
SET @id :='3';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);

DROP TABLE IF EXISTS t_person_db;
CREATE TABLE t_person_db (
  HOSPCODE varchar(5) NOT NULL,
  CID varchar(13) DEFAULT NULL,
  PID varchar(15) NOT NULL,
  HID varchar(14) DEFAULT NULL,
  PRENAME varchar(3) NOT NULL DEFAULT '',
  NAME varchar(50) NOT NULL DEFAULT '',
  LNAME varchar(50) NOT NULL DEFAULT '',
  HN varchar(15) DEFAULT NULL,
  SEX varchar(1) NOT NULL DEFAULT '',
  BIRTH date NOT NULL DEFAULT '0000-00-00',
  MSTATUS char(1) DEFAULT NULL,
  OCCUPATION_OLD varchar(3) DEFAULT NULL,
  OCCUPATION_NEW varchar(4) DEFAULT NULL,
  RACE varchar(3) DEFAULT NULL,
  NATION varchar(3) NOT NULL DEFAULT '',
  RELIGION varchar(2) DEFAULT NULL,
  EDUCATION varchar(2) DEFAULT NULL,
  FSTATUS varchar(1) DEFAULT NULL,
  FATHER varchar(13) DEFAULT NULL,
  MOTHER varchar(13) DEFAULT NULL,
  COUPLE varchar(13) DEFAULT NULL,
  VSTATUS varchar(1) DEFAULT NULL,
  MOVEIN date DEFAULT NULL,
  DISCHARGE varchar(1) DEFAULT NULL,
  DDISCHARGE date DEFAULT NULL,
  ABOGROUP varchar(1) DEFAULT NULL,
  RHGROUP varchar(1) DEFAULT NULL,
  LABOR varchar(2) DEFAULT NULL,
  PASSPORT varchar(8) DEFAULT NULL,
  TYPEAREA varchar(1) NOT NULL DEFAULT '',
  D_UPDATE datetime NOT NULL DEFAULT '0000-00-00 00:00:00',
  check_hosp varchar(5) NOT NULL DEFAULT '',
  check_typearea varchar(1) NOT NULL DEFAULT '',
  addr varchar(100) DEFAULT NULL,
	vhid varchar(8) DEFAULT NULL,
  check_vhid varchar(8) DEFAULT NULL,
  maininscl varchar(5) DEFAULT NULL,
  inscl varchar(5) DEFAULT NULL,
	error_code varchar(255) DEFAULT NULL,
  PRIMARY KEY (HOSPCODE,PID),
	KEY (HOSPCODE,PID),
  KEY (HOSPCODE),
  KEY  (PID),
  KEY  (CID),
  KEY (TYPEAREA),
  KEY (check_typearea),
  KEY (vhid),
  KEY  (check_vhid),
  KEY (LABOR),
  KEY (NATION),
  KEY (BIRTH),
  KEY (error_code)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO t_person_db 
(
	HOSPCODE,CID,PID,HID,PRENAME,NAME,LNAME,HN,SEX,BIRTH,MSTATUS,OCCUPATION_OLD,OCCUPATION_NEW,RACE,NATION
	,RELIGION,EDUCATION,FSTATUS,FATHER,MOTHER,COUPLE,VSTATUS,MOVEIN,DISCHARGE,DDISCHARGE,ABOGROUP,RHGROUP,LABOR
	,PASSPORT,TYPEAREA,D_UPDATE,check_hosp,check_typearea,vhid,check_vhid,addr
)
(	SELECT SQL_BIG_RESULT 
				p.HOSPCODE,p.CID,p.PID,p.HID,p.PRENAME,p.NAME,p.LNAME,p.HN,p.SEX,p.BIRTH,p.MSTATUS,p.OCCUPATION_OLD,p.OCCUPATION_NEW
				,p.RACE,p.NATION,p.RELIGION,p.EDUCATION,p.FSTATUS,p.FATHER,p.MOTHER,p.COUPLE,p.VSTATUS,p.MOVEIN,p.DISCHARGE
				,p.DDISCHARGE,p.ABOGROUP,p.RHGROUP,p.LABOR,p.PASSPORT,p.TYPEAREA,p.D_UPDATE,p.HOSPCODE as check_hosp
				,p.TYPEAREA as check_typearea 
				,if(ho.CHANGWAT is not null,concat(ho.CHANGWAT,ho.AMPUR,ho.TAMBON,SUBSTR(CONCAT('00',ho.VILLAGE),-2)),null) as vhid
				,if(ho.CHANGWAT is not null,concat(ho.CHANGWAT,ho.AMPUR,ho.TAMBON,SUBSTR(CONCAT('00',ho.VILLAGE),-2)),null) as check_vhid
				,ho.house as addr
	FROM
		person as p 
		LEFT JOIN home ho ON p.HOSPCODE=ho.HOSPCODE AND p.HID=ho.HID
);


UPDATE t_person_db t,chospital h
			SET t.vhid=concat(h.provcode,h.distcode,h.subdistcode,SUBSTR(CONCAT('00',h.mu),-2))
			,t.check_vhid=concat(h.provcode,h.distcode,h.subdistcode,SUBSTR(CONCAT('00',h.mu),-2))
			,t.addr=h.address
WHERE t.hospcode=h.hoscode AND (t.vhid is null OR t.check_vhid is null) ;



UPDATE t_person_db 
SET error_code =IF(ISNULL(error_code),'PE0001',CONCAT(error_code,',','PE0001') ) 
WHERE  NATION in(99) AND DISCHARGE in(9) AND (cid is null or LENGTH(trim(cid))=0);

UPDATE t_person_db 
SET error_code =IF(ISNULL(error_code),'PE0002',CONCAT(error_code,',','PE0002') ) 
WHERE  NATION in(99) AND DISCHARGE in(9) AND mod11(cid)=0 AND (cid IS NOT null OR LENGTH(TRIM(cid)) >0 );


UPDATE t_person_db p LEFT JOIN chospital h ON p.HOSPCODE=h.hoscode 
SET error_code =IF(ISNULL(error_code),'PE0003',CONCAT(error_code,',','PE0003') ) 
WHERE  NATION in(99) AND DISCHARGE in(9) AND (
substr(cid,1,5) in(hoscode)
OR
CONCAT('0',substr(cid,2,5)) = CONCAT('0',hoscode)
);

UPDATE t_person_db p LEFT JOIN chospital h ON p.HOSPCODE=h.hoscode 
SET error_code =IF(ISNULL(error_code),'PE0004',CONCAT(error_code,',','PE0004') ) 
WHERE  NATION in(99) AND DISCHARGE in(9) 
AND (`NAME`  LIKE '%พม่า%' OR LNAME  LIKE '%พม่า%' 
					OR `NAME`  LIKE '%ลาว%' OR LNAME  LIKE '%ลาว%'  
				 OR `NAME`  LIKE '%เขมร%' OR LNAME  LIKE '%เขมร%'  
				 OR `NAME`  LIKE '%กัมพูชา%' OR LNAME  LIKE '%กัมพูชา%'  
				 OR `NAME`  LIKE '%มอญ%' OR LNAME  LIKE '%มอญ%'  
				 OR `NAME`  LIKE '%กระเหรี่ยง%' OR LNAME  LIKE '%กระเหรี่ยง%'  
				 OR `NAME`  LIKE '%กะเหรี่ยง%' OR LNAME  LIKE '%กะเหรี่ยง%'  
				 OR `NAME`  LIKE '%ญวน%' OR LNAME  LIKE '%ญวน%'  
				 OR `NAME`  LIKE '%อาข่า%' OR LNAME  LIKE '%อาข่า%'  
				 OR `NAME`  LIKE '%เวียดนาม%' OR LNAME  LIKE '%เวียดนาม%'  
				 OR `NAME`  LIKE '%ชาวเขา%' OR LNAME  LIKE '%ชาวเขา%'  
OR UPPER(`NAME`) REGEXP '^[A-Z]' OR UPPER(LNAME) REGEXP '^[A-Z]' 
				)
AND (
substr(cid,1,5) in(hoscode)
OR
CONCAT('0',substr(cid,2,5)) = CONCAT('0',hoscode)
);

UPDATE t_person_db p LEFT JOIN home h ON p.HOSPCODE=h.HOSPCODE AND p.HID=h.HID
SET error_code =IF(ISNULL(error_code),'PE0005',CONCAT(error_code,',','PE0005') ) 
WHERE   DISCHARGE in(9) AND TYPEAREA in(1,3) AND h.HOSPCODE is null;

UPDATE t_person_db 
SET error_code =IF(ISNULL(error_code),'PE0006',CONCAT(error_code,',','PE0006') ) 
WHERE   DISCHARGE in(9) AND (sex NOT in(1,2) OR sex is null);

UPDATE t_person_db 
SET error_code =IF(ISNULL(error_code),'PE0007',CONCAT(error_code,',','PE0007') ) 
WHERE   DISCHARGE in(9) AND TYPEAREA in(1,3)  
AND ( TIMESTAMPDIFF(year,BIRTH,NOW()) >100  
	OR BIRTH > NOW()  );

UPDATE t_person_db 
SET error_code =IF(ISNULL(error_code),'PE0008',CONCAT(error_code,',','PE0008') ) 
WHERE   DISCHARGE in(9) AND NATION NOT IN(99) AND (LENGTH(TRIM(LABOR)) =0   OR LABOR is null);

UPDATE t_person_db p LEFT JOIN chospital h ON p.HOSPCODE=h.hoscode 
SET error_code =IF(ISNULL(error_code),'PE0009',CONCAT(error_code,',','PE0009') ) 
WHERE   h.hoscode is null;

UPDATE t_person_db p 
SET error_code =IF(ISNULL(error_code),'PE0011',CONCAT(error_code,',','PE0011') ) 
WHERE   mstatus  in(6) AND  p.prename NOT BETWEEN 800 AND  959;

UPDATE t_person_db p 
SET error_code =IF(ISNULL(error_code),'PE0012',CONCAT(error_code,',','PE0012') ) 
WHERE   mstatus not in(6) AND (p.prename BETWEEN 800 AND 862 OR  p.prename BETWEEN 865 AND 959);

UPDATE t_person_db p 
SET error_code =IF(ISNULL(error_code),'PE0013',CONCAT(error_code,',','PE0013') ) 
WHERE   sex not in(1) AND (p.prename BETWEEN 800 AND 862 OR  p.prename BETWEEN 865 AND 959);

UPDATE t_person_db p 
SET error_code =IF(ISNULL(error_code),'PE0014',CONCAT(error_code,',','PE0014') ) 
WHERE  sex not in(1) AND mstatus  in(6);

DROP TABLE IF EXISTS t_person_cid;
CREATE TABLE t_person_cid (
  HOSPCODE varchar(5) NOT NULL DEFAULT '',
  CID varchar(13) not null,
  PID varchar(15) NOT NULL DEFAULT '',
  HID varchar(14) DEFAULT NULL,
  PRENAME varchar(3) NOT NULL DEFAULT '',
  NAME varchar(50) NOT NULL DEFAULT '',
  LNAME varchar(50) NOT NULL DEFAULT '',
  HN varchar(15) DEFAULT NULL,
  SEX varchar(1) NOT NULL DEFAULT '',
  BIRTH date NOT NULL DEFAULT '0000-00-00',
  MSTATUS char(1) DEFAULT NULL,
  OCCUPATION_OLD varchar(3) DEFAULT NULL,
  OCCUPATION_NEW varchar(4) DEFAULT NULL,
  RACE varchar(3) DEFAULT NULL,
  NATION varchar(3) NOT NULL DEFAULT '',
  RELIGION varchar(2) DEFAULT NULL,
  EDUCATION varchar(2) DEFAULT NULL,
  FSTATUS varchar(1) DEFAULT NULL,
  FATHER varchar(13) DEFAULT NULL,
  MOTHER varchar(13) DEFAULT NULL,
  COUPLE varchar(13) DEFAULT NULL,
  VSTATUS varchar(1) DEFAULT NULL,
  MOVEIN date DEFAULT NULL,
  DISCHARGE varchar(1) DEFAULT NULL,
  DDISCHARGE date DEFAULT NULL,
  ABOGROUP varchar(1) DEFAULT NULL,
  RHGROUP varchar(1) DEFAULT NULL,
  LABOR varchar(2) DEFAULT NULL,
  PASSPORT varchar(8) DEFAULT NULL,
  TYPEAREA varchar(1) NOT NULL DEFAULT '',
  D_UPDATE datetime NOT NULL DEFAULT '0000-00-00 00:00:00',
  check_hosp varchar(5) NOT NULL DEFAULT '',
  check_typearea varchar(1) NOT NULL DEFAULT '',
  vhid varchar(8) DEFAULT NULL,
  check_vhid varchar(8) DEFAULT NULL,
  maininscl varchar(5) DEFAULT NULL,
  inscl varchar(5) DEFAULT NULL,
  age_y int(3) DEFAULT NULL,
	addr varchar(100) DEFAULT NULL,
  PRIMARY KEY (CID),
  KEY HOSPCODE_PID (HOSPCODE,PID),
  KEY HOSPCODE (HOSPCODE),
  KEY PID (PID),
  KEY TYPEAREA (TYPEAREA),
  KEY vhid (vhid),
  KEY check_vhid (check_vhid),
  KEY check_typearea (check_typearea),
  KEY check_hosp (check_hosp),
  KEY BIRTH (BIRTH),
  KEY LABOR (LABOR),
  KEY NATION (NATION)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;


INSERT IGNORE INTO t_person_cid
(
		SELECT SQL_BIG_RESULT 
				p.HOSPCODE,p.CID,p.PID,p.HID,p.PRENAME,p.NAME,p.LNAME,p.HN,p.SEX,p.BIRTH
				,p.MSTATUS,p.OCCUPATION_OLD,p.OCCUPATION_NEW,p.RACE,p.NATION,p.RELIGION,p.EDUCATION,p.FSTATUS
				,p.FATHER,p.MOTHER,p.COUPLE,p.VSTATUS,p.MOVEIN,p.DISCHARGE
				,p.DDISCHARGE,p.ABOGROUP,p.RHGROUP,p.LABOR,p.PASSPORT,p.TYPEAREA,p.D_UPDATE,
				p.HOSPCODE as check_hosp	,p.TYPEAREA as check_typearea ,vhid,check_vhid,maininscl,inscl
				,age(DATE_FORMAT(CONCAT(@b_year,'0101'),'%Y%m%d'),birth,'y') as age_y,p.addr
				
		FROM
			t_person_db p
		WHERE LENGTH(TRIM(p.cid))=13 AND p.TYPEAREA in('1','3')
		ORDER BY  p.D_UPDATE DESC ,p.TYPEAREA ASC
);

INSERT IGNORE INTO t_person_cid
(
		SELECT SQL_BIG_RESULT 
				p.HOSPCODE,p.CID,p.PID,p.HID,p.PRENAME,p.NAME,p.LNAME,p.HN,p.SEX,p.BIRTH
				,p.MSTATUS,p.OCCUPATION_OLD,p.OCCUPATION_NEW,p.RACE,p.NATION,p.RELIGION,p.EDUCATION,p.FSTATUS
				,p.FATHER,p.MOTHER,p.COUPLE,p.VSTATUS,p.MOVEIN,p.DISCHARGE
				,p.DDISCHARGE,p.ABOGROUP,p.RHGROUP,p.LABOR,p.PASSPORT,p.TYPEAREA,p.D_UPDATE,
				p.HOSPCODE as check_hosp	,p.TYPEAREA as check_typearea ,vhid,check_vhid,maininscl,inscl
				,age(DATE_FORMAT(CONCAT(@b_year,'0101'),'%Y%m%d'),birth,'y') as age_y,p.addr
		FROM
			t_person_db p
		WHERE LENGTH(TRIM(p.cid))=13 AND p.TYPEAREA in('2','4','5')
		ORDER BY p.TYPEAREA ASC
);

#################################
UPDATE  t_person_db  pd INNER JOIN t_person_cid p ON pd.CID=p.CID 
LEFT JOIN address a ON pd.HOSPCODE=a.HOSPCODE AND pd.PID=a.PID
SET pd.error_code =IF(ISNULL(pd.error_code),'PE0015',CONCAT(pd.error_code,',','PE0015') ) 
WHERE  p.check_typearea in(4,5) AND p.DISCHARGE in(9) AND a.CHANGWAT in(@prov_c);

DROP TABLE IF EXISTS tmpz_error_person;
CREATE TABLE IF NOT EXISTS tmpz_error_person (error_name text ,KEY (hospcode,pid),KEY(cid),key(error_code) )
ENGINE=myisam DEFAULT CHARSET=utf8 as(
SELECT
HOSPCODE,PID,cid
,SUBSTRING_INDEX(p.error_code,',',1) error_code
,null as error_name
FROM t_person_db p WHERE 
error_code is not null
);
INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',2),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*2)+1 ;

INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',3),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*3)+2 ;
 
INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',4),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*4)+3 ;

INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',5),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*5)+4 ;

INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',6),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*6)+5 ;

INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',7),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*7)+6 ;

INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',8),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*8)+7 ;

INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',9),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*9)+8 ;

INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',10),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*10)+9 ;

INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',11),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*11)+10 ;

INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',12),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*12)+11 ;

INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',13),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*13)+12 ;

INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',14),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*14)+13 ;

INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',15),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*15)+14 ;

UPDATE tmpz_error_person p INNER JOIN cerror_new c ON p.error_code=c.err_code 
SET p.error_name=c.err_name;

DROP TABLE IF EXISTS tmp_exchange_person;
CREATE TABLE IF NOT EXISTS tmp_exchange_person (error_code VARCHAR(255),KEY (hospcode,pid),KEY(cid),KEY(error_code))
ENGINE=myisam DEFAULT CHARSET=utf8 as(
SELECT
HOSPCODE,PID,cid,GROUP_CONCAT(error_code separator ' :: ') error_code, GROUP_CONCAT(error_name separator ' :: ') error_name
FROM tmpz_error_person 
GROUP BY HOSPCODE,PID
);
DROP TABLE IF EXISTS tmpz_error_person;


 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988049.8484409;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:49;a:5:{i:0;s:37:"DROP PROCEDURE IF EXISTS t_person_anc";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988049.8484409;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:50;a:5:{i:0;s:37:"DROP PROCEDURE IF EXISTS t_person_anc";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988049.9576409;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:52;a:5:{i:0;s:5429:"CREATE PROCEDURE t_person_anc()
 BEGIN 
SET @prov_c := '58';
SET @id := '4';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
SET	@date_3:=concat(@b_year-2,'1001');

DROP TABLE IF EXISTS tmp_anc;

CREATE TABLE IF NOT EXISTS tmp_anc (
KEY (cid),
KEY (hospcode,pid),
KEY (date_serv),
KEY (ga),
KEY (gravida)
)ENGINE=MyISAM  AS(
SELECT  SQL_BIG_RESULT 
		tt.HOSPCODE,tt.PID,tt.SEQ,tt.DATE_SERV,tt.GRAVIDA,tt.ancno,tt.GA,tt.ANCRESULT,tt.ANCPLACE,tt.PROVIDER,tt.D_UPDATE,pe.cid,pe.nation,pe.birth,pe.sex
FROM
			anc tt LEFT JOIN person pe ON tt.HOSPCODE=pe.HOSPCODE AND tt.pid=pe.pid 
WHERE
		tt.date_serv BETWEEN @date_3 AND @end_d
);

DROP TABLE IF EXISTS tmp_labor;
CREATE TABLE IF NOT EXISTS tmp_labor (
KEY (cid),
KEY (hospcode,pid),
KEY (bdate)
) ENGINE=MyISAM  AS(
SELECT  SQL_BIG_RESULT 
		lb.*,pe.cid,pe.birth,age(lb.bdate,pe.birth,'y') as age_y
FROM
			labor lb  LEFT JOIN person pe ON lb.HOSPCODE=pe.HOSPCODE AND lb.pid=pe.pid 
WHERE
		 lb.bdate BETWEEN @date_3 AND @end_d
);

DROP TABLE IF EXISTS t_labor;
CREATE TABLE IF NOT EXISTS t_labor (
PRIMARY KEY (CID,BDATE)
) ENGINE=MyISAM  IGNORE AS
SELECT l.* FROM tmp_labor l INNER JOIN chospital h ON l.hospcode=h.hoscode WHERE  h.hostype in(5,6,7,11);

INSERT IGNORE t_labor (SELECT * FROM tmp_labor);



DROP TABLE IF EXISTS t_person_anc;

CREATE TABLE IF NOT EXISTS t_person_anc(
		id int(15) NOT NULL AUTO_INCREMENT
		,hospcode varchar(5) NOT NULL
	  ,pid varchar(15) NOT NULL 
		,typearea varchar(1) NOT NULL 
		,cid VARCHAR(13) NOT NULL
		,birth date
		,sex VARCHAR(1) DEFAULT NULL 
		,nation VARCHAR(3) DEFAULT NULL 
		,occupat_new VARCHAR(4) DEFAULT NULL 
		,gravida VARCHAR(2) DEFAULT NULL 
		,bdate date
		,bhosp VARCHAR(5) DEFAULT NULL
		,input_bhosp VARCHAR(5) DEFAULT NULL 
		,g1_ga VARCHAR(2) DEFAULT NULL 
		,g1_date date
		,g1_hospcode VARCHAR(5) DEFAULT NULL 
		,g1_input_hosp VARCHAR(5) DEFAULT NULL 
		
		,g2_ga VARCHAR(2) DEFAULT NULL 
		,g2_date date
		,g2_hospcode VARCHAR(5) DEFAULT NULL 
		,g2_input_hosp VARCHAR(5) DEFAULT NULL 

		,g3_ga VARCHAR(2) DEFAULT NULL 
		,g3_date date
		,g3_hospcode VARCHAR(5) DEFAULT NULL 
		,g3_input_hosp VARCHAR(5) DEFAULT NULL 

		,g4_ga VARCHAR(2) DEFAULT NULL 
		,g4_date date
		,g4_hospcode VARCHAR(5) DEFAULT NULL 
		,g4_input_hosp VARCHAR(5) DEFAULT NULL 

		,g5_ga VARCHAR(2) DEFAULT NULL 
		,g5_date date
		,g5_hospcode VARCHAR(5) DEFAULT NULL 
		,g5_input_hosp VARCHAR(5) DEFAULT NULL 
	
	,PRIMARY KEY (id)
	,KEY cid (cid)
,KEY  (hospcode)
,KEY  (pid)
,KEY  (typearea)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

TRUNCATE TABLE t_person_anc;

/*GROUP BY CID Gravida */
INSERT IGNORE INTO t_person_anc
(
hospcode,pid,typearea,cid,birth,sex,nation,occupat_new,gravida
)
(
SELECT	pe.hospcode,pe.pid,pe.check_typearea,pe.cid,pe.BIRTH,pe.SEX,pe.NATION,pe.OCCUPATION_NEW,tt.GRAVIDA
FROM		tmp_anc as tt LEFT JOIN t_person_cid as pe ON tt.CID=pe.CID 
WHERE	 tt.DATE_SERV BETWEEN @date_3 AND @end_d AND LENGTH(pe.cid) = 13
GROUP BY pe.CID,tt.GRAVIDA
ORDER BY  pe.CID
);

UPDATE t_person_anc a INNER JOIN
	(
	SELECT 			cid,date_serv ,gravida,ancplace,ga,hospcode
	FROM		tmp_anc	WHERE			ga <= 12 
	GROUP BY cid,gravida
	)	 as g ON a.cid=g.cid AND g.gravida=a.gravida
SET a.g1_ga= g.ga 		,a.g1_date=g.date_serv ,a.g1_hospcode =g.ancplace 			,a.g1_input_hosp= g.hospcode;

UPDATE t_person_anc a INNER JOIN
	(
	SELECT 	cid,date_serv ,gravida,ancplace,ga,hospcode
	FROM		tmp_anc	WHERE		ga BETWEEN 16 AND 20 
	GROUP BY cid,gravida
	)	 as g ON a.cid=g.cid AND g.gravida=a.gravida
SET a.g2_ga= g.ga  ,a.g2_date=g.date_serv 	,a.g2_hospcode =g.ancplace 		,a.g2_input_hosp= g.hospcode;

UPDATE t_person_anc a INNER JOIN
	(
	SELECT 	cid,date_serv ,gravida,ancplace,ga,hospcode
	FROM		tmp_anc	WHERE		ga BETWEEN 24 AND 28 
	GROUP BY cid,gravida
	)	 as g ON a.cid=g.cid AND g.gravida=a.gravida
SET a.g3_ga= g.ga  	,a.g3_date=g.date_serv 	,a.g3_hospcode =g.ancplace 		,a.g3_input_hosp= g.hospcode;

UPDATE t_person_anc a INNER JOIN
	(
	SELECT 	cid,date_serv ,gravida,ancplace,ga,hospcode
	FROM		tmp_anc	WHERE		 ga BETWEEN 30 AND 34 
	GROUP BY cid,gravida
	)	 as g ON a.cid=g.cid AND g.gravida=a.gravida
SET a.g4_ga= g.ga 	,a.g4_date=g.date_serv 		,a.g4_hospcode =g.ancplace 		,a.g4_input_hosp= g.hospcode;

UPDATE t_person_anc a INNER JOIN
	(	
  SELECT 			cid,date_serv ,gravida,ancplace,ga,hospcode
	FROM		tmp_anc	WHERE			ga BETWEEN 36 AND 40 
	GROUP BY cid,gravida
	)	 as g ON a.cid=g.cid AND g.gravida=a.gravida
SET a.g5_ga= g.ga  	,a.g5_date=g.date_serv 		,a.g5_hospcode =g.ancplace 		,a.g5_input_hosp= g.hospcode;

UPDATE t_person_anc a INNER JOIN
	(
	SELECT cid,bdate,gravida,bhosp,hospcode 	FROM	tmp_labor l INNER JOIN chospital h ON l.hospcode=h.hoscode AND h.hostype IN(5,6,7,11)
	WHERE	bdate BETWEEN @start_d AND @end_d AND  BHOSP=HOSPCODE
	GROUP BY cid,gravida
	)	 as g ON a.cid=g.cid AND g.gravida=a.gravida
SET a.bdate=g.bdate	,a.bhosp=g.bhosp	,a.input_bhosp=g.hospcode;

UPDATE t_person_anc a INNER JOIN
	(
	SELECT cid,bdate,gravida,bhosp,hospcode 	FROM	tmp_labor
	WHERE	bdate BETWEEN @start_d AND @end_d 
	GROUP BY cid,gravida
	)	 as g ON a.cid=g.cid AND g.gravida=a.gravida
SET a.bdate=g.bdate	,a.bhosp=g.bhosp	,a.input_bhosp=g.hospcode
WHERE ISNULL(a.bdate);


 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988049.9576409;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:53;a:5:{i:0;s:5429:"CREATE PROCEDURE t_person_anc()
 BEGIN 
SET @prov_c := '58';
SET @id := '4';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
SET	@date_3:=concat(@b_year-2,'1001');

DROP TABLE IF EXISTS tmp_anc;

CREATE TABLE IF NOT EXISTS tmp_anc (
KEY (cid),
KEY (hospcode,pid),
KEY (date_serv),
KEY (ga),
KEY (gravida)
)ENGINE=MyISAM  AS(
SELECT  SQL_BIG_RESULT 
		tt.HOSPCODE,tt.PID,tt.SEQ,tt.DATE_SERV,tt.GRAVIDA,tt.ancno,tt.GA,tt.ANCRESULT,tt.ANCPLACE,tt.PROVIDER,tt.D_UPDATE,pe.cid,pe.nation,pe.birth,pe.sex
FROM
			anc tt LEFT JOIN person pe ON tt.HOSPCODE=pe.HOSPCODE AND tt.pid=pe.pid 
WHERE
		tt.date_serv BETWEEN @date_3 AND @end_d
);

DROP TABLE IF EXISTS tmp_labor;
CREATE TABLE IF NOT EXISTS tmp_labor (
KEY (cid),
KEY (hospcode,pid),
KEY (bdate)
) ENGINE=MyISAM  AS(
SELECT  SQL_BIG_RESULT 
		lb.*,pe.cid,pe.birth,age(lb.bdate,pe.birth,'y') as age_y
FROM
			labor lb  LEFT JOIN person pe ON lb.HOSPCODE=pe.HOSPCODE AND lb.pid=pe.pid 
WHERE
		 lb.bdate BETWEEN @date_3 AND @end_d
);

DROP TABLE IF EXISTS t_labor;
CREATE TABLE IF NOT EXISTS t_labor (
PRIMARY KEY (CID,BDATE)
) ENGINE=MyISAM  IGNORE AS
SELECT l.* FROM tmp_labor l INNER JOIN chospital h ON l.hospcode=h.hoscode WHERE  h.hostype in(5,6,7,11);

INSERT IGNORE t_labor (SELECT * FROM tmp_labor);



DROP TABLE IF EXISTS t_person_anc;

CREATE TABLE IF NOT EXISTS t_person_anc(
		id int(15) NOT NULL AUTO_INCREMENT
		,hospcode varchar(5) NOT NULL
	  ,pid varchar(15) NOT NULL 
		,typearea varchar(1) NOT NULL 
		,cid VARCHAR(13) NOT NULL
		,birth date
		,sex VARCHAR(1) DEFAULT NULL 
		,nation VARCHAR(3) DEFAULT NULL 
		,occupat_new VARCHAR(4) DEFAULT NULL 
		,gravida VARCHAR(2) DEFAULT NULL 
		,bdate date
		,bhosp VARCHAR(5) DEFAULT NULL
		,input_bhosp VARCHAR(5) DEFAULT NULL 
		,g1_ga VARCHAR(2) DEFAULT NULL 
		,g1_date date
		,g1_hospcode VARCHAR(5) DEFAULT NULL 
		,g1_input_hosp VARCHAR(5) DEFAULT NULL 
		
		,g2_ga VARCHAR(2) DEFAULT NULL 
		,g2_date date
		,g2_hospcode VARCHAR(5) DEFAULT NULL 
		,g2_input_hosp VARCHAR(5) DEFAULT NULL 

		,g3_ga VARCHAR(2) DEFAULT NULL 
		,g3_date date
		,g3_hospcode VARCHAR(5) DEFAULT NULL 
		,g3_input_hosp VARCHAR(5) DEFAULT NULL 

		,g4_ga VARCHAR(2) DEFAULT NULL 
		,g4_date date
		,g4_hospcode VARCHAR(5) DEFAULT NULL 
		,g4_input_hosp VARCHAR(5) DEFAULT NULL 

		,g5_ga VARCHAR(2) DEFAULT NULL 
		,g5_date date
		,g5_hospcode VARCHAR(5) DEFAULT NULL 
		,g5_input_hosp VARCHAR(5) DEFAULT NULL 
	
	,PRIMARY KEY (id)
	,KEY cid (cid)
,KEY  (hospcode)
,KEY  (pid)
,KEY  (typearea)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

TRUNCATE TABLE t_person_anc;

/*GROUP BY CID Gravida */
INSERT IGNORE INTO t_person_anc
(
hospcode,pid,typearea,cid,birth,sex,nation,occupat_new,gravida
)
(
SELECT	pe.hospcode,pe.pid,pe.check_typearea,pe.cid,pe.BIRTH,pe.SEX,pe.NATION,pe.OCCUPATION_NEW,tt.GRAVIDA
FROM		tmp_anc as tt LEFT JOIN t_person_cid as pe ON tt.CID=pe.CID 
WHERE	 tt.DATE_SERV BETWEEN @date_3 AND @end_d AND LENGTH(pe.cid) = 13
GROUP BY pe.CID,tt.GRAVIDA
ORDER BY  pe.CID
);

UPDATE t_person_anc a INNER JOIN
	(
	SELECT 			cid,date_serv ,gravida,ancplace,ga,hospcode
	FROM		tmp_anc	WHERE			ga <= 12 
	GROUP BY cid,gravida
	)	 as g ON a.cid=g.cid AND g.gravida=a.gravida
SET a.g1_ga= g.ga 		,a.g1_date=g.date_serv ,a.g1_hospcode =g.ancplace 			,a.g1_input_hosp= g.hospcode;

UPDATE t_person_anc a INNER JOIN
	(
	SELECT 	cid,date_serv ,gravida,ancplace,ga,hospcode
	FROM		tmp_anc	WHERE		ga BETWEEN 16 AND 20 
	GROUP BY cid,gravida
	)	 as g ON a.cid=g.cid AND g.gravida=a.gravida
SET a.g2_ga= g.ga  ,a.g2_date=g.date_serv 	,a.g2_hospcode =g.ancplace 		,a.g2_input_hosp= g.hospcode;

UPDATE t_person_anc a INNER JOIN
	(
	SELECT 	cid,date_serv ,gravida,ancplace,ga,hospcode
	FROM		tmp_anc	WHERE		ga BETWEEN 24 AND 28 
	GROUP BY cid,gravida
	)	 as g ON a.cid=g.cid AND g.gravida=a.gravida
SET a.g3_ga= g.ga  	,a.g3_date=g.date_serv 	,a.g3_hospcode =g.ancplace 		,a.g3_input_hosp= g.hospcode;

UPDATE t_person_anc a INNER JOIN
	(
	SELECT 	cid,date_serv ,gravida,ancplace,ga,hospcode
	FROM		tmp_anc	WHERE		 ga BETWEEN 30 AND 34 
	GROUP BY cid,gravida
	)	 as g ON a.cid=g.cid AND g.gravida=a.gravida
SET a.g4_ga= g.ga 	,a.g4_date=g.date_serv 		,a.g4_hospcode =g.ancplace 		,a.g4_input_hosp= g.hospcode;

UPDATE t_person_anc a INNER JOIN
	(	
  SELECT 			cid,date_serv ,gravida,ancplace,ga,hospcode
	FROM		tmp_anc	WHERE			ga BETWEEN 36 AND 40 
	GROUP BY cid,gravida
	)	 as g ON a.cid=g.cid AND g.gravida=a.gravida
SET a.g5_ga= g.ga  	,a.g5_date=g.date_serv 		,a.g5_hospcode =g.ancplace 		,a.g5_input_hosp= g.hospcode;

UPDATE t_person_anc a INNER JOIN
	(
	SELECT cid,bdate,gravida,bhosp,hospcode 	FROM	tmp_labor l INNER JOIN chospital h ON l.hospcode=h.hoscode AND h.hostype IN(5,6,7,11)
	WHERE	bdate BETWEEN @start_d AND @end_d AND  BHOSP=HOSPCODE
	GROUP BY cid,gravida
	)	 as g ON a.cid=g.cid AND g.gravida=a.gravida
SET a.bdate=g.bdate	,a.bhosp=g.bhosp	,a.input_bhosp=g.hospcode;

UPDATE t_person_anc a INNER JOIN
	(
	SELECT cid,bdate,gravida,bhosp,hospcode 	FROM	tmp_labor
	WHERE	bdate BETWEEN @start_d AND @end_d 
	GROUP BY cid,gravida
	)	 as g ON a.cid=g.cid AND g.gravida=a.gravida
SET a.bdate=g.bdate	,a.bhosp=g.bhosp	,a.input_bhosp=g.hospcode
WHERE ISNULL(a.bdate);


 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.020041;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:55;a:5:{i:0;s:37:"DROP PROCEDURE IF EXISTS t_person_epi";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.035641;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:56;a:5:{i:0;s:37:"DROP PROCEDURE IF EXISTS t_person_epi";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.129241;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:58;a:5:{i:0;s:17586:"CREATE PROCEDURE t_person_epi()
 BEGIN 
SET @prov_c := '58';
SET @id := '5';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
SET	@date_3:=concat(@b_year-14,'1001');

DROP TABLE IF EXISTS tmp_epi;
CREATE TABLE tmp_epi (
KEY (cid),
KEY (hospcode,pid),
KEY (vaccinetype)
) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		tt.HOSPCODE,tt.PID,tt.SEQ,tt.DATE_SERV,tt.VACCINETYPE,tt.VACCINEPLACE,tt.PROVIDER,tt.D_UPDATE,pe.cid
FROM
			epi tt LEFT JOIN  t_person_db pe ON tt.HOSPCODE=pe.HOSPCODE AND tt.pid=pe.pid 
WHERE
tt.date_serv BETWEEN @date_3 AND @end_d
);

DROP TABLE IF EXISTS tmp_newborn;
CREATE TABLE tmp_newborn (
KEY (cid),
KEY (hospcode,pid),
KEY (bweight)
) ENGINE=MyISAM  AS(
SELECT t.HOSPCODE,t.PID,t.MPID,t.GRAVIDA,t.GA,t.BDATE,t.BTIME,t.BPLACE,t.bhosp,t.BIRTHNO,t.btype
,t.bdoctor,t.BWEIGHT,t.ASPHYXIA,t.VITK,t.TSH,t.TSHRESULT,t.D_UPDATE
,p.CID,p.nation,p.sex,p.check_hosp,p.check_vhid,p.check_typearea,p.vhid,p.typearea
FROM		newborn t LEFT JOIN t_person_db p ON t.HOSPCODE=p.HOSPCODE AND t.pid=p.pid 
WHERE t.bdate BETWEEN @date_3 AND @end_d
);

DROP TABLE IF EXISTS tmp_nutrition;
CREATE TABLE tmp_nutrition (
error_code varchar(255) DEFAULT NULL,
KEY (cid),
KEY (hospcode,pid),
KEY (food,childdevelop)
) ENGINE=MyISAM  AS(
SELECT 
		t.HOSPCODE,t.PID,t.SEQ,t.DATE_SERV,t.NUTRITIONPLACE,t.WEIGHT,t.HEIGHT,t.HEADCIRCUM,t.CHILDDEVELOP,t.FOOD,t.BOTTLE,t.PROVIDER,t.D_UPDATE,pe.cid,null as error_code
FROM
			nutrition t LEFT JOIN t_person_db pe ON t.HOSPCODE=pe.HOSPCODE AND t.pid=pe.pid 
WHERE
t.date_serv BETWEEN @date_3 AND @end_d
);
UPDATE tmp_nutrition n INNER JOIN person p  ON n.HOSPCODE=p.HOSPCODE AND n.PID=p.PID
SET error_code =IF(ISNULL(n.error_code),'NU0001',CONCAT(n.error_code,',','NU0001') ) 
WHERE  DATE_SERV BETWEEN @start_d AND @end_d AND n.DATE_SERV < p.BIRTH;


DROP TABLE IF EXISTS t_person_epi;
CREATE TABLE IF NOT EXISTS t_person_epi (
		id int(15) NOT NULL AUTO_INCREMENT
		,hospcode varchar(5) NOT NULL
	  ,pid varchar(15) NOT NULL 
		,typearea varchar(1) NOT NULL 
		,vhid varchar(8) DEFAULT NULL 
		,cid VARCHAR(13) NOT NULL
		,birth date
		,sex VARCHAR(1) DEFAULT NULL 
		,nation VARCHAR(3) DEFAULT NULL 
		,bweight int(4) DEFAULT 0
		,bw_input_hosp VARCHAR(5) DEFAULT NULL 
		,food VARCHAR(1) DEFAULT NULL 
		,food_date date
		,food_input_hosp VARCHAR(5) DEFAULT NULL 

		,childdevelop VARCHAR(1) DEFAULT NULL 
		,childdevelop_date date
		,childdevelop_input_hosp VARCHAR(5) DEFAULT NULL 
		
		,bcg_date date
		,bcg_hospcode VARCHAR(5) DEFAULT NULL
		,bcg_input_hosp VARCHAR(5) DEFAULT NULL 

		,hbv1_date date
		,hbv1_hospcode VARCHAR(5) DEFAULT NULL
		,hbv1_input_hosp VARCHAR(5) DEFAULT NULL 
		,hbv2_date date
		,hbv2_hospcode VARCHAR(5) DEFAULT NULL
		,hbv2_input_hosp VARCHAR(5) DEFAULT NULL 
		,hbv3_date date
		,hbv3_hospcode VARCHAR(5) DEFAULT NULL
		,hbv3_input_hosp VARCHAR(5) DEFAULT NULL 
	
		,opv1_date date
		,opv1_hospcode VARCHAR(5) DEFAULT NULL
		,opv1_input_hosp VARCHAR(5) DEFAULT NULL 
		,opv2_date date
		,opv2_hospcode VARCHAR(5) DEFAULT NULL
		,opv2_input_hosp VARCHAR(5) DEFAULT NULL 
		,opv3_date date
		,opv3_hospcode VARCHAR(5) DEFAULT NULL
		,opv3_input_hosp VARCHAR(5) DEFAULT NULL 
		,opv4_date date
		,opv4_hospcode VARCHAR(5) DEFAULT NULL
		,opv4_input_hosp VARCHAR(5) DEFAULT NULL 
		,opv5_date date
		,opv5_hospcode VARCHAR(5) DEFAULT NULL
		,opv5_input_hosp VARCHAR(5) DEFAULT NULL 

		,opvs1_date date
		,opvs1_hospcode VARCHAR(5) DEFAULT NULL
		,opvs1_input_hosp VARCHAR(5) DEFAULT NULL 
		,opvs2_date date
		,opvs2_hospcode VARCHAR(5) DEFAULT NULL
		,opvs2_input_hosp VARCHAR(5) DEFAULT NULL 
		,opvs3_date date
		,opvs3_hospcode VARCHAR(5) DEFAULT NULL
		,opvs3_input_hosp VARCHAR(5) DEFAULT NULL 

		,dtp1_date date
		,dtp1_hospcode VARCHAR(5) DEFAULT NULL
		,dtp1_input_hosp VARCHAR(5) DEFAULT NULL 
		,dtp2_date date
		,dtp2_hospcode VARCHAR(5) DEFAULT NULL
		,dtp2_input_hosp VARCHAR(5) DEFAULT NULL 
		,dtp3_date date
		,dtp3_hospcode VARCHAR(5) DEFAULT NULL
		,dtp3_input_hosp VARCHAR(5) DEFAULT NULL 
		,dtp4_date date
		,dtp4_hospcode VARCHAR(5) DEFAULT NULL
		,dtp4_input_hosp VARCHAR(5) DEFAULT NULL 
		,dtp5_date date
		,dtp5_hospcode VARCHAR(5) DEFAULT NULL
		,dtp5_input_hosp VARCHAR(5) DEFAULT NULL 

		,bcgs_date date
		,bcgs_hospcode VARCHAR(5) DEFAULT NULL
		,bcgs_input_hosp VARCHAR(5) DEFAULT NULL 

		,dts1_date date
		,dts1_hospcode VARCHAR(5) DEFAULT NULL
		,dts1_input_hosp VARCHAR(5) DEFAULT NULL 
		,dts2_date date
		,dts2_hospcode VARCHAR(5) DEFAULT NULL
		,dts2_input_hosp VARCHAR(5) DEFAULT NULL 
		,dts3_date date
		,dts3_hospcode VARCHAR(5) DEFAULT NULL
		,dts3_input_hosp VARCHAR(5) DEFAULT NULL 
		,dts4_date date
		,dts4_hospcode VARCHAR(5) DEFAULT NULL
		,dts4_input_hosp VARCHAR(5) DEFAULT NULL 

		,je1_date date
		,je1_hospcode VARCHAR(5) DEFAULT NULL
		,je1_input_hosp VARCHAR(5) DEFAULT NULL 
		,je2_date date
		,je2_hospcode VARCHAR(5) DEFAULT NULL
		,je2_input_hosp VARCHAR(5) DEFAULT NULL 
		,je3_date date
		,je3_hospcode VARCHAR(5) DEFAULT NULL
		,je3_input_hosp VARCHAR(5) DEFAULT NULL 

		,j11_date date
		,j11_hospcode VARCHAR(5) DEFAULT NULL
		,j11_input_hosp VARCHAR(5) DEFAULT NULL 
		,j12_date date
		,j12_hospcode VARCHAR(5) DEFAULT NULL
		,j12_input_hosp VARCHAR(5) DEFAULT NULL 

		,mmr1_date date
		,mmr1_hospcode VARCHAR(5) DEFAULT NULL
		,mmr1_input_hosp VARCHAR(5) DEFAULT NULL 
		,mmr2_date date
		,mmr2_hospcode VARCHAR(5) DEFAULT NULL
		,mmr2_input_hosp VARCHAR(5) DEFAULT NULL 
		,mmrs_date date
		,mmrs_hospcode VARCHAR(5) DEFAULT NULL
		,mmrs_input_hosp VARCHAR(5) DEFAULT NULL 
		,mrs_date date
		,mrs_hospcode VARCHAR(5) DEFAULT NULL
		,mrs_input_hosp VARCHAR(5) DEFAULT NULL 
		,mrc_date date
		,mrc_hospcode VARCHAR(5) DEFAULT NULL
		,mrc_input_hosp VARCHAR(5) DEFAULT NULL 
		,mmrc_date date
		,mmrc_hospcode VARCHAR(5) DEFAULT NULL
		,mmrc_input_hosp VARCHAR(5) DEFAULT NULL 

		,hpv1_date date
		,hpv1_hospcode VARCHAR(5) DEFAULT NULL
		,hpv1_input_hosp VARCHAR(5) DEFAULT NULL 
		,hpv2_date date
		,hpv2_hospcode VARCHAR(5) DEFAULT NULL
		,hpv2_input_hosp VARCHAR(5) DEFAULT NULL 
		,hpv3_date date
		,hpv3_hospcode VARCHAR(5) DEFAULT NULL
		,hpv3_input_hosp VARCHAR(5) DEFAULT NULL 

		,ipv2_date date
		,ipv2_hospcode VARCHAR(5) DEFAULT NULL
		,ipv2_input_hosp VARCHAR(5) DEFAULT NULL 

		,rv21_date date
		,rv21_hospcode VARCHAR(5) DEFAULT NULL
		,rv21_input_hosp VARCHAR(5) DEFAULT NULL 
		,rv22_date date
		,rv22_hospcode VARCHAR(5) DEFAULT NULL
		,rv22_input_hosp VARCHAR(5) DEFAULT NULL 

		,rv31_date date
		,rv31_hospcode VARCHAR(5) DEFAULT NULL
		,rv31_input_hosp VARCHAR(5) DEFAULT NULL 
		,rv32_date date
		,rv32_hospcode VARCHAR(5) DEFAULT NULL
		,rv32_input_hosp VARCHAR(5) DEFAULT NULL 
		,rv33_date date
		,rv33_hospcode VARCHAR(5) DEFAULT NULL
		,rv33_input_hosp VARCHAR(5) DEFAULT NULL 


	,PRIMARY KEY (id)
	,KEY cid (cid)
,KEY  (hospcode)
,KEY  (typearea)

) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO t_person_epi (cid,hospcode,pid,typearea,BIRTH,SEX,NATION,vhid)
(	SELECT 
					pe.cid,pe.check_hosp,pe.pid,pe.check_typearea,pe.BIRTH,pe.SEX,pe.NATION,check_vhid
	FROM
					tmp_epi as tt
				LEFT JOIN t_person_cid as pe ON tt.CID=pe.CID
	WHERE pe.age_y < 14	
	GROUP BY pe.CID
);

/****BCG******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.bcg_date =e.DATE_SERV, p.bcg_hospcode =e.VACCINEPLACE, p.bcg_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('010');

/****HBV1******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.hbv1_date =e.DATE_SERV, p.hbv1_hospcode =e.VACCINEPLACE, p.hbv1_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('041','091','D51','H31');
/****HBV2******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.hbv2_date =e.DATE_SERV, p.hbv2_hospcode =e.VACCINEPLACE, p.hbv2_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('042','092','D52','H32');
/****HBV3******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.hbv3_date =e.DATE_SERV, p.hbv3_hospcode =e.VACCINEPLACE, p.hbv3_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('043','093','H33','D23','D53');

/****OPV1******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.opv1_date =e.DATE_SERV, p.opv1_hospcode =e.VACCINEPLACE, p.opv1_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('081','D31','D41','D51','I11');
/****OPV2******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.opv2_date =e.DATE_SERV, p.opv2_hospcode =e.VACCINEPLACE, p.opv2_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('082','D32','D42','D52','I12');
/****OPV3******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.opv3_date =e.DATE_SERV, p.opv3_hospcode =e.VACCINEPLACE, p.opv3_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('083','D33','D43','D53','I13');
/****OPV4******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.opv4_date =e.DATE_SERV, p.opv4_hospcode =e.VACCINEPLACE, p.opv4_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('084','D34','D44','D54','I14');
/****OPV5******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.opv5_date =e.DATE_SERV, p.opv5_hospcode =e.VACCINEPLACE, p.opv5_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('085','D35','D45','D55','I15');
/****OPVS1******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.opvs1_date =e.DATE_SERV, p.opvs1_hospcode =e.VACCINEPLACE, p.opvs1_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('086');
/****OPVS2******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.opvs2_date =e.DATE_SERV, p.opvs2_hospcode =e.VACCINEPLACE, p.opvs2_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('087');
/****OPVS3******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.opvs3_date =e.DATE_SERV, p.opvs3_hospcode =e.VACCINEPLACE, p.opvs3_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('088');

/****DTP1******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.dtp1_date =e.DATE_SERV, p.dtp1_hospcode =e.VACCINEPLACE, p.dtp1_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('031','091','D11','D21','D31','D41','D51');
/****DTP2******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.dtp2_date =e.DATE_SERV, p.dtp2_hospcode =e.VACCINEPLACE, p.dtp2_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('032','092','D12','D22','D32','D42','D52');
/****DTP3******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.dtp3_date =e.DATE_SERV, p.dtp3_hospcode =e.VACCINEPLACE, p.dtp3_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('033','093','D13','D23','D33','D43','D53');
/****DTP4******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.dtp4_date =e.DATE_SERV, p.dtp4_hospcode =e.VACCINEPLACE, p.dtp4_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('034','D14','D24','D34','D44','D54');
/****DTP5******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.dtp5_date =e.DATE_SERV, p.dtp5_hospcode =e.VACCINEPLACE, p.dtp5_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('035','D35','D45','D55');

/****BCGS******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.bcgs_date =e.DATE_SERV, p.bcgs_hospcode =e.VACCINEPLACE, p.bcgs_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('011');

/****DTS1******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.dts1_date =e.DATE_SERV, p.dts1_hospcode =e.VACCINEPLACE, p.dts1_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('021');
/****DTS2******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.dts2_date =e.DATE_SERV, p.dts2_hospcode =e.VACCINEPLACE, p.dts2_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('022');
/****DTS3******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.dts3_date =e.DATE_SERV, p.dts3_hospcode =e.VACCINEPLACE, p.dts3_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('023');
/****DTS4******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.dts4_date =e.DATE_SERV, p.dts4_hospcode =e.VACCINEPLACE, p.dts4_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('024');

/****JE1******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.je1_date =e.DATE_SERV, p.je1_hospcode =e.VACCINEPLACE, p.je1_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('051');
/****JE2******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.je2_date =e.DATE_SERV, p.je2_hospcode =e.VACCINEPLACE, p.je2_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('052');
/****JE3******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.je3_date =e.DATE_SERV, p.je3_hospcode =e.VACCINEPLACE, p.je3_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('053');

/****J11******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.j11_date =e.DATE_SERV, p.j11_hospcode =e.VACCINEPLACE, p.j11_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('J11');
/****J12******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.j12_date =e.DATE_SERV, p.j12_hospcode =e.VACCINEPLACE, p.j12_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('J12');

/****MMR1=MMR 9 เดือน******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.mmr1_date =e.DATE_SERV, p.mmr1_hospcode =e.VACCINEPLACE, p.mmr1_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('061','M11');
/****MMR2* 2ปี /หรือห่าง mmr1 6wks*****/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.mmr2_date =e.DATE_SERV, p.mmr2_hospcode =e.VACCINEPLACE, p.mmr2_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('073','M12');

/****MMRS ป1******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.mmrs_date =e.DATE_SERV, p.mmrs_hospcode =e.VACCINEPLACE, p.mmrs_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('072');
/****MRS ป1******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.mrs_date =e.DATE_SERV, p.mrs_hospcode =e.VACCINEPLACE, p.mrs_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('075');

/****MRC******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.mrc_date =e.DATE_SERV, p.mrc_hospcode =e.VACCINEPLACE, p.mrc_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('074');

/****MMRC******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.mmrc_date =e.DATE_SERV, p.mmrc_hospcode =e.VACCINEPLACE, p.mmrc_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('076');


/****HPV1******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.hpv1_date =e.DATE_SERV, p.hpv1_hospcode =e.VACCINEPLACE, p.hpv1_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('H31','310');
/****HPV2******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.hpv2_date =e.DATE_SERV, p.hpv2_hospcode =e.VACCINEPLACE, p.hpv2_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('H32','320');
/****HPV3******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.hpv3_date =e.DATE_SERV, p.hpv3_hospcode =e.VACCINEPLACE, p.hpv3_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('H33','311');

/****IPV2******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.ipv2_date =e.DATE_SERV, p.ipv2_hospcode =e.VACCINEPLACE, p.ipv2_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('401','D32','D42','D52','I12');

/****RV21******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.rv21_date =e.DATE_SERV, p.rv21_hospcode =e.VACCINEPLACE, p.rv21_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('R11');
/****RV22******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.rv22_date =e.DATE_SERV, p.rv22_hospcode =e.VACCINEPLACE, p.rv22_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('R12');
/****RV31******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.rv31_date =e.DATE_SERV, p.rv31_hospcode =e.VACCINEPLACE, p.rv31_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('R21');
/****RV32******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.rv32_date =e.DATE_SERV, p.rv32_hospcode =e.VACCINEPLACE, p.rv32_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('R22');
/****RV33******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.rv33_date =e.DATE_SERV, p.rv33_hospcode =e.VACCINEPLACE, p.rv33_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('R23');

/****food******/
UPDATE  t_person_epi p INNER JOIN (
	SELECT cid,food,DATE_SERV,hospcode FROM tmp_nutrition WHERE food in(1,2,3,4) ORDER BY CONCAT(cid,DATE_SERV) DESC 
) n ON p.cid=n.cid 
SET p.food_date =n.DATE_SERV, p.food =n.food, p.food_input_hosp =n.hospcode;
/****childdev******/
UPDATE  t_person_epi p INNER JOIN (
	SELECT cid,childdevelop,DATE_SERV,hospcode FROM tmp_nutrition WHERE childdevelop in(1,2,3) ORDER BY CONCAT(cid,DATE_SERV) DESC 
) n ON p.cid=n.cid 
SET p.childdevelop_date =n.DATE_SERV, p.childdevelop =n.childdevelop, p.childdevelop_input_hosp =n.hospcode;

/****newborn******/
UPDATE  t_person_epi p INNER JOIN 
(SELECT n.* FROM tmp_newborn  n INNER JOIN chospital h ON n.hospcode=h.hoscode 
WHERE h.hostype IN(5,6,7,11) AND n.HOSPCODE= n.BHOSP 
) n ON p.cid=n.cid 
SET p.bweight =n.BWEIGHT, p.bw_input_hosp =n.hospcode;

UPDATE  t_person_epi p INNER JOIN tmp_newborn  n ON p.cid=n.cid 
SET p.bweight =n.BWEIGHT, p.bw_input_hosp =n.hospcode
WHERE ISNULL(p.bweight);

 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.129241;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:59;a:5:{i:0;s:17586:"CREATE PROCEDURE t_person_epi()
 BEGIN 
SET @prov_c := '58';
SET @id := '5';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
SET	@date_3:=concat(@b_year-14,'1001');

DROP TABLE IF EXISTS tmp_epi;
CREATE TABLE tmp_epi (
KEY (cid),
KEY (hospcode,pid),
KEY (vaccinetype)
) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		tt.HOSPCODE,tt.PID,tt.SEQ,tt.DATE_SERV,tt.VACCINETYPE,tt.VACCINEPLACE,tt.PROVIDER,tt.D_UPDATE,pe.cid
FROM
			epi tt LEFT JOIN  t_person_db pe ON tt.HOSPCODE=pe.HOSPCODE AND tt.pid=pe.pid 
WHERE
tt.date_serv BETWEEN @date_3 AND @end_d
);

DROP TABLE IF EXISTS tmp_newborn;
CREATE TABLE tmp_newborn (
KEY (cid),
KEY (hospcode,pid),
KEY (bweight)
) ENGINE=MyISAM  AS(
SELECT t.HOSPCODE,t.PID,t.MPID,t.GRAVIDA,t.GA,t.BDATE,t.BTIME,t.BPLACE,t.bhosp,t.BIRTHNO,t.btype
,t.bdoctor,t.BWEIGHT,t.ASPHYXIA,t.VITK,t.TSH,t.TSHRESULT,t.D_UPDATE
,p.CID,p.nation,p.sex,p.check_hosp,p.check_vhid,p.check_typearea,p.vhid,p.typearea
FROM		newborn t LEFT JOIN t_person_db p ON t.HOSPCODE=p.HOSPCODE AND t.pid=p.pid 
WHERE t.bdate BETWEEN @date_3 AND @end_d
);

DROP TABLE IF EXISTS tmp_nutrition;
CREATE TABLE tmp_nutrition (
error_code varchar(255) DEFAULT NULL,
KEY (cid),
KEY (hospcode,pid),
KEY (food,childdevelop)
) ENGINE=MyISAM  AS(
SELECT 
		t.HOSPCODE,t.PID,t.SEQ,t.DATE_SERV,t.NUTRITIONPLACE,t.WEIGHT,t.HEIGHT,t.HEADCIRCUM,t.CHILDDEVELOP,t.FOOD,t.BOTTLE,t.PROVIDER,t.D_UPDATE,pe.cid,null as error_code
FROM
			nutrition t LEFT JOIN t_person_db pe ON t.HOSPCODE=pe.HOSPCODE AND t.pid=pe.pid 
WHERE
t.date_serv BETWEEN @date_3 AND @end_d
);
UPDATE tmp_nutrition n INNER JOIN person p  ON n.HOSPCODE=p.HOSPCODE AND n.PID=p.PID
SET error_code =IF(ISNULL(n.error_code),'NU0001',CONCAT(n.error_code,',','NU0001') ) 
WHERE  DATE_SERV BETWEEN @start_d AND @end_d AND n.DATE_SERV < p.BIRTH;


DROP TABLE IF EXISTS t_person_epi;
CREATE TABLE IF NOT EXISTS t_person_epi (
		id int(15) NOT NULL AUTO_INCREMENT
		,hospcode varchar(5) NOT NULL
	  ,pid varchar(15) NOT NULL 
		,typearea varchar(1) NOT NULL 
		,vhid varchar(8) DEFAULT NULL 
		,cid VARCHAR(13) NOT NULL
		,birth date
		,sex VARCHAR(1) DEFAULT NULL 
		,nation VARCHAR(3) DEFAULT NULL 
		,bweight int(4) DEFAULT 0
		,bw_input_hosp VARCHAR(5) DEFAULT NULL 
		,food VARCHAR(1) DEFAULT NULL 
		,food_date date
		,food_input_hosp VARCHAR(5) DEFAULT NULL 

		,childdevelop VARCHAR(1) DEFAULT NULL 
		,childdevelop_date date
		,childdevelop_input_hosp VARCHAR(5) DEFAULT NULL 
		
		,bcg_date date
		,bcg_hospcode VARCHAR(5) DEFAULT NULL
		,bcg_input_hosp VARCHAR(5) DEFAULT NULL 

		,hbv1_date date
		,hbv1_hospcode VARCHAR(5) DEFAULT NULL
		,hbv1_input_hosp VARCHAR(5) DEFAULT NULL 
		,hbv2_date date
		,hbv2_hospcode VARCHAR(5) DEFAULT NULL
		,hbv2_input_hosp VARCHAR(5) DEFAULT NULL 
		,hbv3_date date
		,hbv3_hospcode VARCHAR(5) DEFAULT NULL
		,hbv3_input_hosp VARCHAR(5) DEFAULT NULL 
	
		,opv1_date date
		,opv1_hospcode VARCHAR(5) DEFAULT NULL
		,opv1_input_hosp VARCHAR(5) DEFAULT NULL 
		,opv2_date date
		,opv2_hospcode VARCHAR(5) DEFAULT NULL
		,opv2_input_hosp VARCHAR(5) DEFAULT NULL 
		,opv3_date date
		,opv3_hospcode VARCHAR(5) DEFAULT NULL
		,opv3_input_hosp VARCHAR(5) DEFAULT NULL 
		,opv4_date date
		,opv4_hospcode VARCHAR(5) DEFAULT NULL
		,opv4_input_hosp VARCHAR(5) DEFAULT NULL 
		,opv5_date date
		,opv5_hospcode VARCHAR(5) DEFAULT NULL
		,opv5_input_hosp VARCHAR(5) DEFAULT NULL 

		,opvs1_date date
		,opvs1_hospcode VARCHAR(5) DEFAULT NULL
		,opvs1_input_hosp VARCHAR(5) DEFAULT NULL 
		,opvs2_date date
		,opvs2_hospcode VARCHAR(5) DEFAULT NULL
		,opvs2_input_hosp VARCHAR(5) DEFAULT NULL 
		,opvs3_date date
		,opvs3_hospcode VARCHAR(5) DEFAULT NULL
		,opvs3_input_hosp VARCHAR(5) DEFAULT NULL 

		,dtp1_date date
		,dtp1_hospcode VARCHAR(5) DEFAULT NULL
		,dtp1_input_hosp VARCHAR(5) DEFAULT NULL 
		,dtp2_date date
		,dtp2_hospcode VARCHAR(5) DEFAULT NULL
		,dtp2_input_hosp VARCHAR(5) DEFAULT NULL 
		,dtp3_date date
		,dtp3_hospcode VARCHAR(5) DEFAULT NULL
		,dtp3_input_hosp VARCHAR(5) DEFAULT NULL 
		,dtp4_date date
		,dtp4_hospcode VARCHAR(5) DEFAULT NULL
		,dtp4_input_hosp VARCHAR(5) DEFAULT NULL 
		,dtp5_date date
		,dtp5_hospcode VARCHAR(5) DEFAULT NULL
		,dtp5_input_hosp VARCHAR(5) DEFAULT NULL 

		,bcgs_date date
		,bcgs_hospcode VARCHAR(5) DEFAULT NULL
		,bcgs_input_hosp VARCHAR(5) DEFAULT NULL 

		,dts1_date date
		,dts1_hospcode VARCHAR(5) DEFAULT NULL
		,dts1_input_hosp VARCHAR(5) DEFAULT NULL 
		,dts2_date date
		,dts2_hospcode VARCHAR(5) DEFAULT NULL
		,dts2_input_hosp VARCHAR(5) DEFAULT NULL 
		,dts3_date date
		,dts3_hospcode VARCHAR(5) DEFAULT NULL
		,dts3_input_hosp VARCHAR(5) DEFAULT NULL 
		,dts4_date date
		,dts4_hospcode VARCHAR(5) DEFAULT NULL
		,dts4_input_hosp VARCHAR(5) DEFAULT NULL 

		,je1_date date
		,je1_hospcode VARCHAR(5) DEFAULT NULL
		,je1_input_hosp VARCHAR(5) DEFAULT NULL 
		,je2_date date
		,je2_hospcode VARCHAR(5) DEFAULT NULL
		,je2_input_hosp VARCHAR(5) DEFAULT NULL 
		,je3_date date
		,je3_hospcode VARCHAR(5) DEFAULT NULL
		,je3_input_hosp VARCHAR(5) DEFAULT NULL 

		,j11_date date
		,j11_hospcode VARCHAR(5) DEFAULT NULL
		,j11_input_hosp VARCHAR(5) DEFAULT NULL 
		,j12_date date
		,j12_hospcode VARCHAR(5) DEFAULT NULL
		,j12_input_hosp VARCHAR(5) DEFAULT NULL 

		,mmr1_date date
		,mmr1_hospcode VARCHAR(5) DEFAULT NULL
		,mmr1_input_hosp VARCHAR(5) DEFAULT NULL 
		,mmr2_date date
		,mmr2_hospcode VARCHAR(5) DEFAULT NULL
		,mmr2_input_hosp VARCHAR(5) DEFAULT NULL 
		,mmrs_date date
		,mmrs_hospcode VARCHAR(5) DEFAULT NULL
		,mmrs_input_hosp VARCHAR(5) DEFAULT NULL 
		,mrs_date date
		,mrs_hospcode VARCHAR(5) DEFAULT NULL
		,mrs_input_hosp VARCHAR(5) DEFAULT NULL 
		,mrc_date date
		,mrc_hospcode VARCHAR(5) DEFAULT NULL
		,mrc_input_hosp VARCHAR(5) DEFAULT NULL 
		,mmrc_date date
		,mmrc_hospcode VARCHAR(5) DEFAULT NULL
		,mmrc_input_hosp VARCHAR(5) DEFAULT NULL 

		,hpv1_date date
		,hpv1_hospcode VARCHAR(5) DEFAULT NULL
		,hpv1_input_hosp VARCHAR(5) DEFAULT NULL 
		,hpv2_date date
		,hpv2_hospcode VARCHAR(5) DEFAULT NULL
		,hpv2_input_hosp VARCHAR(5) DEFAULT NULL 
		,hpv3_date date
		,hpv3_hospcode VARCHAR(5) DEFAULT NULL
		,hpv3_input_hosp VARCHAR(5) DEFAULT NULL 

		,ipv2_date date
		,ipv2_hospcode VARCHAR(5) DEFAULT NULL
		,ipv2_input_hosp VARCHAR(5) DEFAULT NULL 

		,rv21_date date
		,rv21_hospcode VARCHAR(5) DEFAULT NULL
		,rv21_input_hosp VARCHAR(5) DEFAULT NULL 
		,rv22_date date
		,rv22_hospcode VARCHAR(5) DEFAULT NULL
		,rv22_input_hosp VARCHAR(5) DEFAULT NULL 

		,rv31_date date
		,rv31_hospcode VARCHAR(5) DEFAULT NULL
		,rv31_input_hosp VARCHAR(5) DEFAULT NULL 
		,rv32_date date
		,rv32_hospcode VARCHAR(5) DEFAULT NULL
		,rv32_input_hosp VARCHAR(5) DEFAULT NULL 
		,rv33_date date
		,rv33_hospcode VARCHAR(5) DEFAULT NULL
		,rv33_input_hosp VARCHAR(5) DEFAULT NULL 


	,PRIMARY KEY (id)
	,KEY cid (cid)
,KEY  (hospcode)
,KEY  (typearea)

) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO t_person_epi (cid,hospcode,pid,typearea,BIRTH,SEX,NATION,vhid)
(	SELECT 
					pe.cid,pe.check_hosp,pe.pid,pe.check_typearea,pe.BIRTH,pe.SEX,pe.NATION,check_vhid
	FROM
					tmp_epi as tt
				LEFT JOIN t_person_cid as pe ON tt.CID=pe.CID
	WHERE pe.age_y < 14	
	GROUP BY pe.CID
);

/****BCG******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.bcg_date =e.DATE_SERV, p.bcg_hospcode =e.VACCINEPLACE, p.bcg_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('010');

/****HBV1******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.hbv1_date =e.DATE_SERV, p.hbv1_hospcode =e.VACCINEPLACE, p.hbv1_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('041','091','D51','H31');
/****HBV2******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.hbv2_date =e.DATE_SERV, p.hbv2_hospcode =e.VACCINEPLACE, p.hbv2_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('042','092','D52','H32');
/****HBV3******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.hbv3_date =e.DATE_SERV, p.hbv3_hospcode =e.VACCINEPLACE, p.hbv3_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('043','093','H33','D23','D53');

/****OPV1******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.opv1_date =e.DATE_SERV, p.opv1_hospcode =e.VACCINEPLACE, p.opv1_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('081','D31','D41','D51','I11');
/****OPV2******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.opv2_date =e.DATE_SERV, p.opv2_hospcode =e.VACCINEPLACE, p.opv2_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('082','D32','D42','D52','I12');
/****OPV3******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.opv3_date =e.DATE_SERV, p.opv3_hospcode =e.VACCINEPLACE, p.opv3_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('083','D33','D43','D53','I13');
/****OPV4******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.opv4_date =e.DATE_SERV, p.opv4_hospcode =e.VACCINEPLACE, p.opv4_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('084','D34','D44','D54','I14');
/****OPV5******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.opv5_date =e.DATE_SERV, p.opv5_hospcode =e.VACCINEPLACE, p.opv5_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('085','D35','D45','D55','I15');
/****OPVS1******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.opvs1_date =e.DATE_SERV, p.opvs1_hospcode =e.VACCINEPLACE, p.opvs1_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('086');
/****OPVS2******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.opvs2_date =e.DATE_SERV, p.opvs2_hospcode =e.VACCINEPLACE, p.opvs2_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('087');
/****OPVS3******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.opvs3_date =e.DATE_SERV, p.opvs3_hospcode =e.VACCINEPLACE, p.opvs3_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('088');

/****DTP1******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.dtp1_date =e.DATE_SERV, p.dtp1_hospcode =e.VACCINEPLACE, p.dtp1_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('031','091','D11','D21','D31','D41','D51');
/****DTP2******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.dtp2_date =e.DATE_SERV, p.dtp2_hospcode =e.VACCINEPLACE, p.dtp2_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('032','092','D12','D22','D32','D42','D52');
/****DTP3******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.dtp3_date =e.DATE_SERV, p.dtp3_hospcode =e.VACCINEPLACE, p.dtp3_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('033','093','D13','D23','D33','D43','D53');
/****DTP4******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.dtp4_date =e.DATE_SERV, p.dtp4_hospcode =e.VACCINEPLACE, p.dtp4_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('034','D14','D24','D34','D44','D54');
/****DTP5******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.dtp5_date =e.DATE_SERV, p.dtp5_hospcode =e.VACCINEPLACE, p.dtp5_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('035','D35','D45','D55');

/****BCGS******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.bcgs_date =e.DATE_SERV, p.bcgs_hospcode =e.VACCINEPLACE, p.bcgs_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('011');

/****DTS1******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.dts1_date =e.DATE_SERV, p.dts1_hospcode =e.VACCINEPLACE, p.dts1_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('021');
/****DTS2******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.dts2_date =e.DATE_SERV, p.dts2_hospcode =e.VACCINEPLACE, p.dts2_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('022');
/****DTS3******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.dts3_date =e.DATE_SERV, p.dts3_hospcode =e.VACCINEPLACE, p.dts3_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('023');
/****DTS4******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.dts4_date =e.DATE_SERV, p.dts4_hospcode =e.VACCINEPLACE, p.dts4_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('024');

/****JE1******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.je1_date =e.DATE_SERV, p.je1_hospcode =e.VACCINEPLACE, p.je1_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('051');
/****JE2******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.je2_date =e.DATE_SERV, p.je2_hospcode =e.VACCINEPLACE, p.je2_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('052');
/****JE3******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.je3_date =e.DATE_SERV, p.je3_hospcode =e.VACCINEPLACE, p.je3_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('053');

/****J11******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.j11_date =e.DATE_SERV, p.j11_hospcode =e.VACCINEPLACE, p.j11_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('J11');
/****J12******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.j12_date =e.DATE_SERV, p.j12_hospcode =e.VACCINEPLACE, p.j12_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('J12');

/****MMR1=MMR 9 เดือน******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.mmr1_date =e.DATE_SERV, p.mmr1_hospcode =e.VACCINEPLACE, p.mmr1_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('061','M11');
/****MMR2* 2ปี /หรือห่าง mmr1 6wks*****/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.mmr2_date =e.DATE_SERV, p.mmr2_hospcode =e.VACCINEPLACE, p.mmr2_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('073','M12');

/****MMRS ป1******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.mmrs_date =e.DATE_SERV, p.mmrs_hospcode =e.VACCINEPLACE, p.mmrs_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('072');
/****MRS ป1******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.mrs_date =e.DATE_SERV, p.mrs_hospcode =e.VACCINEPLACE, p.mrs_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('075');

/****MRC******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.mrc_date =e.DATE_SERV, p.mrc_hospcode =e.VACCINEPLACE, p.mrc_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('074');

/****MMRC******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.mmrc_date =e.DATE_SERV, p.mmrc_hospcode =e.VACCINEPLACE, p.mmrc_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('076');


/****HPV1******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.hpv1_date =e.DATE_SERV, p.hpv1_hospcode =e.VACCINEPLACE, p.hpv1_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('H31','310');
/****HPV2******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.hpv2_date =e.DATE_SERV, p.hpv2_hospcode =e.VACCINEPLACE, p.hpv2_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('H32','320');
/****HPV3******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.hpv3_date =e.DATE_SERV, p.hpv3_hospcode =e.VACCINEPLACE, p.hpv3_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('H33','311');

/****IPV2******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.ipv2_date =e.DATE_SERV, p.ipv2_hospcode =e.VACCINEPLACE, p.ipv2_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('401','D32','D42','D52','I12');

/****RV21******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.rv21_date =e.DATE_SERV, p.rv21_hospcode =e.VACCINEPLACE, p.rv21_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('R11');
/****RV22******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.rv22_date =e.DATE_SERV, p.rv22_hospcode =e.VACCINEPLACE, p.rv22_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('R12');
/****RV31******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.rv31_date =e.DATE_SERV, p.rv31_hospcode =e.VACCINEPLACE, p.rv31_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('R21');
/****RV32******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.rv32_date =e.DATE_SERV, p.rv32_hospcode =e.VACCINEPLACE, p.rv32_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('R22');
/****RV33******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.rv33_date =e.DATE_SERV, p.rv33_hospcode =e.VACCINEPLACE, p.rv33_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('R23');

/****food******/
UPDATE  t_person_epi p INNER JOIN (
	SELECT cid,food,DATE_SERV,hospcode FROM tmp_nutrition WHERE food in(1,2,3,4) ORDER BY CONCAT(cid,DATE_SERV) DESC 
) n ON p.cid=n.cid 
SET p.food_date =n.DATE_SERV, p.food =n.food, p.food_input_hosp =n.hospcode;
/****childdev******/
UPDATE  t_person_epi p INNER JOIN (
	SELECT cid,childdevelop,DATE_SERV,hospcode FROM tmp_nutrition WHERE childdevelop in(1,2,3) ORDER BY CONCAT(cid,DATE_SERV) DESC 
) n ON p.cid=n.cid 
SET p.childdevelop_date =n.DATE_SERV, p.childdevelop =n.childdevelop, p.childdevelop_input_hosp =n.hospcode;

/****newborn******/
UPDATE  t_person_epi p INNER JOIN 
(SELECT n.* FROM tmp_newborn  n INNER JOIN chospital h ON n.hospcode=h.hoscode 
WHERE h.hostype IN(5,6,7,11) AND n.HOSPCODE= n.BHOSP 
) n ON p.cid=n.cid 
SET p.bweight =n.BWEIGHT, p.bw_input_hosp =n.hospcode;

UPDATE  t_person_epi p INNER JOIN tmp_newborn  n ON p.cid=n.cid 
SET p.bweight =n.BWEIGHT, p.bw_input_hosp =n.hospcode
WHERE ISNULL(p.bweight);

 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.222842;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:61;a:5:{i:0;s:34:"DROP PROCEDURE IF EXISTS t_village";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.222842;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:62;a:5:{i:0;s:34:"DROP PROCEDURE IF EXISTS t_village";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.2852421;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:64;a:5:{i:0;s:642:"CREATE PROCEDURE t_village()
 BEGIN 
SET @prov_c := '58';
SET @id := '6';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS t_village ;

CREATE TABLE t_village (
KEY (hospcode,vid)
) ENGINE=MyISAM  AS(

SELECT
*
FROM
(
	(SELECT 
		v.HOSPCODE,v.VID
	FROM
		village v
	GROUP BY v.HOSPCODE,v.VID
	)
	UNION
	(SELECT 
		v.HOSPCODE,CONCAT(h.provcode,h.distcode,h.subdistcode,'00')
	FROM
		village v ,chospital h
	WHERE v.HOSPCODE=h.hoscode
	GROUP BY v.HOSPCODE
	) 
) as vv
ORDER BY hospcode,vid
);


 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.2852421;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:65;a:5:{i:0;s:642:"CREATE PROCEDURE t_village()
 BEGIN 
SET @prov_c := '58';
SET @id := '6';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS t_village ;

CREATE TABLE t_village (
KEY (hospcode,vid)
) ENGINE=MyISAM  AS(

SELECT
*
FROM
(
	(SELECT 
		v.HOSPCODE,v.VID
	FROM
		village v
	GROUP BY v.HOSPCODE,v.VID
	)
	UNION
	(SELECT 
		v.HOSPCODE,CONCAT(h.provcode,h.distcode,h.subdistcode,'00')
	FROM
		village v ,chospital h
	WHERE v.HOSPCODE=h.hoscode
	GROUP BY v.HOSPCODE
	) 
) as vv
ORDER BY hospcode,vid
);


 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.3476419;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:67;a:5:{i:0;s:34:"DROP PROCEDURE IF EXISTS t_surveil";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.3476419;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:68;a:5:{i:0;s:34:"DROP PROCEDURE IF EXISTS t_surveil";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.410042;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:70;a:5:{i:0;s:2675:"CREATE PROCEDURE t_surveil()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '7';
SET @b_year:=IF(MONTH(NOW())=1 AND DAY(NOW())<=5,year(NOW())-1,year(NOW()));
SET @start_d:=concat(@b_year,'0101');
SET @end_d:=concat(@b_year,'1231');

DROP TABLE IF EXISTS t_surveil;
CREATE TABLE IF NOT EXISTS t_surveil (
  `hospcode` varchar(5) not null,
  `pid` varchar(15) not null,
  `cid` varchar(13) not null,
	`seq` varchar(16) not null,
	`fname` varchar(100) not null,
	`lname` varchar(100) not null,
	`sex` varchar(1) not null,
	`areacode` varchar(8) not null,
	`birth` date not null,
	`age_y` int(3) not null,
	`age_m` int(3) not null,
	`age_d` int(3) not null,
  `date_serv` date not null,
  `an` varchar(9) default null,
  `datetime_admit` datetime default null,
  `diagcode` varchar(6) not null,
  `diagcodelast` varchar(6) default null,
  `code506` varchar(2) not null,
  `code506last` varchar(2) default null,
  `illdate` date not null,
  `illhouse` varchar(75) default null,
  `ill_areacode` varchar(8) default null,
  `ptstatus` char(1) not null,
  `date_death` date default null,
  `groupname1560` varchar(50) default null,
	`groupname190` varchar(50) default null,		
	`groupname506` varchar(255) default null,  
	key (`hospcode`,`pid`,`seq`,`code506`),
	key (`code506`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO t_surveil
(
`hospcode`,`pid`,`cid`,`seq`,`fname`,`lname`,`sex`,`areacode`,`birth`
,`age_y`,`age_m`,`age_d`,`date_serv`,`an`,`datetime_admit`,`diagcode`
,`diagcodelast`,`code506`,`code506last`,`illdate`,`illhouse`,`ill_areacode`
,`ptstatus`,`date_death`,`groupname1560`,`groupname190`,`groupname506`
)
(
SELECT SQL_BIG_RESULT 
	t1.*,a.groupname1560,a.groupname190
	,if(l.group506code is not null,l.group506name
	,if(l.group506code is null,r.group506name,NULL
	))
FROM
(SELECT
	s.HOSPCODE,s.PID,p.CID,s.SEQ,p.`NAME` as fname,p.LNAME,p.SEX,concat(h.provcode,h.distcode,h.subdistcode,SUBSTR(CONCAT('00',h.mu),-2))
	,p.BIRTH,age(s.ILLDATE,p.BIRTH,'y') as yy ,age(s.ILLDATE,p.BIRTH,'m') as mm , age(s.ILLDATE,p.BIRTH,'d') as dd,s.DATE_SERV
	,s.AN,s.DATETIME_ADMIT,s.DIAGCODE,s.DIAGCODELAST,s.CODE506,s.CODE506LAST,s.ILLDATE,s.ILLHOUSE
	,CONCAT(s.ILLCHANGWAT,s.ILLAMPUR,s.ILLTAMBON,SUBSTR(CONCAT('00',s.ILLVILLAGE),-2)) as ill_areacode,s.PTSTATUS,s.DATE_DEATH
 
FROM
		surveillance s 
		LEFT JOIN t_person_db p  ON s.HOSPCODE=p.HOSPCODE AND s.PID=p.PID 
		LEFT JOIN chospital h ON  s.HOSPCODE=h.hoscode
WHERE 
 (s.DATE_SERV BETWEEN @start_d AND @end_d)
) as t1 ,cage a,cdisease506 r,cdisease506 l
WHERE  t1.yy=a.age AND t1.CODE506=r.group506code AND t1.CODE506LAST=l.group506code
);


 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.410042;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:71;a:5:{i:0;s:2675:"CREATE PROCEDURE t_surveil()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '7';
SET @b_year:=IF(MONTH(NOW())=1 AND DAY(NOW())<=5,year(NOW())-1,year(NOW()));
SET @start_d:=concat(@b_year,'0101');
SET @end_d:=concat(@b_year,'1231');

DROP TABLE IF EXISTS t_surveil;
CREATE TABLE IF NOT EXISTS t_surveil (
  `hospcode` varchar(5) not null,
  `pid` varchar(15) not null,
  `cid` varchar(13) not null,
	`seq` varchar(16) not null,
	`fname` varchar(100) not null,
	`lname` varchar(100) not null,
	`sex` varchar(1) not null,
	`areacode` varchar(8) not null,
	`birth` date not null,
	`age_y` int(3) not null,
	`age_m` int(3) not null,
	`age_d` int(3) not null,
  `date_serv` date not null,
  `an` varchar(9) default null,
  `datetime_admit` datetime default null,
  `diagcode` varchar(6) not null,
  `diagcodelast` varchar(6) default null,
  `code506` varchar(2) not null,
  `code506last` varchar(2) default null,
  `illdate` date not null,
  `illhouse` varchar(75) default null,
  `ill_areacode` varchar(8) default null,
  `ptstatus` char(1) not null,
  `date_death` date default null,
  `groupname1560` varchar(50) default null,
	`groupname190` varchar(50) default null,		
	`groupname506` varchar(255) default null,  
	key (`hospcode`,`pid`,`seq`,`code506`),
	key (`code506`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO t_surveil
(
`hospcode`,`pid`,`cid`,`seq`,`fname`,`lname`,`sex`,`areacode`,`birth`
,`age_y`,`age_m`,`age_d`,`date_serv`,`an`,`datetime_admit`,`diagcode`
,`diagcodelast`,`code506`,`code506last`,`illdate`,`illhouse`,`ill_areacode`
,`ptstatus`,`date_death`,`groupname1560`,`groupname190`,`groupname506`
)
(
SELECT SQL_BIG_RESULT 
	t1.*,a.groupname1560,a.groupname190
	,if(l.group506code is not null,l.group506name
	,if(l.group506code is null,r.group506name,NULL
	))
FROM
(SELECT
	s.HOSPCODE,s.PID,p.CID,s.SEQ,p.`NAME` as fname,p.LNAME,p.SEX,concat(h.provcode,h.distcode,h.subdistcode,SUBSTR(CONCAT('00',h.mu),-2))
	,p.BIRTH,age(s.ILLDATE,p.BIRTH,'y') as yy ,age(s.ILLDATE,p.BIRTH,'m') as mm , age(s.ILLDATE,p.BIRTH,'d') as dd,s.DATE_SERV
	,s.AN,s.DATETIME_ADMIT,s.DIAGCODE,s.DIAGCODELAST,s.CODE506,s.CODE506LAST,s.ILLDATE,s.ILLHOUSE
	,CONCAT(s.ILLCHANGWAT,s.ILLAMPUR,s.ILLTAMBON,SUBSTR(CONCAT('00',s.ILLVILLAGE),-2)) as ill_areacode,s.PTSTATUS,s.DATE_DEATH
 
FROM
		surveillance s 
		LEFT JOIN t_person_db p  ON s.HOSPCODE=p.HOSPCODE AND s.PID=p.PID 
		LEFT JOIN chospital h ON  s.HOSPCODE=h.hoscode
WHERE 
 (s.DATE_SERV BETWEEN @start_d AND @end_d)
) as t1 ,cage a,cdisease506 r,cdisease506 l
WHERE  t1.yy=a.age AND t1.CODE506=r.group506code AND t1.CODE506LAST=l.group506code
);


 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.4724419;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:73;a:5:{i:0;s:37:"DROP PROCEDURE IF EXISTS t_pt_surveil";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.4724419;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:74;a:5:{i:0;s:37:"DROP PROCEDURE IF EXISTS t_pt_surveil";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.534842;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:76;a:5:{i:0;s:1648:"CREATE PROCEDURE t_pt_surveil()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '8';
SET @b_year:=IF(MONTH(NOW())=1 AND DAY(NOW())<=5,year(NOW())-1,year(NOW()));
SET @start_d:=concat(@b_year,'0101');
SET @end_d:=concat(@b_year,'1231');

#DROP TABLE IF EXISTS t_pt_surveil;
CREATE TABLE IF NOT EXISTS t_pt_surveil (
  `id` varchar(32) not null,
  `code506` varchar(2) not null,
	`groupname506` varchar(255) default null,  
  `hospcode` varchar(5) not null,
	`pt_areacode` varchar(8) not null,
	`sex` varchar(1) not null,
	`age_y` int(3) not null,
  `groupname1560` varchar(50) default null,
  `yymm` varchar(50) default null,
  `wks` int(2) default 0,
	`seq` int(9) default 0,
  `pid` int(9) default 0,
  `death` int(9) default 0,
	key (groupname506,hospcode,pt_areacode,sex,groupname1560,wks)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

DELETE FROM t_pt_surveil WHERE (SUBSTR(yymm,1,4)-543)=year(now());

INSERT IGNORE INTO t_pt_surveil
(
`id`,`code506`,`groupname506`,`hospcode`,`pt_areacode`,`sex`,`age_y`,`groupname1560`,`yymm`,`wks`,`seq`,`pid`,`death`)
(
SELECT  SQL_BIG_RESULT 
	@id,if(code506last is not null,code506last,if(code506last is null,code506,NULL)) as code506
	,groupname506,hospcode,ill_areacode,sex,age_y
	,groupname1560,CONCAT((DATE_FORMAT(illdate,'%Y')+543),DATE_FORMAT(illdate,'%m')) as yymm
	,epid_wks(epiddate,illdate)
	,COUNT(seq) as seq,COUNT(DISTINCT pid) as pid
	,SUM(CASE WHEN ptstatus=2 THEN 1 ELSE 0 END) as death
FROM
	t_surveil ,sys_config
WHERE
	SUBSTR(illdate,1,4) = @b_year
GROUP BY 
	groupname506,hospcode,areacode,sex,groupname1560,yymm
ORDER BY 
groupname506,hospcode
);
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.534842;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:77;a:5:{i:0;s:1648:"CREATE PROCEDURE t_pt_surveil()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '8';
SET @b_year:=IF(MONTH(NOW())=1 AND DAY(NOW())<=5,year(NOW())-1,year(NOW()));
SET @start_d:=concat(@b_year,'0101');
SET @end_d:=concat(@b_year,'1231');

#DROP TABLE IF EXISTS t_pt_surveil;
CREATE TABLE IF NOT EXISTS t_pt_surveil (
  `id` varchar(32) not null,
  `code506` varchar(2) not null,
	`groupname506` varchar(255) default null,  
  `hospcode` varchar(5) not null,
	`pt_areacode` varchar(8) not null,
	`sex` varchar(1) not null,
	`age_y` int(3) not null,
  `groupname1560` varchar(50) default null,
  `yymm` varchar(50) default null,
  `wks` int(2) default 0,
	`seq` int(9) default 0,
  `pid` int(9) default 0,
  `death` int(9) default 0,
	key (groupname506,hospcode,pt_areacode,sex,groupname1560,wks)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

DELETE FROM t_pt_surveil WHERE (SUBSTR(yymm,1,4)-543)=year(now());

INSERT IGNORE INTO t_pt_surveil
(
`id`,`code506`,`groupname506`,`hospcode`,`pt_areacode`,`sex`,`age_y`,`groupname1560`,`yymm`,`wks`,`seq`,`pid`,`death`)
(
SELECT  SQL_BIG_RESULT 
	@id,if(code506last is not null,code506last,if(code506last is null,code506,NULL)) as code506
	,groupname506,hospcode,ill_areacode,sex,age_y
	,groupname1560,CONCAT((DATE_FORMAT(illdate,'%Y')+543),DATE_FORMAT(illdate,'%m')) as yymm
	,epid_wks(epiddate,illdate)
	,COUNT(seq) as seq,COUNT(DISTINCT pid) as pid
	,SUM(CASE WHEN ptstatus=2 THEN 1 ELSE 0 END) as death
FROM
	t_surveil ,sys_config
WHERE
	SUBSTR(illdate,1,4) = @b_year
GROUP BY 
	groupname506,hospcode,areacode,sex,groupname1560,yymm
ORDER BY 
groupname506,hospcode
);
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.5972421;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:79;a:5:{i:0;s:41:"DROP PROCEDURE IF EXISTS t_person_sex_age";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.5972421;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:80;a:5:{i:0;s:41:"DROP PROCEDURE IF EXISTS t_person_sex_age";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.659642;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:82;a:5:{i:0;s:7125:"CREATE PROCEDURE t_person_sex_age()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '9';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);

DROP TABLE IF EXISTS tmp_person_agegroup;

CREATE TABLE tmp_person_agegroup (
KEY (hospcode),
KEY (vhid)
) ENGINE=MyISAM  AS(
	SELECT SQL_BIG_RESULT 
			check_hosp as hospcode,check_vhid as vhid,sex,age_y as age
		,ca.groupcode190,ca.groupname190,ca.groupcode1560,ca.groupname1560,ca.groupcode060,ca.groupname060
		,ca.groupcode3560,ca.groupname3560
	FROM 
		t_person_cid p,cage ca
	WHERE
		ca.age=age_y AND p.check_typearea in(1,3)
		AND p.DISCHARGE=9 AND nation=99 
);


DROP TABLE IF EXISTS tmp_labor_agegroup;

CREATE TABLE tmp_labor_agegroup (
KEY (hospcode),
KEY (vhid)
) ENGINE=MyISAM  AS(
	SELECT SQL_BIG_RESULT 
			check_hosp as hospcode,check_vhid as vhid,sex,age_y as age
		,ca.groupcode190,ca.groupname190,ca.groupcode1560,ca.groupname1560,ca.groupcode060,ca.groupname060
		,ca.groupcode3560,ca.groupname3560
	FROM 
		t_person_cid p,cage ca
	WHERE
		ca.age=age_y AND p.check_typearea in(1,3)
		AND p.DISCHARGE=9 AND (p.labor >= 1 OR p.nation !='099')
);



DROP TABLE IF EXISTS t_person_sex_age190 ;

CREATE TABLE IF NOT EXISTS t_person_sex_age190  (
  `id` varchar(32) not null default '',
	`year` varchar(4) not null default '',
	`hospcode` varchar(5) not null default '',
  `areacode` varchar(8) not null default '',
  `sex` varchar(15) not null default '',
  `groupcode` int(2) not null default 0,
  `groupname` varchar(255) not null default '',
  `result` int(9) not null default 0,
  KEY `hospcode` (`hospcode`),
  KEY `areacode` (`areacode`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

#DELETE FROM t_person_sex_age190 WHERE year= year(now())+543;

INSERT INTO t_person_sex_age190
(
`id`,`year`,`hospcode`,`areacode`,`sex`,`groupcode`,`groupname`,`result`
)
(
	SELECT SQL_BIG_RESULT 
	@id as id,(@b_year+543) as year,ag.hospcode,ag.vhid,ag.sex,ag.groupcode,ag.groupname,ag.result
	FROM
			(SELECT
			hospcode,vhid,if(sex=1,'ชาย',if(sex=2,'หญิง','ระบุไม่ได้' )) as sex ,groupcode190 as groupcode,groupname190 as groupname,COUNT(*) as result
			FROM
			tmp_person_agegroup
			GROUP BY
			hospcode,vhid,sex,groupcode190 
			ORDER BY hospcode,vhid
			) as ag
);

DROP TABLE IF EXISTS t_labor_sex_age190 ;

CREATE TABLE IF NOT EXISTS t_labor_sex_age190 (
  `id` varchar(32) not null default '',
	`year` varchar(4) not null default '',
	`hospcode` varchar(5) not null default '',
  `areacode` varchar(8) not null default '',
  `sex` varchar(15) not null default '',
  `groupcode` int(2) not null default 0,
  `groupname` varchar(255) not null default '',
  `result` int(9) not null default 0,
  KEY `hospcode` (`hospcode`),
  KEY `areacode` (`areacode`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

#DELETE FROM t_labor_sex_age190 WHERE year= year(now())+543;

INSERT INTO t_labor_sex_age190
(
`id`,`year`,`hospcode`,`areacode`,`sex`,`groupcode`,`groupname`,`result`
)
(
	SELECT SQL_BIG_RESULT 
	@id as id,(@b_year+543) as year,ag.hospcode,ag.vhid,ag.sex,ag.groupcode,ag.groupname,ag.result
	FROM
			(SELECT
			hospcode,vhid,if(sex=1,'ชาย',if(sex=2,'หญิง','ระบุไม่ได้' )) as sex ,groupcode190 as groupcode,groupname190 as groupname,COUNT(*) as result
			FROM
			tmp_labor_agegroup
			GROUP BY
			hospcode,vhid,sex,groupcode190 
			ORDER BY hospcode,vhid
			) as ag
);


DROP TABLE IF EXISTS t_person_sex_age1560 ;

CREATE TABLE IF NOT EXISTS t_person_sex_age1560 (
  `id` varchar(32) not null default '',
	`year` varchar(4) not null default '',
	`hospcode` varchar(5) not null default '',
  `areacode` varchar(8) not null default '',
  `sex` varchar(15) not null default '',
  `groupcode` int(2) not null default 0,
  `groupname` varchar(255) not null default '',
  `result` int(9) not null default 0,
  KEY `hospcode` (`hospcode`),
  KEY `areacode` (`areacode`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

#DELETE FROM t_person_sex_age1560 WHERE year= year(now())+543;


INSERT INTO t_person_sex_age1560
(
`id`,`year`,`hospcode`,`areacode`,`sex`,`groupcode`,`groupname`,`result`
)
(
	SELECT SQL_BIG_RESULT 
	@id as id,(@b_year+543) as year,ag.hospcode,ag.vhid,ag.sex,ag.groupcode,ag.groupname,ag.result
	FROM
			(SELECT
			hospcode,vhid,if(sex=1,'ชาย',if(sex=2,'หญิง','ระบุไม่ได้' )) as sex ,groupcode1560 as groupcode ,groupname1560 as groupname,COUNT(*) as result
			FROM
			tmp_person_agegroup
			GROUP BY
			hospcode,vhid,sex,groupcode1560
			ORDER BY hospcode,vhid
			) as ag
);


DROP TABLE IF EXISTS t_person_sex_age060 ;

CREATE TABLE IF NOT EXISTS t_person_sex_age060 (
  `id` varchar(32) not null default '',
	`year` varchar(4) not null default '',
	`hospcode` varchar(5) not null default '',
  `areacode` varchar(8) not null default '',
  `sex` varchar(15) not null default '',
  `groupcode` int(2) not null default 0,
  `groupname` varchar(255) not null default '',
  `result` int(9) not null default 0,
  KEY `hospcode` (`hospcode`),
  KEY `areacode` (`areacode`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

#DELETE FROM t_person_sex_age060 WHERE year= year(now())+543;


INSERT INTO t_person_sex_age060
(
`id`,`year`,`hospcode`,`areacode`,`sex`,`groupcode`,`groupname`,`result`
)
(
	SELECT SQL_BIG_RESULT 
	@id as id,(@b_year+543) as year,ag.hospcode,ag.vhid,ag.sex,ag.groupcode,ag.groupname,ag.result
	FROM
			(SELECT
			hospcode,vhid,if(sex=1,'ชาย',if(sex=2,'หญิง','ระบุไม่ได้' )) as sex ,groupcode060 as groupcode ,groupname060 as groupname,COUNT(*) as result
			FROM
			tmp_person_agegroup
			GROUP BY
			hospcode,vhid,sex,groupcode060
			ORDER BY hospcode,vhid
			) as ag
);


DROP TABLE IF EXISTS t_person_sex_age3560 ;

CREATE TABLE IF NOT EXISTS t_person_sex_age3560 (
  `id` varchar(32) not null default '',
	`year` varchar(4) not null default '',
	`hospcode` varchar(5) not null default '',
  `areacode` varchar(8) not null default '',
  `sex` varchar(15) not null default '',
  `groupcode` int(2) not null default 0,
  `groupname` varchar(255) not null default '',
  `result` int(9) not null default 0,
  KEY `hospcode` (`hospcode`),
  KEY `areacode` (`areacode`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

#DELETE FROM t_person_sex_age3560 WHERE year= year(now())+543;


INSERT INTO t_person_sex_age3560
(
`id`,`year`,`hospcode`,`areacode`,`sex`,`groupcode`,`groupname`,`result`
)
(
	SELECT SQL_BIG_RESULT 
	@id as id,(@b_year+543) as year,ag.hospcode,ag.vhid,ag.sex,ag.groupcode,ag.groupname,ag.result
	FROM
			(SELECT
			hospcode,vhid,if(sex=1,'ชาย',if(sex=2,'หญิง','ระบุไม่ได้' )) as sex ,groupcode3560 as groupcode ,groupname3560 as groupname,COUNT(*) as result
			FROM
			tmp_person_agegroup
			GROUP BY
			hospcode,vhid,sex,groupcode3560
			ORDER BY hospcode,vhid
			) as ag
);

DROP TABLE IF EXISTS tmp_person_agegroup;
DROP TABLE IF EXISTS tmp_labor_agegroup;

 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.659642;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:83;a:5:{i:0;s:7125:"CREATE PROCEDURE t_person_sex_age()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '9';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);

DROP TABLE IF EXISTS tmp_person_agegroup;

CREATE TABLE tmp_person_agegroup (
KEY (hospcode),
KEY (vhid)
) ENGINE=MyISAM  AS(
	SELECT SQL_BIG_RESULT 
			check_hosp as hospcode,check_vhid as vhid,sex,age_y as age
		,ca.groupcode190,ca.groupname190,ca.groupcode1560,ca.groupname1560,ca.groupcode060,ca.groupname060
		,ca.groupcode3560,ca.groupname3560
	FROM 
		t_person_cid p,cage ca
	WHERE
		ca.age=age_y AND p.check_typearea in(1,3)
		AND p.DISCHARGE=9 AND nation=99 
);


DROP TABLE IF EXISTS tmp_labor_agegroup;

CREATE TABLE tmp_labor_agegroup (
KEY (hospcode),
KEY (vhid)
) ENGINE=MyISAM  AS(
	SELECT SQL_BIG_RESULT 
			check_hosp as hospcode,check_vhid as vhid,sex,age_y as age
		,ca.groupcode190,ca.groupname190,ca.groupcode1560,ca.groupname1560,ca.groupcode060,ca.groupname060
		,ca.groupcode3560,ca.groupname3560
	FROM 
		t_person_cid p,cage ca
	WHERE
		ca.age=age_y AND p.check_typearea in(1,3)
		AND p.DISCHARGE=9 AND (p.labor >= 1 OR p.nation !='099')
);



DROP TABLE IF EXISTS t_person_sex_age190 ;

CREATE TABLE IF NOT EXISTS t_person_sex_age190  (
  `id` varchar(32) not null default '',
	`year` varchar(4) not null default '',
	`hospcode` varchar(5) not null default '',
  `areacode` varchar(8) not null default '',
  `sex` varchar(15) not null default '',
  `groupcode` int(2) not null default 0,
  `groupname` varchar(255) not null default '',
  `result` int(9) not null default 0,
  KEY `hospcode` (`hospcode`),
  KEY `areacode` (`areacode`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

#DELETE FROM t_person_sex_age190 WHERE year= year(now())+543;

INSERT INTO t_person_sex_age190
(
`id`,`year`,`hospcode`,`areacode`,`sex`,`groupcode`,`groupname`,`result`
)
(
	SELECT SQL_BIG_RESULT 
	@id as id,(@b_year+543) as year,ag.hospcode,ag.vhid,ag.sex,ag.groupcode,ag.groupname,ag.result
	FROM
			(SELECT
			hospcode,vhid,if(sex=1,'ชาย',if(sex=2,'หญิง','ระบุไม่ได้' )) as sex ,groupcode190 as groupcode,groupname190 as groupname,COUNT(*) as result
			FROM
			tmp_person_agegroup
			GROUP BY
			hospcode,vhid,sex,groupcode190 
			ORDER BY hospcode,vhid
			) as ag
);

DROP TABLE IF EXISTS t_labor_sex_age190 ;

CREATE TABLE IF NOT EXISTS t_labor_sex_age190 (
  `id` varchar(32) not null default '',
	`year` varchar(4) not null default '',
	`hospcode` varchar(5) not null default '',
  `areacode` varchar(8) not null default '',
  `sex` varchar(15) not null default '',
  `groupcode` int(2) not null default 0,
  `groupname` varchar(255) not null default '',
  `result` int(9) not null default 0,
  KEY `hospcode` (`hospcode`),
  KEY `areacode` (`areacode`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

#DELETE FROM t_labor_sex_age190 WHERE year= year(now())+543;

INSERT INTO t_labor_sex_age190
(
`id`,`year`,`hospcode`,`areacode`,`sex`,`groupcode`,`groupname`,`result`
)
(
	SELECT SQL_BIG_RESULT 
	@id as id,(@b_year+543) as year,ag.hospcode,ag.vhid,ag.sex,ag.groupcode,ag.groupname,ag.result
	FROM
			(SELECT
			hospcode,vhid,if(sex=1,'ชาย',if(sex=2,'หญิง','ระบุไม่ได้' )) as sex ,groupcode190 as groupcode,groupname190 as groupname,COUNT(*) as result
			FROM
			tmp_labor_agegroup
			GROUP BY
			hospcode,vhid,sex,groupcode190 
			ORDER BY hospcode,vhid
			) as ag
);


DROP TABLE IF EXISTS t_person_sex_age1560 ;

CREATE TABLE IF NOT EXISTS t_person_sex_age1560 (
  `id` varchar(32) not null default '',
	`year` varchar(4) not null default '',
	`hospcode` varchar(5) not null default '',
  `areacode` varchar(8) not null default '',
  `sex` varchar(15) not null default '',
  `groupcode` int(2) not null default 0,
  `groupname` varchar(255) not null default '',
  `result` int(9) not null default 0,
  KEY `hospcode` (`hospcode`),
  KEY `areacode` (`areacode`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

#DELETE FROM t_person_sex_age1560 WHERE year= year(now())+543;


INSERT INTO t_person_sex_age1560
(
`id`,`year`,`hospcode`,`areacode`,`sex`,`groupcode`,`groupname`,`result`
)
(
	SELECT SQL_BIG_RESULT 
	@id as id,(@b_year+543) as year,ag.hospcode,ag.vhid,ag.sex,ag.groupcode,ag.groupname,ag.result
	FROM
			(SELECT
			hospcode,vhid,if(sex=1,'ชาย',if(sex=2,'หญิง','ระบุไม่ได้' )) as sex ,groupcode1560 as groupcode ,groupname1560 as groupname,COUNT(*) as result
			FROM
			tmp_person_agegroup
			GROUP BY
			hospcode,vhid,sex,groupcode1560
			ORDER BY hospcode,vhid
			) as ag
);


DROP TABLE IF EXISTS t_person_sex_age060 ;

CREATE TABLE IF NOT EXISTS t_person_sex_age060 (
  `id` varchar(32) not null default '',
	`year` varchar(4) not null default '',
	`hospcode` varchar(5) not null default '',
  `areacode` varchar(8) not null default '',
  `sex` varchar(15) not null default '',
  `groupcode` int(2) not null default 0,
  `groupname` varchar(255) not null default '',
  `result` int(9) not null default 0,
  KEY `hospcode` (`hospcode`),
  KEY `areacode` (`areacode`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

#DELETE FROM t_person_sex_age060 WHERE year= year(now())+543;


INSERT INTO t_person_sex_age060
(
`id`,`year`,`hospcode`,`areacode`,`sex`,`groupcode`,`groupname`,`result`
)
(
	SELECT SQL_BIG_RESULT 
	@id as id,(@b_year+543) as year,ag.hospcode,ag.vhid,ag.sex,ag.groupcode,ag.groupname,ag.result
	FROM
			(SELECT
			hospcode,vhid,if(sex=1,'ชาย',if(sex=2,'หญิง','ระบุไม่ได้' )) as sex ,groupcode060 as groupcode ,groupname060 as groupname,COUNT(*) as result
			FROM
			tmp_person_agegroup
			GROUP BY
			hospcode,vhid,sex,groupcode060
			ORDER BY hospcode,vhid
			) as ag
);


DROP TABLE IF EXISTS t_person_sex_age3560 ;

CREATE TABLE IF NOT EXISTS t_person_sex_age3560 (
  `id` varchar(32) not null default '',
	`year` varchar(4) not null default '',
	`hospcode` varchar(5) not null default '',
  `areacode` varchar(8) not null default '',
  `sex` varchar(15) not null default '',
  `groupcode` int(2) not null default 0,
  `groupname` varchar(255) not null default '',
  `result` int(9) not null default 0,
  KEY `hospcode` (`hospcode`),
  KEY `areacode` (`areacode`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

#DELETE FROM t_person_sex_age3560 WHERE year= year(now())+543;


INSERT INTO t_person_sex_age3560
(
`id`,`year`,`hospcode`,`areacode`,`sex`,`groupcode`,`groupname`,`result`
)
(
	SELECT SQL_BIG_RESULT 
	@id as id,(@b_year+543) as year,ag.hospcode,ag.vhid,ag.sex,ag.groupcode,ag.groupname,ag.result
	FROM
			(SELECT
			hospcode,vhid,if(sex=1,'ชาย',if(sex=2,'หญิง','ระบุไม่ได้' )) as sex ,groupcode3560 as groupcode ,groupname3560 as groupname,COUNT(*) as result
			FROM
			tmp_person_agegroup
			GROUP BY
			hospcode,vhid,sex,groupcode3560
			ORDER BY hospcode,vhid
			) as ag
);

DROP TABLE IF EXISTS tmp_person_agegroup;
DROP TABLE IF EXISTS tmp_labor_agegroup;

 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.7064431;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:85;a:5:{i:0;s:34:"DROP PROCEDURE IF EXISTS t_diagopd";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.7064431;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:86;a:5:{i:0;s:34:"DROP PROCEDURE IF EXISTS t_diagopd";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.7688429;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:88;a:5:{i:0;s:2357:"CREATE PROCEDURE t_diagopd()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '10';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'0701');
SET @end_d:=concat(@b_year,'0930');

DROP TABLES IF EXISTS tmp_diag_opd;
CREATE TABLE IF NOT EXISTS tmp_diag_opd (
KEY(cid),KEY(hospcode),KEY(pid),KEY(seq),KEY(date_serv),KEY(diagcode),KEY(diagtype),KEY(hospcode,pid,seq)
) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		o.*,p.CID
FROM
	diagnosis_opd o 
	LEFT JOIN t_person_db p ON o.HOSPCODE=p.HOSPCODE AND o.PID=p.PID
WHERE	DATE_SERV BETWEEN @start_d AND @end_d
);


DROP TABLES IF EXISTS tmp_procedure_opd;
CREATE TABLE IF NOT EXISTS tmp_procedure_opd(
KEY(cid),KEY(hospcode),KEY(pid),KEY(seq),KEY(date_serv),KEY(procedcode),KEY(hospcode,pid,seq),KEY(hospcode,pid,procedcode)
) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		o.HOSPCODE,o.PID,o.SEQ,o.DATE_SERV,o.CLINIC,o.PROCEDCODE,o.serviceprice,o.PROVIDER,o.D_UPDATE,p.CID
FROM
	procedure_opd o 
	LEFT JOIN t_person_db p ON o.HOSPCODE=p.HOSPCODE AND o.PID=p.PID
WHERE	DATE_SERV BETWEEN @start_d AND @end_d
);

DROP TABLES IF EXISTS tmp_diag_opd1;
CREATE TABLE IF NOT EXISTS tmp_diag_opd1 ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
	o.HOSPCODE,p.CID,p.SEX,p.BIRTH,age(o.DATE_SERV,p.BIRTH,'y') as age_y
	,p.NATION,SUBSTR(DATE_FORMAT(DATE_SERV,'%Y%m'),1,6) as yymm,o.diagcode,d.code298
FROM
	tmp_diag_opd o 
	LEFT JOIN cdisease d ON o.diagcode=d.diagcode
	LEFT JOIN t_person_db p ON o.hospcode=p.hospcode AND o.pid=p.pid
WHERE o.diagtype in('1')
);

DROP TABLES IF EXISTS t_diag_opd;
CREATE TABLE IF NOT EXISTS t_diag_opd ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
	o.HOSPCODE,concat(h.provcode,h.distcode,h.subdistcode,SUBSTR(CONCAT('00',h.mu),-2)) as areacode,o.CID,o.SEX,age_y,o.NATION,o.yymm,o.diagcode
	,o.code298,groupcode190,groupcode1560,groupcode060,groupcode3560
FROM
	tmp_diag_opd1 o 
	LEFT JOIN cage c ON o.age_y=c.age
	LEFT JOIN chospital h ON o.hospcode=h.hoscode
WHERE h.provcode =@prov_c
);

DROP TABLES IF EXISTS t_diag_opd_sex;
CREATE TABLE IF NOT EXISTS t_diag_opd_sex ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
	hospcode,areacode, sex,code298,COUNT(*) as result
FROM 
	t_diag_opd 
GROUP BY 
hospcode,areacode,sex,code298
);

DROP TABLES IF EXISTS tmp_diag_opd1;
#DROP TABLES IF EXISTS tmp_diag_opd;
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.7688429;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:89;a:5:{i:0;s:2357:"CREATE PROCEDURE t_diagopd()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '10';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'0701');
SET @end_d:=concat(@b_year,'0930');

DROP TABLES IF EXISTS tmp_diag_opd;
CREATE TABLE IF NOT EXISTS tmp_diag_opd (
KEY(cid),KEY(hospcode),KEY(pid),KEY(seq),KEY(date_serv),KEY(diagcode),KEY(diagtype),KEY(hospcode,pid,seq)
) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		o.*,p.CID
FROM
	diagnosis_opd o 
	LEFT JOIN t_person_db p ON o.HOSPCODE=p.HOSPCODE AND o.PID=p.PID
WHERE	DATE_SERV BETWEEN @start_d AND @end_d
);


DROP TABLES IF EXISTS tmp_procedure_opd;
CREATE TABLE IF NOT EXISTS tmp_procedure_opd(
KEY(cid),KEY(hospcode),KEY(pid),KEY(seq),KEY(date_serv),KEY(procedcode),KEY(hospcode,pid,seq),KEY(hospcode,pid,procedcode)
) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		o.HOSPCODE,o.PID,o.SEQ,o.DATE_SERV,o.CLINIC,o.PROCEDCODE,o.serviceprice,o.PROVIDER,o.D_UPDATE,p.CID
FROM
	procedure_opd o 
	LEFT JOIN t_person_db p ON o.HOSPCODE=p.HOSPCODE AND o.PID=p.PID
WHERE	DATE_SERV BETWEEN @start_d AND @end_d
);

DROP TABLES IF EXISTS tmp_diag_opd1;
CREATE TABLE IF NOT EXISTS tmp_diag_opd1 ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
	o.HOSPCODE,p.CID,p.SEX,p.BIRTH,age(o.DATE_SERV,p.BIRTH,'y') as age_y
	,p.NATION,SUBSTR(DATE_FORMAT(DATE_SERV,'%Y%m'),1,6) as yymm,o.diagcode,d.code298
FROM
	tmp_diag_opd o 
	LEFT JOIN cdisease d ON o.diagcode=d.diagcode
	LEFT JOIN t_person_db p ON o.hospcode=p.hospcode AND o.pid=p.pid
WHERE o.diagtype in('1')
);

DROP TABLES IF EXISTS t_diag_opd;
CREATE TABLE IF NOT EXISTS t_diag_opd ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
	o.HOSPCODE,concat(h.provcode,h.distcode,h.subdistcode,SUBSTR(CONCAT('00',h.mu),-2)) as areacode,o.CID,o.SEX,age_y,o.NATION,o.yymm,o.diagcode
	,o.code298,groupcode190,groupcode1560,groupcode060,groupcode3560
FROM
	tmp_diag_opd1 o 
	LEFT JOIN cage c ON o.age_y=c.age
	LEFT JOIN chospital h ON o.hospcode=h.hoscode
WHERE h.provcode =@prov_c
);

DROP TABLES IF EXISTS t_diag_opd_sex;
CREATE TABLE IF NOT EXISTS t_diag_opd_sex ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
	hospcode,areacode, sex,code298,COUNT(*) as result
FROM 
	t_diag_opd 
GROUP BY 
hospcode,areacode,sex,code298
);

DROP TABLES IF EXISTS tmp_diag_opd1;
#DROP TABLES IF EXISTS tmp_diag_opd;
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.831243;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:91;a:5:{i:0;s:34:"DROP PROCEDURE IF EXISTS t_diagipd";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.831243;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:92;a:5:{i:0;s:34:"DROP PROCEDURE IF EXISTS t_diagipd";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.8780429;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:94;a:5:{i:0;s:2498:"CREATE PROCEDURE t_diagipd()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '11';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLES IF EXISTS tmp_diag_ipd;
CREATE TABLE IF NOT EXISTS tmp_diag_ipd (
KEY(cid), KEY(hospcode), KEY(datetime_admit), KEY(datetime_disch), KEY(diagcode), KEY(diagtype),KEY(an),KEY(hospcode,an)
)ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		i.*,p.CID,a.datetime_disch
FROM
	diagnosis_ipd i 
	LEFT JOIN t_person_db p ON  i.HOSPCODE=p.HOSPCODE AND i.PID=p.PID
	LEFT JOIN admission a ON i.HOSPCODE=a.HOSPCODE AND i.pid=a.pid AND i.an=a.an
WHERE	(DATE_FORMAT(i.DATETIME_ADMIT,'%Y%m%d') BETWEEN @start_d AND @end_d OR DATE_FORMAT(a.DATETIME_DISCH,'%Y%m%d') BETWEEN @start_d AND @end_d)
);



DROP TABLES IF EXISTS tmp_procedure_ipd;
CREATE TABLE IF NOT EXISTS tmp_procedure_ipd (
KEY(cid), KEY(hospcode), KEY(datetime_admit), KEY(procedcode) ,KEY(an),KEY(hospcode,an),KEY(hospcode,an,procedcode)
) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		i.*,p.CID
FROM
	procedure_ipd i 
	LEFT JOIN t_person_db p ON i.HOSPCODE=p.HOSPCODE AND i.PID=p.PID
WHERE	DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d') BETWEEN @start_d AND @end_d
);

DROP TABLES IF EXISTS tmp_diag_ipd1;
CREATE TABLE IF NOT EXISTS tmp_diag_ipd1 ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
	o.HOSPCODE,p.CID,p.SEX,p.BIRTH,age(o.DATETIME_DISCH,p.BIRTH,'y') as age_y
	,p.NATION,SUBSTR(DATE_FORMAT(DATETIME_DISCH,'%Y%m'),1,6) as yymm,o.diagcode,d.code298
FROM
	tmp_diag_ipd o LEFT JOIN cdisease d ON o.diagcode=d.diagcode 
  LEFT JOIN t_person_db p ON o.hospcode=p.hospcode AND o.pid=p.pid
WHERE o.diagtype in('1')
);

DROP TABLES IF EXISTS t_diag_ipd;
CREATE TABLE IF NOT EXISTS t_diag_ipd ENGINE=MyISAM  AS(
SELECT
	o.HOSPCODE,concat(h.provcode,h.distcode,h.subdistcode,SUBSTR(CONCAT('00',h.mu),-2)) as areacode,o.CID,o.SEX,age_y,o.NATION,o.yymm,o.diagcode
	,o.code298,groupcode190,groupcode1560,groupcode060,groupcode3560
FROM
	tmp_diag_ipd1 o 
	LEFT JOIN cage c ON o.age_y=c.age
  LEFT JOIN chospital h ON o.hospcode=h.hoscode
WHERE h.provcode =@prov_c
);

DROP TABLES IF EXISTS t_diag_ipd_sex;
CREATE TABLE IF NOT EXISTS t_diag_ipd_sex ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
	hospcode,areacode, sex,code298,COUNT(*) as result
FROM 
	t_diag_ipd 
GROUP BY 
hospcode,areacode,sex,code298
);

DROP TABLES IF EXISTS tmp_diag_ipd1;
#DROP TABLES IF EXISTS tmp_diag_ipd;

 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.8780429;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:95;a:5:{i:0;s:2498:"CREATE PROCEDURE t_diagipd()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '11';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLES IF EXISTS tmp_diag_ipd;
CREATE TABLE IF NOT EXISTS tmp_diag_ipd (
KEY(cid), KEY(hospcode), KEY(datetime_admit), KEY(datetime_disch), KEY(diagcode), KEY(diagtype),KEY(an),KEY(hospcode,an)
)ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		i.*,p.CID,a.datetime_disch
FROM
	diagnosis_ipd i 
	LEFT JOIN t_person_db p ON  i.HOSPCODE=p.HOSPCODE AND i.PID=p.PID
	LEFT JOIN admission a ON i.HOSPCODE=a.HOSPCODE AND i.pid=a.pid AND i.an=a.an
WHERE	(DATE_FORMAT(i.DATETIME_ADMIT,'%Y%m%d') BETWEEN @start_d AND @end_d OR DATE_FORMAT(a.DATETIME_DISCH,'%Y%m%d') BETWEEN @start_d AND @end_d)
);



DROP TABLES IF EXISTS tmp_procedure_ipd;
CREATE TABLE IF NOT EXISTS tmp_procedure_ipd (
KEY(cid), KEY(hospcode), KEY(datetime_admit), KEY(procedcode) ,KEY(an),KEY(hospcode,an),KEY(hospcode,an,procedcode)
) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		i.*,p.CID
FROM
	procedure_ipd i 
	LEFT JOIN t_person_db p ON i.HOSPCODE=p.HOSPCODE AND i.PID=p.PID
WHERE	DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d') BETWEEN @start_d AND @end_d
);

DROP TABLES IF EXISTS tmp_diag_ipd1;
CREATE TABLE IF NOT EXISTS tmp_diag_ipd1 ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
	o.HOSPCODE,p.CID,p.SEX,p.BIRTH,age(o.DATETIME_DISCH,p.BIRTH,'y') as age_y
	,p.NATION,SUBSTR(DATE_FORMAT(DATETIME_DISCH,'%Y%m'),1,6) as yymm,o.diagcode,d.code298
FROM
	tmp_diag_ipd o LEFT JOIN cdisease d ON o.diagcode=d.diagcode 
  LEFT JOIN t_person_db p ON o.hospcode=p.hospcode AND o.pid=p.pid
WHERE o.diagtype in('1')
);

DROP TABLES IF EXISTS t_diag_ipd;
CREATE TABLE IF NOT EXISTS t_diag_ipd ENGINE=MyISAM  AS(
SELECT
	o.HOSPCODE,concat(h.provcode,h.distcode,h.subdistcode,SUBSTR(CONCAT('00',h.mu),-2)) as areacode,o.CID,o.SEX,age_y,o.NATION,o.yymm,o.diagcode
	,o.code298,groupcode190,groupcode1560,groupcode060,groupcode3560
FROM
	tmp_diag_ipd1 o 
	LEFT JOIN cage c ON o.age_y=c.age
  LEFT JOIN chospital h ON o.hospcode=h.hoscode
WHERE h.provcode =@prov_c
);

DROP TABLES IF EXISTS t_diag_ipd_sex;
CREATE TABLE IF NOT EXISTS t_diag_ipd_sex ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
	hospcode,areacode, sex,code298,COUNT(*) as result
FROM 
	t_diag_ipd 
GROUP BY 
hospcode,areacode,sex,code298
);

DROP TABLES IF EXISTS tmp_diag_ipd1;
#DROP TABLES IF EXISTS tmp_diag_ipd;

 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.9248431;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:97;a:5:{i:0;s:34:"DROP PROCEDURE IF EXISTS t_chronic";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.9248431;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:98;a:5:{i:0;s:34:"DROP PROCEDURE IF EXISTS t_chronic";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.0028429;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:100;a:5:{i:0;s:5259:"CREATE PROCEDURE t_chronic()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '12';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'0701');
SET @end_d:=concat(@b_year,'0930');


DROP TABLES IF EXISTS tmp_chronic;

CREATE TABLE IF NOT EXISTS tmp_chronic (
KEY(cid),
KEY(chronic)
) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		c.*,p.CID
FROM
		chronic c
		INNER JOIN t_person_db  p on p.HOSPCODE=c.HOSPCODE AND p.PID=c.PID
WHERE 
	c.CHRONIC in(SELECT id_chronic FROM cchronic )
  AND c.typedisch between 1 and 9
ORDER BY c.DATE_DIAG
);

DROP TABLES IF EXISTS tmp_chronic_opd;
CREATE TABLE IF NOT EXISTS tmp_chronic_opd (
KEY(cid),
KEY(diagcode)
) ENGINE=MyISAM  AS(
SELECT
		c.*
FROM
	tmp_diag_opd c
WHERE c.DATE_SERV BETWEEN @start_d AND @end_d
	AND c.DIAGCODE in(SELECT id_chronic FROM cchronic )
GROUP BY c.HOSPCODE,c.PID,c.DIAGCODE
ORDER BY c.DATE_SERV
);

DROP TABLES IF EXISTS tmp_chronic_ipd;
CREATE TABLE IF NOT EXISTS tmp_chronic_ipd (
KEY(cid),
KEY(diagcode)
) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		c.*
FROM
	tmp_diag_ipd c
WHERE DATE_FORMAT(c.DATETIME_ADMIT,'%Y%m%d') BETWEEN @start_d AND @end_d
		AND c.DIAGCODE in(SELECT id_chronic FROM cchronic )
GROUP BY c.HOSPCODE,c.PID,c.DIAGCODE
ORDER BY DATETIME_ADMIT
);


DROP TABLES IF EXISTS t_chronic;
CREATE TABLE IF NOT EXISTS t_chronic(
		cid VARCHAR(13) NOT NULL
		,birth date
		,age_y INT(3) DEFAULT 0
		,age_y_dx INT(3) DEFAULT 0
		,groupcode INT(3) DEFAULT 0
		,sex VARCHAR(1) DEFAULT NULL 
		,nation VARCHAR(3) DEFAULT NULL 
		,p_hospcode VARCHAR(5) DEFAULT NULL 
		,d_hospcode VARCHAR(5) DEFAULT NULL 
		,p_pt_vhid VARCHAR(8) DEFAULT NULL 
		,d_pt_vhid VARCHAR(8) DEFAULT NULL 
		,p_typearea VARCHAR(1) DEFAULT NULL 
		,d_typearea VARCHAR(1) DEFAULT NULL 
		,input_hosp VARCHAR(5) DEFAULT NULL 
		,input_pid VARCHAR(15) DEFAULT NULL 
		,source_tb VARCHAR(20) DEFAULT NULL 
		,diagcode VARCHAR(10) NOT NULL
		,date_dx date DEFAULT NULL 
		,hosp_dx VARCHAR(5) DEFAULT NULL 
		,hosp_rx VARCHAR(5) DEFAULT NULL 
		,typedisch VARCHAR(2) DEFAULT NULL 
		,datedisch date DEFAULT NULL 
		,minscl VARCHAR(5) DEFAULT NULL 
		,inscl VARCHAR(3) DEFAULT NULL 
	,PRIMARY KEY (cid,diagcode)
	,KEY (cid)
	,KEY (diagcode)

) ENGINE=MyISAM DEFAULT CHARSET=utf8;

/*import from chronic*/
INSERT IGNORE INTO t_chronic
(
	cid,birth,age_y,age_y_dx,sex,nation,p_hospcode,d_hospcode,p_pt_vhid,d_pt_vhid
	,p_typearea,d_typearea,input_hosp,input_pid,source_tb,diagcode,date_dx
	,hosp_dx,hosp_rx,typedisch,datedisch,minscl,inscl
)
(
SELECT SQL_BIG_RESULT 
	p.CID,p.BIRTH,age(NOW(),p.BIRTH,'y'),age(t.date_diag,p.BIRTH,'y'),p.SEX,p.NATION
	,p.HOSPCODE,p.check_hosp,p.vhid,p.check_vhid,p.TYPEAREA,p.check_typearea
	,t.hosp_input,t.pid_input,t.pt_from,t.diagcode,t.date_diag,t.hosp_dx,t.hosp_rx,t.typedisch,t.datedisch
	,p.maininscl,p.inscl

FROM
	(     SELECT
			c.cid,c.HOSPCODE as hosp_input,c.pid as pid_input,date_diag,c.CHRONIC as diagcode
			,IFNULL(c.HOSP_DX,'00000') as HOSP_DX,c.HOSP_RX,c.TYPEDISCH,c.DATE_DISCH as datedisch,'chronic' as pt_from
		FROM
			tmp_chronic c
		GROUP BY c.CID,c.CHRONIC
	) as t INNER JOIN t_person_cid p ON p.cid=t.cid
);

/*import from diagopd*/
INSERT IGNORE INTO t_chronic
(
	cid,birth,age_y,age_y_dx,sex,nation,p_hospcode,d_hospcode,p_pt_vhid,d_pt_vhid
	,p_typearea,d_typearea,input_hosp,input_pid,source_tb,diagcode,date_dx
	,hosp_dx,hosp_rx,minscl,inscl
)
(
SELECT SQL_BIG_RESULT 
	p.CID,p.BIRTH,age(NOW(),p.BIRTH,'y'),age(t.date_diag,p.BIRTH,'y'),p.SEX,p.NATION
	,p.HOSPCODE,p.check_hosp,p.vhid,p.check_vhid,p.TYPEAREA,p.check_typearea
	,t.hosp_input,t.pid_input,t.pt_from,t.diagcode,t.date_diag,t.hosp_dx,t.hosp_rx
	,p.maininscl,p.inscl

FROM
	(
		SELECT
			o.cid,o.HOSPCODE hosp_input,o.pid pid_input,o.date_serv date_diag,o.diagcode
			,o.HOSPCODE hosp_dx,o.HOSPCODE hosp_rx,'diag_opd' as pt_from
		FROM
			tmp_chronic_opd o
		GROUP BY o.cid,o.diagcode
	) as t INNER JOIN t_person_cid p ON p.cid=t.cid
);

/*import from diagipd*/
INSERT IGNORE INTO t_chronic
(
	cid,birth,age_y,age_y_dx,sex,nation,p_hospcode,d_hospcode,p_pt_vhid,d_pt_vhid
	,p_typearea,d_typearea,input_hosp,input_pid,source_tb,diagcode,date_dx
	,hosp_dx,hosp_rx,minscl,inscl
)
(
SELECT SQL_BIG_RESULT 
	p.CID,p.BIRTH,age(NOW(),p.BIRTH,'y'),age(t.date_diag,p.BIRTH,'y'),p.SEX,p.NATION
	,p.HOSPCODE,p.check_hosp,p.vhid,p.check_vhid,p.TYPEAREA,p.check_typearea
	,t.hosp_input,t.pid_input,t.pt_from,t.diagcode,t.date_diag,t.hosp_dx,t.hosp_rx
	,p.maininscl,p.inscl

FROM
	(
		SELECT
			i.cid,i.HOSPCODE hosp_input,i.pid pid_input,DATE_FORMAT(i.DATETIME_ADMIT,'%Y-%m-%d') date_diag,i.diagcode
			,i.HOSPCODE hosp_dx,i.HOSPCODE hosp_rx,'diag_ipd' as pt_from
		FROM
			tmp_chronic_ipd i
		GROUP BY i.cid,i.diagcode
	) as t INNER JOIN t_person_cid p ON p.cid=t.cid
);





UPDATE t_chronic t ,cage  ag SET t.groupcode=ag.groupcode1560
WHERE t.age_y=ag.age ;

/*
UPDATE t_chronic c,tmp_chronic tc
		SET c.typedisch=tc.typedisch,c.date_dx=tc.DATE_DIAG
WHERE c.cid = tc.cid AND c.diagcode=tc.chronic;
*/

UPDATE t_chronic c,t_person_cid p SET c.typedisch='02'  
WHERE c.cid=p.cid AND p.DISCHARGE=1;

 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.0028429;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:101;a:5:{i:0;s:5259:"CREATE PROCEDURE t_chronic()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '12';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'0701');
SET @end_d:=concat(@b_year,'0930');


DROP TABLES IF EXISTS tmp_chronic;

CREATE TABLE IF NOT EXISTS tmp_chronic (
KEY(cid),
KEY(chronic)
) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		c.*,p.CID
FROM
		chronic c
		INNER JOIN t_person_db  p on p.HOSPCODE=c.HOSPCODE AND p.PID=c.PID
WHERE 
	c.CHRONIC in(SELECT id_chronic FROM cchronic )
  AND c.typedisch between 1 and 9
ORDER BY c.DATE_DIAG
);

DROP TABLES IF EXISTS tmp_chronic_opd;
CREATE TABLE IF NOT EXISTS tmp_chronic_opd (
KEY(cid),
KEY(diagcode)
) ENGINE=MyISAM  AS(
SELECT
		c.*
FROM
	tmp_diag_opd c
WHERE c.DATE_SERV BETWEEN @start_d AND @end_d
	AND c.DIAGCODE in(SELECT id_chronic FROM cchronic )
GROUP BY c.HOSPCODE,c.PID,c.DIAGCODE
ORDER BY c.DATE_SERV
);

DROP TABLES IF EXISTS tmp_chronic_ipd;
CREATE TABLE IF NOT EXISTS tmp_chronic_ipd (
KEY(cid),
KEY(diagcode)
) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		c.*
FROM
	tmp_diag_ipd c
WHERE DATE_FORMAT(c.DATETIME_ADMIT,'%Y%m%d') BETWEEN @start_d AND @end_d
		AND c.DIAGCODE in(SELECT id_chronic FROM cchronic )
GROUP BY c.HOSPCODE,c.PID,c.DIAGCODE
ORDER BY DATETIME_ADMIT
);


DROP TABLES IF EXISTS t_chronic;
CREATE TABLE IF NOT EXISTS t_chronic(
		cid VARCHAR(13) NOT NULL
		,birth date
		,age_y INT(3) DEFAULT 0
		,age_y_dx INT(3) DEFAULT 0
		,groupcode INT(3) DEFAULT 0
		,sex VARCHAR(1) DEFAULT NULL 
		,nation VARCHAR(3) DEFAULT NULL 
		,p_hospcode VARCHAR(5) DEFAULT NULL 
		,d_hospcode VARCHAR(5) DEFAULT NULL 
		,p_pt_vhid VARCHAR(8) DEFAULT NULL 
		,d_pt_vhid VARCHAR(8) DEFAULT NULL 
		,p_typearea VARCHAR(1) DEFAULT NULL 
		,d_typearea VARCHAR(1) DEFAULT NULL 
		,input_hosp VARCHAR(5) DEFAULT NULL 
		,input_pid VARCHAR(15) DEFAULT NULL 
		,source_tb VARCHAR(20) DEFAULT NULL 
		,diagcode VARCHAR(10) NOT NULL
		,date_dx date DEFAULT NULL 
		,hosp_dx VARCHAR(5) DEFAULT NULL 
		,hosp_rx VARCHAR(5) DEFAULT NULL 
		,typedisch VARCHAR(2) DEFAULT NULL 
		,datedisch date DEFAULT NULL 
		,minscl VARCHAR(5) DEFAULT NULL 
		,inscl VARCHAR(3) DEFAULT NULL 
	,PRIMARY KEY (cid,diagcode)
	,KEY (cid)
	,KEY (diagcode)

) ENGINE=MyISAM DEFAULT CHARSET=utf8;

/*import from chronic*/
INSERT IGNORE INTO t_chronic
(
	cid,birth,age_y,age_y_dx,sex,nation,p_hospcode,d_hospcode,p_pt_vhid,d_pt_vhid
	,p_typearea,d_typearea,input_hosp,input_pid,source_tb,diagcode,date_dx
	,hosp_dx,hosp_rx,typedisch,datedisch,minscl,inscl
)
(
SELECT SQL_BIG_RESULT 
	p.CID,p.BIRTH,age(NOW(),p.BIRTH,'y'),age(t.date_diag,p.BIRTH,'y'),p.SEX,p.NATION
	,p.HOSPCODE,p.check_hosp,p.vhid,p.check_vhid,p.TYPEAREA,p.check_typearea
	,t.hosp_input,t.pid_input,t.pt_from,t.diagcode,t.date_diag,t.hosp_dx,t.hosp_rx,t.typedisch,t.datedisch
	,p.maininscl,p.inscl

FROM
	(     SELECT
			c.cid,c.HOSPCODE as hosp_input,c.pid as pid_input,date_diag,c.CHRONIC as diagcode
			,IFNULL(c.HOSP_DX,'00000') as HOSP_DX,c.HOSP_RX,c.TYPEDISCH,c.DATE_DISCH as datedisch,'chronic' as pt_from
		FROM
			tmp_chronic c
		GROUP BY c.CID,c.CHRONIC
	) as t INNER JOIN t_person_cid p ON p.cid=t.cid
);

/*import from diagopd*/
INSERT IGNORE INTO t_chronic
(
	cid,birth,age_y,age_y_dx,sex,nation,p_hospcode,d_hospcode,p_pt_vhid,d_pt_vhid
	,p_typearea,d_typearea,input_hosp,input_pid,source_tb,diagcode,date_dx
	,hosp_dx,hosp_rx,minscl,inscl
)
(
SELECT SQL_BIG_RESULT 
	p.CID,p.BIRTH,age(NOW(),p.BIRTH,'y'),age(t.date_diag,p.BIRTH,'y'),p.SEX,p.NATION
	,p.HOSPCODE,p.check_hosp,p.vhid,p.check_vhid,p.TYPEAREA,p.check_typearea
	,t.hosp_input,t.pid_input,t.pt_from,t.diagcode,t.date_diag,t.hosp_dx,t.hosp_rx
	,p.maininscl,p.inscl

FROM
	(
		SELECT
			o.cid,o.HOSPCODE hosp_input,o.pid pid_input,o.date_serv date_diag,o.diagcode
			,o.HOSPCODE hosp_dx,o.HOSPCODE hosp_rx,'diag_opd' as pt_from
		FROM
			tmp_chronic_opd o
		GROUP BY o.cid,o.diagcode
	) as t INNER JOIN t_person_cid p ON p.cid=t.cid
);

/*import from diagipd*/
INSERT IGNORE INTO t_chronic
(
	cid,birth,age_y,age_y_dx,sex,nation,p_hospcode,d_hospcode,p_pt_vhid,d_pt_vhid
	,p_typearea,d_typearea,input_hosp,input_pid,source_tb,diagcode,date_dx
	,hosp_dx,hosp_rx,minscl,inscl
)
(
SELECT SQL_BIG_RESULT 
	p.CID,p.BIRTH,age(NOW(),p.BIRTH,'y'),age(t.date_diag,p.BIRTH,'y'),p.SEX,p.NATION
	,p.HOSPCODE,p.check_hosp,p.vhid,p.check_vhid,p.TYPEAREA,p.check_typearea
	,t.hosp_input,t.pid_input,t.pt_from,t.diagcode,t.date_diag,t.hosp_dx,t.hosp_rx
	,p.maininscl,p.inscl

FROM
	(
		SELECT
			i.cid,i.HOSPCODE hosp_input,i.pid pid_input,DATE_FORMAT(i.DATETIME_ADMIT,'%Y-%m-%d') date_diag,i.diagcode
			,i.HOSPCODE hosp_dx,i.HOSPCODE hosp_rx,'diag_ipd' as pt_from
		FROM
			tmp_chronic_ipd i
		GROUP BY i.cid,i.diagcode
	) as t INNER JOIN t_person_cid p ON p.cid=t.cid
);





UPDATE t_chronic t ,cage  ag SET t.groupcode=ag.groupcode1560
WHERE t.age_y=ag.age ;

/*
UPDATE t_chronic c,tmp_chronic tc
		SET c.typedisch=tc.typedisch,c.date_dx=tc.DATE_DIAG
WHERE c.cid = tc.cid AND c.diagcode=tc.chronic;
*/

UPDATE t_chronic c,t_person_cid p SET c.typedisch='02'  
WHERE c.cid=p.cid AND p.DISCHARGE=1;

 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.049643;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:103;a:5:{i:0;s:31:"DROP PROCEDURE IF EXISTS t_dmht";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.049643;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:104;a:5:{i:0;s:31:"DROP PROCEDURE IF EXISTS t_dmht";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.1276431;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:106;a:5:{i:0;s:17166:"CREATE PROCEDURE t_dmht()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '13';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-2,'1001');
SET	@start_d1:=concat(@b_year-1,'0701');
SET	@start_d2:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLES IF EXISTS tmp_labfu;
CREATE TABLE IF NOT EXISTS tmp_labfu( 
  `HOSPCODE` varchar(5) NOT NULL,
  `PID` varchar(15) NOT NULL,
  `SEQ` varchar(16) NOT NULL,
  `DATE_SERV` date NOT NULL,
  `LABTEST` varchar(7) NOT NULL DEFAULT '',
  `LABRESULT` double(6,2) NOT NULL,
  `D_UPDATE` datetime NOT NULL,
  `CID` varchar(13) DEFAULT NULL,
  `LABTEST_SEND` varchar(7) DEFAULT NULL,
  `LABTEST_NEW` varchar(7) DEFAULT NULL,
PRIMARY KEY (HOSPCODE,PID,SEQ,LABTEST_SEND),
KEY (hospcode),KEY (pid),KEY (seq),KEY (cid),
KEY (date_serv),KEY (labtest),KEY (labresult),
KEY (LABTEST_SEND), KEY (LABTEST_NEW)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO tmp_labfu (HOSPCODE,PID,SEQ,DATE_SERV,LABTEST_SEND,LABRESULT,D_UPDATE,CID)
(SELECT SQL_BIG_RESULT 
				l.HOSPCODE,l.PID,l.SEQ,l.DATE_SERV,l.LABTEST,l.LABRESULT,l.D_UPDATE,p.CID
FROM
	labfu l LEFT JOIN t_person_db p ON  l.HOSPCODE=p.HOSPCODE AND l.PID=p.PID
WHERE	DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY HOSPCODE,PID,SEQ,LABTEST
);

UPDATE tmp_labfu l SET l.LABTEST=l.LABTEST_SEND WHERE LENGTH(TRIM(l.LABTEST_SEND)) =2;

UPDATE tmp_labfu l INNER JOIN clabtest_new c ON l.LABTEST=c.old_code 
SET l.LABTEST_NEW=c.`code`
WHERE LENGTH(TRIM(l.LABTEST)) =2;

UPDATE tmp_labfu l INNER JOIN clabtest_new c ON l.LABTEST_SEND=c.`code` 
SET l.LABTEST=c.old_code , l.LABTEST_NEW=c.`code`
WHERE LENGTH(TRIM(l.LABTEST_SEND)) > 2;


DROP TABLES IF EXISTS tmp_chronicfu;
CREATE TABLE IF NOT EXISTS tmp_chronicfu (
KEY (hospcode),
KEY (pid),
KEY (seq),
KEY (cid),
KEY (date_serv),
KEY (sbp),
KEY (dbp),
KEY (foot),
KEY (retina)
)ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		c.*,p.CID
FROM
	chronicfu c LEFT JOIN t_person_db p ON c.HOSPCODE=p.HOSPCODE AND c.PID=p.PID
WHERE	DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY HOSPCODE,PID,SEQ
	);

DROP TABLE IF EXISTS t_chronicfu;
CREATE  TABLE IF NOT EXISTS t_chronicfu(
hospcode VARCHAR(5) NOT NULL,
pid VARCHAR(15) NOT NULL,
cid VARCHAR(13) NOT NULL,
ld_bp1 date DEFAULT NULL,
ld_bp2 date DEFAULT NULL,
sbp_1 VARCHAR(10) DEFAULT NULL,
dbp_1 VARCHAR(10) DEFAULT NULL,
sbp_2 VARCHAR(10) DEFAULT NULL,
dbp_2 VARCHAR(10) DEFAULT NULL,
ld_hba1c date DEFAULT NULL,
hba1c  VARCHAR(10) DEFAULT NULL,
ld_foot date DEFAULT NULL ,
foot VARCHAR(10)  DEFAULT NULL,
ld_retina date DEFAULT NULL, 
retina VARCHAR(10)  DEFAULT NULL ,
control_dm int(1) DEFAULT '0',
control_ht int(1) DEFAULT '0',
PRIMARY KEY (cid,hospcode),
KEY (cid),
KEY (hospcode)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 AS
(
SELECT hospcode,pid,cid,null as sbp_1 ,null as dbp_1,null as sbp_2,null as dbp_2,null as hba1c
,null as ld_foot,null as foot,null as ld_retina,null as retina,0 as control_dm ,0 as control_ht
FROM tmp_chronicfu 
WHERE LENGTH(cid)=13  AND DATE_SERV BETWEEN @start_d2 AND @end_d
GROUP BY HOSPCODE,cid
);
UPDATE t_chronicfu f INNER JOIN (
	SELECT hospcode , pid ,max(date_serv) date_serv 
	FROM tmp_labfu WHERE labtest in(5) 
	GROUP BY hospcode,PID
) l ON f.hospcode=l.hospcode AND f.pid=l.pid
SET f.ld_hba1c=l.date_serv;

UPDATE t_chronicfu f INNER JOIN tmp_labfu l ON f.hospcode=l.hospcode AND f.pid=l.pid AND f.ld_hba1c=l.DATE_SERV 
SET f.hba1c=l.LABRESULT
WHERE l.LABTEST in(5);

UPDATE t_chronicfu SET control_dm='1' WHERE  (hba1c BETWEEN 0.1  AND 6.99)	AND ld_hba1c BETWEEN @start_d2 AND @end_d	;

UPDATE t_chronicfu d ,	
								(SELECT c.HOSPCODE, c.PID ,c.DATE_SERV,c.SBP,c.DBP
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV =
								(SELECT c1.DATE_SERV FROM tmp_chronicfu c1 WHERE c1.HOSPCODE=c.HOSPCODE  AND c1.pid=c.pid 
									and c1.SBP >0 AND c1.DBP>0  GROUP BY c1.HOSPCODE,c1.PID,c1.DATE_SERV 
									ORDER BY c1.date_serv desc LIMIT 0,1)
								GROUP BY hospcode,PID) as t
		SET ld_bp1 =t.DATE_SERV,sbp_1 =t.SBP,dbp_1 =t.DBP
WHERE		d.HOSPCODE=t.HOSPCODE  AND d.pid=t.pid  ;
/*last_bp2*/
UPDATE t_chronicfu d ,	
								(SELECT c.HOSPCODE, c.PID ,c.DATE_SERV,c.SBP,c.DBP
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV =
								(SELECT c1.DATE_SERV FROM tmp_chronicfu c1 WHERE c1.HOSPCODE=c.HOSPCODE  AND c1.pid=c.pid 
									and c1.SBP >0 AND c1.DBP>0  GROUP BY c1.HOSPCODE,c1.PID,c1.DATE_SERV 
									ORDER BY c1.date_serv desc LIMIT 1,1)
								GROUP BY hospcode,PID) as t
		SET ld_bp2 =t.DATE_SERV,sbp_2 =t.SBP,dbp_2 =t.DBP
WHERE		d.HOSPCODE=t.HOSPCODE  AND d.pid=t.pid  ;

UPDATE t_chronicfu SET control_ht ='1'	 WHERE 		
 (sbp_1  > 50 AND sbp_1 <= 139) AND (sbp_2 > 50 AND sbp_2 <=139 )
AND (dbp_1 > 50 AND dbp_1 <= 89) AND (dbp_1 > 50 AND dbp_1 <= 89) AND ld_bp1 BETWEEN @start_d2 AND @end_d ;

UPDATE t_chronicfu f INNER JOIN (
	SELECT hospcode , pid ,max(date_serv) date_serv 
	FROM tmp_chronicfu WHERE foot in(1,3) 
	GROUP BY hospcode,PID
) l ON f.hospcode=l.hospcode AND f.pid=l.pid
SET f.ld_foot=l.date_serv;

UPDATE t_chronicfu f INNER JOIN tmp_chronicfu l ON f.hospcode=l.hospcode AND f.pid=l.pid AND f.ld_foot=l.DATE_SERV 
SET f.foot=l.foot;

UPDATE t_chronicfu f INNER JOIN (
	SELECT hospcode , pid ,max(date_serv) date_serv 
	FROM tmp_chronicfu WHERE retina in(1,2,3,4) 
	GROUP BY hospcode,PID
) l ON f.hospcode=l.hospcode AND f.pid=l.pid
SET f.ld_retina=l.date_serv;

UPDATE t_chronicfu f INNER JOIN tmp_chronicfu l ON f.hospcode=l.hospcode AND f.pid=l.pid AND f.ld_retina=l.DATE_SERV 
SET f.retina=l.retina;


DROP TABLES IF EXISTS t_dmht;
CREATE TABLE IF NOT EXISTS t_dmht (
		id int(15) NOT NULL AUTO_INCREMENT
		,hospcode VARCHAR(5) DEFAULT NULL 
		,pid VARCHAR(15)  DEFAULT NULL 
		,vhid VARCHAR(8) DEFAULT NULL 
		,typearea VARCHAR(1) DEFAULT NULL 
		,cid VARCHAR(13) NOT NULL
		,birth date
		,age_y INT(3) DEFAULT 0
		,groupcode1560 VARCHAR(100) DEFAULT NULL 
		,groupname1560 VARCHAR(100) DEFAULT NULL 
		,sex VARCHAR(1) DEFAULT NULL 
		,nation VARCHAR(3) DEFAULT NULL 
		,source_tb VARCHAR(255) DEFAULT NULL 
		,mix_dx VARCHAR(255) DEFAULT NULL 	
		,t_mix_dx VARCHAR(255) DEFAULT NULL 	
		,type_dx VARCHAR(2) DEFAULT NULL 
		,date_dx VARCHAR(255) DEFAULT NULL 
		,hosp_dx varchar(255) DEFAULT NULL 
		,minscl VARCHAR(5) DEFAULT NULL 
		,inscl VARCHAR(3) DEFAULT NULL 
		,ld_hba1c date  DEFAULT NULL 
		,rs_hba1c VARCHAR(10)  DEFAULT NULL
		,ih_hba1c  VARCHAR(5)  DEFAULT NULL
		,ld_fpg1 date DEFAULT NULL 
		,rs_fpg1 VARCHAR(10)  DEFAULT NULL 
		,ih_fpg1  VARCHAR(5)  DEFAULT NULL
		,ld_fpg2 date DEFAULT NULL 
		,rs_fpg2 VARCHAR(10)  DEFAULT NULL 
		,ih_fpg2  VARCHAR(5)  DEFAULT NULL
		,ld_fpg3 date DEFAULT NULL 
		,rs_fpg3 VARCHAR(10)  DEFAULT NULL 
		,ih_fpg3  VARCHAR(5)  DEFAULT NULL
		,ld_creatinine date DEFAULT NULL 
		,rs_creatinine VARCHAR(10)  DEFAULT NULL 
		,ih_creatinine VARCHAR(5)  DEFAULT NULL
		,ld_lipid date DEFAULT NULL 
		,rs_lipid VARCHAR(10)  DEFAULT NULL 
		,ih_lipid VARCHAR(5)  DEFAULT NULL
		,ld_foot date DEFAULT NULL 
		,rs_foot VARCHAR(10)  DEFAULT NULL
		,ih_foot VARCHAR(5)  DEFAULT NULL 
		,ld_retina date DEFAULT NULL 
		,rs_retina VARCHAR(10)  DEFAULT NULL 
		,ih_retina VARCHAR(5)  DEFAULT NULL 
		,ld_bp1 date DEFAULT NULL 
		,ih_bp1 VARCHAR(5)  DEFAULT NULL 
		,rs_bps1 VARCHAR(10)  DEFAULT NULL 
		,rs_bpd1 VARCHAR(10)  DEFAULT NULL 
		,ld_bp2 date  DEFAULT NULL 
		,ih_bp2 VARCHAR(5)  DEFAULT NULL 
		,rs_bps2 VARCHAR(10)  DEFAULT NULL 
		,rs_bpd2 VARCHAR(10)  DEFAULT NULL 
		,`complication_dm` varchar(20) DEFAULT '0',
  `complication_ht` varchar(20) DEFAULT '0',
  `control_dm` int(1) DEFAULT '0',
  `control_ht` int(1) DEFAULT '0',
  `bmi` decimal(10,2) DEFAULT '0',
  `obes` int(1) DEFAULT '0',
  `height` smallint(6) DEFAULT '0',
  `weight` mediumint(9) DEFAULT '0',
	`waist_cm`  smallint(6) NULL DEFAULT 0 ,
	PRIMARY KEY (cid)
	,KEY (cid)
  ,KEY (id)
	,KEY (type_dx)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO t_dmht(
	hospcode,vhid,typearea,cid,birth,age_y,groupcode1560,groupname1560,sex,nation,minscl,inscl,source_tb,hosp_dx,mix_dx,t_mix_dx,date_dx
)
(
	SELECT SQL_BIG_RESULT 
			p.check_hosp,p.check_vhid,p.check_typearea,p.cid,p.birth,p.age_y,a.groupcode1560,a.groupname1560,p.sex,p.nation
			,p.maininscl,p.inscl
			,GROUP_CONCAT(c.source_tb ORDER BY c.date_dx ) source_tb
			,GROUP_CONCAT(c.hosp_dx ORDER BY c.date_dx ) hosp_dx
			,GROUP_CONCAT(c.diagcode ORDER BY c.date_dx  ) diagcode
			,GROUP_CONCAT(DISTINCT  substr(c.diagcode,1,1) ORDER BY SUBSTR(c.diagcode,1,1)  ) 
			,GROUP_CONCAT(c.date_dx  ORDER BY c.date_dx ) date_dx
FROM
(SELECT * FROM t_chronic 
WHERE  (SUBSTR(UPPER(diagcode),1,3) BETWEEN  'E10' and 'E14'  OR 	SUBSTR(UPPER(diagcode),1,3) BETWEEN  'I10' and 'I15')  
GROUP BY concat(cid,'-',diagcode) ) c 
INNER JOIN t_person_cid  p ON c.cid = p.cid
LEFT JOIN cage a ON	 p.age_y=a.age
WHERE p.nation IN(99)  AND p.DISCHARGE  IN(9)
GROUP BY p.cid
);

/*update pid*/
UPDATE t_dmht d,t_person_cid p  SET d.pid=p.pid WHERE d.cid=p.cid AND d.hospcode=p.hospcode;

/*up_mixdiag*/
UPDATE t_dmht 
	SET type_dx = if(t_mix_dx ='I' ,'01'  
							,if(t_mix_dx ='E' ,'02'
							,if(t_mix_dx ='E,I','03',NULL)));


/*up_hba1c*/
UPDATE IGNORE t_dmht d INNER JOIN 
(SELECT cid,MAX(date_serv) date_serv FROM  tmp_labfu WHERE labtest IN(5) GROUP BY cid) l ON d.cid=l.cid 
SET d.ld_hba1c =l.date_serv;

UPDATE IGNORE t_dmht d INNER JOIN tmp_labfu l ON d.cid=l.cid  AND d.ld_hba1c =l.date_serv
SET d.rs_hba1c =l.labresult ,d.ih_hba1c=l.HOSPCODE
WHERE l.labtest IN(5);


/*up_fpg1*/
UPDATE t_dmht d ,
								(SELECT l.cid,l.HOSPCODE,l.DATE_SERV,l.LABRESULT 
								FROM tmp_labfu l
								WHERE l.labtest in(1,3) 
								    AND l.DATE_SERV =
								(SELECT l1.DATE_SERV FROM tmp_labfu l1 WHERE l1.labtest in(1,3) AND l1.cid=l.cid GROUP BY l1.cid,l1.DATE_SERV ORDER BY l1.date_serv desc LIMIT 0,1)
								GROUP BY cid) as t
		SET ld_fpg1 =t.DATE_SERV,rs_fpg1 =t.LABRESULT ,ih_fpg1=t.hospcode
WHERE
		d.cid=t.cid ;

/*up_fpg2*/
UPDATE t_dmht d ,
								(SELECT l.cid,l.DATE_SERV,l.LABRESULT,l.HOSPCODE
								FROM tmp_labfu l
								WHERE l.labtest in(1,3) 
								    AND l.DATE_SERV =
								(SELECT l1.DATE_SERV FROM tmp_labfu l1 WHERE l1.labtest in(1,3) AND l1.cid=l.cid GROUP BY l1.cid,l1.DATE_SERV ORDER BY l1.date_serv desc LIMIT 1,1)
								GROUP BY cid) as t
		SET ld_fpg2 =t.DATE_SERV,rs_fpg2 =t.LABRESULT ,ih_fpg2=t.hospcode
WHERE
		d.cid=t.cid ;

/*up_fpg3*/
UPDATE t_dmht d ,
								(SELECT l.cid,l.DATE_SERV,l.LABRESULT,l.HOSPCODE
								FROM tmp_labfu l
								WHERE l.labtest in(1,3) 
								    AND l.DATE_SERV =
								(SELECT l1.DATE_SERV FROM tmp_labfu l1 WHERE l1.labtest in(1,3) AND l1.cid=l.cid GROUP BY l1.cid,l1.DATE_SERV ORDER BY l1.date_serv desc LIMIT 2,1)
								GROUP BY cid) as t
		SET ld_fpg3 =t.DATE_SERV,rs_fpg3 =t.LABRESULT,ih_fpg3=t.hospcode
WHERE
		d.cid=t.cid ;
/*Creatinine*/ 
UPDATE t_dmht d ,	
								(SELECT l.cid,l.DATE_SERV,l.LABRESULT,l.HOSPCODE
								FROM tmp_labfu l
								WHERE l.labtest in(11,13) 
								    AND l.DATE_SERV =
								(SELECT l1.DATE_SERV FROM tmp_labfu l1 WHERE l1.labtest in(11,13) AND l1.cid=l.cid GROUP BY l1.cid,l1.DATE_SERV ORDER BY l1.date_serv desc LIMIT 0,1)
								GROUP BY cid) as t
		SET ld_creatinine =t.DATE_SERV,rs_creatinine =t.LABRESULT,ih_creatinine=t.hospcode 
WHERE
		d.cid=t.cid ;

/*lipid TotalCholesterol*/
UPDATE t_dmht d ,	
								(SELECT l.cid,l.DATE_SERV,l.LABRESULT,l.HOSPCODE 
								FROM tmp_labfu l
								WHERE l.labtest in(7) 
								    AND l.DATE_SERV =
								(SELECT l1.DATE_SERV FROM tmp_labfu l1 WHERE l1.labtest in(7) AND l1.cid=l.cid GROUP BY l1.cid,l1.DATE_SERV ORDER BY l1.date_serv desc LIMIT 0,1)
								GROUP BY cid) as t
		SET ld_lipid =t.DATE_SERV,rs_lipid =t.LABRESULT ,ih_lipid=t.hospcode 
WHERE
		d.cid=t.cid ;

/*foot*/
UPDATE t_dmht d ,	
								(SELECT c.cid,c.DATE_SERV,c.FOOT,c.HOSPCODE
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV =
								(SELECT c1.DATE_SERV FROM tmp_chronicfu c1 WHERE c1.cid=c.cid and c1.foot in(1,3) GROUP BY c1.cid,c1.DATE_SERV ORDER BY c1.date_serv desc LIMIT 0,1)
								GROUP BY cid) as t
		SET ld_foot =t.DATE_SERV,rs_foot =t.FOOT,ih_foot=t.hospcode
WHERE
		d.cid=t.cid ;

/*retina*/ 
UPDATE t_dmht d ,	
								(SELECT c.cid,c.DATE_SERV,c.RETINA,c.HOSPCODE
								FROM tmp_chronicfu c
								WHERE c.RETINA in(1,2,3,4)  AND c.DATE_SERV =
								(SELECT c1.DATE_SERV FROM tmp_chronicfu c1 WHERE c1.cid=c.cid and c1.RETINA in(1,2,3,4) GROUP BY c1.cid,c1.DATE_SERV ORDER BY c1.date_serv desc LIMIT 0,1)
								GROUP BY cid) as t
		SET ld_retina =t.DATE_SERV,rs_retina =t.RETINA ,ih_retina=t.hospcode
WHERE
		d.cid=t.cid ;

/*last_bp1*/ 
UPDATE t_dmht d ,	
								(SELECT c.cid,c.DATE_SERV,c.SBP,c.DBP,c.HOSPCODE
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV =
								(SELECT c1.DATE_SERV FROM tmp_chronicfu c1 WHERE c1.cid=c.cid and c1.SBP >0 AND c1.DBP>0  GROUP BY c1.cid,c1.DATE_SERV ORDER BY c1.date_serv desc LIMIT 0,1)
								GROUP BY cid) as t
		SET ld_bp1 =t.DATE_SERV,rs_bps1 =t.SBP,rs_bpd1 =t.DBP,ih_bp1=t.hospcode
WHERE
		d.cid=t.cid ;

/*last_bp2*/
UPDATE t_dmht d ,	
								(SELECT c.cid,c.DATE_SERV,c.SBP,c.DBP,c.HOSPCODE
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV =
								(SELECT c1.DATE_SERV FROM tmp_chronicfu c1 WHERE c1.cid=c.cid and c1.SBP >0 AND c1.DBP>0 GROUP BY c1.cid,c1.DATE_SERV ORDER BY c1.date_serv desc LIMIT 1,1)
								GROUP BY cid) as t
		SET ld_bp2 =t.DATE_SERV,rs_bps2 =t.SBP,rs_bpd2 =t.DBP,ih_bp2=t.hospcode
WHERE
		d.cid=t.cid ;

/*ภาวะแทรกซ้อนทางตา*/
UPDATE t_dmht t , (
					SELECT 
							cid
					FROM
					tmp_chronic_opd 
					WHERE diagcode in('E103','E113','E123','E133','E143','H360','H280')
)  d SET complication_dm='1' WHERE t.cid=d.cid AND d.cid is not null AND t.type_dx in(2,3);
/*ไต*/
UPDATE t_dmht t , (
					SELECT 
							cid
					FROM
					tmp_chronic_opd 
					WHERE diagcode in('E102','E112','E122','E132','E142','N083')
)  d SET complication_dm='2' WHERE t.cid=d.cid AND d.cid is not null AND t.type_dx in(2,3);

/*เท้า*/
UPDATE t_dmht t , (
					SELECT 
							cid
					FROM
					tmp_chronic_opd 
					WHERE diagcode in('E104','E114','E124','E134','E144','I792','E105','E115','E125','E135','E145' )
)  d SET complication_dm='3' WHERE t.cid=d.cid AND d.cid is not null AND t.type_dx in(2,3);

/*หลายอย่าง*/
UPDATE t_dmht t , (
					SELECT 
							cid
					FROM
					tmp_chronic_opd 
					WHERE diagcode in('E107','E117','E127','E137','E147')
)  d SET complication_dm='4' WHERE t.cid=d.cid AND d.cid is not null AND t.type_dx in(2,3);
/*ภาวะนำ้ตาลตำ่*/
UPDATE t_dmht t , (
					SELECT 
							cid
					FROM
					tmp_chronic_opd 
					WHERE diagcode in('E16')
)  d SET complication_dm='5' WHERE t.cid=d.cid AND d.cid is not null AND t.type_dx in(2,3);

UPDATE t_dmht t , (
					SELECT 
							cid
					FROM
					tmp_chronic_opd 
					WHERE diagcode in('E131')
)  d SET complication_dm='6' WHERE t.cid=d.cid AND d.cid is not null AND t.type_dx in(2,3);
/*หัวใจ*/
UPDATE t_dmht t , (
					SELECT 
							cid
					FROM
					tmp_chronic_opd 
					WHERE diagcode in('I110','I119')
)  d SET complication_ht='1' WHERE t.cid=d.cid AND d.cid is not null AND t.type_dx in(1,3);
/*ไต*/
UPDATE t_dmht t , (
					SELECT 
							cid
					FROM
					tmp_chronic_opd 
					WHERE diagcode in('I120','I129')
)  d SET complication_ht='2' WHERE t.cid=d.cid AND d.cid is not null AND t.type_dx in(1,3);

/*ไตหัวใจ*/
UPDATE t_dmht t , (
					SELECT 
							cid
					FROM
					tmp_chronic_opd 
					WHERE diagcode in('I130','I131','I132','I139')
)  d SET complication_ht='3' WHERE t.cid=d.cid AND d.cid is not null AND t.type_dx in(1,3);

/*w,h*/
UPDATE t_dmht t , (
				SELECT
				*
				FROM
				(SELECT 
							cid,weight,height,WAIST_CM
					FROM
					tmp_chronicfu
					WHERE  weight is not null  and height is not null
					ORDER BY DATE_SERV DESC
					) pre
					GROUP BY cid
)  d SET t.weight=d.weight ,t.height=d.height,t.waist_cm=d.waist_cm  WHERE t.cid=d.cid AND d.cid is not null ;

/*up control dm 1 ok 0 not ok*/
UPDATE t_dmht SET control_dm='1' WHERE type_dx in(2,3) AND 
			(rs_hba1c BETWEEN 0.1  AND 6.99)	AND ld_hba1c BETWEEN @start_d2 AND @end_d	;
/*bp control*/
UPDATE t_dmht SET control_ht ='1'	 WHERE 		
type_dx in(1,3) AND (rs_bps1  > 50 AND rs_bps1 <= 139) AND (rs_bps2 > 50 AND rs_bps2 <=139 )
AND (rs_bpd1 > 50 AND rs_bpd1 <= 89) AND (rs_bpd2 > 50 AND rs_bpd2 <= 89) AND ld_bp1 BETWEEN @start_d2 AND @end_d ;

UPDATE t_dmht SET bmi=round(WEIGHT/((HEIGHT/100)*(HEIGHT/100)),2) ;


UPDATE t_dmht SET obes =1 WHERE
(sex='1' AND round(WAIST_CM)>90) OR (sex='2' AND round(WAIST_CM)>80)
OR bmi>=25;

 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.1432431;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:107;a:5:{i:0;s:17166:"CREATE PROCEDURE t_dmht()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '13';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-2,'1001');
SET	@start_d1:=concat(@b_year-1,'0701');
SET	@start_d2:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLES IF EXISTS tmp_labfu;
CREATE TABLE IF NOT EXISTS tmp_labfu( 
  `HOSPCODE` varchar(5) NOT NULL,
  `PID` varchar(15) NOT NULL,
  `SEQ` varchar(16) NOT NULL,
  `DATE_SERV` date NOT NULL,
  `LABTEST` varchar(7) NOT NULL DEFAULT '',
  `LABRESULT` double(6,2) NOT NULL,
  `D_UPDATE` datetime NOT NULL,
  `CID` varchar(13) DEFAULT NULL,
  `LABTEST_SEND` varchar(7) DEFAULT NULL,
  `LABTEST_NEW` varchar(7) DEFAULT NULL,
PRIMARY KEY (HOSPCODE,PID,SEQ,LABTEST_SEND),
KEY (hospcode),KEY (pid),KEY (seq),KEY (cid),
KEY (date_serv),KEY (labtest),KEY (labresult),
KEY (LABTEST_SEND), KEY (LABTEST_NEW)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO tmp_labfu (HOSPCODE,PID,SEQ,DATE_SERV,LABTEST_SEND,LABRESULT,D_UPDATE,CID)
(SELECT SQL_BIG_RESULT 
				l.HOSPCODE,l.PID,l.SEQ,l.DATE_SERV,l.LABTEST,l.LABRESULT,l.D_UPDATE,p.CID
FROM
	labfu l LEFT JOIN t_person_db p ON  l.HOSPCODE=p.HOSPCODE AND l.PID=p.PID
WHERE	DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY HOSPCODE,PID,SEQ,LABTEST
);

UPDATE tmp_labfu l SET l.LABTEST=l.LABTEST_SEND WHERE LENGTH(TRIM(l.LABTEST_SEND)) =2;

UPDATE tmp_labfu l INNER JOIN clabtest_new c ON l.LABTEST=c.old_code 
SET l.LABTEST_NEW=c.`code`
WHERE LENGTH(TRIM(l.LABTEST)) =2;

UPDATE tmp_labfu l INNER JOIN clabtest_new c ON l.LABTEST_SEND=c.`code` 
SET l.LABTEST=c.old_code , l.LABTEST_NEW=c.`code`
WHERE LENGTH(TRIM(l.LABTEST_SEND)) > 2;


DROP TABLES IF EXISTS tmp_chronicfu;
CREATE TABLE IF NOT EXISTS tmp_chronicfu (
KEY (hospcode),
KEY (pid),
KEY (seq),
KEY (cid),
KEY (date_serv),
KEY (sbp),
KEY (dbp),
KEY (foot),
KEY (retina)
)ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		c.*,p.CID
FROM
	chronicfu c LEFT JOIN t_person_db p ON c.HOSPCODE=p.HOSPCODE AND c.PID=p.PID
WHERE	DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY HOSPCODE,PID,SEQ
	);

DROP TABLE IF EXISTS t_chronicfu;
CREATE  TABLE IF NOT EXISTS t_chronicfu(
hospcode VARCHAR(5) NOT NULL,
pid VARCHAR(15) NOT NULL,
cid VARCHAR(13) NOT NULL,
ld_bp1 date DEFAULT NULL,
ld_bp2 date DEFAULT NULL,
sbp_1 VARCHAR(10) DEFAULT NULL,
dbp_1 VARCHAR(10) DEFAULT NULL,
sbp_2 VARCHAR(10) DEFAULT NULL,
dbp_2 VARCHAR(10) DEFAULT NULL,
ld_hba1c date DEFAULT NULL,
hba1c  VARCHAR(10) DEFAULT NULL,
ld_foot date DEFAULT NULL ,
foot VARCHAR(10)  DEFAULT NULL,
ld_retina date DEFAULT NULL, 
retina VARCHAR(10)  DEFAULT NULL ,
control_dm int(1) DEFAULT '0',
control_ht int(1) DEFAULT '0',
PRIMARY KEY (cid,hospcode),
KEY (cid),
KEY (hospcode)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 AS
(
SELECT hospcode,pid,cid,null as sbp_1 ,null as dbp_1,null as sbp_2,null as dbp_2,null as hba1c
,null as ld_foot,null as foot,null as ld_retina,null as retina,0 as control_dm ,0 as control_ht
FROM tmp_chronicfu 
WHERE LENGTH(cid)=13  AND DATE_SERV BETWEEN @start_d2 AND @end_d
GROUP BY HOSPCODE,cid
);
UPDATE t_chronicfu f INNER JOIN (
	SELECT hospcode , pid ,max(date_serv) date_serv 
	FROM tmp_labfu WHERE labtest in(5) 
	GROUP BY hospcode,PID
) l ON f.hospcode=l.hospcode AND f.pid=l.pid
SET f.ld_hba1c=l.date_serv;

UPDATE t_chronicfu f INNER JOIN tmp_labfu l ON f.hospcode=l.hospcode AND f.pid=l.pid AND f.ld_hba1c=l.DATE_SERV 
SET f.hba1c=l.LABRESULT
WHERE l.LABTEST in(5);

UPDATE t_chronicfu SET control_dm='1' WHERE  (hba1c BETWEEN 0.1  AND 6.99)	AND ld_hba1c BETWEEN @start_d2 AND @end_d	;

UPDATE t_chronicfu d ,	
								(SELECT c.HOSPCODE, c.PID ,c.DATE_SERV,c.SBP,c.DBP
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV =
								(SELECT c1.DATE_SERV FROM tmp_chronicfu c1 WHERE c1.HOSPCODE=c.HOSPCODE  AND c1.pid=c.pid 
									and c1.SBP >0 AND c1.DBP>0  GROUP BY c1.HOSPCODE,c1.PID,c1.DATE_SERV 
									ORDER BY c1.date_serv desc LIMIT 0,1)
								GROUP BY hospcode,PID) as t
		SET ld_bp1 =t.DATE_SERV,sbp_1 =t.SBP,dbp_1 =t.DBP
WHERE		d.HOSPCODE=t.HOSPCODE  AND d.pid=t.pid  ;
/*last_bp2*/
UPDATE t_chronicfu d ,	
								(SELECT c.HOSPCODE, c.PID ,c.DATE_SERV,c.SBP,c.DBP
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV =
								(SELECT c1.DATE_SERV FROM tmp_chronicfu c1 WHERE c1.HOSPCODE=c.HOSPCODE  AND c1.pid=c.pid 
									and c1.SBP >0 AND c1.DBP>0  GROUP BY c1.HOSPCODE,c1.PID,c1.DATE_SERV 
									ORDER BY c1.date_serv desc LIMIT 1,1)
								GROUP BY hospcode,PID) as t
		SET ld_bp2 =t.DATE_SERV,sbp_2 =t.SBP,dbp_2 =t.DBP
WHERE		d.HOSPCODE=t.HOSPCODE  AND d.pid=t.pid  ;

UPDATE t_chronicfu SET control_ht ='1'	 WHERE 		
 (sbp_1  > 50 AND sbp_1 <= 139) AND (sbp_2 > 50 AND sbp_2 <=139 )
AND (dbp_1 > 50 AND dbp_1 <= 89) AND (dbp_1 > 50 AND dbp_1 <= 89) AND ld_bp1 BETWEEN @start_d2 AND @end_d ;

UPDATE t_chronicfu f INNER JOIN (
	SELECT hospcode , pid ,max(date_serv) date_serv 
	FROM tmp_chronicfu WHERE foot in(1,3) 
	GROUP BY hospcode,PID
) l ON f.hospcode=l.hospcode AND f.pid=l.pid
SET f.ld_foot=l.date_serv;

UPDATE t_chronicfu f INNER JOIN tmp_chronicfu l ON f.hospcode=l.hospcode AND f.pid=l.pid AND f.ld_foot=l.DATE_SERV 
SET f.foot=l.foot;

UPDATE t_chronicfu f INNER JOIN (
	SELECT hospcode , pid ,max(date_serv) date_serv 
	FROM tmp_chronicfu WHERE retina in(1,2,3,4) 
	GROUP BY hospcode,PID
) l ON f.hospcode=l.hospcode AND f.pid=l.pid
SET f.ld_retina=l.date_serv;

UPDATE t_chronicfu f INNER JOIN tmp_chronicfu l ON f.hospcode=l.hospcode AND f.pid=l.pid AND f.ld_retina=l.DATE_SERV 
SET f.retina=l.retina;


DROP TABLES IF EXISTS t_dmht;
CREATE TABLE IF NOT EXISTS t_dmht (
		id int(15) NOT NULL AUTO_INCREMENT
		,hospcode VARCHAR(5) DEFAULT NULL 
		,pid VARCHAR(15)  DEFAULT NULL 
		,vhid VARCHAR(8) DEFAULT NULL 
		,typearea VARCHAR(1) DEFAULT NULL 
		,cid VARCHAR(13) NOT NULL
		,birth date
		,age_y INT(3) DEFAULT 0
		,groupcode1560 VARCHAR(100) DEFAULT NULL 
		,groupname1560 VARCHAR(100) DEFAULT NULL 
		,sex VARCHAR(1) DEFAULT NULL 
		,nation VARCHAR(3) DEFAULT NULL 
		,source_tb VARCHAR(255) DEFAULT NULL 
		,mix_dx VARCHAR(255) DEFAULT NULL 	
		,t_mix_dx VARCHAR(255) DEFAULT NULL 	
		,type_dx VARCHAR(2) DEFAULT NULL 
		,date_dx VARCHAR(255) DEFAULT NULL 
		,hosp_dx varchar(255) DEFAULT NULL 
		,minscl VARCHAR(5) DEFAULT NULL 
		,inscl VARCHAR(3) DEFAULT NULL 
		,ld_hba1c date  DEFAULT NULL 
		,rs_hba1c VARCHAR(10)  DEFAULT NULL
		,ih_hba1c  VARCHAR(5)  DEFAULT NULL
		,ld_fpg1 date DEFAULT NULL 
		,rs_fpg1 VARCHAR(10)  DEFAULT NULL 
		,ih_fpg1  VARCHAR(5)  DEFAULT NULL
		,ld_fpg2 date DEFAULT NULL 
		,rs_fpg2 VARCHAR(10)  DEFAULT NULL 
		,ih_fpg2  VARCHAR(5)  DEFAULT NULL
		,ld_fpg3 date DEFAULT NULL 
		,rs_fpg3 VARCHAR(10)  DEFAULT NULL 
		,ih_fpg3  VARCHAR(5)  DEFAULT NULL
		,ld_creatinine date DEFAULT NULL 
		,rs_creatinine VARCHAR(10)  DEFAULT NULL 
		,ih_creatinine VARCHAR(5)  DEFAULT NULL
		,ld_lipid date DEFAULT NULL 
		,rs_lipid VARCHAR(10)  DEFAULT NULL 
		,ih_lipid VARCHAR(5)  DEFAULT NULL
		,ld_foot date DEFAULT NULL 
		,rs_foot VARCHAR(10)  DEFAULT NULL
		,ih_foot VARCHAR(5)  DEFAULT NULL 
		,ld_retina date DEFAULT NULL 
		,rs_retina VARCHAR(10)  DEFAULT NULL 
		,ih_retina VARCHAR(5)  DEFAULT NULL 
		,ld_bp1 date DEFAULT NULL 
		,ih_bp1 VARCHAR(5)  DEFAULT NULL 
		,rs_bps1 VARCHAR(10)  DEFAULT NULL 
		,rs_bpd1 VARCHAR(10)  DEFAULT NULL 
		,ld_bp2 date  DEFAULT NULL 
		,ih_bp2 VARCHAR(5)  DEFAULT NULL 
		,rs_bps2 VARCHAR(10)  DEFAULT NULL 
		,rs_bpd2 VARCHAR(10)  DEFAULT NULL 
		,`complication_dm` varchar(20) DEFAULT '0',
  `complication_ht` varchar(20) DEFAULT '0',
  `control_dm` int(1) DEFAULT '0',
  `control_ht` int(1) DEFAULT '0',
  `bmi` decimal(10,2) DEFAULT '0',
  `obes` int(1) DEFAULT '0',
  `height` smallint(6) DEFAULT '0',
  `weight` mediumint(9) DEFAULT '0',
	`waist_cm`  smallint(6) NULL DEFAULT 0 ,
	PRIMARY KEY (cid)
	,KEY (cid)
  ,KEY (id)
	,KEY (type_dx)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO t_dmht(
	hospcode,vhid,typearea,cid,birth,age_y,groupcode1560,groupname1560,sex,nation,minscl,inscl,source_tb,hosp_dx,mix_dx,t_mix_dx,date_dx
)
(
	SELECT SQL_BIG_RESULT 
			p.check_hosp,p.check_vhid,p.check_typearea,p.cid,p.birth,p.age_y,a.groupcode1560,a.groupname1560,p.sex,p.nation
			,p.maininscl,p.inscl
			,GROUP_CONCAT(c.source_tb ORDER BY c.date_dx ) source_tb
			,GROUP_CONCAT(c.hosp_dx ORDER BY c.date_dx ) hosp_dx
			,GROUP_CONCAT(c.diagcode ORDER BY c.date_dx  ) diagcode
			,GROUP_CONCAT(DISTINCT  substr(c.diagcode,1,1) ORDER BY SUBSTR(c.diagcode,1,1)  ) 
			,GROUP_CONCAT(c.date_dx  ORDER BY c.date_dx ) date_dx
FROM
(SELECT * FROM t_chronic 
WHERE  (SUBSTR(UPPER(diagcode),1,3) BETWEEN  'E10' and 'E14'  OR 	SUBSTR(UPPER(diagcode),1,3) BETWEEN  'I10' and 'I15')  
GROUP BY concat(cid,'-',diagcode) ) c 
INNER JOIN t_person_cid  p ON c.cid = p.cid
LEFT JOIN cage a ON	 p.age_y=a.age
WHERE p.nation IN(99)  AND p.DISCHARGE  IN(9)
GROUP BY p.cid
);

/*update pid*/
UPDATE t_dmht d,t_person_cid p  SET d.pid=p.pid WHERE d.cid=p.cid AND d.hospcode=p.hospcode;

/*up_mixdiag*/
UPDATE t_dmht 
	SET type_dx = if(t_mix_dx ='I' ,'01'  
							,if(t_mix_dx ='E' ,'02'
							,if(t_mix_dx ='E,I','03',NULL)));


/*up_hba1c*/
UPDATE IGNORE t_dmht d INNER JOIN 
(SELECT cid,MAX(date_serv) date_serv FROM  tmp_labfu WHERE labtest IN(5) GROUP BY cid) l ON d.cid=l.cid 
SET d.ld_hba1c =l.date_serv;

UPDATE IGNORE t_dmht d INNER JOIN tmp_labfu l ON d.cid=l.cid  AND d.ld_hba1c =l.date_serv
SET d.rs_hba1c =l.labresult ,d.ih_hba1c=l.HOSPCODE
WHERE l.labtest IN(5);


/*up_fpg1*/
UPDATE t_dmht d ,
								(SELECT l.cid,l.HOSPCODE,l.DATE_SERV,l.LABRESULT 
								FROM tmp_labfu l
								WHERE l.labtest in(1,3) 
								    AND l.DATE_SERV =
								(SELECT l1.DATE_SERV FROM tmp_labfu l1 WHERE l1.labtest in(1,3) AND l1.cid=l.cid GROUP BY l1.cid,l1.DATE_SERV ORDER BY l1.date_serv desc LIMIT 0,1)
								GROUP BY cid) as t
		SET ld_fpg1 =t.DATE_SERV,rs_fpg1 =t.LABRESULT ,ih_fpg1=t.hospcode
WHERE
		d.cid=t.cid ;

/*up_fpg2*/
UPDATE t_dmht d ,
								(SELECT l.cid,l.DATE_SERV,l.LABRESULT,l.HOSPCODE
								FROM tmp_labfu l
								WHERE l.labtest in(1,3) 
								    AND l.DATE_SERV =
								(SELECT l1.DATE_SERV FROM tmp_labfu l1 WHERE l1.labtest in(1,3) AND l1.cid=l.cid GROUP BY l1.cid,l1.DATE_SERV ORDER BY l1.date_serv desc LIMIT 1,1)
								GROUP BY cid) as t
		SET ld_fpg2 =t.DATE_SERV,rs_fpg2 =t.LABRESULT ,ih_fpg2=t.hospcode
WHERE
		d.cid=t.cid ;

/*up_fpg3*/
UPDATE t_dmht d ,
								(SELECT l.cid,l.DATE_SERV,l.LABRESULT,l.HOSPCODE
								FROM tmp_labfu l
								WHERE l.labtest in(1,3) 
								    AND l.DATE_SERV =
								(SELECT l1.DATE_SERV FROM tmp_labfu l1 WHERE l1.labtest in(1,3) AND l1.cid=l.cid GROUP BY l1.cid,l1.DATE_SERV ORDER BY l1.date_serv desc LIMIT 2,1)
								GROUP BY cid) as t
		SET ld_fpg3 =t.DATE_SERV,rs_fpg3 =t.LABRESULT,ih_fpg3=t.hospcode
WHERE
		d.cid=t.cid ;
/*Creatinine*/ 
UPDATE t_dmht d ,	
								(SELECT l.cid,l.DATE_SERV,l.LABRESULT,l.HOSPCODE
								FROM tmp_labfu l
								WHERE l.labtest in(11,13) 
								    AND l.DATE_SERV =
								(SELECT l1.DATE_SERV FROM tmp_labfu l1 WHERE l1.labtest in(11,13) AND l1.cid=l.cid GROUP BY l1.cid,l1.DATE_SERV ORDER BY l1.date_serv desc LIMIT 0,1)
								GROUP BY cid) as t
		SET ld_creatinine =t.DATE_SERV,rs_creatinine =t.LABRESULT,ih_creatinine=t.hospcode 
WHERE
		d.cid=t.cid ;

/*lipid TotalCholesterol*/
UPDATE t_dmht d ,	
								(SELECT l.cid,l.DATE_SERV,l.LABRESULT,l.HOSPCODE 
								FROM tmp_labfu l
								WHERE l.labtest in(7) 
								    AND l.DATE_SERV =
								(SELECT l1.DATE_SERV FROM tmp_labfu l1 WHERE l1.labtest in(7) AND l1.cid=l.cid GROUP BY l1.cid,l1.DATE_SERV ORDER BY l1.date_serv desc LIMIT 0,1)
								GROUP BY cid) as t
		SET ld_lipid =t.DATE_SERV,rs_lipid =t.LABRESULT ,ih_lipid=t.hospcode 
WHERE
		d.cid=t.cid ;

/*foot*/
UPDATE t_dmht d ,	
								(SELECT c.cid,c.DATE_SERV,c.FOOT,c.HOSPCODE
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV =
								(SELECT c1.DATE_SERV FROM tmp_chronicfu c1 WHERE c1.cid=c.cid and c1.foot in(1,3) GROUP BY c1.cid,c1.DATE_SERV ORDER BY c1.date_serv desc LIMIT 0,1)
								GROUP BY cid) as t
		SET ld_foot =t.DATE_SERV,rs_foot =t.FOOT,ih_foot=t.hospcode
WHERE
		d.cid=t.cid ;

/*retina*/ 
UPDATE t_dmht d ,	
								(SELECT c.cid,c.DATE_SERV,c.RETINA,c.HOSPCODE
								FROM tmp_chronicfu c
								WHERE c.RETINA in(1,2,3,4)  AND c.DATE_SERV =
								(SELECT c1.DATE_SERV FROM tmp_chronicfu c1 WHERE c1.cid=c.cid and c1.RETINA in(1,2,3,4) GROUP BY c1.cid,c1.DATE_SERV ORDER BY c1.date_serv desc LIMIT 0,1)
								GROUP BY cid) as t
		SET ld_retina =t.DATE_SERV,rs_retina =t.RETINA ,ih_retina=t.hospcode
WHERE
		d.cid=t.cid ;

/*last_bp1*/ 
UPDATE t_dmht d ,	
								(SELECT c.cid,c.DATE_SERV,c.SBP,c.DBP,c.HOSPCODE
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV =
								(SELECT c1.DATE_SERV FROM tmp_chronicfu c1 WHERE c1.cid=c.cid and c1.SBP >0 AND c1.DBP>0  GROUP BY c1.cid,c1.DATE_SERV ORDER BY c1.date_serv desc LIMIT 0,1)
								GROUP BY cid) as t
		SET ld_bp1 =t.DATE_SERV,rs_bps1 =t.SBP,rs_bpd1 =t.DBP,ih_bp1=t.hospcode
WHERE
		d.cid=t.cid ;

/*last_bp2*/
UPDATE t_dmht d ,	
								(SELECT c.cid,c.DATE_SERV,c.SBP,c.DBP,c.HOSPCODE
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV =
								(SELECT c1.DATE_SERV FROM tmp_chronicfu c1 WHERE c1.cid=c.cid and c1.SBP >0 AND c1.DBP>0 GROUP BY c1.cid,c1.DATE_SERV ORDER BY c1.date_serv desc LIMIT 1,1)
								GROUP BY cid) as t
		SET ld_bp2 =t.DATE_SERV,rs_bps2 =t.SBP,rs_bpd2 =t.DBP,ih_bp2=t.hospcode
WHERE
		d.cid=t.cid ;

/*ภาวะแทรกซ้อนทางตา*/
UPDATE t_dmht t , (
					SELECT 
							cid
					FROM
					tmp_chronic_opd 
					WHERE diagcode in('E103','E113','E123','E133','E143','H360','H280')
)  d SET complication_dm='1' WHERE t.cid=d.cid AND d.cid is not null AND t.type_dx in(2,3);
/*ไต*/
UPDATE t_dmht t , (
					SELECT 
							cid
					FROM
					tmp_chronic_opd 
					WHERE diagcode in('E102','E112','E122','E132','E142','N083')
)  d SET complication_dm='2' WHERE t.cid=d.cid AND d.cid is not null AND t.type_dx in(2,3);

/*เท้า*/
UPDATE t_dmht t , (
					SELECT 
							cid
					FROM
					tmp_chronic_opd 
					WHERE diagcode in('E104','E114','E124','E134','E144','I792','E105','E115','E125','E135','E145' )
)  d SET complication_dm='3' WHERE t.cid=d.cid AND d.cid is not null AND t.type_dx in(2,3);

/*หลายอย่าง*/
UPDATE t_dmht t , (
					SELECT 
							cid
					FROM
					tmp_chronic_opd 
					WHERE diagcode in('E107','E117','E127','E137','E147')
)  d SET complication_dm='4' WHERE t.cid=d.cid AND d.cid is not null AND t.type_dx in(2,3);
/*ภาวะนำ้ตาลตำ่*/
UPDATE t_dmht t , (
					SELECT 
							cid
					FROM
					tmp_chronic_opd 
					WHERE diagcode in('E16')
)  d SET complication_dm='5' WHERE t.cid=d.cid AND d.cid is not null AND t.type_dx in(2,3);

UPDATE t_dmht t , (
					SELECT 
							cid
					FROM
					tmp_chronic_opd 
					WHERE diagcode in('E131')
)  d SET complication_dm='6' WHERE t.cid=d.cid AND d.cid is not null AND t.type_dx in(2,3);
/*หัวใจ*/
UPDATE t_dmht t , (
					SELECT 
							cid
					FROM
					tmp_chronic_opd 
					WHERE diagcode in('I110','I119')
)  d SET complication_ht='1' WHERE t.cid=d.cid AND d.cid is not null AND t.type_dx in(1,3);
/*ไต*/
UPDATE t_dmht t , (
					SELECT 
							cid
					FROM
					tmp_chronic_opd 
					WHERE diagcode in('I120','I129')
)  d SET complication_ht='2' WHERE t.cid=d.cid AND d.cid is not null AND t.type_dx in(1,3);

/*ไตหัวใจ*/
UPDATE t_dmht t , (
					SELECT 
							cid
					FROM
					tmp_chronic_opd 
					WHERE diagcode in('I130','I131','I132','I139')
)  d SET complication_ht='3' WHERE t.cid=d.cid AND d.cid is not null AND t.type_dx in(1,3);

/*w,h*/
UPDATE t_dmht t , (
				SELECT
				*
				FROM
				(SELECT 
							cid,weight,height,WAIST_CM
					FROM
					tmp_chronicfu
					WHERE  weight is not null  and height is not null
					ORDER BY DATE_SERV DESC
					) pre
					GROUP BY cid
)  d SET t.weight=d.weight ,t.height=d.height,t.waist_cm=d.waist_cm  WHERE t.cid=d.cid AND d.cid is not null ;

/*up control dm 1 ok 0 not ok*/
UPDATE t_dmht SET control_dm='1' WHERE type_dx in(2,3) AND 
			(rs_hba1c BETWEEN 0.1  AND 6.99)	AND ld_hba1c BETWEEN @start_d2 AND @end_d	;
/*bp control*/
UPDATE t_dmht SET control_ht ='1'	 WHERE 		
type_dx in(1,3) AND (rs_bps1  > 50 AND rs_bps1 <= 139) AND (rs_bps2 > 50 AND rs_bps2 <=139 )
AND (rs_bpd1 > 50 AND rs_bpd1 <= 89) AND (rs_bpd2 > 50 AND rs_bpd2 <= 89) AND ld_bp1 BETWEEN @start_d2 AND @end_d ;

UPDATE t_dmht SET bmi=round(WEIGHT/((HEIGHT/100)*(HEIGHT/100)),2) ;


UPDATE t_dmht SET obes =1 WHERE
(sex='1' AND round(WAIST_CM)>90) OR (sex='2' AND round(WAIST_CM)>80)
OR bmi>=25;

 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.2056429;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:109;a:5:{i:0;s:36:"DROP PROCEDURE IF EXISTS t_ncdscreen";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.2056429;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:110;a:5:{i:0;s:36:"DROP PROCEDURE IF EXISTS t_ncdscreen";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.283644;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:112;a:5:{i:0;s:7505:"CREATE PROCEDURE t_ncdscreen()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '14';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-2,'1001');
SET	@start_d1:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
SET @end_d1:=concat(@b_year-1,'0930');

DROP TABLES IF EXISTS tmp_ncdscreen;
CREATE TABLE IF NOT EXISTS tmp_ncdscreen (error_code varchar(255) DEFAULT NULL, KEY(cid)) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		n.*,p.CID,null as error_code
FROM
	ncdscreen n left join t_person_db p ON n.HOSPCODE=p.HOSPCODE AND n.PID=p.PID
WHERE	DATE_SERV BETWEEN @start_d AND @end_d
);

UPDATE tmp_ncdscreen 
SET error_code =IF(ISNULL(error_code),'NCD0001',CONCAT(error_code,',','NCD0001') ) 
WHERE  DATE_SERV BETWEEN @start_d1 AND @end_d AND HEIGHT NOT BETWEEN 90 AND 250;

UPDATE tmp_ncdscreen 
SET error_code =IF(ISNULL(error_code),'NCD0002',CONCAT(error_code,',','NCD0002') ) 
WHERE  DATE_SERV BETWEEN @start_d1 AND @end_d AND WEIGHT NOT BETWEEN  10 AND 300;

UPDATE tmp_ncdscreen n INNER JOIN person p  ON n.HOSPCODE=p.HOSPCODE AND n.PID=p.PID
SET error_code =IF(ISNULL(n.error_code),'NCD0003',CONCAT(n.error_code,',','NCD0003') ) 
WHERE  DATE_SERV BETWEEN @start_d1 AND @end_d AND n.DATE_SERV < p.BIRTH;


DROP TABLES IF EXISTS t_ncdscreen;
CREATE TABLE IF NOT EXISTS t_ncdscreen (
KEY(hospcode),KEY(check_hosp),KEY(cid),KEY(date_serv),KEY(bslevel),KEY(bstest),KEY(sbp_1,dbp_1),KEY(sbp_2,dbp_2),KEY(sex)
) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
ns.*,c.groupcode3560,c.groupname3560
FROM
		(SELECT
				n.*,age(n.DATE_SERV,p.BIRTH,'y') as age_y,p.check_hosp,p.check_typearea,p.TYPEAREA,p.check_vhid,p.vhid,p.nation,p.sex
		FROM
			tmp_ncdscreen n LEFT JOIN t_person_cid p ON n.cid=p.cid
		WHERE	DATE_SERV BETWEEN @start_d AND @end_d
		) as ns,cage c 
WHERE ns.age_y=c.age
);
/*เบาหวาน*/
DROP  TABLE IF EXISTS  t_person_dm_screen;
CREATE  TABLE IF NOT EXISTS t_person_dm_screen (
  hospcode varchar(5) DEFAULT NULL,
  areacode varchar(8) DEFAULT NULL,
  cid varchar(13) NOT NULL DEFAULT '',
  pid varchar(15) DEFAULT NULL,
	age_y int(3) DEFAULT '0',
	typearea  varchar(1) DEFAULT NULL,
	date_screen date ,
  bslevel int(6)  DEFAULT '0',
	bstest  varchar(1) DEFAULT NULL,
  ill varchar(1) default null,
  risk varchar(1) default null,
PRIMARY KEY (cid),
	KEY (hospcode),
	KEY (areacode),
	KEY (pid),
	KEY (typearea),
  KEY (risk)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO t_person_dm_screen(
  hospcode,areacode,cid,pid,age_y,typearea
)
SELECT pe.check_hosp HOSPCODE
								,pe.check_vhid as areacode
								,pe.CID,pe.PID,pe.age_y,pe.check_typearea TYPEAREA
				FROM
						t_person_cid pe
				WHERE
						substr(pe.check_vhid,1,2)=@prov_c
						AND pe.nation=99 
						AND pe.DISCHARGE=9 
						AND pe.age_y>=15 
						AND pe.check_typearea in(1,3)
						AND cid not in(SELECT cid FROM t_dmht WHERE type_dx in(2,3))
ORDER BY check_hosp,check_typearea
;

UPDATE t_person_dm_screen p,t_ncdscreen n SET p.date_screen=n.DATE_SERV  ,p.bslevel=n.BSLEVEL, p.bstest=n.bstest
WHERE p.cid=n.cid AND n.DATE_SERV BETWEEN @start_d1 AND @end_d;

update t_person_dm_screen p inner join t_dmht d 
SET ill='1'
WHERE p.cid=d.cid AND d.type_dx in(2,3);

update t_person_dm_screen SET risk='0'
where (((bstest in('1','3') OR bstest is null) AND bslevel >= 70 AND bslevel <= 100 ) OR
(bstest in('2','4') AND bslevel >= 70 AND bslevel <= 140));

update t_person_dm_screen SET risk='1'
where (((bstest in('1','3') OR bstest is null) AND bslevel > 100 AND bslevel <= 125 ) OR 
(bstest in('2','4')   AND bslevel > 140 AND bslevel <= 200 ));

update t_person_dm_screen SET risk='2'
where (((bstest in('1','3') OR bstest is null) AND bslevel > 125) OR
(bstest in('2','4') AND bslevel > 200));


/*ความดัน*/
DROP  TABLE IF EXISTS  t_person_ht_screen;
CREATE  TABLE IF NOT EXISTS t_person_ht_screen (
  hospcode varchar(5) DEFAULT NULL,
  areacode varchar(8) DEFAULT NULL,
  cid varchar(13) NOT NULL DEFAULT '',
  pid varchar(15) DEFAULT NULL,
	age_y int(3) DEFAULT '0',
	typearea  varchar(1) DEFAULT NULL,
	date_screen date ,
  sbp_1 int(3)  DEFAULT 0,
	dbp_1 int(3)  DEFAULT 0,
	sbp_2 int(3)  DEFAULT 0,
	dbp_2 int(3)  DEFAULT 0,
  ill varchar(1) default null,
	sbp int(3)  DEFAULT 0,
	dbp int(3)  DEFAULT 0,
	risk varchar(1) default null,
PRIMARY KEY (cid),
	KEY (hospcode),
	KEY (areacode),
	KEY (pid),
	KEY (typearea),
	KEY (risk)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO t_person_ht_screen(
  hospcode,areacode,cid,pid,age_y,typearea
)
SELECT pe.check_hosp HOSPCODE
								,pe.check_vhid as areacode
								,pe.CID,pe.PID,pe.age_y,pe.check_typearea TYPEAREA
				FROM
						t_person_cid pe
				WHERE
						substr(pe.check_vhid,1,2)=@prov_c
						AND pe.nation=99 
						AND pe.DISCHARGE=9 
						AND pe.age_y>=15 
						AND pe.check_typearea in(1,3)
						AND cid not in(SELECT cid FROM t_dmht WHERE type_dx in(1,3))
ORDER BY check_hosp,check_typearea
;

UPDATE t_person_ht_screen p,t_ncdscreen n SET p.date_screen=n.DATE_SERV  ,p.sbp_1=n.SBP_1,p.sbp_2=n.SBP_2,p.dbp_1=n.dBP_1,p.dbp_2=n.dBP_2
WHERE p.cid=n.cid AND n.DATE_SERV BETWEEN @start_d1 AND @end_d;

update t_person_ht_screen p inner join t_dmht d 
SET ill='1'
WHERE p.cid=d.cid AND d.type_dx in(1,3);

update t_person_ht_screen SET sbp=sbp_2 ,dbp=dbp_2
WHERE sbp_2 >0  ; 

update t_person_ht_screen SET sbp=sbp_1 ,dbp=dbp_1
WHERE sbp =0 and sbp_1 >0  ;

update t_person_ht_screen SET risk='0'
where (sbp  > 50 AND sbp < 120) and  (dbp > 50 AND dbp < 80);

update t_person_ht_screen SET risk='1'
where (sbp BETWEEN 120 AND 139) OR (dbp BETWEEN 80 AND 89);

update t_person_ht_screen SET risk='2'
where sbp >=140 OR dbp >=90;

DROP TABLE IF EXISTS tmp_ncdscreen_last;
CREATE TABLE IF NOT EXISTS tmp_ncdscreen_last(
  `HOSPCODE` varchar(5) DEFAULT NULL,
  `PID` varchar(15)  DEFAULT NULL,
  `SEQ` varchar(16) DEFAULT NULL,
  `DATE_SERV` date NOT NULL,
  `BSLEVEL` int(6) DEFAULT NULL,
  `BSTEST` char(1) DEFAULT NULL,
  `SCREENPLACE` varchar(5) DEFAULT NULL,
  `CID` varchar(13) DEFAULT NULL,
  `age_y` int(3) DEFAULT NULL,
  `pcheck_hosp` varchar(5) DEFAULT '',
  `pcheck_typearea` varchar(1) DEFAULT '',
  `pcheck_vhid` varchar(8) DEFAULT NULL,
  `nation` varchar(3) DEFAULT '',
  `sex` varchar(1) DEFAULT '',
	diagcode VARCHAR(8) DEFAULT NULL,
	diag_hospcode VARCHAR(5) DEFAULT NULL,
	diag_date date DEFAULT NULL,
PRIMARY KEY (cid),
	KEY (hospcode),
	KEY (pcheck_hosp),
	KEY (pcheck_typearea),
	KEY (pcheck_vhid)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;
INSERT INTO tmp_ncdscreen_last (cid,date_serv)
(SELECT cid,max(DATE_SERV) DATE_SERV  
FROM t_ncdscreen WHERE DATE_SERV BETWEEN @start_d AND @end_d1 AND BSLEVEL > 70
GROUP BY cid
);

UPDATE tmp_ncdscreen_last l INNER JOIN t_ncdscreen n ON l.cid=n.cid AND l.date_serv=n.date_serv
SET l.HOSPCODE = n.HOSPCODE ,l.PID=n.PID ,l.SEQ =n.SEQ ,l.BSLEVEL=n.BSLEVEL ,l.BSTEST=.n.BSTEST
,l.SCREENPLACE=n.SCREENPLACE,l.age_y=n.age_y ,l.pcheck_hosp =n.check_hosp , l.pcheck_typearea=n.check_typearea 
,l.pcheck_vhid = n.check_vhid,l.nation=n.nation,l.sex=n.sex;

UPDATE tmp_ncdscreen_last l INNER JOIN  t_chronic  c ON l.cid=c.cid
SET l.diagcode=c.diagcode , l.diag_hospcode=IFNULL(c.hosp_dx,c.input_hosp) ,l.diag_date=c.date_dx
WHERE  SUBSTR(c.diagcode ,1,3) BETWEEN 'E10' AND 'E14' AND c.date_dx>l.date_serv;
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.283644;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:113;a:5:{i:0;s:7505:"CREATE PROCEDURE t_ncdscreen()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '14';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-2,'1001');
SET	@start_d1:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
SET @end_d1:=concat(@b_year-1,'0930');

DROP TABLES IF EXISTS tmp_ncdscreen;
CREATE TABLE IF NOT EXISTS tmp_ncdscreen (error_code varchar(255) DEFAULT NULL, KEY(cid)) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		n.*,p.CID,null as error_code
FROM
	ncdscreen n left join t_person_db p ON n.HOSPCODE=p.HOSPCODE AND n.PID=p.PID
WHERE	DATE_SERV BETWEEN @start_d AND @end_d
);

UPDATE tmp_ncdscreen 
SET error_code =IF(ISNULL(error_code),'NCD0001',CONCAT(error_code,',','NCD0001') ) 
WHERE  DATE_SERV BETWEEN @start_d1 AND @end_d AND HEIGHT NOT BETWEEN 90 AND 250;

UPDATE tmp_ncdscreen 
SET error_code =IF(ISNULL(error_code),'NCD0002',CONCAT(error_code,',','NCD0002') ) 
WHERE  DATE_SERV BETWEEN @start_d1 AND @end_d AND WEIGHT NOT BETWEEN  10 AND 300;

UPDATE tmp_ncdscreen n INNER JOIN person p  ON n.HOSPCODE=p.HOSPCODE AND n.PID=p.PID
SET error_code =IF(ISNULL(n.error_code),'NCD0003',CONCAT(n.error_code,',','NCD0003') ) 
WHERE  DATE_SERV BETWEEN @start_d1 AND @end_d AND n.DATE_SERV < p.BIRTH;


DROP TABLES IF EXISTS t_ncdscreen;
CREATE TABLE IF NOT EXISTS t_ncdscreen (
KEY(hospcode),KEY(check_hosp),KEY(cid),KEY(date_serv),KEY(bslevel),KEY(bstest),KEY(sbp_1,dbp_1),KEY(sbp_2,dbp_2),KEY(sex)
) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
ns.*,c.groupcode3560,c.groupname3560
FROM
		(SELECT
				n.*,age(n.DATE_SERV,p.BIRTH,'y') as age_y,p.check_hosp,p.check_typearea,p.TYPEAREA,p.check_vhid,p.vhid,p.nation,p.sex
		FROM
			tmp_ncdscreen n LEFT JOIN t_person_cid p ON n.cid=p.cid
		WHERE	DATE_SERV BETWEEN @start_d AND @end_d
		) as ns,cage c 
WHERE ns.age_y=c.age
);
/*เบาหวาน*/
DROP  TABLE IF EXISTS  t_person_dm_screen;
CREATE  TABLE IF NOT EXISTS t_person_dm_screen (
  hospcode varchar(5) DEFAULT NULL,
  areacode varchar(8) DEFAULT NULL,
  cid varchar(13) NOT NULL DEFAULT '',
  pid varchar(15) DEFAULT NULL,
	age_y int(3) DEFAULT '0',
	typearea  varchar(1) DEFAULT NULL,
	date_screen date ,
  bslevel int(6)  DEFAULT '0',
	bstest  varchar(1) DEFAULT NULL,
  ill varchar(1) default null,
  risk varchar(1) default null,
PRIMARY KEY (cid),
	KEY (hospcode),
	KEY (areacode),
	KEY (pid),
	KEY (typearea),
  KEY (risk)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO t_person_dm_screen(
  hospcode,areacode,cid,pid,age_y,typearea
)
SELECT pe.check_hosp HOSPCODE
								,pe.check_vhid as areacode
								,pe.CID,pe.PID,pe.age_y,pe.check_typearea TYPEAREA
				FROM
						t_person_cid pe
				WHERE
						substr(pe.check_vhid,1,2)=@prov_c
						AND pe.nation=99 
						AND pe.DISCHARGE=9 
						AND pe.age_y>=15 
						AND pe.check_typearea in(1,3)
						AND cid not in(SELECT cid FROM t_dmht WHERE type_dx in(2,3))
ORDER BY check_hosp,check_typearea
;

UPDATE t_person_dm_screen p,t_ncdscreen n SET p.date_screen=n.DATE_SERV  ,p.bslevel=n.BSLEVEL, p.bstest=n.bstest
WHERE p.cid=n.cid AND n.DATE_SERV BETWEEN @start_d1 AND @end_d;

update t_person_dm_screen p inner join t_dmht d 
SET ill='1'
WHERE p.cid=d.cid AND d.type_dx in(2,3);

update t_person_dm_screen SET risk='0'
where (((bstest in('1','3') OR bstest is null) AND bslevel >= 70 AND bslevel <= 100 ) OR
(bstest in('2','4') AND bslevel >= 70 AND bslevel <= 140));

update t_person_dm_screen SET risk='1'
where (((bstest in('1','3') OR bstest is null) AND bslevel > 100 AND bslevel <= 125 ) OR 
(bstest in('2','4')   AND bslevel > 140 AND bslevel <= 200 ));

update t_person_dm_screen SET risk='2'
where (((bstest in('1','3') OR bstest is null) AND bslevel > 125) OR
(bstest in('2','4') AND bslevel > 200));


/*ความดัน*/
DROP  TABLE IF EXISTS  t_person_ht_screen;
CREATE  TABLE IF NOT EXISTS t_person_ht_screen (
  hospcode varchar(5) DEFAULT NULL,
  areacode varchar(8) DEFAULT NULL,
  cid varchar(13) NOT NULL DEFAULT '',
  pid varchar(15) DEFAULT NULL,
	age_y int(3) DEFAULT '0',
	typearea  varchar(1) DEFAULT NULL,
	date_screen date ,
  sbp_1 int(3)  DEFAULT 0,
	dbp_1 int(3)  DEFAULT 0,
	sbp_2 int(3)  DEFAULT 0,
	dbp_2 int(3)  DEFAULT 0,
  ill varchar(1) default null,
	sbp int(3)  DEFAULT 0,
	dbp int(3)  DEFAULT 0,
	risk varchar(1) default null,
PRIMARY KEY (cid),
	KEY (hospcode),
	KEY (areacode),
	KEY (pid),
	KEY (typearea),
	KEY (risk)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO t_person_ht_screen(
  hospcode,areacode,cid,pid,age_y,typearea
)
SELECT pe.check_hosp HOSPCODE
								,pe.check_vhid as areacode
								,pe.CID,pe.PID,pe.age_y,pe.check_typearea TYPEAREA
				FROM
						t_person_cid pe
				WHERE
						substr(pe.check_vhid,1,2)=@prov_c
						AND pe.nation=99 
						AND pe.DISCHARGE=9 
						AND pe.age_y>=15 
						AND pe.check_typearea in(1,3)
						AND cid not in(SELECT cid FROM t_dmht WHERE type_dx in(1,3))
ORDER BY check_hosp,check_typearea
;

UPDATE t_person_ht_screen p,t_ncdscreen n SET p.date_screen=n.DATE_SERV  ,p.sbp_1=n.SBP_1,p.sbp_2=n.SBP_2,p.dbp_1=n.dBP_1,p.dbp_2=n.dBP_2
WHERE p.cid=n.cid AND n.DATE_SERV BETWEEN @start_d1 AND @end_d;

update t_person_ht_screen p inner join t_dmht d 
SET ill='1'
WHERE p.cid=d.cid AND d.type_dx in(1,3);

update t_person_ht_screen SET sbp=sbp_2 ,dbp=dbp_2
WHERE sbp_2 >0  ; 

update t_person_ht_screen SET sbp=sbp_1 ,dbp=dbp_1
WHERE sbp =0 and sbp_1 >0  ;

update t_person_ht_screen SET risk='0'
where (sbp  > 50 AND sbp < 120) and  (dbp > 50 AND dbp < 80);

update t_person_ht_screen SET risk='1'
where (sbp BETWEEN 120 AND 139) OR (dbp BETWEEN 80 AND 89);

update t_person_ht_screen SET risk='2'
where sbp >=140 OR dbp >=90;

DROP TABLE IF EXISTS tmp_ncdscreen_last;
CREATE TABLE IF NOT EXISTS tmp_ncdscreen_last(
  `HOSPCODE` varchar(5) DEFAULT NULL,
  `PID` varchar(15)  DEFAULT NULL,
  `SEQ` varchar(16) DEFAULT NULL,
  `DATE_SERV` date NOT NULL,
  `BSLEVEL` int(6) DEFAULT NULL,
  `BSTEST` char(1) DEFAULT NULL,
  `SCREENPLACE` varchar(5) DEFAULT NULL,
  `CID` varchar(13) DEFAULT NULL,
  `age_y` int(3) DEFAULT NULL,
  `pcheck_hosp` varchar(5) DEFAULT '',
  `pcheck_typearea` varchar(1) DEFAULT '',
  `pcheck_vhid` varchar(8) DEFAULT NULL,
  `nation` varchar(3) DEFAULT '',
  `sex` varchar(1) DEFAULT '',
	diagcode VARCHAR(8) DEFAULT NULL,
	diag_hospcode VARCHAR(5) DEFAULT NULL,
	diag_date date DEFAULT NULL,
PRIMARY KEY (cid),
	KEY (hospcode),
	KEY (pcheck_hosp),
	KEY (pcheck_typearea),
	KEY (pcheck_vhid)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;
INSERT INTO tmp_ncdscreen_last (cid,date_serv)
(SELECT cid,max(DATE_SERV) DATE_SERV  
FROM t_ncdscreen WHERE DATE_SERV BETWEEN @start_d AND @end_d1 AND BSLEVEL > 70
GROUP BY cid
);

UPDATE tmp_ncdscreen_last l INNER JOIN t_ncdscreen n ON l.cid=n.cid AND l.date_serv=n.date_serv
SET l.HOSPCODE = n.HOSPCODE ,l.PID=n.PID ,l.SEQ =n.SEQ ,l.BSLEVEL=n.BSLEVEL ,l.BSTEST=.n.BSTEST
,l.SCREENPLACE=n.SCREENPLACE,l.age_y=n.age_y ,l.pcheck_hosp =n.check_hosp , l.pcheck_typearea=n.check_typearea 
,l.pcheck_vhid = n.check_vhid,l.nation=n.nation,l.sex=n.sex;

UPDATE tmp_ncdscreen_last l INNER JOIN  t_chronic  c ON l.cid=c.cid
SET l.diagcode=c.diagcode , l.diag_hospcode=IFNULL(c.hosp_dx,c.input_hosp) ,l.diag_date=c.date_dx
WHERE  SUBSTR(c.diagcode ,1,3) BETWEEN 'E10' AND 'E14' AND c.date_dx>l.date_serv;
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.3304441;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:115;a:5:{i:0;s:34:"DROP PROCEDURE IF EXISTS t_service";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.3304441;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:116;a:5:{i:0;s:34:"DROP PROCEDURE IF EXISTS t_service";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.392844;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:118;a:5:{i:0;s:954:"CREATE PROCEDURE t_service()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '15';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');


DROP TABLES IF EXISTS tmp_service;
CREATE TABLE IF NOT EXISTS tmp_service (
KEY(cid),KEY(hospcode),KEY(pid),KEY(seq),
KEY(date_serv),KEY(instype),KEY(typein),
KEY(typeout),KEY(CAUSEIN),KEY(hospcode,pid),
KEY(hospcode,pid,seq),KEY(hospcode,pid,instype),
KEY(hospcode,pid,typein)
) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		s.hospcode,s.pid,s.seq,s.date_serv,s.intime,s.location,s.instype,s.main,s.typein,s.referinhosp
		,s.causein,s.servplace,s.sbp,s.dbp,s.typeout,s.referouthosp,s.causeout,s.cost,s.price
,s.payprice,s.actualpay,p.CID,p.nation
FROM
	service s LEFT JOIN t_person_db p ON s.HOSPCODE=p.HOSPCODE AND s.PID=p.PID
WHERE	DATE_SERV BETWEEN @start_d AND @end_d
);
#DROP TABLES IF EXISTS tmp_diag_ipd;

 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.392844;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:119;a:5:{i:0;s:954:"CREATE PROCEDURE t_service()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '15';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');


DROP TABLES IF EXISTS tmp_service;
CREATE TABLE IF NOT EXISTS tmp_service (
KEY(cid),KEY(hospcode),KEY(pid),KEY(seq),
KEY(date_serv),KEY(instype),KEY(typein),
KEY(typeout),KEY(CAUSEIN),KEY(hospcode,pid),
KEY(hospcode,pid,seq),KEY(hospcode,pid,instype),
KEY(hospcode,pid,typein)
) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		s.hospcode,s.pid,s.seq,s.date_serv,s.intime,s.location,s.instype,s.main,s.typein,s.referinhosp
		,s.causein,s.servplace,s.sbp,s.dbp,s.typeout,s.referouthosp,s.causeout,s.cost,s.price
,s.payprice,s.actualpay,p.CID,p.nation
FROM
	service s LEFT JOIN t_person_db p ON s.HOSPCODE=p.HOSPCODE AND s.PID=p.PID
WHERE	DATE_SERV BETWEEN @start_d AND @end_d
);
#DROP TABLES IF EXISTS tmp_diag_ipd;

 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.4396441;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:121;a:5:{i:0;s:36:"DROP PROCEDURE IF EXISTS t_admission";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.4396441;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:122;a:5:{i:0;s:36:"DROP PROCEDURE IF EXISTS t_admission";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.502044;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:124;a:5:{i:0;s:936:"CREATE PROCEDURE t_admission()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '16';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'0701');
SET @end_d:=concat(@b_year,'0930');


DROP TABLES IF EXISTS tmp_admission;
CREATE TABLE IF NOT EXISTS tmp_admission (
KEY (cid),
KEY (hospcode),
KEY (pid),
KEY (datetime_admit),
KEY (datetime_disch),
KEY (instype),
KEY (TYPEIN),
KEY (REFERINHOSP),
KEY (DISCHSTATUS),
KEY (DISCHTYPE),
KEY (REFEROUTHOSP),
KEY (an),
KEY (hospcode,an)
) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		a.*,IF(DATEDIFF(DATETIME_DISCH,DATETIME_ADMIT)!=0,DATEDIFF(DATETIME_DISCH,DATETIME_ADMIT),1) as day,p.CID,p.nation
FROM
	admission a LEFT JOIN t_person_db p ON a.HOSPCODE=p.HOSPCODE AND a.PID=p.PID
WHERE	(DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d') BETWEEN @start_d AND @end_d OR DATE_FORMAT(DATETIME_DISCH,'%Y%m%d') BETWEEN @start_d AND @end_d)
);



 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.502044;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:125;a:5:{i:0;s:936:"CREATE PROCEDURE t_admission()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '16';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'0701');
SET @end_d:=concat(@b_year,'0930');


DROP TABLES IF EXISTS tmp_admission;
CREATE TABLE IF NOT EXISTS tmp_admission (
KEY (cid),
KEY (hospcode),
KEY (pid),
KEY (datetime_admit),
KEY (datetime_disch),
KEY (instype),
KEY (TYPEIN),
KEY (REFERINHOSP),
KEY (DISCHSTATUS),
KEY (DISCHTYPE),
KEY (REFEROUTHOSP),
KEY (an),
KEY (hospcode,an)
) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		a.*,IF(DATEDIFF(DATETIME_DISCH,DATETIME_ADMIT)!=0,DATEDIFF(DATETIME_DISCH,DATETIME_ADMIT),1) as day,p.CID,p.nation
FROM
	admission a LEFT JOIN t_person_db p ON a.HOSPCODE=p.HOSPCODE AND a.PID=p.PID
WHERE	(DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d') BETWEEN @start_d AND @end_d OR DATE_FORMAT(DATETIME_DISCH,'%Y%m%d') BETWEEN @start_d AND @end_d)
);



 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.5644441;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:127;a:5:{i:0;s:32:"DROP PROCEDURE IF EXISTS t_death";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.5644441;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:128;a:5:{i:0;s:32:"DROP PROCEDURE IF EXISTS t_death";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.6580441;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:130;a:5:{i:0;s:4295:"CREATE PROCEDURE t_death()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '17';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLES IF EXISTS tmp_death;
CREATE TABLE IF NOT EXISTS tmp_death (
error_code varchar(255) DEFAULT null,
correct_cause varchar(9)  DEFAULT null,
KEY(cid),
KEY(hospcode),
KEY(pid),
KEY(DDEATH),
KEY(CDEATH)
) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		a.HOSPCODE,a.PID,a.HOSPDEATH,a.AN,a.SEQ,a.ddeath,a.cdeath_a,a.CDEATH_B,a.CDEATH_C,a.CDEATH_D,a.ODISEASE,a.cdeath,a.PREGDEATH,a.pdeath,a.PROVIDER,a.d_update,p.CID,p.nation,age(a.ddeath,p.birth,'y') as age_y,p.sex,p.check_hosp,p.check_vhid,p.check_typearea,p.vhid,p.typearea,null as error_code,null as correct_cause
FROM
	death a LEFT JOIN t_person_db p ON a.HOSPCODE=p.HOSPCODE AND a.PID=p.PID 
WHERE	DDEATH BETWEEN @start_d AND @end_d 
		);

UPDATE tmp_death d INNER JOIN person p ON d.HOSPCODE=p.HOSPCODE AND d.PID=p.PID
SET error_code =IF(ISNULL(error_code),'DE0001',CONCAT(error_code,',','DE0001') ) 
WHERE   p.DISCHARGE NOT IN(1) ;

UPDATE tmp_death d INNER JOIN chronic c ON d.HOSPCODE=c.HOSPCODE AND d.PID=c.PID
SET error_code =IF(ISNULL(error_code),'DE0002',CONCAT(error_code,',','DE0002') ) 
WHERE  c.date_disch is null  AND c.typedisch NOT IN(2)   ;

UPDATE tmp_death d INNER JOIN ncdscreen n ON d.HOSPCODE=n.HOSPCODE AND d.PID=n.PID
SET error_code =IF(ISNULL(error_code),'DE0003',CONCAT(error_code,',','DE0003') ) 
WHERE    n.DATE_SERV > d.DDEATH ;

UPDATE tmp_death d INNER JOIN tmp_service s ON d.HOSPCODE=s.HOSPCODE AND d.PID=s.PID
SET error_code =IF(ISNULL(error_code),'DE0004',CONCAT(error_code,',','DE0004') ) 
WHERE    s.DATE_SERV > d.DDEATH ;

UPDATE tmp_death d  SET correct_cause = cdeath_a;
UPDATE tmp_death d  SET correct_cause = cdeath_b
WHERE  cdeath_b is not null AND TRIM(cdeath_b) !='';
UPDATE tmp_death d  SET correct_cause = cdeath_c
WHERE  cdeath_c is not null AND TRIM(cdeath_c) !='';
UPDATE tmp_death d  SET correct_cause = cdeath_d
WHERE  cdeath_d is not null AND TRIM(cdeath_d) !='';

UPDATE tmp_death d 
SET error_code =IF(ISNULL(error_code),'DE0005',CONCAT(error_code,',','DE0005') ) 
WHERE  trim(correct_cause) != trim(cdeath);

UPDATE tmp_death d 
SET error_code =IF(ISNULL(error_code),'DE0006',CONCAT(error_code,',','DE0006') ) 
WHERE  SUBSTR(d.CDEATH,1,3) BETWEEN 'R00' AND 'R99' OR
					SUBSTR(d.CDEATH,1,3) BETWEEN 'Y10' AND 'Y34' OR
					SUBSTR(d.CDEATH,1,3) IN('C80','C97','I46','I50') OR
					SUBSTR(d.CDEATH,1,4) IN('I490','I709') OR
					d.CDEATH IN('Y872','I472','I514','I515','I516','I519');

UPDATE tmp_death d 
SET error_code =IF(ISNULL(error_code),'DE0008',CONCAT(error_code,',','DE0008') ) 
WHERE  pdeath IN(1) AND (LENGTH(TRIM(HOSPDEATH)) != 5 OR HOSPDEATH IS NULL) ;


DROP TABLES IF EXISTS t_death;
CREATE TABLE IF NOT EXISTS t_death (
KEY(cid),
KEY(hospcode),
KEY(pid),
KEY(DDEATH),
KEY(CDEATH)
) ENGINE=MyISAM  AS(
SELECT
		a.*,g.groupcode1560,groupcode3560,groupcode190,g.groupname1560,groupname3560,groupname190
FROM
	tmp_death a,cage g
WHERE	 a.age_y=g.age AND check_typearea in(1,3)
);


DROP TABLES IF EXISTS t_death_sex_age1560;
CREATE TABLE IF NOT EXISTS t_death_sex_age1560 (
  `id` varchar(32) not null default '',
	`year` varchar(4) not null default '',
	`hospcode` varchar(5) not null default '',
  `areacode` varchar(8) not null default '',
  `sex` varchar(15) not null default '',
  `diagcode` varchar(9) not null default '',
  `groupcode` int(2) not null default 0,
  `groupname` varchar(255) not null default '',
  `result` int(9) not null default 0,
  KEY `hospcode` (`hospcode`),
  KEY `areacode` (`areacode`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

DELETE FROM t_death_sex_age1560 WHERE year= year(now())+543;

INSERT IGNORE INTO t_death_sex_age1560
(
	SELECT
	@id ,(@b_year+543) as year,ag.hospcode,ag.vhid,ag.sex,cdeath,ag.groupcode,ag.groupname,ag.result
	FROM
			(SELECT
			check_hosp as hospcode,check_vhid as vhid,sex,cdeath ,groupcode1560 as groupcode ,groupname1560 as groupname,COUNT(*) as result
			FROM
			t_death
			GROUP BY
			check_hosp,check_vhid,sex,cdeath,groupcode1560
			ORDER BY check_hosp,check_vhid
			) as ag
);


 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.6580441;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:131;a:5:{i:0;s:4295:"CREATE PROCEDURE t_death()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '17';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLES IF EXISTS tmp_death;
CREATE TABLE IF NOT EXISTS tmp_death (
error_code varchar(255) DEFAULT null,
correct_cause varchar(9)  DEFAULT null,
KEY(cid),
KEY(hospcode),
KEY(pid),
KEY(DDEATH),
KEY(CDEATH)
) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		a.HOSPCODE,a.PID,a.HOSPDEATH,a.AN,a.SEQ,a.ddeath,a.cdeath_a,a.CDEATH_B,a.CDEATH_C,a.CDEATH_D,a.ODISEASE,a.cdeath,a.PREGDEATH,a.pdeath,a.PROVIDER,a.d_update,p.CID,p.nation,age(a.ddeath,p.birth,'y') as age_y,p.sex,p.check_hosp,p.check_vhid,p.check_typearea,p.vhid,p.typearea,null as error_code,null as correct_cause
FROM
	death a LEFT JOIN t_person_db p ON a.HOSPCODE=p.HOSPCODE AND a.PID=p.PID 
WHERE	DDEATH BETWEEN @start_d AND @end_d 
		);

UPDATE tmp_death d INNER JOIN person p ON d.HOSPCODE=p.HOSPCODE AND d.PID=p.PID
SET error_code =IF(ISNULL(error_code),'DE0001',CONCAT(error_code,',','DE0001') ) 
WHERE   p.DISCHARGE NOT IN(1) ;

UPDATE tmp_death d INNER JOIN chronic c ON d.HOSPCODE=c.HOSPCODE AND d.PID=c.PID
SET error_code =IF(ISNULL(error_code),'DE0002',CONCAT(error_code,',','DE0002') ) 
WHERE  c.date_disch is null  AND c.typedisch NOT IN(2)   ;

UPDATE tmp_death d INNER JOIN ncdscreen n ON d.HOSPCODE=n.HOSPCODE AND d.PID=n.PID
SET error_code =IF(ISNULL(error_code),'DE0003',CONCAT(error_code,',','DE0003') ) 
WHERE    n.DATE_SERV > d.DDEATH ;

UPDATE tmp_death d INNER JOIN tmp_service s ON d.HOSPCODE=s.HOSPCODE AND d.PID=s.PID
SET error_code =IF(ISNULL(error_code),'DE0004',CONCAT(error_code,',','DE0004') ) 
WHERE    s.DATE_SERV > d.DDEATH ;

UPDATE tmp_death d  SET correct_cause = cdeath_a;
UPDATE tmp_death d  SET correct_cause = cdeath_b
WHERE  cdeath_b is not null AND TRIM(cdeath_b) !='';
UPDATE tmp_death d  SET correct_cause = cdeath_c
WHERE  cdeath_c is not null AND TRIM(cdeath_c) !='';
UPDATE tmp_death d  SET correct_cause = cdeath_d
WHERE  cdeath_d is not null AND TRIM(cdeath_d) !='';

UPDATE tmp_death d 
SET error_code =IF(ISNULL(error_code),'DE0005',CONCAT(error_code,',','DE0005') ) 
WHERE  trim(correct_cause) != trim(cdeath);

UPDATE tmp_death d 
SET error_code =IF(ISNULL(error_code),'DE0006',CONCAT(error_code,',','DE0006') ) 
WHERE  SUBSTR(d.CDEATH,1,3) BETWEEN 'R00' AND 'R99' OR
					SUBSTR(d.CDEATH,1,3) BETWEEN 'Y10' AND 'Y34' OR
					SUBSTR(d.CDEATH,1,3) IN('C80','C97','I46','I50') OR
					SUBSTR(d.CDEATH,1,4) IN('I490','I709') OR
					d.CDEATH IN('Y872','I472','I514','I515','I516','I519');

UPDATE tmp_death d 
SET error_code =IF(ISNULL(error_code),'DE0008',CONCAT(error_code,',','DE0008') ) 
WHERE  pdeath IN(1) AND (LENGTH(TRIM(HOSPDEATH)) != 5 OR HOSPDEATH IS NULL) ;


DROP TABLES IF EXISTS t_death;
CREATE TABLE IF NOT EXISTS t_death (
KEY(cid),
KEY(hospcode),
KEY(pid),
KEY(DDEATH),
KEY(CDEATH)
) ENGINE=MyISAM  AS(
SELECT
		a.*,g.groupcode1560,groupcode3560,groupcode190,g.groupname1560,groupname3560,groupname190
FROM
	tmp_death a,cage g
WHERE	 a.age_y=g.age AND check_typearea in(1,3)
);


DROP TABLES IF EXISTS t_death_sex_age1560;
CREATE TABLE IF NOT EXISTS t_death_sex_age1560 (
  `id` varchar(32) not null default '',
	`year` varchar(4) not null default '',
	`hospcode` varchar(5) not null default '',
  `areacode` varchar(8) not null default '',
  `sex` varchar(15) not null default '',
  `diagcode` varchar(9) not null default '',
  `groupcode` int(2) not null default 0,
  `groupname` varchar(255) not null default '',
  `result` int(9) not null default 0,
  KEY `hospcode` (`hospcode`),
  KEY `areacode` (`areacode`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

DELETE FROM t_death_sex_age1560 WHERE year= year(now())+543;

INSERT IGNORE INTO t_death_sex_age1560
(
	SELECT
	@id ,(@b_year+543) as year,ag.hospcode,ag.vhid,ag.sex,cdeath,ag.groupcode,ag.groupname,ag.result
	FROM
			(SELECT
			check_hosp as hospcode,check_vhid as vhid,sex,cdeath ,groupcode1560 as groupcode ,groupname1560 as groupname,COUNT(*) as result
			FROM
			t_death
			GROUP BY
			check_hosp,check_vhid,sex,cdeath,groupcode1560
			ORDER BY check_hosp,check_vhid
			) as ag
);


 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.704844;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:133;a:5:{i:0;s:34:"DROP PROCEDURE IF EXISTS t_newborn";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.704844;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:134;a:5:{i:0;s:34:"DROP PROCEDURE IF EXISTS t_newborn";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.798444;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:136;a:5:{i:0;s:519:"CREATE PROCEDURE t_newborn()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '18';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS t_newborn;
CREATE TABLE IF NOT EXISTS t_newborn (
PRIMARY KEY (CID,BDATE)
) ENGINE=MyISAM  IGNORE AS
SELECT n.* FROM tmp_newborn n INNER JOIN chospital h ON n.hospcode=h.hoscode WHERE  h.hostype in(5,6,7,11);

INSERT IGNORE t_newborn (SELECT * FROM tmp_newborn);



 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.798444;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:137;a:5:{i:0;s:519:"CREATE PROCEDURE t_newborn()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '18';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS t_newborn;
CREATE TABLE IF NOT EXISTS t_newborn (
PRIMARY KEY (CID,BDATE)
) ENGINE=MyISAM  IGNORE AS
SELECT n.* FROM tmp_newborn n INNER JOIN chospital h ON n.hospcode=h.hoscode WHERE  h.hostype in(5,6,7,11);

INSERT IGNORE t_newborn (SELECT * FROM tmp_newborn);



 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.8608451;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:139;a:5:{i:0;s:31:"DROP PROCEDURE IF EXISTS t_card";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.8608451;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:140;a:5:{i:0;s:31:"DROP PROCEDURE IF EXISTS t_card";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.907645;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:142;a:5:{i:0;s:675:"CREATE PROCEDURE t_card()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '19';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
DROP TABLES IF EXISTS tmp_card;
CREATE TABLE IF NOT EXISTS tmp_card (
KEY(cid),
KEY(hospcode),
KEY(pid)
) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
	c.*
FROM
		(SELECT 
				a.*,p.CID,p.nation,p.sex,p.check_hosp,p.check_vhid,p.check_typearea,p.vhid,p.typearea
		FROM
			card a LEFT JOIN t_person_db p ON a.HOSPCODE=p.HOSPCODE AND a.PID=p.PID 
		WHERE	 p.check_typearea in(1,3)
		ORDER BY cid ASC,d_update DESC
		) as c
GROUP BY cid
);



 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.907645;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:143;a:5:{i:0;s:675:"CREATE PROCEDURE t_card()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '19';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
DROP TABLES IF EXISTS tmp_card;
CREATE TABLE IF NOT EXISTS tmp_card (
KEY(cid),
KEY(hospcode),
KEY(pid)
) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
	c.*
FROM
		(SELECT 
				a.*,p.CID,p.nation,p.sex,p.check_hosp,p.check_vhid,p.check_typearea,p.vhid,p.typearea
		FROM
			card a LEFT JOIN t_person_db p ON a.HOSPCODE=p.HOSPCODE AND a.PID=p.PID 
		WHERE	 p.check_typearea in(1,3)
		ORDER BY cid ASC,d_update DESC
		) as c
GROUP BY cid
);



 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.9544449;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:145;a:5:{i:0;s:35:"DROP PROCEDURE IF EXISTS t_drug_opd";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.9544449;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:146;a:5:{i:0;s:35:"DROP PROCEDURE IF EXISTS t_drug_opd";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.001245;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:148;a:5:{i:0;s:3018:"CREATE PROCEDURE t_drug_opd()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '20';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLES IF EXISTS tmp_drug_opd;
CREATE TABLE IF NOT EXISTS tmp_drug_opd (
  `HOSPCODE` varchar(5) NOT NULL,
  `PID` varchar(15) NOT NULL,
  `SEQ` varchar(16) NOT NULL,
  `DATE_SERV` date NOT NULL,
  `CLINIC` varchar(5) NOT NULL,
  `DIDSTD` varchar(24) NOT NULL,
  `DNAME` varchar(255) DEFAULT NULL,
  `AMOUNT` int(12) DEFAULT NULL,
  `UNIT` varchar(3) DEFAULT NULL,
  `UNIT_PACKING` varchar(20) DEFAULT NULL,
  `DRUGPRICE` decimal(11,2) DEFAULT NULL,
  `DRUGCOST` decimal(11,2) DEFAULT NULL,
  `PROVIDER` varchar(15) DEFAULT NULL,
  `D_UPDATE` datetime NOT NULL,
  `CID` varchar(13) DEFAULT NULL,
	`nation` varchar(4) DEFAULT NULL,
	`sex` varchar(1) DEFAULT NULL,
	`check_hosp` varchar(5) DEFAULT NULL,
	`check_vhid` varchar(8) DEFAULT NULL,
	`check_typearea` varchar(1) DEFAULT NULL,
	`vhid` varchar(8) DEFAULT NULL,
	`typearea` varchar(1) DEFAULT NULL,
	`drug_name` varchar(255) DEFAULT NULL,
	`drug_type` varchar(50) DEFAULT NULL,
	`ed` varchar(1) DEFAULT NULL,
	`age_y` int(3) DEFAULT 0,
	`instype` varchar(4) DEFAULT NULL,
	`instypegroup` int(3) DEFAULT 0,
	`groupcode060` int(3) DEFAULT 0,
  PRIMARY KEY (`HOSPCODE`,`PID`,`SEQ`,`DIDSTD`),
  KEY `idx1` (`HOSPCODE`,`PID`),
  KEY `idx2` (`DATE_SERV`),
  KEY `idx3` (`HOSPCODE`),
  KEY `idx4` (`DIDSTD`),
  KEY `idx5` (`HOSPCODE`,`PROVIDER`),
  KEY `idx6` (`cid`),
  KEY `idx7` (`seq`),
  KEY `idx8` (`pid`),
  KEY `idx9` (`check_typearea`),
  KEY `idx10` (`check_vhid`),
  KEY `idx11` (`drug_type`),
  KEY `idx13` (`ed`),
	KEY `idx14` (`age_y`),
	KEY `idx15` (`instype`),
	KEY `idx16` (`instypegroup`),
	KEY `idx17` (`groupcode060`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO tmp_drug_opd
(
	HOSPCODE,PID,SEQ,DATE_SERV,CLINIC,DIDSTD,DNAME,AMOUNT,UNIT,UNIT_PACKING,DRUGPRICE,DRUGCOST,PROVIDER,D_UPDATE
	,CID,nation,sex,check_hosp,check_vhid,check_typearea,vhid,typearea,age_y
)
(
SELECT SQL_BIG_RESULT 
		a.HOSPCODE,a.PID,a.SEQ,a.DATE_SERV,a.CLINIC,a.DIDSTD,a.DNAME,a.amount,a.unit,a.unit_packing,a.drugprice,a.drugcost,a.PROVIDER,a.D_UPDATE,pe.CID,pe.nation,pe.sex,pe.check_hosp,pe.check_vhid,pe.check_typearea,pe.vhid,pe.typearea,age(a.date_serv,pe.birth,'y')
FROM
	drug_opd a LEFT JOIN t_person_db pe ON  a.HOSPCODE=pe.HOSPCODE AND a.PID=pe.PID
WHERE	date_serv BETWEEN @start_d AND @end_d 
);

UPDATE tmp_drug_opd d,cage ag SET d.groupcode060=ag.groupcode060
WHERE d.age_y=ag.age; 

UPDATE tmp_drug_opd d,tmp_service s SET d.instype=s.instype
WHERE d.HOSPCODE=s.HOSPCODE AND d.PID=s.PID AND d.seq=s.seq ; 

UPDATE tmp_drug_opd d,cinstype_new i SET d.instypegroup=i.instypegroup
WHERE d.instype=i.instypecode; 


UPDATE tmp_drug_opd d,cdrug_planthai p SET d.drug_name=p.drug_name ,d.drug_type=p.drug_type ,d.ed=p.ed
WHERE d.didstd=p.DIDSTD; 


 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.016845;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:149;a:5:{i:0;s:3018:"CREATE PROCEDURE t_drug_opd()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '20';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLES IF EXISTS tmp_drug_opd;
CREATE TABLE IF NOT EXISTS tmp_drug_opd (
  `HOSPCODE` varchar(5) NOT NULL,
  `PID` varchar(15) NOT NULL,
  `SEQ` varchar(16) NOT NULL,
  `DATE_SERV` date NOT NULL,
  `CLINIC` varchar(5) NOT NULL,
  `DIDSTD` varchar(24) NOT NULL,
  `DNAME` varchar(255) DEFAULT NULL,
  `AMOUNT` int(12) DEFAULT NULL,
  `UNIT` varchar(3) DEFAULT NULL,
  `UNIT_PACKING` varchar(20) DEFAULT NULL,
  `DRUGPRICE` decimal(11,2) DEFAULT NULL,
  `DRUGCOST` decimal(11,2) DEFAULT NULL,
  `PROVIDER` varchar(15) DEFAULT NULL,
  `D_UPDATE` datetime NOT NULL,
  `CID` varchar(13) DEFAULT NULL,
	`nation` varchar(4) DEFAULT NULL,
	`sex` varchar(1) DEFAULT NULL,
	`check_hosp` varchar(5) DEFAULT NULL,
	`check_vhid` varchar(8) DEFAULT NULL,
	`check_typearea` varchar(1) DEFAULT NULL,
	`vhid` varchar(8) DEFAULT NULL,
	`typearea` varchar(1) DEFAULT NULL,
	`drug_name` varchar(255) DEFAULT NULL,
	`drug_type` varchar(50) DEFAULT NULL,
	`ed` varchar(1) DEFAULT NULL,
	`age_y` int(3) DEFAULT 0,
	`instype` varchar(4) DEFAULT NULL,
	`instypegroup` int(3) DEFAULT 0,
	`groupcode060` int(3) DEFAULT 0,
  PRIMARY KEY (`HOSPCODE`,`PID`,`SEQ`,`DIDSTD`),
  KEY `idx1` (`HOSPCODE`,`PID`),
  KEY `idx2` (`DATE_SERV`),
  KEY `idx3` (`HOSPCODE`),
  KEY `idx4` (`DIDSTD`),
  KEY `idx5` (`HOSPCODE`,`PROVIDER`),
  KEY `idx6` (`cid`),
  KEY `idx7` (`seq`),
  KEY `idx8` (`pid`),
  KEY `idx9` (`check_typearea`),
  KEY `idx10` (`check_vhid`),
  KEY `idx11` (`drug_type`),
  KEY `idx13` (`ed`),
	KEY `idx14` (`age_y`),
	KEY `idx15` (`instype`),
	KEY `idx16` (`instypegroup`),
	KEY `idx17` (`groupcode060`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO tmp_drug_opd
(
	HOSPCODE,PID,SEQ,DATE_SERV,CLINIC,DIDSTD,DNAME,AMOUNT,UNIT,UNIT_PACKING,DRUGPRICE,DRUGCOST,PROVIDER,D_UPDATE
	,CID,nation,sex,check_hosp,check_vhid,check_typearea,vhid,typearea,age_y
)
(
SELECT SQL_BIG_RESULT 
		a.HOSPCODE,a.PID,a.SEQ,a.DATE_SERV,a.CLINIC,a.DIDSTD,a.DNAME,a.amount,a.unit,a.unit_packing,a.drugprice,a.drugcost,a.PROVIDER,a.D_UPDATE,pe.CID,pe.nation,pe.sex,pe.check_hosp,pe.check_vhid,pe.check_typearea,pe.vhid,pe.typearea,age(a.date_serv,pe.birth,'y')
FROM
	drug_opd a LEFT JOIN t_person_db pe ON  a.HOSPCODE=pe.HOSPCODE AND a.PID=pe.PID
WHERE	date_serv BETWEEN @start_d AND @end_d 
);

UPDATE tmp_drug_opd d,cage ag SET d.groupcode060=ag.groupcode060
WHERE d.age_y=ag.age; 

UPDATE tmp_drug_opd d,tmp_service s SET d.instype=s.instype
WHERE d.HOSPCODE=s.HOSPCODE AND d.PID=s.PID AND d.seq=s.seq ; 

UPDATE tmp_drug_opd d,cinstype_new i SET d.instypegroup=i.instypegroup
WHERE d.instype=i.instypecode; 


UPDATE tmp_drug_opd d,cdrug_planthai p SET d.drug_name=p.drug_name ,d.drug_type=p.drug_type ,d.ed=p.ed
WHERE d.didstd=p.DIDSTD; 


 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.0636449;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:151;a:5:{i:0;s:35:"DROP PROCEDURE IF EXISTS t_planthai";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.0636449;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:152;a:5:{i:0;s:35:"DROP PROCEDURE IF EXISTS t_planthai";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.1270449;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:154;a:5:{i:0;s:4017:"CREATE PROCEDURE t_planthai()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '21';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLES IF EXISTS t_planthai_proced;
CREATE TABLE IF NOT EXISTS t_planthai_proced(
	`hospcode` varchar(5) NOT null,
  `pid` varchar(15) NOT null,
	`seq` varchar(16) NOT null,
	`date_serv` date NOT NULL,
	`procedcode` varchar(8) default null,
	`instype` varchar(4) default null,
	`instypegroup` varchar(2) default null,
	`tmtype` varchar(1)  default null,
	`servplace` varchar(1)  default null,
	`age_y` int(3)  default 0,
	`cid` varchar(13)  default null,
  KEY `hospcode` (`hospcode`),
  KEY `pid` (`pid`),
	KEY `cid` (`cid`),
  KEY `seq` (`seq`),
  KEY `date_serv` (`date_serv`),
	KEY `procedcode` (`procedcode`),
	KEY `instype` (`instype`),
	KEY `instypegroup` (`instypegroup`),
	KEY `tmtype` (`tmtype`),
	KEY `servplace` (`servplace`),
  KEY `HOSPCODE_PID` (`hospcode`,`pid`,`seq`)
)ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT INTO t_planthai_proced
(
		hospcode,pid,seq,date_serv,procedcode,tmtype
)
(
SELECT SQL_BIG_RESULT  p.hospcode,p.pid,p.seq,p.date_serv,PROCEDCODE,tmtype
FROM
		tmp_procedure_opd p 
		INNER JOIN cicd9ttm_planthai t ON p.PROCEDCODE= t.code
	WHERE
		t.code is not null
		AND p.date_serv BETWEEN @start_d AND @end_d 
);

INSERT INTO t_planthai_proced
(
		hospcode,pid,seq,date_serv,procedcode
)
(
SELECT SQL_BIG_RESULT  p.hospcode,p.pid,p.seq,p.date_serv,PROCEDCODE
FROM
		tmp_procedure_opd p 
WHERE
PROCEDCODE IN ('9991','9992','9335') 
AND p.date_serv BETWEEN @start_d AND @end_d 
);

UPDATE t_planthai_proced p,tmp_service s SET p.instype=s.instype,p.servplace=s.servplace
WHERE 
	s.hospcode = p.hospcode AND s.pid = p.pid AND s.seq = p.seq ;

UPDATE t_planthai_proced p,cinstype_new i SET p.instypegroup=i.instypegroup
WHERE 
	p.instype = i.instypecode ;

UPDATE t_planthai_proced p,t_person_db pe  SET p.age_y= age(p.date_serv,pe.BIRTH,'y'),p.cid=pe.cid
WHERE 
	p.hospcode=pe.hospcode AND p.pid=pe.pid  ;

/**************/

DROP TABLES IF EXISTS t_planthai_diag_proced;

CREATE TABLE IF NOT EXISTS t_planthai_diag_proced(
	`hospcode` varchar(5) NOT null,
  `pid` varchar(15) NOT null,
	`seq` varchar(16) NOT null,
	`date_serv` date NOT NULL,
	`diagcode` varchar(8) default null,
	`diagtype` varchar(1) default null,
	`procedcode` varchar(8) default null,
	`instype` varchar(4) default null,
	`instypegroup` varchar(2) default null,
	`diseasethai` varchar(255) default null,
	`tmtype` varchar(1)  default null,
	`servplace` varchar(1)  default null,
	`age_y` int(3)  default 0,
`cid` varchar(13)  default null,
  KEY `hospcode` (`hospcode`),
  KEY `pid` (`pid`),
KEY `cid` (`cid`),
  KEY `seq` (`seq`),
  KEY `date_serv` (`date_serv`),
	KEY `diagcode` (`diagcode`),
	KEY `diagtype` (`diagtype`),
	KEY `procedcode` (`procedcode`),
	KEY `instype` (`instype`),
	KEY `instypegroup` (`instypegroup`),
	KEY `tmtype` (`tmtype`),
	KEY `servplace` (`servplace`),
	KEY `age_y` (`age_y`),
  KEY `HOSPCODE_PID` (`hospcode`,`pid`,`seq`)
)ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT INTO t_planthai_diag_proced
(
		hospcode,pid,seq,date_serv,diagcode,diagtype,procedcode,tmtype,servplace,instype,instypegroup
)
(
		SELECT SQL_BIG_RESULT  a.hospcode,a.pid,a.seq,a.date_serv,a.diagcode,a.diagtype,p.PROCEDCODE,p.tmtype,p.servplace,p.instype,p.instypegroup
		FROM
			tmp_diag_opd a
			LEFT JOIN t_planthai_proced p ON a.hospcode=p.hospcode AND a.pid=p.pid AND a.seq=p.seq AND a.date_serv=p.date_serv
		WHERE	a.date_serv BETWEEN @start_d AND @end_d 
		AND SUBSTR(a.diagcode,1,1)='U'
);

UPDATE t_planthai_diag_proced p,cdisease d  SET p.diseasethai=d.diseasethai
WHERE 
	d.diagcode = p.diagcode  ;


UPDATE t_planthai_diag_proced p,t_person_db pe  SET p.age_y= age(p.date_serv,pe.BIRTH,'y'),p.cid=pe.cid
WHERE 
	p.hospcode=pe.hospcode AND p.pid=pe.pid  ;

 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.1270449;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:155;a:5:{i:0;s:4017:"CREATE PROCEDURE t_planthai()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '21';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLES IF EXISTS t_planthai_proced;
CREATE TABLE IF NOT EXISTS t_planthai_proced(
	`hospcode` varchar(5) NOT null,
  `pid` varchar(15) NOT null,
	`seq` varchar(16) NOT null,
	`date_serv` date NOT NULL,
	`procedcode` varchar(8) default null,
	`instype` varchar(4) default null,
	`instypegroup` varchar(2) default null,
	`tmtype` varchar(1)  default null,
	`servplace` varchar(1)  default null,
	`age_y` int(3)  default 0,
	`cid` varchar(13)  default null,
  KEY `hospcode` (`hospcode`),
  KEY `pid` (`pid`),
	KEY `cid` (`cid`),
  KEY `seq` (`seq`),
  KEY `date_serv` (`date_serv`),
	KEY `procedcode` (`procedcode`),
	KEY `instype` (`instype`),
	KEY `instypegroup` (`instypegroup`),
	KEY `tmtype` (`tmtype`),
	KEY `servplace` (`servplace`),
  KEY `HOSPCODE_PID` (`hospcode`,`pid`,`seq`)
)ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT INTO t_planthai_proced
(
		hospcode,pid,seq,date_serv,procedcode,tmtype
)
(
SELECT SQL_BIG_RESULT  p.hospcode,p.pid,p.seq,p.date_serv,PROCEDCODE,tmtype
FROM
		tmp_procedure_opd p 
		INNER JOIN cicd9ttm_planthai t ON p.PROCEDCODE= t.code
	WHERE
		t.code is not null
		AND p.date_serv BETWEEN @start_d AND @end_d 
);

INSERT INTO t_planthai_proced
(
		hospcode,pid,seq,date_serv,procedcode
)
(
SELECT SQL_BIG_RESULT  p.hospcode,p.pid,p.seq,p.date_serv,PROCEDCODE
FROM
		tmp_procedure_opd p 
WHERE
PROCEDCODE IN ('9991','9992','9335') 
AND p.date_serv BETWEEN @start_d AND @end_d 
);

UPDATE t_planthai_proced p,tmp_service s SET p.instype=s.instype,p.servplace=s.servplace
WHERE 
	s.hospcode = p.hospcode AND s.pid = p.pid AND s.seq = p.seq ;

UPDATE t_planthai_proced p,cinstype_new i SET p.instypegroup=i.instypegroup
WHERE 
	p.instype = i.instypecode ;

UPDATE t_planthai_proced p,t_person_db pe  SET p.age_y= age(p.date_serv,pe.BIRTH,'y'),p.cid=pe.cid
WHERE 
	p.hospcode=pe.hospcode AND p.pid=pe.pid  ;

/**************/

DROP TABLES IF EXISTS t_planthai_diag_proced;

CREATE TABLE IF NOT EXISTS t_planthai_diag_proced(
	`hospcode` varchar(5) NOT null,
  `pid` varchar(15) NOT null,
	`seq` varchar(16) NOT null,
	`date_serv` date NOT NULL,
	`diagcode` varchar(8) default null,
	`diagtype` varchar(1) default null,
	`procedcode` varchar(8) default null,
	`instype` varchar(4) default null,
	`instypegroup` varchar(2) default null,
	`diseasethai` varchar(255) default null,
	`tmtype` varchar(1)  default null,
	`servplace` varchar(1)  default null,
	`age_y` int(3)  default 0,
`cid` varchar(13)  default null,
  KEY `hospcode` (`hospcode`),
  KEY `pid` (`pid`),
KEY `cid` (`cid`),
  KEY `seq` (`seq`),
  KEY `date_serv` (`date_serv`),
	KEY `diagcode` (`diagcode`),
	KEY `diagtype` (`diagtype`),
	KEY `procedcode` (`procedcode`),
	KEY `instype` (`instype`),
	KEY `instypegroup` (`instypegroup`),
	KEY `tmtype` (`tmtype`),
	KEY `servplace` (`servplace`),
	KEY `age_y` (`age_y`),
  KEY `HOSPCODE_PID` (`hospcode`,`pid`,`seq`)
)ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT INTO t_planthai_diag_proced
(
		hospcode,pid,seq,date_serv,diagcode,diagtype,procedcode,tmtype,servplace,instype,instypegroup
)
(
		SELECT SQL_BIG_RESULT  a.hospcode,a.pid,a.seq,a.date_serv,a.diagcode,a.diagtype,p.PROCEDCODE,p.tmtype,p.servplace,p.instype,p.instypegroup
		FROM
			tmp_diag_opd a
			LEFT JOIN t_planthai_proced p ON a.hospcode=p.hospcode AND a.pid=p.pid AND a.seq=p.seq AND a.date_serv=p.date_serv
		WHERE	a.date_serv BETWEEN @start_d AND @end_d 
		AND SUBSTR(a.diagcode,1,1)='U'
);

UPDATE t_planthai_diag_proced p,cdisease d  SET p.diseasethai=d.diseasethai
WHERE 
	d.diagcode = p.diagcode  ;


UPDATE t_planthai_diag_proced p,t_person_db pe  SET p.age_y= age(p.date_serv,pe.BIRTH,'y'),p.cid=pe.cid
WHERE 
	p.hospcode=pe.hospcode AND p.pid=pe.pid  ;

 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.193445;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:157;a:5:{i:0;s:36:"DROP PROCEDURE IF EXISTS t_planthai1";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.195446;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:158;a:5:{i:0;s:36:"DROP PROCEDURE IF EXISTS t_planthai1";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.248647;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:160;a:5:{i:0;s:2120:"CREATE PROCEDURE t_planthai1()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '22';
SET	@send :=  IF((SELECT active FROM sys_report WHERE cat_id = @cat_id and id = @id )=1,0,2);
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS tmp_diag_no_z;
CREATE  TABLE IF NOT EXISTS  tmp_diag_no_z(index (hospcode,pid,seq)) ENGINE MyIsam
AS
(
SELECT hospcode,pid,seq FROM tmp_diag_opd 
WHERE  substr(diagcode ,1,1)  != 'Z' AND DATE_SERV BETWEEN @start_d AND @end_d 
GROUP BY hospcode,pid,seq
);

DROP TABLE IF EXISTS t_planthai1;
CREATE TABLE IF NOT EXISTS t_planthai1(
hospcode VARCHAR(5) NOT NULL,
pid VARCHAR(18) NOT NULL,
seq VARCHAR(18) NOT NULL,
date_serv date,
instypegroup INT(2) DEFAULT NULL,
planthai INT(1) DEFAULT NULL,
KEY hospcode (hospcode),
KEY pid (pid),
KEY seq (seq),
KEY date_serv (date_serv),
KEY planthai (planthai),
KEY instypegroup (instypegroup)

)ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT INTO t_planthai1
(
	HOSPCODE,PID,SEQ,DATE_SERV,instypegroup
)
(
SELECT SQL_BIG_RESULT s.HOSPCODE,s.PID,s.SEQ,s.DATE_SERV,i.instypegroup
FROM tmp_service s LEFT JOIN cinstype_new i ON s.instype = i.instypecode
INNER JOIN tmp_diag_no_z d ON s.hospcode=d.hospcode AND s.pid=d.pid AND s.seq=d.seq
WHERE s.DATE_SERV BETWEEN @start_d AND @end_d
);

UPDATE
	t_planthai1 p1,
	(
			SELECT SQL_BIG_RESULT 
			e3.*
			FROM
			(
			SELECT HOSPCODE,PID,SEQ,DATE_SERV,instypegroup
			FROM t_planthai_diag_proced 
			WHERE DATE_SERV BETWEEN @start_d AND @end_d
			AND LEFT(DIAGCODE,1) = 'U'

			UNION
			SELECT HOSPCODE,PID,SEQ,DATE_SERV,instypegroup 
			FROM tmp_drug_opd
			WHERE DATE_SERV BETWEEN @start_d AND @end_d
			AND LEFT(DIDSTD,2) IN ('41','42') 
			
			UNION
			SELECT HOSPCODE,PID,SEQ,DATE_SERV,instypegroup 
			FROM t_planthai_proced
			WHERE DATE_SERV BETWEEN @start_d AND @end_d
			) as e3
			GROUP BY HOSPCODE,PID,SEQ,DATE_SERV,instypegroup

	) p2
		SET planthai=1 
WHERE p1.hospcode=p2.hospcode AND p1.pid=p2.pid AND p1.seq=p2.seq;
	
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.248647;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:161;a:5:{i:0;s:2120:"CREATE PROCEDURE t_planthai1()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '22';
SET	@send :=  IF((SELECT active FROM sys_report WHERE cat_id = @cat_id and id = @id )=1,0,2);
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS tmp_diag_no_z;
CREATE  TABLE IF NOT EXISTS  tmp_diag_no_z(index (hospcode,pid,seq)) ENGINE MyIsam
AS
(
SELECT hospcode,pid,seq FROM tmp_diag_opd 
WHERE  substr(diagcode ,1,1)  != 'Z' AND DATE_SERV BETWEEN @start_d AND @end_d 
GROUP BY hospcode,pid,seq
);

DROP TABLE IF EXISTS t_planthai1;
CREATE TABLE IF NOT EXISTS t_planthai1(
hospcode VARCHAR(5) NOT NULL,
pid VARCHAR(18) NOT NULL,
seq VARCHAR(18) NOT NULL,
date_serv date,
instypegroup INT(2) DEFAULT NULL,
planthai INT(1) DEFAULT NULL,
KEY hospcode (hospcode),
KEY pid (pid),
KEY seq (seq),
KEY date_serv (date_serv),
KEY planthai (planthai),
KEY instypegroup (instypegroup)

)ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT INTO t_planthai1
(
	HOSPCODE,PID,SEQ,DATE_SERV,instypegroup
)
(
SELECT SQL_BIG_RESULT s.HOSPCODE,s.PID,s.SEQ,s.DATE_SERV,i.instypegroup
FROM tmp_service s LEFT JOIN cinstype_new i ON s.instype = i.instypecode
INNER JOIN tmp_diag_no_z d ON s.hospcode=d.hospcode AND s.pid=d.pid AND s.seq=d.seq
WHERE s.DATE_SERV BETWEEN @start_d AND @end_d
);

UPDATE
	t_planthai1 p1,
	(
			SELECT SQL_BIG_RESULT 
			e3.*
			FROM
			(
			SELECT HOSPCODE,PID,SEQ,DATE_SERV,instypegroup
			FROM t_planthai_diag_proced 
			WHERE DATE_SERV BETWEEN @start_d AND @end_d
			AND LEFT(DIAGCODE,1) = 'U'

			UNION
			SELECT HOSPCODE,PID,SEQ,DATE_SERV,instypegroup 
			FROM tmp_drug_opd
			WHERE DATE_SERV BETWEEN @start_d AND @end_d
			AND LEFT(DIDSTD,2) IN ('41','42') 
			
			UNION
			SELECT HOSPCODE,PID,SEQ,DATE_SERV,instypegroup 
			FROM t_planthai_proced
			WHERE DATE_SERV BETWEEN @start_d AND @end_d
			) as e3
			GROUP BY HOSPCODE,PID,SEQ,DATE_SERV,instypegroup

	) p2
		SET planthai=1 
WHERE p1.hospcode=p2.hospcode AND p1.pid=p2.pid AND p1.seq=p2.seq;
	
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.2954471;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:163;a:5:{i:0;s:31:"DROP PROCEDURE IF EXISTS t_cmi1";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.2954471;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:164;a:5:{i:0;s:31:"DROP PROCEDURE IF EXISTS t_cmi1";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.342247;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:166;a:5:{i:0;s:3727:"CREATE PROCEDURE t_cmi1()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '23';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLES IF EXISTS tmp_cmiadmission;
CREATE TABLE IF NOT EXISTS tmp_cmiadmission(
SELECT SQL_BIG_RESULT t.hospcode, t.drg, count(t.an) as cntan, sum(t.adjrw) as sumadj
, count(if(month(t.datetime_disch)=10 and t.ERROR=0,t.an,null)) as cntm10
, sum(if(month(t.datetime_disch)=10 and t.ERROR=0,t.adjrw,0)) as adjm10
, count(if(month(t.datetime_disch)=11 and t.ERROR=0,t.an,null)) as cntm11
, sum(if(month(t.datetime_disch)=11 and t.ERROR=0,t.adjrw,0)) as adjm11
, count(if(month(t.datetime_disch)=12 and t.ERROR=0,t.an,null)) as cntm12
, sum(if(month(t.datetime_disch)=12 and t.ERROR=0,t.adjrw,0)) as adjm12
, count(if(month(t.datetime_disch)=1 and t.ERROR=0,t.an,null)) as cntm01
, sum(if(month(t.datetime_disch)=1 and t.ERROR=0,t.adjrw,0)) as adjm01
, count(if(month(t.datetime_disch)=2 and t.ERROR=0,t.an,null)) as cntm02
, sum(if(month(t.datetime_disch)=2 and t.ERROR=0,t.adjrw,0)) as adjm02
, count(if(month(t.datetime_disch)=3 and t.ERROR=0,t.an,null)) as cntm03
, sum(if(month(t.datetime_disch)=3 and t.ERROR=0,t.adjrw,0)) as adjm03
, count(if(month(t.datetime_disch)=4 and t.ERROR=0,t.an,null)) as cntm04
, sum(if(month(t.datetime_disch)=4 and t.ERROR=0,t.adjrw,0)) as adjm04
, count(if(month(t.datetime_disch)=5 and t.ERROR=0,t.an,null)) as cntm05
, sum(if(month(t.datetime_disch)=5 and t.ERROR=0,t.adjrw,0)) as adjm05
, count(if(month(t.datetime_disch)=6 and t.ERROR=0,t.an,null)) as cntm06
, sum(if(month(t.datetime_disch)=6 and t.ERROR=0,t.adjrw,0)) as adjm06
, count(if(month(t.datetime_disch)=7 and t.ERROR=0,t.an,null)) as cntm07
, sum(if(month(t.datetime_disch)=7 and t.ERROR=0,t.adjrw,0)) as adjm07
, count(if(month(t.datetime_disch)=8 and t.ERROR=0,t.an,null)) as cntm08
, sum(if(month(t.datetime_disch)=8 and t.ERROR=0, t.adjrw,0)) as adjm08
, count(if(month(t.datetime_disch)=9 and t.ERROR=0,t.an,null)) as cntm09
, sum(if(month(t.datetime_disch)=9 and t.ERROR=0,t.adjrw,0)) as adjm09
, count(if(t.error=0, t.HOSPCODE,null)) as cntok
FROM admission t
WHERE date_format(t.datetime_disch,'%Y%m%d') BETWEEN @start_d and @end_d
GROUP BY t.hospcode, t.drg
);
ALTER TABLE tmp_cmiadmission ADD KEY(hospcode);

DROP TABLES IF EXISTS tmp_ccmihosp;
CREATE TABLE IF NOT EXISTS tmp_ccmihosp(
SELECT
t.hcode, t.hname, t.chwcode, t.chwname, t.region, t.regbed, t.actbed, t.splevel
FROM ccmihosp t
WHERE t.byear=@b_year+543
);
ALTER TABLE tmp_ccmihosp ADD KEY(hcode);
ALTER TABLE tmp_ccmihosp ADD KEY(splevel);

DROP TABLES IF EXISTS tmp_ccmistd;
CREATE TABLE IF NOT EXISTS tmp_ccmistd(
SELECT
t.splevel, t.refcmi, t.pctlowcmi
FROM ccmistd t
WHERE t.byear=@b_year+543
);
ALTER TABLE tmp_ccmistd ADD KEY(splevel);

DROP TABLES IF EXISTS t_cmi_admission;
CREATE TABLE IF NOT EXISTS t_cmi_admission(
SELECT SQL_BIG_RESULT
t.hospcode, t.drg, t.cntan, t.sumadj
, h.hname, h.chwcode, h.chwname, h.region, h.regbed, h.actbed, h.splevel
, s.refcmi, s.pctlowcmi, @b_year as byear
, t.cntm10, t.adjm10, t.cntm11, t.adjm11, t.cntm12, t.adjm12, t.cntm01, t.adjm01
, t.cntm02, t.adjm02, t.cntm03, t.adjm03, t.cntm04, t.adjm04, t.cntm05, t.adjm05
, t.cntm06, t.adjm06, t.cntm07, t.adjm07, t.cntm08, t.adjm08, t.cntm09, t.adjm09
, t.cntok
FROM tmp_cmiadmission t JOIN tmp_ccmihosp h ON t.hospcode = h.hcode
JOIN tmp_ccmistd s ON h.splevel = s.splevel
);
ALTER TABLE tmp_ccmistd ADD KEY(splevel);

DROP TABLES IF EXISTS tmp_cmiadmission;
#DROP TABLES IF EXISTS tmp_diag_ipd;
DROP TABLES IF EXISTS tmp_ccmihosp;
DROP TABLES IF EXISTS tmp_ccmistd;
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.342247;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:167;a:5:{i:0;s:3727:"CREATE PROCEDURE t_cmi1()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '23';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLES IF EXISTS tmp_cmiadmission;
CREATE TABLE IF NOT EXISTS tmp_cmiadmission(
SELECT SQL_BIG_RESULT t.hospcode, t.drg, count(t.an) as cntan, sum(t.adjrw) as sumadj
, count(if(month(t.datetime_disch)=10 and t.ERROR=0,t.an,null)) as cntm10
, sum(if(month(t.datetime_disch)=10 and t.ERROR=0,t.adjrw,0)) as adjm10
, count(if(month(t.datetime_disch)=11 and t.ERROR=0,t.an,null)) as cntm11
, sum(if(month(t.datetime_disch)=11 and t.ERROR=0,t.adjrw,0)) as adjm11
, count(if(month(t.datetime_disch)=12 and t.ERROR=0,t.an,null)) as cntm12
, sum(if(month(t.datetime_disch)=12 and t.ERROR=0,t.adjrw,0)) as adjm12
, count(if(month(t.datetime_disch)=1 and t.ERROR=0,t.an,null)) as cntm01
, sum(if(month(t.datetime_disch)=1 and t.ERROR=0,t.adjrw,0)) as adjm01
, count(if(month(t.datetime_disch)=2 and t.ERROR=0,t.an,null)) as cntm02
, sum(if(month(t.datetime_disch)=2 and t.ERROR=0,t.adjrw,0)) as adjm02
, count(if(month(t.datetime_disch)=3 and t.ERROR=0,t.an,null)) as cntm03
, sum(if(month(t.datetime_disch)=3 and t.ERROR=0,t.adjrw,0)) as adjm03
, count(if(month(t.datetime_disch)=4 and t.ERROR=0,t.an,null)) as cntm04
, sum(if(month(t.datetime_disch)=4 and t.ERROR=0,t.adjrw,0)) as adjm04
, count(if(month(t.datetime_disch)=5 and t.ERROR=0,t.an,null)) as cntm05
, sum(if(month(t.datetime_disch)=5 and t.ERROR=0,t.adjrw,0)) as adjm05
, count(if(month(t.datetime_disch)=6 and t.ERROR=0,t.an,null)) as cntm06
, sum(if(month(t.datetime_disch)=6 and t.ERROR=0,t.adjrw,0)) as adjm06
, count(if(month(t.datetime_disch)=7 and t.ERROR=0,t.an,null)) as cntm07
, sum(if(month(t.datetime_disch)=7 and t.ERROR=0,t.adjrw,0)) as adjm07
, count(if(month(t.datetime_disch)=8 and t.ERROR=0,t.an,null)) as cntm08
, sum(if(month(t.datetime_disch)=8 and t.ERROR=0, t.adjrw,0)) as adjm08
, count(if(month(t.datetime_disch)=9 and t.ERROR=0,t.an,null)) as cntm09
, sum(if(month(t.datetime_disch)=9 and t.ERROR=0,t.adjrw,0)) as adjm09
, count(if(t.error=0, t.HOSPCODE,null)) as cntok
FROM admission t
WHERE date_format(t.datetime_disch,'%Y%m%d') BETWEEN @start_d and @end_d
GROUP BY t.hospcode, t.drg
);
ALTER TABLE tmp_cmiadmission ADD KEY(hospcode);

DROP TABLES IF EXISTS tmp_ccmihosp;
CREATE TABLE IF NOT EXISTS tmp_ccmihosp(
SELECT
t.hcode, t.hname, t.chwcode, t.chwname, t.region, t.regbed, t.actbed, t.splevel
FROM ccmihosp t
WHERE t.byear=@b_year+543
);
ALTER TABLE tmp_ccmihosp ADD KEY(hcode);
ALTER TABLE tmp_ccmihosp ADD KEY(splevel);

DROP TABLES IF EXISTS tmp_ccmistd;
CREATE TABLE IF NOT EXISTS tmp_ccmistd(
SELECT
t.splevel, t.refcmi, t.pctlowcmi
FROM ccmistd t
WHERE t.byear=@b_year+543
);
ALTER TABLE tmp_ccmistd ADD KEY(splevel);

DROP TABLES IF EXISTS t_cmi_admission;
CREATE TABLE IF NOT EXISTS t_cmi_admission(
SELECT SQL_BIG_RESULT
t.hospcode, t.drg, t.cntan, t.sumadj
, h.hname, h.chwcode, h.chwname, h.region, h.regbed, h.actbed, h.splevel
, s.refcmi, s.pctlowcmi, @b_year as byear
, t.cntm10, t.adjm10, t.cntm11, t.adjm11, t.cntm12, t.adjm12, t.cntm01, t.adjm01
, t.cntm02, t.adjm02, t.cntm03, t.adjm03, t.cntm04, t.adjm04, t.cntm05, t.adjm05
, t.cntm06, t.adjm06, t.cntm07, t.adjm07, t.cntm08, t.adjm08, t.cntm09, t.adjm09
, t.cntok
FROM tmp_cmiadmission t JOIN tmp_ccmihosp h ON t.hospcode = h.hcode
JOIN tmp_ccmistd s ON h.splevel = s.splevel
);
ALTER TABLE tmp_ccmistd ADD KEY(splevel);

DROP TABLES IF EXISTS tmp_cmiadmission;
#DROP TABLES IF EXISTS tmp_diag_ipd;
DROP TABLES IF EXISTS tmp_ccmihosp;
DROP TABLES IF EXISTS tmp_ccmistd;
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.3998489;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:169;a:5:{i:0;s:29:"DROP PROCEDURE IF EXISTS t_bp";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.3998489;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:170;a:5:{i:0;s:29:"DROP PROCEDURE IF EXISTS t_bp";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.4440501;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:172;a:5:{i:0;s:5446:"CREATE PROCEDURE t_bp()
 BEGIN 
SET	@prov_c := '58';
SET @id := '24';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d1:=concat(@b_year-1,'1001');
SET @end_d1:=concat(@b_year-1,'1231');
SET	@start_d2:=concat(@b_year,'0101');
SET @end_d2:=concat(@b_year,'0331');
SET	@start_d3:=concat(@b_year,'0401');
SET @end_d3:=concat(@b_year,'0630');
SET	@start_d4:=concat(@b_year,'0701');
SET @end_d4:=concat(@b_year,'0930');

DROP  TABLE IF EXISTS tmp_bp;
CREATE  TABLE IF NOT EXISTS tmp_bp  (
		cid  VARCHAR(13) not null 
		,bp_date1_tr1 date
		,sbp1_tr1 int(3) DEFAULT 0
		,dbp1_tr1 int(3) DEFAULT 0
		,bp_date2_tr1 date
		,sbp2_tr1 int(3) DEFAULT 0
		,dbp2_tr1 int(3) DEFAULT 0

		,bp_date1_tr2 date
		,sbp1_tr2 int(3) DEFAULT 0
		,dbp1_tr2 int(3) DEFAULT 0
		,bp_date2_tr2 date
		,sbp2_tr2 int(3) DEFAULT 0
		,dbp2_tr2 int(3) DEFAULT 0

		,bp_date1_tr3 date
		,sbp1_tr3 int(3) DEFAULT 0
		,dbp1_tr3 int(3) DEFAULT 0
		,bp_date2_tr3 date
		,sbp2_tr3 int(3) DEFAULT 0
		,dbp2_tr3 int(3) DEFAULT 0

		,bp_date1_tr4 date
		,sbp1_tr4 int(3) DEFAULT 0
		,dbp1_tr4 int(3) DEFAULT 0
		,bp_date2_tr4 date
		,sbp2_tr4 int(3) DEFAULT 0
		,dbp2_tr4 int(3) DEFAULT 0
		
,INDEX(CID)
) ENGINE=MyISAM  ;

INSERT INTO tmp_bp (
cid
)
(
	SELECT c.cid
	FROM tmp_chronicfu c
	INNER JOIN (SELECT cid,type_dx FROM t_dmht WHERE type_dx in('01','03')) dh ON dh.cid=c.CID
	WHERE  LENGTH(TRIM(c.cid))=13 AND c.DATE_SERV BETWEEN @start_d1 AND @end_d4
	GROUP BY c.cid
);

UPDATE tmp_bp bp,( SELECT c.cid,c.DATE_SERV,c.SBP,c.DBP
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV<=@end_d1 AND c.DATE_SERV =
								(SELECT c1.DATE_SERV 
								FROM tmp_chronicfu c1
								WHERE c1.cid=c.cid AND c1.DATE_SERV <=@end_d1
								GROUP BY c1.cid,c1.DATE_SERV 
								ORDER BY c1.date_serv desc LIMIT 0,1)
								GROUP BY cid
										) tbp
	SET bp.bp_date1_tr1=tbp.DATE_SERV ,bp.sbp1_tr1=tbp.sbp , bp.dbp1_tr1=tbp.dbp 
WHERE bp.cid=tbp.cid
;

UPDATE tmp_bp bp,( SELECT c.cid,c.DATE_SERV,c.SBP,c.DBP
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV<=@end_d1 AND c.DATE_SERV =
								(SELECT c1.DATE_SERV 
								FROM tmp_chronicfu c1
								WHERE c1.cid=c.cid AND c1.DATE_SERV <=@end_d1
								GROUP BY c1.cid,c1.DATE_SERV 
								ORDER BY c1.date_serv desc LIMIT 1,1)
								GROUP BY cid
										) tbp
	SET bp.bp_date2_tr1=tbp.DATE_SERV ,bp.sbp2_tr1=tbp.sbp , bp.dbp2_tr1=tbp.dbp 
WHERE bp.cid=tbp.cid
;

UPDATE tmp_bp bp,( SELECT c.cid,c.DATE_SERV,c.SBP,c.DBP
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV<=@end_d2 AND c.DATE_SERV =
								(SELECT c1.DATE_SERV 
								FROM tmp_chronicfu c1
								WHERE c1.cid=c.cid AND c1.DATE_SERV <=@end_d2
								GROUP BY c1.cid,c1.DATE_SERV 
								ORDER BY c1.date_serv desc LIMIT 0,1)
								GROUP BY cid
										) tbp
	SET bp.bp_date1_tr2=tbp.DATE_SERV ,bp.sbp1_tr2=tbp.sbp , bp.dbp1_tr2=tbp.dbp 
WHERE bp.cid=tbp.cid
;

UPDATE tmp_bp bp,( SELECT c.cid,c.DATE_SERV,c.SBP,c.DBP
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV<=@end_d2 AND c.DATE_SERV =
								(SELECT c1.DATE_SERV 
								FROM tmp_chronicfu c1
								WHERE c1.cid=c.cid AND c1.DATE_SERV <=@end_d2
								GROUP BY c1.cid,c1.DATE_SERV 
								ORDER BY c1.date_serv desc LIMIT 1,1)
								GROUP BY cid
										) tbp
	SET bp.bp_date2_tr2=tbp.DATE_SERV ,bp.sbp2_tr2=tbp.sbp , bp.dbp2_tr2=tbp.dbp 
WHERE bp.cid=tbp.cid
;


UPDATE tmp_bp bp,( SELECT c.cid,c.DATE_SERV,c.SBP,c.DBP
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV<=@end_d3 AND c.DATE_SERV =
								(SELECT c1.DATE_SERV 
								FROM tmp_chronicfu c1
								WHERE c1.cid=c.cid AND c1.DATE_SERV <=@end_d3
								GROUP BY c1.cid,c1.DATE_SERV 
								ORDER BY c1.date_serv desc LIMIT 0,1)
								GROUP BY cid
										) tbp
	SET bp.bp_date1_tr3=tbp.DATE_SERV ,bp.sbp1_tr3=tbp.sbp , bp.dbp1_tr3=tbp.dbp 
WHERE bp.cid=tbp.cid
;

UPDATE tmp_bp bp,( SELECT c.cid,c.DATE_SERV,c.SBP,c.DBP
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV<=@end_d3 AND c.DATE_SERV =
								(SELECT c1.DATE_SERV 
								FROM tmp_chronicfu c1
								WHERE c1.cid=c.cid AND c1.DATE_SERV <=@end_d3
								GROUP BY c1.cid,c1.DATE_SERV 
								ORDER BY c1.date_serv desc LIMIT 1,1)
								GROUP BY cid
										) tbp
	SET bp.bp_date2_tr3=tbp.DATE_SERV ,bp.sbp2_tr3=tbp.sbp , bp.dbp2_tr3=tbp.dbp 
WHERE bp.cid=tbp.cid
;


UPDATE tmp_bp bp,( SELECT c.cid,c.DATE_SERV,c.SBP,c.DBP
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV<=@end_d4 AND c.DATE_SERV =
								(SELECT c1.DATE_SERV 
								FROM tmp_chronicfu c1
								WHERE c1.cid=c.cid AND c1.DATE_SERV <=@end_d4
								GROUP BY c1.cid,c1.DATE_SERV 
								ORDER BY c1.date_serv desc LIMIT 0,1)
								GROUP BY cid
										) tbp
	SET bp.bp_date1_tr4=tbp.DATE_SERV ,bp.sbp1_tr4=tbp.sbp , bp.dbp1_tr4=tbp.dbp 
WHERE bp.cid=tbp.cid
;

UPDATE tmp_bp bp,( SELECT c.cid,c.DATE_SERV,c.SBP,c.DBP
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV<=@end_d4 AND c.DATE_SERV =
								(SELECT c1.DATE_SERV 
								FROM tmp_chronicfu c1
								WHERE c1.cid=c.cid AND c1.DATE_SERV <=@end_d4
								GROUP BY c1.cid,c1.DATE_SERV 
								ORDER BY c1.date_serv desc LIMIT 1,1)
								GROUP BY cid
										) tbp
	SET bp.bp_date2_tr4=tbp.DATE_SERV ,bp.sbp2_tr4=tbp.sbp , bp.dbp2_tr4=tbp.dbp 
WHERE bp.cid=tbp.cid
;

 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.4440501;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:173;a:5:{i:0;s:5446:"CREATE PROCEDURE t_bp()
 BEGIN 
SET	@prov_c := '58';
SET @id := '24';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d1:=concat(@b_year-1,'1001');
SET @end_d1:=concat(@b_year-1,'1231');
SET	@start_d2:=concat(@b_year,'0101');
SET @end_d2:=concat(@b_year,'0331');
SET	@start_d3:=concat(@b_year,'0401');
SET @end_d3:=concat(@b_year,'0630');
SET	@start_d4:=concat(@b_year,'0701');
SET @end_d4:=concat(@b_year,'0930');

DROP  TABLE IF EXISTS tmp_bp;
CREATE  TABLE IF NOT EXISTS tmp_bp  (
		cid  VARCHAR(13) not null 
		,bp_date1_tr1 date
		,sbp1_tr1 int(3) DEFAULT 0
		,dbp1_tr1 int(3) DEFAULT 0
		,bp_date2_tr1 date
		,sbp2_tr1 int(3) DEFAULT 0
		,dbp2_tr1 int(3) DEFAULT 0

		,bp_date1_tr2 date
		,sbp1_tr2 int(3) DEFAULT 0
		,dbp1_tr2 int(3) DEFAULT 0
		,bp_date2_tr2 date
		,sbp2_tr2 int(3) DEFAULT 0
		,dbp2_tr2 int(3) DEFAULT 0

		,bp_date1_tr3 date
		,sbp1_tr3 int(3) DEFAULT 0
		,dbp1_tr3 int(3) DEFAULT 0
		,bp_date2_tr3 date
		,sbp2_tr3 int(3) DEFAULT 0
		,dbp2_tr3 int(3) DEFAULT 0

		,bp_date1_tr4 date
		,sbp1_tr4 int(3) DEFAULT 0
		,dbp1_tr4 int(3) DEFAULT 0
		,bp_date2_tr4 date
		,sbp2_tr4 int(3) DEFAULT 0
		,dbp2_tr4 int(3) DEFAULT 0
		
,INDEX(CID)
) ENGINE=MyISAM  ;

INSERT INTO tmp_bp (
cid
)
(
	SELECT c.cid
	FROM tmp_chronicfu c
	INNER JOIN (SELECT cid,type_dx FROM t_dmht WHERE type_dx in('01','03')) dh ON dh.cid=c.CID
	WHERE  LENGTH(TRIM(c.cid))=13 AND c.DATE_SERV BETWEEN @start_d1 AND @end_d4
	GROUP BY c.cid
);

UPDATE tmp_bp bp,( SELECT c.cid,c.DATE_SERV,c.SBP,c.DBP
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV<=@end_d1 AND c.DATE_SERV =
								(SELECT c1.DATE_SERV 
								FROM tmp_chronicfu c1
								WHERE c1.cid=c.cid AND c1.DATE_SERV <=@end_d1
								GROUP BY c1.cid,c1.DATE_SERV 
								ORDER BY c1.date_serv desc LIMIT 0,1)
								GROUP BY cid
										) tbp
	SET bp.bp_date1_tr1=tbp.DATE_SERV ,bp.sbp1_tr1=tbp.sbp , bp.dbp1_tr1=tbp.dbp 
WHERE bp.cid=tbp.cid
;

UPDATE tmp_bp bp,( SELECT c.cid,c.DATE_SERV,c.SBP,c.DBP
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV<=@end_d1 AND c.DATE_SERV =
								(SELECT c1.DATE_SERV 
								FROM tmp_chronicfu c1
								WHERE c1.cid=c.cid AND c1.DATE_SERV <=@end_d1
								GROUP BY c1.cid,c1.DATE_SERV 
								ORDER BY c1.date_serv desc LIMIT 1,1)
								GROUP BY cid
										) tbp
	SET bp.bp_date2_tr1=tbp.DATE_SERV ,bp.sbp2_tr1=tbp.sbp , bp.dbp2_tr1=tbp.dbp 
WHERE bp.cid=tbp.cid
;

UPDATE tmp_bp bp,( SELECT c.cid,c.DATE_SERV,c.SBP,c.DBP
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV<=@end_d2 AND c.DATE_SERV =
								(SELECT c1.DATE_SERV 
								FROM tmp_chronicfu c1
								WHERE c1.cid=c.cid AND c1.DATE_SERV <=@end_d2
								GROUP BY c1.cid,c1.DATE_SERV 
								ORDER BY c1.date_serv desc LIMIT 0,1)
								GROUP BY cid
										) tbp
	SET bp.bp_date1_tr2=tbp.DATE_SERV ,bp.sbp1_tr2=tbp.sbp , bp.dbp1_tr2=tbp.dbp 
WHERE bp.cid=tbp.cid
;

UPDATE tmp_bp bp,( SELECT c.cid,c.DATE_SERV,c.SBP,c.DBP
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV<=@end_d2 AND c.DATE_SERV =
								(SELECT c1.DATE_SERV 
								FROM tmp_chronicfu c1
								WHERE c1.cid=c.cid AND c1.DATE_SERV <=@end_d2
								GROUP BY c1.cid,c1.DATE_SERV 
								ORDER BY c1.date_serv desc LIMIT 1,1)
								GROUP BY cid
										) tbp
	SET bp.bp_date2_tr2=tbp.DATE_SERV ,bp.sbp2_tr2=tbp.sbp , bp.dbp2_tr2=tbp.dbp 
WHERE bp.cid=tbp.cid
;


UPDATE tmp_bp bp,( SELECT c.cid,c.DATE_SERV,c.SBP,c.DBP
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV<=@end_d3 AND c.DATE_SERV =
								(SELECT c1.DATE_SERV 
								FROM tmp_chronicfu c1
								WHERE c1.cid=c.cid AND c1.DATE_SERV <=@end_d3
								GROUP BY c1.cid,c1.DATE_SERV 
								ORDER BY c1.date_serv desc LIMIT 0,1)
								GROUP BY cid
										) tbp
	SET bp.bp_date1_tr3=tbp.DATE_SERV ,bp.sbp1_tr3=tbp.sbp , bp.dbp1_tr3=tbp.dbp 
WHERE bp.cid=tbp.cid
;

UPDATE tmp_bp bp,( SELECT c.cid,c.DATE_SERV,c.SBP,c.DBP
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV<=@end_d3 AND c.DATE_SERV =
								(SELECT c1.DATE_SERV 
								FROM tmp_chronicfu c1
								WHERE c1.cid=c.cid AND c1.DATE_SERV <=@end_d3
								GROUP BY c1.cid,c1.DATE_SERV 
								ORDER BY c1.date_serv desc LIMIT 1,1)
								GROUP BY cid
										) tbp
	SET bp.bp_date2_tr3=tbp.DATE_SERV ,bp.sbp2_tr3=tbp.sbp , bp.dbp2_tr3=tbp.dbp 
WHERE bp.cid=tbp.cid
;


UPDATE tmp_bp bp,( SELECT c.cid,c.DATE_SERV,c.SBP,c.DBP
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV<=@end_d4 AND c.DATE_SERV =
								(SELECT c1.DATE_SERV 
								FROM tmp_chronicfu c1
								WHERE c1.cid=c.cid AND c1.DATE_SERV <=@end_d4
								GROUP BY c1.cid,c1.DATE_SERV 
								ORDER BY c1.date_serv desc LIMIT 0,1)
								GROUP BY cid
										) tbp
	SET bp.bp_date1_tr4=tbp.DATE_SERV ,bp.sbp1_tr4=tbp.sbp , bp.dbp1_tr4=tbp.dbp 
WHERE bp.cid=tbp.cid
;

UPDATE tmp_bp bp,( SELECT c.cid,c.DATE_SERV,c.SBP,c.DBP
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV<=@end_d4 AND c.DATE_SERV =
								(SELECT c1.DATE_SERV 
								FROM tmp_chronicfu c1
								WHERE c1.cid=c.cid AND c1.DATE_SERV <=@end_d4
								GROUP BY c1.cid,c1.DATE_SERV 
								ORDER BY c1.date_serv desc LIMIT 1,1)
								GROUP BY cid
										) tbp
	SET bp.bp_date2_tr4=tbp.DATE_SERV ,bp.sbp2_tr4=tbp.sbp , bp.dbp2_tr4=tbp.dbp 
WHERE bp.cid=tbp.cid
;

 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.5064499;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:175;a:5:{i:0;s:29:"DROP PROCEDURE IF EXISTS t_fp";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.5064499;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:176;a:5:{i:0;s:29:"DROP PROCEDURE IF EXISTS t_fp";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.56885;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:178;a:5:{i:0;s:1249:"CREATE PROCEDURE t_fp()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '25';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-2,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP  TABLE IF EXISTS tmp_fp;
CREATE TABLE IF NOT EXISTS tmp_fp(
  `HOSPCODE` varchar(5) NOT NULL,
  `PID` varchar(15) NOT NULL,
  `SEQ` varchar(16) DEFAULT NULL,
  `DATE_SERV` date NOT NULL,
  `FPTYPE` char(1) NOT NULL,
  `FPPLACE` varchar(5) DEFAULT NULL,
  `PROVIDER` varchar(15) DEFAULT NULL,
  `D_UPDATE` datetime NOT NULL,
	 cid varchar(13) DEFAULT NULL,
	 nation varchar(3)  DEFAULT NULL,
	 age_y int(3)  DEFAULT 0,
  PRIMARY KEY (`HOSPCODE`,`PID`,`DATE_SERV`,`FPTYPE`),
  KEY `idx1` (`HOSPCODE`,`PID`),
  KEY `idx2` (`HOSPCODE`),
  KEY `idx3` (`DATE_SERV`),
  KEY `idx4` (`FPTYPE`),
  KEY `idx5` (`FPPLACE`),
  KEY `idx6` (`HOSPCODE`,`PROVIDER`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT INTO tmp_fp 
(
SELECT SQL_BIG_RESULT 
	fp.HOSPCODE,fp.PID,fp.SEQ,fp.DATE_SERV,fp.FPTYPE,fp.FPPLACE,fp.PROVIDER,fp.D_UPDATE,p.cid,p.nation,age(fp.date_serv,p.birth,'y') age_y
FROM
	fp LEFT JOIN person p ON fp.HOSPCODE=p.HOSPCODE AND fp.PID=p.PID
WHERE 
	fp.date_serv BETWEEN @start_d AND @end_d
);


 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.56885;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:179;a:5:{i:0;s:1249:"CREATE PROCEDURE t_fp()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '25';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-2,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP  TABLE IF EXISTS tmp_fp;
CREATE TABLE IF NOT EXISTS tmp_fp(
  `HOSPCODE` varchar(5) NOT NULL,
  `PID` varchar(15) NOT NULL,
  `SEQ` varchar(16) DEFAULT NULL,
  `DATE_SERV` date NOT NULL,
  `FPTYPE` char(1) NOT NULL,
  `FPPLACE` varchar(5) DEFAULT NULL,
  `PROVIDER` varchar(15) DEFAULT NULL,
  `D_UPDATE` datetime NOT NULL,
	 cid varchar(13) DEFAULT NULL,
	 nation varchar(3)  DEFAULT NULL,
	 age_y int(3)  DEFAULT 0,
  PRIMARY KEY (`HOSPCODE`,`PID`,`DATE_SERV`,`FPTYPE`),
  KEY `idx1` (`HOSPCODE`,`PID`),
  KEY `idx2` (`HOSPCODE`),
  KEY `idx3` (`DATE_SERV`),
  KEY `idx4` (`FPTYPE`),
  KEY `idx5` (`FPPLACE`),
  KEY `idx6` (`HOSPCODE`,`PROVIDER`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT INTO tmp_fp 
(
SELECT SQL_BIG_RESULT 
	fp.HOSPCODE,fp.PID,fp.SEQ,fp.DATE_SERV,fp.FPTYPE,fp.FPPLACE,fp.PROVIDER,fp.D_UPDATE,p.cid,p.nation,age(fp.date_serv,p.birth,'y') age_y
FROM
	fp LEFT JOIN person p ON fp.HOSPCODE=p.HOSPCODE AND fp.PID=p.PID
WHERE 
	fp.date_serv BETWEEN @start_d AND @end_d
);


 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.6156509;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:181;a:5:{i:0;s:37:"DROP PROCEDURE IF EXISTS t_charge_opd";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.6156509;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:182;a:5:{i:0;s:37:"DROP PROCEDURE IF EXISTS t_charge_opd";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.678051;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:184;a:5:{i:0;s:1347:"CREATE PROCEDURE t_charge_opd()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '26';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLES IF EXISTS tmp_charge_opd;
CREATE TABLE IF NOT EXISTS tmp_charge_opd (
KEY(cid),
KEY(hospcode),
KEY(pid),
KEY(date_serv),
KEY(chargeitem),
KEY(hospcode,pid),
KEY(hospcode,pid,seq)
) ENGINE=MyISAM  AS(
		SELECT 
				a.*,p.CID,p.nation,p.sex,p.check_hosp,p.check_vhid,p.check_typearea,p.vhid,p.typearea
		FROM
			charge_opd a LEFT JOIN t_person_db p ON a.HOSPCODE=p.HOSPCODE AND a.PID=p.PID 
		WHERE a.DATE_SERV BETWEEN  @start_d AND @end_d
);

DROP TABLES IF EXISTS t_charge_opd;
CREATE TABLE IF NOT EXISTS t_charge_opd (
KEY(cid),
KEY(hospcode),
KEY(pid),
KEY(date_serv),
KEY(chargeitem),
KEY(hospcode,pid),
KEY(hospcode,pid,seq)
) ENGINE=MyISAM  AS(
		SELECT 
				HOSPCODE,PID,SEQ,DATE_SERV,CLINIC,CHARGEITEM,CHARGELIST
				,INSTYPE
				,SUM(QUANTITY)  QUANTITY
				,SUM(COST) COST
				,SUM(PRICE) PRICE
				,SUM(PAYPRICE) PAYPRICE
				,D_UPDATE
				,CID, nation, sex, check_hosp, check_vhid, check_typearea, vhid, typearea
		FROM
			tmp_charge_opd a
		WHERE a.DATE_SERV BETWEEN  @start_d AND @end_d
		GROUP BY a.HOSPCODE,a.PID,a.SEQ,CLINIC,a.CHARGEITEM,INSTYPE
);


 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.678051;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:185;a:5:{i:0;s:1347:"CREATE PROCEDURE t_charge_opd()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '26';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLES IF EXISTS tmp_charge_opd;
CREATE TABLE IF NOT EXISTS tmp_charge_opd (
KEY(cid),
KEY(hospcode),
KEY(pid),
KEY(date_serv),
KEY(chargeitem),
KEY(hospcode,pid),
KEY(hospcode,pid,seq)
) ENGINE=MyISAM  AS(
		SELECT 
				a.*,p.CID,p.nation,p.sex,p.check_hosp,p.check_vhid,p.check_typearea,p.vhid,p.typearea
		FROM
			charge_opd a LEFT JOIN t_person_db p ON a.HOSPCODE=p.HOSPCODE AND a.PID=p.PID 
		WHERE a.DATE_SERV BETWEEN  @start_d AND @end_d
);

DROP TABLES IF EXISTS t_charge_opd;
CREATE TABLE IF NOT EXISTS t_charge_opd (
KEY(cid),
KEY(hospcode),
KEY(pid),
KEY(date_serv),
KEY(chargeitem),
KEY(hospcode,pid),
KEY(hospcode,pid,seq)
) ENGINE=MyISAM  AS(
		SELECT 
				HOSPCODE,PID,SEQ,DATE_SERV,CLINIC,CHARGEITEM,CHARGELIST
				,INSTYPE
				,SUM(QUANTITY)  QUANTITY
				,SUM(COST) COST
				,SUM(PRICE) PRICE
				,SUM(PAYPRICE) PAYPRICE
				,D_UPDATE
				,CID, nation, sex, check_hosp, check_vhid, check_typearea, vhid, typearea
		FROM
			tmp_charge_opd a
		WHERE a.DATE_SERV BETWEEN  @start_d AND @end_d
		GROUP BY a.HOSPCODE,a.PID,a.SEQ,CLINIC,a.CHARGEITEM,INSTYPE
);


 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.7248509;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:187;a:5:{i:0;s:39:"DROP PROCEDURE IF EXISTS t_nation_labor";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.7248509;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:188;a:5:{i:0;s:39:"DROP PROCEDURE IF EXISTS t_nation_labor";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.802851;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:190;a:5:{i:0;s:4417:"CREATE PROCEDURE t_nation_labor()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '27';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP  TABLE IF EXISTS  t_admission_labor;
CREATE  TABLE IF NOT EXISTS t_admission_labor (INDEX(HOSPCODE,AN)) 
ENGINE=MyISAM  AS 
(
SELECT 
 a.HOSPCODE,a.AN,p.cid,p.sex,a.DATETIME_ADMIT,a.DATETIME_DISCH,a.INSTYPE,a.PRICE,a.PAYPRICE,a.ACTUALPAY,(a.PRICE-a.ACTUALPAY) as fee ,p.LABOR, p.NATION,nationcodeaec,
		IF(LABOR IN('12','14','22','38') ,1
			,IF(LABOR IN('24') ,2
			,IF(LABOR IN('36','37') ,3
			,IF(LABOR IN('22','38') AND SUBSTR(p.CID,1,1) IN(0,3,4,5,6,7,8) ,4
			,IF(LABOR IN('01','02','03','11','15','16','17','18') AND SUBSTR(p.CID,1,1) IN(0,3,4,5,6,7,8) ,5
			,IF(LABOR IN('01','02','03','11','15','16','17','18') ,6,0
		))))))  as labor_group ,'        ' diagcode ,' ' diagtype
FROM tmp_admission a
				INNER JOIN t_person_db p ON a.HOSPCODE =p.HOSPCODE AND a.PID=p.PID
				INNER JOIN cnation n ON a.nation =n.nationcode
WHERE p.nation != 99     AND a.DATETIME_DISCH BETWEEN @start_d AND @end_d  
);
update t_admission_labor	a	LEFT JOIN tmp_diag_ipd d ON a.HOSPCODE =d.HOSPCODE AND a.AN=d.AN   
SET a.diagcode=d.diagcode , a.diagtype=d.diagtype
WHERE d.diagtype in(1);

DROP  TABLE IF EXISTS  t_service_labor;
CREATE  TABLE IF NOT EXISTS t_service_labor (INDEX(HOSPCODE,pid,seq)) 
ENGINE=MyISAM  AS 
(
SELECT 
 a.HOSPCODE,a.pid,p.cid,p.sex,a.seq,a.date_serv,a.INSTYPE,a.PRICE,a.PAYPRICE,a.ACTUALPAY,(a.PRICE-a.ACTUALPAY) as fee ,p.LABOR, p.NATION,nationcodeaec,
		IF(LABOR IN('12','14','22','38') ,1
			,IF(LABOR IN('24') ,2
			,IF(LABOR IN('36','37') ,3
			,IF(LABOR IN('22','38') AND SUBSTR(p.CID,1,1) IN(0,3,4,5,6,7,8) ,4
			,IF(LABOR IN('01','02','03','11','15','16','17','18') AND SUBSTR(p.CID,1,1) IN(0,3,4,5,6,7,8) ,5
			,IF(LABOR IN('01','02','03','11','15','16','17','18') ,6,0
		))))))  as labor_group  ,'        ' diagcode ,' ' diagtype
FROM tmp_service a
					INNER JOIN t_person_db p ON a.HOSPCODE =p.HOSPCODE AND a.PID=p.PID
					INNER JOIN cnation n ON a.nation =n.nationcode
WHERE p.nation != 99     AND a.date_serv BETWEEN @start_d AND @end_d 
);
update t_service_labor	a	LEFT JOIN tmp_diag_opd d ON a.HOSPCODE =d.HOSPCODE AND a.PID=d.PID AND a.SEQ=d.SEQ  
SET a.diagcode=d.diagcode , a.diagtype=d.diagtype
WHERE d.diagtype in(1);



DROP  TABLE IF EXISTS  t_anc_labor;
CREATE  TABLE IF NOT EXISTS t_anc_labor (INDEX(HOSPCODE,pid,seq)) 
ENGINE=MyISAM  AS 
(
SELECT 
 a.HOSPCODE,a.pid,s.cid,s.sex,a.seq,a.date_serv,s.INSTYPE,s.LABOR, s.NATION,nationcodeaec,s.labor_group
FROM tmp_anc a 
				INNER JOIN t_service_labor s ON a.HOSPCODE =s.HOSPCODE AND a.PID=s.PID	AND a.SEQ=s.SEQ	
	WHERE  a.date_serv BETWEEN @start_d AND @end_d 
);


DROP  TABLE IF EXISTS  tmp_postnatal;
CREATE  TABLE IF NOT EXISTS tmp_postnatal (INDEX(HOSPCODE,pid,seq)) 
ENGINE=MyISAM  AS 
(
SELECT po.*,p.cid,p.nation,p.occupation_new occupat,p.birth,p.check_vhid vhid
FROM postnatal po LEFT JOIN t_person_db p ON po.hospcode=p.hospcode and po.pid=p.pid
WHERE po.BDATE BETWEEN @start_d AND @end_d
);

DROP  TABLE IF EXISTS  t_postnatal_labor;
CREATE  TABLE IF NOT EXISTS t_postnatal_labor (INDEX(HOSPCODE,pid,seq)) 
ENGINE=MyISAM  AS 
(
SELECT 
 a.HOSPCODE,a.pid,s.cid,s.sex,a.seq,a.BDATE,s.INSTYPE,s.LABOR, s.NATION,nationcodeaec,s.labor_group
FROM tmp_postnatal a 
				INNER JOIN t_service_labor s ON a.HOSPCODE =s.HOSPCODE AND a.PID=s.PID	AND a.SEQ=s.SEQ	
WHERE a.BDATE BETWEEN @start_d AND @end_d 
);

DROP  TABLE IF EXISTS  t_epi_labor;
CREATE  TABLE IF NOT EXISTS t_epi_labor (INDEX(HOSPCODE,pid,seq)) 
ENGINE=MyISAM  AS 
(
SELECT 
	a.HOSPCODE,a.pid,s.cid,s.sex,a.seq,a.date_serv,s.INSTYPE,s.LABOR, s.NATION,nationcodeaec,s.labor_group
FROM tmp_epi a 
				INNER JOIN t_service_labor s ON a.HOSPCODE =s.HOSPCODE AND a.PID=s.PID	AND a.SEQ=s.SEQ	
	WHERE a.date_serv BETWEEN @start_d AND @end_d 
);

DROP  TABLE IF EXISTS  t_fp_labor;
CREATE  TABLE IF NOT EXISTS t_fp_labor (INDEX(HOSPCODE,pid,seq)) 
ENGINE=MyISAM  AS 
(
SELECT 
 a.HOSPCODE,a.pid,s.cid,s.sex,a.seq,a.date_serv,s.INSTYPE,s.LABOR, s.NATION,nationcodeaec,s.labor_group
FROM tmp_fp a 
				INNER JOIN t_service_labor s ON a.HOSPCODE =s.HOSPCODE AND a.PID=s.PID	AND a.SEQ=s.SEQ	
WHERE a.date_serv BETWEEN @start_d AND @end_d
);
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.802851;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:191;a:5:{i:0;s:4417:"CREATE PROCEDURE t_nation_labor()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '27';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP  TABLE IF EXISTS  t_admission_labor;
CREATE  TABLE IF NOT EXISTS t_admission_labor (INDEX(HOSPCODE,AN)) 
ENGINE=MyISAM  AS 
(
SELECT 
 a.HOSPCODE,a.AN,p.cid,p.sex,a.DATETIME_ADMIT,a.DATETIME_DISCH,a.INSTYPE,a.PRICE,a.PAYPRICE,a.ACTUALPAY,(a.PRICE-a.ACTUALPAY) as fee ,p.LABOR, p.NATION,nationcodeaec,
		IF(LABOR IN('12','14','22','38') ,1
			,IF(LABOR IN('24') ,2
			,IF(LABOR IN('36','37') ,3
			,IF(LABOR IN('22','38') AND SUBSTR(p.CID,1,1) IN(0,3,4,5,6,7,8) ,4
			,IF(LABOR IN('01','02','03','11','15','16','17','18') AND SUBSTR(p.CID,1,1) IN(0,3,4,5,6,7,8) ,5
			,IF(LABOR IN('01','02','03','11','15','16','17','18') ,6,0
		))))))  as labor_group ,'        ' diagcode ,' ' diagtype
FROM tmp_admission a
				INNER JOIN t_person_db p ON a.HOSPCODE =p.HOSPCODE AND a.PID=p.PID
				INNER JOIN cnation n ON a.nation =n.nationcode
WHERE p.nation != 99     AND a.DATETIME_DISCH BETWEEN @start_d AND @end_d  
);
update t_admission_labor	a	LEFT JOIN tmp_diag_ipd d ON a.HOSPCODE =d.HOSPCODE AND a.AN=d.AN   
SET a.diagcode=d.diagcode , a.diagtype=d.diagtype
WHERE d.diagtype in(1);

DROP  TABLE IF EXISTS  t_service_labor;
CREATE  TABLE IF NOT EXISTS t_service_labor (INDEX(HOSPCODE,pid,seq)) 
ENGINE=MyISAM  AS 
(
SELECT 
 a.HOSPCODE,a.pid,p.cid,p.sex,a.seq,a.date_serv,a.INSTYPE,a.PRICE,a.PAYPRICE,a.ACTUALPAY,(a.PRICE-a.ACTUALPAY) as fee ,p.LABOR, p.NATION,nationcodeaec,
		IF(LABOR IN('12','14','22','38') ,1
			,IF(LABOR IN('24') ,2
			,IF(LABOR IN('36','37') ,3
			,IF(LABOR IN('22','38') AND SUBSTR(p.CID,1,1) IN(0,3,4,5,6,7,8) ,4
			,IF(LABOR IN('01','02','03','11','15','16','17','18') AND SUBSTR(p.CID,1,1) IN(0,3,4,5,6,7,8) ,5
			,IF(LABOR IN('01','02','03','11','15','16','17','18') ,6,0
		))))))  as labor_group  ,'        ' diagcode ,' ' diagtype
FROM tmp_service a
					INNER JOIN t_person_db p ON a.HOSPCODE =p.HOSPCODE AND a.PID=p.PID
					INNER JOIN cnation n ON a.nation =n.nationcode
WHERE p.nation != 99     AND a.date_serv BETWEEN @start_d AND @end_d 
);
update t_service_labor	a	LEFT JOIN tmp_diag_opd d ON a.HOSPCODE =d.HOSPCODE AND a.PID=d.PID AND a.SEQ=d.SEQ  
SET a.diagcode=d.diagcode , a.diagtype=d.diagtype
WHERE d.diagtype in(1);



DROP  TABLE IF EXISTS  t_anc_labor;
CREATE  TABLE IF NOT EXISTS t_anc_labor (INDEX(HOSPCODE,pid,seq)) 
ENGINE=MyISAM  AS 
(
SELECT 
 a.HOSPCODE,a.pid,s.cid,s.sex,a.seq,a.date_serv,s.INSTYPE,s.LABOR, s.NATION,nationcodeaec,s.labor_group
FROM tmp_anc a 
				INNER JOIN t_service_labor s ON a.HOSPCODE =s.HOSPCODE AND a.PID=s.PID	AND a.SEQ=s.SEQ	
	WHERE  a.date_serv BETWEEN @start_d AND @end_d 
);


DROP  TABLE IF EXISTS  tmp_postnatal;
CREATE  TABLE IF NOT EXISTS tmp_postnatal (INDEX(HOSPCODE,pid,seq)) 
ENGINE=MyISAM  AS 
(
SELECT po.*,p.cid,p.nation,p.occupation_new occupat,p.birth,p.check_vhid vhid
FROM postnatal po LEFT JOIN t_person_db p ON po.hospcode=p.hospcode and po.pid=p.pid
WHERE po.BDATE BETWEEN @start_d AND @end_d
);

DROP  TABLE IF EXISTS  t_postnatal_labor;
CREATE  TABLE IF NOT EXISTS t_postnatal_labor (INDEX(HOSPCODE,pid,seq)) 
ENGINE=MyISAM  AS 
(
SELECT 
 a.HOSPCODE,a.pid,s.cid,s.sex,a.seq,a.BDATE,s.INSTYPE,s.LABOR, s.NATION,nationcodeaec,s.labor_group
FROM tmp_postnatal a 
				INNER JOIN t_service_labor s ON a.HOSPCODE =s.HOSPCODE AND a.PID=s.PID	AND a.SEQ=s.SEQ	
WHERE a.BDATE BETWEEN @start_d AND @end_d 
);

DROP  TABLE IF EXISTS  t_epi_labor;
CREATE  TABLE IF NOT EXISTS t_epi_labor (INDEX(HOSPCODE,pid,seq)) 
ENGINE=MyISAM  AS 
(
SELECT 
	a.HOSPCODE,a.pid,s.cid,s.sex,a.seq,a.date_serv,s.INSTYPE,s.LABOR, s.NATION,nationcodeaec,s.labor_group
FROM tmp_epi a 
				INNER JOIN t_service_labor s ON a.HOSPCODE =s.HOSPCODE AND a.PID=s.PID	AND a.SEQ=s.SEQ	
	WHERE a.date_serv BETWEEN @start_d AND @end_d 
);

DROP  TABLE IF EXISTS  t_fp_labor;
CREATE  TABLE IF NOT EXISTS t_fp_labor (INDEX(HOSPCODE,pid,seq)) 
ENGINE=MyISAM  AS 
(
SELECT 
 a.HOSPCODE,a.pid,s.cid,s.sex,a.seq,a.date_serv,s.INSTYPE,s.LABOR, s.NATION,nationcodeaec,s.labor_group
FROM tmp_fp a 
				INNER JOIN t_service_labor s ON a.HOSPCODE =s.HOSPCODE AND a.PID=s.PID	AND a.SEQ=s.SEQ	
WHERE a.date_serv BETWEEN @start_d AND @end_d
);
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.8496511;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:193;a:5:{i:0;s:32:"DROP PROCEDURE IF EXISTS t_refer";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.8496511;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:194;a:5:{i:0;s:32:"DROP PROCEDURE IF EXISTS t_refer";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.912051;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:196;a:5:{i:0;s:2406:"CREATE PROCEDURE t_refer()
 BEGIN 
SET @prov_c :='58';
SET	@id:= '28';
SET	@year_start:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@year_start-1,'1001');
SET @end_d:=concat(@year_start,'0930');

DROP TABLE IF EXISTS t_refer;
CREATE TABLE IF NOT EXISTS t_refer (INDEX(HOSPCODE,PID,date_serv)) 
ENGINE=MyISAM  AS 
(SELECT
hospcode,h.provcode prov ,c.zonecode zone,pid,cid,date_serv, 'opd' source,causeout,typeout,referouthosp,ho.provcode referoutprov ,c1.zonecode referzone
FROM
(
SELECT
s.hospcode,s.pid,s.date_serv,s.causeout,s.typeout,s.REFEROUTHOSP,CID
FROM
tmp_service s  
 WHERE s.typeout  in(3) 
AND DATE_FORMAT(s.date_serv,'%Y%m%d') BETWEEN @start_d AND @end_d
) o
INNER JOIN chospital h ON o.hospcode=h.hoscode
LEFT JOIN chospital ho ON o.referouthosp =ho.hoscode
LEFT JOIN cchangwat c ON h.provcode =c.changwatcode
LEFT JOIN cchangwat c1 ON ho.provcode =c1.changwatcode
WHERE
		h.hostype in(5,6,7,11,12,15) AND h.hdc_regist in(1)
);


DROP TABLES IF EXISTS tmpz_admission;
CREATE TABLE IF NOT EXISTS tmpz_admission (
KEY (cid),
KEY (hospcode),
KEY (pid),
KEY (datetime_admit),
KEY (datetime_disch),
KEY (instype),
KEY (TYPEIN),
KEY (REFERINHOSP),
KEY (DISCHSTATUS),
KEY (DISCHTYPE),
KEY (REFEROUTHOSP),
KEY (an),
KEY (hospcode,an)
) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		a.*,IF(DATEDIFF(DATETIME_DISCH,DATETIME_ADMIT)!=0,DATEDIFF(DATETIME_DISCH,DATETIME_ADMIT),1) as day,p.CID,p.nation
FROM
	admission a LEFT JOIN t_person_db p ON a.HOSPCODE=p.HOSPCODE AND a.PID=p.PID
WHERE	(DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d') BETWEEN @start_d1 AND @end_d OR DATE_FORMAT(DATETIME_DISCH,'%Y%m%d') BETWEEN @start_d1 AND @end_d)
);


INSERT IGNORE INTO t_refer(
SELECT
hospcode,h.provcode prov,c.zonecode,pid,cid,date_serv,'ipd',causeout,typeout,referouthosp,ho.provcode referoutprov ,c1.zonecode
FROM
(
SELECT
s.hospcode,s.AN pid,s.DATETIME_DISCH date_serv,s.causeout,s.DISCHTYPE typeout,s.REFEROUTHOSP,CID
FROM
tmpz_admission s  
 WHERE s.DISCHTYPE  in(4) 
AND DATE_FORMAT(s.DATETIME_DISCH,'%Y%m%d') BETWEEN @start_d1 AND @end_d
) o
INNER JOIN chospital h ON o.hospcode=h.hoscode
LEFT JOIN chospital ho ON o.referouthosp =ho.hoscode
LEFT JOIN cchangwat c ON h.provcode =c.changwatcode
LEFT JOIN cchangwat c1 ON ho.provcode =c1.changwatcode
WHERE
		h.hostype in(5,6,7,11,12,15) AND h.hdc_regist in(1)
);

 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.912051;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:197;a:5:{i:0;s:2406:"CREATE PROCEDURE t_refer()
 BEGIN 
SET @prov_c :='58';
SET	@id:= '28';
SET	@year_start:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@year_start-1,'1001');
SET @end_d:=concat(@year_start,'0930');

DROP TABLE IF EXISTS t_refer;
CREATE TABLE IF NOT EXISTS t_refer (INDEX(HOSPCODE,PID,date_serv)) 
ENGINE=MyISAM  AS 
(SELECT
hospcode,h.provcode prov ,c.zonecode zone,pid,cid,date_serv, 'opd' source,causeout,typeout,referouthosp,ho.provcode referoutprov ,c1.zonecode referzone
FROM
(
SELECT
s.hospcode,s.pid,s.date_serv,s.causeout,s.typeout,s.REFEROUTHOSP,CID
FROM
tmp_service s  
 WHERE s.typeout  in(3) 
AND DATE_FORMAT(s.date_serv,'%Y%m%d') BETWEEN @start_d AND @end_d
) o
INNER JOIN chospital h ON o.hospcode=h.hoscode
LEFT JOIN chospital ho ON o.referouthosp =ho.hoscode
LEFT JOIN cchangwat c ON h.provcode =c.changwatcode
LEFT JOIN cchangwat c1 ON ho.provcode =c1.changwatcode
WHERE
		h.hostype in(5,6,7,11,12,15) AND h.hdc_regist in(1)
);


DROP TABLES IF EXISTS tmpz_admission;
CREATE TABLE IF NOT EXISTS tmpz_admission (
KEY (cid),
KEY (hospcode),
KEY (pid),
KEY (datetime_admit),
KEY (datetime_disch),
KEY (instype),
KEY (TYPEIN),
KEY (REFERINHOSP),
KEY (DISCHSTATUS),
KEY (DISCHTYPE),
KEY (REFEROUTHOSP),
KEY (an),
KEY (hospcode,an)
) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		a.*,IF(DATEDIFF(DATETIME_DISCH,DATETIME_ADMIT)!=0,DATEDIFF(DATETIME_DISCH,DATETIME_ADMIT),1) as day,p.CID,p.nation
FROM
	admission a LEFT JOIN t_person_db p ON a.HOSPCODE=p.HOSPCODE AND a.PID=p.PID
WHERE	(DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d') BETWEEN @start_d1 AND @end_d OR DATE_FORMAT(DATETIME_DISCH,'%Y%m%d') BETWEEN @start_d1 AND @end_d)
);


INSERT IGNORE INTO t_refer(
SELECT
hospcode,h.provcode prov,c.zonecode,pid,cid,date_serv,'ipd',causeout,typeout,referouthosp,ho.provcode referoutprov ,c1.zonecode
FROM
(
SELECT
s.hospcode,s.AN pid,s.DATETIME_DISCH date_serv,s.causeout,s.DISCHTYPE typeout,s.REFEROUTHOSP,CID
FROM
tmpz_admission s  
 WHERE s.DISCHTYPE  in(4) 
AND DATE_FORMAT(s.DATETIME_DISCH,'%Y%m%d') BETWEEN @start_d1 AND @end_d
) o
INNER JOIN chospital h ON o.hospcode=h.hoscode
LEFT JOIN chospital ho ON o.referouthosp =ho.hoscode
LEFT JOIN cchangwat c ON h.provcode =c.changwatcode
LEFT JOIN cchangwat c1 ON ho.provcode =c1.changwatcode
WHERE
		h.hostype in(5,6,7,11,12,15) AND h.hdc_regist in(1)
);

 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.9744511;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:199;a:5:{i:0;s:39:"DROP PROCEDURE IF EXISTS t_childdev1830";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.9744511;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:200;a:5:{i:0;s:39:"DROP PROCEDURE IF EXISTS t_childdev1830";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.021251;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:202;a:5:{i:0;s:5594:"CREATE PROCEDURE t_childdev1830()
 BEGIN 
SET @prov_c :='58';
SET	@id:= '29';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
SET @begin_d=DATE_ADD(@start_d,INTERVAL -30 month);
SET @begin_d1=DATE_ADD(@start_d,INTERVAL -1 month);
SET @end_d1:=concat(@b_year,'1030');

DROP TABLE IF EXISTS t_childdev1830;
CREATE TABLE  IF NOT EXISTS t_childdev1830(INDEX (hospcode,pid,cid)) ENGINE=MyISAM  AS  
(SELECT
 p.HOSPCODE,p.PID,p.CID,p.BIRTH,p.check_vhid AREACODE,p.check_typearea TYPEAREA
, if(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d) in(18,30),1,0) M10
, IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 1 MONTH) in(18,30),1,0) M11
, if(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 2 MONTH) in(18,30),1,0) M12
, if(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 3 MONTH) in(18,30),1,0) M01
, if(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 4 MONTH) in(18,30),1,0) M02
, if(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 5 MONTH) in(18,30),1,0) M03
, if(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 6 MONTH) in(18,30),1,0) M04
, if(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 7 MONTH) in(18,30),1,0) M05
, if(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 8 MONTH) in(18,30),1,0) M06
, if(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 9 MONTH) in(18,30),1,0) M07
, if(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 10 MONTH) in(18,30),1,0) M08
, if(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 11 MONTH) in(18,30),1,0) M09

,IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d) in(18),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 1 MONTH) in(18),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 2 MONTH) in(18),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 3 MONTH) in(18),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 4 MONTH) in(18),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 5 MONTH) in(18),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 6 MONTH) in(18),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 7 MONTH) in(18),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 8 MONTH) in(18),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 9 MONTH) in(18),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 10 MONTH) in(18),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 11 MONTH) in(18),1,
   0))))))))))))  AGE_18
,IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d) in(30),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 1 MONTH) in(30),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 2 MONTH) in(30),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 3 MONTH) in(30),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 4 MONTH) in(30),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 5 MONTH) in(30),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 6 MONTH) in(30),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 7 MONTH) in(30),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 8 MONTH) in(30),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 9 MONTH) in(30),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 10 MONTH) in(30),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 11 MONTH) in(30),1,
   0))))))))))))  AGE_30

, STR_TO_DATE('0000000','%Y%m%d') DATE_SERV
,0 AGE_SERV
,0 PASS
, STR_TO_DATE('0000000','%Y%m%d') DATE_START
, STR_TO_DATE('0000000','%Y%m%d') DATE_END
FROM t_person_cid  p
WHERE BIRTH BETWEEN @begin_d AND @end_d AND
						check_typearea in('1','3') AND p.DISCHARGE='9' AND LENGTH(trim(p.CID))=13 AND  
						(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d) IN(18,30) OR 
							TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d + INTERVAL 1 MONTH) IN(18,30) OR 
							TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d + INTERVAL 2 MONTH) IN(18,30) OR 
							TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d + INTERVAL 3 MONTH) IN(18,30) OR 
							TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d + INTERVAL 4 MONTH) IN(18,30) OR 
							TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d + INTERVAL 5 MONTH) IN(18,30) OR 
							TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d + INTERVAL 6 MONTH) IN(18,30) OR 
							TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d + INTERVAL 7 MONTH) IN(18,30) OR 
							TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d + INTERVAL 8 MONTH) IN(18,30) OR 
							TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d + INTERVAL 9 MONTH) IN(18,30) OR 
							TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d + INTERVAL 10 MONTH) IN(18,30) OR 
							TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d + INTERVAL 11 MONTH) IN(18,30) 
						)
);
UPDATE t_childdev1830 SET date_serv=NULL , date_start=NULL ,date_end=NULL  WHERE DATE_FORMAT(date_serv,'%Y%m%d')='00000000';
UPDATE  t_childdev1830 SET date_start=DATE_ADD(BIRTH,INTERVAL 18 month) ,date_end=DATE_ADD(DATE_ADD(BIRTH,INTERVAL 19 month),INTERVAL -1 DAY)  WHERE age_18=1;
UPDATE  t_childdev1830 SET date_start=DATE_ADD(BIRTH,INTERVAL 30 month) ,date_end=DATE_ADD(DATE_ADD(BIRTH,INTERVAL 31 month),INTERVAL -1 DAY)  WHERE age_30=1;

DROP TEMPORARY  TABLE IF EXISTS tmz_nutrition;
CREATE TEMPORARY TABLE tmz_nutrition(INDEX (cid)) ENGINE=MyISAM  AS  
(SELECT p.HOSPCODE,p.PID,p.cid,n1.DATE_SERV
		FROM nutrition n1 INNER JOIN person p ON  p.HOSPCODE =n1.HOSPCODE AND p.PID=n1.PID
		WHERE  n1.CHILDDEVELOP in(SELECT id_childdevelop FROM cchilddevelop)  
		AND n1.date_serv  BETWEEN @begin_d1  AND @end_d1
);
UPDATE  t_childdev1830 c INNER JOIN tmz_nutrition	n ON n.cid=c.cid  SET c.date_serv=n.DATE_SERV 
,c.age_serv=TIMESTAMPDIFF(MONTH,c.BIRTH,n.DATE_SERV),c.pass=1
WHERE  TIMESTAMPDIFF(MONTH,c.BIRTH,n.DATE_SERV) IN(18,30) ; 

DROP TEMPORARY TABLE tmz_nutrition;

 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.021251;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:203;a:5:{i:0;s:5594:"CREATE PROCEDURE t_childdev1830()
 BEGIN 
SET @prov_c :='58';
SET	@id:= '29';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
SET @begin_d=DATE_ADD(@start_d,INTERVAL -30 month);
SET @begin_d1=DATE_ADD(@start_d,INTERVAL -1 month);
SET @end_d1:=concat(@b_year,'1030');

DROP TABLE IF EXISTS t_childdev1830;
CREATE TABLE  IF NOT EXISTS t_childdev1830(INDEX (hospcode,pid,cid)) ENGINE=MyISAM  AS  
(SELECT
 p.HOSPCODE,p.PID,p.CID,p.BIRTH,p.check_vhid AREACODE,p.check_typearea TYPEAREA
, if(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d) in(18,30),1,0) M10
, IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 1 MONTH) in(18,30),1,0) M11
, if(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 2 MONTH) in(18,30),1,0) M12
, if(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 3 MONTH) in(18,30),1,0) M01
, if(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 4 MONTH) in(18,30),1,0) M02
, if(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 5 MONTH) in(18,30),1,0) M03
, if(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 6 MONTH) in(18,30),1,0) M04
, if(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 7 MONTH) in(18,30),1,0) M05
, if(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 8 MONTH) in(18,30),1,0) M06
, if(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 9 MONTH) in(18,30),1,0) M07
, if(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 10 MONTH) in(18,30),1,0) M08
, if(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 11 MONTH) in(18,30),1,0) M09

,IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d) in(18),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 1 MONTH) in(18),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 2 MONTH) in(18),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 3 MONTH) in(18),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 4 MONTH) in(18),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 5 MONTH) in(18),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 6 MONTH) in(18),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 7 MONTH) in(18),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 8 MONTH) in(18),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 9 MONTH) in(18),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 10 MONTH) in(18),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 11 MONTH) in(18),1,
   0))))))))))))  AGE_18
,IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d) in(30),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 1 MONTH) in(30),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 2 MONTH) in(30),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 3 MONTH) in(30),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 4 MONTH) in(30),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 5 MONTH) in(30),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 6 MONTH) in(30),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 7 MONTH) in(30),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 8 MONTH) in(30),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 9 MONTH) in(30),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 10 MONTH) in(30),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 11 MONTH) in(30),1,
   0))))))))))))  AGE_30

, STR_TO_DATE('0000000','%Y%m%d') DATE_SERV
,0 AGE_SERV
,0 PASS
, STR_TO_DATE('0000000','%Y%m%d') DATE_START
, STR_TO_DATE('0000000','%Y%m%d') DATE_END
FROM t_person_cid  p
WHERE BIRTH BETWEEN @begin_d AND @end_d AND
						check_typearea in('1','3') AND p.DISCHARGE='9' AND LENGTH(trim(p.CID))=13 AND  
						(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d) IN(18,30) OR 
							TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d + INTERVAL 1 MONTH) IN(18,30) OR 
							TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d + INTERVAL 2 MONTH) IN(18,30) OR 
							TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d + INTERVAL 3 MONTH) IN(18,30) OR 
							TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d + INTERVAL 4 MONTH) IN(18,30) OR 
							TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d + INTERVAL 5 MONTH) IN(18,30) OR 
							TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d + INTERVAL 6 MONTH) IN(18,30) OR 
							TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d + INTERVAL 7 MONTH) IN(18,30) OR 
							TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d + INTERVAL 8 MONTH) IN(18,30) OR 
							TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d + INTERVAL 9 MONTH) IN(18,30) OR 
							TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d + INTERVAL 10 MONTH) IN(18,30) OR 
							TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d + INTERVAL 11 MONTH) IN(18,30) 
						)
);
UPDATE t_childdev1830 SET date_serv=NULL , date_start=NULL ,date_end=NULL  WHERE DATE_FORMAT(date_serv,'%Y%m%d')='00000000';
UPDATE  t_childdev1830 SET date_start=DATE_ADD(BIRTH,INTERVAL 18 month) ,date_end=DATE_ADD(DATE_ADD(BIRTH,INTERVAL 19 month),INTERVAL -1 DAY)  WHERE age_18=1;
UPDATE  t_childdev1830 SET date_start=DATE_ADD(BIRTH,INTERVAL 30 month) ,date_end=DATE_ADD(DATE_ADD(BIRTH,INTERVAL 31 month),INTERVAL -1 DAY)  WHERE age_30=1;

DROP TEMPORARY  TABLE IF EXISTS tmz_nutrition;
CREATE TEMPORARY TABLE tmz_nutrition(INDEX (cid)) ENGINE=MyISAM  AS  
(SELECT p.HOSPCODE,p.PID,p.cid,n1.DATE_SERV
		FROM nutrition n1 INNER JOIN person p ON  p.HOSPCODE =n1.HOSPCODE AND p.PID=n1.PID
		WHERE  n1.CHILDDEVELOP in(SELECT id_childdevelop FROM cchilddevelop)  
		AND n1.date_serv  BETWEEN @begin_d1  AND @end_d1
);
UPDATE  t_childdev1830 c INNER JOIN tmz_nutrition	n ON n.cid=c.cid  SET c.date_serv=n.DATE_SERV 
,c.age_serv=TIMESTAMPDIFF(MONTH,c.BIRTH,n.DATE_SERV),c.pass=1
WHERE  TIMESTAMPDIFF(MONTH,c.BIRTH,n.DATE_SERV) IN(18,30) ; 

DROP TEMPORARY TABLE tmz_nutrition;

 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.0836511;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:205;a:5:{i:0;s:38:"DROP PROCEDURE IF EXISTS t_cmi_referin";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.0836511;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:206;a:5:{i:0;s:38:"DROP PROCEDURE IF EXISTS t_cmi_referin";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.130451;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:208;a:5:{i:0;s:1231:"CREATE PROCEDURE t_cmi_referin()
 BEGIN 
SET @prov_c :='58';
SET @id:= '30';
SET @year_start:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@year_start-1,'1001');
SET @end_d:=concat(@year_start,'0930');


DROP TABLE IF EXISTS t_cmi_referin;
CREATE TABLE IF NOT EXISTS t_cmi_referin (INDEX(monthly,hospcode,referin,drg)) 
		ENGINE=MyISAM  AS 
		(select @year_start as byear,DATE_FORMAT(t.DATETIME_DISCH,'%Y%m')  as monthly,t.HOSPCODE as hospcode, 
						a.chwcode, a.region, a.splevel, 
						t.REFERINHOSP as referin, b.hostype as refer_hostype, b.provcode as refer_prov, c.zonecode as refer_region,
						t.DRG as drg, count(t.AN) as cases, sum(t.ADJRW) as sum_adjrw,
						sum(if(t.ADJRW=0,1,0)) as adjrw0, t.RW as rw
						from tmp_admission t join (select t.hcode, t.hname, t.chwcode, t.chwname, t.region, t.splevel
										from ccmihosp t where t.byear = @year_start+543) a on t.HOSPCODE = a.hcode
										join chospital b on t.REFERINHOSP = b.hoscode
										join cchangwat c on b.provcode=c.changwatcode
						where t.REFERINHOSP != ''	AND DATE_FORMAT(t.DATETIME_DISCH,'%Y%m%d') BETWEEN @start_d AND @end_d
						group by t.HOSPCODE,monthly, t.REFERINHOSP, t.DRG
) ;

 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.1460509;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:209;a:5:{i:0;s:1231:"CREATE PROCEDURE t_cmi_referin()
 BEGIN 
SET @prov_c :='58';
SET @id:= '30';
SET @year_start:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@year_start-1,'1001');
SET @end_d:=concat(@year_start,'0930');


DROP TABLE IF EXISTS t_cmi_referin;
CREATE TABLE IF NOT EXISTS t_cmi_referin (INDEX(monthly,hospcode,referin,drg)) 
		ENGINE=MyISAM  AS 
		(select @year_start as byear,DATE_FORMAT(t.DATETIME_DISCH,'%Y%m')  as monthly,t.HOSPCODE as hospcode, 
						a.chwcode, a.region, a.splevel, 
						t.REFERINHOSP as referin, b.hostype as refer_hostype, b.provcode as refer_prov, c.zonecode as refer_region,
						t.DRG as drg, count(t.AN) as cases, sum(t.ADJRW) as sum_adjrw,
						sum(if(t.ADJRW=0,1,0)) as adjrw0, t.RW as rw
						from tmp_admission t join (select t.hcode, t.hname, t.chwcode, t.chwname, t.region, t.splevel
										from ccmihosp t where t.byear = @year_start+543) a on t.HOSPCODE = a.hcode
										join chospital b on t.REFERINHOSP = b.hoscode
										join cchangwat c on b.provcode=c.changwatcode
						where t.REFERINHOSP != ''	AND DATE_FORMAT(t.DATETIME_DISCH,'%Y%m%d') BETWEEN @start_d AND @end_d
						group by t.HOSPCODE,monthly, t.REFERINHOSP, t.DRG
) ;

 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.192852;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:211;a:5:{i:0;s:39:"DROP PROCEDURE IF EXISTS ws_person_dmht";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.192852;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:212;a:5:{i:0;s:39:"DROP PROCEDURE IF EXISTS ws_person_dmht";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.2552519;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:214;a:5:{i:0;s:3370:"CREATE PROCEDURE ws_person_dmht()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '31';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

CREATE TABLE IF NOT EXISTS ws_person_dmht(
  provcode varchar(2) not null,
  cid varchar(13) not null,
  flag_sent varchar(1) DEFAULT '0',
  type_dx int(1) DEFAULT '0',
	last_hba1c decimal(10,2) DEFAULT 0.00,
  date_serv_hba1c date,
  hba1c_hosp VARCHAR(5),
	last_fpg decimal(10,2) DEFAULT 0.00,
  date_serv_fpg date,
	fpg_hosp VARCHAR(5),
  last_sbp int(3) DEFAULT 0,
  last_dbp int(3) DEFAULT 0,
  date_serv_bp date,
	bp_hosp VARCHAR(5),
PRIMARY KEY (provcode,cid),
KEY (cid)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

CREATE TABLE IF NOT EXISTS ws_delete(
  provcode varchar(2) not null,
  cid varchar(13) not null,
  flag_sent varchar(1) DEFAULT '0',
  ws_table varchar(150) not null,
PRIMARY KEY (provcode,cid,ws_table),
KEY (provcode),
KEY (cid),
KEY (ws_table)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

DELETE FROM ws_delete WHERE flag_sent='2';

#ลบกรณีเปลี่ยนการวินิจฉัย;
DROP TEMPORARY TABLE IF EXISTS tmz_ws_cid_del;
CREATE TEMPORARY TABLE  IF NOT EXISTS tmz_ws_cid_del (PRIMARY KEY (CID)) 
ENGINE=MyISAM  AS 
(
SELECT
m.cid
FROM ws_person_dmht m LEFT JOIN t_dmht d ON m.cid=d.cid 
WHERE  d.cid is NULL
);

INSERT IGNORE INTO  ws_delete (SELECT @prov_c,cid,'0','ws_person_dmht' FROM  tmz_ws_cid_del);
DELETE FROM ws_person_dmht  WHERE cid in(SELECT cid FROM tmz_ws_cid_del ) ;

#สร้างตัวเปรียบเทียบเฉพาะที่ข้อมูลไม่ตรงกันให้แทนที่ หากเท่ากันทุก filed ไม่ต้องทำอะไร;
DROP TEMPORARY TABLE IF EXISTS tmz_ws_cid_prompt;
CREATE TEMPORARY TABLE  IF NOT EXISTS tmz_ws_cid_prompt (PRIMARY KEY (CID)) 
ENGINE=MyISAM  AS 
(
SELECT SQL_BIG_RESULT 
			@prov_c provcode
			,cid
			,type_dx 
			,rs_hba1c last_hba1c 
			,ld_hba1c date_serv_hba1c 
			,ih_hba1c  hba1c_hosp
			,rs_fpg1 last_fpg 
			,ld_fpg1 date_serv_fpg 
			,ih_fpg1  fpg_hosp
			,rs_bps1 last_sbp
			,rs_bpd1 last_dbp
			,ld_bp1 date_serv_bp
			,ih_bp1  bp_hosp
FROM 
		t_dmht
WHERE mod11(cid)=1 
				AND (SUBSTR(cid,1,6) not in(SELECT CONCAT('0',hoscode) FROM chospital WHERE provcode in(@prov_c))  
				AND SUBSTR(cid,1,5) not in(SELECT hoscode FROM chospital WHERE provcode in(@prov_c)))
);
#REPLACE ON Change OR Not found;
REPLACE  INTO ws_person_dmht (
SELECT SQL_BIG_RESULT
			p.provcode
			,p.cid
			,'0'
			,p.type_dx 
			,p.last_hba1c 
			,p.date_serv_hba1c 
			,p.hba1c_hosp
			,p.last_fpg 
			,p.date_serv_fpg 
			,p.fpg_hosp
			,p.last_sbp
			,p.last_dbp
			,p.date_serv_bp
			,p.bp_hosp
FROM
		tmz_ws_cid_prompt p LEFT JOIN ws_person_dmht d ON p.cid=d.cid
WHERE 
		d.cid IS NULL
		OR p.type_dx != d.type_dx  
		OR p.last_hba1c != d.last_hba1c 
		OR p.date_serv_hba1c != d.date_serv_hba1c 
		OR p.hba1c_hosp != d.hba1c_hosp 		
		OR p.last_fpg != d.last_fpg 
		OR p.date_serv_fpg != d.date_serv_fpg 
		OR p.fpg_hosp != d.fpg_hosp 		
		OR p.last_sbp != d.last_sbp 
		OR p.last_dbp != d.last_dbp
		OR p.date_serv_bp != d.date_serv_bp
		OR p.bp_hosp != d.bp_hosp 		

 );
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.2552519;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:215;a:5:{i:0;s:3370:"CREATE PROCEDURE ws_person_dmht()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '31';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

CREATE TABLE IF NOT EXISTS ws_person_dmht(
  provcode varchar(2) not null,
  cid varchar(13) not null,
  flag_sent varchar(1) DEFAULT '0',
  type_dx int(1) DEFAULT '0',
	last_hba1c decimal(10,2) DEFAULT 0.00,
  date_serv_hba1c date,
  hba1c_hosp VARCHAR(5),
	last_fpg decimal(10,2) DEFAULT 0.00,
  date_serv_fpg date,
	fpg_hosp VARCHAR(5),
  last_sbp int(3) DEFAULT 0,
  last_dbp int(3) DEFAULT 0,
  date_serv_bp date,
	bp_hosp VARCHAR(5),
PRIMARY KEY (provcode,cid),
KEY (cid)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

CREATE TABLE IF NOT EXISTS ws_delete(
  provcode varchar(2) not null,
  cid varchar(13) not null,
  flag_sent varchar(1) DEFAULT '0',
  ws_table varchar(150) not null,
PRIMARY KEY (provcode,cid,ws_table),
KEY (provcode),
KEY (cid),
KEY (ws_table)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

DELETE FROM ws_delete WHERE flag_sent='2';

#ลบกรณีเปลี่ยนการวินิจฉัย;
DROP TEMPORARY TABLE IF EXISTS tmz_ws_cid_del;
CREATE TEMPORARY TABLE  IF NOT EXISTS tmz_ws_cid_del (PRIMARY KEY (CID)) 
ENGINE=MyISAM  AS 
(
SELECT
m.cid
FROM ws_person_dmht m LEFT JOIN t_dmht d ON m.cid=d.cid 
WHERE  d.cid is NULL
);

INSERT IGNORE INTO  ws_delete (SELECT @prov_c,cid,'0','ws_person_dmht' FROM  tmz_ws_cid_del);
DELETE FROM ws_person_dmht  WHERE cid in(SELECT cid FROM tmz_ws_cid_del ) ;

#สร้างตัวเปรียบเทียบเฉพาะที่ข้อมูลไม่ตรงกันให้แทนที่ หากเท่ากันทุก filed ไม่ต้องทำอะไร;
DROP TEMPORARY TABLE IF EXISTS tmz_ws_cid_prompt;
CREATE TEMPORARY TABLE  IF NOT EXISTS tmz_ws_cid_prompt (PRIMARY KEY (CID)) 
ENGINE=MyISAM  AS 
(
SELECT SQL_BIG_RESULT 
			@prov_c provcode
			,cid
			,type_dx 
			,rs_hba1c last_hba1c 
			,ld_hba1c date_serv_hba1c 
			,ih_hba1c  hba1c_hosp
			,rs_fpg1 last_fpg 
			,ld_fpg1 date_serv_fpg 
			,ih_fpg1  fpg_hosp
			,rs_bps1 last_sbp
			,rs_bpd1 last_dbp
			,ld_bp1 date_serv_bp
			,ih_bp1  bp_hosp
FROM 
		t_dmht
WHERE mod11(cid)=1 
				AND (SUBSTR(cid,1,6) not in(SELECT CONCAT('0',hoscode) FROM chospital WHERE provcode in(@prov_c))  
				AND SUBSTR(cid,1,5) not in(SELECT hoscode FROM chospital WHERE provcode in(@prov_c)))
);
#REPLACE ON Change OR Not found;
REPLACE  INTO ws_person_dmht (
SELECT SQL_BIG_RESULT
			p.provcode
			,p.cid
			,'0'
			,p.type_dx 
			,p.last_hba1c 
			,p.date_serv_hba1c 
			,p.hba1c_hosp
			,p.last_fpg 
			,p.date_serv_fpg 
			,p.fpg_hosp
			,p.last_sbp
			,p.last_dbp
			,p.date_serv_bp
			,p.bp_hosp
FROM
		tmz_ws_cid_prompt p LEFT JOIN ws_person_dmht d ON p.cid=d.cid
WHERE 
		d.cid IS NULL
		OR p.type_dx != d.type_dx  
		OR p.last_hba1c != d.last_hba1c 
		OR p.date_serv_hba1c != d.date_serv_hba1c 
		OR p.hba1c_hosp != d.hba1c_hosp 		
		OR p.last_fpg != d.last_fpg 
		OR p.date_serv_fpg != d.date_serv_fpg 
		OR p.fpg_hosp != d.fpg_hosp 		
		OR p.last_sbp != d.last_sbp 
		OR p.last_dbp != d.last_dbp
		OR p.date_serv_bp != d.date_serv_bp
		OR p.bp_hosp != d.bp_hosp 		

 );
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.317652;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:217;a:5:{i:0;s:44:"DROP PROCEDURE IF EXISTS ws_person_nutrition";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.317652;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:218;a:5:{i:0;s:44:"DROP PROCEDURE IF EXISTS ws_person_nutrition";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.3800521;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:220;a:5:{i:0;s:4575:"CREATE PROCEDURE ws_person_nutrition()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '32';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
DROP TABLE IF EXISTS t_obes;
CREATE TABLE IF NOT EXISTS t_obes 
(
cid VARCHAR(13) NOT NULL,
sex VARCHAR(1) NOT NULL DEFAULT '0',
birth date,
age_y VARCHAR(3) NOT NULL DEFAULT '0',
hospcode VARCHAR(5) DEFAULT NULL,
date_serv date ,
weight decimal(5,1) NOT NULL DEFAULT '0',
height int(3) NOT NULL DEFAULT '0',
waist_cm int(3) NOT NULL DEFAULT '0',
bmi decimal(10,1) NOT NULL DEFAULT '0',
nutri_level int(1) NOT NULL DEFAULT '0',
bmi_id int(1) NOT NULL DEFAULT '0',
PRIMARY KEY (cid)
) ENGINE MyISAM DEFAULT CHARACTER SET=utf8 ;

/*INSERT*/
INSERT IGNORE INTO  t_obes(cid)
SELECT
n.cid
FROM
tmp_nutrition n
WHERE
mod11(n.cid) =1 AND TIMESTAMPDIFF(YEAR,DATE_SERV,now()) <6;

INSERT IGNORE INTO  t_obes(cid)
SELECT
n.cid
FROM
t_ncdscreen n
WHERE
mod11(n.cid) =1 AND TIMESTAMPDIFF(YEAR,DATE_SERV,now()) <6;

INSERT IGNORE INTO  t_obes(cid)
SELECT
n.cid
FROM
tmp_chronicfu n
WHERE
mod11(n.cid) =1 AND TIMESTAMPDIFF(YEAR,DATE_SERV,now()) <6;

/*update from nutrition*/
UPDATE  t_obes o , (
SELECT
cid,hospcode,date_serv,height,weight
FROM
tmp_nutrition 
WHERE
mod11(cid) =1 AND TIMESTAMPDIFF(YEAR,DATE_SERV,now()) <6
ORDER BY date_serv DESC 
 )  n  
SET  o.hospcode=n.hospcode ,o.date_serv=n.date_serv,o.height=n.height,o.weight=n.weight
WHERE o.cid=n.cid;


/*UPDATE FROM ncdscreen*/
UPDATE  t_obes o , (
SELECT
cid,hospcode,date_serv,height,weight,waist_cm
FROM
t_ncdscreen 
WHERE
mod11(cid) =1 AND TIMESTAMPDIFF(YEAR,DATE_SERV,now()) <6
ORDER BY date_serv DESC 
 )  n 
SET  o.hospcode=n.hospcode ,o.date_serv=n.date_serv,o.height=n.height,o.weight=n.weight,o.waist_cm=n.waist_cm
WHERE o.cid=n.cid;

/*INSERT FROM chronicfu*/
UPDATE  t_obes o , (
SELECT
cid,hospcode,date_serv,height,weight,waist_cm
FROM
tmp_chronicfu 
WHERE
mod11(cid) =1 AND TIMESTAMPDIFF(YEAR,DATE_SERV,now()) <6
ORDER BY date_serv DESC 
 )  n 
SET  o.hospcode=n.hospcode ,o.date_serv=n.date_serv,o.height=n.height,o.weight=n.weight,o.waist_cm=n.waist_cm
WHERE o.cid=n.cid;

UPDATE t_obes  o INNER JOIN person  p ON o.cid=p.cid SET o.sex=p.sex
,o.age_y=TIMESTAMPDIFF(year,p.BIRTH,o.date_serv)
,o.birth=p.BIRTH
WHERE p.BIRTH < NOW() AND p.DISCHARGE =9;

DELETE FROM t_obes WHERE sex not in(1,2);

UPDATE t_obes o ,(
SELECT
cid
,IFNULL(nutri_cal(TIMESTAMPDIFF(MONTH,birth,date_serv),SEX,3,height,weight),0) nutri_level
FROM
t_obes
WHERE age_y BETWEEN 0 AND 18
) w SET o.nutri_level=w.nutri_level
WHERE o.cid=w.cid;


UPDATE t_obes SET  BMI= IFNULL(round(weight/((height/100)*(height/100)),2),0)
WHERE age_y>18;

UPDATE t_obes SET  BMI= IFNULL(round(weight/((height/100)*(height/100)),2),0)
WHERE nutri_level=0 OR bmi=0;

DELETE FROM t_obes WHERE height=0 OR weight=0;
DELETE FROM t_obes WHERE date_serv < birth;
DELETE FROM t_obes WHERE TIMESTAMPDIFF(YEAR,birth,NOW()) > 120;
DELETE FROM t_obes WHERE bmi >200;
DELETE FROM t_obes WHERE substr(cid,2,5) in(SELECT hoscode FROM chospital WHERE provcode =@prov_c);
DELETE FROM t_obes WHERE substr(cid,1,5) in(SELECT hoscode FROM chospital WHERE provcode =@prov_c);

UPDATE t_obes o , cbmi_result r  SET o.bmi_id = r.bmi_id  WHERE o.bmi BETWEEN  r.min AND r.max ;
CREATE TABLE IF NOT EXISTS ws_person_nutrition
(
provcode VARCHAR(2) NOT NULL,
cid VARCHAR(13) NOT NULL,
flag_sent VARCHAR(1) NOT NULL DEFAULT '0',
sex VARCHAR(1) NOT NULL,
birth date,
age_y VARCHAR(3) NOT NULL,
hospcode VARCHAR(5) DEFAULT NULL,
date_serv date ,
weight decimal(5,1) NOT NULL DEFAULT '0',
height int(3) NOT NULL DEFAULT '0',
waist_cm int(3) NOT NULL DEFAULT '0',
bmi decimal(10,1) NOT NULL DEFAULT '0',
bmi_result varchar(255) NOT NULL DEFAULT '',
nutri_level int(1) NOT NULL DEFAULT '0',
nutri_result varchar(255) NOT NULL DEFAULT '',
PRIMARY KEY (provcode,cid)
) ENGINE MyISAM DEFAULT CHARACTER SET=utf8 ;

DELETE w  FROM ws_person_nutrition w INNER JOIN t_obes o ON w.cid=o.cid 
WHERE o.hospcode !=w.hospcode OR o.date_serv != w.date_serv OR o.bmi !=w.bmi OR o.nutri_level != w.nutri_level;

INSERT IGNORE INTO ws_person_nutrition 
(
SELECT
@prov_c,o.cid,'0',o.sex,o.birth,o.age_y,o.hospcode,o.date_serv,o.weight,o.height,o.waist_cm,o.bmi, b.bmi_result ,o.nutri_level,n.nutri_name
FROM
	t_obes  o 
	LEFT JOIN cbmi_result b on o.bmi_id=b.bmi_id
	LEFT JOIN cnutri_result n on o.nutri_level=n.nutri_level
);

 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.3800521;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:221;a:5:{i:0;s:4575:"CREATE PROCEDURE ws_person_nutrition()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '32';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
DROP TABLE IF EXISTS t_obes;
CREATE TABLE IF NOT EXISTS t_obes 
(
cid VARCHAR(13) NOT NULL,
sex VARCHAR(1) NOT NULL DEFAULT '0',
birth date,
age_y VARCHAR(3) NOT NULL DEFAULT '0',
hospcode VARCHAR(5) DEFAULT NULL,
date_serv date ,
weight decimal(5,1) NOT NULL DEFAULT '0',
height int(3) NOT NULL DEFAULT '0',
waist_cm int(3) NOT NULL DEFAULT '0',
bmi decimal(10,1) NOT NULL DEFAULT '0',
nutri_level int(1) NOT NULL DEFAULT '0',
bmi_id int(1) NOT NULL DEFAULT '0',
PRIMARY KEY (cid)
) ENGINE MyISAM DEFAULT CHARACTER SET=utf8 ;

/*INSERT*/
INSERT IGNORE INTO  t_obes(cid)
SELECT
n.cid
FROM
tmp_nutrition n
WHERE
mod11(n.cid) =1 AND TIMESTAMPDIFF(YEAR,DATE_SERV,now()) <6;

INSERT IGNORE INTO  t_obes(cid)
SELECT
n.cid
FROM
t_ncdscreen n
WHERE
mod11(n.cid) =1 AND TIMESTAMPDIFF(YEAR,DATE_SERV,now()) <6;

INSERT IGNORE INTO  t_obes(cid)
SELECT
n.cid
FROM
tmp_chronicfu n
WHERE
mod11(n.cid) =1 AND TIMESTAMPDIFF(YEAR,DATE_SERV,now()) <6;

/*update from nutrition*/
UPDATE  t_obes o , (
SELECT
cid,hospcode,date_serv,height,weight
FROM
tmp_nutrition 
WHERE
mod11(cid) =1 AND TIMESTAMPDIFF(YEAR,DATE_SERV,now()) <6
ORDER BY date_serv DESC 
 )  n  
SET  o.hospcode=n.hospcode ,o.date_serv=n.date_serv,o.height=n.height,o.weight=n.weight
WHERE o.cid=n.cid;


/*UPDATE FROM ncdscreen*/
UPDATE  t_obes o , (
SELECT
cid,hospcode,date_serv,height,weight,waist_cm
FROM
t_ncdscreen 
WHERE
mod11(cid) =1 AND TIMESTAMPDIFF(YEAR,DATE_SERV,now()) <6
ORDER BY date_serv DESC 
 )  n 
SET  o.hospcode=n.hospcode ,o.date_serv=n.date_serv,o.height=n.height,o.weight=n.weight,o.waist_cm=n.waist_cm
WHERE o.cid=n.cid;

/*INSERT FROM chronicfu*/
UPDATE  t_obes o , (
SELECT
cid,hospcode,date_serv,height,weight,waist_cm
FROM
tmp_chronicfu 
WHERE
mod11(cid) =1 AND TIMESTAMPDIFF(YEAR,DATE_SERV,now()) <6
ORDER BY date_serv DESC 
 )  n 
SET  o.hospcode=n.hospcode ,o.date_serv=n.date_serv,o.height=n.height,o.weight=n.weight,o.waist_cm=n.waist_cm
WHERE o.cid=n.cid;

UPDATE t_obes  o INNER JOIN person  p ON o.cid=p.cid SET o.sex=p.sex
,o.age_y=TIMESTAMPDIFF(year,p.BIRTH,o.date_serv)
,o.birth=p.BIRTH
WHERE p.BIRTH < NOW() AND p.DISCHARGE =9;

DELETE FROM t_obes WHERE sex not in(1,2);

UPDATE t_obes o ,(
SELECT
cid
,IFNULL(nutri_cal(TIMESTAMPDIFF(MONTH,birth,date_serv),SEX,3,height,weight),0) nutri_level
FROM
t_obes
WHERE age_y BETWEEN 0 AND 18
) w SET o.nutri_level=w.nutri_level
WHERE o.cid=w.cid;


UPDATE t_obes SET  BMI= IFNULL(round(weight/((height/100)*(height/100)),2),0)
WHERE age_y>18;

UPDATE t_obes SET  BMI= IFNULL(round(weight/((height/100)*(height/100)),2),0)
WHERE nutri_level=0 OR bmi=0;

DELETE FROM t_obes WHERE height=0 OR weight=0;
DELETE FROM t_obes WHERE date_serv < birth;
DELETE FROM t_obes WHERE TIMESTAMPDIFF(YEAR,birth,NOW()) > 120;
DELETE FROM t_obes WHERE bmi >200;
DELETE FROM t_obes WHERE substr(cid,2,5) in(SELECT hoscode FROM chospital WHERE provcode =@prov_c);
DELETE FROM t_obes WHERE substr(cid,1,5) in(SELECT hoscode FROM chospital WHERE provcode =@prov_c);

UPDATE t_obes o , cbmi_result r  SET o.bmi_id = r.bmi_id  WHERE o.bmi BETWEEN  r.min AND r.max ;
CREATE TABLE IF NOT EXISTS ws_person_nutrition
(
provcode VARCHAR(2) NOT NULL,
cid VARCHAR(13) NOT NULL,
flag_sent VARCHAR(1) NOT NULL DEFAULT '0',
sex VARCHAR(1) NOT NULL,
birth date,
age_y VARCHAR(3) NOT NULL,
hospcode VARCHAR(5) DEFAULT NULL,
date_serv date ,
weight decimal(5,1) NOT NULL DEFAULT '0',
height int(3) NOT NULL DEFAULT '0',
waist_cm int(3) NOT NULL DEFAULT '0',
bmi decimal(10,1) NOT NULL DEFAULT '0',
bmi_result varchar(255) NOT NULL DEFAULT '',
nutri_level int(1) NOT NULL DEFAULT '0',
nutri_result varchar(255) NOT NULL DEFAULT '',
PRIMARY KEY (provcode,cid)
) ENGINE MyISAM DEFAULT CHARACTER SET=utf8 ;

DELETE w  FROM ws_person_nutrition w INNER JOIN t_obes o ON w.cid=o.cid 
WHERE o.hospcode !=w.hospcode OR o.date_serv != w.date_serv OR o.bmi !=w.bmi OR o.nutri_level != w.nutri_level;

INSERT IGNORE INTO ws_person_nutrition 
(
SELECT
@prov_c,o.cid,'0',o.sex,o.birth,o.age_y,o.hospcode,o.date_serv,o.weight,o.height,o.waist_cm,o.bmi, b.bmi_result ,o.nutri_level,n.nutri_name
FROM
	t_obes  o 
	LEFT JOIN cbmi_result b on o.bmi_id=b.bmi_id
	LEFT JOIN cnutri_result n on o.nutri_level=n.nutri_level
);

 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.442452;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:223;a:5:{i:0;s:46:"DROP PROCEDURE IF EXISTS ws_person_drugallergy";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.442452;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:224;a:5:{i:0;s:46:"DROP PROCEDURE IF EXISTS ws_person_drugallergy";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.4892521;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:226;a:5:{i:0;s:2708:"CREATE PROCEDURE ws_person_drugallergy()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '33';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS t_drugallergy;
CREATE TABLE IF NOT EXISTS t_drugallergy (PRIMARY KEY (cid,drugallergy), KEY (cid)) ENGINE MyISAM AS
(SELECT DISTINCT
CID
,DRUGALLERGY
,c.Generic_Name DNAME_STD
/*,IF(INSTR(c.Generic_Name,'MG') ,SUBSTR(c.Generic_Name,1,INSTR(c.Generic_Name,'MG')+1),c.Generic_Name   ) DNAMEP*/
,SPACE(100) DNAMEP
,SPACE(100) DNAME
,DATERECORD
,d.HOSPCODE
FROM
drugallergy d INNER JOIN person p ON d.HOSPCODE=p.HOSPCODE AND d.PID=p.PID
INNER JOIN cdrug_std c ON d.DRUGALLERGY=c.didstd
WHERE mod11(cid)=1  
GROUP BY p.cid,c.didstd
);


UPDATE t_drugallergy SET DNAME_STD = REPLACE(DNAME_STD,' ','#');
UPDATE t_drugallergy SET DNAMEP = IF(INSTR(DNAME_STD,'MG') ,SUBSTR(DNAME_STD,1,INSTR(DNAME_STD,'MG')+1),DNAME_STD );
UPDATE t_drugallergy SET dnamep = repl_digits_pipe(DNAMEP);
UPDATE t_drugallergy SET DNAME = if(INSTR(DNAMEP,'|'),SUBSTR(DNAMEP ,1, INSTR(DNAMEP,'|')-1),DNAMEP);
UPDATE t_drugallergy SET DNAME = if(SUBSTR(DNAME,-1)='(', SUBSTR(DNAME,1,LENGTH(DNAME)-1) ,DNAME);




UPDATE t_drugallergy SET DNAME_STD = REPLACE(DNAME_STD,'#',' ') , DNAME =REPLACE(DNAME,'#',' ');

CREATE TABLE IF NOT EXISTS ws_person_drugallergy
(
provcode VARCHAR(2) NOT NULL,
cid VARCHAR(13) NOT NULL,
flag_sent VARCHAR(1) NOT NULL DEFAULT '0',
hospcode VARCHAR(5) DEFAULT NULL,
daterecode DATE,
didcode VARCHAR(24) NOT NULL DEFAULT ' ',
didname varchar(255) NOT NULL DEFAULT ' ',
PRIMARY KEY (provcode,cid,didcode)
) ENGINE MyISAM DEFAULT CHARACTER SET=utf8 ;

CREATE TABLE IF NOT EXISTS ws_delete(
  provcode varchar(2) not null,
  cid varchar(13) not null,
  flag_sent varchar(1) DEFAULT '0',
  ws_table varchar(150) not null,
PRIMARY KEY (provcode,cid,ws_table),
KEY (provcode),
KEY (cid),
KEY (ws_table)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

DELETE FROM ws_delete WHERE flag_sent='2';

#ลบกรณีลบ;
DROP TEMPORARY TABLE IF EXISTS tmz_ws_cid_del;
CREATE TEMPORARY TABLE  IF NOT EXISTS tmz_ws_cid_del (PRIMARY KEY (CID)) 
ENGINE=MyISAM  AS 
(
SELECT DISTINCT
m.cid
FROM ws_person_drugallergy m LEFT JOIN t_drugallergy d ON m.cid=d.cid 
WHERE  d.cid is NULL
);

INSERT IGNORE INTO  ws_delete (SELECT @prov_c,cid,'0','ws_person_drugallergy' FROM  tmz_ws_cid_del);

DELETE FROM ws_person_drugallergy  WHERE cid in(SELECT cid FROM tmz_ws_cid_del ) ;

INSERT IGNORE INTO ws_person_drugallergy 
(
SELECT
@prov_c,cid,'0',hospcode,DATERECORD,DRUGALLERGY,DNAME
FROM
	t_drugallergy 
);
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.4892521;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:227;a:5:{i:0;s:2708:"CREATE PROCEDURE ws_person_drugallergy()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '33';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS t_drugallergy;
CREATE TABLE IF NOT EXISTS t_drugallergy (PRIMARY KEY (cid,drugallergy), KEY (cid)) ENGINE MyISAM AS
(SELECT DISTINCT
CID
,DRUGALLERGY
,c.Generic_Name DNAME_STD
/*,IF(INSTR(c.Generic_Name,'MG') ,SUBSTR(c.Generic_Name,1,INSTR(c.Generic_Name,'MG')+1),c.Generic_Name   ) DNAMEP*/
,SPACE(100) DNAMEP
,SPACE(100) DNAME
,DATERECORD
,d.HOSPCODE
FROM
drugallergy d INNER JOIN person p ON d.HOSPCODE=p.HOSPCODE AND d.PID=p.PID
INNER JOIN cdrug_std c ON d.DRUGALLERGY=c.didstd
WHERE mod11(cid)=1  
GROUP BY p.cid,c.didstd
);


UPDATE t_drugallergy SET DNAME_STD = REPLACE(DNAME_STD,' ','#');
UPDATE t_drugallergy SET DNAMEP = IF(INSTR(DNAME_STD,'MG') ,SUBSTR(DNAME_STD,1,INSTR(DNAME_STD,'MG')+1),DNAME_STD );
UPDATE t_drugallergy SET dnamep = repl_digits_pipe(DNAMEP);
UPDATE t_drugallergy SET DNAME = if(INSTR(DNAMEP,'|'),SUBSTR(DNAMEP ,1, INSTR(DNAMEP,'|')-1),DNAMEP);
UPDATE t_drugallergy SET DNAME = if(SUBSTR(DNAME,-1)='(', SUBSTR(DNAME,1,LENGTH(DNAME)-1) ,DNAME);




UPDATE t_drugallergy SET DNAME_STD = REPLACE(DNAME_STD,'#',' ') , DNAME =REPLACE(DNAME,'#',' ');

CREATE TABLE IF NOT EXISTS ws_person_drugallergy
(
provcode VARCHAR(2) NOT NULL,
cid VARCHAR(13) NOT NULL,
flag_sent VARCHAR(1) NOT NULL DEFAULT '0',
hospcode VARCHAR(5) DEFAULT NULL,
daterecode DATE,
didcode VARCHAR(24) NOT NULL DEFAULT ' ',
didname varchar(255) NOT NULL DEFAULT ' ',
PRIMARY KEY (provcode,cid,didcode)
) ENGINE MyISAM DEFAULT CHARACTER SET=utf8 ;

CREATE TABLE IF NOT EXISTS ws_delete(
  provcode varchar(2) not null,
  cid varchar(13) not null,
  flag_sent varchar(1) DEFAULT '0',
  ws_table varchar(150) not null,
PRIMARY KEY (provcode,cid,ws_table),
KEY (provcode),
KEY (cid),
KEY (ws_table)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

DELETE FROM ws_delete WHERE flag_sent='2';

#ลบกรณีลบ;
DROP TEMPORARY TABLE IF EXISTS tmz_ws_cid_del;
CREATE TEMPORARY TABLE  IF NOT EXISTS tmz_ws_cid_del (PRIMARY KEY (CID)) 
ENGINE=MyISAM  AS 
(
SELECT DISTINCT
m.cid
FROM ws_person_drugallergy m LEFT JOIN t_drugallergy d ON m.cid=d.cid 
WHERE  d.cid is NULL
);

INSERT IGNORE INTO  ws_delete (SELECT @prov_c,cid,'0','ws_person_drugallergy' FROM  tmz_ws_cid_del);

DELETE FROM ws_person_drugallergy  WHERE cid in(SELECT cid FROM tmz_ws_cid_del ) ;

INSERT IGNORE INTO ws_person_drugallergy 
(
SELECT
@prov_c,cid,'0',hospcode,DATERECORD,DRUGALLERGY,DNAME
FROM
	t_drugallergy 
);
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.551652;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:229;a:5:{i:0;s:35:"DROP PROCEDURE IF EXISTS t_cmi_dead";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.551652;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:230;a:5:{i:0;s:35:"DROP PROCEDURE IF EXISTS t_cmi_dead";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.5984521;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:232;a:5:{i:0;s:1277:"CREATE PROCEDURE t_cmi_dead()
 BEGIN 
SET @prov_c :='58';
SET @id:= '34';
SET @year_start:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@year_start-1,'1001');
SET @end_d:=concat(@year_start,'0930');

DROP TABLE IF EXISTS t_cmi_dead;
CREATE TABLE IF NOT EXISTS t_cmi_dead (INDEX(monthly,hospcode,drg)) 
		ENGINE=MyISAM  AS 
		(select @year_start as byear,DATE_FORMAT(t.DATETIME_DISCH,'%Y%m') as monthly,t.HOSPCODE as hospcode, 
							a.chwcode, a.region, a.splevel, substr(t.drg,1,2) as mdc,
							t.DRG as drg, count(t.AN) as cases, sum(t.ADJRW) as sum_adjrw,
							sum(t.price) as price,sum(if(t.price=0,1,0)) as price0,sum(t.day) as los,
							sum(if(t.ADJRW=0,1,0)) as adjrw0, t.RW as rw,
							sum(if(t.REFERINHOSP != '' ,1,0)) as referin,
							sum(if(t.REFERINHOSP !='' and t.adjrw=0,1,0)) as referin_adjrw0,
							sum(if(t.REFERINHOSP !='',t.adjrw,0)) as referin_adjrw
						from tmp_admission t join (select t.hcode, t.hname, t.chwcode, t.chwname, t.region, t.splevel
										from ccmihosp t where t.byear = @year_start+543) a on t.HOSPCODE = a.hcode
						where DATE_FORMAT(t.DATETIME_DISCH,'%Y%m%d') BETWEEN @start_d AND @end_d
							AND t.DISCHSTATUS in (8,9)
						group by t.HOSPCODE,monthly, t.drg
) ;
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.5984521;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:233;a:5:{i:0;s:1277:"CREATE PROCEDURE t_cmi_dead()
 BEGIN 
SET @prov_c :='58';
SET @id:= '34';
SET @year_start:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@year_start-1,'1001');
SET @end_d:=concat(@year_start,'0930');

DROP TABLE IF EXISTS t_cmi_dead;
CREATE TABLE IF NOT EXISTS t_cmi_dead (INDEX(monthly,hospcode,drg)) 
		ENGINE=MyISAM  AS 
		(select @year_start as byear,DATE_FORMAT(t.DATETIME_DISCH,'%Y%m') as monthly,t.HOSPCODE as hospcode, 
							a.chwcode, a.region, a.splevel, substr(t.drg,1,2) as mdc,
							t.DRG as drg, count(t.AN) as cases, sum(t.ADJRW) as sum_adjrw,
							sum(t.price) as price,sum(if(t.price=0,1,0)) as price0,sum(t.day) as los,
							sum(if(t.ADJRW=0,1,0)) as adjrw0, t.RW as rw,
							sum(if(t.REFERINHOSP != '' ,1,0)) as referin,
							sum(if(t.REFERINHOSP !='' and t.adjrw=0,1,0)) as referin_adjrw0,
							sum(if(t.REFERINHOSP !='',t.adjrw,0)) as referin_adjrw
						from tmp_admission t join (select t.hcode, t.hname, t.chwcode, t.chwname, t.region, t.splevel
										from ccmihosp t where t.byear = @year_start+543) a on t.HOSPCODE = a.hcode
						where DATE_FORMAT(t.DATETIME_DISCH,'%Y%m%d') BETWEEN @start_d AND @end_d
							AND t.DISCHSTATUS in (8,9)
						group by t.HOSPCODE,monthly, t.drg
) ;
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.660852;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:235;a:5:{i:0;s:40:"DROP PROCEDURE IF EXISTS t_procedure_ipd";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.660852;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:236;a:5:{i:0;s:40:"DROP PROCEDURE IF EXISTS t_procedure_ipd";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.7232521;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:238;a:5:{i:0;s:4196:"CREATE PROCEDURE t_procedure_ipd()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '35';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

#รายงานเพื่อใช้ใน Service Plan สาขาการส่งต่อ ใช้ในการพัฒนา Node ให้มีศักยภาพในการรักษาโรคที่ไม่ยากจนเกินไป
DROP TABLES IF EXISTS t_procedure_ipd;
CREATE TABLE IF NOT EXISTS t_procedure_ipd (
	`prov` varchar(2) NOT null,
	`hospcode` varchar(5) NOT null,
	`hosp_level` varchar(2) NOT null,
  `cid` varchar(15) not null,
	`an` varchar(16) NOT null,
  `pid` varchar(15) NOT null,
	`seq` varchar(16) NOT null,
	`sex` TINYINT,
	`age_y` int,
	`age_m` int,
	`typearea` TINYINT,
	`datetime_admit` datetime NOT NULL,
	`datetime_disc` datetime NOT NULL,
	`actlos` INT,
	`procedcode` varchar(8) default null,
  `dischstatus` char(1),
  `dischtype` char(1),
	`typein` char(1),
	`timestart` datetime,
	`timefinish` datetime,
	`timediff` time,
	`timeused` int(6),
	`provider` varchar(16),
	`drg` varchar(5),
	`rw` float,
	`adjrw` float,
	`price` float,
	`referin` VARCHAR(5),
	`ipd_referin` VARCHAR(5),
	`ipd_referout` VARCHAR(5),
	`opd_referin` VARCHAR(5),
	`referin_level` VARCHAR(2),
	`lastupdate` TIMESTAMP,
  KEY `hospcode` (`hospcode`),
  KEY `an` (`an`),
  KEY `pid` (`pid`),
	KEY `cid` (`cid`),
  KEY `seq` (`seq`),
  KEY `referin` (`referin`),
  KEY `datetime_admit` (`datetime_admit`),
	KEY `procedcode` (`procedcode`),
	KEY `timestart` (`timestart`),
  KEY `HOSPCODE_PID` (`hospcode`,`pid`,`seq`)
)ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT INTO t_procedure_ipd 
SELECT @prov_c as prov,op.HOSPCODE, '' as hosplevel, p.CID, op.AN, ipd.PID, ipd.SEQ, p.sex, 
			age(ipd.DATETIME_ADMIT,p.BIRTH,'y') as age_y,
			age(ipd.DATETIME_ADMIT,p.BIRTH,'m') as age_m,
			p.TYPEAREA,
			ipd.DATETIME_ADMIT, ipd.DATETIME_DISCH, ipd.ACTLOS , op.procedcode, 
      ipd.DISCHSTATUS , ipd.DISCHTYPE , ipd.TYPEIN,
      op.TIMESTART, op.TIMEFINISH, TIMEDIFF(op.TIMESTART,ipd.DATETIME_ADMIT) as timediff,
			IF(TIME_TO_SEC(TIMEDIFF(op.TIMESTART,ipd.DATETIME_ADMIT))>0,TIME_TO_SEC(TIMEDIFF(op.TIMESTART,ipd.DATETIME_ADMIT))/60,0) as timeued,
			op.PROVIDER, ipd.DRG, ipd.RW, ipd.ADJRW, ipd.price,
      ipd.REFERINHOSP as ipdreferin, ipd.REFERINHOSP as ipdreferin, ipd.REFEROUTHOSP as ipdreferout,
			'' as opdreferin, '' as referin_level, CURRENT_TIMESTAMP() as lastupdate
	FROM procedure_ipd op
		LEFT JOIN admission ipd on op.HOSPCODE=ipd.HOSPCODE and op.AN=ipd.AN
		LEFT JOIN person p on op.HOSPCODE=p.HOSPCODE and op.PID=p.PID
	WHERE DATE_FORMAT(ipd.DATETIME_DISCH,'%Y%m%d') BETWEEN @start_d and @end_d
 ;

#ค้นสถานพยาบาลที่ส่ง refer มา ในกรณีที่ HIS ไม่ได้บันทึกไว้ใน admission แต่มีใน service
UPDATE t_procedure_ipd op,tmp_service opd SET op.opd_referin=opd.referinhosp
	WHERE op.hospcode = opd.hospcode AND op.seq = opd.seq and substr(op.datetime_admit,1,10)=opd.date_serv and op.pid=opd.pid;

UPDATE t_procedure_ipd op SET op.referin = op.opd_referin
	where op.referin='' and op.opd_referin!='' ;

#กรณีวัน admit=วันจำหน่าย ให้แทนค่าเป็น 1
UPDATE t_procedure_ipd op SET op.actlos = 1 
	where op.actlos=0 and op.datetime_admit=op.datetime_disc ;

#กรณีวัน admit < วันจำหน่าย ให้คำนวณหา DATEDIFF
UPDATE t_procedure_ipd op SET op.actlos = DATEDIFF(op.datetime_disc,op.datetime_admit)
	where op.actlos=0 ;

#ค้นหาประเภทสถานพยาบาล A-F
UPDATE t_procedure_ipd op,ccmihosp h SET op.hosp_level=h.splevel WHERE op.hospcode=h.hcode ;
UPDATE t_procedure_ipd op,ccmihosp h SET op.referin_level=h.splevel WHERE op.referin!='' and op.referin=h.hcode ;
UPDATE t_procedure_ipd op SET op.referin_level='NA' WHERE op.referin!='' and (op.referin_level='' or ISNULL(op.referin_level)) ;

 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.7232521;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:239;a:5:{i:0;s:4196:"CREATE PROCEDURE t_procedure_ipd()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '35';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

#รายงานเพื่อใช้ใน Service Plan สาขาการส่งต่อ ใช้ในการพัฒนา Node ให้มีศักยภาพในการรักษาโรคที่ไม่ยากจนเกินไป
DROP TABLES IF EXISTS t_procedure_ipd;
CREATE TABLE IF NOT EXISTS t_procedure_ipd (
	`prov` varchar(2) NOT null,
	`hospcode` varchar(5) NOT null,
	`hosp_level` varchar(2) NOT null,
  `cid` varchar(15) not null,
	`an` varchar(16) NOT null,
  `pid` varchar(15) NOT null,
	`seq` varchar(16) NOT null,
	`sex` TINYINT,
	`age_y` int,
	`age_m` int,
	`typearea` TINYINT,
	`datetime_admit` datetime NOT NULL,
	`datetime_disc` datetime NOT NULL,
	`actlos` INT,
	`procedcode` varchar(8) default null,
  `dischstatus` char(1),
  `dischtype` char(1),
	`typein` char(1),
	`timestart` datetime,
	`timefinish` datetime,
	`timediff` time,
	`timeused` int(6),
	`provider` varchar(16),
	`drg` varchar(5),
	`rw` float,
	`adjrw` float,
	`price` float,
	`referin` VARCHAR(5),
	`ipd_referin` VARCHAR(5),
	`ipd_referout` VARCHAR(5),
	`opd_referin` VARCHAR(5),
	`referin_level` VARCHAR(2),
	`lastupdate` TIMESTAMP,
  KEY `hospcode` (`hospcode`),
  KEY `an` (`an`),
  KEY `pid` (`pid`),
	KEY `cid` (`cid`),
  KEY `seq` (`seq`),
  KEY `referin` (`referin`),
  KEY `datetime_admit` (`datetime_admit`),
	KEY `procedcode` (`procedcode`),
	KEY `timestart` (`timestart`),
  KEY `HOSPCODE_PID` (`hospcode`,`pid`,`seq`)
)ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT INTO t_procedure_ipd 
SELECT @prov_c as prov,op.HOSPCODE, '' as hosplevel, p.CID, op.AN, ipd.PID, ipd.SEQ, p.sex, 
			age(ipd.DATETIME_ADMIT,p.BIRTH,'y') as age_y,
			age(ipd.DATETIME_ADMIT,p.BIRTH,'m') as age_m,
			p.TYPEAREA,
			ipd.DATETIME_ADMIT, ipd.DATETIME_DISCH, ipd.ACTLOS , op.procedcode, 
      ipd.DISCHSTATUS , ipd.DISCHTYPE , ipd.TYPEIN,
      op.TIMESTART, op.TIMEFINISH, TIMEDIFF(op.TIMESTART,ipd.DATETIME_ADMIT) as timediff,
			IF(TIME_TO_SEC(TIMEDIFF(op.TIMESTART,ipd.DATETIME_ADMIT))>0,TIME_TO_SEC(TIMEDIFF(op.TIMESTART,ipd.DATETIME_ADMIT))/60,0) as timeued,
			op.PROVIDER, ipd.DRG, ipd.RW, ipd.ADJRW, ipd.price,
      ipd.REFERINHOSP as ipdreferin, ipd.REFERINHOSP as ipdreferin, ipd.REFEROUTHOSP as ipdreferout,
			'' as opdreferin, '' as referin_level, CURRENT_TIMESTAMP() as lastupdate
	FROM procedure_ipd op
		LEFT JOIN admission ipd on op.HOSPCODE=ipd.HOSPCODE and op.AN=ipd.AN
		LEFT JOIN person p on op.HOSPCODE=p.HOSPCODE and op.PID=p.PID
	WHERE DATE_FORMAT(ipd.DATETIME_DISCH,'%Y%m%d') BETWEEN @start_d and @end_d
 ;

#ค้นสถานพยาบาลที่ส่ง refer มา ในกรณีที่ HIS ไม่ได้บันทึกไว้ใน admission แต่มีใน service
UPDATE t_procedure_ipd op,tmp_service opd SET op.opd_referin=opd.referinhosp
	WHERE op.hospcode = opd.hospcode AND op.seq = opd.seq and substr(op.datetime_admit,1,10)=opd.date_serv and op.pid=opd.pid;

UPDATE t_procedure_ipd op SET op.referin = op.opd_referin
	where op.referin='' and op.opd_referin!='' ;

#กรณีวัน admit=วันจำหน่าย ให้แทนค่าเป็น 1
UPDATE t_procedure_ipd op SET op.actlos = 1 
	where op.actlos=0 and op.datetime_admit=op.datetime_disc ;

#กรณีวัน admit < วันจำหน่าย ให้คำนวณหา DATEDIFF
UPDATE t_procedure_ipd op SET op.actlos = DATEDIFF(op.datetime_disc,op.datetime_admit)
	where op.actlos=0 ;

#ค้นหาประเภทสถานพยาบาล A-F
UPDATE t_procedure_ipd op,ccmihosp h SET op.hosp_level=h.splevel WHERE op.hospcode=h.hcode ;
UPDATE t_procedure_ipd op,ccmihosp h SET op.referin_level=h.splevel WHERE op.referin!='' and op.referin=h.hcode ;
UPDATE t_procedure_ipd op SET op.referin_level='NA' WHERE op.referin!='' and (op.referin_level='' or ISNULL(op.referin_level)) ;

 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.816853;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:241;a:5:{i:0;s:38:"DROP PROCEDURE IF EXISTS t_ckd_ill_all";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.816853;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:242;a:5:{i:0;s:38:"DROP PROCEDURE IF EXISTS t_ckd_ill_all";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.8948531;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:244;a:5:{i:0;s:3874:"CREATE PROCEDURE t_ckd_ill_all()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '36';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

CREATE TABLE IF NOT EXISTS t_ckd_ill_all (
  cid varchar(13) NOT NULL,
  group_diag text,
  group_date text,
  group_hos_dx text,
  min_date_dx date DEFAULT NULL,
  hospcode varchar(5) NOT NULL DEFAULT '',
  PRIMARY KEY (cid)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO  t_ckd_ill_all (
			SELECT cid 
						,GROUP_CONCAT(trim(diagcode) ORDER BY SUBSTR(diagcode,1,1),date_dx) group_diag
						,GROUP_CONCAT(date_dx ORDER BY SUBSTR(diagcode,1,1),date_dx) group_date
							,GROUP_CONCAT(IF(LENGTH(trim(hosp_dx))=0 OR ISNULL(hosp_dx),input_hosp,hosp_dx) ORDER BY SUBSTR(diagcode,1,1),date_dx)
						,min(date_dx) min_date_dx, space(5) hospcode
  FROM t_chronic 
   WHERE UPPER(diagcode) in('E102', 'E112', 'E122', 'E132', 'E142','I151') 
					OR UPPER(substr(diagcode,1,3)) in('I12','I13','N18')  
	GROUP BY cid
	ORDER BY date_dx  );

UPDATE t_ckd_ill_all  c,t_person_cid p SET c.hospcode=p.check_hosp WHERE c.cid=p.cid;

DROP TABLE IF  EXISTS t_ckd_screen;
CREATE TABLE IF NOT EXISTS t_ckd_screen (
lab12_date date default null,
lab12_hosp VARCHAR(5) DEFAULT NULL,
lab12_result VARCHAR(10) DEFAULT NULL,

lab14_date date default null,
lab14_hosp VARCHAR(5) DEFAULT NULL,
lab14_result VARCHAR(10) DEFAULT NULL,
lab11_date date default null,
lab11_hosp VARCHAR(5) DEFAULT NULL,
lab11_result VARCHAR(10) DEFAULT NULL,
lab15_date date default null,
lab15_hosp VARCHAR(5) DEFAULT NULL,
lab15_result VARCHAR(10) DEFAULT NULL,
lab15_ok_result VARCHAR(10) DEFAULT NULL,
minlab_date date default null,
PRIMARY KEY(cid) ) ENGINE MyIsam as(
SELECT
t.hospcode,t.pid,t.cid,t.vhid,t.typearea,t.birth,t.age_y,t.sex,t.nation,t.mix_dx,t.date_dx,t.hosp_dx
,null as lab12_date 
,null as lab12_hosp
,null as  lab12_result
,null as lab14_date
,null as lab14_hosp
,null as lab14_result
,null as lab11_date
,null as lab11_hosp
,null as lab11_result
,null as lab15_date
,null as lab15_hosp
,null as lab15_result
,null as lab15_ok_result
,null as minlab_date
FROM
t_dmht  t 
	LEFT JOIN (SELECT cid FROM t_ckd_ill_all WHERE min_date_dx < @start_d ) c ON t.cid=c.cid 
WHERE
t.nation in('099') AND t.typearea in(1,3)
AND (c.cid is null ));

UPDATE t_ckd_screen s ,tmp_labfu l SET s.lab12_date=l.DATE_SERV,s.lab12_hosp=l.HOSPCODE ,s.lab12_result=l.LABRESULT
WHERE s.cid=l.cid AND l.LABTEST=12 AND l.DATE_SERV  BETWEEN @start_d AND @end_d;

UPDATE t_ckd_screen s ,tmp_labfu l SET s.lab14_date=l.DATE_SERV,s.lab14_hosp=l.HOSPCODE ,s.lab14_result=l.LABRESULT
WHERE s.cid=l.cid AND l.LABTEST=14 AND l.DATE_SERV  BETWEEN @start_d AND @end_d;

UPDATE t_ckd_screen s ,tmp_labfu l SET s.lab11_date=l.DATE_SERV,s.lab11_hosp=l.HOSPCODE ,s.lab11_result=l.LABRESULT
WHERE s.cid=l.cid AND l.LABTEST=11 AND l.DATE_SERV  BETWEEN @start_d AND @end_d;

UPDATE t_ckd_screen s ,tmp_labfu l SET s.lab15_date=l.DATE_SERV,s.lab15_hosp=l.HOSPCODE ,s.lab15_result=l.LABRESULT
WHERE s.cid=l.cid AND l.LABTEST=15 AND l.DATE_SERV  BETWEEN @start_d AND @end_d;

UPDATE t_ckd_screen SET lab15_ok_result =lab15_result;

UPDATE t_ckd_screen SET lab15_ok_result =egfr_fnc(lab11_result,age_y,sex)
WHERE lab11_result IS NOT NULL AND lab11_result>0 ;

UPDATE t_ckd_screen SET minlab_date =IF(lab12_date is NULL OR lab14_date is NULL 
			,COALESCE(lab12_date,lab14_date),LEAST(lab12_date,lab14_date));

UPDATE t_ckd_screen SET minlab_date =IF(lab15_date is NULL OR minlab_date is NULL 
			,COALESCE(lab15_date,minlab_date),LEAST(lab15_date,minlab_date));

UPDATE t_ckd_screen SET minlab_date =IF(lab11_date is NULL OR minlab_date is NULL 
			,COALESCE(lab11_date,minlab_date),LEAST(lab11_date,minlab_date));

 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.8948531;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:245;a:5:{i:0;s:3874:"CREATE PROCEDURE t_ckd_ill_all()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '36';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

CREATE TABLE IF NOT EXISTS t_ckd_ill_all (
  cid varchar(13) NOT NULL,
  group_diag text,
  group_date text,
  group_hos_dx text,
  min_date_dx date DEFAULT NULL,
  hospcode varchar(5) NOT NULL DEFAULT '',
  PRIMARY KEY (cid)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO  t_ckd_ill_all (
			SELECT cid 
						,GROUP_CONCAT(trim(diagcode) ORDER BY SUBSTR(diagcode,1,1),date_dx) group_diag
						,GROUP_CONCAT(date_dx ORDER BY SUBSTR(diagcode,1,1),date_dx) group_date
							,GROUP_CONCAT(IF(LENGTH(trim(hosp_dx))=0 OR ISNULL(hosp_dx),input_hosp,hosp_dx) ORDER BY SUBSTR(diagcode,1,1),date_dx)
						,min(date_dx) min_date_dx, space(5) hospcode
  FROM t_chronic 
   WHERE UPPER(diagcode) in('E102', 'E112', 'E122', 'E132', 'E142','I151') 
					OR UPPER(substr(diagcode,1,3)) in('I12','I13','N18')  
	GROUP BY cid
	ORDER BY date_dx  );

UPDATE t_ckd_ill_all  c,t_person_cid p SET c.hospcode=p.check_hosp WHERE c.cid=p.cid;

DROP TABLE IF  EXISTS t_ckd_screen;
CREATE TABLE IF NOT EXISTS t_ckd_screen (
lab12_date date default null,
lab12_hosp VARCHAR(5) DEFAULT NULL,
lab12_result VARCHAR(10) DEFAULT NULL,

lab14_date date default null,
lab14_hosp VARCHAR(5) DEFAULT NULL,
lab14_result VARCHAR(10) DEFAULT NULL,
lab11_date date default null,
lab11_hosp VARCHAR(5) DEFAULT NULL,
lab11_result VARCHAR(10) DEFAULT NULL,
lab15_date date default null,
lab15_hosp VARCHAR(5) DEFAULT NULL,
lab15_result VARCHAR(10) DEFAULT NULL,
lab15_ok_result VARCHAR(10) DEFAULT NULL,
minlab_date date default null,
PRIMARY KEY(cid) ) ENGINE MyIsam as(
SELECT
t.hospcode,t.pid,t.cid,t.vhid,t.typearea,t.birth,t.age_y,t.sex,t.nation,t.mix_dx,t.date_dx,t.hosp_dx
,null as lab12_date 
,null as lab12_hosp
,null as  lab12_result
,null as lab14_date
,null as lab14_hosp
,null as lab14_result
,null as lab11_date
,null as lab11_hosp
,null as lab11_result
,null as lab15_date
,null as lab15_hosp
,null as lab15_result
,null as lab15_ok_result
,null as minlab_date
FROM
t_dmht  t 
	LEFT JOIN (SELECT cid FROM t_ckd_ill_all WHERE min_date_dx < @start_d ) c ON t.cid=c.cid 
WHERE
t.nation in('099') AND t.typearea in(1,3)
AND (c.cid is null ));

UPDATE t_ckd_screen s ,tmp_labfu l SET s.lab12_date=l.DATE_SERV,s.lab12_hosp=l.HOSPCODE ,s.lab12_result=l.LABRESULT
WHERE s.cid=l.cid AND l.LABTEST=12 AND l.DATE_SERV  BETWEEN @start_d AND @end_d;

UPDATE t_ckd_screen s ,tmp_labfu l SET s.lab14_date=l.DATE_SERV,s.lab14_hosp=l.HOSPCODE ,s.lab14_result=l.LABRESULT
WHERE s.cid=l.cid AND l.LABTEST=14 AND l.DATE_SERV  BETWEEN @start_d AND @end_d;

UPDATE t_ckd_screen s ,tmp_labfu l SET s.lab11_date=l.DATE_SERV,s.lab11_hosp=l.HOSPCODE ,s.lab11_result=l.LABRESULT
WHERE s.cid=l.cid AND l.LABTEST=11 AND l.DATE_SERV  BETWEEN @start_d AND @end_d;

UPDATE t_ckd_screen s ,tmp_labfu l SET s.lab15_date=l.DATE_SERV,s.lab15_hosp=l.HOSPCODE ,s.lab15_result=l.LABRESULT
WHERE s.cid=l.cid AND l.LABTEST=15 AND l.DATE_SERV  BETWEEN @start_d AND @end_d;

UPDATE t_ckd_screen SET lab15_ok_result =lab15_result;

UPDATE t_ckd_screen SET lab15_ok_result =egfr_fnc(lab11_result,age_y,sex)
WHERE lab11_result IS NOT NULL AND lab11_result>0 ;

UPDATE t_ckd_screen SET minlab_date =IF(lab12_date is NULL OR lab14_date is NULL 
			,COALESCE(lab12_date,lab14_date),LEAST(lab12_date,lab14_date));

UPDATE t_ckd_screen SET minlab_date =IF(lab15_date is NULL OR minlab_date is NULL 
			,COALESCE(lab15_date,minlab_date),LEAST(lab15_date,minlab_date));

UPDATE t_ckd_screen SET minlab_date =IF(lab11_date is NULL OR minlab_date is NULL 
			,COALESCE(lab11_date,minlab_date),LEAST(lab11_date,minlab_date));

 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.941653;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:247;a:5:{i:0;s:32:"DROP PROCEDURE IF EXISTS t_influ";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.941653;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:248;a:5:{i:0;s:32:"DROP PROCEDURE IF EXISTS t_influ";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.0040531;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:250;a:5:{i:0;s:2251:"CREATE PROCEDURE t_influ()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '37';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF  EXISTS t_influ;
CREATE TABLE IF NOT EXISTS t_influ(key (cid) ) ENGINE MyISAM as
(SELECT DISTINCT
p.cid,p.sex,p.BIRTH,e.DATE_SERV,e.VACCINETYPE,e.VACCINEPLACE
,'0' type_1,'0' type_2,'0' type_3,'0' type_4,'0' type_5,'0' type_6,'0' type_7,'0' type_8,'0' type_9
FROM
epi e  INNER JOIN person p ON p.HOSPCODE=e.HOSPCODE AND p.PID=e.pid
WHERE 
e.DATE_SERV BETWEEN @start_d AND @end_d
AND VACCINETYPE in('815')
);
UPDATE t_influ i INNER JOIN provider p    SET type_1 =1 WHERE  i.cid=p.CID ;
UPDATE t_influ i INNER JOIN tmp_anc a    SET type_2 =1 WHERE  i.cid=a.cid AND  TIMESTAMPDIFF(week,DATE_ADD(a.DATE_SERV,INTERVAL -(a.GA) WEEK),i.DATE_SERV)>4;
UPDATE t_influ   SET type_3 =1 WHERE TIMESTAMPDIFF(MONTH,BIRTH,DATE_SERV)  BETWEEN 6 and 24;
UPDATE t_influ   SET type_4 =1 WHERE TIMESTAMPDIFF(YEAR,BIRTH,DATE_SERV)  > 65;
UPDATE t_influ i INNER JOIN t_chronic c   SET type_5 =1  WHERE i.cid=c.cid 
	AND (substr(c.diagcode,1,3) in('J44','J45','J46','I20','I21','I22','I23','I24','I25','I60','I61','I62','I63','I64','I65','I66','I67','N17','N18','N19','E10','E11','E12','E13','E14')
or substr(c.diagcode,1,1) in('C')) AND c.date_dx <= i.DATE_SERV;
UPDATE t_influ i INNER JOIN tmp_diag_opd d   SET type_6 =1 WHERE  i.cid=d.CID AND substr(d.diagcode,1,3) in('Q00','Q01','Q02','Q03','Q04','F84') AND d.DATE_SERV <= i.DATE_SERV;
UPDATE t_influ i INNER JOIN t_chronic c   SET type_7 =1  WHERE i.cid=c.cid AND substr(c.diagcode,1,3) in('B20','B21','B22','B23','B24') AND c.date_dx <= i.DATE_SERV;
UPDATE t_influ i INNER JOIN tmp_diag_opd d   SET type_7 =1 WHERE  i.cid=d.CID AND substr(d.diagcode,1,3) in('D56') AND d.DATE_SERV <= i.DATE_SERV;
UPDATE t_influ i INNER JOIN tmp_diag_opd d   SET type_8 =1 WHERE  i.cid=d.CID AND substr(d.diagcode,1,3) in('E66') AND d.DATE_SERV <= i.DATE_SERV;
UPDATE t_influ SET type_4=0 WHERE type_5 =1 OR type_7 =1 OR type_8 =1;
UPDATE t_influ SET type_9=1 WHERE type_1 =0 AND type_2 =0 AND type_3 =0 AND type_4 =0 AND type_5 =0 AND type_6 =0 AND type_7 =0 AND type_8 =0;

 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.0040531;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:251;a:5:{i:0;s:2251:"CREATE PROCEDURE t_influ()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '37';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF  EXISTS t_influ;
CREATE TABLE IF NOT EXISTS t_influ(key (cid) ) ENGINE MyISAM as
(SELECT DISTINCT
p.cid,p.sex,p.BIRTH,e.DATE_SERV,e.VACCINETYPE,e.VACCINEPLACE
,'0' type_1,'0' type_2,'0' type_3,'0' type_4,'0' type_5,'0' type_6,'0' type_7,'0' type_8,'0' type_9
FROM
epi e  INNER JOIN person p ON p.HOSPCODE=e.HOSPCODE AND p.PID=e.pid
WHERE 
e.DATE_SERV BETWEEN @start_d AND @end_d
AND VACCINETYPE in('815')
);
UPDATE t_influ i INNER JOIN provider p    SET type_1 =1 WHERE  i.cid=p.CID ;
UPDATE t_influ i INNER JOIN tmp_anc a    SET type_2 =1 WHERE  i.cid=a.cid AND  TIMESTAMPDIFF(week,DATE_ADD(a.DATE_SERV,INTERVAL -(a.GA) WEEK),i.DATE_SERV)>4;
UPDATE t_influ   SET type_3 =1 WHERE TIMESTAMPDIFF(MONTH,BIRTH,DATE_SERV)  BETWEEN 6 and 24;
UPDATE t_influ   SET type_4 =1 WHERE TIMESTAMPDIFF(YEAR,BIRTH,DATE_SERV)  > 65;
UPDATE t_influ i INNER JOIN t_chronic c   SET type_5 =1  WHERE i.cid=c.cid 
	AND (substr(c.diagcode,1,3) in('J44','J45','J46','I20','I21','I22','I23','I24','I25','I60','I61','I62','I63','I64','I65','I66','I67','N17','N18','N19','E10','E11','E12','E13','E14')
or substr(c.diagcode,1,1) in('C')) AND c.date_dx <= i.DATE_SERV;
UPDATE t_influ i INNER JOIN tmp_diag_opd d   SET type_6 =1 WHERE  i.cid=d.CID AND substr(d.diagcode,1,3) in('Q00','Q01','Q02','Q03','Q04','F84') AND d.DATE_SERV <= i.DATE_SERV;
UPDATE t_influ i INNER JOIN t_chronic c   SET type_7 =1  WHERE i.cid=c.cid AND substr(c.diagcode,1,3) in('B20','B21','B22','B23','B24') AND c.date_dx <= i.DATE_SERV;
UPDATE t_influ i INNER JOIN tmp_diag_opd d   SET type_7 =1 WHERE  i.cid=d.CID AND substr(d.diagcode,1,3) in('D56') AND d.DATE_SERV <= i.DATE_SERV;
UPDATE t_influ i INNER JOIN tmp_diag_opd d   SET type_8 =1 WHERE  i.cid=d.CID AND substr(d.diagcode,1,3) in('E66') AND d.DATE_SERV <= i.DATE_SERV;
UPDATE t_influ SET type_4=0 WHERE type_5 =1 OR type_7 =1 OR type_8 =1;
UPDATE t_influ SET type_9=1 WHERE type_1 =0 AND type_2 =0 AND type_3 =0 AND type_4 =0 AND type_5 =0 AND type_6 =0 AND type_7 =0 AND type_8 =0;

 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.050853;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:253;a:5:{i:0;s:38:"DROP PROCEDURE IF EXISTS t_ckd_service";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.050853;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:254;a:5:{i:0;s:38:"DROP PROCEDURE IF EXISTS t_ckd_service";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.1132531;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:256;a:5:{i:0;s:6112:"CREATE PROCEDURE t_ckd_service()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '38';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF  EXISTS t_ckd_service;
CREATE TABLE IF NOT EXISTS t_ckd_service (
sex varchar(1),
age varchar(3),
nation varchar(3),
sbp int(3),
dbp int(3),
egfr varchar(20),
creatinine varchar(20),
egfr_ok varchar(20),
hb varchar(20),
hba1c varchar(20),
serum_k varchar(20),
serum_hco3 varchar(20),
urine_protein int(1),
upcr varchar(20),
serum_po4 varchar(20),
serum_ipth varchar(20),
acei_arb int(1),
statin int(1),
KEY(hospcode),KEY(PID),KEY(DATE_SERV)
) ENGINE MyISAM as
(SELECT
HOSPCODE,PID,SEQ,DATE_SERV,DIAGCODE,cid
,0 as 'sex'
,'' as 'nation'
,0 as 'age'
,0 as 'sbp'
,0 as 'dbp'
,0 as 'egfr'
,0 as 'creatinine'
,0 as 'egfr_ok'
,0 as 'hb'
,0 as 'hba1c'
,0 as 'serum_k'
,0 as 'serum_hco3'
,0 as 'urine_protein'
,0 as 'upcr'
,0 as 'serum_po4'
,0 as 'serum_ipth'
,0 as 'acei_arb'
,0 as 'statin'
FROM
tmp_diag_opd o LEFT JOIN chospital h ON o.HOSPCODE=h.hoscode
WHERE 
(substr(diagcode,1,4) IN ('N181','N182','N183','N184','N189','E102','E112','E122','E132','E142','I151') OR substr(diagcode,1,3) IN ('I12','I13'))
AND h.hostype in(5,6,7) AND o.DATE_SERV BETWEEN @start_d AND  @end_d
ORDER BY HOSPCODE ASC ,PID ASC, DATE_SERV DESC);


/*up sex for egfr*/
UPDATE  t_ckd_service c INNER JOIN  t_person_db p ON c.HOSPCODE=p.hospcode 	AND c.PID=p.pid
SET c.sex=p.SEX, c.age=TIMESTAMPDIFF(year,p.BIRTH,c.DATE_SERV),c.nation=p.NATION;
/*up bp from service*/
UPDATE t_ckd_service c INNER JOIN  tmp_service s ON c.HOSPCODE=s.hospcode 
							AND c.PID=s.pid AND c.seq=s.seq AND c.DATE_SERV=s.date_serv
SET c.sbp = s.sbp , c.dbp = s.dbp
WHERE s.sbp BETWEEN 10 AND 300 AND s.dbp BETWEEN 10 AND 300; 
/*up bp from chronicfu where bp <10*/
UPDATE t_ckd_service c INNER JOIN  tmp_chronicfu f ON c.HOSPCODE=f.hospcode 
							AND c.PID=f.pid AND c.seq=f.seq AND c.DATE_SERV=f.date_serv
SET c.sbp=f.sbp , c.dbp=f.dbp
WHERE c.sbp <10 AND f.sbp BETWEEN 10 AND 300 AND f.dbp BETWEEN 10 AND 300; 
/*up egfr*/
UPDATE t_ckd_service c INNER JOIN  tmp_labfu l ON c.HOSPCODE=l.hospcode 
							AND c.PID=l.pid AND c.seq=l.seq AND c.DATE_SERV=l.date_serv
SET c.egfr = l.LABRESULT
WHERE l.LABTEST=15;
/*up egfr_ok*/
UPDATE t_ckd_service c SET c.egfr_ok = c.egfr;
/*up creatinine*/
UPDATE t_ckd_service c INNER JOIN  tmp_labfu l ON c.HOSPCODE=l.hospcode 
							AND c.PID=l.pid AND c.seq=l.seq AND c.DATE_SERV=l.date_serv
SET c.creatinine = l.LABRESULT
WHERE l.LABTEST=11;
/*up hb*/
UPDATE t_ckd_service c INNER JOIN  tmp_labfu l ON c.HOSPCODE=l.hospcode 
							AND c.PID=l.pid AND c.seq=l.seq AND c.DATE_SERV=l.date_serv
SET c.hb = l.LABRESULT
WHERE l.LABTEST=16;
/*up hba1c*/
UPDATE t_ckd_service c INNER JOIN  tmp_labfu l ON c.HOSPCODE=l.hospcode 
							AND c.PID=l.pid AND c.seq=l.seq AND c.DATE_SERV=l.date_serv
SET c.hba1c = l.LABRESULT
WHERE l.LABTEST=5;
/*up serum_k*/
UPDATE t_ckd_service c INNER JOIN  tmp_labfu l ON c.HOSPCODE=l.hospcode 
							AND c.PID=l.pid AND c.seq=l.seq AND c.DATE_SERV=l.date_serv
SET c.serum_k = l.LABRESULT
WHERE l.LABTEST=18;
/*up serum_hco3*/
UPDATE t_ckd_service c INNER JOIN  tmp_labfu l ON c.HOSPCODE=l.hospcode 
							AND c.PID=l.pid AND c.seq=l.seq AND c.DATE_SERV=l.date_serv
SET c.serum_hco3 = l.LABRESULT
WHERE l.LABTEST=19;
/*up urine_protein*/
UPDATE t_ckd_service c INNER JOIN  tmp_labfu l ON c.HOSPCODE=l.hospcode 
							AND c.PID=l.pid AND c.seq=l.seq AND c.DATE_SERV=l.date_serv
SET c.urine_protein = 1
WHERE (l.LABTEST=12 AND l.LABRESULT >=0 ) OR (l.LABTEST=14 AND l.LABRESULT >=0 )  ;
/*up upcr*/
UPDATE t_ckd_service c INNER JOIN  tmp_labfu l ON c.HOSPCODE=l.hospcode 
							AND c.PID=l.pid AND c.seq=l.seq AND c.DATE_SERV=l.date_serv
SET c.upcr = l.LABRESULT
WHERE l.LABTEST=17;
/*up serum_po4*/
UPDATE t_ckd_service c INNER JOIN  tmp_labfu l ON c.HOSPCODE=l.hospcode 
							AND c.PID=l.pid AND c.seq=l.seq AND c.DATE_SERV=l.date_serv
SET c.serum_po4 = l.LABRESULT
WHERE l.LABTEST=20;
/*up serum_ipth*/
UPDATE t_ckd_service c INNER JOIN  tmp_labfu l ON c.HOSPCODE=l.hospcode 
							AND c.PID=l.pid AND c.seq=l.seq AND c.DATE_SERV=l.date_serv
SET c.serum_ipth = l.LABRESULT
WHERE l.LABTEST=21;
/*up egfr_ok*/
UPDATE t_ckd_service c SET c.egfr_ok = egfr_fnc(c.creatinine,c.age,c.sex) WHERE c.creatinine > 0 ;
/*up acei_arb*/
UPDATE t_ckd_service c INNER JOIN  tmp_drug_opd d ON c.HOSPCODE=d.hospcode 
							AND c.PID=d.pid AND c.seq=d.seq AND c.DATE_SERV=d.date_serv
SET c.acei_arb = 1
WHERE 
(     d.DIDSTD REGEXP '^[0-9]0061[7-9]'
      OR d.DIDSTD REGEXP '^[0-9]0062[1-3]'
      OR d.DIDSTD REGEXP '^[0-9]23171'
      OR d.DIDSTD REGEXP '^[0-9]24354'
      OR d.DIDSTD REGEXP '^[0-9]24432'
      OR d.DIDSTD REGEXP '^[0-9]24831'
      OR d.DIDSTD REGEXP '^[0-9]24843'
      OR d.DIDSTD REGEXP '^[0-9]24860'
      OR d.DIDSTD REGEXP '^[0-9]24889'
      OR d.DIDSTD REGEXP '^[0-9]24976'
      OR d.DIDSTD REGEXP '^[0-9]44080'
      OR d.DIDSTD REGEXP '^[0-9]030902500[39]'
      OR d.DIDSTD REGEXP '^[0-9]03090[1-2]0001'
      OR d.DIDSTD REGEXP '^[0-9]0309025005'
      OR d.DIDSTD REGEXP '^[0-9]0309040005'
      OR d.DIDSTD REGEXP '^[0-9]0309025007'
      OR d.DIDSTD REGEXP '^[0-9]0309040001'
      OR d.DIDSTD REGEXP '^[0-9]0309025008'
      OR d.DIDSTD REGEXP '^[0-9]030902500[1246]'
      OR d.DIDSTD REGEXP '^[0-9]0309040003'
      OR d.DIDSTD REGEXP '^[0-9]0309023001'
      );
/*up statin*/
UPDATE t_ckd_service c INNER JOIN  tmp_drug_opd d ON c.HOSPCODE=d.hospcode 
							AND c.PID=d.pid AND c.seq=d.seq AND c.DATE_SERV=d.date_serv
SET c.statin = 1
WHERE 
(    d.DIDSTD REGEXP '^[0-9]05573'
     OR d.DIDSTD REGEXP '^[0-9]12482'
     OR d.DIDSTD REGEXP '^[0-9]24868'
     OR d.DIDSTD REGEXP '^[0-9]24922'
     OR d.DIDSTD REGEXP '^[0-9]43383'
     OR d.DIDSTD REGEXP '^[0-9]45714'
     OR d.DIDSTD REGEXP '^[0-9]0204011001'
     OR d.DIDSTD REGEXP '^[0-9]0204011002'
      );
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.1132531;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:257;a:5:{i:0;s:6112:"CREATE PROCEDURE t_ckd_service()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '38';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF  EXISTS t_ckd_service;
CREATE TABLE IF NOT EXISTS t_ckd_service (
sex varchar(1),
age varchar(3),
nation varchar(3),
sbp int(3),
dbp int(3),
egfr varchar(20),
creatinine varchar(20),
egfr_ok varchar(20),
hb varchar(20),
hba1c varchar(20),
serum_k varchar(20),
serum_hco3 varchar(20),
urine_protein int(1),
upcr varchar(20),
serum_po4 varchar(20),
serum_ipth varchar(20),
acei_arb int(1),
statin int(1),
KEY(hospcode),KEY(PID),KEY(DATE_SERV)
) ENGINE MyISAM as
(SELECT
HOSPCODE,PID,SEQ,DATE_SERV,DIAGCODE,cid
,0 as 'sex'
,'' as 'nation'
,0 as 'age'
,0 as 'sbp'
,0 as 'dbp'
,0 as 'egfr'
,0 as 'creatinine'
,0 as 'egfr_ok'
,0 as 'hb'
,0 as 'hba1c'
,0 as 'serum_k'
,0 as 'serum_hco3'
,0 as 'urine_protein'
,0 as 'upcr'
,0 as 'serum_po4'
,0 as 'serum_ipth'
,0 as 'acei_arb'
,0 as 'statin'
FROM
tmp_diag_opd o LEFT JOIN chospital h ON o.HOSPCODE=h.hoscode
WHERE 
(substr(diagcode,1,4) IN ('N181','N182','N183','N184','N189','E102','E112','E122','E132','E142','I151') OR substr(diagcode,1,3) IN ('I12','I13'))
AND h.hostype in(5,6,7) AND o.DATE_SERV BETWEEN @start_d AND  @end_d
ORDER BY HOSPCODE ASC ,PID ASC, DATE_SERV DESC);


/*up sex for egfr*/
UPDATE  t_ckd_service c INNER JOIN  t_person_db p ON c.HOSPCODE=p.hospcode 	AND c.PID=p.pid
SET c.sex=p.SEX, c.age=TIMESTAMPDIFF(year,p.BIRTH,c.DATE_SERV),c.nation=p.NATION;
/*up bp from service*/
UPDATE t_ckd_service c INNER JOIN  tmp_service s ON c.HOSPCODE=s.hospcode 
							AND c.PID=s.pid AND c.seq=s.seq AND c.DATE_SERV=s.date_serv
SET c.sbp = s.sbp , c.dbp = s.dbp
WHERE s.sbp BETWEEN 10 AND 300 AND s.dbp BETWEEN 10 AND 300; 
/*up bp from chronicfu where bp <10*/
UPDATE t_ckd_service c INNER JOIN  tmp_chronicfu f ON c.HOSPCODE=f.hospcode 
							AND c.PID=f.pid AND c.seq=f.seq AND c.DATE_SERV=f.date_serv
SET c.sbp=f.sbp , c.dbp=f.dbp
WHERE c.sbp <10 AND f.sbp BETWEEN 10 AND 300 AND f.dbp BETWEEN 10 AND 300; 
/*up egfr*/
UPDATE t_ckd_service c INNER JOIN  tmp_labfu l ON c.HOSPCODE=l.hospcode 
							AND c.PID=l.pid AND c.seq=l.seq AND c.DATE_SERV=l.date_serv
SET c.egfr = l.LABRESULT
WHERE l.LABTEST=15;
/*up egfr_ok*/
UPDATE t_ckd_service c SET c.egfr_ok = c.egfr;
/*up creatinine*/
UPDATE t_ckd_service c INNER JOIN  tmp_labfu l ON c.HOSPCODE=l.hospcode 
							AND c.PID=l.pid AND c.seq=l.seq AND c.DATE_SERV=l.date_serv
SET c.creatinine = l.LABRESULT
WHERE l.LABTEST=11;
/*up hb*/
UPDATE t_ckd_service c INNER JOIN  tmp_labfu l ON c.HOSPCODE=l.hospcode 
							AND c.PID=l.pid AND c.seq=l.seq AND c.DATE_SERV=l.date_serv
SET c.hb = l.LABRESULT
WHERE l.LABTEST=16;
/*up hba1c*/
UPDATE t_ckd_service c INNER JOIN  tmp_labfu l ON c.HOSPCODE=l.hospcode 
							AND c.PID=l.pid AND c.seq=l.seq AND c.DATE_SERV=l.date_serv
SET c.hba1c = l.LABRESULT
WHERE l.LABTEST=5;
/*up serum_k*/
UPDATE t_ckd_service c INNER JOIN  tmp_labfu l ON c.HOSPCODE=l.hospcode 
							AND c.PID=l.pid AND c.seq=l.seq AND c.DATE_SERV=l.date_serv
SET c.serum_k = l.LABRESULT
WHERE l.LABTEST=18;
/*up serum_hco3*/
UPDATE t_ckd_service c INNER JOIN  tmp_labfu l ON c.HOSPCODE=l.hospcode 
							AND c.PID=l.pid AND c.seq=l.seq AND c.DATE_SERV=l.date_serv
SET c.serum_hco3 = l.LABRESULT
WHERE l.LABTEST=19;
/*up urine_protein*/
UPDATE t_ckd_service c INNER JOIN  tmp_labfu l ON c.HOSPCODE=l.hospcode 
							AND c.PID=l.pid AND c.seq=l.seq AND c.DATE_SERV=l.date_serv
SET c.urine_protein = 1
WHERE (l.LABTEST=12 AND l.LABRESULT >=0 ) OR (l.LABTEST=14 AND l.LABRESULT >=0 )  ;
/*up upcr*/
UPDATE t_ckd_service c INNER JOIN  tmp_labfu l ON c.HOSPCODE=l.hospcode 
							AND c.PID=l.pid AND c.seq=l.seq AND c.DATE_SERV=l.date_serv
SET c.upcr = l.LABRESULT
WHERE l.LABTEST=17;
/*up serum_po4*/
UPDATE t_ckd_service c INNER JOIN  tmp_labfu l ON c.HOSPCODE=l.hospcode 
							AND c.PID=l.pid AND c.seq=l.seq AND c.DATE_SERV=l.date_serv
SET c.serum_po4 = l.LABRESULT
WHERE l.LABTEST=20;
/*up serum_ipth*/
UPDATE t_ckd_service c INNER JOIN  tmp_labfu l ON c.HOSPCODE=l.hospcode 
							AND c.PID=l.pid AND c.seq=l.seq AND c.DATE_SERV=l.date_serv
SET c.serum_ipth = l.LABRESULT
WHERE l.LABTEST=21;
/*up egfr_ok*/
UPDATE t_ckd_service c SET c.egfr_ok = egfr_fnc(c.creatinine,c.age,c.sex) WHERE c.creatinine > 0 ;
/*up acei_arb*/
UPDATE t_ckd_service c INNER JOIN  tmp_drug_opd d ON c.HOSPCODE=d.hospcode 
							AND c.PID=d.pid AND c.seq=d.seq AND c.DATE_SERV=d.date_serv
SET c.acei_arb = 1
WHERE 
(     d.DIDSTD REGEXP '^[0-9]0061[7-9]'
      OR d.DIDSTD REGEXP '^[0-9]0062[1-3]'
      OR d.DIDSTD REGEXP '^[0-9]23171'
      OR d.DIDSTD REGEXP '^[0-9]24354'
      OR d.DIDSTD REGEXP '^[0-9]24432'
      OR d.DIDSTD REGEXP '^[0-9]24831'
      OR d.DIDSTD REGEXP '^[0-9]24843'
      OR d.DIDSTD REGEXP '^[0-9]24860'
      OR d.DIDSTD REGEXP '^[0-9]24889'
      OR d.DIDSTD REGEXP '^[0-9]24976'
      OR d.DIDSTD REGEXP '^[0-9]44080'
      OR d.DIDSTD REGEXP '^[0-9]030902500[39]'
      OR d.DIDSTD REGEXP '^[0-9]03090[1-2]0001'
      OR d.DIDSTD REGEXP '^[0-9]0309025005'
      OR d.DIDSTD REGEXP '^[0-9]0309040005'
      OR d.DIDSTD REGEXP '^[0-9]0309025007'
      OR d.DIDSTD REGEXP '^[0-9]0309040001'
      OR d.DIDSTD REGEXP '^[0-9]0309025008'
      OR d.DIDSTD REGEXP '^[0-9]030902500[1246]'
      OR d.DIDSTD REGEXP '^[0-9]0309040003'
      OR d.DIDSTD REGEXP '^[0-9]0309023001'
      );
/*up statin*/
UPDATE t_ckd_service c INNER JOIN  tmp_drug_opd d ON c.HOSPCODE=d.hospcode 
							AND c.PID=d.pid AND c.seq=d.seq AND c.DATE_SERV=d.date_serv
SET c.statin = 1
WHERE 
(    d.DIDSTD REGEXP '^[0-9]05573'
     OR d.DIDSTD REGEXP '^[0-9]12482'
     OR d.DIDSTD REGEXP '^[0-9]24868'
     OR d.DIDSTD REGEXP '^[0-9]24922'
     OR d.DIDSTD REGEXP '^[0-9]43383'
     OR d.DIDSTD REGEXP '^[0-9]45714'
     OR d.DIDSTD REGEXP '^[0-9]0204011001'
     OR d.DIDSTD REGEXP '^[0-9]0204011002'
      );
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.160053;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:259;a:5:{i:0;s:35:"DROP PROCEDURE IF EXISTS t_ckd_egfr";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.160053;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:260;a:5:{i:0;s:35:"DROP PROCEDURE IF EXISTS t_ckd_egfr";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.2224531;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:262;a:5:{i:0;s:6521:"CREATE PROCEDURE t_ckd_egfr()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '39';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
SET @start_d1:=concat(@b_year-2,'1001');
SET @end_d1:=concat(@b_year-1,'0930');

DROP TABLE IF  EXISTS t_lab_egfr;
CREATE TABLE IF NOT EXISTS t_lab_egfr(
sex varchar(1),
age varchar(3),
nation varchar(3),
egfr varchar(20),
creatinine varchar(20),
egfr_ok varchar(20),
KEY(hospcode),KEY(PID),KEY(DATE_SERV)
) ENGINE MyISAM as
(SELECT
HOSPCODE,PID,SEQ,DATE_SERV,cid
,0 as 'sex'
,'' as 'nation'
,0 as 'age'
,0 as 'egfr'
,0 as 'creatinine'
,0 as 'egfr_ok'
FROM
tmp_labfu
WHERE
LABTEST in(11,15) AND LENGTH(TRIM(LABRESULT)) >0
);
/*up sex for egfr*/
UPDATE  t_lab_egfr c INNER JOIN  t_person_db p ON c.HOSPCODE=p.hospcode 	AND c.PID=p.pid
SET c.sex=p.SEX, c.age=TIMESTAMPDIFF(year,p.BIRTH,c.DATE_SERV),c.nation=p.NATION;

/*up egfr*/
UPDATE t_lab_egfr c INNER JOIN  tmp_labfu l ON c.HOSPCODE=l.hospcode 
							AND c.PID=l.pid AND c.seq=l.seq AND c.DATE_SERV=l.date_serv
SET c.egfr = l.LABRESULT
WHERE l.LABTEST=15;
/*up egfr_ok*/
UPDATE t_lab_egfr c SET c.egfr_ok = c.egfr;
/*up creatinine*/
UPDATE t_lab_egfr c INNER JOIN  tmp_labfu l ON c.HOSPCODE=l.hospcode 
							AND c.PID=l.pid AND c.seq=l.seq AND c.DATE_SERV=l.date_serv
SET c.creatinine = l.LABRESULT
WHERE l.LABTEST=11;
/*up egfr_ok*/
UPDATE t_lab_egfr c SET c.egfr_ok = egfr_fnc(c.creatinine,c.age,c.sex) WHERE c.creatinine > 0 ;

DROP TABLE IF  EXISTS t_ckd_egfr;
CREATE TABLE IF NOT EXISTS t_ckd_egfr (
egfr_r1 varchar(20) default '0',
egfr_d1 date default null,
egfr_r2 varchar(20) default '0',
egfr_d2 date default null,
egfr_r3 varchar(20) default '0',
egfr_d3 date default null,
egfr_r4 varchar(20) default '0',
egfr_d4 date default null,
day1 int(2) default 0,
day2 int(2) default 0,
day3 int(2) default 0,
sumseq int(2) default 0,
egfr_avg VARCHAR(20) DEFAULT null,
KEY(hospcode),
KEY(pid)
) ENGINE MyISAM as
(SELECT
HOSPCODE,PID,cid,sex,nation,
'0' as 'egfr_r1',
null as egfr_d1,
'0' as 'egfr_r2',
null as egfr_d2,
'0' as 'egfr_r3',
null as egfr_d3,
'0' as 'egfr_r4',
null as egfr_d4,
0 as 'day1',
0 as 'day2',
0 as 'day3',
0 as 'sumseq',
null as 'egfr_avg'
FROM
t_ckd_service
WHERE 
(
      DIAGCODE IN ('N181','N182','N183','N184')
		 OR  (DIAGCODE IN ('N189') AND ( egfr_ok=0 OR  egfr_ok>=15))
     OR (( DIAGCODE IN ('E102','E112','E122','E132','E142')
       OR LEFT( DIAGCODE,3) IN ('I12','I13')
       OR  DIAGCODE='I151')
      AND  egfr_ok>=15)
  ) 
AND DATE_SERV BETWEEN @start_d AND  @end_d
GROUP BY HOSPCODE ,PID
);
/*sumseq*/
UPDATE t_ckd_egfr e  
INNER JOIN (
		SELECT HOSPCODE,PID,COUNT(DISTINCT HOSPCODE ,PID,DATE_SERV) as sumseq
		FROM	t_lab_egfr 
	 WHERE egfr_ok>0		
	  GROUP BY HOSPCODE,PID
) c
SET e.sumseq=c.sumseq
WHERE  e.hospcode=c.HOSPCODE AND e.pid=c.PID;
/*egfr_1*/
UPDATE t_ckd_egfr e  
	INNER JOIN (
		SELECT HOSPCODE,PID,DATE_SERV,egfr_ok 
		FROM t_lab_egfr s 
		WHERE egfr_ok>0 
			AND DATE_SERV =(SELECT DATE_SERV FROM t_lab_egfr s1 WHERE s1.egfr_ok>0 AND s1.HOSPCODE=s.HOSPCODE AND s1.PID=s.PID
																		GROUP BY s1.cid,s1.DATE_SERV ORDER BY s1.date_serv DESC LIMIT 0,1)
		GROUP BY HOSPCODE,PID
		) c
SET e.egfr_r1=c.egfr_ok , e.egfr_d1=c.DATE_SERV
WHERE  e.hospcode=c.HOSPCODE AND e.pid=c.PID;
/*egfr_2*/
UPDATE t_ckd_egfr e  
	INNER JOIN (
		SELECT HOSPCODE,PID,DATE_SERV,egfr_ok 
		FROM t_lab_egfr s 
		WHERE egfr_ok>0 
			AND DATE_SERV =(SELECT DATE_SERV FROM t_lab_egfr s1 WHERE s1.egfr_ok>0 AND s1.HOSPCODE=s.HOSPCODE AND s1.PID=s.PID
																		GROUP BY s1.cid,s1.DATE_SERV ORDER BY s1.date_serv DESC LIMIT 1,1)
		GROUP BY HOSPCODE,PID
		) c
SET e.egfr_r2=c.egfr_ok , e.egfr_d2=c.DATE_SERV
WHERE  e.hospcode=c.HOSPCODE AND e.pid=c.PID;
/*egfr_3*/
UPDATE t_ckd_egfr e  
	INNER JOIN (
		SELECT HOSPCODE,PID,DATE_SERV,egfr_ok 
		FROM t_lab_egfr s 
		WHERE egfr_ok>0 
			AND DATE_SERV =(SELECT DATE_SERV FROM t_lab_egfr s1 WHERE s1.egfr_ok>0 AND s1.HOSPCODE=s.HOSPCODE AND s1.PID=s.PID
																		GROUP BY s1.cid,s1.DATE_SERV ORDER BY s1.date_serv DESC LIMIT 2,1)
		GROUP BY HOSPCODE,PID
		) c
SET e.egfr_r3=c.egfr_ok , e.egfr_d3=c.DATE_SERV
WHERE  e.hospcode=c.HOSPCODE AND e.pid=c.PID;
/*egfr_4*/
UPDATE t_ckd_egfr e  
	INNER JOIN (
		SELECT HOSPCODE,PID,DATE_SERV,egfr_ok 
		FROM t_lab_egfr s 
		WHERE egfr_ok>0 
			AND DATE_SERV =(SELECT DATE_SERV FROM t_lab_egfr s1 WHERE s1.egfr_ok>0 AND s1.HOSPCODE=s.HOSPCODE AND s1.PID=s.PID
																		GROUP BY s1.cid,s1.DATE_SERV ORDER BY s1.date_serv DESC LIMIT 3,1)
		GROUP BY HOSPCODE,PID
		) c
SET e.egfr_r4=c.egfr_ok , e.egfr_d4=c.DATE_SERV
WHERE  e.hospcode=c.HOSPCODE AND e.pid=c.PID;
/*day*/
UPDATE  t_ckd_egfr e   SET e.day1=TIMESTAMPDIFF(day,e.egfr_d2,e.egfr_d1)
,e.day2=TIMESTAMPDIFF(day,e.egfr_d3,e.egfr_d2)
,e.day3=TIMESTAMPDIFF(day,e.egfr_d4,e.egfr_d3);
/*egfr_avg*/
UPDATE  t_ckd_egfr e   SET e.egfr_avg= ROUND((((egfr_r2-egfr_r1) /day1))*365,2)
WHERE e.sumseq = 2;

UPDATE  t_ckd_egfr e   SET e.egfr_avg= ROUND(( ( ((egfr_r3-egfr_r2) /day2) + ((egfr_r2-egfr_r1) /day1) )/2 )*365,2)
WHERE e.sumseq = 3;

UPDATE  t_ckd_egfr e   SET e.egfr_avg= ROUND((( ((egfr_r4-egfr_r3) /day3)  + ((egfr_r3-egfr_r2) /day2) + ((egfr_r2-egfr_r1) /day1) )/3)*365,2)
WHERE e.sumseq > 3;

DROP TABLE IF  EXISTS t_ckd_stage;
CREATE TABLE IF NOT EXISTS t_ckd_stage(
egfr_r2 varchar(20) default '0',
egfr_d2 date default null,
stage_now int DEFAULT 0,
stage_lastyear int DEFAULT 0,
PRIMARY KEY(hospcode,pid)
,KEY(hospcode,pid)
,KEY(cid) 
) ENGINE MyISAM as
(
SELECT 
hospcode,pid,cid,sex,nation,egfr_r1,egfr_d1,null as egfr_r2 ,null as egfr_d2,0 as stage_now,0 as stage_lastyear
FROM
t_ckd_egfr
WHERE  egfr_r1 >0
);

UPDATE t_ckd_stage t INNER JOIN (
SELECT * FROM
(SELECT * FROM t_lab_egfr WHERE date_serv BETWEEN @start_d1 AND @end_d1 ORDER BY date_serv DESC) d1
GROUP BY hospcode,pid
) l ON t.hospcode=l.hospcode AND t.pid=l.pid
SET t.egfr_r2=l.egfr_ok,t.egfr_d2=l.date_serv;

UPDATE t_ckd_stage SET stage_now=IF(egfr_r1 >=90,1,
IF(egfr_r1 BETWEEN 60 AND 89.99,2
,IF(egfr_r1 BETWEEN 30 AND 59.99,3
,IF(egfr_r1 BETWEEN 15 AND 29.99,4
,IF(egfr_r1 <15,5,0
)))))
,
stage_lastyear=IF(egfr_r2 >=90,1,
IF(egfr_r2 BETWEEN 60 AND 89.99,2
,IF(egfr_r2 BETWEEN 30 AND 59.99,3
,IF(egfr_r2 BETWEEN 15 AND 29.99,4
,IF(egfr_r2 <15,5,0
)))))
;
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.2380531;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:263;a:5:{i:0;s:6521:"CREATE PROCEDURE t_ckd_egfr()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '39';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
SET @start_d1:=concat(@b_year-2,'1001');
SET @end_d1:=concat(@b_year-1,'0930');

DROP TABLE IF  EXISTS t_lab_egfr;
CREATE TABLE IF NOT EXISTS t_lab_egfr(
sex varchar(1),
age varchar(3),
nation varchar(3),
egfr varchar(20),
creatinine varchar(20),
egfr_ok varchar(20),
KEY(hospcode),KEY(PID),KEY(DATE_SERV)
) ENGINE MyISAM as
(SELECT
HOSPCODE,PID,SEQ,DATE_SERV,cid
,0 as 'sex'
,'' as 'nation'
,0 as 'age'
,0 as 'egfr'
,0 as 'creatinine'
,0 as 'egfr_ok'
FROM
tmp_labfu
WHERE
LABTEST in(11,15) AND LENGTH(TRIM(LABRESULT)) >0
);
/*up sex for egfr*/
UPDATE  t_lab_egfr c INNER JOIN  t_person_db p ON c.HOSPCODE=p.hospcode 	AND c.PID=p.pid
SET c.sex=p.SEX, c.age=TIMESTAMPDIFF(year,p.BIRTH,c.DATE_SERV),c.nation=p.NATION;

/*up egfr*/
UPDATE t_lab_egfr c INNER JOIN  tmp_labfu l ON c.HOSPCODE=l.hospcode 
							AND c.PID=l.pid AND c.seq=l.seq AND c.DATE_SERV=l.date_serv
SET c.egfr = l.LABRESULT
WHERE l.LABTEST=15;
/*up egfr_ok*/
UPDATE t_lab_egfr c SET c.egfr_ok = c.egfr;
/*up creatinine*/
UPDATE t_lab_egfr c INNER JOIN  tmp_labfu l ON c.HOSPCODE=l.hospcode 
							AND c.PID=l.pid AND c.seq=l.seq AND c.DATE_SERV=l.date_serv
SET c.creatinine = l.LABRESULT
WHERE l.LABTEST=11;
/*up egfr_ok*/
UPDATE t_lab_egfr c SET c.egfr_ok = egfr_fnc(c.creatinine,c.age,c.sex) WHERE c.creatinine > 0 ;

DROP TABLE IF  EXISTS t_ckd_egfr;
CREATE TABLE IF NOT EXISTS t_ckd_egfr (
egfr_r1 varchar(20) default '0',
egfr_d1 date default null,
egfr_r2 varchar(20) default '0',
egfr_d2 date default null,
egfr_r3 varchar(20) default '0',
egfr_d3 date default null,
egfr_r4 varchar(20) default '0',
egfr_d4 date default null,
day1 int(2) default 0,
day2 int(2) default 0,
day3 int(2) default 0,
sumseq int(2) default 0,
egfr_avg VARCHAR(20) DEFAULT null,
KEY(hospcode),
KEY(pid)
) ENGINE MyISAM as
(SELECT
HOSPCODE,PID,cid,sex,nation,
'0' as 'egfr_r1',
null as egfr_d1,
'0' as 'egfr_r2',
null as egfr_d2,
'0' as 'egfr_r3',
null as egfr_d3,
'0' as 'egfr_r4',
null as egfr_d4,
0 as 'day1',
0 as 'day2',
0 as 'day3',
0 as 'sumseq',
null as 'egfr_avg'
FROM
t_ckd_service
WHERE 
(
      DIAGCODE IN ('N181','N182','N183','N184')
		 OR  (DIAGCODE IN ('N189') AND ( egfr_ok=0 OR  egfr_ok>=15))
     OR (( DIAGCODE IN ('E102','E112','E122','E132','E142')
       OR LEFT( DIAGCODE,3) IN ('I12','I13')
       OR  DIAGCODE='I151')
      AND  egfr_ok>=15)
  ) 
AND DATE_SERV BETWEEN @start_d AND  @end_d
GROUP BY HOSPCODE ,PID
);
/*sumseq*/
UPDATE t_ckd_egfr e  
INNER JOIN (
		SELECT HOSPCODE,PID,COUNT(DISTINCT HOSPCODE ,PID,DATE_SERV) as sumseq
		FROM	t_lab_egfr 
	 WHERE egfr_ok>0		
	  GROUP BY HOSPCODE,PID
) c
SET e.sumseq=c.sumseq
WHERE  e.hospcode=c.HOSPCODE AND e.pid=c.PID;
/*egfr_1*/
UPDATE t_ckd_egfr e  
	INNER JOIN (
		SELECT HOSPCODE,PID,DATE_SERV,egfr_ok 
		FROM t_lab_egfr s 
		WHERE egfr_ok>0 
			AND DATE_SERV =(SELECT DATE_SERV FROM t_lab_egfr s1 WHERE s1.egfr_ok>0 AND s1.HOSPCODE=s.HOSPCODE AND s1.PID=s.PID
																		GROUP BY s1.cid,s1.DATE_SERV ORDER BY s1.date_serv DESC LIMIT 0,1)
		GROUP BY HOSPCODE,PID
		) c
SET e.egfr_r1=c.egfr_ok , e.egfr_d1=c.DATE_SERV
WHERE  e.hospcode=c.HOSPCODE AND e.pid=c.PID;
/*egfr_2*/
UPDATE t_ckd_egfr e  
	INNER JOIN (
		SELECT HOSPCODE,PID,DATE_SERV,egfr_ok 
		FROM t_lab_egfr s 
		WHERE egfr_ok>0 
			AND DATE_SERV =(SELECT DATE_SERV FROM t_lab_egfr s1 WHERE s1.egfr_ok>0 AND s1.HOSPCODE=s.HOSPCODE AND s1.PID=s.PID
																		GROUP BY s1.cid,s1.DATE_SERV ORDER BY s1.date_serv DESC LIMIT 1,1)
		GROUP BY HOSPCODE,PID
		) c
SET e.egfr_r2=c.egfr_ok , e.egfr_d2=c.DATE_SERV
WHERE  e.hospcode=c.HOSPCODE AND e.pid=c.PID;
/*egfr_3*/
UPDATE t_ckd_egfr e  
	INNER JOIN (
		SELECT HOSPCODE,PID,DATE_SERV,egfr_ok 
		FROM t_lab_egfr s 
		WHERE egfr_ok>0 
			AND DATE_SERV =(SELECT DATE_SERV FROM t_lab_egfr s1 WHERE s1.egfr_ok>0 AND s1.HOSPCODE=s.HOSPCODE AND s1.PID=s.PID
																		GROUP BY s1.cid,s1.DATE_SERV ORDER BY s1.date_serv DESC LIMIT 2,1)
		GROUP BY HOSPCODE,PID
		) c
SET e.egfr_r3=c.egfr_ok , e.egfr_d3=c.DATE_SERV
WHERE  e.hospcode=c.HOSPCODE AND e.pid=c.PID;
/*egfr_4*/
UPDATE t_ckd_egfr e  
	INNER JOIN (
		SELECT HOSPCODE,PID,DATE_SERV,egfr_ok 
		FROM t_lab_egfr s 
		WHERE egfr_ok>0 
			AND DATE_SERV =(SELECT DATE_SERV FROM t_lab_egfr s1 WHERE s1.egfr_ok>0 AND s1.HOSPCODE=s.HOSPCODE AND s1.PID=s.PID
																		GROUP BY s1.cid,s1.DATE_SERV ORDER BY s1.date_serv DESC LIMIT 3,1)
		GROUP BY HOSPCODE,PID
		) c
SET e.egfr_r4=c.egfr_ok , e.egfr_d4=c.DATE_SERV
WHERE  e.hospcode=c.HOSPCODE AND e.pid=c.PID;
/*day*/
UPDATE  t_ckd_egfr e   SET e.day1=TIMESTAMPDIFF(day,e.egfr_d2,e.egfr_d1)
,e.day2=TIMESTAMPDIFF(day,e.egfr_d3,e.egfr_d2)
,e.day3=TIMESTAMPDIFF(day,e.egfr_d4,e.egfr_d3);
/*egfr_avg*/
UPDATE  t_ckd_egfr e   SET e.egfr_avg= ROUND((((egfr_r2-egfr_r1) /day1))*365,2)
WHERE e.sumseq = 2;

UPDATE  t_ckd_egfr e   SET e.egfr_avg= ROUND(( ( ((egfr_r3-egfr_r2) /day2) + ((egfr_r2-egfr_r1) /day1) )/2 )*365,2)
WHERE e.sumseq = 3;

UPDATE  t_ckd_egfr e   SET e.egfr_avg= ROUND((( ((egfr_r4-egfr_r3) /day3)  + ((egfr_r3-egfr_r2) /day2) + ((egfr_r2-egfr_r1) /day1) )/3)*365,2)
WHERE e.sumseq > 3;

DROP TABLE IF  EXISTS t_ckd_stage;
CREATE TABLE IF NOT EXISTS t_ckd_stage(
egfr_r2 varchar(20) default '0',
egfr_d2 date default null,
stage_now int DEFAULT 0,
stage_lastyear int DEFAULT 0,
PRIMARY KEY(hospcode,pid)
,KEY(hospcode,pid)
,KEY(cid) 
) ENGINE MyISAM as
(
SELECT 
hospcode,pid,cid,sex,nation,egfr_r1,egfr_d1,null as egfr_r2 ,null as egfr_d2,0 as stage_now,0 as stage_lastyear
FROM
t_ckd_egfr
WHERE  egfr_r1 >0
);

UPDATE t_ckd_stage t INNER JOIN (
SELECT * FROM
(SELECT * FROM t_lab_egfr WHERE date_serv BETWEEN @start_d1 AND @end_d1 ORDER BY date_serv DESC) d1
GROUP BY hospcode,pid
) l ON t.hospcode=l.hospcode AND t.pid=l.pid
SET t.egfr_r2=l.egfr_ok,t.egfr_d2=l.date_serv;

UPDATE t_ckd_stage SET stage_now=IF(egfr_r1 >=90,1,
IF(egfr_r1 BETWEEN 60 AND 89.99,2
,IF(egfr_r1 BETWEEN 30 AND 59.99,3
,IF(egfr_r1 BETWEEN 15 AND 29.99,4
,IF(egfr_r1 <15,5,0
)))))
,
stage_lastyear=IF(egfr_r2 >=90,1,
IF(egfr_r2 BETWEEN 60 AND 89.99,2
,IF(egfr_r2 BETWEEN 30 AND 59.99,3
,IF(egfr_r2 BETWEEN 15 AND 29.99,4
,IF(egfr_r2 <15,5,0
)))))
;
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.3004529;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:265;a:5:{i:0;s:37:"DROP PROCEDURE IF EXISTS t_death_hosp";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.3004529;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:266;a:5:{i:0;s:37:"DROP PROCEDURE IF EXISTS t_death_hosp";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.347254;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:268;a:5:{i:0;s:1895:"CREATE PROCEDURE t_death_hosp()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '40';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
DROP TABLE IF EXISTS t_death_hosp;
CREATE TABLE IF NOT EXISTS t_death_hosp( 
pt_type VARCHAR(1) DEFAULT NULL,
pdx_opd VARCHAR(7) DEFAULT NULL,
pdx_ipd VARCHAR(7) DEFAULT NULL,
code298 VARCHAR(7) DEFAULT NULL,
PRIMARY KEY(hospcode,pid),
KEY(hospcode),
KEY(pid),
KEY(cid),
KEY(date)
 ) ENGINE=MyISAM  AS(

		SELECT DISTINCT
			s.hospcode,s.pid,s.CID,date_serv as date, '1' as pt_type,NULL as pdx_opd,NULL as pdx_ipd,null as code298
			FROM
			tmp_service s 
			WHERE s.typeout in(4,5,6) AND date_serv BETWEEN @start_d AND @end_d
			GROUP BY s.hospcode,s.pid
);

INSERT IGNORE INTO t_death_hosp (hospcode,pid,CID,DATE,pt_type)
(	SELECT
			a.hospcode,a.pid,a.CID,DATE_FORMAT(DATETIME_DISCH,'%Y%m%d'), '2' as pt_type
			FROM
			tmp_admission a
			WHERE (a.DISCHSTATUS in(8,9)  OR a.DISCHTYPE in(8,9)) 
					AND DATE_FORMAT(DATETIME_DISCH,'%Y%m%d') BETWEEN @start_d AND @end_d 
);

UPDATE t_death_hosp t INNER JOIN (
		SELECT HOSPCODE,PID,DATE_SERV,DIAGCODE
		FROM tmp_diag_opd WHERE DIAGTYPE in(1) 
		GROUP BY HOSPCODE,PID,DATE_SERV
)  d SET pdx_opd=d.DIAGCODE WHERE t.hospcode=d.HOSPCODE and t.pid=d.PID AND t.date=d.DATE_SERV;

UPDATE t_death_hosp t INNER JOIN (
		SELECT HOSPCODE,PID,DATE_FORMAT(datetime_disch,'%Y%m%d') date,DIAGCODE
		FROM tmp_diag_ipd WHERE DIAGTYPE in(1) 
		GROUP BY HOSPCODE,PID,date
)  d SET pdx_ipd=d.DIAGCODE WHERE t.hospcode=d.HOSPCODE and t.pid=d.PID AND t.date=d.date;

UPDATE t_death_hosp t INNER JOIN cicd298group i ON t.pdx_ipd=i.icd10 
SET t.code298=i.groupcode298;

UPDATE t_death_hosp t INNER JOIN cicd298group i ON t.pdx_opd=i.icd10 
SET t.code298=i.groupcode298 
WHERE t.code298 is NULL;

 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.347254;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:269;a:5:{i:0;s:1895:"CREATE PROCEDURE t_death_hosp()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '40';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
DROP TABLE IF EXISTS t_death_hosp;
CREATE TABLE IF NOT EXISTS t_death_hosp( 
pt_type VARCHAR(1) DEFAULT NULL,
pdx_opd VARCHAR(7) DEFAULT NULL,
pdx_ipd VARCHAR(7) DEFAULT NULL,
code298 VARCHAR(7) DEFAULT NULL,
PRIMARY KEY(hospcode,pid),
KEY(hospcode),
KEY(pid),
KEY(cid),
KEY(date)
 ) ENGINE=MyISAM  AS(

		SELECT DISTINCT
			s.hospcode,s.pid,s.CID,date_serv as date, '1' as pt_type,NULL as pdx_opd,NULL as pdx_ipd,null as code298
			FROM
			tmp_service s 
			WHERE s.typeout in(4,5,6) AND date_serv BETWEEN @start_d AND @end_d
			GROUP BY s.hospcode,s.pid
);

INSERT IGNORE INTO t_death_hosp (hospcode,pid,CID,DATE,pt_type)
(	SELECT
			a.hospcode,a.pid,a.CID,DATE_FORMAT(DATETIME_DISCH,'%Y%m%d'), '2' as pt_type
			FROM
			tmp_admission a
			WHERE (a.DISCHSTATUS in(8,9)  OR a.DISCHTYPE in(8,9)) 
					AND DATE_FORMAT(DATETIME_DISCH,'%Y%m%d') BETWEEN @start_d AND @end_d 
);

UPDATE t_death_hosp t INNER JOIN (
		SELECT HOSPCODE,PID,DATE_SERV,DIAGCODE
		FROM tmp_diag_opd WHERE DIAGTYPE in(1) 
		GROUP BY HOSPCODE,PID,DATE_SERV
)  d SET pdx_opd=d.DIAGCODE WHERE t.hospcode=d.HOSPCODE and t.pid=d.PID AND t.date=d.DATE_SERV;

UPDATE t_death_hosp t INNER JOIN (
		SELECT HOSPCODE,PID,DATE_FORMAT(datetime_disch,'%Y%m%d') date,DIAGCODE
		FROM tmp_diag_ipd WHERE DIAGTYPE in(1) 
		GROUP BY HOSPCODE,PID,date
)  d SET pdx_ipd=d.DIAGCODE WHERE t.hospcode=d.HOSPCODE and t.pid=d.PID AND t.date=d.date;

UPDATE t_death_hosp t INNER JOIN cicd298group i ON t.pdx_ipd=i.icd10 
SET t.code298=i.groupcode298;

UPDATE t_death_hosp t INNER JOIN cicd298group i ON t.pdx_opd=i.icd10 
SET t.code298=i.groupcode298 
WHERE t.code298 is NULL;

 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.3940539;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:271;a:5:{i:0;s:38:"DROP PROCEDURE IF EXISTS t_labor_abort";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.3940539;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:272;a:5:{i:0;s:38:"DROP PROCEDURE IF EXISTS t_labor_abort";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.4408541;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:274;a:5:{i:0;s:2784:"CREATE PROCEDURE t_labor_abort()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '41';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS t_labor_abort;
CREATE TABLE IF NOT EXISTS t_labor_abort(
lmp date DEFAULT NULL,
edc date DEFAULT NULL,
nation VARCHAR(3) DEFAULT NULL,
bdate date DEFAULT NULL,
teen VARCHAR(1) DEFAULT NULL,
abort VARCHAR(1) DEFAULT NULL,
date_disch date DEFAULT NULL,
fp_date date DEFAULT NULL,
fp VARCHAR(1) DEFAULT NULL,
fptype VARCHAR(1) DEFAULT NULL,
PRIMARY KEY(hospcode,pid),
KEY(hospcode),
KEY(pid),
KEY(cid),
KEY(bdate),
KEY(bhosp),
KEY(bresult),
KEY(lborn),
KEY(age_y)
) ENGINE MyIsam  as
SELECT 
l.*,null as nation ,null as teen,null as abort,null date_disch,null fp_date,null as fp,null as fptype
FROM
tmp_labor l
WHERE l.BDATE BETWEEN @start_d AND @end_d 
GROUP BY hospcode,pid;

UPDATE t_labor_abort l 
INNER JOIN (
SELECT * FROM tmp_diag_ipd 
WHERE ((SUBSTR(diagcode,1,3)  BETWEEN 'O03' AND 'O07')  
		OR (SUBSTR(diagcode,1,3) BETWEEN 'O62' AND 'O84') 
		OR diagcode in('O601','O602','O603'))
GROUP BY HOSPCODE,PID
) d ON l.hospcode=d.hospcode AND l.pid=d.pid 
SET l.BRESULT=d.diagcode
WHERE ((SUBSTR(diagcode,1,3) not BETWEEN 'O03' AND 'O07')  OR
(SUBSTR(diagcode,1,3) not BETWEEN 'O62' AND 'O84') OR diagcode not in('O601','O602','O603'));

INSERT IGNORE INTO t_labor_abort(
	HOSPCODE,PID,BRESULT, BHOSP,D_UPDATE,cid,birth,age_y ,date_disch,nation
)  
(
SELECT
	d.HOSPCODE,d.PID,DIAGCODE  as BRESULT,d.HOSPCODE as BHOSP,d.D_UPDATE, d.cid , p.birth 
	, TIMESTAMPDIFF(year,BIRTH,datetime_disch)  ,DATE_FORMAT(datetime_disch,'%Y%m%d'),p.NATION
FROM
tmp_diag_ipd d INNER JOIN t_person_db p ON d.HOSPCODE=p.HOSPCODE AND d.PID=p.PID
WHERE ((SUBSTR(diagcode,1,3)  BETWEEN 'O03' AND 'O07')  
		OR (SUBSTR(diagcode,1,3) BETWEEN 'O62' AND 'O84') 
		OR diagcode in('O601','O602','O603'))
GROUP BY HOSPCODE,PID
);

UPDATE t_labor_abort SET LBORN=1 
WHERE LBORN=0 AND SBORN=0 AND SUBSTR(BRESULT,1,3) BETWEEN 'O80' AND 'O84';


UPDATE t_labor_abort l INNER JOIN t_person_db p ON p.HOSPCODE=l.HOSPCODE AND p.PID=l.PID 
SET l.nation=p.NATION;

UPDATE t_labor_abort SET teen=1 WHERE age_y < 19;

UPDATE t_labor_abort SET abort=1  WHERE lborn =0 
AND (bresult in('O021','O364') OR  SUBSTR(bresult,1,3) in('O03','O06','O08')) ;

DELETE FROM t_labor_abort WHERE age_y <10 OR age_y is NULL;

UPDATE t_labor_abort l INNER JOIN tmp_fp f ON f.HOSPCODE=l.HOSPCODE AND f.PID=l.PID   
SET fp_date= f.DATE_SERV, l.fptype=f.fptype;

UPDATE t_labor_abort SET fp=1
WHERE   fp_date BETWEEN BDATE and  date_disch ;

UPDATE t_labor_abort SET fp=1
WHERE   TIMESTAMPDIFF(day,BDATE,fp_date) < 15;
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.4408541;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:275;a:5:{i:0;s:2784:"CREATE PROCEDURE t_labor_abort()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '41';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS t_labor_abort;
CREATE TABLE IF NOT EXISTS t_labor_abort(
lmp date DEFAULT NULL,
edc date DEFAULT NULL,
nation VARCHAR(3) DEFAULT NULL,
bdate date DEFAULT NULL,
teen VARCHAR(1) DEFAULT NULL,
abort VARCHAR(1) DEFAULT NULL,
date_disch date DEFAULT NULL,
fp_date date DEFAULT NULL,
fp VARCHAR(1) DEFAULT NULL,
fptype VARCHAR(1) DEFAULT NULL,
PRIMARY KEY(hospcode,pid),
KEY(hospcode),
KEY(pid),
KEY(cid),
KEY(bdate),
KEY(bhosp),
KEY(bresult),
KEY(lborn),
KEY(age_y)
) ENGINE MyIsam  as
SELECT 
l.*,null as nation ,null as teen,null as abort,null date_disch,null fp_date,null as fp,null as fptype
FROM
tmp_labor l
WHERE l.BDATE BETWEEN @start_d AND @end_d 
GROUP BY hospcode,pid;

UPDATE t_labor_abort l 
INNER JOIN (
SELECT * FROM tmp_diag_ipd 
WHERE ((SUBSTR(diagcode,1,3)  BETWEEN 'O03' AND 'O07')  
		OR (SUBSTR(diagcode,1,3) BETWEEN 'O62' AND 'O84') 
		OR diagcode in('O601','O602','O603'))
GROUP BY HOSPCODE,PID
) d ON l.hospcode=d.hospcode AND l.pid=d.pid 
SET l.BRESULT=d.diagcode
WHERE ((SUBSTR(diagcode,1,3) not BETWEEN 'O03' AND 'O07')  OR
(SUBSTR(diagcode,1,3) not BETWEEN 'O62' AND 'O84') OR diagcode not in('O601','O602','O603'));

INSERT IGNORE INTO t_labor_abort(
	HOSPCODE,PID,BRESULT, BHOSP,D_UPDATE,cid,birth,age_y ,date_disch,nation
)  
(
SELECT
	d.HOSPCODE,d.PID,DIAGCODE  as BRESULT,d.HOSPCODE as BHOSP,d.D_UPDATE, d.cid , p.birth 
	, TIMESTAMPDIFF(year,BIRTH,datetime_disch)  ,DATE_FORMAT(datetime_disch,'%Y%m%d'),p.NATION
FROM
tmp_diag_ipd d INNER JOIN t_person_db p ON d.HOSPCODE=p.HOSPCODE AND d.PID=p.PID
WHERE ((SUBSTR(diagcode,1,3)  BETWEEN 'O03' AND 'O07')  
		OR (SUBSTR(diagcode,1,3) BETWEEN 'O62' AND 'O84') 
		OR diagcode in('O601','O602','O603'))
GROUP BY HOSPCODE,PID
);

UPDATE t_labor_abort SET LBORN=1 
WHERE LBORN=0 AND SBORN=0 AND SUBSTR(BRESULT,1,3) BETWEEN 'O80' AND 'O84';


UPDATE t_labor_abort l INNER JOIN t_person_db p ON p.HOSPCODE=l.HOSPCODE AND p.PID=l.PID 
SET l.nation=p.NATION;

UPDATE t_labor_abort SET teen=1 WHERE age_y < 19;

UPDATE t_labor_abort SET abort=1  WHERE lborn =0 
AND (bresult in('O021','O364') OR  SUBSTR(bresult,1,3) in('O03','O06','O08')) ;

DELETE FROM t_labor_abort WHERE age_y <10 OR age_y is NULL;

UPDATE t_labor_abort l INNER JOIN tmp_fp f ON f.HOSPCODE=l.HOSPCODE AND f.PID=l.PID   
SET fp_date= f.DATE_SERV, l.fptype=f.fptype;

UPDATE t_labor_abort SET fp=1
WHERE   fp_date BETWEEN BDATE and  date_disch ;

UPDATE t_labor_abort SET fp=1
WHERE   TIMESTAMPDIFF(day,BDATE,fp_date) < 15;
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.5032539;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:277;a:5:{i:0;s:38:"DROP PROCEDURE IF EXISTS t_nutrition05";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.5032539;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:278;a:5:{i:0;s:38:"DROP PROCEDURE IF EXISTS t_nutrition05";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.5500541;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:280;a:5:{i:0;s:5814:"CREATE PROCEDURE t_nutrition05()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '42';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
SET @start_t1=concat(@b_year-1,'1001');
SET @start_t2=concat(@b_year,'0101');
SET @start_t3=concat(@b_year,'0401');
SET @start_t4=concat(@b_year,'0701');
SET @end_t1=concat(@b_year-1,'1231');
SET @end_t2=concat(@b_year,'0331');
SET @end_t3=concat(@b_year,'0630');
SET @end_t4=concat(@b_year,'0930');

DROP TABLE IF EXISTS t_nutrition05;
CREATE TABLE IF NOT EXISTS t_nutrition05( 
		CID VARCHAR(13) NOT NULL,
		SEX VARCHAR(1) NOT NULL,
		BIRTH DATE  DEFAULT NULL,
		AGE_T1 VARCHAR(5)  DEFAULT NULL,
		AGE_T2 VARCHAR(5)  DEFAULT NULL,
		AGE_T3 VARCHAR(5)  DEFAULT NULL,
		AGE_T4 VARCHAR(5)  DEFAULT NULL,
		DATE_SERV1 DATE DEFAULT NULL,
		DATE_SERV2 DATE DEFAULT NULL,
		DATE_SERV3 DATE DEFAULT NULL,
		DATE_SERV4 DATE DEFAULT NULL,
		AGE_MS1 VARCHAR(5)  DEFAULT NULL,
		AGE_MS2 VARCHAR(5)  DEFAULT NULL,
		AGE_MS3 VARCHAR(5)  DEFAULT NULL,
		AGE_MS4 VARCHAR(5)  DEFAULT NULL,
		WEIGHT1 DECIMAL(5,1)  DEFAULT 0,
		WEIGHT2 DECIMAL(5,1)  DEFAULT 0,
		WEIGHT3 DECIMAL(5,1)  DEFAULT 0,
		WEIGHT4 DECIMAL(5,1)  DEFAULT 0,
		HEIGHT1 INT(3)  DEFAULT 0,
		HEIGHT2 INT(3)  DEFAULT 0,
		HEIGHT3 INT(3)  DEFAULT 0,
		HEIGHT4 INT(3)  DEFAULT 0,
		W_S1 VARCHAR(1)  DEFAULT NULL,
		W_S2 VARCHAR(1)  DEFAULT NULL,
		W_S3 VARCHAR(1)  DEFAULT NULL,
		W_S4 VARCHAR(1)  DEFAULT NULL,
		H_S1 VARCHAR(1)  DEFAULT NULL,
		H_S2 VARCHAR(1)  DEFAULT NULL,
		H_S3 VARCHAR(1)  DEFAULT NULL,
		H_S4 VARCHAR(1)  DEFAULT NULL,
		WH1 VARCHAR(1)  DEFAULT NULL,
		WH2 VARCHAR(1)  DEFAULT NULL,
		WH3 VARCHAR(1)  DEFAULT NULL,
		WH4 VARCHAR(1)  DEFAULT NULL,
		hospcode VARCHAR(5)  DEFAULT NULL,
		typearea VARCHAR(1)  DEFAULT NULL,
		PRIMARY KEY (CID)
) ENGINE MyISAM DEFAULT CHARACTER SET=utf8;
/*เพิ่มข้อมูลคน*/
INSERT IGNORE INTO t_nutrition05 (cid,birth,sex,AGE_T1,AGE_T2,AGE_T3,AGE_T4,hospcode,typearea)
SELECT
		p.cid,p.BIRTH,p.SEX
		,TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@end_t1,'%Y%m%d')) AGE_T1
		,TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@end_t2,'%Y%m%d')) AGE_T2
		,TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@end_t3,'%Y%m%d')) AGE_T3
		,TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@end_t4,'%Y%m%d')) AGE_T4
		,check_hosp,check_typearea
FROM  t_person_cid p 
WHERE   TIMESTAMPDIFF(day,p.BIRTH,NOW())>1  AND 
		(
			TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@end_t1,'%Y%m%d'))  <6 OR
			TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@end_t2,'%Y%m%d'))  <6 OR
			TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@end_t3,'%Y%m%d'))  <6 OR
			TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@end_t4,'%Y%m%d'))  <6 
		)
GROUP BY p.cid;

/*เพิ่มบริการตามไตรมาส*/
UPDATE t_nutrition05 p INNER JOIN 
(SELECT * FROM 
			(SELECT cid,DATE_SERV,WEIGHT,HEIGHT FROM tmp_nutrition 
				WHERE DATE_SERV BETWEEN @start_t1 AND @end_t1 
				ORDER BY DATE_SERV DESC ) as t1 GROUP BY cid) as n
ON p.cid=n.cid  SET p.DATE_SERV1=n.DATE_SERV ,p.HEIGHT1=n.height ,p.WEIGHT1=n.weight;

UPDATE t_nutrition05 p INNER JOIN 
(SELECT * FROM 
			(SELECT cid,DATE_SERV,WEIGHT,HEIGHT FROM tmp_nutrition 
				WHERE DATE_SERV BETWEEN @start_t2 AND @end_t2
				ORDER BY DATE_SERV DESC ) as t1 GROUP BY cid) as n
ON p.cid=n.cid  SET p.DATE_SERV2=n.DATE_SERV ,p.HEIGHT2=n.height ,p.WEIGHT2=n.weight;

UPDATE t_nutrition05 p INNER JOIN 
(SELECT * FROM 
			(SELECT cid,DATE_SERV,WEIGHT,HEIGHT FROM tmp_nutrition 
				WHERE DATE_SERV BETWEEN @start_t3 AND @end_t3
				ORDER BY DATE_SERV DESC ) as t1 GROUP BY cid) as n
ON p.cid=n.cid  SET p.DATE_SERV3=n.DATE_SERV ,p.HEIGHT3=n.height ,p.WEIGHT3=n.weight;

UPDATE t_nutrition05 p INNER JOIN 
(SELECT * FROM 
			(SELECT cid,DATE_SERV,WEIGHT,HEIGHT FROM tmp_nutrition 
				WHERE DATE_SERV BETWEEN @start_t4 AND @end_t4
				ORDER BY DATE_SERV DESC ) as t1 GROUP BY cid) as n
ON p.cid=n.cid  SET p.DATE_SERV4=n.DATE_SERV ,p.HEIGHT4=n.height ,p.WEIGHT4=n.weight;
/*คำนวนอายุเป็นเดือนณวันรับบริการ*/
UPDATE t_nutrition05  SET AGE_MS1 = TIMESTAMPDIFF(MONTH,BIRTH,DATE_SERV1)
		,AGE_MS2 = TIMESTAMPDIFF(MONTH,BIRTH,DATE_SERV2)
		,AGE_MS3 = TIMESTAMPDIFF(MONTH,BIRTH,DATE_SERV3)
		,AGE_MS4 = TIMESTAMPDIFF(MONTH,BIRTH,DATE_SERV4);
/*คำนวน Nutrition_CAL*/
UPDATE t_nutrition05 SET W_S1=nutri_cal(AGE_MS1,SEX,'1',HEIGHT1,WEIGHT1) WHERE AGE_MS1 >0 AND WEIGHT1 >0;
UPDATE t_nutrition05 SET W_S2=nutri_cal(AGE_MS2,SEX,'1',HEIGHT2,WEIGHT2) WHERE AGE_MS2 >0 AND WEIGHT2 >0;
UPDATE t_nutrition05 SET W_S3=nutri_cal(AGE_MS3,SEX,'1',HEIGHT3,WEIGHT3) WHERE AGE_MS3 >0 AND WEIGHT3 >0;
UPDATE t_nutrition05 SET W_S4=nutri_cal(AGE_MS4,SEX,'1',HEIGHT4,WEIGHT4) WHERE AGE_MS4 >0 AND WEIGHT4 >0;

UPDATE t_nutrition05 SET H_S1=nutri_cal(AGE_MS1,SEX,'2',HEIGHT1,WEIGHT1) WHERE AGE_MS1 >0  AND HEIGHT1 >0;
UPDATE t_nutrition05 SET H_S2=nutri_cal(AGE_MS2,SEX,'2',HEIGHT2,WEIGHT2) WHERE AGE_MS2 >0  AND HEIGHT2 >0;
UPDATE t_nutrition05 SET H_S3=nutri_cal(AGE_MS3,SEX,'2',HEIGHT3,WEIGHT3) WHERE AGE_MS3 >0  AND HEIGHT3 >0;
UPDATE t_nutrition05 SET H_S4=nutri_cal(AGE_MS4,SEX,'2',HEIGHT4,WEIGHT4) WHERE AGE_MS4 >0  AND HEIGHT4 >0;

UPDATE t_nutrition05 SET WH1=nutri_cal(AGE_MS1,SEX,'3',HEIGHT1,WEIGHT1) WHERE AGE_MS1 >0 AND WEIGHT1 >0 AND HEIGHT1 >0 ; 
UPDATE t_nutrition05 SET WH2=nutri_cal(AGE_MS2,SEX,'3',HEIGHT2,WEIGHT2) WHERE AGE_MS2 >0 AND WEIGHT2 >0 AND HEIGHT2 >0 ; 
UPDATE t_nutrition05 SET WH3=nutri_cal(AGE_MS3,SEX,'3',HEIGHT3,WEIGHT3) WHERE AGE_MS3 >0 AND WEIGHT3 >0 AND HEIGHT3 >0 ; 
UPDATE t_nutrition05 SET WH4=nutri_cal(AGE_MS4,SEX,'3',HEIGHT4,WEIGHT4) WHERE AGE_MS4 >0 AND WEIGHT4 >0 AND HEIGHT4 >0 ; 

 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.5500541;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:281;a:5:{i:0;s:5814:"CREATE PROCEDURE t_nutrition05()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '42';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
SET @start_t1=concat(@b_year-1,'1001');
SET @start_t2=concat(@b_year,'0101');
SET @start_t3=concat(@b_year,'0401');
SET @start_t4=concat(@b_year,'0701');
SET @end_t1=concat(@b_year-1,'1231');
SET @end_t2=concat(@b_year,'0331');
SET @end_t3=concat(@b_year,'0630');
SET @end_t4=concat(@b_year,'0930');

DROP TABLE IF EXISTS t_nutrition05;
CREATE TABLE IF NOT EXISTS t_nutrition05( 
		CID VARCHAR(13) NOT NULL,
		SEX VARCHAR(1) NOT NULL,
		BIRTH DATE  DEFAULT NULL,
		AGE_T1 VARCHAR(5)  DEFAULT NULL,
		AGE_T2 VARCHAR(5)  DEFAULT NULL,
		AGE_T3 VARCHAR(5)  DEFAULT NULL,
		AGE_T4 VARCHAR(5)  DEFAULT NULL,
		DATE_SERV1 DATE DEFAULT NULL,
		DATE_SERV2 DATE DEFAULT NULL,
		DATE_SERV3 DATE DEFAULT NULL,
		DATE_SERV4 DATE DEFAULT NULL,
		AGE_MS1 VARCHAR(5)  DEFAULT NULL,
		AGE_MS2 VARCHAR(5)  DEFAULT NULL,
		AGE_MS3 VARCHAR(5)  DEFAULT NULL,
		AGE_MS4 VARCHAR(5)  DEFAULT NULL,
		WEIGHT1 DECIMAL(5,1)  DEFAULT 0,
		WEIGHT2 DECIMAL(5,1)  DEFAULT 0,
		WEIGHT3 DECIMAL(5,1)  DEFAULT 0,
		WEIGHT4 DECIMAL(5,1)  DEFAULT 0,
		HEIGHT1 INT(3)  DEFAULT 0,
		HEIGHT2 INT(3)  DEFAULT 0,
		HEIGHT3 INT(3)  DEFAULT 0,
		HEIGHT4 INT(3)  DEFAULT 0,
		W_S1 VARCHAR(1)  DEFAULT NULL,
		W_S2 VARCHAR(1)  DEFAULT NULL,
		W_S3 VARCHAR(1)  DEFAULT NULL,
		W_S4 VARCHAR(1)  DEFAULT NULL,
		H_S1 VARCHAR(1)  DEFAULT NULL,
		H_S2 VARCHAR(1)  DEFAULT NULL,
		H_S3 VARCHAR(1)  DEFAULT NULL,
		H_S4 VARCHAR(1)  DEFAULT NULL,
		WH1 VARCHAR(1)  DEFAULT NULL,
		WH2 VARCHAR(1)  DEFAULT NULL,
		WH3 VARCHAR(1)  DEFAULT NULL,
		WH4 VARCHAR(1)  DEFAULT NULL,
		hospcode VARCHAR(5)  DEFAULT NULL,
		typearea VARCHAR(1)  DEFAULT NULL,
		PRIMARY KEY (CID)
) ENGINE MyISAM DEFAULT CHARACTER SET=utf8;
/*เพิ่มข้อมูลคน*/
INSERT IGNORE INTO t_nutrition05 (cid,birth,sex,AGE_T1,AGE_T2,AGE_T3,AGE_T4,hospcode,typearea)
SELECT
		p.cid,p.BIRTH,p.SEX
		,TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@end_t1,'%Y%m%d')) AGE_T1
		,TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@end_t2,'%Y%m%d')) AGE_T2
		,TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@end_t3,'%Y%m%d')) AGE_T3
		,TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@end_t4,'%Y%m%d')) AGE_T4
		,check_hosp,check_typearea
FROM  t_person_cid p 
WHERE   TIMESTAMPDIFF(day,p.BIRTH,NOW())>1  AND 
		(
			TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@end_t1,'%Y%m%d'))  <6 OR
			TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@end_t2,'%Y%m%d'))  <6 OR
			TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@end_t3,'%Y%m%d'))  <6 OR
			TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@end_t4,'%Y%m%d'))  <6 
		)
GROUP BY p.cid;

/*เพิ่มบริการตามไตรมาส*/
UPDATE t_nutrition05 p INNER JOIN 
(SELECT * FROM 
			(SELECT cid,DATE_SERV,WEIGHT,HEIGHT FROM tmp_nutrition 
				WHERE DATE_SERV BETWEEN @start_t1 AND @end_t1 
				ORDER BY DATE_SERV DESC ) as t1 GROUP BY cid) as n
ON p.cid=n.cid  SET p.DATE_SERV1=n.DATE_SERV ,p.HEIGHT1=n.height ,p.WEIGHT1=n.weight;

UPDATE t_nutrition05 p INNER JOIN 
(SELECT * FROM 
			(SELECT cid,DATE_SERV,WEIGHT,HEIGHT FROM tmp_nutrition 
				WHERE DATE_SERV BETWEEN @start_t2 AND @end_t2
				ORDER BY DATE_SERV DESC ) as t1 GROUP BY cid) as n
ON p.cid=n.cid  SET p.DATE_SERV2=n.DATE_SERV ,p.HEIGHT2=n.height ,p.WEIGHT2=n.weight;

UPDATE t_nutrition05 p INNER JOIN 
(SELECT * FROM 
			(SELECT cid,DATE_SERV,WEIGHT,HEIGHT FROM tmp_nutrition 
				WHERE DATE_SERV BETWEEN @start_t3 AND @end_t3
				ORDER BY DATE_SERV DESC ) as t1 GROUP BY cid) as n
ON p.cid=n.cid  SET p.DATE_SERV3=n.DATE_SERV ,p.HEIGHT3=n.height ,p.WEIGHT3=n.weight;

UPDATE t_nutrition05 p INNER JOIN 
(SELECT * FROM 
			(SELECT cid,DATE_SERV,WEIGHT,HEIGHT FROM tmp_nutrition 
				WHERE DATE_SERV BETWEEN @start_t4 AND @end_t4
				ORDER BY DATE_SERV DESC ) as t1 GROUP BY cid) as n
ON p.cid=n.cid  SET p.DATE_SERV4=n.DATE_SERV ,p.HEIGHT4=n.height ,p.WEIGHT4=n.weight;
/*คำนวนอายุเป็นเดือนณวันรับบริการ*/
UPDATE t_nutrition05  SET AGE_MS1 = TIMESTAMPDIFF(MONTH,BIRTH,DATE_SERV1)
		,AGE_MS2 = TIMESTAMPDIFF(MONTH,BIRTH,DATE_SERV2)
		,AGE_MS3 = TIMESTAMPDIFF(MONTH,BIRTH,DATE_SERV3)
		,AGE_MS4 = TIMESTAMPDIFF(MONTH,BIRTH,DATE_SERV4);
/*คำนวน Nutrition_CAL*/
UPDATE t_nutrition05 SET W_S1=nutri_cal(AGE_MS1,SEX,'1',HEIGHT1,WEIGHT1) WHERE AGE_MS1 >0 AND WEIGHT1 >0;
UPDATE t_nutrition05 SET W_S2=nutri_cal(AGE_MS2,SEX,'1',HEIGHT2,WEIGHT2) WHERE AGE_MS2 >0 AND WEIGHT2 >0;
UPDATE t_nutrition05 SET W_S3=nutri_cal(AGE_MS3,SEX,'1',HEIGHT3,WEIGHT3) WHERE AGE_MS3 >0 AND WEIGHT3 >0;
UPDATE t_nutrition05 SET W_S4=nutri_cal(AGE_MS4,SEX,'1',HEIGHT4,WEIGHT4) WHERE AGE_MS4 >0 AND WEIGHT4 >0;

UPDATE t_nutrition05 SET H_S1=nutri_cal(AGE_MS1,SEX,'2',HEIGHT1,WEIGHT1) WHERE AGE_MS1 >0  AND HEIGHT1 >0;
UPDATE t_nutrition05 SET H_S2=nutri_cal(AGE_MS2,SEX,'2',HEIGHT2,WEIGHT2) WHERE AGE_MS2 >0  AND HEIGHT2 >0;
UPDATE t_nutrition05 SET H_S3=nutri_cal(AGE_MS3,SEX,'2',HEIGHT3,WEIGHT3) WHERE AGE_MS3 >0  AND HEIGHT3 >0;
UPDATE t_nutrition05 SET H_S4=nutri_cal(AGE_MS4,SEX,'2',HEIGHT4,WEIGHT4) WHERE AGE_MS4 >0  AND HEIGHT4 >0;

UPDATE t_nutrition05 SET WH1=nutri_cal(AGE_MS1,SEX,'3',HEIGHT1,WEIGHT1) WHERE AGE_MS1 >0 AND WEIGHT1 >0 AND HEIGHT1 >0 ; 
UPDATE t_nutrition05 SET WH2=nutri_cal(AGE_MS2,SEX,'3',HEIGHT2,WEIGHT2) WHERE AGE_MS2 >0 AND WEIGHT2 >0 AND HEIGHT2 >0 ; 
UPDATE t_nutrition05 SET WH3=nutri_cal(AGE_MS3,SEX,'3',HEIGHT3,WEIGHT3) WHERE AGE_MS3 >0 AND WEIGHT3 >0 AND HEIGHT3 >0 ; 
UPDATE t_nutrition05 SET WH4=nutri_cal(AGE_MS4,SEX,'3',HEIGHT4,WEIGHT4) WHERE AGE_MS4 >0 AND WEIGHT4 >0 AND HEIGHT4 >0 ; 

 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.6124539;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:283;a:5:{i:0;s:37:"DROP PROCEDURE IF EXISTS t_nutrition6";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.6124539;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:284;a:5:{i:0;s:37:"DROP PROCEDURE IF EXISTS t_nutrition6";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.6592541;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:286;a:5:{i:0;s:3318:"CREATE PROCEDURE t_nutrition6()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '43';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
SET @start_te1=concat(@b_year-1,'1001');
SET @start_te2=concat(@b_year,'0501');
SET @end_te1=concat(@b_year-1,'1231');
SET @end_te2=concat(@b_year,'0731');

DROP TABLE IF EXISTS t_nutrition6up;
CREATE TABLE IF NOT EXISTS t_nutrition6up( 
		CID VARCHAR(13) NOT NULL,
		SEX VARCHAR(1) NOT NULL,
		BIRTH DATE  DEFAULT NULL,
		AGE_T1 VARCHAR(5)  DEFAULT NULL,
		AGE_T2 VARCHAR(5)  DEFAULT NULL,
		DATE_SERV1 DATE DEFAULT NULL,
		DATE_SERV2 DATE DEFAULT NULL,
		AGE_MS1 VARCHAR(5)  DEFAULT NULL,
		AGE_MS2 VARCHAR(5)  DEFAULT NULL,
		WEIGHT1 DECIMAL(5,1)  DEFAULT 0,
		WEIGHT2 DECIMAL(5,1)  DEFAULT 0,
		HEIGHT1 INT(3)  DEFAULT 0,
		HEIGHT2 INT(3)  DEFAULT 0,
		W_S1 VARCHAR(1)  DEFAULT NULL,
		W_S2 VARCHAR(1)  DEFAULT NULL,
		H_S1 VARCHAR(1)  DEFAULT NULL,
		H_S2 VARCHAR(1)  DEFAULT NULL,
		WH1 VARCHAR(1)  DEFAULT NULL,
		WH2 VARCHAR(1)  DEFAULT NULL,
		hospcode VARCHAR(5)  DEFAULT NULL,
		typearea VARCHAR(1)  DEFAULT NULL,
		PRIMARY KEY (CID)
) ENGINE MyISAM DEFAULT CHARACTER SET=utf8;
/*เพิ่มข้อมูลคน*/
INSERT IGNORE INTO t_nutrition6up (cid,birth,sex,AGE_T1,AGE_T2,hospcode,typearea)
SELECT
		p.cid,p.BIRTH,p.SEX
		,TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@end_te1,'%Y%m%d')) AGE_T1
		,TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@end_te2,'%Y%m%d')) AGE_T2
		,check_hosp,check_typearea
FROM  t_person_cid p 
WHERE  
		(
			TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@end_te1,'%Y%m%d'))  BETWEEN 6 AND 18 OR
			TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@end_te2,'%Y%m%d'))  BETWEEN 6 AND 18 
		)
 GROUP BY p.cid;

/*เพิ่มบริการตามไตรมาส*/
UPDATE t_nutrition6up p INNER JOIN 
(SELECT * FROM 
			(SELECT cid,DATE_SERV,WEIGHT,HEIGHT FROM tmp_nutrition 
				WHERE DATE_SERV BETWEEN @start_te1 AND @end_te1 
				ORDER BY DATE_SERV DESC ) as t1 GROUP BY cid) as n
ON p.cid=n.cid  SET p.DATE_SERV1=n.DATE_SERV ,p.HEIGHT1=n.height ,p.WEIGHT1=n.weight ;


UPDATE t_nutrition6up p INNER JOIN 
(SELECT * FROM 
			(SELECT cid,DATE_SERV,WEIGHT,HEIGHT FROM tmp_nutrition 
				WHERE DATE_SERV BETWEEN @start_te2 AND @end_te2
				ORDER BY DATE_SERV DESC ) as t1 GROUP BY cid) as n
ON p.cid=n.cid  SET p.DATE_SERV2=n.DATE_SERV ,p.HEIGHT2=n.height ,p.WEIGHT2=n.weight;

/*คำนวนอายุเป็นเดือนณวันรับบริการ*/
UPDATE t_nutrition6up  SET AGE_MS1 = TIMESTAMPDIFF(MONTH,BIRTH,DATE_SERV1)
		,AGE_MS2 = TIMESTAMPDIFF(MONTH,BIRTH,DATE_SERV2);
/*คำนวน Nutrition_CAL*/
UPDATE t_nutrition6up SET W_S1=nutri_cal(AGE_MS1,SEX,'1',HEIGHT1,WEIGHT1) WHERE AGE_MS1 >1;
UPDATE t_nutrition6up SET W_S2=nutri_cal(AGE_MS2,SEX,'1',HEIGHT2,WEIGHT2) WHERE AGE_MS2 >1;

UPDATE t_nutrition6up SET H_S1=nutri_cal(AGE_MS1,SEX,'2',HEIGHT1,WEIGHT1) WHERE AGE_MS1 >1;
UPDATE t_nutrition6up SET H_S2=nutri_cal(AGE_MS2,SEX,'2',HEIGHT2,WEIGHT2) WHERE AGE_MS2 >1;

UPDATE t_nutrition6up SET WH1=nutri_cal(AGE_MS1,SEX,'3',HEIGHT1,WEIGHT1) WHERE AGE_MS1 >1;
UPDATE t_nutrition6up SET WH2=nutri_cal(AGE_MS2,SEX,'3',HEIGHT2,WEIGHT2) WHERE AGE_MS2 >1;

 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.6592541;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:287;a:5:{i:0;s:3318:"CREATE PROCEDURE t_nutrition6()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '43';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
SET @start_te1=concat(@b_year-1,'1001');
SET @start_te2=concat(@b_year,'0501');
SET @end_te1=concat(@b_year-1,'1231');
SET @end_te2=concat(@b_year,'0731');

DROP TABLE IF EXISTS t_nutrition6up;
CREATE TABLE IF NOT EXISTS t_nutrition6up( 
		CID VARCHAR(13) NOT NULL,
		SEX VARCHAR(1) NOT NULL,
		BIRTH DATE  DEFAULT NULL,
		AGE_T1 VARCHAR(5)  DEFAULT NULL,
		AGE_T2 VARCHAR(5)  DEFAULT NULL,
		DATE_SERV1 DATE DEFAULT NULL,
		DATE_SERV2 DATE DEFAULT NULL,
		AGE_MS1 VARCHAR(5)  DEFAULT NULL,
		AGE_MS2 VARCHAR(5)  DEFAULT NULL,
		WEIGHT1 DECIMAL(5,1)  DEFAULT 0,
		WEIGHT2 DECIMAL(5,1)  DEFAULT 0,
		HEIGHT1 INT(3)  DEFAULT 0,
		HEIGHT2 INT(3)  DEFAULT 0,
		W_S1 VARCHAR(1)  DEFAULT NULL,
		W_S2 VARCHAR(1)  DEFAULT NULL,
		H_S1 VARCHAR(1)  DEFAULT NULL,
		H_S2 VARCHAR(1)  DEFAULT NULL,
		WH1 VARCHAR(1)  DEFAULT NULL,
		WH2 VARCHAR(1)  DEFAULT NULL,
		hospcode VARCHAR(5)  DEFAULT NULL,
		typearea VARCHAR(1)  DEFAULT NULL,
		PRIMARY KEY (CID)
) ENGINE MyISAM DEFAULT CHARACTER SET=utf8;
/*เพิ่มข้อมูลคน*/
INSERT IGNORE INTO t_nutrition6up (cid,birth,sex,AGE_T1,AGE_T2,hospcode,typearea)
SELECT
		p.cid,p.BIRTH,p.SEX
		,TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@end_te1,'%Y%m%d')) AGE_T1
		,TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@end_te2,'%Y%m%d')) AGE_T2
		,check_hosp,check_typearea
FROM  t_person_cid p 
WHERE  
		(
			TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@end_te1,'%Y%m%d'))  BETWEEN 6 AND 18 OR
			TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@end_te2,'%Y%m%d'))  BETWEEN 6 AND 18 
		)
 GROUP BY p.cid;

/*เพิ่มบริการตามไตรมาส*/
UPDATE t_nutrition6up p INNER JOIN 
(SELECT * FROM 
			(SELECT cid,DATE_SERV,WEIGHT,HEIGHT FROM tmp_nutrition 
				WHERE DATE_SERV BETWEEN @start_te1 AND @end_te1 
				ORDER BY DATE_SERV DESC ) as t1 GROUP BY cid) as n
ON p.cid=n.cid  SET p.DATE_SERV1=n.DATE_SERV ,p.HEIGHT1=n.height ,p.WEIGHT1=n.weight ;


UPDATE t_nutrition6up p INNER JOIN 
(SELECT * FROM 
			(SELECT cid,DATE_SERV,WEIGHT,HEIGHT FROM tmp_nutrition 
				WHERE DATE_SERV BETWEEN @start_te2 AND @end_te2
				ORDER BY DATE_SERV DESC ) as t1 GROUP BY cid) as n
ON p.cid=n.cid  SET p.DATE_SERV2=n.DATE_SERV ,p.HEIGHT2=n.height ,p.WEIGHT2=n.weight;

/*คำนวนอายุเป็นเดือนณวันรับบริการ*/
UPDATE t_nutrition6up  SET AGE_MS1 = TIMESTAMPDIFF(MONTH,BIRTH,DATE_SERV1)
		,AGE_MS2 = TIMESTAMPDIFF(MONTH,BIRTH,DATE_SERV2);
/*คำนวน Nutrition_CAL*/
UPDATE t_nutrition6up SET W_S1=nutri_cal(AGE_MS1,SEX,'1',HEIGHT1,WEIGHT1) WHERE AGE_MS1 >1;
UPDATE t_nutrition6up SET W_S2=nutri_cal(AGE_MS2,SEX,'1',HEIGHT2,WEIGHT2) WHERE AGE_MS2 >1;

UPDATE t_nutrition6up SET H_S1=nutri_cal(AGE_MS1,SEX,'2',HEIGHT1,WEIGHT1) WHERE AGE_MS1 >1;
UPDATE t_nutrition6up SET H_S2=nutri_cal(AGE_MS2,SEX,'2',HEIGHT2,WEIGHT2) WHERE AGE_MS2 >1;

UPDATE t_nutrition6up SET WH1=nutri_cal(AGE_MS1,SEX,'3',HEIGHT1,WEIGHT1) WHERE AGE_MS1 >1;
UPDATE t_nutrition6up SET WH2=nutri_cal(AGE_MS2,SEX,'3',HEIGHT2,WEIGHT2) WHERE AGE_MS2 >1;

 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.7216539;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:289;a:5:{i:0;s:38:"DROP PROCEDURE IF EXISTS t_nutrition15";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.7216539;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:290;a:5:{i:0;s:38:"DROP PROCEDURE IF EXISTS t_nutrition15";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.784054;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:292;a:5:{i:0;s:2321:"CREATE PROCEDURE t_nutrition15()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '44';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS t_nutrition15up;
CREATE TABLE IF NOT EXISTS t_nutrition15up( 
		CID VARCHAR(13) NOT NULL,
		SEX VARCHAR(1) NOT NULL,
		BIRTH DATE  DEFAULT NULL,
		AGE_Y VARCHAR(5)  DEFAULT NULL,
		AGE_YS VARCHAR(5)  DEFAULT NULL,
		DATE_SERV DATE DEFAULT NULL,		
		WEIGHT DECIMAL(5,1)  DEFAULT 0,
		HEIGHT INT(3)  DEFAULT 0,
		L_BMI DECIMAL(10,1)  DEFAULT 0,
		L_WAIST INT(3)  DEFAULT 0,
		hospcode VARCHAR(5)  DEFAULT NULL,
		typearea VARCHAR(1)  DEFAULT NULL,
		PRIMARY KEY (CID)
) ENGINE MyISAM DEFAULT CHARACTER SET=utf8;
/*เพิ่มข้อมูลคน*/
INSERT IGNORE INTO t_nutrition15up (cid,birth,sex,age_y,hospcode,typearea)
SELECT
		p.cid,p.BIRTH,p.SEX,age_y	,check_hosp,check_typearea
FROM  t_person_cid p 
WHERE  TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@start_d,'%Y%m%d'))  >=15 
 GROUP BY p.cid;

UPDATE t_nutrition15up p INNER JOIN 
(SELECT * FROM 
			(SELECT cid,DATE_SERV,WEIGHT,HEIGHT FROM tmp_nutrition 
				WHERE DATE_SERV BETWEEN @start_d AND @end_d
				ORDER BY DATE_SERV DESC ) as t1 GROUP BY cid) as n
ON p.cid=n.cid  SET p.DATE_SERV=n.DATE_SERV , p.HEIGHT=n.height , p.WEIGHT=n.weight;

UPDATE t_nutrition15up p INNER JOIN 
(SELECT * FROM 
			(SELECT cid,DATE_SERV,WEIGHT,HEIGHT,WAIST_CM FROM tmp_ncdscreen 
				WHERE DATE_SERV BETWEEN @start_d AND @end_d
				ORDER BY DATE_SERV DESC ) as t1 GROUP BY cid) as n
ON p.cid=n.cid  SET p.DATE_SERV=n.DATE_SERV ,p.HEIGHT=n.height ,p.WEIGHT=n.weight,p.L_WAIST=n.WAIST_CM
WHERE p.WEIGHT in(0) OR p.HEIGHT in(0) OR p.date_serv < n.date_serv;


UPDATE t_nutrition15up p INNER JOIN 
(SELECT * FROM 
			(SELECT cid,DATE_SERV,WEIGHT,HEIGHT,WAIST_CM FROM tmp_ncdscreen 
				WHERE DATE_SERV BETWEEN @start_d AND @end_d
				ORDER BY DATE_SERV DESC ) as t1 GROUP BY cid) as n
ON p.cid=n.cid  SET p.DATE_SERV=n.DATE_SERV ,p.HEIGHT=n.height ,p.WEIGHT=n.weight,p.L_WAIST=n.WAIST_CM
WHERE p.L_WAIST in(0) AND n.WAIST_CM >0;

UPDATE t_nutrition15up SET AGE_YS=TIMESTAMPDIFF(YEAR,birth,date_serv);

UPDATE t_nutrition15up SET L_BMI=round(WEIGHT/((HEIGHT/100)*(HEIGHT/100)),2) ;
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.784054;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:293;a:5:{i:0;s:2321:"CREATE PROCEDURE t_nutrition15()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '44';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS t_nutrition15up;
CREATE TABLE IF NOT EXISTS t_nutrition15up( 
		CID VARCHAR(13) NOT NULL,
		SEX VARCHAR(1) NOT NULL,
		BIRTH DATE  DEFAULT NULL,
		AGE_Y VARCHAR(5)  DEFAULT NULL,
		AGE_YS VARCHAR(5)  DEFAULT NULL,
		DATE_SERV DATE DEFAULT NULL,		
		WEIGHT DECIMAL(5,1)  DEFAULT 0,
		HEIGHT INT(3)  DEFAULT 0,
		L_BMI DECIMAL(10,1)  DEFAULT 0,
		L_WAIST INT(3)  DEFAULT 0,
		hospcode VARCHAR(5)  DEFAULT NULL,
		typearea VARCHAR(1)  DEFAULT NULL,
		PRIMARY KEY (CID)
) ENGINE MyISAM DEFAULT CHARACTER SET=utf8;
/*เพิ่มข้อมูลคน*/
INSERT IGNORE INTO t_nutrition15up (cid,birth,sex,age_y,hospcode,typearea)
SELECT
		p.cid,p.BIRTH,p.SEX,age_y	,check_hosp,check_typearea
FROM  t_person_cid p 
WHERE  TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@start_d,'%Y%m%d'))  >=15 
 GROUP BY p.cid;

UPDATE t_nutrition15up p INNER JOIN 
(SELECT * FROM 
			(SELECT cid,DATE_SERV,WEIGHT,HEIGHT FROM tmp_nutrition 
				WHERE DATE_SERV BETWEEN @start_d AND @end_d
				ORDER BY DATE_SERV DESC ) as t1 GROUP BY cid) as n
ON p.cid=n.cid  SET p.DATE_SERV=n.DATE_SERV , p.HEIGHT=n.height , p.WEIGHT=n.weight;

UPDATE t_nutrition15up p INNER JOIN 
(SELECT * FROM 
			(SELECT cid,DATE_SERV,WEIGHT,HEIGHT,WAIST_CM FROM tmp_ncdscreen 
				WHERE DATE_SERV BETWEEN @start_d AND @end_d
				ORDER BY DATE_SERV DESC ) as t1 GROUP BY cid) as n
ON p.cid=n.cid  SET p.DATE_SERV=n.DATE_SERV ,p.HEIGHT=n.height ,p.WEIGHT=n.weight,p.L_WAIST=n.WAIST_CM
WHERE p.WEIGHT in(0) OR p.HEIGHT in(0) OR p.date_serv < n.date_serv;


UPDATE t_nutrition15up p INNER JOIN 
(SELECT * FROM 
			(SELECT cid,DATE_SERV,WEIGHT,HEIGHT,WAIST_CM FROM tmp_ncdscreen 
				WHERE DATE_SERV BETWEEN @start_d AND @end_d
				ORDER BY DATE_SERV DESC ) as t1 GROUP BY cid) as n
ON p.cid=n.cid  SET p.DATE_SERV=n.DATE_SERV ,p.HEIGHT=n.height ,p.WEIGHT=n.weight,p.L_WAIST=n.WAIST_CM
WHERE p.L_WAIST in(0) AND n.WAIST_CM >0;

UPDATE t_nutrition15up SET AGE_YS=TIMESTAMPDIFF(YEAR,birth,date_serv);

UPDATE t_nutrition15up SET L_BMI=round(WEIGHT/((HEIGHT/100)*(HEIGHT/100)),2) ;
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.8308539;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:295;a:5:{i:0;s:29:"DROP PROCEDURE IF EXISTS t_tb";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.8308539;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:296;a:5:{i:0;s:29:"DROP PROCEDURE IF EXISTS t_tb";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.893255;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:298;a:5:{i:0;s:5636:"CREATE PROCEDURE t_tb()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '45';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d1:=concat(@b_year-1,'0701');
SET @end_d1:=concat(@b_year-1,'0930');
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF  EXISTS tmp_tb;
CREATE TABLE IF NOT EXISTS tmp_tb (
  HOSPCODE varchar(5) NOT NULL,
  PID varchar(15) NOT NULL,
  CID varchar(13) DEFAULT NULL,
  BIRTH date,
  SEX varchar(1),
  NATION varchar(3),
	date_dx date,
  DIAGCODE varchar(6),
  DIAGTYPE char(1) NOT NULL,
	PERIOD VARCHAR(1),
	source_tb VARCHAR(20) DEFAULT NULL,
	group_tb VARCHAR(1) DEFAULT NULL,
PRIMARY KEY (hospcode,pid,date_dx,diagcode),
KEY (hospcode),
KEY (pid),
KEY (cid),
KEY (date_dx),
KEY (diagcode),
KEY (source_tb)
)ENGINE=MyISAM  AS(
SELECT
 i.HOSPCODE,i.PID,p.CID,p.BIRTH,p.SEX,p.NATION,DATE_FORMAT(i.datetime_disch,'%Y%m%d') date_dx
 ,i.DIAGCODE,i.DIAGTYPE,'diag_ipd' as source_tb,NULL as PERIOD,NULL as group_tb
FROM
tmp_diag_ipd i 
 LEFT JOIN tmp_admission a ON a.HOSPCODE=i.HOSPCODE AND a.AN=i.AN
 LEFT JOIN person p ON  i.HOSPCODE=p.HOSPCODE AND i.PID=p.PID
WHERE
	substr(diagcode,1,3)  in('A15','A16','A17','A18','A19','U88','U89')
AND DATE_FORMAT(i.datetime_disch,'%Y%m%d')  BETWEEN @start_d1 AND @end_d
GROUP BY hospcode,pid,date_dx,diagcode
);

INSERT IGNORE INTO tmp_tb (
SELECT
 o.HOSPCODE,o.PID,p.CID,p.BIRTH,p.SEX,p.NATION,o.date_serv date_dx
 ,o.DIAGCODE,o.DIAGTYPE,'diag_opd' as source_tb,NULL as PERIOD,NULL as group_tb
FROM
tmp_diag_opd o 
 LEFT JOIN person p ON  o.HOSPCODE=p.HOSPCODE AND o.PID=p.PID
WHERE
	substr(diagcode,1,3)  in('A15','A16','A17','A18','A19','U88','U89')
AND o.DATE_SERV  BETWEEN @start_d1 AND @end_d
GROUP BY hospcode,pid,date_dx,diagcode
);

/*up period*/
UPDATE tmp_tb SET PERIOD='0'
WHERE date_dx BETWEEN @start_d1 AND  @end_d1;
UPDATE tmp_tb SET PERIOD='1'
WHERE date_dx BETWEEN  concat(@b_year-1,'1001') AND  concat(@b_year-1,'1231');
UPDATE tmp_tb SET PERIOD='2'
WHERE date_dx BETWEEN  concat(@b_year,'0101') AND  concat(@b_year,'0331');
UPDATE tmp_tb SET PERIOD='3'
WHERE date_dx BETWEEN  concat(@b_year,'0401') AND  concat(@b_year,'0630');
UPDATE tmp_tb SET PERIOD='4'
WHERE date_dx BETWEEN  concat(@b_year,'0701') AND  concat(@b_year,'0930');

/*upgroup*/
UPDATE tmp_tb SET group_tb='1'
WHERE diagcode in('A150','A151','A157');
UPDATE tmp_tb SET group_tb='2'
WHERE diagcode in('A160','A161','A152','A153','A162','A169');
UPDATE tmp_tb SET group_tb='3'
WHERE diagcode in('A154','A155','A156','A158','A159','A163','A164','A165','A167','A168') 
		OR substr(diagcode,1,3) in('A17','A18');

/*ทะเบียน TB สะสม*/
CREATE TABLE IF NOT EXISTS t_person_tb (
HOSPCODE  VARCHAR(5) DEFAULT NULL,
PID  VARCHAR(20) DEFAULT NULL,
CID  VARCHAR(13),
BIRTH DATE DEFAULT NULL,
SEX VARCHAR(1) DEFAULT NULL,
NATION VARCHAR(3) DEFAULT NULL,
DATE_DX DATE DEFAULT NULL,
DIAGCODE VARCHAR(7),
SOURCE_TB VARCHAR(20) DEFAULT NULL,
GROUP_tb  VARCHAR(1) DEFAULT NULL,
HOSP_DX  VARCHAR(5) DEFAULT NULL,
PRIMARY KEY (cid,diagcode),
KEY (hospcode),
KEY (pid),
KEY (cid),
KEY (date_dx),
KEY (diagcode),
KEY (GROUP_tb),
KEY (source_tb)
)ENGINE=MyISAM DEFAULT CHARSET=utf8;
REPLACE  INTO t_person_tb (
SELECT
 input_hosp,input_pid,cid,birth,sex,nation,date_dx 
,diagcode, source_tb,'0' as group_tb,hosp_dx
FROM
t_chronic
WHERE substr(diagcode,1,3)  in('A15','A16','A17','A18','A19','U88','U89') 
);
/*upgroup*/
UPDATE t_person_tb SET group_tb='1'
WHERE diagcode in('A150','A151','A157');
UPDATE t_person_tb SET group_tb='2'
WHERE diagcode in('A160','A161','A152','A153','A162','A169');
UPDATE t_person_tb SET group_tb='3'
WHERE diagcode in('A154','A155','A156','A158','A159','A163','A164','A165','A167','A168') 
		OR substr(diagcode,1,3) in('A17','A18');

/*ทะเบียนผู้ป่วยใหม่*/
DROP TABLE IF  EXISTS t_tb;
CREATE TABLE IF NOT EXISTS t_tb (
HOSPCODE  VARCHAR(5) DEFAULT NULL,
PID  VARCHAR(20) DEFAULT NULL,
CID  VARCHAR(13),
BIRTH DATE DEFAULT NULL,
SEX VARCHAR(1) DEFAULT NULL,
NATION VARCHAR(3) DEFAULT NULL,
DATE_DX DATE DEFAULT NULL,
DIAGCODE VARCHAR(7) DEFAULT NULL,
DIAGTYPE VARCHAR(1) DEFAULT NULL,
SOURCE_TB VARCHAR(20) DEFAULT NULL,
PERIOD VARCHAR(1),
GROUP_tb  VARCHAR(1) DEFAULT NULL,
PRIMARY KEY (cid,PERIOD),
KEY (hospcode),
KEY (pid),
KEY (cid),
KEY (date_dx),
KEY (diagcode),
KEY (GROUP_tb),
KEY (source_tb)
)ENGINE=MyISAM DEFAULT CHARSET=utf8;
/*จากผู้ป่วยเดิมที่มีอยู่เพื่อตัดรายเก่าออกมาเป็นกลับเป็นซ้ำ*/
INSERT IGNORE INTO t_tb (
SELECT
 hospcode,pid,cid,birth,sex,nation,date_dx 
,diagcode, null DIAGTYPE, source_tb,'0' as PERIOD ,group_tb
FROM
t_person_tb
WHERE  date_dx <  @end_d1
);
/*นำเข้า โดยให้ความสำคัญ diag_ipd ก่อน*/
INSERT IGNORE INTO t_tb (
SELECT
HOSPCODE,PID,CID,BIRTH,SEX,NATION,date_dx
 ,DIAGCODE,DIAGTYPE,source_tb,PERIOD,group_tb
FROM
tmp_tb
WHERE  date_dx BETWEEN  @start_d AND  @end_d AND source_tb='diag_ipd' AND group_tb in(1,2,3)
ORDER BY PERIOD,DATE_DX,CID
);

/*นำเข้า โดยให้ความสำคัญ diag_ipd ก่อน*/
INSERT IGNORE INTO t_tb (
SELECT
HOSPCODE,PID,CID,BIRTH,SEX,NATION,date_dx
 ,DIAGCODE,DIAGTYPE,source_tb,PERIOD,group_tb
FROM
tmp_tb
WHERE  date_dx BETWEEN  @start_d AND  @end_d AND source_tb='diag_opd' AND group_tb in(1,2,3)
ORDER BY PERIOD,DATE_DX,CID
);
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.893255;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:299;a:5:{i:0;s:5636:"CREATE PROCEDURE t_tb()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '45';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d1:=concat(@b_year-1,'0701');
SET @end_d1:=concat(@b_year-1,'0930');
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF  EXISTS tmp_tb;
CREATE TABLE IF NOT EXISTS tmp_tb (
  HOSPCODE varchar(5) NOT NULL,
  PID varchar(15) NOT NULL,
  CID varchar(13) DEFAULT NULL,
  BIRTH date,
  SEX varchar(1),
  NATION varchar(3),
	date_dx date,
  DIAGCODE varchar(6),
  DIAGTYPE char(1) NOT NULL,
	PERIOD VARCHAR(1),
	source_tb VARCHAR(20) DEFAULT NULL,
	group_tb VARCHAR(1) DEFAULT NULL,
PRIMARY KEY (hospcode,pid,date_dx,diagcode),
KEY (hospcode),
KEY (pid),
KEY (cid),
KEY (date_dx),
KEY (diagcode),
KEY (source_tb)
)ENGINE=MyISAM  AS(
SELECT
 i.HOSPCODE,i.PID,p.CID,p.BIRTH,p.SEX,p.NATION,DATE_FORMAT(i.datetime_disch,'%Y%m%d') date_dx
 ,i.DIAGCODE,i.DIAGTYPE,'diag_ipd' as source_tb,NULL as PERIOD,NULL as group_tb
FROM
tmp_diag_ipd i 
 LEFT JOIN tmp_admission a ON a.HOSPCODE=i.HOSPCODE AND a.AN=i.AN
 LEFT JOIN person p ON  i.HOSPCODE=p.HOSPCODE AND i.PID=p.PID
WHERE
	substr(diagcode,1,3)  in('A15','A16','A17','A18','A19','U88','U89')
AND DATE_FORMAT(i.datetime_disch,'%Y%m%d')  BETWEEN @start_d1 AND @end_d
GROUP BY hospcode,pid,date_dx,diagcode
);

INSERT IGNORE INTO tmp_tb (
SELECT
 o.HOSPCODE,o.PID,p.CID,p.BIRTH,p.SEX,p.NATION,o.date_serv date_dx
 ,o.DIAGCODE,o.DIAGTYPE,'diag_opd' as source_tb,NULL as PERIOD,NULL as group_tb
FROM
tmp_diag_opd o 
 LEFT JOIN person p ON  o.HOSPCODE=p.HOSPCODE AND o.PID=p.PID
WHERE
	substr(diagcode,1,3)  in('A15','A16','A17','A18','A19','U88','U89')
AND o.DATE_SERV  BETWEEN @start_d1 AND @end_d
GROUP BY hospcode,pid,date_dx,diagcode
);

/*up period*/
UPDATE tmp_tb SET PERIOD='0'
WHERE date_dx BETWEEN @start_d1 AND  @end_d1;
UPDATE tmp_tb SET PERIOD='1'
WHERE date_dx BETWEEN  concat(@b_year-1,'1001') AND  concat(@b_year-1,'1231');
UPDATE tmp_tb SET PERIOD='2'
WHERE date_dx BETWEEN  concat(@b_year,'0101') AND  concat(@b_year,'0331');
UPDATE tmp_tb SET PERIOD='3'
WHERE date_dx BETWEEN  concat(@b_year,'0401') AND  concat(@b_year,'0630');
UPDATE tmp_tb SET PERIOD='4'
WHERE date_dx BETWEEN  concat(@b_year,'0701') AND  concat(@b_year,'0930');

/*upgroup*/
UPDATE tmp_tb SET group_tb='1'
WHERE diagcode in('A150','A151','A157');
UPDATE tmp_tb SET group_tb='2'
WHERE diagcode in('A160','A161','A152','A153','A162','A169');
UPDATE tmp_tb SET group_tb='3'
WHERE diagcode in('A154','A155','A156','A158','A159','A163','A164','A165','A167','A168') 
		OR substr(diagcode,1,3) in('A17','A18');

/*ทะเบียน TB สะสม*/
CREATE TABLE IF NOT EXISTS t_person_tb (
HOSPCODE  VARCHAR(5) DEFAULT NULL,
PID  VARCHAR(20) DEFAULT NULL,
CID  VARCHAR(13),
BIRTH DATE DEFAULT NULL,
SEX VARCHAR(1) DEFAULT NULL,
NATION VARCHAR(3) DEFAULT NULL,
DATE_DX DATE DEFAULT NULL,
DIAGCODE VARCHAR(7),
SOURCE_TB VARCHAR(20) DEFAULT NULL,
GROUP_tb  VARCHAR(1) DEFAULT NULL,
HOSP_DX  VARCHAR(5) DEFAULT NULL,
PRIMARY KEY (cid,diagcode),
KEY (hospcode),
KEY (pid),
KEY (cid),
KEY (date_dx),
KEY (diagcode),
KEY (GROUP_tb),
KEY (source_tb)
)ENGINE=MyISAM DEFAULT CHARSET=utf8;
REPLACE  INTO t_person_tb (
SELECT
 input_hosp,input_pid,cid,birth,sex,nation,date_dx 
,diagcode, source_tb,'0' as group_tb,hosp_dx
FROM
t_chronic
WHERE substr(diagcode,1,3)  in('A15','A16','A17','A18','A19','U88','U89') 
);
/*upgroup*/
UPDATE t_person_tb SET group_tb='1'
WHERE diagcode in('A150','A151','A157');
UPDATE t_person_tb SET group_tb='2'
WHERE diagcode in('A160','A161','A152','A153','A162','A169');
UPDATE t_person_tb SET group_tb='3'
WHERE diagcode in('A154','A155','A156','A158','A159','A163','A164','A165','A167','A168') 
		OR substr(diagcode,1,3) in('A17','A18');

/*ทะเบียนผู้ป่วยใหม่*/
DROP TABLE IF  EXISTS t_tb;
CREATE TABLE IF NOT EXISTS t_tb (
HOSPCODE  VARCHAR(5) DEFAULT NULL,
PID  VARCHAR(20) DEFAULT NULL,
CID  VARCHAR(13),
BIRTH DATE DEFAULT NULL,
SEX VARCHAR(1) DEFAULT NULL,
NATION VARCHAR(3) DEFAULT NULL,
DATE_DX DATE DEFAULT NULL,
DIAGCODE VARCHAR(7) DEFAULT NULL,
DIAGTYPE VARCHAR(1) DEFAULT NULL,
SOURCE_TB VARCHAR(20) DEFAULT NULL,
PERIOD VARCHAR(1),
GROUP_tb  VARCHAR(1) DEFAULT NULL,
PRIMARY KEY (cid,PERIOD),
KEY (hospcode),
KEY (pid),
KEY (cid),
KEY (date_dx),
KEY (diagcode),
KEY (GROUP_tb),
KEY (source_tb)
)ENGINE=MyISAM DEFAULT CHARSET=utf8;
/*จากผู้ป่วยเดิมที่มีอยู่เพื่อตัดรายเก่าออกมาเป็นกลับเป็นซ้ำ*/
INSERT IGNORE INTO t_tb (
SELECT
 hospcode,pid,cid,birth,sex,nation,date_dx 
,diagcode, null DIAGTYPE, source_tb,'0' as PERIOD ,group_tb
FROM
t_person_tb
WHERE  date_dx <  @end_d1
);
/*นำเข้า โดยให้ความสำคัญ diag_ipd ก่อน*/
INSERT IGNORE INTO t_tb (
SELECT
HOSPCODE,PID,CID,BIRTH,SEX,NATION,date_dx
 ,DIAGCODE,DIAGTYPE,source_tb,PERIOD,group_tb
FROM
tmp_tb
WHERE  date_dx BETWEEN  @start_d AND  @end_d AND source_tb='diag_ipd' AND group_tb in(1,2,3)
ORDER BY PERIOD,DATE_DX,CID
);

/*นำเข้า โดยให้ความสำคัญ diag_ipd ก่อน*/
INSERT IGNORE INTO t_tb (
SELECT
HOSPCODE,PID,CID,BIRTH,SEX,NATION,date_dx
 ,DIAGCODE,DIAGTYPE,source_tb,PERIOD,group_tb
FROM
tmp_tb
WHERE  date_dx BETWEEN  @start_d AND  @end_d AND source_tb='diag_opd' AND group_tb in(1,2,3)
ORDER BY PERIOD,DATE_DX,CID
);
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.9556551;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:301;a:5:{i:0;s:36:"DROP PROCEDURE IF EXISTS t_refer_sp5";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.9556551;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:302;a:5:{i:0;s:36:"DROP PROCEDURE IF EXISTS t_refer_sp5";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.018055;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:304;a:5:{i:0;s:3868:"CREATE PROCEDURE t_refer_sp5()
 BEGIN 
SET @prov_c := '58';
SET @id := '46';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-2,'1001');
SET @end_d:=concat(@b_year,'0930');
DROP TABLE IF EXISTS t_refer_sp5;
CREATE TABLE IF NOT EXISTS t_refer_sp5 (
hospcode VARCHAR(5),
splevel VARCHAR(2) DEFAULT NULL,
pid VARCHAR(15),
cid VARCHAR(13) DEFAULT NULL,
seq VARCHAR(15) DEFAULT NULL,
an VARCHAR(15) DEFAULT NULL,
date_serv date,
sp_code VARCHAR(7) DEFAULT NULL,
source VARCHAR(15) DEFAULT NULL,
referin_hospcode VARCHAR(5) DEFAULT NULL,
referin_splevel VARCHAR(2) DEFAULT NULL,
typein VARCHAR(2) DEFAULT NULL,
clinic VARCHAR(3) DEFAULT NULL,
PRIMARY KEY (hospcode,pid,date_serv),
KEY (sp_code),
KEY (referin_hospcode),
KEY (typein)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;
/*สูติกรรม  */
INSERT IGNORE INTO  t_refer_sp5 
( 
hospcode,pid,an,date_serv,sp_code,source,clinic
)
(
SELECT HOSPCODE,PID,AN,DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d'),PROCEDCODE,'proced_ipd','1'
FROM procedure_ipd
WHERE DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d')  BETWEEN @start_d AND @end_d
	AND (SUBSTR(PROCEDCODE,1,3) BETWEEN '740' AND '744' 
	OR PROCEDCODE in('7491','7499'))
);
/*ศัลยกรรม*/
INSERT IGNORE INTO  t_refer_sp5 
( 
hospcode,pid,an,date_serv,sp_code,source,clinic
)
(
SELECT HOSPCODE,PID,AN,DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d'),PROCEDCODE,'proced_ipd','2'
FROM procedure_ipd
WHERE DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d')  BETWEEN @start_d AND @end_d
	AND PROCEDCODE BETWEEN '4701' AND '4719'
);

/*อายุรกรรม*/
INSERT IGNORE INTO  t_refer_sp5 
( 
hospcode,pid,an,date_serv,sp_code,source,clinic
)
(
SELECT HOSPCODE,PID,AN,DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d'),DIAGCODE,'diag_ipd','3'
FROM diagnosis_ipd
WHERE DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d')  BETWEEN @start_d AND @end_d
	AND (SUBSTR(DIAGCODE,1,3) BETWEEN 'A40' AND 'A41' 
	OR SUBSTR(DIAGCODE,1,3) in('R65'))
);

/*กุมารเวชกรรม*/
INSERT IGNORE INTO  t_refer_sp5 
( 
hospcode,pid,an,date_serv,sp_code,source,clinic
)
(
SELECT HOSPCODE,PID,AN,DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d'),PROCEDCODE,'proced_ipd','4'
FROM procedure_ipd
WHERE DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d')  BETWEEN @start_d AND @end_d
	AND PROCEDCODE in('9671','9672','939')
	);

/*ออโธปิดิกส์*/
INSERT IGNORE INTO  t_refer_sp5 
( 
hospcode,pid,an,date_serv,sp_code,source,clinic
)
(
SELECT HOSPCODE,PID,AN,DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d'),DIAGCODE,'diag_ipd','5'
FROM diagnosis_ipd
WHERE DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d')  BETWEEN @start_d AND @end_d
	AND DIAGCODE in('S42000','S42100','S42200','S42300','S42400','S42700','S42800','S42900'
	,'S52000','S52100','S52200','S52300','S52400','S52500','S52600','S52700','S52800','S52900'
	,'S62000','S62100','S62200','S62300','S62400','S6250','S6260','S6270','S6280','S9200','S9210'
	,'S9220','S9230','S9240','S9250','S9270','S9290')
);
/*update cid*/
UPDATE t_refer_sp5 s INNER JOIN person p ON s.hospcode=p.hospcode AND s.pid=p.pid 
SET s.cid=p.cid;
/*update refer*/
UPDATE t_refer_sp5 s INNER JOIN admission a ON a.hospcode=s.hospcode AND a.an=s.an
SET s.referin_hospcode=a.referinhosp , s.typein=a.TYPEIN;
/*update refer*/
UPDATE t_refer_sp5 s INNER JOIN service a ON a.hospcode=s.hospcode AND a.pid=s.pid AND a.DATE_SERV=s.date_serv
SET s.referin_hospcode=a.referinhosp, s.typein=a.TYPEIN,s.seq=a.seq ;

/*update level*/
UPDATE t_refer_sp5 s INNER JOIN (SELECT hcode,splevel FROM ccmihosp WHERE byear = (@b_year+543) GROUP BY hcode) a 
	ON a.hcode=s.hospcode SET s.splevel=a.splevel;

/*update level*/
UPDATE t_refer_sp5 s INNER JOIN (SELECT hcode,splevel FROM ccmihosp WHERE byear = (@b_year+543) GROUP BY hcode) a 
	ON a.hcode=s.referin_hospcode SET s.referin_splevel=a.splevel;

 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.018055;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:305;a:5:{i:0;s:3868:"CREATE PROCEDURE t_refer_sp5()
 BEGIN 
SET @prov_c := '58';
SET @id := '46';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-2,'1001');
SET @end_d:=concat(@b_year,'0930');
DROP TABLE IF EXISTS t_refer_sp5;
CREATE TABLE IF NOT EXISTS t_refer_sp5 (
hospcode VARCHAR(5),
splevel VARCHAR(2) DEFAULT NULL,
pid VARCHAR(15),
cid VARCHAR(13) DEFAULT NULL,
seq VARCHAR(15) DEFAULT NULL,
an VARCHAR(15) DEFAULT NULL,
date_serv date,
sp_code VARCHAR(7) DEFAULT NULL,
source VARCHAR(15) DEFAULT NULL,
referin_hospcode VARCHAR(5) DEFAULT NULL,
referin_splevel VARCHAR(2) DEFAULT NULL,
typein VARCHAR(2) DEFAULT NULL,
clinic VARCHAR(3) DEFAULT NULL,
PRIMARY KEY (hospcode,pid,date_serv),
KEY (sp_code),
KEY (referin_hospcode),
KEY (typein)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;
/*สูติกรรม  */
INSERT IGNORE INTO  t_refer_sp5 
( 
hospcode,pid,an,date_serv,sp_code,source,clinic
)
(
SELECT HOSPCODE,PID,AN,DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d'),PROCEDCODE,'proced_ipd','1'
FROM procedure_ipd
WHERE DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d')  BETWEEN @start_d AND @end_d
	AND (SUBSTR(PROCEDCODE,1,3) BETWEEN '740' AND '744' 
	OR PROCEDCODE in('7491','7499'))
);
/*ศัลยกรรม*/
INSERT IGNORE INTO  t_refer_sp5 
( 
hospcode,pid,an,date_serv,sp_code,source,clinic
)
(
SELECT HOSPCODE,PID,AN,DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d'),PROCEDCODE,'proced_ipd','2'
FROM procedure_ipd
WHERE DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d')  BETWEEN @start_d AND @end_d
	AND PROCEDCODE BETWEEN '4701' AND '4719'
);

/*อายุรกรรม*/
INSERT IGNORE INTO  t_refer_sp5 
( 
hospcode,pid,an,date_serv,sp_code,source,clinic
)
(
SELECT HOSPCODE,PID,AN,DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d'),DIAGCODE,'diag_ipd','3'
FROM diagnosis_ipd
WHERE DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d')  BETWEEN @start_d AND @end_d
	AND (SUBSTR(DIAGCODE,1,3) BETWEEN 'A40' AND 'A41' 
	OR SUBSTR(DIAGCODE,1,3) in('R65'))
);

/*กุมารเวชกรรม*/
INSERT IGNORE INTO  t_refer_sp5 
( 
hospcode,pid,an,date_serv,sp_code,source,clinic
)
(
SELECT HOSPCODE,PID,AN,DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d'),PROCEDCODE,'proced_ipd','4'
FROM procedure_ipd
WHERE DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d')  BETWEEN @start_d AND @end_d
	AND PROCEDCODE in('9671','9672','939')
	);

/*ออโธปิดิกส์*/
INSERT IGNORE INTO  t_refer_sp5 
( 
hospcode,pid,an,date_serv,sp_code,source,clinic
)
(
SELECT HOSPCODE,PID,AN,DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d'),DIAGCODE,'diag_ipd','5'
FROM diagnosis_ipd
WHERE DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d')  BETWEEN @start_d AND @end_d
	AND DIAGCODE in('S42000','S42100','S42200','S42300','S42400','S42700','S42800','S42900'
	,'S52000','S52100','S52200','S52300','S52400','S52500','S52600','S52700','S52800','S52900'
	,'S62000','S62100','S62200','S62300','S62400','S6250','S6260','S6270','S6280','S9200','S9210'
	,'S9220','S9230','S9240','S9250','S9270','S9290')
);
/*update cid*/
UPDATE t_refer_sp5 s INNER JOIN person p ON s.hospcode=p.hospcode AND s.pid=p.pid 
SET s.cid=p.cid;
/*update refer*/
UPDATE t_refer_sp5 s INNER JOIN admission a ON a.hospcode=s.hospcode AND a.an=s.an
SET s.referin_hospcode=a.referinhosp , s.typein=a.TYPEIN;
/*update refer*/
UPDATE t_refer_sp5 s INNER JOIN service a ON a.hospcode=s.hospcode AND a.pid=s.pid AND a.DATE_SERV=s.date_serv
SET s.referin_hospcode=a.referinhosp, s.typein=a.TYPEIN,s.seq=a.seq ;

/*update level*/
UPDATE t_refer_sp5 s INNER JOIN (SELECT hcode,splevel FROM ccmihosp WHERE byear = (@b_year+543) GROUP BY hcode) a 
	ON a.hcode=s.hospcode SET s.splevel=a.splevel;

/*update level*/
UPDATE t_refer_sp5 s INNER JOIN (SELECT hcode,splevel FROM ccmihosp WHERE byear = (@b_year+543) GROUP BY hcode) a 
	ON a.hcode=s.referin_hospcode SET s.referin_splevel=a.splevel;

 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.0804551;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:307;a:5:{i:0;s:35:"DROP PROCEDURE IF EXISTS t_accident";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.0804551;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:308;a:5:{i:0;s:35:"DROP PROCEDURE IF EXISTS t_accident";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.127255;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:310;a:5:{i:0;s:602:"CREATE PROCEDURE t_accident()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '47';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF  EXISTS tmp_accident;
CREATE TABLE IF NOT EXISTS tmp_accident (
KEY (cid),
KEY (hospcode,pid),
KEY (hospcode,pid,seq),
KEY (DATETIME_SERV)
)ENGINE=MyISAM  AS(
SELECT
a.*,p.CID,p.BIRTH,p.SEX,p.NATION
FROM
accident a 
LEFT JOIN person p ON a.HOSPCODE=p.HOSPCODE AND a.PID=p.PID
WHERE DATE_FORMAT(a.DATETIME_SERV,'%Y%m%d') BETWEEN @start_d AND @end_d
);
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.127255;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:311;a:5:{i:0;s:602:"CREATE PROCEDURE t_accident()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '47';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF  EXISTS tmp_accident;
CREATE TABLE IF NOT EXISTS tmp_accident (
KEY (cid),
KEY (hospcode,pid),
KEY (hospcode,pid,seq),
KEY (DATETIME_SERV)
)ENGINE=MyISAM  AS(
SELECT
a.*,p.CID,p.BIRTH,p.SEX,p.NATION
FROM
accident a 
LEFT JOIN person p ON a.HOSPCODE=p.HOSPCODE AND a.PID=p.PID
WHERE DATE_FORMAT(a.DATETIME_SERV,'%Y%m%d') BETWEEN @start_d AND @end_d
);
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.190655;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:313;a:5:{i:0;s:33:"DROP PROCEDURE IF EXISTS t_dental";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.190655;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:314;a:5:{i:0;s:33:"DROP PROCEDURE IF EXISTS t_dental";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.2374549;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:316;a:5:{i:0;s:2160:"CREATE PROCEDURE t_dental()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '48';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-2,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF  EXISTS tmp_dental;
CREATE TABLE IF NOT EXISTS tmp_dental 
(
PRIMARY KEY (HOSPCODE,PID,SEQ),
KEY (HOSPCODE ,PID),
KEY (HOSPCODE),
KEY (DATE_SERV),
KEY (DENTTYPE),
KEY (CLASS),
KEY (HOSPCODE,PROVIDER),
KEY (CID)
)ENGINE=MyISAM  AS(
SELECT
		d.*,p.cid
FROM
		dental d 
		LEFT JOIN person p ON d.HOSPCODE=p.HOSPCODE AND d.PID=p.PID
 WHERE
			DATE_FORMAT(d.date_serv,'%Y%m%d')  BETWEEN @start_d AND @end_d
GROUP BY HOSPCODE,PID,SEQ
);

DROP TABLE IF  EXISTS tmp_dental_last;
CREATE TABLE IF NOT EXISTS tmp_dental_last 
(
 HOSPCODE varchar(5) NOT NULL,
  PID varchar(15) NOT NULL,
  SEQ varchar(16) NOT NULL,
  DATE_SERV date NOT NULL,
  DENTTYPE varchar(1) NOT NULL,
  SERVPLACE varchar(1) NOT NULL,
  PTEETH int(2) DEFAULT NULL,
  PCARIES int(2) DEFAULT NULL,
  PFILLING int(2) DEFAULT NULL,
  PEXTRACT int(2) DEFAULT NULL,
  DTEETH int(2) DEFAULT NULL,
  DCARIES int(2) DEFAULT NULL,
  DFILLING int(2) DEFAULT NULL,
  DEXTRACT int(2) DEFAULT NULL,
  NEED_FLUORIDE char(1) DEFAULT NULL,
  NEED_SCALING char(1) DEFAULT NULL,
  NEED_SEALANT int(2) DEFAULT NULL,
  NEED_PFILLING int(2) DEFAULT NULL,
  NEED_DFILLING int(2) DEFAULT NULL,
  NEED_PEXTRACT int(2) DEFAULT NULL,
  NEED_DEXTRACT int(2) DEFAULT NULL,
  NPROSTHESIS char(1) DEFAULT NULL,
  PERMANENT_PERMANENT smallint(6) DEFAULT NULL,
  PERMANENT_PROSTHESIS smallint(6) DEFAULT NULL,
  PROSTHESIS_PROSTHESIS smallint(6) DEFAULT NULL,
  GUM varchar(6) DEFAULT NULL,
  SCHOOLTYPE char(1) DEFAULT NULL,
  CLASS char(1) DEFAULT NULL,
  PROVIDER varchar(15) DEFAULT NULL,
  D_UPDATE datetime NOT NULL,
CID varchar(13) DEFAULT NULL,
PRIMARY KEY (HOSPCODE,PID),
KEY (HOSPCODE ,PID),
KEY (HOSPCODE),
KEY (DATE_SERV),
KEY (DENTTYPE),
KEY (CLASS),
KEY (HOSPCODE,PROVIDER),
KEY (CID)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO tmp_dental_last (
	SELECT * FROM tmp_dental ORDER BY DATE_SERV DESC
);
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.2374549;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:317;a:5:{i:0;s:2160:"CREATE PROCEDURE t_dental()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '48';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-2,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF  EXISTS tmp_dental;
CREATE TABLE IF NOT EXISTS tmp_dental 
(
PRIMARY KEY (HOSPCODE,PID,SEQ),
KEY (HOSPCODE ,PID),
KEY (HOSPCODE),
KEY (DATE_SERV),
KEY (DENTTYPE),
KEY (CLASS),
KEY (HOSPCODE,PROVIDER),
KEY (CID)
)ENGINE=MyISAM  AS(
SELECT
		d.*,p.cid
FROM
		dental d 
		LEFT JOIN person p ON d.HOSPCODE=p.HOSPCODE AND d.PID=p.PID
 WHERE
			DATE_FORMAT(d.date_serv,'%Y%m%d')  BETWEEN @start_d AND @end_d
GROUP BY HOSPCODE,PID,SEQ
);

DROP TABLE IF  EXISTS tmp_dental_last;
CREATE TABLE IF NOT EXISTS tmp_dental_last 
(
 HOSPCODE varchar(5) NOT NULL,
  PID varchar(15) NOT NULL,
  SEQ varchar(16) NOT NULL,
  DATE_SERV date NOT NULL,
  DENTTYPE varchar(1) NOT NULL,
  SERVPLACE varchar(1) NOT NULL,
  PTEETH int(2) DEFAULT NULL,
  PCARIES int(2) DEFAULT NULL,
  PFILLING int(2) DEFAULT NULL,
  PEXTRACT int(2) DEFAULT NULL,
  DTEETH int(2) DEFAULT NULL,
  DCARIES int(2) DEFAULT NULL,
  DFILLING int(2) DEFAULT NULL,
  DEXTRACT int(2) DEFAULT NULL,
  NEED_FLUORIDE char(1) DEFAULT NULL,
  NEED_SCALING char(1) DEFAULT NULL,
  NEED_SEALANT int(2) DEFAULT NULL,
  NEED_PFILLING int(2) DEFAULT NULL,
  NEED_DFILLING int(2) DEFAULT NULL,
  NEED_PEXTRACT int(2) DEFAULT NULL,
  NEED_DEXTRACT int(2) DEFAULT NULL,
  NPROSTHESIS char(1) DEFAULT NULL,
  PERMANENT_PERMANENT smallint(6) DEFAULT NULL,
  PERMANENT_PROSTHESIS smallint(6) DEFAULT NULL,
  PROSTHESIS_PROSTHESIS smallint(6) DEFAULT NULL,
  GUM varchar(6) DEFAULT NULL,
  SCHOOLTYPE char(1) DEFAULT NULL,
  CLASS char(1) DEFAULT NULL,
  PROVIDER varchar(15) DEFAULT NULL,
  D_UPDATE datetime NOT NULL,
CID varchar(13) DEFAULT NULL,
PRIMARY KEY (HOSPCODE,PID),
KEY (HOSPCODE ,PID),
KEY (HOSPCODE),
KEY (DATE_SERV),
KEY (DENTTYPE),
KEY (CLASS),
KEY (HOSPCODE,PROVIDER),
KEY (CID)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO tmp_dental_last (
	SELECT * FROM tmp_dental ORDER BY DATE_SERV DESC
);
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.299855;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:319;a:5:{i:0;s:36:"DROP PROCEDURE IF EXISTS t_all_alien";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.299855;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:320;a:5:{i:0;s:36:"DROP PROCEDURE IF EXISTS t_all_alien";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.3466549;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:322;a:5:{i:0;s:1672:"CREATE PROCEDURE t_all_alien()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '49';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
DROP TABLE IF EXISTS t_all_labor;
CREATE TABLE IF NOT EXISTS t_all_labor(
  HOSPCODE varchar(5) NOT NULL,
  PID varchar(15) NOT NULL,
	SEQ_AN varchar(15) NOT NULL,
  cid varchar(13) DEFAULT NULL,
  sex varchar(1) NOT NULL DEFAULT '',
  DATE_SERV date NOT NULL,
  INSTYPE varchar(4) NOT NULL,
  PRICE decimal(11,2) NOT NULL,
  PAYPRICE decimal(11,2) NOT NULL,
  ACTUALPAY decimal(11,2) NOT NULL,
  fee decimal(12,2) NOT NULL DEFAULT '0.00',
  LABOR varchar(2) DEFAULT NULL,
  NATION varchar(3) NOT NULL DEFAULT '',
	NATIONCODEAEC varchar(3) NOT NULL DEFAULT '',
  labor_group int(1) NOT NULL DEFAULT '0',
  diagcode varchar(8) NOT NULL DEFAULT '',
  diagtype varchar(1) NOT NULL DEFAULT '',
	source VARCHAR(50) DEFAULT NULL,
  KEY  (HOSPCODE,PID,SEQ_AN,DATE_SERV)
) ENGINE = myisam DEFAULT CHARSET=utf8;

INSERT IGNORE INTO t_all_labor (
SELECT
HOSPCODE,pid,seq,cid,sex,date_serv,INSTYPE,PRICE,PAYPRICE,ACTUALPAY,fee,LABOR,NATION,nationcodeaec,labor_group,diagcode,diagtype,'service' as 'source'
FROM t_service_labor 
);
INSERT IGNORE INTO  t_all_labor (
SELECT
HOSPCODE,'' as 'pid',an,cid,sex,DATE_FORMAT(DATETIME_DISCH,'%Y%m%d'),INSTYPE,PRICE,PAYPRICE,ACTUALPAY,fee,LABOR,NATION,nationcodeaec,labor_group,diagcode,diagtype,'admission' as 'source'
FROM t_admission_labor  
);
UPDATE t_all_labor l INNER JOIN tmp_admission a ON l.hospcode=a.hospcode AND l.seq_an=a.an 
SET l.pid=a.pid
WHERE l.source='admission';

 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.3466549;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:323;a:5:{i:0;s:1672:"CREATE PROCEDURE t_all_alien()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '49';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
DROP TABLE IF EXISTS t_all_labor;
CREATE TABLE IF NOT EXISTS t_all_labor(
  HOSPCODE varchar(5) NOT NULL,
  PID varchar(15) NOT NULL,
	SEQ_AN varchar(15) NOT NULL,
  cid varchar(13) DEFAULT NULL,
  sex varchar(1) NOT NULL DEFAULT '',
  DATE_SERV date NOT NULL,
  INSTYPE varchar(4) NOT NULL,
  PRICE decimal(11,2) NOT NULL,
  PAYPRICE decimal(11,2) NOT NULL,
  ACTUALPAY decimal(11,2) NOT NULL,
  fee decimal(12,2) NOT NULL DEFAULT '0.00',
  LABOR varchar(2) DEFAULT NULL,
  NATION varchar(3) NOT NULL DEFAULT '',
	NATIONCODEAEC varchar(3) NOT NULL DEFAULT '',
  labor_group int(1) NOT NULL DEFAULT '0',
  diagcode varchar(8) NOT NULL DEFAULT '',
  diagtype varchar(1) NOT NULL DEFAULT '',
	source VARCHAR(50) DEFAULT NULL,
  KEY  (HOSPCODE,PID,SEQ_AN,DATE_SERV)
) ENGINE = myisam DEFAULT CHARSET=utf8;

INSERT IGNORE INTO t_all_labor (
SELECT
HOSPCODE,pid,seq,cid,sex,date_serv,INSTYPE,PRICE,PAYPRICE,ACTUALPAY,fee,LABOR,NATION,nationcodeaec,labor_group,diagcode,diagtype,'service' as 'source'
FROM t_service_labor 
);
INSERT IGNORE INTO  t_all_labor (
SELECT
HOSPCODE,'' as 'pid',an,cid,sex,DATE_FORMAT(DATETIME_DISCH,'%Y%m%d'),INSTYPE,PRICE,PAYPRICE,ACTUALPAY,fee,LABOR,NATION,nationcodeaec,labor_group,diagcode,diagtype,'admission' as 'source'
FROM t_admission_labor  
);
UPDATE t_all_labor l INNER JOIN tmp_admission a ON l.hospcode=a.hospcode AND l.seq_an=a.an 
SET l.pid=a.pid
WHERE l.source='admission';

 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.393455;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:325;a:5:{i:0;s:36:"DROP PROCEDURE IF EXISTS t_alcoholic";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.393455;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:326;a:5:{i:0;s:36:"DROP PROCEDURE IF EXISTS t_alcoholic";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.4402561;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:328;a:5:{i:0;s:710:"CREATE PROCEDURE t_alcoholic()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '50';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS t_alcoholic;
CREATE TABLE IF NOT EXISTS t_alcoholic (province varchar(2),PRIMARY KEY (province,hospcode,cid,date_serv,diagcode) ,KEY (cid)) ENGINE=myisam as (
SELECT
@prov_c province,HOSPCODE,pid,cid,DATE_SERV,DIAGCODE
FROM
tmp_diag_opd
WHERE substr(DIAGCODE,1,3) in('F10') OR DIAGCODE in('F171','F172') OR DIAGCODE in('Z508')
AND DATE_SERV BETWEEN @start_d AND  @end_d
GROUP BY province,hospcode,cid,date_serv,diagcode
ORDER BY HOSPCODE,CID,DIAGCODE
);
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.4402561;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:329;a:5:{i:0;s:710:"CREATE PROCEDURE t_alcoholic()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '50';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS t_alcoholic;
CREATE TABLE IF NOT EXISTS t_alcoholic (province varchar(2),PRIMARY KEY (province,hospcode,cid,date_serv,diagcode) ,KEY (cid)) ENGINE=myisam as (
SELECT
@prov_c province,HOSPCODE,pid,cid,DATE_SERV,DIAGCODE
FROM
tmp_diag_opd
WHERE substr(DIAGCODE,1,3) in('F10') OR DIAGCODE in('F171','F172') OR DIAGCODE in('Z508')
AND DATE_SERV BETWEEN @start_d AND  @end_d
GROUP BY province,hospcode,cid,date_serv,diagcode
ORDER BY HOSPCODE,CID,DIAGCODE
);
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.487056;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:331;a:5:{i:0;s:33:"DROP PROCEDURE IF EXISTS t_envocc";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.487056;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:332;a:5:{i:0;s:33:"DROP PROCEDURE IF EXISTS t_envocc";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.5338559;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:334;a:5:{i:0;s:6444:"CREATE PROCEDURE t_envocc()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '51';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

/*external cause*/
DROP TABLE  IF EXISTS t_envocc_ext;
CREATE TABLE  IF NOT EXISTS t_envocc_ext(
PRIMARY KEY (hospcode,pid,seq_an,date_serv,DIAGCODE)
,KEY(cid)
,KEY (hospcode,pid)
,KEY (hospcode,pid,seq_an)
,KEY (date_serv)
,KEY (DIAGCODE)
) ENGINE = MyISAM as (
SELECT
HOSPCODE,PID,CID,SEQ as seq_an,DATE_SERV,DIAGCODE,DIAGTYPE,'diag_opd' as 'source'
FROM
tmp_diag_opd
WHERE DIAGCODE IN('Y96') 
   OR (SUBSTR(DIAGCODE,1,1) IN('V','W','X')  AND SUBSTR(DIAGCODE,5,1) in('2')) AND DATE_SERV BETWEEN @start_d AND @end_d
);
INSERT IGNORE INTO t_envocc_ext(
SELECT
HOSPCODE,PID,CID,AN as seq_an,DATE_FORMAT(datetime_disch,'%Y%m%d') as DATE_SERV
,DIAGCODE,DIAGTYPE,'diag_ipd' as 'source'
FROM
tmp_diag_ipd
WHERE DIAGCODE IN('Y96') 
   OR (SUBSTR(DIAGCODE,1,1) IN('V','W','X')  AND SUBSTR(DIAGCODE,5,1) in('2'))  AND DATE_FORMAT(datetime_disch,'%Y%m%d') BETWEEN @start_d AND @end_d
);
/*envocc_diag*/
DROP TABLE  IF EXISTS t_envocc;
CREATE TABLE  IF NOT EXISTS t_envocc(
PRIMARY KEY (hospcode,pid,seq_an,date_serv,DIAGCODE)
,KEY(cid)
,KEY (hospcode,pid)
,KEY (hospcode,pid,seq_an)
,KEY (date_serv)
,KEY (DIAGCODE)
) ENGINE = MyISAM as (
SELECT
HOSPCODE,PID,CID,SEQ as seq_an,DATE_SERV,DIAGCODE,DIAGTYPE,'diag_opd' as 'source'
FROM
tmp_diag_opd
WHERE  DATE_SERV BETWEEN @start_d AND @end_d 
AND (DIAGCODE  IN('J628','J61','J920','H833','H903','H904' ,'H905')
OR SUBSTR(DIAGCODE,1,3) IN('I20','I28')
OR SUBSTR(DIAGCODE,1,3) IN('C45','T52','T67')
OR SUBSTR(DIAGCODE,1,3)  BETWEEN  'J00' AND 'J39' 
OR SUBSTR(DIAGCODE,1,3)  BETWEEN  'J40' AND 'J47' 
OR SUBSTR(DIAGCODE,1,3)  BETWEEN  'J60' AND 'J99' )
);


INSERT IGNORE INTO  t_envocc (
SELECT
HOSPCODE,PID,CID,SEQ as seq_an,DATE_SERV,DIAGCODE,DIAGTYPE,'diag_opd' as 'source'
FROM
tmp_diag_opd
WHERE DATE_SERV BETWEEN @start_d AND  @end_d 
AND  DIAGCODE  IN('T600','T601','T602','T603','T604','T608','T609','T560')
AND CONCAT(HOSPCODE,'-',PID,'-',SEQ)  not in(
					SELECT
					CONCAT(HOSPCODE,'-',PID,'-',SEQ_an) 
					FROM t_envocc_ext 
					WHERE DIAGCODE in('X68') AND source in('diag_opd')
					)
);

INSERT IGNORE INTO  t_envocc (
SELECT
HOSPCODE,PID,CID,SEQ as seq_an,DATE_SERV,DIAGCODE,DIAGTYPE,'diag_opd' as 'source'
FROM
tmp_diag_opd
WHERE DATE_SERV BETWEEN @start_d AND  @end_d 
AND SUBSTR(DIAGCODE,1,3)  BETWEEN 'M00' AND 'M99'  
AND CONCAT(HOSPCODE,'-',PID,'-',SEQ)  in(
					SELECT
					CONCAT(HOSPCODE,'-',PID,'-',SEQ_an) 
					FROM t_envocc_ext 
					WHERE DIAGCODE in('Y96') AND source in('diag_opd')
					)
);
INSERT IGNORE INTO  t_envocc (
SELECT
HOSPCODE,PID,CID,SEQ as seq_an,DATE_SERV,DIAGCODE,DIAGTYPE,'diag_opd' as 'source'
FROM
tmp_diag_opd
WHERE DATE_SERV BETWEEN @start_d AND  @end_d 
AND SUBSTR(DIAGCODE,1,3)  IN('G56')
AND CONCAT(HOSPCODE,'-',PID,'-',SEQ)  in(
					SELECT
					CONCAT(HOSPCODE,'-',PID,'-',SEQ_an) 
					FROM t_envocc_ext 
					WHERE DIAGCODE in('Y96') AND source in('diag_opd')
					)
);


INSERT IGNORE INTO  t_envocc (
SELECT
HOSPCODE,PID,CID,SEQ as seq_an,DATE_SERV,DIAGCODE,DIAGTYPE,'diag_opd' as 'source'
FROM
tmp_diag_opd
WHERE DATE_SERV BETWEEN @start_d AND @end_d 
AND (SUBSTR(DIAGCODE,1,1)  IN('S') OR  SUBSTR(DIAGCODE,1,2)  IN('T0','T1','T2') )
AND CONCAT(HOSPCODE,'-',PID,'-',SEQ)  in(
					SELECT
					CONCAT(HOSPCODE,'-',PID,'-',SEQ_an) 
					FROM t_envocc_ext 
					WHERE (SUBSTR(DIAGCODE,1,1) IN('V','W','X')  AND SUBSTR(DIAGCODE,5,1) in('2'))
						AND source in('diag_opd')
					)
);

/*insert from diag_ipd*/
INSERT IGNORE INTO  t_envocc (
SELECT
HOSPCODE,PID,CID,AN as seq_an,DATE_FORMAT(datetime_disch,'%Y%m%d') as DATE_SERV
,DIAGCODE,DIAGTYPE,'diag_ipd' as 'source'
FROM
tmp_diag_ipd
WHERE DATE_FORMAT(datetime_disch,'%Y%m%d') BETWEEN @start_d AND @end_d 
AND (DIAGCODE  IN('J628','J61','J920','H833','H903','H904' ,'H905')
OR SUBSTR(DIAGCODE,1,3) IN('I20','I28')
OR SUBSTR(DIAGCODE,1,3) IN('C45','T52','T67')
OR SUBSTR(DIAGCODE,1,3)  BETWEEN  'J00' AND 'J39' 
OR SUBSTR(DIAGCODE,1,3)  BETWEEN  'J40' AND 'J47' 
OR SUBSTR(DIAGCODE,1,3)  BETWEEN  'J60' AND 'J99' )
);

INSERT IGNORE INTO  t_envocc (
SELECT
HOSPCODE,PID,CID,AN as seq_an,DATE_FORMAT(datetime_disch,'%Y%m%d') as DATE_SERV
,DIAGCODE,DIAGTYPE,'diag_ipd' as 'source'
FROM
tmp_diag_ipd
WHERE DATE_FORMAT(datetime_disch,'%Y%m%d') BETWEEN @start_d AND @end_d 
AND DIAGCODE  IN('T600','T601','T602','T603','T604','T608','T609','T560')
AND CONCAT(HOSPCODE,'-',PID,'-',AN)  not in(
					SELECT
					CONCAT(HOSPCODE,'-',PID,'-',SEQ_an) 
					FROM t_envocc_ext 
					WHERE DIAGCODE in('X68') AND source in('diag_ipd')
					)
);

INSERT IGNORE INTO  t_envocc (
SELECT
HOSPCODE,PID,CID,AN as seq_an,DATE_FORMAT(datetime_disch,'%Y%m%d') as DATE_SERV
,DIAGCODE,DIAGTYPE,'diag_ipd' as 'source'
FROM
tmp_diag_ipd
WHERE DATE_FORMAT(datetime_disch,'%Y%m%d') BETWEEN @start_d AND @end_d 
AND SUBSTR(DIAGCODE,1,3)  BETWEEN 'M00' AND 'M99'  
AND CONCAT(HOSPCODE,'-',PID,'-',AN)  in(
					SELECT
					CONCAT(HOSPCODE,'-',PID,'-',SEQ_an) 
					FROM t_envocc_ext 
					WHERE DIAGCODE in('Y96') AND source in('diag_ipd')
					)
);

INSERT IGNORE INTO  t_envocc (
SELECT
HOSPCODE,PID,CID,AN as seq_an,DATE_FORMAT(datetime_disch,'%Y%m%d') as DATE_SERV
,DIAGCODE,DIAGTYPE,'diag_ipd' as 'source'
FROM
tmp_diag_ipd
WHERE DATE_FORMAT(datetime_disch,'%Y%m%d') BETWEEN @start_d AND @end_d 
AND SUBSTR(DIAGCODE,1,3)  IN('G56')  
AND CONCAT(HOSPCODE,'-',PID,'-',AN)  in(
					SELECT
					CONCAT(HOSPCODE,'-',PID,'-',SEQ_an) 
					FROM t_envocc_ext 
					WHERE DIAGCODE in('Y96') AND source in('diag_ipd')
					)
);

INSERT IGNORE INTO  t_envocc (
SELECT
HOSPCODE,PID,CID,AN as seq_an,DATE_FORMAT(datetime_disch,'%Y%m%d') as DATE_SERV
,DIAGCODE,DIAGTYPE,'diag_ipd' as 'source'
FROM
tmp_diag_ipd
WHERE DATE_FORMAT(datetime_disch,'%Y%m%d') BETWEEN @start_d AND @end_d 
AND (SUBSTR(DIAGCODE,1,2)  IN('T0','T1','T2')  OR SUBSTR(DIAGCODE,1,1)  IN('S')   )
AND CONCAT(HOSPCODE,'-',PID,'-',AN)  in(
					SELECT
					CONCAT(HOSPCODE,'-',PID,'-',SEQ_an) 
					FROM t_envocc_ext 
					WHERE (SUBSTR(DIAGCODE,1,1) IN('V','W','X')  AND SUBSTR(DIAGCODE,5,1) in('2'))
						AND source in('diag_ipd')
					)
);

 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.5494559;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:335;a:5:{i:0;s:6444:"CREATE PROCEDURE t_envocc()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '51';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

/*external cause*/
DROP TABLE  IF EXISTS t_envocc_ext;
CREATE TABLE  IF NOT EXISTS t_envocc_ext(
PRIMARY KEY (hospcode,pid,seq_an,date_serv,DIAGCODE)
,KEY(cid)
,KEY (hospcode,pid)
,KEY (hospcode,pid,seq_an)
,KEY (date_serv)
,KEY (DIAGCODE)
) ENGINE = MyISAM as (
SELECT
HOSPCODE,PID,CID,SEQ as seq_an,DATE_SERV,DIAGCODE,DIAGTYPE,'diag_opd' as 'source'
FROM
tmp_diag_opd
WHERE DIAGCODE IN('Y96') 
   OR (SUBSTR(DIAGCODE,1,1) IN('V','W','X')  AND SUBSTR(DIAGCODE,5,1) in('2')) AND DATE_SERV BETWEEN @start_d AND @end_d
);
INSERT IGNORE INTO t_envocc_ext(
SELECT
HOSPCODE,PID,CID,AN as seq_an,DATE_FORMAT(datetime_disch,'%Y%m%d') as DATE_SERV
,DIAGCODE,DIAGTYPE,'diag_ipd' as 'source'
FROM
tmp_diag_ipd
WHERE DIAGCODE IN('Y96') 
   OR (SUBSTR(DIAGCODE,1,1) IN('V','W','X')  AND SUBSTR(DIAGCODE,5,1) in('2'))  AND DATE_FORMAT(datetime_disch,'%Y%m%d') BETWEEN @start_d AND @end_d
);
/*envocc_diag*/
DROP TABLE  IF EXISTS t_envocc;
CREATE TABLE  IF NOT EXISTS t_envocc(
PRIMARY KEY (hospcode,pid,seq_an,date_serv,DIAGCODE)
,KEY(cid)
,KEY (hospcode,pid)
,KEY (hospcode,pid,seq_an)
,KEY (date_serv)
,KEY (DIAGCODE)
) ENGINE = MyISAM as (
SELECT
HOSPCODE,PID,CID,SEQ as seq_an,DATE_SERV,DIAGCODE,DIAGTYPE,'diag_opd' as 'source'
FROM
tmp_diag_opd
WHERE  DATE_SERV BETWEEN @start_d AND @end_d 
AND (DIAGCODE  IN('J628','J61','J920','H833','H903','H904' ,'H905')
OR SUBSTR(DIAGCODE,1,3) IN('I20','I28')
OR SUBSTR(DIAGCODE,1,3) IN('C45','T52','T67')
OR SUBSTR(DIAGCODE,1,3)  BETWEEN  'J00' AND 'J39' 
OR SUBSTR(DIAGCODE,1,3)  BETWEEN  'J40' AND 'J47' 
OR SUBSTR(DIAGCODE,1,3)  BETWEEN  'J60' AND 'J99' )
);


INSERT IGNORE INTO  t_envocc (
SELECT
HOSPCODE,PID,CID,SEQ as seq_an,DATE_SERV,DIAGCODE,DIAGTYPE,'diag_opd' as 'source'
FROM
tmp_diag_opd
WHERE DATE_SERV BETWEEN @start_d AND  @end_d 
AND  DIAGCODE  IN('T600','T601','T602','T603','T604','T608','T609','T560')
AND CONCAT(HOSPCODE,'-',PID,'-',SEQ)  not in(
					SELECT
					CONCAT(HOSPCODE,'-',PID,'-',SEQ_an) 
					FROM t_envocc_ext 
					WHERE DIAGCODE in('X68') AND source in('diag_opd')
					)
);

INSERT IGNORE INTO  t_envocc (
SELECT
HOSPCODE,PID,CID,SEQ as seq_an,DATE_SERV,DIAGCODE,DIAGTYPE,'diag_opd' as 'source'
FROM
tmp_diag_opd
WHERE DATE_SERV BETWEEN @start_d AND  @end_d 
AND SUBSTR(DIAGCODE,1,3)  BETWEEN 'M00' AND 'M99'  
AND CONCAT(HOSPCODE,'-',PID,'-',SEQ)  in(
					SELECT
					CONCAT(HOSPCODE,'-',PID,'-',SEQ_an) 
					FROM t_envocc_ext 
					WHERE DIAGCODE in('Y96') AND source in('diag_opd')
					)
);
INSERT IGNORE INTO  t_envocc (
SELECT
HOSPCODE,PID,CID,SEQ as seq_an,DATE_SERV,DIAGCODE,DIAGTYPE,'diag_opd' as 'source'
FROM
tmp_diag_opd
WHERE DATE_SERV BETWEEN @start_d AND  @end_d 
AND SUBSTR(DIAGCODE,1,3)  IN('G56')
AND CONCAT(HOSPCODE,'-',PID,'-',SEQ)  in(
					SELECT
					CONCAT(HOSPCODE,'-',PID,'-',SEQ_an) 
					FROM t_envocc_ext 
					WHERE DIAGCODE in('Y96') AND source in('diag_opd')
					)
);


INSERT IGNORE INTO  t_envocc (
SELECT
HOSPCODE,PID,CID,SEQ as seq_an,DATE_SERV,DIAGCODE,DIAGTYPE,'diag_opd' as 'source'
FROM
tmp_diag_opd
WHERE DATE_SERV BETWEEN @start_d AND @end_d 
AND (SUBSTR(DIAGCODE,1,1)  IN('S') OR  SUBSTR(DIAGCODE,1,2)  IN('T0','T1','T2') )
AND CONCAT(HOSPCODE,'-',PID,'-',SEQ)  in(
					SELECT
					CONCAT(HOSPCODE,'-',PID,'-',SEQ_an) 
					FROM t_envocc_ext 
					WHERE (SUBSTR(DIAGCODE,1,1) IN('V','W','X')  AND SUBSTR(DIAGCODE,5,1) in('2'))
						AND source in('diag_opd')
					)
);

/*insert from diag_ipd*/
INSERT IGNORE INTO  t_envocc (
SELECT
HOSPCODE,PID,CID,AN as seq_an,DATE_FORMAT(datetime_disch,'%Y%m%d') as DATE_SERV
,DIAGCODE,DIAGTYPE,'diag_ipd' as 'source'
FROM
tmp_diag_ipd
WHERE DATE_FORMAT(datetime_disch,'%Y%m%d') BETWEEN @start_d AND @end_d 
AND (DIAGCODE  IN('J628','J61','J920','H833','H903','H904' ,'H905')
OR SUBSTR(DIAGCODE,1,3) IN('I20','I28')
OR SUBSTR(DIAGCODE,1,3) IN('C45','T52','T67')
OR SUBSTR(DIAGCODE,1,3)  BETWEEN  'J00' AND 'J39' 
OR SUBSTR(DIAGCODE,1,3)  BETWEEN  'J40' AND 'J47' 
OR SUBSTR(DIAGCODE,1,3)  BETWEEN  'J60' AND 'J99' )
);

INSERT IGNORE INTO  t_envocc (
SELECT
HOSPCODE,PID,CID,AN as seq_an,DATE_FORMAT(datetime_disch,'%Y%m%d') as DATE_SERV
,DIAGCODE,DIAGTYPE,'diag_ipd' as 'source'
FROM
tmp_diag_ipd
WHERE DATE_FORMAT(datetime_disch,'%Y%m%d') BETWEEN @start_d AND @end_d 
AND DIAGCODE  IN('T600','T601','T602','T603','T604','T608','T609','T560')
AND CONCAT(HOSPCODE,'-',PID,'-',AN)  not in(
					SELECT
					CONCAT(HOSPCODE,'-',PID,'-',SEQ_an) 
					FROM t_envocc_ext 
					WHERE DIAGCODE in('X68') AND source in('diag_ipd')
					)
);

INSERT IGNORE INTO  t_envocc (
SELECT
HOSPCODE,PID,CID,AN as seq_an,DATE_FORMAT(datetime_disch,'%Y%m%d') as DATE_SERV
,DIAGCODE,DIAGTYPE,'diag_ipd' as 'source'
FROM
tmp_diag_ipd
WHERE DATE_FORMAT(datetime_disch,'%Y%m%d') BETWEEN @start_d AND @end_d 
AND SUBSTR(DIAGCODE,1,3)  BETWEEN 'M00' AND 'M99'  
AND CONCAT(HOSPCODE,'-',PID,'-',AN)  in(
					SELECT
					CONCAT(HOSPCODE,'-',PID,'-',SEQ_an) 
					FROM t_envocc_ext 
					WHERE DIAGCODE in('Y96') AND source in('diag_ipd')
					)
);

INSERT IGNORE INTO  t_envocc (
SELECT
HOSPCODE,PID,CID,AN as seq_an,DATE_FORMAT(datetime_disch,'%Y%m%d') as DATE_SERV
,DIAGCODE,DIAGTYPE,'diag_ipd' as 'source'
FROM
tmp_diag_ipd
WHERE DATE_FORMAT(datetime_disch,'%Y%m%d') BETWEEN @start_d AND @end_d 
AND SUBSTR(DIAGCODE,1,3)  IN('G56')  
AND CONCAT(HOSPCODE,'-',PID,'-',AN)  in(
					SELECT
					CONCAT(HOSPCODE,'-',PID,'-',SEQ_an) 
					FROM t_envocc_ext 
					WHERE DIAGCODE in('Y96') AND source in('diag_ipd')
					)
);

INSERT IGNORE INTO  t_envocc (
SELECT
HOSPCODE,PID,CID,AN as seq_an,DATE_FORMAT(datetime_disch,'%Y%m%d') as DATE_SERV
,DIAGCODE,DIAGTYPE,'diag_ipd' as 'source'
FROM
tmp_diag_ipd
WHERE DATE_FORMAT(datetime_disch,'%Y%m%d') BETWEEN @start_d AND @end_d 
AND (SUBSTR(DIAGCODE,1,2)  IN('T0','T1','T2')  OR SUBSTR(DIAGCODE,1,1)  IN('S')   )
AND CONCAT(HOSPCODE,'-',PID,'-',AN)  in(
					SELECT
					CONCAT(HOSPCODE,'-',PID,'-',SEQ_an) 
					FROM t_envocc_ext 
					WHERE (SUBSTR(DIAGCODE,1,1) IN('V','W','X')  AND SUBSTR(DIAGCODE,5,1) in('2'))
						AND source in('diag_ipd')
					)
);

 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.596256;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:337;a:5:{i:0;s:36:"DROP PROCEDURE IF EXISTS t_refer_4pa";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.596256;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:338;a:5:{i:0;s:36:"DROP PROCEDURE IF EXISTS t_refer_4pa";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.6586559;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:340;a:5:{i:0;s:4403:"CREATE PROCEDURE t_refer_4pa()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '52';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
SET @my_zone:=(SELECT zonecode FROM sys_config LIMIT 1);

DROP TABLE IF EXISTS tmz_person;
CREATE TEMPORARY TABLE IF NOT EXISTS tmz_person (PRIMARY KEY (hospcode,pid,birth),KEY (birth)  ) ENGINE=myisam as
(
SELECT * FROM person WHERE BIRTH BETWEEN concat(@b_year-1,'0701') AND @end_d
);
/*opdcase typeout=3*/
DROP TABLE IF  EXISTS t_refer_4pa;
CREATE TABLE IF NOT EXISTS t_refer_4pa (PRIMARY KEY(hospcode,pid,seq_an,diagcode) ,KEY (causeout),KEY (typeout) ) ENGINE=myisam as
(SELECT
s.HOSPCODE,s.pid,s.seq seq_an,s.date_serv,s.typeout,s.causeout,referouthosp,d.DIAGCODE,d.DIAGTYPE, 'opdcase' source
FROM tmp_service s 
	INNER JOIN tmp_diag_opd d ON s.HOSPCODE=d.HOSPCODE AND s.pid=d.PID AND s.seq=d.SEQ
	INNER JOIN (
		SELECT hcode FROM ccmihosp 
		WHERE byear in(@b_year+543)  AND chwcode in(@prov_c) 	AND hcode NOT IN (SELECT HOSPCODE FROM chospital_boat)
		GROUP BY hcode 
	) c ON s.HOSPCODE=c.hcode
	INNER JOIN (
		SELECT hcode FROM ccmihosp WHERE byear in(@b_year+543)  AND region NOT in(@my_zone) GROUP BY hcode 
	) z ON s.referouthosp=z.hcode
WHERE s.date_serv BETWEEN @start_d AND @end_d AND LENGTH(TRIM(s.referouthosp)) = 5 
		AND ( SUBSTR(DIAGCODE,1,1) in('C')
			OR SUBSTR(DIAGCODE,1,2) in('D0')
			OR SUBSTR(DIAGCODE,1,3) BETWEEN 'I20' AND 'I25'
			OR SUBSTR(DIAGCODE,1,3) BETWEEN 'V01' AND 'Y98'
		)
);

INSERT IGNORE INTO t_refer_4pa (
SELECT
s.HOSPCODE,s.pid,s.seq,s.date_serv,s.typeout,s.causeout,referouthosp,d.DIAGCODE,d.DIAGTYPE, 'opdcase' source
FROM tmp_service s 
	INNER JOIN tmp_diag_opd d ON s.HOSPCODE=d.HOSPCODE AND s.pid=d.PID AND s.seq=d.SEQ
	INNER JOIN (
		SELECT hcode FROM ccmihosp 
		WHERE byear in(@b_year+543)  AND chwcode in(@prov_c) 	AND hcode NOT IN (SELECT HOSPCODE FROM chospital_boat)
		GROUP BY hcode 
	) c ON s.HOSPCODE=c.hcode
	INNER JOIN (
		SELECT hcode FROM ccmihosp WHERE byear in(@b_year+543)  AND region NOT in(@my_zone) GROUP BY hcode 
	) z ON s.referouthosp=z.hcode
  INNER JOIN tmz_person p ON s.hospcode=p.HOSPCODE AND s.pid=p.PID
WHERE s.date_serv BETWEEN @start_d AND @end_d AND LENGTH(TRIM(s.referouthosp)) = 5 
	AND TIMESTAMPDIFF(day,p.BIRTH,s.date_serv) <= 28
	);

/*ipdcase DISCHTYPE=4*/
INSERT IGNORE INTO t_refer_4pa (
SELECT
s.HOSPCODE,s.pid,s.AN,DATE_FORMAT(s.DATETIME_DISCH,'%Y%m%d'),s.DISCHTYPE,s.causeout,referouthosp,d.DIAGCODE,d.DIAGTYPE, 'ipdcase' source
FROM tmp_admission s 
	INNER JOIN tmp_diag_ipd d ON s.HOSPCODE=d.HOSPCODE AND s.AN=d.AN
	INNER JOIN (
		SELECT hcode FROM ccmihosp 
		WHERE byear in(@b_year+543)  AND chwcode in(@prov_c) 	AND hcode NOT IN (SELECT HOSPCODE FROM chospital_boat)
		GROUP BY hcode 
	) c ON s.HOSPCODE=c.hcode
	INNER JOIN (
		SELECT hcode FROM ccmihosp WHERE byear in(@b_year+543)  AND region NOT in(@my_zone) GROUP BY hcode 
	) z ON s.referouthosp=z.hcode
WHERE DATE_FORMAT(s.DATETIME_DISCH,'%Y%m%d') BETWEEN @start_d AND @end_d AND LENGTH(TRIM(s.referouthosp)) = 5 
		AND ( SUBSTR(DIAGCODE,1,1) in('C')
			OR SUBSTR(DIAGCODE,1,2) in('D0')
			OR SUBSTR(DIAGCODE,1,3) BETWEEN 'I20' AND 'I25'
			OR SUBSTR(DIAGCODE,1,3) BETWEEN 'V01' AND 'Y98'
		)
);

INSERT IGNORE INTO t_refer_4pa (
SELECT
s.HOSPCODE,s.pid,s.AN,DATE_FORMAT(s.DATETIME_DISCH,'%Y%m%d'),s.DISCHTYPE,s.causeout,referouthosp,d.DIAGCODE,d.DIAGTYPE, 'ipdcase' source
FROM tmp_admission s 
	INNER JOIN tmp_diag_ipd d ON s.HOSPCODE=d.HOSPCODE AND s.AN=d.AN
	INNER JOIN (
		SELECT hcode FROM ccmihosp 
		WHERE byear in(@b_year+543)  AND chwcode in(@prov_c) 	AND hcode NOT IN (SELECT HOSPCODE FROM chospital_boat)
		GROUP BY hcode 
	) c ON s.HOSPCODE=c.hcode
	INNER JOIN (
		SELECT hcode FROM ccmihosp WHERE byear in(@b_year+543)  AND region NOT in(@my_zone) GROUP BY hcode 
	) z ON s.referouthosp=z.hcode
	INNER JOIN tmz_person p ON s.hospcode=p.HOSPCODE AND s.pid=p.PID
WHERE DATE_FORMAT(s.DATETIME_DISCH,'%Y%m%d') BETWEEN @start_d AND @end_d AND LENGTH(TRIM(s.referouthosp)) = 5 
	AND TIMESTAMPDIFF(day,p.BIRTH,s.DATETIME_DISCH) <= 28
	);

DELETE FROM t_refer_4pa WHERE hospcode in(
SELECT hcode  FROM ccmihosp WHERE byear in(@b_year+543)  AND region in(3) GROUP BY hcode 
) AND SUBSTR(DIAGCODE,1,3) BETWEEN 'I20' AND 'I25' ;

 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.6586559;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:341;a:5:{i:0;s:4403:"CREATE PROCEDURE t_refer_4pa()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '52';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
SET @my_zone:=(SELECT zonecode FROM sys_config LIMIT 1);

DROP TABLE IF EXISTS tmz_person;
CREATE TEMPORARY TABLE IF NOT EXISTS tmz_person (PRIMARY KEY (hospcode,pid,birth),KEY (birth)  ) ENGINE=myisam as
(
SELECT * FROM person WHERE BIRTH BETWEEN concat(@b_year-1,'0701') AND @end_d
);
/*opdcase typeout=3*/
DROP TABLE IF  EXISTS t_refer_4pa;
CREATE TABLE IF NOT EXISTS t_refer_4pa (PRIMARY KEY(hospcode,pid,seq_an,diagcode) ,KEY (causeout),KEY (typeout) ) ENGINE=myisam as
(SELECT
s.HOSPCODE,s.pid,s.seq seq_an,s.date_serv,s.typeout,s.causeout,referouthosp,d.DIAGCODE,d.DIAGTYPE, 'opdcase' source
FROM tmp_service s 
	INNER JOIN tmp_diag_opd d ON s.HOSPCODE=d.HOSPCODE AND s.pid=d.PID AND s.seq=d.SEQ
	INNER JOIN (
		SELECT hcode FROM ccmihosp 
		WHERE byear in(@b_year+543)  AND chwcode in(@prov_c) 	AND hcode NOT IN (SELECT HOSPCODE FROM chospital_boat)
		GROUP BY hcode 
	) c ON s.HOSPCODE=c.hcode
	INNER JOIN (
		SELECT hcode FROM ccmihosp WHERE byear in(@b_year+543)  AND region NOT in(@my_zone) GROUP BY hcode 
	) z ON s.referouthosp=z.hcode
WHERE s.date_serv BETWEEN @start_d AND @end_d AND LENGTH(TRIM(s.referouthosp)) = 5 
		AND ( SUBSTR(DIAGCODE,1,1) in('C')
			OR SUBSTR(DIAGCODE,1,2) in('D0')
			OR SUBSTR(DIAGCODE,1,3) BETWEEN 'I20' AND 'I25'
			OR SUBSTR(DIAGCODE,1,3) BETWEEN 'V01' AND 'Y98'
		)
);

INSERT IGNORE INTO t_refer_4pa (
SELECT
s.HOSPCODE,s.pid,s.seq,s.date_serv,s.typeout,s.causeout,referouthosp,d.DIAGCODE,d.DIAGTYPE, 'opdcase' source
FROM tmp_service s 
	INNER JOIN tmp_diag_opd d ON s.HOSPCODE=d.HOSPCODE AND s.pid=d.PID AND s.seq=d.SEQ
	INNER JOIN (
		SELECT hcode FROM ccmihosp 
		WHERE byear in(@b_year+543)  AND chwcode in(@prov_c) 	AND hcode NOT IN (SELECT HOSPCODE FROM chospital_boat)
		GROUP BY hcode 
	) c ON s.HOSPCODE=c.hcode
	INNER JOIN (
		SELECT hcode FROM ccmihosp WHERE byear in(@b_year+543)  AND region NOT in(@my_zone) GROUP BY hcode 
	) z ON s.referouthosp=z.hcode
  INNER JOIN tmz_person p ON s.hospcode=p.HOSPCODE AND s.pid=p.PID
WHERE s.date_serv BETWEEN @start_d AND @end_d AND LENGTH(TRIM(s.referouthosp)) = 5 
	AND TIMESTAMPDIFF(day,p.BIRTH,s.date_serv) <= 28
	);

/*ipdcase DISCHTYPE=4*/
INSERT IGNORE INTO t_refer_4pa (
SELECT
s.HOSPCODE,s.pid,s.AN,DATE_FORMAT(s.DATETIME_DISCH,'%Y%m%d'),s.DISCHTYPE,s.causeout,referouthosp,d.DIAGCODE,d.DIAGTYPE, 'ipdcase' source
FROM tmp_admission s 
	INNER JOIN tmp_diag_ipd d ON s.HOSPCODE=d.HOSPCODE AND s.AN=d.AN
	INNER JOIN (
		SELECT hcode FROM ccmihosp 
		WHERE byear in(@b_year+543)  AND chwcode in(@prov_c) 	AND hcode NOT IN (SELECT HOSPCODE FROM chospital_boat)
		GROUP BY hcode 
	) c ON s.HOSPCODE=c.hcode
	INNER JOIN (
		SELECT hcode FROM ccmihosp WHERE byear in(@b_year+543)  AND region NOT in(@my_zone) GROUP BY hcode 
	) z ON s.referouthosp=z.hcode
WHERE DATE_FORMAT(s.DATETIME_DISCH,'%Y%m%d') BETWEEN @start_d AND @end_d AND LENGTH(TRIM(s.referouthosp)) = 5 
		AND ( SUBSTR(DIAGCODE,1,1) in('C')
			OR SUBSTR(DIAGCODE,1,2) in('D0')
			OR SUBSTR(DIAGCODE,1,3) BETWEEN 'I20' AND 'I25'
			OR SUBSTR(DIAGCODE,1,3) BETWEEN 'V01' AND 'Y98'
		)
);

INSERT IGNORE INTO t_refer_4pa (
SELECT
s.HOSPCODE,s.pid,s.AN,DATE_FORMAT(s.DATETIME_DISCH,'%Y%m%d'),s.DISCHTYPE,s.causeout,referouthosp,d.DIAGCODE,d.DIAGTYPE, 'ipdcase' source
FROM tmp_admission s 
	INNER JOIN tmp_diag_ipd d ON s.HOSPCODE=d.HOSPCODE AND s.AN=d.AN
	INNER JOIN (
		SELECT hcode FROM ccmihosp 
		WHERE byear in(@b_year+543)  AND chwcode in(@prov_c) 	AND hcode NOT IN (SELECT HOSPCODE FROM chospital_boat)
		GROUP BY hcode 
	) c ON s.HOSPCODE=c.hcode
	INNER JOIN (
		SELECT hcode FROM ccmihosp WHERE byear in(@b_year+543)  AND region NOT in(@my_zone) GROUP BY hcode 
	) z ON s.referouthosp=z.hcode
	INNER JOIN tmz_person p ON s.hospcode=p.HOSPCODE AND s.pid=p.PID
WHERE DATE_FORMAT(s.DATETIME_DISCH,'%Y%m%d') BETWEEN @start_d AND @end_d AND LENGTH(TRIM(s.referouthosp)) = 5 
	AND TIMESTAMPDIFF(day,p.BIRTH,s.DATETIME_DISCH) <= 28
	);

DELETE FROM t_refer_4pa WHERE hospcode in(
SELECT hcode  FROM ccmihosp WHERE byear in(@b_year+543)  AND region in(3) GROUP BY hcode 
) AND SUBSTR(DIAGCODE,1,3) BETWEEN 'I20' AND 'I25' ;

 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.721056;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:343;a:5:{i:0;s:36:"DROP PROCEDURE IF EXISTS t_death28pa";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.721056;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:344;a:5:{i:0;s:36:"DROP PROCEDURE IF EXISTS t_death28pa";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.7678559;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:346;a:5:{i:0;s:2015:"CREATE PROCEDURE t_death28pa()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '53';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');


DROP TABLE IF EXISTS tmp_labor_hosp;
CREATE  TABLE IF NOT EXISTS tmp_labor_hosp(PRIMARY KEY (cid,bdate)) ENGINE= myisam as
(SELECT l.HOSPCODE,l.PID,l.BDATE,l.BHOSP,l.LBORN,p.NATION,p.CID
FROM tmp_labor l 
			INNER JOIN chospital c ON l.HOSPCODE=c.hoscode and c.hostype IN(5,6,7,11)
			INNER JOIN person p ON l.HOSPCODE=p.HOSPCODE AND l.pid=p.PID
WHERE l.BDATE BETWEEN @start_d AND @end_d 
AND  l.BHOSP IN(SELECT hoscode FROM chospital WHERE hostype IN(5,6,7,11) )
GROUP BY p.cid,l.bdate
);

INSERT IGNORE INTO tmp_labor_hosp (
SELECT l.HOSPCODE,l.PID,l.BDATE,l.BHOSP,l.LBORN,p.NATION,p.CID
FROM tmp_labor l 
			INNER JOIN person p ON l.HOSPCODE=p.HOSPCODE AND l.pid=p.PID
WHERE l.BDATE BETWEEN @start_d AND @end_d 
AND  l.BHOSP IN(SELECT hoscode FROM chospital WHERE hostype IN(5,6,7,11) ) 
GROUP BY p.cid,l.bdate
);


DROP TABLE IF EXISTS t_death28;
CREATE  TABLE IF NOT EXISTS t_death28(
date_death date,
DISCHARGE VARCHAR(2),
source VARCHAR(20),
PRIMARY KEY (hospcode,pid)) ENGINE= myisam as
(
SELECT s.HOSPCODE,s.pid,s.CID,p.`NAME`,p.LNAME,p.BIRTH,DATE_FORMAT(s.DATETIME_DISCH,'%Y%m%d') date_death 
,s.DISCHTYPE as DISCHARGE, 'admission' as source
FROM  tmp_admission s INNER JOIN person p ON s.HOSPCODE=p.HOSPCODE AND s.pid=p.PID
WHERE DATE_FORMAT(s.DATETIME_DISCH,'%Y%m%d') BETWEEN @start_d AND @end_d  
AND (s.DISCHTYPE in(8,9) OR s.DISCHSTATUS in(8,9))
AND TIMESTAMPDIFF(day,p.BIRTH,s.DATETIME_DISCH) <=28
);
INSERT IGNORE INTO t_death28 (
SELECT s.HOSPCODE,s.pid,s.CID,p.`NAME`,p.LNAME,p.BIRTH,date_serv,typeout, 'service' as source
FROM  tmp_service s INNER JOIN person p ON s.HOSPCODE=p.HOSPCODE AND s.pid=p.PID
WHERE s.date_serv BETWEEN @start_d AND @end_d  AND s.typeout in(4,5,6) 
AND TIMESTAMPDIFF(day,p.BIRTH,s.date_serv) <=28
);

 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.7678559;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:347;a:5:{i:0;s:2015:"CREATE PROCEDURE t_death28pa()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '53';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');


DROP TABLE IF EXISTS tmp_labor_hosp;
CREATE  TABLE IF NOT EXISTS tmp_labor_hosp(PRIMARY KEY (cid,bdate)) ENGINE= myisam as
(SELECT l.HOSPCODE,l.PID,l.BDATE,l.BHOSP,l.LBORN,p.NATION,p.CID
FROM tmp_labor l 
			INNER JOIN chospital c ON l.HOSPCODE=c.hoscode and c.hostype IN(5,6,7,11)
			INNER JOIN person p ON l.HOSPCODE=p.HOSPCODE AND l.pid=p.PID
WHERE l.BDATE BETWEEN @start_d AND @end_d 
AND  l.BHOSP IN(SELECT hoscode FROM chospital WHERE hostype IN(5,6,7,11) )
GROUP BY p.cid,l.bdate
);

INSERT IGNORE INTO tmp_labor_hosp (
SELECT l.HOSPCODE,l.PID,l.BDATE,l.BHOSP,l.LBORN,p.NATION,p.CID
FROM tmp_labor l 
			INNER JOIN person p ON l.HOSPCODE=p.HOSPCODE AND l.pid=p.PID
WHERE l.BDATE BETWEEN @start_d AND @end_d 
AND  l.BHOSP IN(SELECT hoscode FROM chospital WHERE hostype IN(5,6,7,11) ) 
GROUP BY p.cid,l.bdate
);


DROP TABLE IF EXISTS t_death28;
CREATE  TABLE IF NOT EXISTS t_death28(
date_death date,
DISCHARGE VARCHAR(2),
source VARCHAR(20),
PRIMARY KEY (hospcode,pid)) ENGINE= myisam as
(
SELECT s.HOSPCODE,s.pid,s.CID,p.`NAME`,p.LNAME,p.BIRTH,DATE_FORMAT(s.DATETIME_DISCH,'%Y%m%d') date_death 
,s.DISCHTYPE as DISCHARGE, 'admission' as source
FROM  tmp_admission s INNER JOIN person p ON s.HOSPCODE=p.HOSPCODE AND s.pid=p.PID
WHERE DATE_FORMAT(s.DATETIME_DISCH,'%Y%m%d') BETWEEN @start_d AND @end_d  
AND (s.DISCHTYPE in(8,9) OR s.DISCHSTATUS in(8,9))
AND TIMESTAMPDIFF(day,p.BIRTH,s.DATETIME_DISCH) <=28
);
INSERT IGNORE INTO t_death28 (
SELECT s.HOSPCODE,s.pid,s.CID,p.`NAME`,p.LNAME,p.BIRTH,date_serv,typeout, 'service' as source
FROM  tmp_service s INNER JOIN person p ON s.HOSPCODE=p.HOSPCODE AND s.pid=p.PID
WHERE s.date_serv BETWEEN @start_d AND @end_d  AND s.typeout in(4,5,6) 
AND TIMESTAMPDIFF(day,p.BIRTH,s.date_serv) <=28
);

 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.830256;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:349;a:5:{i:0;s:38:"DROP PROCEDURE IF EXISTS t_occupat_new";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.830256;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:350;a:5:{i:0;s:38:"DROP PROCEDURE IF EXISTS t_occupat_new";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.8770559;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:352;a:5:{i:0;s:1206:"CREATE PROCEDURE t_occupat_new()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '54';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF  EXISTS t_occupat_new;
CREATE TABLE IF NOT EXISTS t_occupat_new(
  id varchar(32) NOT NULL,
  hospcode varchar(5) NOT NULL,
  areacode varchar(8) NOT NULL,
  b_year varchar(4) NOT NULL,
	occupation_new varchar(4) NOT NULL,
	result int(9) DEFAULT 0,
	PRIMARY KEY (id,hospcode,areacode,b_year,occupation_new),
	KEY (hospcode),
	KEY (areacode),
	KEY (b_year)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO t_occupat_new (
SELECT @id,p.check_hosp hospcode ,p.check_vhid  areacode	
	  ,@b_year+543 as b_year
		,p.OCCUPATION_NEW
		,COUNT(DISTINCT p.cid) target
		FROM  t_person_cid p
	  WHERE SUBSTR(p.check_vhid,1,2) in(@prov_c)  
       AND p.check_typearea in(1,3) AND p.NATION in(99) 
       AND (p.DISCHARGE  in(2,3,9) OR (p.DISCHARGE  in(1)  AND p.DDISCHARGE > @start_d))
       AND TIMESTAMPDIFF(year,p.birth,CONCAT(@b_year,'0101')) BETWEEN 0 AND 199
		GROUP BY CONCAT(p.check_hosp ,'-' , p.check_vhid ,'-',p.OCCUPATION_NEW)
);
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.8770559;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:353;a:5:{i:0;s:1206:"CREATE PROCEDURE t_occupat_new()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '54';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF  EXISTS t_occupat_new;
CREATE TABLE IF NOT EXISTS t_occupat_new(
  id varchar(32) NOT NULL,
  hospcode varchar(5) NOT NULL,
  areacode varchar(8) NOT NULL,
  b_year varchar(4) NOT NULL,
	occupation_new varchar(4) NOT NULL,
	result int(9) DEFAULT 0,
	PRIMARY KEY (id,hospcode,areacode,b_year,occupation_new),
	KEY (hospcode),
	KEY (areacode),
	KEY (b_year)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO t_occupat_new (
SELECT @id,p.check_hosp hospcode ,p.check_vhid  areacode	
	  ,@b_year+543 as b_year
		,p.OCCUPATION_NEW
		,COUNT(DISTINCT p.cid) target
		FROM  t_person_cid p
	  WHERE SUBSTR(p.check_vhid,1,2) in(@prov_c)  
       AND p.check_typearea in(1,3) AND p.NATION in(99) 
       AND (p.DISCHARGE  in(2,3,9) OR (p.DISCHARGE  in(1)  AND p.DDISCHARGE > @start_d))
       AND TIMESTAMPDIFF(year,p.birth,CONCAT(@b_year,'0101')) BETWEEN 0 AND 199
		GROUP BY CONCAT(p.check_hosp ,'-' , p.check_vhid ,'-',p.OCCUPATION_NEW)
);
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.939456;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:355;a:5:{i:0;s:40:"DROP PROCEDURE IF EXISTS t_person_envocc";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.939456;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:356;a:5:{i:0;s:40:"DROP PROCEDURE IF EXISTS t_person_envocc";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.9862559;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:358;a:5:{i:0;s:1372:"CREATE PROCEDURE t_person_envocc()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '55';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF  EXISTS t_person_envocc;
CREATE TABLE IF NOT EXISTS t_person_envocc(
PRIMARY KEY (hospcode,areacode)
,KEY (hospcode)
,KEY (areacode)
) ENGINE = myisam AS
(SELECT
	p.check_hosp hospcode,p.vhid areacode
	,COUNT(DISTINCT IF(TIMESTAMPDIFF(year,p.birth,CONCAT(@b_year,'0101')) BETWEEN 0 AND  4,  p.CID,NULL)) result04
	,COUNT(DISTINCT IF(TIMESTAMPDIFF(year,p.birth,CONCAT(@b_year,'0101')) BETWEEN 5 AND  9,  p.CID,NULL)) result59
	,COUNT(DISTINCT IF(TIMESTAMPDIFF(year,p.birth,CONCAT(@b_year,'0101')) BETWEEN 10 AND  14,  p.CID,NULL)) result1014
	,COUNT(DISTINCT IF(TIMESTAMPDIFF(year,p.birth,CONCAT(@b_year,'0101')) BETWEEN 15 AND  59,  p.CID,NULL)) result1559
	,COUNT(DISTINCT IF(TIMESTAMPDIFF(year,p.birth,CONCAT(@b_year,'0101')) BETWEEN 60 AND  199,  p.CID,NULL)) result60
FROM
t_person_cid p
WHERE SUBSTR(p.vhid,1,2) in(@prov_c)  AND (p.cid is null OR p.cid is not null) 
AND p.check_typearea in(1,3) AND p.NATION in(99) 
AND (p.DISCHARGE  in(2,3,9) OR (p.DISCHARGE  in(1)  AND p.DDISCHARGE > @start_d))
AND TIMESTAMPDIFF(year,p.birth,CONCAT(@b_year,'0101')) BETWEEN 0 AND 199
GROUP BY p.check_hosp,p.vhid
);
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.001857;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:359;a:5:{i:0;s:1372:"CREATE PROCEDURE t_person_envocc()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '55';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF  EXISTS t_person_envocc;
CREATE TABLE IF NOT EXISTS t_person_envocc(
PRIMARY KEY (hospcode,areacode)
,KEY (hospcode)
,KEY (areacode)
) ENGINE = myisam AS
(SELECT
	p.check_hosp hospcode,p.vhid areacode
	,COUNT(DISTINCT IF(TIMESTAMPDIFF(year,p.birth,CONCAT(@b_year,'0101')) BETWEEN 0 AND  4,  p.CID,NULL)) result04
	,COUNT(DISTINCT IF(TIMESTAMPDIFF(year,p.birth,CONCAT(@b_year,'0101')) BETWEEN 5 AND  9,  p.CID,NULL)) result59
	,COUNT(DISTINCT IF(TIMESTAMPDIFF(year,p.birth,CONCAT(@b_year,'0101')) BETWEEN 10 AND  14,  p.CID,NULL)) result1014
	,COUNT(DISTINCT IF(TIMESTAMPDIFF(year,p.birth,CONCAT(@b_year,'0101')) BETWEEN 15 AND  59,  p.CID,NULL)) result1559
	,COUNT(DISTINCT IF(TIMESTAMPDIFF(year,p.birth,CONCAT(@b_year,'0101')) BETWEEN 60 AND  199,  p.CID,NULL)) result60
FROM
t_person_cid p
WHERE SUBSTR(p.vhid,1,2) in(@prov_c)  AND (p.cid is null OR p.cid is not null) 
AND p.check_typearea in(1,3) AND p.NATION in(99) 
AND (p.DISCHARGE  in(2,3,9) OR (p.DISCHARGE  in(1)  AND p.DDISCHARGE > @start_d))
AND TIMESTAMPDIFF(year,p.birth,CONCAT(@b_year,'0101')) BETWEEN 0 AND 199
GROUP BY p.check_hosp,p.vhid
);
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.0642569;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:361;a:5:{i:0;s:38:"DROP PROCEDURE IF EXISTS tmp_specialpp";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.0642569;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:362;a:5:{i:0;s:38:"DROP PROCEDURE IF EXISTS tmp_specialpp";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.111057;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:364;a:5:{i:0;s:11130:"CREATE PROCEDURE tmp_specialpp()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '56';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
SET @begin_d=DATE_ADD(@start_d,INTERVAL -43 month);
SET @begin_d1=DATE_ADD(@start_d,INTERVAL -1 month);
SET @end_d1:=concat(@b_year,'1030');


/*เตรียมข้อมูล*/
DROP TABLE IF EXISTS tmp_specialpp;
CREATE TABLE IF NOT EXISTS tmp_specialpp(
PRIMARY KEY (HOSPCODE,PID,DATE_SERV,PPSPECIAL) 
,KEY (cid)
,KEY (hospcode,pid)
,KEY (date_serv)
,KEY (ppspecial)
)(
SELECT 
s.*,p.CID
FROM specialpp s LEFT JOIN person p ON s.HOSPCODE=p.HOSPCODE AND s.PID=p.PID
WHERE DATE_SERV BETWEEN @begin_d1 AND @end_d1
);

/*หาเด็กกลุ่มเป้าหมาย*/
DROP TABLE IF EXISTS t_childdev;
CREATE TABLE  IF NOT EXISTS t_childdev(
  `HOSPCODE` varchar(5) NOT NULL DEFAULT '',
  `PID` varchar(15) NOT NULL DEFAULT '',
  `CID` varchar(13) NOT NULL,
  `BIRTH` date  DEFAULT NULL,
  `SEX` varchar(1) NOT NULL DEFAULT '',
  `AREACODE` varchar(8) DEFAULT NULL,
  `TYPEAREA` varchar(1) NOT NULL DEFAULT '',
  `AGE_9` int(1) NOT NULL DEFAULT '0',
  `AGE_18` int(1) NOT NULL DEFAULT '0',
  `AGE_30` int(1) NOT NULL DEFAULT '0',
  `AGE_42` int(1) NOT NULL DEFAULT '0',
PRIMARY KEY (`HOSPCODE`,`PID`),
 KEY (`HOSPCODE`,`PID`,`CID`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;
INSERT IGNORE INTO t_childdev (SELECT
 p.HOSPCODE,p.PID,p.CID,p.BIRTH,p.SEX,p.check_vhid AREACODE,p.check_typearea TYPEAREA,0,0,0,0
FROM t_person_cid  p
WHERE BIRTH BETWEEN @begin_d AND @end_d AND
						check_typearea in('1','3') AND p.DISCHARGE='9' AND LENGTH(trim(p.CID))=13 AND  NATION in(99) 
);

UPDATE t_childdev SET AGE_9=1 WHERE (DATE_ADD(BIRTH,INTERVAL 9 month)  BETWEEN @start_d AND @end_d) 
			OR (DATE_ADD(BIRTH,INTERVAL 10 month)  BETWEEN @start_d AND @end_d);
UPDATE t_childdev SET AGE_18=1 WHERE (DATE_ADD(BIRTH,INTERVAL 18 month)  BETWEEN @start_d AND @end_d)
			OR (DATE_ADD(BIRTH,INTERVAL 19 month)  BETWEEN @start_d AND @end_d);
UPDATE t_childdev SET AGE_30=1 WHERE (DATE_ADD(BIRTH,INTERVAL 30 month)  BETWEEN @start_d AND @end_d)
			OR (DATE_ADD(BIRTH,INTERVAL 31 month)  BETWEEN @start_d AND @end_d);
UPDATE t_childdev SET AGE_42=1 WHERE (DATE_ADD(BIRTH,INTERVAL 42 month)  BETWEEN @start_d AND @end_d)
			OR (DATE_ADD(BIRTH,INTERVAL 43 month)  BETWEEN @start_d AND @end_d);

/*นำเด็กกลุ่มเป้าหมายเข้าตารางคำนวน*/
DROP TABLE IF EXISTS t_childdev_specialpp;
CREATE TABLE  IF NOT EXISTS t_childdev_specialpp(
hospcode VARCHAR(5) NOT NULL,
pid VARCHAR(15) NOT NULL,
cid VARCHAR(15) NOT NULL DEFAULT '',
birth date,
sex VARCHAR(1) NOT NULL,
areacode VARCHAR(8) NOT NULL,
typearea VARCHAR(1) DEFAULT NULL,
agemonth VARCHAR(3) NOT NULL DEFAULT '',
date_start date,
date_end date,
date_serv_first date,
status1 VARCHAR(1) DEFAULT NULL,
date_serv2 date,
sp_first text,
sp_last text,
date_serv_last date,
status2 VARCHAR(1) DEFAULT NULL,
status21 VARCHAR(1) DEFAULT NULL,
status22 VARCHAR(1) DEFAULT NULL,
status23 VARCHAR(1) DEFAULT NULL,
status24 VARCHAR(1) DEFAULT NULL,
status25 VARCHAR(1) DEFAULT NULL,
 PRIMARY KEY(hospcode,pid,cid,agemonth)
,KEY (hospcode,pid,cid)
) ENGINE=MyISAM ;

INSERT IGNORE INTO t_childdev_specialpp (hospcode,pid,cid,birth,sex,areacode,typearea,agemonth)
(
SELECT
p.hospcode,p.pid,p.cid,p.birth,p.sex,p.areacode,p.typearea,'42'
FROM t_childdev p
WHERE AGE_42=1
);
INSERT IGNORE INTO t_childdev_specialpp (hospcode,pid,cid,birth,sex,areacode,typearea,agemonth)
(
SELECT
p.hospcode,p.pid,p.cid,p.birth,p.sex,p.areacode,p.typearea,'30'
FROM t_childdev p
WHERE AGE_30=1
);
INSERT IGNORE INTO t_childdev_specialpp (hospcode,pid,cid,birth,sex,areacode,typearea,agemonth)
(
SELECT
p.hospcode,p.pid,p.cid,p.birth,p.sex,p.areacode,p.typearea,'18'
FROM t_childdev p
WHERE AGE_18=1
);
INSERT IGNORE INTO t_childdev_specialpp (hospcode,pid,cid,birth,sex,areacode,typearea,agemonth)
(
SELECT
p.hospcode,p.pid,p.cid,p.birth,p.sex,p.areacode,p.typearea,'9'
FROM t_childdev p
WHERE AGE_9=1
);



INSERT IGNORE INTO t_childdev_specialpp (hospcode,pid,cid,birth,sex,areacode,typearea,agemonth)
(SELECT
p.hospcode,p.pid,p.cid,p.birth,p.sex,p.areacode,p.typearea
,IF(age_18=1 AND age_9=1 , 18 ,0)
FROM t_childdev p
);
INSERT IGNORE INTO t_childdev_specialpp (hospcode,pid,cid,birth,sex,areacode,typearea,agemonth)
(SELECT
p.hospcode,p.pid,p.cid,p.birth,p.sex,p.areacode,p.typearea
,IF(age_18=1 AND age_9=1 , 9 ,0)
FROM t_childdev p
);
DELETE FROM t_childdev_specialpp WHERE agemonth=0;

/*อัพเดทช่วงวันที่ที่ทำแล้วถือว่าได้รับการคัดกรอง*/
UPDATE  t_childdev_specialpp SET date_start=DATE_ADD(BIRTH,INTERVAL 9 month) ,date_end=DATE_ADD(DATE_ADD(BIRTH,INTERVAL 10 month),INTERVAL -1 DAY)  WHERE agemonth=9;
UPDATE  t_childdev_specialpp SET date_start=DATE_ADD(BIRTH,INTERVAL 18 month) ,date_end=DATE_ADD(DATE_ADD(BIRTH,INTERVAL 19 month),INTERVAL -1 DAY)  WHERE agemonth=18;
UPDATE  t_childdev_specialpp SET date_start=DATE_ADD(BIRTH,INTERVAL 30 month) ,date_end=DATE_ADD(DATE_ADD(BIRTH,INTERVAL 31 month),INTERVAL -1 DAY)  WHERE agemonth=30;
UPDATE  t_childdev_specialpp SET date_start=DATE_ADD(BIRTH,INTERVAL 42 month) ,date_end=DATE_ADD(DATE_ADD(BIRTH,INTERVAL 43 month),INTERVAL -1 DAY)  WHERE agemonth=42;

/*หาวันที่วันแรกที่ได้รับการตรวจเอาวันน้อยที่สุดจากวันเกิดที่มีรหัสที่กำหนด*/
UPDATE t_childdev_specialpp s INNER JOIN 
(
			SELECT s1.cid,s1.date_start, s1.date_end ,MIN(t1.date_serv) min_date_serv
			FROM tmp_specialpp  t1 INNER JOIN t_childdev_specialpp s1 ON  t1.cid=s1.cid
			WHERE t1.date_serv BETWEEN s1.date_start AND s1.date_end 
			AND PPSPECIAL in('1B260','1B261','1B262' ,'1B200'
			,'1B201','1B202','1B209','1B210','1B211','1B212'
			,'1B219','1B220','1B221','1B222','1B229','1B230'
			,'1B231','1B232','1B239','1B240','1B241','1B242','1B249')
			GROUP BY t1.cid,s1.date_start
)
t  ON s.cid=t.cid   AND s.date_start=t.date_start
SET s.date_serv_first= t.min_date_serv
WHERE t.min_date_serv BETWEEN s.date_start AND s.date_end ;

/*อัพเดททgroup รหัสที่ทำวันแรกทั้งหมด*/
UPDATE t_childdev_specialpp s INNER JOIN 
(
			SELECT s1.cid,s1.date_serv_first ,GROUP_CONCAT(t1.PPSPECIAL ORDER BY t1.PPSPECIAL) gr_sp
			FROM tmp_specialpp  t1 INNER JOIN t_childdev_specialpp s1 ON  t1.cid=s1.cid
			WHERE t1.date_serv in(s1.date_serv_first)
			GROUP BY t1.cid,s1.date_serv_first
)
t  ON s.cid=t.cid  AND s.date_serv_first=t.date_serv_first
SET s.sp_first= t.gr_sp	 ;

/*สรุปผลครั้งแรกตามเงื่อนไข*/
UPDATE t_childdev_specialpp SET status1=IF(INSTR(sp_first,'1B260'),1
,IF(INSTR(sp_first,'1B261'),2
,IF(INSTR(sp_first,'1B262'),3
,NULL
)))
WHERE date_serv_first IS NOT NULL;

/*สรุปผลครั้งแรกถ้าลงรหัสแบบที่ละด้านแบบเดิม*/
UPDATE t_childdev_specialpp SET status1=IF(INSTR(sp_first,'1B200,1B210,1B220,1B230,1B240'),1,NULL)
WHERE date_serv_first IS NOT NULL AND status1 IS NULL;

UPDATE t_childdev_specialpp SET status1=IF(
instr(sp_first,'1B201') 
OR instr(sp_first,'1B211') 
OR instr(sp_first,'1B221') 
OR instr(sp_first,'1B231') 
OR instr(sp_first,'1B241') 
,2,NULL)
WHERE date_serv_first IS NOT NULL AND status1 IS NULL;

UPDATE t_childdev_specialpp SET status1=IF(
instr(sp_first,'1B202') 
OR instr(sp_first,'1B212') 
OR instr(sp_first,'1B222') 
OR instr(sp_first,'1B232') 
OR instr(sp_first,'1B242') 
,3,NULL)
WHERE date_serv_first IS NOT NULL AND status1 IS NULL;


/*อัพเดทวันที่ติดตามนับจากวันครั้งแรกถึงวันสุดท้ายที่ไม่เกิน 30 วันที่เป็นไปได้ กรณีผิดปกติ*/
UPDATE  t_childdev_specialpp SET date_serv2=DATE_ADD(date_serv_first,INTERVAL 30 day) 
WHERE date_serv_first  IS NOT NULL AND status1 in(2) ;


/*หาวันที่วันสุดท้ายที่มาตรวจ  ตามช่วง 30 วันที่กำหนด เปลี่ยนได้ตลอดจนกว่าจะเลย 30 วัน*/
UPDATE t_childdev_specialpp s INNER JOIN 
(
			SELECT s1.cid,s1.date_serv_first, s1.date_serv2 ,MAX(t1.date_serv) max_date_serv
			FROM tmp_specialpp  t1 INNER JOIN t_childdev_specialpp s1 ON  t1.cid=s1.cid
			WHERE t1.date_serv BETWEEN s1.date_serv_first AND s1.date_serv2 
			AND PPSPECIAL in('1B260','1B261','1B262' ,'1B200'
			,'1B201','1B202','1B209','1B210','1B211','1B212'
			,'1B219','1B220','1B221','1B222','1B229','1B230'
			,'1B231','1B232','1B239','1B240','1B241','1B242','1B249')
			GROUP BY t1.cid,s1.date_serv2
)
t  ON s.cid=t.cid  AND s.date_serv2=t.date_serv2
SET s.date_serv_last= t.max_date_serv
WHERE t.max_date_serv BETWEEN s.date_serv_first AND s.date_serv2 
AND t.max_date_serv > s.date_serv_first AND s.date_serv2 is not null;


/*อัพเดททgroup รหัสวันสุดท้ายกรณีที่ติดตาม จะเปลี่ยนแปลงได้ตลอดจนกว่าจะเลย 30 วันจึงจะสรุปได้จริง*/
UPDATE t_childdev_specialpp s INNER JOIN 
(
			SELECT s1.cid,s1.date_serv_last ,GROUP_CONCAT(t1.PPSPECIAL) gr_sp
			FROM tmp_specialpp  t1 INNER JOIN t_childdev_specialpp s1 ON  t1.cid=s1.cid
			WHERE t1.date_serv in(s1.date_serv_last)
			GROUP BY t1.cid,s1.date_serv_last
)
t  ON s.cid=t.cid   AND s.date_serv_last=t.date_serv_last
SET s.sp_last= t.gr_sp
WHERE  s.date_serv2 is not null	 ;
/*สรุปผลครั้งสุดท้าย*/
UPDATE t_childdev_specialpp SET status21=IF(INSTR(sp_last,'1B202'),1,null),
status22=IF(INSTR(sp_last,'1B212'),1,null),
status23=IF(INSTR(sp_last,'1B222'),1,null),
status24=IF(INSTR(sp_last,'1B232'),1,null),
status25= IF(INSTR(sp_last,'1B242'),1,null)
WHERE date_serv_last IS NOT NULL AND  INSTR(sp_last,'1B260')=0  
AND date_serv_last > date_serv_first  
AND NOW() > date_serv2 
AND date_serv2 is not null;

UPDATE t_childdev_specialpp SET status2=IF(INSTR(sp_last,'1B260'),1,NULL)
 WHERE date_serv_last IS NOT NULL AND date_serv_last > date_serv_first AND status2 IS NULL
AND date_serv2 is not null;

/*สรุปผลครั้งสุดท้ายถ้าลงรหัสแบบที่ละด้านแบบเดิม*/
UPDATE t_childdev_specialpp SET status2=IF(INSTR(sp_first,'1B200,1B210,1B220,1B230,1B240'),1,NULL)
WHERE date_serv_last IS NOT NULL AND date_serv_last > date_serv_first AND status2 IS NULL
AND date_serv2 is not null;
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.111057;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:365;a:5:{i:0;s:11130:"CREATE PROCEDURE tmp_specialpp()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '56';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
SET @begin_d=DATE_ADD(@start_d,INTERVAL -43 month);
SET @begin_d1=DATE_ADD(@start_d,INTERVAL -1 month);
SET @end_d1:=concat(@b_year,'1030');


/*เตรียมข้อมูล*/
DROP TABLE IF EXISTS tmp_specialpp;
CREATE TABLE IF NOT EXISTS tmp_specialpp(
PRIMARY KEY (HOSPCODE,PID,DATE_SERV,PPSPECIAL) 
,KEY (cid)
,KEY (hospcode,pid)
,KEY (date_serv)
,KEY (ppspecial)
)(
SELECT 
s.*,p.CID
FROM specialpp s LEFT JOIN person p ON s.HOSPCODE=p.HOSPCODE AND s.PID=p.PID
WHERE DATE_SERV BETWEEN @begin_d1 AND @end_d1
);

/*หาเด็กกลุ่มเป้าหมาย*/
DROP TABLE IF EXISTS t_childdev;
CREATE TABLE  IF NOT EXISTS t_childdev(
  `HOSPCODE` varchar(5) NOT NULL DEFAULT '',
  `PID` varchar(15) NOT NULL DEFAULT '',
  `CID` varchar(13) NOT NULL,
  `BIRTH` date  DEFAULT NULL,
  `SEX` varchar(1) NOT NULL DEFAULT '',
  `AREACODE` varchar(8) DEFAULT NULL,
  `TYPEAREA` varchar(1) NOT NULL DEFAULT '',
  `AGE_9` int(1) NOT NULL DEFAULT '0',
  `AGE_18` int(1) NOT NULL DEFAULT '0',
  `AGE_30` int(1) NOT NULL DEFAULT '0',
  `AGE_42` int(1) NOT NULL DEFAULT '0',
PRIMARY KEY (`HOSPCODE`,`PID`),
 KEY (`HOSPCODE`,`PID`,`CID`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;
INSERT IGNORE INTO t_childdev (SELECT
 p.HOSPCODE,p.PID,p.CID,p.BIRTH,p.SEX,p.check_vhid AREACODE,p.check_typearea TYPEAREA,0,0,0,0
FROM t_person_cid  p
WHERE BIRTH BETWEEN @begin_d AND @end_d AND
						check_typearea in('1','3') AND p.DISCHARGE='9' AND LENGTH(trim(p.CID))=13 AND  NATION in(99) 
);

UPDATE t_childdev SET AGE_9=1 WHERE (DATE_ADD(BIRTH,INTERVAL 9 month)  BETWEEN @start_d AND @end_d) 
			OR (DATE_ADD(BIRTH,INTERVAL 10 month)  BETWEEN @start_d AND @end_d);
UPDATE t_childdev SET AGE_18=1 WHERE (DATE_ADD(BIRTH,INTERVAL 18 month)  BETWEEN @start_d AND @end_d)
			OR (DATE_ADD(BIRTH,INTERVAL 19 month)  BETWEEN @start_d AND @end_d);
UPDATE t_childdev SET AGE_30=1 WHERE (DATE_ADD(BIRTH,INTERVAL 30 month)  BETWEEN @start_d AND @end_d)
			OR (DATE_ADD(BIRTH,INTERVAL 31 month)  BETWEEN @start_d AND @end_d);
UPDATE t_childdev SET AGE_42=1 WHERE (DATE_ADD(BIRTH,INTERVAL 42 month)  BETWEEN @start_d AND @end_d)
			OR (DATE_ADD(BIRTH,INTERVAL 43 month)  BETWEEN @start_d AND @end_d);

/*นำเด็กกลุ่มเป้าหมายเข้าตารางคำนวน*/
DROP TABLE IF EXISTS t_childdev_specialpp;
CREATE TABLE  IF NOT EXISTS t_childdev_specialpp(
hospcode VARCHAR(5) NOT NULL,
pid VARCHAR(15) NOT NULL,
cid VARCHAR(15) NOT NULL DEFAULT '',
birth date,
sex VARCHAR(1) NOT NULL,
areacode VARCHAR(8) NOT NULL,
typearea VARCHAR(1) DEFAULT NULL,
agemonth VARCHAR(3) NOT NULL DEFAULT '',
date_start date,
date_end date,
date_serv_first date,
status1 VARCHAR(1) DEFAULT NULL,
date_serv2 date,
sp_first text,
sp_last text,
date_serv_last date,
status2 VARCHAR(1) DEFAULT NULL,
status21 VARCHAR(1) DEFAULT NULL,
status22 VARCHAR(1) DEFAULT NULL,
status23 VARCHAR(1) DEFAULT NULL,
status24 VARCHAR(1) DEFAULT NULL,
status25 VARCHAR(1) DEFAULT NULL,
 PRIMARY KEY(hospcode,pid,cid,agemonth)
,KEY (hospcode,pid,cid)
) ENGINE=MyISAM ;

INSERT IGNORE INTO t_childdev_specialpp (hospcode,pid,cid,birth,sex,areacode,typearea,agemonth)
(
SELECT
p.hospcode,p.pid,p.cid,p.birth,p.sex,p.areacode,p.typearea,'42'
FROM t_childdev p
WHERE AGE_42=1
);
INSERT IGNORE INTO t_childdev_specialpp (hospcode,pid,cid,birth,sex,areacode,typearea,agemonth)
(
SELECT
p.hospcode,p.pid,p.cid,p.birth,p.sex,p.areacode,p.typearea,'30'
FROM t_childdev p
WHERE AGE_30=1
);
INSERT IGNORE INTO t_childdev_specialpp (hospcode,pid,cid,birth,sex,areacode,typearea,agemonth)
(
SELECT
p.hospcode,p.pid,p.cid,p.birth,p.sex,p.areacode,p.typearea,'18'
FROM t_childdev p
WHERE AGE_18=1
);
INSERT IGNORE INTO t_childdev_specialpp (hospcode,pid,cid,birth,sex,areacode,typearea,agemonth)
(
SELECT
p.hospcode,p.pid,p.cid,p.birth,p.sex,p.areacode,p.typearea,'9'
FROM t_childdev p
WHERE AGE_9=1
);



INSERT IGNORE INTO t_childdev_specialpp (hospcode,pid,cid,birth,sex,areacode,typearea,agemonth)
(SELECT
p.hospcode,p.pid,p.cid,p.birth,p.sex,p.areacode,p.typearea
,IF(age_18=1 AND age_9=1 , 18 ,0)
FROM t_childdev p
);
INSERT IGNORE INTO t_childdev_specialpp (hospcode,pid,cid,birth,sex,areacode,typearea,agemonth)
(SELECT
p.hospcode,p.pid,p.cid,p.birth,p.sex,p.areacode,p.typearea
,IF(age_18=1 AND age_9=1 , 9 ,0)
FROM t_childdev p
);
DELETE FROM t_childdev_specialpp WHERE agemonth=0;

/*อัพเดทช่วงวันที่ที่ทำแล้วถือว่าได้รับการคัดกรอง*/
UPDATE  t_childdev_specialpp SET date_start=DATE_ADD(BIRTH,INTERVAL 9 month) ,date_end=DATE_ADD(DATE_ADD(BIRTH,INTERVAL 10 month),INTERVAL -1 DAY)  WHERE agemonth=9;
UPDATE  t_childdev_specialpp SET date_start=DATE_ADD(BIRTH,INTERVAL 18 month) ,date_end=DATE_ADD(DATE_ADD(BIRTH,INTERVAL 19 month),INTERVAL -1 DAY)  WHERE agemonth=18;
UPDATE  t_childdev_specialpp SET date_start=DATE_ADD(BIRTH,INTERVAL 30 month) ,date_end=DATE_ADD(DATE_ADD(BIRTH,INTERVAL 31 month),INTERVAL -1 DAY)  WHERE agemonth=30;
UPDATE  t_childdev_specialpp SET date_start=DATE_ADD(BIRTH,INTERVAL 42 month) ,date_end=DATE_ADD(DATE_ADD(BIRTH,INTERVAL 43 month),INTERVAL -1 DAY)  WHERE agemonth=42;

/*หาวันที่วันแรกที่ได้รับการตรวจเอาวันน้อยที่สุดจากวันเกิดที่มีรหัสที่กำหนด*/
UPDATE t_childdev_specialpp s INNER JOIN 
(
			SELECT s1.cid,s1.date_start, s1.date_end ,MIN(t1.date_serv) min_date_serv
			FROM tmp_specialpp  t1 INNER JOIN t_childdev_specialpp s1 ON  t1.cid=s1.cid
			WHERE t1.date_serv BETWEEN s1.date_start AND s1.date_end 
			AND PPSPECIAL in('1B260','1B261','1B262' ,'1B200'
			,'1B201','1B202','1B209','1B210','1B211','1B212'
			,'1B219','1B220','1B221','1B222','1B229','1B230'
			,'1B231','1B232','1B239','1B240','1B241','1B242','1B249')
			GROUP BY t1.cid,s1.date_start
)
t  ON s.cid=t.cid   AND s.date_start=t.date_start
SET s.date_serv_first= t.min_date_serv
WHERE t.min_date_serv BETWEEN s.date_start AND s.date_end ;

/*อัพเดททgroup รหัสที่ทำวันแรกทั้งหมด*/
UPDATE t_childdev_specialpp s INNER JOIN 
(
			SELECT s1.cid,s1.date_serv_first ,GROUP_CONCAT(t1.PPSPECIAL ORDER BY t1.PPSPECIAL) gr_sp
			FROM tmp_specialpp  t1 INNER JOIN t_childdev_specialpp s1 ON  t1.cid=s1.cid
			WHERE t1.date_serv in(s1.date_serv_first)
			GROUP BY t1.cid,s1.date_serv_first
)
t  ON s.cid=t.cid  AND s.date_serv_first=t.date_serv_first
SET s.sp_first= t.gr_sp	 ;

/*สรุปผลครั้งแรกตามเงื่อนไข*/
UPDATE t_childdev_specialpp SET status1=IF(INSTR(sp_first,'1B260'),1
,IF(INSTR(sp_first,'1B261'),2
,IF(INSTR(sp_first,'1B262'),3
,NULL
)))
WHERE date_serv_first IS NOT NULL;

/*สรุปผลครั้งแรกถ้าลงรหัสแบบที่ละด้านแบบเดิม*/
UPDATE t_childdev_specialpp SET status1=IF(INSTR(sp_first,'1B200,1B210,1B220,1B230,1B240'),1,NULL)
WHERE date_serv_first IS NOT NULL AND status1 IS NULL;

UPDATE t_childdev_specialpp SET status1=IF(
instr(sp_first,'1B201') 
OR instr(sp_first,'1B211') 
OR instr(sp_first,'1B221') 
OR instr(sp_first,'1B231') 
OR instr(sp_first,'1B241') 
,2,NULL)
WHERE date_serv_first IS NOT NULL AND status1 IS NULL;

UPDATE t_childdev_specialpp SET status1=IF(
instr(sp_first,'1B202') 
OR instr(sp_first,'1B212') 
OR instr(sp_first,'1B222') 
OR instr(sp_first,'1B232') 
OR instr(sp_first,'1B242') 
,3,NULL)
WHERE date_serv_first IS NOT NULL AND status1 IS NULL;


/*อัพเดทวันที่ติดตามนับจากวันครั้งแรกถึงวันสุดท้ายที่ไม่เกิน 30 วันที่เป็นไปได้ กรณีผิดปกติ*/
UPDATE  t_childdev_specialpp SET date_serv2=DATE_ADD(date_serv_first,INTERVAL 30 day) 
WHERE date_serv_first  IS NOT NULL AND status1 in(2) ;


/*หาวันที่วันสุดท้ายที่มาตรวจ  ตามช่วง 30 วันที่กำหนด เปลี่ยนได้ตลอดจนกว่าจะเลย 30 วัน*/
UPDATE t_childdev_specialpp s INNER JOIN 
(
			SELECT s1.cid,s1.date_serv_first, s1.date_serv2 ,MAX(t1.date_serv) max_date_serv
			FROM tmp_specialpp  t1 INNER JOIN t_childdev_specialpp s1 ON  t1.cid=s1.cid
			WHERE t1.date_serv BETWEEN s1.date_serv_first AND s1.date_serv2 
			AND PPSPECIAL in('1B260','1B261','1B262' ,'1B200'
			,'1B201','1B202','1B209','1B210','1B211','1B212'
			,'1B219','1B220','1B221','1B222','1B229','1B230'
			,'1B231','1B232','1B239','1B240','1B241','1B242','1B249')
			GROUP BY t1.cid,s1.date_serv2
)
t  ON s.cid=t.cid  AND s.date_serv2=t.date_serv2
SET s.date_serv_last= t.max_date_serv
WHERE t.max_date_serv BETWEEN s.date_serv_first AND s.date_serv2 
AND t.max_date_serv > s.date_serv_first AND s.date_serv2 is not null;


/*อัพเดททgroup รหัสวันสุดท้ายกรณีที่ติดตาม จะเปลี่ยนแปลงได้ตลอดจนกว่าจะเลย 30 วันจึงจะสรุปได้จริง*/
UPDATE t_childdev_specialpp s INNER JOIN 
(
			SELECT s1.cid,s1.date_serv_last ,GROUP_CONCAT(t1.PPSPECIAL) gr_sp
			FROM tmp_specialpp  t1 INNER JOIN t_childdev_specialpp s1 ON  t1.cid=s1.cid
			WHERE t1.date_serv in(s1.date_serv_last)
			GROUP BY t1.cid,s1.date_serv_last
)
t  ON s.cid=t.cid   AND s.date_serv_last=t.date_serv_last
SET s.sp_last= t.gr_sp
WHERE  s.date_serv2 is not null	 ;
/*สรุปผลครั้งสุดท้าย*/
UPDATE t_childdev_specialpp SET status21=IF(INSTR(sp_last,'1B202'),1,null),
status22=IF(INSTR(sp_last,'1B212'),1,null),
status23=IF(INSTR(sp_last,'1B222'),1,null),
status24=IF(INSTR(sp_last,'1B232'),1,null),
status25= IF(INSTR(sp_last,'1B242'),1,null)
WHERE date_serv_last IS NOT NULL AND  INSTR(sp_last,'1B260')=0  
AND date_serv_last > date_serv_first  
AND NOW() > date_serv2 
AND date_serv2 is not null;

UPDATE t_childdev_specialpp SET status2=IF(INSTR(sp_last,'1B260'),1,NULL)
 WHERE date_serv_last IS NOT NULL AND date_serv_last > date_serv_first AND status2 IS NULL
AND date_serv2 is not null;

/*สรุปผลครั้งสุดท้ายถ้าลงรหัสแบบที่ละด้านแบบเดิม*/
UPDATE t_childdev_specialpp SET status2=IF(INSTR(sp_first,'1B200,1B210,1B220,1B230,1B240'),1,NULL)
WHERE date_serv_last IS NOT NULL AND date_serv_last > date_serv_first AND status2 IS NULL
AND date_serv2 is not null;
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.1734569;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:367;a:5:{i:0;s:44:"DROP PROCEDURE IF EXISTS t_nutrition_service";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.1734569;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:368;a:5:{i:0;s:44:"DROP PROCEDURE IF EXISTS t_nutrition_service";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.251457;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:370;a:5:{i:0;s:3554:"CREATE PROCEDURE t_nutrition_service()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '57';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS t_nutrition_service;
CREATE TABLE IF NOT EXISTS t_nutrition_service(
hospcode VARCHAR(5) NOT NULL,
pid VARCHAR(15) NOT NULL,
seq VARCHAR(16) NOT NULL,
date_serv date,
weight decimal(5,1) NOT NULL,
height  int(3) NOT NULL,
HEADCIRCUM int(3) DEFAULT NULL,
FOOD varchar(1) DEFAULT NULL,
BOTTLE varchar(1) DEFAULT NULL,
BIRTH date,
SEX varchar(1) NOT NULL,
NATION varchar(3) DEFAULT NULL,
quarter_m int(1) DEFAULT 0,
nutri1 int(1) DEFAULT 0,
nutri2 int(1) DEFAULT 0,
nutri3 int(1) DEFAULT 0,
PRIMARY KEY (hospcode,pid,quarter_m)
)  ENGINE MyISAM DEFAULT CHARACTER SET=utf8;

INSERT IGNORE INTO t_nutrition_service (HOSPCODE,PID,SEQ,DATE_SERV,WEIGHT,HEIGHT,HEADCIRCUM,FOOD,BOTTLE
,BIRTH,SEX,NATION,quarter_m)
(
SELECT n.HOSPCODE,n.PID,n.SEQ,n.DATE_SERV,n.WEIGHT,n.HEIGHT,n.HEADCIRCUM,FOOD,BOTTLE
,p.BIRTH,p.SEX,p.NATION, IF(DATE_FORMAT(n.DATE_SERV,'%m') BETWEEN 10 AND 12,1,
IF(DATE_FORMAT(n.DATE_SERV,'%m') BETWEEN 1 AND 3,2,
IF(DATE_FORMAT(n.DATE_SERV,'%m') BETWEEN 4 AND 6,3,
IF(DATE_FORMAT(n.DATE_SERV,'%m') BETWEEN 7 AND 9,4,0
 )))) as quarter_m
FROM
tmp_nutrition n INNER JOIN t_person_db p ON n.HOSPCODE=p.HOSPCODE AND n.PID=p.PID
WHERE WEIGHT BETWEEN 0.1  AND 300 AND HEIGHT   BETWEEN 40 AND 250 
AND n.DATE_SERV >= p.birth
AND n.DATE_SERV BETWEEN  @start_d AND @end_d
AND p.NATION in(99) 
ORDER BY n.HOSPCODE ASC ,n.PID ASC ,n.DATE_SERV DESC 
);

UPDATE t_nutrition_service SET nutri1=nutri_cal(TIMESTAMPDIFF(month,birth,date_serv),sex,1,height,weight)
,nutri2=nutri_cal(TIMESTAMPDIFF(month,birth,date_serv),sex,2,height,weight)
,nutri3=nutri_cal(TIMESTAMPDIFF(month,birth,date_serv),sex,3,height,weight);

DROP TABLE IF EXISTS t_nutrition_service6_14;
CREATE TABLE IF NOT EXISTS t_nutrition_service6_14(
hospcode VARCHAR(5) NOT NULL,
pid VARCHAR(15) NOT NULL,
seq VARCHAR(16) NOT NULL,
date_serv date,
weight decimal(5,1) NOT NULL,
height  int(3) NOT NULL,
HEADCIRCUM int(3) DEFAULT NULL,
FOOD varchar(1) DEFAULT NULL,
BOTTLE varchar(1) DEFAULT NULL,
BIRTH date,
SEX varchar(1) NOT NULL,
NATION varchar(3) DEFAULT NULL,
quarter_m int(1) DEFAULT 0,
nutri1 int(1) DEFAULT 0,
nutri2 int(1) DEFAULT 0,
nutri3 int(1) DEFAULT 0,
PRIMARY KEY (hospcode,pid,quarter_m)
)  ENGINE MyISAM DEFAULT CHARACTER SET=utf8;

INSERT IGNORE INTO t_nutrition_service6_14 (HOSPCODE,PID,SEQ,DATE_SERV,WEIGHT,HEIGHT,HEADCIRCUM,FOOD,BOTTLE
,BIRTH,SEX,NATION,quarter_m)
(
SELECT n.HOSPCODE,n.PID,n.SEQ,n.DATE_SERV,n.WEIGHT,n.HEIGHT,n.HEADCIRCUM,FOOD,BOTTLE
,p.BIRTH,p.SEX,p.NATION, IF(DATE_FORMAT(n.DATE_SERV,'%m') BETWEEN 10 AND 11,2,
IF(DATE_FORMAT(n.DATE_SERV,'%m') BETWEEN 5 AND 6,1,0
 )) as quarter_m
FROM
tmp_nutrition n INNER JOIN t_person_db p ON n.HOSPCODE=p.HOSPCODE AND n.PID=p.PID
WHERE WEIGHT BETWEEN 0.1  AND 300 AND HEIGHT   BETWEEN 40 AND 250 
AND n.DATE_SERV >= p.birth AND TIMESTAMPDIFF(YEAR,p.BIRTH,n.DATE_SERV) BETWEEN 6 AND 14
AND  n.DATE_SERV BETWEEN  @start_d AND @end_d
AND p.NATION in(99) 
ORDER BY n.HOSPCODE ASC ,n.PID ASC ,n.DATE_SERV DESC 
);

UPDATE t_nutrition_service6_14 SET nutri1=nutri_cal(TIMESTAMPDIFF(month,birth,date_serv),sex,1,height,weight)
,nutri2=nutri_cal(TIMESTAMPDIFF(month,birth,date_serv),sex,2,height,weight)
,nutri3=nutri_cal(TIMESTAMPDIFF(month,birth,date_serv),sex,3,height,weight);


 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.251457;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:371;a:5:{i:0;s:3554:"CREATE PROCEDURE t_nutrition_service()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '57';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS t_nutrition_service;
CREATE TABLE IF NOT EXISTS t_nutrition_service(
hospcode VARCHAR(5) NOT NULL,
pid VARCHAR(15) NOT NULL,
seq VARCHAR(16) NOT NULL,
date_serv date,
weight decimal(5,1) NOT NULL,
height  int(3) NOT NULL,
HEADCIRCUM int(3) DEFAULT NULL,
FOOD varchar(1) DEFAULT NULL,
BOTTLE varchar(1) DEFAULT NULL,
BIRTH date,
SEX varchar(1) NOT NULL,
NATION varchar(3) DEFAULT NULL,
quarter_m int(1) DEFAULT 0,
nutri1 int(1) DEFAULT 0,
nutri2 int(1) DEFAULT 0,
nutri3 int(1) DEFAULT 0,
PRIMARY KEY (hospcode,pid,quarter_m)
)  ENGINE MyISAM DEFAULT CHARACTER SET=utf8;

INSERT IGNORE INTO t_nutrition_service (HOSPCODE,PID,SEQ,DATE_SERV,WEIGHT,HEIGHT,HEADCIRCUM,FOOD,BOTTLE
,BIRTH,SEX,NATION,quarter_m)
(
SELECT n.HOSPCODE,n.PID,n.SEQ,n.DATE_SERV,n.WEIGHT,n.HEIGHT,n.HEADCIRCUM,FOOD,BOTTLE
,p.BIRTH,p.SEX,p.NATION, IF(DATE_FORMAT(n.DATE_SERV,'%m') BETWEEN 10 AND 12,1,
IF(DATE_FORMAT(n.DATE_SERV,'%m') BETWEEN 1 AND 3,2,
IF(DATE_FORMAT(n.DATE_SERV,'%m') BETWEEN 4 AND 6,3,
IF(DATE_FORMAT(n.DATE_SERV,'%m') BETWEEN 7 AND 9,4,0
 )))) as quarter_m
FROM
tmp_nutrition n INNER JOIN t_person_db p ON n.HOSPCODE=p.HOSPCODE AND n.PID=p.PID
WHERE WEIGHT BETWEEN 0.1  AND 300 AND HEIGHT   BETWEEN 40 AND 250 
AND n.DATE_SERV >= p.birth
AND n.DATE_SERV BETWEEN  @start_d AND @end_d
AND p.NATION in(99) 
ORDER BY n.HOSPCODE ASC ,n.PID ASC ,n.DATE_SERV DESC 
);

UPDATE t_nutrition_service SET nutri1=nutri_cal(TIMESTAMPDIFF(month,birth,date_serv),sex,1,height,weight)
,nutri2=nutri_cal(TIMESTAMPDIFF(month,birth,date_serv),sex,2,height,weight)
,nutri3=nutri_cal(TIMESTAMPDIFF(month,birth,date_serv),sex,3,height,weight);

DROP TABLE IF EXISTS t_nutrition_service6_14;
CREATE TABLE IF NOT EXISTS t_nutrition_service6_14(
hospcode VARCHAR(5) NOT NULL,
pid VARCHAR(15) NOT NULL,
seq VARCHAR(16) NOT NULL,
date_serv date,
weight decimal(5,1) NOT NULL,
height  int(3) NOT NULL,
HEADCIRCUM int(3) DEFAULT NULL,
FOOD varchar(1) DEFAULT NULL,
BOTTLE varchar(1) DEFAULT NULL,
BIRTH date,
SEX varchar(1) NOT NULL,
NATION varchar(3) DEFAULT NULL,
quarter_m int(1) DEFAULT 0,
nutri1 int(1) DEFAULT 0,
nutri2 int(1) DEFAULT 0,
nutri3 int(1) DEFAULT 0,
PRIMARY KEY (hospcode,pid,quarter_m)
)  ENGINE MyISAM DEFAULT CHARACTER SET=utf8;

INSERT IGNORE INTO t_nutrition_service6_14 (HOSPCODE,PID,SEQ,DATE_SERV,WEIGHT,HEIGHT,HEADCIRCUM,FOOD,BOTTLE
,BIRTH,SEX,NATION,quarter_m)
(
SELECT n.HOSPCODE,n.PID,n.SEQ,n.DATE_SERV,n.WEIGHT,n.HEIGHT,n.HEADCIRCUM,FOOD,BOTTLE
,p.BIRTH,p.SEX,p.NATION, IF(DATE_FORMAT(n.DATE_SERV,'%m') BETWEEN 10 AND 11,2,
IF(DATE_FORMAT(n.DATE_SERV,'%m') BETWEEN 5 AND 6,1,0
 )) as quarter_m
FROM
tmp_nutrition n INNER JOIN t_person_db p ON n.HOSPCODE=p.HOSPCODE AND n.PID=p.PID
WHERE WEIGHT BETWEEN 0.1  AND 300 AND HEIGHT   BETWEEN 40 AND 250 
AND n.DATE_SERV >= p.birth AND TIMESTAMPDIFF(YEAR,p.BIRTH,n.DATE_SERV) BETWEEN 6 AND 14
AND  n.DATE_SERV BETWEEN  @start_d AND @end_d
AND p.NATION in(99) 
ORDER BY n.HOSPCODE ASC ,n.PID ASC ,n.DATE_SERV DESC 
);

UPDATE t_nutrition_service6_14 SET nutri1=nutri_cal(TIMESTAMPDIFF(month,birth,date_serv),sex,1,height,weight)
,nutri2=nutri_cal(TIMESTAMPDIFF(month,birth,date_serv),sex,2,height,weight)
,nutri3=nutri_cal(TIMESTAMPDIFF(month,birth,date_serv),sex,3,height,weight);


 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.3138571;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:373;a:5:{i:0;s:34:"DROP PROCEDURE IF EXISTS t_cvdrisk";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.3138571;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:374;a:5:{i:0;s:34:"DROP PROCEDURE IF EXISTS t_cvdrisk";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.3918569;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:376;a:5:{i:0;s:18289:"CREATE PROCEDURE t_cvdrisk()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '58';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'0701');
SET	@start_d10:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
SET @end_d12:=concat(@b_year-1,'1231');

DROP TABLE IF EXISTS t_cvd_ill;
CREATE TABLE IF NOT EXISTS t_cvd_ill(
 CID varchar(13) NOT NULL
 ,`BIRTH` date
 ,`SEX` varchar(1) NOT NULL
 ,source_tb VARCHAR(255) DEFAULT NULL 
 ,mix_dx VARCHAR(255) DEFAULT NULL 	
 ,date_dx VARCHAR(255) DEFAULT NULL 
 ,hosp_dx varchar(255) DEFAULT NULL 
 ,hosp_input varchar(255) DEFAULT NULL 
,PRIMARY KEY (`CID`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;
INSERT IGNORE INTO 	t_cvd_ill (
SELECT cid,birth,sex
,GROUP_CONCAT(source_tb ORDER BY date_dx)
,GROUP_CONCAT(diagcode ORDER BY date_dx)
,GROUP_CONCAT(date_dx ORDER BY date_dx)
,GROUP_CONCAT(IFNULL(hosp_dx,input_hosp) ORDER BY date_dx)
,GROUP_CONCAT(input_hosp ORDER BY date_dx)
FROM t_chronic WHERE SUBSTR(UPPER(diagcode),1,4) IN ('E105','E115','E125','E135','E145','I110','I119') 
OR SUBSTR(UPPER(diagcode),1,3) BETWEEN  'I60' AND 'I64' 
OR SUBSTR(UPPER(diagcode),1,3) IN ('I13') 
GROUP BY cid
);

DROP TABLE IF EXISTS tmp_fu_screen;
CREATE TABLE IF NOT EXISTS tmp_fu_screen(
 `HOSPCODE` varchar(5) NOT NULL,
 `CID` varchar(13) DEFAULT NULL,
 `PID` varchar(15) NOT NULL,
	`SEQ` varchar(16) NOT NULL,
 `DATE_SERV` date NOT NULL,
 `SBP` int(3) NOT NULL DEFAULT  0,
 `SBP_SOURCE` VARCHAR(20) DEFAULT NULL,
 `WAIST_CM` int(3) NOT NULL DEFAULT 0,
 `WAIST_SOURCE` VARCHAR(20) DEFAULT NULL,
 `HEIGHT` int(3) NOT NULL DEFAULT 0,
 `HEIGHT_SOURCE` VARCHAR(20) DEFAULT NULL,
 `QUARTERM` VARCHAR(1) DEFAULT NULL,
PRIMARY KEY (`HOSPCODE`,`PID`,`DATE_SERV`),
  KEY  (`HOSPCODE`,`PID`),
  KEY  (`HOSPCODE`),
  KEY  (`DATE_SERV`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO tmp_fu_screen (
SELECT  HOSPCODE,CID,PID,SEQ,DATE_SERV,SBP,'CHRONICFU',WAIST_CM,'CHRONICFU',HEIGHT,'CHRONICFU',NULL
FROM tmp_chronicfu
WHERE date_serv BETWEEN @start_d AND @end_d
);
INSERT IGNORE INTO tmp_fu_screen (
SELECT  HOSPCODE,CID,PID,SEQ,DATE_SERV,IF(SBP_2>0,SBP_2,SBP_1) SBP,'NCDSCREEN',WAIST_CM,'NCDSCREEN',HEIGHT,'NCDSCREEN',NULL
FROM tmp_ncdscreen
WHERE date_serv BETWEEN @start_d AND @end_d
);
UPDATE tmp_fu_screen SET QUARTERM=IF( DATE_SERV < concat(@b_year-1,'1001'),0,
IF(DATE_SERV BETWEEN concat(@b_year-1,'1001') AND concat(@b_year-1,'1231'),1,
IF(DATE_SERV BETWEEN concat(@b_year,'0101') AND concat(@b_year,'0331'),2,
IF(DATE_SERV BETWEEN concat(@b_year,'0401') AND concat(@b_year,'0630'),3,
IF(DATE_SERV BETWEEN concat(@b_year,'0701') AND concat(@b_year,'0930'),4,null
)))));

/*LAB TOTAL CHOL*/
DROP TABLE IF EXISTS tmz_labcvd;
CREATE TABLE IF NOT EXISTS tmz_labcvd(
 `QUARTERM` VARCHAR(1) DEFAULT NULL,
PRIMARY KEY (HOSPCODE,PID,SEQ,LABTEST),KEY (CID) ,KEY (DATE_SERV), KEY (HOSPCODE,PID,DATE_SERV)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 AS
(SELECT *,null as QUARTERM FROM tmp_labfu WHERE LABTEST in(7) AND LABRESULT >0 GROUP BY HOSPCODE,PID,SEQ,LABTEST);

UPDATE tmz_labcvd SET QUARTERM=IF( DATE_SERV < concat(@b_year-1,'1001'),0,
IF(DATE_SERV BETWEEN concat(@b_year-1,'1001') AND concat(@b_year-1,'1231'),1,
IF(DATE_SERV BETWEEN concat(@b_year,'0101') AND concat(@b_year,'0331'),2,
IF(DATE_SERV BETWEEN concat(@b_year,'0401') AND concat(@b_year,'0630'),3,
IF(DATE_SERV BETWEEN concat(@b_year,'0701') AND concat(@b_year,'0930'),4,null
)))));

/*SMOKE */
DROP TABLE IF EXISTS tmp_smoke;
CREATE TABLE IF NOT EXISTS tmp_smoke(
 `HOSPCODE` varchar(5) NOT NULL,
 `PID` varchar(15) NOT NULL,
 `CID` varchar(13) DEFAULT NULL,
 `DATE_SERV` date NOT NULL,
 `SMOKE_SOURCE`  VARCHAR(50) DEFAULT NULL,
 `RESULT` VARCHAR(1) DEFAULT NULL COMMENT '1=สูบ,0=ไม่สูบ',
 `QUARTERM` VARCHAR(1) DEFAULT NULL,
PRIMARY KEY (HOSPCODE,PID,DATE_SERV),KEY (CID) ,KEY (DATE_SERV), KEY (HOSPCODE,PID,DATE_SERV)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 ;

INSERT IGNORE INTO tmp_smoke(
SELECT HOSPCODE,PID,CID,DATE_SERV,'NCDSCREEN',IF(SMOKE=1,0,1) ,NULL 
FROM tmp_ncdscreen WHERE SMOKE in(1,2,3,4)
);
INSERT IGNORE INTO tmp_smoke(
SELECT  HOSPCODE,PID,CID,DATE_SERV,'SPECIALPP',1 ,NULL 
FROM tmp_specialpp 
WHERE SUBSTR(PPSPECIAL,1,4) IN('1B50','1B53','1B54','1B55','1B56')
);
INSERT IGNORE INTO tmp_smoke(
SELECT  HOSPCODE,PID,CID,DATE_SERV,'SPECIALPP',0 ,NULL 
FROM tmp_specialpp WHERE PPSPECIAL in('1B51','1B52') 
);
UPDATE tmp_smoke SET QUARTERM=IF( DATE_SERV < concat(@b_year-1,'1001'),0,
IF(DATE_SERV BETWEEN concat(@b_year-1,'1001') AND concat(@b_year-1,'1231'),1,
IF(DATE_SERV BETWEEN concat(@b_year,'0101') AND concat(@b_year,'0331'),2,
IF(DATE_SERV BETWEEN concat(@b_year,'0401') AND concat(@b_year,'0630'),3,
IF(DATE_SERV BETWEEN concat(@b_year,'0701') AND concat(@b_year,'0930'),4,null
)))));

/*T_CVD*/
DROP TABLE IF EXISTS t_cvdrisk;
CREATE TABLE IF NOT EXISTS t_cvdrisk(
 `CID` varchar(13) DEFAULT NULL
 ,`BIRTH` date
 ,`SEX` varchar(1) NOT NULL
 ,`TYPEAREA` varchar(1) NOT NULL
 ,`nation` varchar(3) DEFAULT NULL
,source_tb VARCHAR(255) DEFAULT NULL 
 ,mix_dx VARCHAR(255) DEFAULT NULL 	
 ,t_mix_dx VARCHAR(255) DEFAULT NULL 	
 ,type_dx VARCHAR(2) DEFAULT NULL 
 ,date_dx VARCHAR(255) DEFAULT NULL 
 ,hosp_dx varchar(255) DEFAULT NULL 
	,`AGE_Y` int(3) NOT NULL DEFAULT '0' 
	,`SEX_CVD` varchar(1) DEFAULT NULL
 ,`QUARTERM` VARCHAR(1) DEFAULT NULL
 ,`SMOKING` varchar(1) DEFAULT NULL
 ,`SMOKE_DATE` date DEFAULT NULL
 ,`SMOKE_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`SMOKE_SOURCE` VARCHAR(20) DEFAULT NULL
 ,`DM` varchar(1) DEFAULT NULL
 ,`SBP` int(3) NOT NULL DEFAULT  0
 ,`SBP_DATE` date DEFAULT NULL
 ,`SBP_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`SBP_SOURCE` VARCHAR(20) DEFAULT NULL
 ,`CHOL` double(6,2) NOT NULL DEFAULT 0
 ,`CHOL_DATE` date DEFAULT NULL
 ,`CHOL_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`WAIST_CM` int(3) NOT NULL DEFAULT 0
 ,`WAIST_DATE` date DEFAULT NULL
 ,`WAIST_HOSPCODE` VARCHAR(5) DEFAULT NULL
  ,`WAIST_SOURCE` VARCHAR(20) DEFAULT NULL
 ,`HEIGHT` int(3) NOT NULL DEFAULT 0
 ,`HEIGHT_DATE` date DEFAULT NULL
 ,`HEIGHT_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`HEIGHT_SOURCE` VARCHAR(20) DEFAULT NULL
 ,`RISK_SCORE` DECIMAL(5,2) NOT NULL DEFAULT 0.00
,PRIMARY KEY (`CID`, `QUARTERM` )
	,KEY  (`CID`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

SET @x=0;
SET @max= 5;
WHILE @x<@max DO
INSERT IGNORE INTO t_cvdrisk(
	cid,birth,sex,typearea,age_y,nation,source_tb,hosp_dx,mix_dx,t_mix_dx,date_dx,QUARTERM
)
(
	SELECT SQL_BIG_RESULT 
			p.cid,p.birth,p.sex,p.typearea, p.age_y,p.nation
			,GROUP_CONCAT(c.source_tb order by date_dx) source_tb
			,GROUP_CONCAT(hosp_dx order by date_dx) hosp_dx
			,GROUP_CONCAT(diagcode order by date_dx ) diagcode
			,GROUP_CONCAT(DISTINCT  substr(diagcode,1,1) order by  substr(diagcode,1,1) ) 
			,GROUP_CONCAT(date_dx order by date_dx) date_dx
			,@x
FROM
(SELECT c.* FROM t_chronic c LEFT JOIN t_cvd_ill i ON c.cid=i.cid
WHERE  (SUBSTR(UPPER(c.diagcode),1,3) BETWEEN  'E10' and 'E14'  OR 	SUBSTR(UPPER(c.diagcode),1,3) BETWEEN  'I10' and 'I15')  
AND ISNULL(i.cid)
GROUP BY concat(c.cid,'-',c.diagcode) ) c 
INNER JOIN t_person_cid  p ON c.cid = p.cid
WHERE p.nation in(99) AND p.DISCHARGE in(9) AND c.typedisch NOT in(2)
GROUP BY p.cid
);

SET  @x = @x + 1; 
END WHILE;
/*up_mixdiag*/
UPDATE t_cvdrisk 
	SET type_dx = if(t_mix_dx ='I' ,'01'  
							,if(t_mix_dx ='E' ,'02'
							,if(t_mix_dx ='E,I','03',NULL)));
/*up sex cvd*/
UPDATE t_cvdrisk SET SEX_CVD = IF(SEX=2,0,1);
/*up DM*/
UPDATE  t_cvdrisk SET DM=IF(type_dx in(2,3),1,0);
/*dele QUARTER BEFORE date_dx*/
DELETE FROM t_cvdrisk 
WHERE DATE_FORMAT(SUBSTR(date_dx,1,10),'%Y%m') > DATE_FORMAT(concat(@b_year,'0630'),'%Y%m')
AND QUARTERM < 4;

DELETE FROM t_cvdrisk 
WHERE DATE_FORMAT(SUBSTR(date_dx,1,10),'%Y%m') > DATE_FORMAT(concat(@b_year,'0331'),'%Y%m')
AND QUARTERM < 3;

DELETE FROM t_cvdrisk 
WHERE DATE_FORMAT(SUBSTR(date_dx,1,10),'%Y%m') > DATE_FORMAT(concat((@b_year-1),'1231'),'%Y%m')
AND QUARTERM < 2;

DELETE FROM t_cvdrisk 
WHERE DATE_FORMAT(SUBSTR(date_dx,1,10),'%Y%m') > DATE_FORMAT(concat((@b_year-1),'0930'),'%Y%m')
AND QUARTERM < 1;

/*last date sbp*/
SET @x=0;
SET @max= 5;
WHILE @x<@max DO
UPDATE  t_cvdrisk c INNER JOIN 
(SELECT cid,MAX(DATE_SERV) date_serv 
FROM tmp_fu_screen  WHERE SBP BETWEEN 50 AND 300 AND QUARTERM in(@x) GROUP BY CID)  f ON c.cid=f.cid 
SET c.SBP_DATE=f.DATE_SERV WHERE c.QUARTERM in(@x);
SET  @x = @x + 1; 
END WHILE;
/*up last sbp*/
UPDATE  t_cvdrisk c INNER JOIN tmp_fu_screen f ON c.cid=f.cid AND c.SBP_DATE=f.DATE_SERV  
SET c.SBP=f.SBP ,c.SBP_SOURCE=f.SBP_SOURCE,c.SBP_HOSPCODE=f.HOSPCODE
WHERE f.SBP BETWEEN 50 AND 300 ;
/*last date height*/
SET @x=0;
SET @max= 5;
WHILE @x<@max DO
UPDATE  t_cvdrisk c INNER JOIN 
(SELECT cid,MAX(DATE_SERV) date_serv 
FROM tmp_fu_screen  WHERE HEIGHT BETWEEN 90 AND 300 AND QUARTERM in(@x) GROUP BY CID)  f ON c.cid=f.cid 
SET c.HEIGHT_DATE=f.DATE_SERV WHERE c.QUARTERM in(@x);
SET  @x = @x + 1; 
END WHILE;
/*up last height*/
UPDATE  t_cvdrisk c INNER JOIN tmp_fu_screen f ON c.cid=f.cid AND c.HEIGHT_DATE=f.DATE_SERV  
SET c.HEIGHT=f.HEIGHT ,c.HEIGHT_SOURCE=f.HEIGHT_SOURCE,c.HEIGHT_HOSPCODE=f.HOSPCODE
WHERE f.HEIGHT BETWEEN 90 AND 300 ;
/*last date waist*/
SET @x=0;
SET @max= 5;
WHILE @x<@max DO
UPDATE  t_cvdrisk c INNER JOIN 
(SELECT cid,MAX(DATE_SERV) date_serv 
FROM tmp_fu_screen  WHERE WAIST_CM  BETWEEN 40 AND 300 AND QUARTERM in(@x) GROUP BY CID)  f ON c.cid=f.cid 
SET c.WAIST_DATE=f.DATE_SERV WHERE c.QUARTERM in(@x);
SET  @x = @x + 1; 
END WHILE;
/*up last waist*/
UPDATE  t_cvdrisk c INNER JOIN tmp_fu_screen f ON c.cid=f.cid AND c.WAIST_DATE=f.DATE_SERV  
SET c.WAIST_CM=f.WAIST_CM ,c.WAIST_SOURCE=f.WAIST_SOURCE,c.WAIST_HOSPCODE=f.HOSPCODE
WHERE f.WAIST_CM  BETWEEN 40 AND 300 ;

/*last date CHOL*/
SET @x=0;
SET @max= 5;
WHILE @x<@max DO
UPDATE  t_cvdrisk c INNER JOIN 
(SELECT cid,MAX(DATE_SERV) date_serv 
FROM tmz_labcvd  WHERE  QUARTERM in(@x) GROUP BY CID)  f ON c.cid=f.cid 
SET c.CHOL_DATE=f.DATE_SERV WHERE c.QUARTERM in(@x);
SET  @x = @x + 1; 
END WHILE;
/*up last CHOL*/
UPDATE  t_cvdrisk c INNER JOIN tmz_labcvd f ON c.cid=f.cid AND c.CHOL_DATE=f.DATE_SERV  
SET c.CHOL=f.labresult ,c.CHOL_HOSPCODE=f.HOSPCODE;

/*SMOKE*/
UPDATE t_cvdrisk c INNER JOIN (
SELECT cid,RESULT,SMOKE_SOURCE ,HOSPCODE,DATE_SERV
FROM tmp_smoke WHERE DATE_SERV BETWEEN @start_d AND @end_d AND RESULT IN(1)
GROUP BY cid
) f ON c.cid=f.cid
SET c.SMOKE_DATE=f.DATE_SERV,c.SMOKING=f.RESULT ,c.SMOKE_SOURCE=f.SMOKE_SOURCE,c.SMOKE_HOSPCODE=f.HOSPCODE;

UPDATE t_cvdrisk c INNER JOIN (
SELECT cid,RESULT,SMOKE_SOURCE ,HOSPCODE,DATE_SERV
FROM tmp_smoke WHERE DATE_SERV BETWEEN @start_d AND @end_d AND RESULT IN(0)
GROUP BY cid
) f ON c.cid=f.cid
SET c.SMOKE_DATE=f.DATE_SERV,c.SMOKING=f.RESULT ,c.SMOKE_SOURCE=f.SMOKE_SOURCE,c.SMOKE_HOSPCODE=f.HOSPCODE
WHERE ISNULL(c.SMOKING);

/*calc*/
UPDATE t_cvdrisk SET RISK_SCORE=cvd_func(AGE_Y,SEX_CVD,SBP,DM,SMOKING,CHOL,WAIST_CM,HEIGHT)
WHERE AGE_Y >0 AND SEX_CVD is not null  AND DM is not null  AND SMOKING is not null  AND SBP >0 
AND (CHOL >0 OR (WAIST_CM >0 AND HEIGHT >0)) ;

DROP TABLE IF EXISTS t_cvdrisk_fl;
CREATE TABLE IF NOT EXISTS t_cvdrisk_fl(
 `CID` varchar(13) DEFAULT NULL
 ,`BIRTH` date
 ,`SEX` varchar(1) NOT NULL
 ,`TYPEAREA` varchar(1) NOT NULL
 ,`nation` varchar(3) DEFAULT NULL
 ,source_tb VARCHAR(255) DEFAULT NULL 
 ,mix_dx VARCHAR(255) DEFAULT NULL 	
 ,t_mix_dx VARCHAR(255) DEFAULT NULL 	
 ,type_dx VARCHAR(2) DEFAULT NULL 
 ,date_dx VARCHAR(255) DEFAULT NULL 
 ,hosp_dx varchar(255) DEFAULT NULL 
	,`AGE_Y` int(3) NOT NULL DEFAULT '0' 
	,`SEX_CVD` varchar(1) DEFAULT NULL
,`DM` varchar(1) DEFAULT NULL
 ,`F_SMOKING` varchar(1) DEFAULT NULL
 ,`F_SMOKE_DATE` date DEFAULT NULL
 ,`F_SMOKE_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`F_SMOKE_SOURCE` VARCHAR(20) DEFAULT NULL
 ,`L_SMOKING` varchar(1) DEFAULT NULL
 ,`L_SMOKE_DATE` date DEFAULT NULL
 ,`L_SMOKE_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`L_SMOKE_SOURCE` VARCHAR(20) DEFAULT NULL
 ,`F_SBP` int(3) NOT NULL DEFAULT  0
 ,`F_SBP_DATE` date DEFAULT NULL
 ,`F_SBP_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`F_SBP_SOURCE` VARCHAR(20) DEFAULT NULL
 ,`L_SBP` int(3) NOT NULL DEFAULT  0
 ,`L_SBP_DATE` date DEFAULT NULL
 ,`L_SBP_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`L_SBP_SOURCE` VARCHAR(20) DEFAULT NULL
 ,`F_CHOL` double(6,2) NOT NULL DEFAULT 0
 ,`F_CHOL_DATE` date DEFAULT NULL
 ,`F_CHOL_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`L_CHOL` double(6,2) NOT NULL DEFAULT 0
 ,`L_CHOL_DATE` date DEFAULT NULL
 ,`L_CHOL_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`F_WAIST_CM` int(3) NOT NULL DEFAULT 0
 ,`F_WAIST_DATE` date DEFAULT NULL
 ,`F_WAIST_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`F_WAIST_SOURCE` VARCHAR(20) DEFAULT NULL
,`L_WAIST_CM` int(3) NOT NULL DEFAULT 0
 ,`L_WAIST_DATE` date DEFAULT NULL
 ,`L_WAIST_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`L_WAIST_SOURCE` VARCHAR(20) DEFAULT NULL
 ,`F_HEIGHT` int(3) NOT NULL DEFAULT 0
 ,`F_HEIGHT_DATE` date DEFAULT NULL
 ,`F_HEIGHT_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`F_HEIGHT_SOURCE` VARCHAR(20) DEFAULT NULL
 ,`L_HEIGHT` int(3) NOT NULL DEFAULT 0
 ,`L_HEIGHT_DATE` date DEFAULT NULL
 ,`L_HEIGHT_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`L_HEIGHT_SOURCE` VARCHAR(20) DEFAULT NULL
 ,`F_RISK_SCORE` DECIMAL(5,2) NOT NULL DEFAULT 0.00
 ,`L_RISK_SCORE` DECIMAL(5,2) NOT NULL DEFAULT 0.00
,PRIMARY KEY (`CID`)
	,KEY  (`CID`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;
INSERT IGNORE INTO t_cvdrisk_fl (cid,birth,sex,typearea,age_y,nation,source_tb,hosp_dx,mix_dx,t_mix_dx,date_dx,dm,sex_cvd,type_dx)
(
SELECT cid,birth,sex,typearea,age_y,nation,source_tb,hosp_dx,mix_dx,t_mix_dx,date_dx,dm,sex_cvd,type_dx
FROM t_cvdrisk 
);

UPDATE  t_cvdrisk_fl c INNER JOIN 
(SELECT cid,MIN(SMOKE_DATE) date_serv 
FROM t_cvdrisk  WHERE SMOKE_DATE BETWEEN @start_d AND @end_d
 GROUP BY CID)  f ON c.cid=f.cid 
SET c.F_SMOKE_DATE=f.DATE_SERV;
UPDATE  t_cvdrisk_fl c INNER JOIN t_cvdrisk f ON c.cid=f.cid AND c.F_SMOKE_DATE=f.SMOKE_DATE  
SET c.F_SMOKING=f.SMOKING ,c.F_SMOKE_SOURCE=f.SMOKE_SOURCE,c.F_SMOKE_HOSPCODE=f.SMOKE_HOSPCODE;

UPDATE  t_cvdrisk_fl c INNER JOIN 
(SELECT cid,MAX(SMOKE_DATE) date_serv 
FROM t_cvdrisk  WHERE SMOKE_DATE BETWEEN @start_d AND @end_d
GROUP BY CID)  f ON c.cid=f.cid 
SET c.L_SMOKE_DATE=f.DATE_SERV;
UPDATE  t_cvdrisk_fl c INNER JOIN t_cvdrisk f ON c.cid=f.cid AND c.L_SMOKE_DATE=f.SMOKE_DATE  
SET c.L_SMOKING=f.SMOKING ,c.L_SMOKE_SOURCE=f.SMOKE_SOURCE,c.L_SMOKE_HOSPCODE=f.SMOKE_HOSPCODE;

UPDATE  t_cvdrisk_fl c INNER JOIN 
(SELECT cid,MIN(SBP_DATE) date_serv 
FROM t_cvdrisk  WHERE SBP_DATE  BETWEEN @start_d AND @end_d12
GROUP BY CID)  f ON c.cid=f.cid 
SET c.F_SBP_DATE=f.DATE_SERV;
UPDATE  t_cvdrisk_fl c INNER JOIN t_cvdrisk f ON c.cid=f.cid AND c.F_SBP_DATE=f.SBP_DATE  
SET c.F_SBP=f.SBP ,c.F_SBP_SOURCE=f.SBP_SOURCE,c.F_SBP_HOSPCODE=f.SBP_HOSPCODE;

UPDATE  t_cvdrisk_fl c INNER JOIN 
(SELECT cid,MAX(SBP_DATE) date_serv 
FROM t_cvdrisk  WHERE  SBP_DATE BETWEEN @start_d10 AND @end_d
GROUP BY CID)  f ON c.cid=f.cid 
SET c.L_SBP_DATE=f.DATE_SERV;
UPDATE  t_cvdrisk_fl c INNER JOIN t_cvdrisk f ON c.cid=f.cid AND c.L_SBP_DATE=f.SBP_DATE  
SET c.L_SBP=f.SBP ,c.L_SBP_SOURCE=f.SBP_SOURCE,c.L_SBP_HOSPCODE=f.SBP_HOSPCODE;

UPDATE  t_cvdrisk_fl c INNER JOIN 
(SELECT cid,MIN(CHOL_DATE) date_serv 
FROM t_cvdrisk  WHERE CHOL_DATE BETWEEN @start_d AND @end_d12
GROUP BY CID)  f ON c.cid=f.cid 
SET c.F_CHOL_DATE=f.DATE_SERV;
UPDATE  t_cvdrisk_fl c INNER JOIN t_cvdrisk f ON c.cid=f.cid AND c.F_CHOL_DATE=f.CHOL_DATE  
SET c.F_CHOL=f.CHOL ,c.F_CHOL_HOSPCODE=f.CHOL_HOSPCODE;

UPDATE  t_cvdrisk_fl c INNER JOIN 
(SELECT cid,MAX(CHOL_DATE) date_serv 
FROM t_cvdrisk  WHERE  CHOL_DATE BETWEEN @start_d10 AND @end_d
GROUP BY CID)  f ON c.cid=f.cid 
SET c.L_CHOL_DATE=f.DATE_SERV;
UPDATE  t_cvdrisk_fl c INNER JOIN t_cvdrisk f ON c.cid=f.cid AND c.L_CHOL_DATE=f.CHOL_DATE  
SET c.L_CHOL=f.CHOL ,c.L_CHOL_HOSPCODE=f.CHOL_HOSPCODE;

UPDATE  t_cvdrisk_fl c INNER JOIN 
(SELECT cid,MIN(WAIST_DATE) date_serv 
FROM t_cvdrisk  WHERE WAIST_DATE BETWEEN @start_d AND @end_d12
GROUP BY CID)  f ON c.cid=f.cid 
SET c.F_WAIST_DATE=f.DATE_SERV;
UPDATE  t_cvdrisk_fl c INNER JOIN t_cvdrisk f ON c.cid=f.cid AND c.F_WAIST_DATE=f.WAIST_DATE  
SET c.F_WAIST_CM=f.WAIST_CM ,c.F_WAIST_SOURCE=f.WAIST_SOURCE,c.F_WAIST_HOSPCODE=f.WAIST_HOSPCODE;

UPDATE  t_cvdrisk_fl c INNER JOIN 
(SELECT cid,MAX(WAIST_DATE) date_serv 
FROM t_cvdrisk  WHERE WAIST_DATE BETWEEN @start_d10 AND @end_d 
GROUP BY CID)  f ON c.cid=f.cid 
SET c.L_WAIST_DATE=f.DATE_SERV;
UPDATE  t_cvdrisk_fl c INNER JOIN t_cvdrisk f ON c.cid=f.cid AND c.L_WAIST_DATE=f.WAIST_DATE  
SET c.L_WAIST_CM=f.WAIST_CM ,c.L_WAIST_SOURCE=f.WAIST_SOURCE,c.L_WAIST_HOSPCODE=f.WAIST_HOSPCODE;

UPDATE  t_cvdrisk_fl c INNER JOIN 
(SELECT cid,MIN(HEIGHT_DATE) date_serv 
FROM t_cvdrisk  WHERE HEIGHT_DATE BETWEEN @start_d AND @end_d12
GROUP BY CID)  f ON c.cid=f.cid 
SET c.F_HEIGHT_DATE=f.DATE_SERV;
UPDATE  t_cvdrisk_fl c INNER JOIN t_cvdrisk f ON c.cid=f.cid AND c.F_HEIGHT_DATE=f.HEIGHT_DATE  
SET c.F_HEIGHT=f.HEIGHT ,c.F_HEIGHT_SOURCE=f.HEIGHT_SOURCE,c.F_HEIGHT_HOSPCODE=f.HEIGHT_HOSPCODE;

UPDATE  t_cvdrisk_fl c INNER JOIN 
(SELECT cid,MAX(HEIGHT_DATE) date_serv 
FROM t_cvdrisk  WHERE HEIGHT_DATE BETWEEN @start_d AND @end_d
GROUP BY CID)  f ON c.cid=f.cid 
SET c.L_HEIGHT_DATE=f.DATE_SERV;
UPDATE  t_cvdrisk_fl c INNER JOIN t_cvdrisk f ON c.cid=f.cid AND c.L_HEIGHT_DATE=f.HEIGHT_DATE  
SET c.L_HEIGHT=f.HEIGHT ,c.L_HEIGHT_SOURCE=f.HEIGHT_SOURCE,c.L_HEIGHT_HOSPCODE=f.HEIGHT_HOSPCODE;

UPDATE t_cvdrisk_fl SET F_RISK_SCORE=cvd_func(AGE_Y,SEX_CVD,F_SBP,DM,F_SMOKING,F_CHOL,F_WAIST_CM,F_HEIGHT)
WHERE AGE_Y >0 AND SEX_CVD is not null  AND DM is not null  AND F_SMOKING is not null  AND F_SBP >0 
AND (F_CHOL >0 OR (F_WAIST_CM >0 AND F_HEIGHT >0)) ;

UPDATE t_cvdrisk_fl SET L_RISK_SCORE=cvd_func(AGE_Y,SEX_CVD,L_SBP,DM,L_SMOKING,L_CHOL,L_WAIST_CM,L_HEIGHT) 
WHERE AGE_Y >0 AND SEX_CVD is not null  AND DM is not null  AND L_SMOKING is not null  AND L_SBP >0 
AND (L_CHOL >0 OR (L_WAIST_CM >0 AND L_HEIGHT >0)) ;

 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.3918569;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:377;a:5:{i:0;s:18289:"CREATE PROCEDURE t_cvdrisk()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '58';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'0701');
SET	@start_d10:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
SET @end_d12:=concat(@b_year-1,'1231');

DROP TABLE IF EXISTS t_cvd_ill;
CREATE TABLE IF NOT EXISTS t_cvd_ill(
 CID varchar(13) NOT NULL
 ,`BIRTH` date
 ,`SEX` varchar(1) NOT NULL
 ,source_tb VARCHAR(255) DEFAULT NULL 
 ,mix_dx VARCHAR(255) DEFAULT NULL 	
 ,date_dx VARCHAR(255) DEFAULT NULL 
 ,hosp_dx varchar(255) DEFAULT NULL 
 ,hosp_input varchar(255) DEFAULT NULL 
,PRIMARY KEY (`CID`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;
INSERT IGNORE INTO 	t_cvd_ill (
SELECT cid,birth,sex
,GROUP_CONCAT(source_tb ORDER BY date_dx)
,GROUP_CONCAT(diagcode ORDER BY date_dx)
,GROUP_CONCAT(date_dx ORDER BY date_dx)
,GROUP_CONCAT(IFNULL(hosp_dx,input_hosp) ORDER BY date_dx)
,GROUP_CONCAT(input_hosp ORDER BY date_dx)
FROM t_chronic WHERE SUBSTR(UPPER(diagcode),1,4) IN ('E105','E115','E125','E135','E145','I110','I119') 
OR SUBSTR(UPPER(diagcode),1,3) BETWEEN  'I60' AND 'I64' 
OR SUBSTR(UPPER(diagcode),1,3) IN ('I13') 
GROUP BY cid
);

DROP TABLE IF EXISTS tmp_fu_screen;
CREATE TABLE IF NOT EXISTS tmp_fu_screen(
 `HOSPCODE` varchar(5) NOT NULL,
 `CID` varchar(13) DEFAULT NULL,
 `PID` varchar(15) NOT NULL,
	`SEQ` varchar(16) NOT NULL,
 `DATE_SERV` date NOT NULL,
 `SBP` int(3) NOT NULL DEFAULT  0,
 `SBP_SOURCE` VARCHAR(20) DEFAULT NULL,
 `WAIST_CM` int(3) NOT NULL DEFAULT 0,
 `WAIST_SOURCE` VARCHAR(20) DEFAULT NULL,
 `HEIGHT` int(3) NOT NULL DEFAULT 0,
 `HEIGHT_SOURCE` VARCHAR(20) DEFAULT NULL,
 `QUARTERM` VARCHAR(1) DEFAULT NULL,
PRIMARY KEY (`HOSPCODE`,`PID`,`DATE_SERV`),
  KEY  (`HOSPCODE`,`PID`),
  KEY  (`HOSPCODE`),
  KEY  (`DATE_SERV`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO tmp_fu_screen (
SELECT  HOSPCODE,CID,PID,SEQ,DATE_SERV,SBP,'CHRONICFU',WAIST_CM,'CHRONICFU',HEIGHT,'CHRONICFU',NULL
FROM tmp_chronicfu
WHERE date_serv BETWEEN @start_d AND @end_d
);
INSERT IGNORE INTO tmp_fu_screen (
SELECT  HOSPCODE,CID,PID,SEQ,DATE_SERV,IF(SBP_2>0,SBP_2,SBP_1) SBP,'NCDSCREEN',WAIST_CM,'NCDSCREEN',HEIGHT,'NCDSCREEN',NULL
FROM tmp_ncdscreen
WHERE date_serv BETWEEN @start_d AND @end_d
);
UPDATE tmp_fu_screen SET QUARTERM=IF( DATE_SERV < concat(@b_year-1,'1001'),0,
IF(DATE_SERV BETWEEN concat(@b_year-1,'1001') AND concat(@b_year-1,'1231'),1,
IF(DATE_SERV BETWEEN concat(@b_year,'0101') AND concat(@b_year,'0331'),2,
IF(DATE_SERV BETWEEN concat(@b_year,'0401') AND concat(@b_year,'0630'),3,
IF(DATE_SERV BETWEEN concat(@b_year,'0701') AND concat(@b_year,'0930'),4,null
)))));

/*LAB TOTAL CHOL*/
DROP TABLE IF EXISTS tmz_labcvd;
CREATE TABLE IF NOT EXISTS tmz_labcvd(
 `QUARTERM` VARCHAR(1) DEFAULT NULL,
PRIMARY KEY (HOSPCODE,PID,SEQ,LABTEST),KEY (CID) ,KEY (DATE_SERV), KEY (HOSPCODE,PID,DATE_SERV)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 AS
(SELECT *,null as QUARTERM FROM tmp_labfu WHERE LABTEST in(7) AND LABRESULT >0 GROUP BY HOSPCODE,PID,SEQ,LABTEST);

UPDATE tmz_labcvd SET QUARTERM=IF( DATE_SERV < concat(@b_year-1,'1001'),0,
IF(DATE_SERV BETWEEN concat(@b_year-1,'1001') AND concat(@b_year-1,'1231'),1,
IF(DATE_SERV BETWEEN concat(@b_year,'0101') AND concat(@b_year,'0331'),2,
IF(DATE_SERV BETWEEN concat(@b_year,'0401') AND concat(@b_year,'0630'),3,
IF(DATE_SERV BETWEEN concat(@b_year,'0701') AND concat(@b_year,'0930'),4,null
)))));

/*SMOKE */
DROP TABLE IF EXISTS tmp_smoke;
CREATE TABLE IF NOT EXISTS tmp_smoke(
 `HOSPCODE` varchar(5) NOT NULL,
 `PID` varchar(15) NOT NULL,
 `CID` varchar(13) DEFAULT NULL,
 `DATE_SERV` date NOT NULL,
 `SMOKE_SOURCE`  VARCHAR(50) DEFAULT NULL,
 `RESULT` VARCHAR(1) DEFAULT NULL COMMENT '1=สูบ,0=ไม่สูบ',
 `QUARTERM` VARCHAR(1) DEFAULT NULL,
PRIMARY KEY (HOSPCODE,PID,DATE_SERV),KEY (CID) ,KEY (DATE_SERV), KEY (HOSPCODE,PID,DATE_SERV)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 ;

INSERT IGNORE INTO tmp_smoke(
SELECT HOSPCODE,PID,CID,DATE_SERV,'NCDSCREEN',IF(SMOKE=1,0,1) ,NULL 
FROM tmp_ncdscreen WHERE SMOKE in(1,2,3,4)
);
INSERT IGNORE INTO tmp_smoke(
SELECT  HOSPCODE,PID,CID,DATE_SERV,'SPECIALPP',1 ,NULL 
FROM tmp_specialpp 
WHERE SUBSTR(PPSPECIAL,1,4) IN('1B50','1B53','1B54','1B55','1B56')
);
INSERT IGNORE INTO tmp_smoke(
SELECT  HOSPCODE,PID,CID,DATE_SERV,'SPECIALPP',0 ,NULL 
FROM tmp_specialpp WHERE PPSPECIAL in('1B51','1B52') 
);
UPDATE tmp_smoke SET QUARTERM=IF( DATE_SERV < concat(@b_year-1,'1001'),0,
IF(DATE_SERV BETWEEN concat(@b_year-1,'1001') AND concat(@b_year-1,'1231'),1,
IF(DATE_SERV BETWEEN concat(@b_year,'0101') AND concat(@b_year,'0331'),2,
IF(DATE_SERV BETWEEN concat(@b_year,'0401') AND concat(@b_year,'0630'),3,
IF(DATE_SERV BETWEEN concat(@b_year,'0701') AND concat(@b_year,'0930'),4,null
)))));

/*T_CVD*/
DROP TABLE IF EXISTS t_cvdrisk;
CREATE TABLE IF NOT EXISTS t_cvdrisk(
 `CID` varchar(13) DEFAULT NULL
 ,`BIRTH` date
 ,`SEX` varchar(1) NOT NULL
 ,`TYPEAREA` varchar(1) NOT NULL
 ,`nation` varchar(3) DEFAULT NULL
,source_tb VARCHAR(255) DEFAULT NULL 
 ,mix_dx VARCHAR(255) DEFAULT NULL 	
 ,t_mix_dx VARCHAR(255) DEFAULT NULL 	
 ,type_dx VARCHAR(2) DEFAULT NULL 
 ,date_dx VARCHAR(255) DEFAULT NULL 
 ,hosp_dx varchar(255) DEFAULT NULL 
	,`AGE_Y` int(3) NOT NULL DEFAULT '0' 
	,`SEX_CVD` varchar(1) DEFAULT NULL
 ,`QUARTERM` VARCHAR(1) DEFAULT NULL
 ,`SMOKING` varchar(1) DEFAULT NULL
 ,`SMOKE_DATE` date DEFAULT NULL
 ,`SMOKE_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`SMOKE_SOURCE` VARCHAR(20) DEFAULT NULL
 ,`DM` varchar(1) DEFAULT NULL
 ,`SBP` int(3) NOT NULL DEFAULT  0
 ,`SBP_DATE` date DEFAULT NULL
 ,`SBP_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`SBP_SOURCE` VARCHAR(20) DEFAULT NULL
 ,`CHOL` double(6,2) NOT NULL DEFAULT 0
 ,`CHOL_DATE` date DEFAULT NULL
 ,`CHOL_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`WAIST_CM` int(3) NOT NULL DEFAULT 0
 ,`WAIST_DATE` date DEFAULT NULL
 ,`WAIST_HOSPCODE` VARCHAR(5) DEFAULT NULL
  ,`WAIST_SOURCE` VARCHAR(20) DEFAULT NULL
 ,`HEIGHT` int(3) NOT NULL DEFAULT 0
 ,`HEIGHT_DATE` date DEFAULT NULL
 ,`HEIGHT_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`HEIGHT_SOURCE` VARCHAR(20) DEFAULT NULL
 ,`RISK_SCORE` DECIMAL(5,2) NOT NULL DEFAULT 0.00
,PRIMARY KEY (`CID`, `QUARTERM` )
	,KEY  (`CID`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

SET @x=0;
SET @max= 5;
WHILE @x<@max DO
INSERT IGNORE INTO t_cvdrisk(
	cid,birth,sex,typearea,age_y,nation,source_tb,hosp_dx,mix_dx,t_mix_dx,date_dx,QUARTERM
)
(
	SELECT SQL_BIG_RESULT 
			p.cid,p.birth,p.sex,p.typearea, p.age_y,p.nation
			,GROUP_CONCAT(c.source_tb order by date_dx) source_tb
			,GROUP_CONCAT(hosp_dx order by date_dx) hosp_dx
			,GROUP_CONCAT(diagcode order by date_dx ) diagcode
			,GROUP_CONCAT(DISTINCT  substr(diagcode,1,1) order by  substr(diagcode,1,1) ) 
			,GROUP_CONCAT(date_dx order by date_dx) date_dx
			,@x
FROM
(SELECT c.* FROM t_chronic c LEFT JOIN t_cvd_ill i ON c.cid=i.cid
WHERE  (SUBSTR(UPPER(c.diagcode),1,3) BETWEEN  'E10' and 'E14'  OR 	SUBSTR(UPPER(c.diagcode),1,3) BETWEEN  'I10' and 'I15')  
AND ISNULL(i.cid)
GROUP BY concat(c.cid,'-',c.diagcode) ) c 
INNER JOIN t_person_cid  p ON c.cid = p.cid
WHERE p.nation in(99) AND p.DISCHARGE in(9) AND c.typedisch NOT in(2)
GROUP BY p.cid
);

SET  @x = @x + 1; 
END WHILE;
/*up_mixdiag*/
UPDATE t_cvdrisk 
	SET type_dx = if(t_mix_dx ='I' ,'01'  
							,if(t_mix_dx ='E' ,'02'
							,if(t_mix_dx ='E,I','03',NULL)));
/*up sex cvd*/
UPDATE t_cvdrisk SET SEX_CVD = IF(SEX=2,0,1);
/*up DM*/
UPDATE  t_cvdrisk SET DM=IF(type_dx in(2,3),1,0);
/*dele QUARTER BEFORE date_dx*/
DELETE FROM t_cvdrisk 
WHERE DATE_FORMAT(SUBSTR(date_dx,1,10),'%Y%m') > DATE_FORMAT(concat(@b_year,'0630'),'%Y%m')
AND QUARTERM < 4;

DELETE FROM t_cvdrisk 
WHERE DATE_FORMAT(SUBSTR(date_dx,1,10),'%Y%m') > DATE_FORMAT(concat(@b_year,'0331'),'%Y%m')
AND QUARTERM < 3;

DELETE FROM t_cvdrisk 
WHERE DATE_FORMAT(SUBSTR(date_dx,1,10),'%Y%m') > DATE_FORMAT(concat((@b_year-1),'1231'),'%Y%m')
AND QUARTERM < 2;

DELETE FROM t_cvdrisk 
WHERE DATE_FORMAT(SUBSTR(date_dx,1,10),'%Y%m') > DATE_FORMAT(concat((@b_year-1),'0930'),'%Y%m')
AND QUARTERM < 1;

/*last date sbp*/
SET @x=0;
SET @max= 5;
WHILE @x<@max DO
UPDATE  t_cvdrisk c INNER JOIN 
(SELECT cid,MAX(DATE_SERV) date_serv 
FROM tmp_fu_screen  WHERE SBP BETWEEN 50 AND 300 AND QUARTERM in(@x) GROUP BY CID)  f ON c.cid=f.cid 
SET c.SBP_DATE=f.DATE_SERV WHERE c.QUARTERM in(@x);
SET  @x = @x + 1; 
END WHILE;
/*up last sbp*/
UPDATE  t_cvdrisk c INNER JOIN tmp_fu_screen f ON c.cid=f.cid AND c.SBP_DATE=f.DATE_SERV  
SET c.SBP=f.SBP ,c.SBP_SOURCE=f.SBP_SOURCE,c.SBP_HOSPCODE=f.HOSPCODE
WHERE f.SBP BETWEEN 50 AND 300 ;
/*last date height*/
SET @x=0;
SET @max= 5;
WHILE @x<@max DO
UPDATE  t_cvdrisk c INNER JOIN 
(SELECT cid,MAX(DATE_SERV) date_serv 
FROM tmp_fu_screen  WHERE HEIGHT BETWEEN 90 AND 300 AND QUARTERM in(@x) GROUP BY CID)  f ON c.cid=f.cid 
SET c.HEIGHT_DATE=f.DATE_SERV WHERE c.QUARTERM in(@x);
SET  @x = @x + 1; 
END WHILE;
/*up last height*/
UPDATE  t_cvdrisk c INNER JOIN tmp_fu_screen f ON c.cid=f.cid AND c.HEIGHT_DATE=f.DATE_SERV  
SET c.HEIGHT=f.HEIGHT ,c.HEIGHT_SOURCE=f.HEIGHT_SOURCE,c.HEIGHT_HOSPCODE=f.HOSPCODE
WHERE f.HEIGHT BETWEEN 90 AND 300 ;
/*last date waist*/
SET @x=0;
SET @max= 5;
WHILE @x<@max DO
UPDATE  t_cvdrisk c INNER JOIN 
(SELECT cid,MAX(DATE_SERV) date_serv 
FROM tmp_fu_screen  WHERE WAIST_CM  BETWEEN 40 AND 300 AND QUARTERM in(@x) GROUP BY CID)  f ON c.cid=f.cid 
SET c.WAIST_DATE=f.DATE_SERV WHERE c.QUARTERM in(@x);
SET  @x = @x + 1; 
END WHILE;
/*up last waist*/
UPDATE  t_cvdrisk c INNER JOIN tmp_fu_screen f ON c.cid=f.cid AND c.WAIST_DATE=f.DATE_SERV  
SET c.WAIST_CM=f.WAIST_CM ,c.WAIST_SOURCE=f.WAIST_SOURCE,c.WAIST_HOSPCODE=f.HOSPCODE
WHERE f.WAIST_CM  BETWEEN 40 AND 300 ;

/*last date CHOL*/
SET @x=0;
SET @max= 5;
WHILE @x<@max DO
UPDATE  t_cvdrisk c INNER JOIN 
(SELECT cid,MAX(DATE_SERV) date_serv 
FROM tmz_labcvd  WHERE  QUARTERM in(@x) GROUP BY CID)  f ON c.cid=f.cid 
SET c.CHOL_DATE=f.DATE_SERV WHERE c.QUARTERM in(@x);
SET  @x = @x + 1; 
END WHILE;
/*up last CHOL*/
UPDATE  t_cvdrisk c INNER JOIN tmz_labcvd f ON c.cid=f.cid AND c.CHOL_DATE=f.DATE_SERV  
SET c.CHOL=f.labresult ,c.CHOL_HOSPCODE=f.HOSPCODE;

/*SMOKE*/
UPDATE t_cvdrisk c INNER JOIN (
SELECT cid,RESULT,SMOKE_SOURCE ,HOSPCODE,DATE_SERV
FROM tmp_smoke WHERE DATE_SERV BETWEEN @start_d AND @end_d AND RESULT IN(1)
GROUP BY cid
) f ON c.cid=f.cid
SET c.SMOKE_DATE=f.DATE_SERV,c.SMOKING=f.RESULT ,c.SMOKE_SOURCE=f.SMOKE_SOURCE,c.SMOKE_HOSPCODE=f.HOSPCODE;

UPDATE t_cvdrisk c INNER JOIN (
SELECT cid,RESULT,SMOKE_SOURCE ,HOSPCODE,DATE_SERV
FROM tmp_smoke WHERE DATE_SERV BETWEEN @start_d AND @end_d AND RESULT IN(0)
GROUP BY cid
) f ON c.cid=f.cid
SET c.SMOKE_DATE=f.DATE_SERV,c.SMOKING=f.RESULT ,c.SMOKE_SOURCE=f.SMOKE_SOURCE,c.SMOKE_HOSPCODE=f.HOSPCODE
WHERE ISNULL(c.SMOKING);

/*calc*/
UPDATE t_cvdrisk SET RISK_SCORE=cvd_func(AGE_Y,SEX_CVD,SBP,DM,SMOKING,CHOL,WAIST_CM,HEIGHT)
WHERE AGE_Y >0 AND SEX_CVD is not null  AND DM is not null  AND SMOKING is not null  AND SBP >0 
AND (CHOL >0 OR (WAIST_CM >0 AND HEIGHT >0)) ;

DROP TABLE IF EXISTS t_cvdrisk_fl;
CREATE TABLE IF NOT EXISTS t_cvdrisk_fl(
 `CID` varchar(13) DEFAULT NULL
 ,`BIRTH` date
 ,`SEX` varchar(1) NOT NULL
 ,`TYPEAREA` varchar(1) NOT NULL
 ,`nation` varchar(3) DEFAULT NULL
 ,source_tb VARCHAR(255) DEFAULT NULL 
 ,mix_dx VARCHAR(255) DEFAULT NULL 	
 ,t_mix_dx VARCHAR(255) DEFAULT NULL 	
 ,type_dx VARCHAR(2) DEFAULT NULL 
 ,date_dx VARCHAR(255) DEFAULT NULL 
 ,hosp_dx varchar(255) DEFAULT NULL 
	,`AGE_Y` int(3) NOT NULL DEFAULT '0' 
	,`SEX_CVD` varchar(1) DEFAULT NULL
,`DM` varchar(1) DEFAULT NULL
 ,`F_SMOKING` varchar(1) DEFAULT NULL
 ,`F_SMOKE_DATE` date DEFAULT NULL
 ,`F_SMOKE_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`F_SMOKE_SOURCE` VARCHAR(20) DEFAULT NULL
 ,`L_SMOKING` varchar(1) DEFAULT NULL
 ,`L_SMOKE_DATE` date DEFAULT NULL
 ,`L_SMOKE_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`L_SMOKE_SOURCE` VARCHAR(20) DEFAULT NULL
 ,`F_SBP` int(3) NOT NULL DEFAULT  0
 ,`F_SBP_DATE` date DEFAULT NULL
 ,`F_SBP_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`F_SBP_SOURCE` VARCHAR(20) DEFAULT NULL
 ,`L_SBP` int(3) NOT NULL DEFAULT  0
 ,`L_SBP_DATE` date DEFAULT NULL
 ,`L_SBP_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`L_SBP_SOURCE` VARCHAR(20) DEFAULT NULL
 ,`F_CHOL` double(6,2) NOT NULL DEFAULT 0
 ,`F_CHOL_DATE` date DEFAULT NULL
 ,`F_CHOL_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`L_CHOL` double(6,2) NOT NULL DEFAULT 0
 ,`L_CHOL_DATE` date DEFAULT NULL
 ,`L_CHOL_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`F_WAIST_CM` int(3) NOT NULL DEFAULT 0
 ,`F_WAIST_DATE` date DEFAULT NULL
 ,`F_WAIST_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`F_WAIST_SOURCE` VARCHAR(20) DEFAULT NULL
,`L_WAIST_CM` int(3) NOT NULL DEFAULT 0
 ,`L_WAIST_DATE` date DEFAULT NULL
 ,`L_WAIST_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`L_WAIST_SOURCE` VARCHAR(20) DEFAULT NULL
 ,`F_HEIGHT` int(3) NOT NULL DEFAULT 0
 ,`F_HEIGHT_DATE` date DEFAULT NULL
 ,`F_HEIGHT_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`F_HEIGHT_SOURCE` VARCHAR(20) DEFAULT NULL
 ,`L_HEIGHT` int(3) NOT NULL DEFAULT 0
 ,`L_HEIGHT_DATE` date DEFAULT NULL
 ,`L_HEIGHT_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`L_HEIGHT_SOURCE` VARCHAR(20) DEFAULT NULL
 ,`F_RISK_SCORE` DECIMAL(5,2) NOT NULL DEFAULT 0.00
 ,`L_RISK_SCORE` DECIMAL(5,2) NOT NULL DEFAULT 0.00
,PRIMARY KEY (`CID`)
	,KEY  (`CID`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;
INSERT IGNORE INTO t_cvdrisk_fl (cid,birth,sex,typearea,age_y,nation,source_tb,hosp_dx,mix_dx,t_mix_dx,date_dx,dm,sex_cvd,type_dx)
(
SELECT cid,birth,sex,typearea,age_y,nation,source_tb,hosp_dx,mix_dx,t_mix_dx,date_dx,dm,sex_cvd,type_dx
FROM t_cvdrisk 
);

UPDATE  t_cvdrisk_fl c INNER JOIN 
(SELECT cid,MIN(SMOKE_DATE) date_serv 
FROM t_cvdrisk  WHERE SMOKE_DATE BETWEEN @start_d AND @end_d
 GROUP BY CID)  f ON c.cid=f.cid 
SET c.F_SMOKE_DATE=f.DATE_SERV;
UPDATE  t_cvdrisk_fl c INNER JOIN t_cvdrisk f ON c.cid=f.cid AND c.F_SMOKE_DATE=f.SMOKE_DATE  
SET c.F_SMOKING=f.SMOKING ,c.F_SMOKE_SOURCE=f.SMOKE_SOURCE,c.F_SMOKE_HOSPCODE=f.SMOKE_HOSPCODE;

UPDATE  t_cvdrisk_fl c INNER JOIN 
(SELECT cid,MAX(SMOKE_DATE) date_serv 
FROM t_cvdrisk  WHERE SMOKE_DATE BETWEEN @start_d AND @end_d
GROUP BY CID)  f ON c.cid=f.cid 
SET c.L_SMOKE_DATE=f.DATE_SERV;
UPDATE  t_cvdrisk_fl c INNER JOIN t_cvdrisk f ON c.cid=f.cid AND c.L_SMOKE_DATE=f.SMOKE_DATE  
SET c.L_SMOKING=f.SMOKING ,c.L_SMOKE_SOURCE=f.SMOKE_SOURCE,c.L_SMOKE_HOSPCODE=f.SMOKE_HOSPCODE;

UPDATE  t_cvdrisk_fl c INNER JOIN 
(SELECT cid,MIN(SBP_DATE) date_serv 
FROM t_cvdrisk  WHERE SBP_DATE  BETWEEN @start_d AND @end_d12
GROUP BY CID)  f ON c.cid=f.cid 
SET c.F_SBP_DATE=f.DATE_SERV;
UPDATE  t_cvdrisk_fl c INNER JOIN t_cvdrisk f ON c.cid=f.cid AND c.F_SBP_DATE=f.SBP_DATE  
SET c.F_SBP=f.SBP ,c.F_SBP_SOURCE=f.SBP_SOURCE,c.F_SBP_HOSPCODE=f.SBP_HOSPCODE;

UPDATE  t_cvdrisk_fl c INNER JOIN 
(SELECT cid,MAX(SBP_DATE) date_serv 
FROM t_cvdrisk  WHERE  SBP_DATE BETWEEN @start_d10 AND @end_d
GROUP BY CID)  f ON c.cid=f.cid 
SET c.L_SBP_DATE=f.DATE_SERV;
UPDATE  t_cvdrisk_fl c INNER JOIN t_cvdrisk f ON c.cid=f.cid AND c.L_SBP_DATE=f.SBP_DATE  
SET c.L_SBP=f.SBP ,c.L_SBP_SOURCE=f.SBP_SOURCE,c.L_SBP_HOSPCODE=f.SBP_HOSPCODE;

UPDATE  t_cvdrisk_fl c INNER JOIN 
(SELECT cid,MIN(CHOL_DATE) date_serv 
FROM t_cvdrisk  WHERE CHOL_DATE BETWEEN @start_d AND @end_d12
GROUP BY CID)  f ON c.cid=f.cid 
SET c.F_CHOL_DATE=f.DATE_SERV;
UPDATE  t_cvdrisk_fl c INNER JOIN t_cvdrisk f ON c.cid=f.cid AND c.F_CHOL_DATE=f.CHOL_DATE  
SET c.F_CHOL=f.CHOL ,c.F_CHOL_HOSPCODE=f.CHOL_HOSPCODE;

UPDATE  t_cvdrisk_fl c INNER JOIN 
(SELECT cid,MAX(CHOL_DATE) date_serv 
FROM t_cvdrisk  WHERE  CHOL_DATE BETWEEN @start_d10 AND @end_d
GROUP BY CID)  f ON c.cid=f.cid 
SET c.L_CHOL_DATE=f.DATE_SERV;
UPDATE  t_cvdrisk_fl c INNER JOIN t_cvdrisk f ON c.cid=f.cid AND c.L_CHOL_DATE=f.CHOL_DATE  
SET c.L_CHOL=f.CHOL ,c.L_CHOL_HOSPCODE=f.CHOL_HOSPCODE;

UPDATE  t_cvdrisk_fl c INNER JOIN 
(SELECT cid,MIN(WAIST_DATE) date_serv 
FROM t_cvdrisk  WHERE WAIST_DATE BETWEEN @start_d AND @end_d12
GROUP BY CID)  f ON c.cid=f.cid 
SET c.F_WAIST_DATE=f.DATE_SERV;
UPDATE  t_cvdrisk_fl c INNER JOIN t_cvdrisk f ON c.cid=f.cid AND c.F_WAIST_DATE=f.WAIST_DATE  
SET c.F_WAIST_CM=f.WAIST_CM ,c.F_WAIST_SOURCE=f.WAIST_SOURCE,c.F_WAIST_HOSPCODE=f.WAIST_HOSPCODE;

UPDATE  t_cvdrisk_fl c INNER JOIN 
(SELECT cid,MAX(WAIST_DATE) date_serv 
FROM t_cvdrisk  WHERE WAIST_DATE BETWEEN @start_d10 AND @end_d 
GROUP BY CID)  f ON c.cid=f.cid 
SET c.L_WAIST_DATE=f.DATE_SERV;
UPDATE  t_cvdrisk_fl c INNER JOIN t_cvdrisk f ON c.cid=f.cid AND c.L_WAIST_DATE=f.WAIST_DATE  
SET c.L_WAIST_CM=f.WAIST_CM ,c.L_WAIST_SOURCE=f.WAIST_SOURCE,c.L_WAIST_HOSPCODE=f.WAIST_HOSPCODE;

UPDATE  t_cvdrisk_fl c INNER JOIN 
(SELECT cid,MIN(HEIGHT_DATE) date_serv 
FROM t_cvdrisk  WHERE HEIGHT_DATE BETWEEN @start_d AND @end_d12
GROUP BY CID)  f ON c.cid=f.cid 
SET c.F_HEIGHT_DATE=f.DATE_SERV;
UPDATE  t_cvdrisk_fl c INNER JOIN t_cvdrisk f ON c.cid=f.cid AND c.F_HEIGHT_DATE=f.HEIGHT_DATE  
SET c.F_HEIGHT=f.HEIGHT ,c.F_HEIGHT_SOURCE=f.HEIGHT_SOURCE,c.F_HEIGHT_HOSPCODE=f.HEIGHT_HOSPCODE;

UPDATE  t_cvdrisk_fl c INNER JOIN 
(SELECT cid,MAX(HEIGHT_DATE) date_serv 
FROM t_cvdrisk  WHERE HEIGHT_DATE BETWEEN @start_d AND @end_d
GROUP BY CID)  f ON c.cid=f.cid 
SET c.L_HEIGHT_DATE=f.DATE_SERV;
UPDATE  t_cvdrisk_fl c INNER JOIN t_cvdrisk f ON c.cid=f.cid AND c.L_HEIGHT_DATE=f.HEIGHT_DATE  
SET c.L_HEIGHT=f.HEIGHT ,c.L_HEIGHT_SOURCE=f.HEIGHT_SOURCE,c.L_HEIGHT_HOSPCODE=f.HEIGHT_HOSPCODE;

UPDATE t_cvdrisk_fl SET F_RISK_SCORE=cvd_func(AGE_Y,SEX_CVD,F_SBP,DM,F_SMOKING,F_CHOL,F_WAIST_CM,F_HEIGHT)
WHERE AGE_Y >0 AND SEX_CVD is not null  AND DM is not null  AND F_SMOKING is not null  AND F_SBP >0 
AND (F_CHOL >0 OR (F_WAIST_CM >0 AND F_HEIGHT >0)) ;

UPDATE t_cvdrisk_fl SET L_RISK_SCORE=cvd_func(AGE_Y,SEX_CVD,L_SBP,DM,L_SMOKING,L_CHOL,L_WAIST_CM,L_HEIGHT) 
WHERE AGE_Y >0 AND SEX_CVD is not null  AND DM is not null  AND L_SMOKING is not null  AND L_SBP >0 
AND (L_CHOL >0 OR (L_WAIST_CM >0 AND L_HEIGHT >0)) ;

 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.454257;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:379;a:5:{i:0;s:38:"DROP PROCEDURE IF EXISTS t_screen_last";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.454257;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:380;a:5:{i:0;s:38:"DROP PROCEDURE IF EXISTS t_screen_last";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.5166571;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:382;a:5:{i:0;s:1902:"CREATE PROCEDURE t_screen_last()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '59';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS t_screen_last;
CREATE TABLE IF NOT EXISTS t_screen_last(
 `HOSPCODE` varchar(5) NOT NULL,
 `CID` varchar(13) DEFAULT NULL,
 `PID` varchar(15) NOT NULL,
	`SEQ` varchar(16) NOT NULL,
 `DATE_SERV` date NOT NULL,
 `WAIST_CM` int(3) NOT NULL DEFAULT 0,
	weight decimal(5,1) NOT NULL DEFAULT '0',
 `HEIGHT` int(3) NOT NULL DEFAULT 0,
  `SMOKE` varchar(1) DEFAULT NULL,
  `ALCOHOL` varchar(1) DEFAULT NULL,
 `SBP_1` int(3) NOT NULL,
  `DBP_1` int(3) NOT NULL,
  `SBP_2` int(3) DEFAULT NULL,
  `DBP_2` int(3) DEFAULT NULL,
  `BSLEVEL` int(6) DEFAULT NULL,
  `BSTEST` char(1) DEFAULT NULL,
  `SCREENPLACE` varchar(5) DEFAULT NULL,
 `QUARTERM` VARCHAR(1) DEFAULT NULL,
	bmi decimal(10,1) NOT NULL DEFAULT '0',
PRIMARY KEY (`HOSPCODE`,`PID`,`QUARTERM`),
  KEY  (`HOSPCODE`,`PID`),
  KEY  (`HOSPCODE`),
  KEY  (`DATE_SERV`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;


INSERT IGNORE INTO t_screen_last (
SELECT  
HOSPCODE,CID,PID,SEQ,DATE_SERV,WAIST_CM,WEIGHT,HEIGHT,SMOKE,ALCOHOL,SBP_1,DBP_1,SBP_2,DBP_2,BSLEVEL,BSTEST,SCREENPLACE
,IF( DATE_SERV < concat(@b_year-1,'1001'),0,
IF(DATE_SERV BETWEEN concat(@b_year-1,'1001') AND concat(@b_year-1,'1231'),1,
IF(DATE_SERV BETWEEN concat(@b_year,'0101') AND concat(@b_year,'0331'),2,
IF(DATE_SERV BETWEEN concat(@b_year,'0401') AND concat(@b_year,'0630'),3,
IF(DATE_SERV BETWEEN concat(@b_year,'0701') AND concat(@b_year,'0930'),4,null
))))),0
FROM tmp_ncdscreen
WHERE date_serv BETWEEN @start_d AND @end_d
ORDER BY DATE_SERV DESC
);
UPDATE t_screen_last SET  BMI= IFNULL(round(weight/((height/100)*(height/100)),2),0)
WHERE weight BETWEEN 10 AND 300 AND height BETWEEN 30 AND 250;

 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.5166571;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:383;a:5:{i:0;s:1902:"CREATE PROCEDURE t_screen_last()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '59';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS t_screen_last;
CREATE TABLE IF NOT EXISTS t_screen_last(
 `HOSPCODE` varchar(5) NOT NULL,
 `CID` varchar(13) DEFAULT NULL,
 `PID` varchar(15) NOT NULL,
	`SEQ` varchar(16) NOT NULL,
 `DATE_SERV` date NOT NULL,
 `WAIST_CM` int(3) NOT NULL DEFAULT 0,
	weight decimal(5,1) NOT NULL DEFAULT '0',
 `HEIGHT` int(3) NOT NULL DEFAULT 0,
  `SMOKE` varchar(1) DEFAULT NULL,
  `ALCOHOL` varchar(1) DEFAULT NULL,
 `SBP_1` int(3) NOT NULL,
  `DBP_1` int(3) NOT NULL,
  `SBP_2` int(3) DEFAULT NULL,
  `DBP_2` int(3) DEFAULT NULL,
  `BSLEVEL` int(6) DEFAULT NULL,
  `BSTEST` char(1) DEFAULT NULL,
  `SCREENPLACE` varchar(5) DEFAULT NULL,
 `QUARTERM` VARCHAR(1) DEFAULT NULL,
	bmi decimal(10,1) NOT NULL DEFAULT '0',
PRIMARY KEY (`HOSPCODE`,`PID`,`QUARTERM`),
  KEY  (`HOSPCODE`,`PID`),
  KEY  (`HOSPCODE`),
  KEY  (`DATE_SERV`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;


INSERT IGNORE INTO t_screen_last (
SELECT  
HOSPCODE,CID,PID,SEQ,DATE_SERV,WAIST_CM,WEIGHT,HEIGHT,SMOKE,ALCOHOL,SBP_1,DBP_1,SBP_2,DBP_2,BSLEVEL,BSTEST,SCREENPLACE
,IF( DATE_SERV < concat(@b_year-1,'1001'),0,
IF(DATE_SERV BETWEEN concat(@b_year-1,'1001') AND concat(@b_year-1,'1231'),1,
IF(DATE_SERV BETWEEN concat(@b_year,'0101') AND concat(@b_year,'0331'),2,
IF(DATE_SERV BETWEEN concat(@b_year,'0401') AND concat(@b_year,'0630'),3,
IF(DATE_SERV BETWEEN concat(@b_year,'0701') AND concat(@b_year,'0930'),4,null
))))),0
FROM tmp_ncdscreen
WHERE date_serv BETWEEN @start_d AND @end_d
ORDER BY DATE_SERV DESC
);
UPDATE t_screen_last SET  BMI= IFNULL(round(weight/((height/100)*(height/100)),2),0)
WHERE weight BETWEEN 10 AND 300 AND height BETWEEN 30 AND 250;

 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.5790579;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:385;a:5:{i:0;s:30:"DROP PROCEDURE IF EXISTS t_adl";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.5790579;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:386;a:5:{i:0;s:30:"DROP PROCEDURE IF EXISTS t_adl";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.641458;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:388;a:5:{i:0;s:9324:"CREATE PROCEDURE t_adl()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '60';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
/*ประวัติการรับบริการตรวจ ADL ประชากรทุกคนไม่เฉพาะในเขต*/
#DROP TABLE IF EXISTS t_adl_last_regist;
CREATE TABLE IF NOT EXISTS t_adl_last_regist(
 `CID` varchar(13) DEFAULT NULL,
 `DATE_SERV` date DEFAULT NULL,
 `PPSPECIAL` VARCHAR(6) DEFAULT NULL,
  `PPSPLACE` VARCHAR(5) DEFAULT NULL,	
PRIMARY KEY (`CID`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

REPLACE INTO t_adl_last_regist 
(SELECT CID,NULL,NULL,NULL
FROM
tmp_specialpp 
WHERE LENGTH(cid)=13 AND PPSPECIAL IN('1B1280','1B1281','1B1282') 
GROUP BY CID
);

UPDATE t_adl_last_regist  t INNER JOIN
(
SELECT s1.hospcode,s1.CID,s1.DATE_SERV,s1.PPSPECIAL,s1.PPSPLACE
FROM tmp_specialpp s1 INNER JOIN tmp_specialpp s2 ON s1.CID=s2.CID AND s2.DATE_SERV >= s1.DATE_SERV
WHERE s1.PPSPECIAL  IN('1B1280','1B1281','1B1282') AND s2.PPSPECIAL  IN('1B1280','1B1281','1B1282')
		AND s1.DATE_SERV BETWEEN @start_d AND @end_d
		AND s2.DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY s1.CID,s1.DATE_SERV
HAVING COUNT(*) = 1
) s ON t.cid = s.cid AND s.date_serv BETWEEN @start_d AND @end_d
SET t.DATE_SERV = s.date_serv , t.PPSPECIAL= s.PPSPECIAL
, t.PPSPLACE=IF(ISNULL(s.PPSPLACE) OR LENGTH(s.PPSPLACE) !=5 ,s.hospcode,s.PPSPLACE);

/*ประวัติการรับบริการตรวจ ADL ประชากรทุกคนเฉพาะในเขตและผลครั้งสุดท้ายของรอบนั้นๆ*/
DROP TABLE IF EXISTS t_adl;
CREATE TABLE IF NOT EXISTS t_adl(
 `HOSPCODE` varchar(5) NOT NULL,
 `CID` varchar(13) DEFAULT NULL,
 `PID` varchar(15) NOT NULL,
 `BIRTH` DATE,
 `AGE_Y` varchar(3) DEFAULT '0',
 `TYPEAREA` varchar(1) DEFAULT NULL,
 `DATE_SERV1` date DEFAULT NULL,
 `PPSPECIAL1` VARCHAR(6) DEFAULT NULL,
  `PP_HOSP1` VARCHAR(5) DEFAULT NULL,	
 `DATE_SERV2` date DEFAULT NULL,
 `PPSPECIAL2` VARCHAR(6) DEFAULT NULL,
  `PP_HOSP2` VARCHAR(5) DEFAULT NULL,	
PRIMARY KEY (`CID`),
  KEY  (`HOSPCODE`,`PID`),
  KEY  (`HOSPCODE`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO t_adl (HOSPCODE,CID,PID,BIRTH,AGE_Y,TYPEAREA)
(
SELECT check_hosp,CID,PID,BIRTH,AGE_Y,check_typearea 
FROM t_person_cid 
WHERE LENGTH(cid)=13  AND check_typearea in(1,3) AND NATION in(99) AND age_y >=60 AND age_y < 200 AND DISCHARGE in(9)
);
/*max date_serv1*/
UPDATE t_adl t INNER JOIN
(SELECT s1.hospcode,s1.CID,s1.DATE_SERV,s1.PPSPECIAL
FROM tmp_specialpp s1 INNER JOIN tmp_specialpp s2 ON s1.CID=s2.CID AND s2.DATE_SERV >= s1.DATE_SERV
WHERE s1.PPSPECIAL  IN('1B1280','1B1281','1B1282') AND s2.PPSPECIAL  IN('1B1280','1B1281','1B1282')
		AND s1.DATE_SERV BETWEEN  CONCAT(@b_year-1,'1001') AND CONCAT(@b_year,'0331') 
		AND s2.DATE_SERV BETWEEN  CONCAT(@b_year-1,'1001') AND CONCAT(@b_year,'0331') 
GROUP BY s1.CID,s1.DATE_SERV
HAVING COUNT(*) = 1
)
s ON t.cid=s.cid SET t.DATE_SERV1=s.date_serv ,t.PPSPECIAL1=s.PPSPECIAL ,t.PP_HOSP1=s.hospcode;

UPDATE t_adl t INNER JOIN
(SELECT s1.hospcode,s1.CID,s1.DATE_SERV,s1.PPSPECIAL
FROM tmp_specialpp s1 INNER JOIN tmp_specialpp s2 ON s1.CID=s2.CID AND s2.DATE_SERV >= s1.DATE_SERV
WHERE s1.PPSPECIAL  IN('1B1280','1B1281','1B1282') AND s2.PPSPECIAL  IN('1B1280','1B1281','1B1282')
		AND s1.DATE_SERV BETWEEN   CONCAT(@b_year,'0401') AND CONCAT(@b_year,'0930') 
		AND s2.DATE_SERV BETWEEN   CONCAT(@b_year,'0401') AND CONCAT(@b_year,'0930')  
GROUP BY s1.CID,s1.DATE_SERV
HAVING COUNT(*) = 1
)
s ON t.cid=s.cid SET t.DATE_SERV2=s.date_serv ,t.PPSPECIAL2=s.PPSPECIAL ,t.PP_HOSP2=s.hospcode;

DROP  TABLE IF EXISTS t_aged;
CREATE  TABLE IF NOT EXISTS t_aged(
  `HOSPCODE` varchar(5) NOT NULL,
  `PID` varchar(15) NOT NULL,
  `CID` varchar(13) NOT NULL,
  `SEX` varchar(1) NOT NULL ,
  `BIRTH` date  DEFAULT NULL,
	`NATION` varchar(3)  DEFAULT NULL,
	`DISCHARGE` varchar(1) DEFAULT NULL,
	`TYPEAREA` varchar(1)  DEFAULT NULL,
	`AGE_Y` int(3) DEFAULT NULL,
	`VHID` varchar(8) DEFAULT NULL,
	 ht_date DATE,
	 ht_risk int(1) DEFAULT NULL,
	 dm_date DATE DEFAULT NULL,
	 dm_risk int(1) DEFAULT NULL,
	 cvd_score decimal(5,2) NOT NULL DEFAULT '0.00',
	 dent_date DATE DEFAULT NULL,
	 dent_code varchar(6) DEFAULT NULL,
	 amt_date DATE DEFAULT NULL,
	 amt_code varchar(6) DEFAULT NULL,
	 2q_date DATE DEFAULT NULL,
	 2q_code varchar(6) DEFAULT NULL,
	 knee_date DATE DEFAULT NULL,
	 knee_code varchar(6) DEFAULT NULL,
	 fall_date DATE DEFAULT NULL,
	 fall_code varchar(6) DEFAULT NULL,
	 adl_date DATE DEFAULT NULL,
	 adl_code varchar(6) DEFAULT NULL,
	 bmi_date DATE DEFAULT NULL,
	 bmi decimal(5,2) NOT NULL DEFAULT '0.00',
		PRIMARY KEY (cid),
		KEY (cid),
		KEY (hospcode,pid)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;
INSERT IGNORE INTO t_aged (hospcode,pid,cid,sex,birth,nation,discharge,typearea,age_y,vhid)
SELECT
check_hosp,pid,cid , sex,birth ,nation,discharge, check_typearea,age_y ,check_vhid
FROM t_person_cid p  
WHERE  p.check_typearea in(1,3) AND p.NATION in(99) AND p.DISCHARGE in(9) AND LENGTH(TRIM(p.CID)) = 13
AND p.age_y >= 60 AND p.age_y < 200;
/**ht**/
UPDATE t_aged t INNER JOIN t_person_ht_screen s ON t.cid = s.cid AND s.date_screen BETWEEN @start_d AND @end_d
SET t.ht_date = s.date_screen , t.ht_risk= s.risk;
/**dm**/
UPDATE t_aged t INNER JOIN t_person_dm_screen s ON t.cid = s.cid AND s.date_screen BETWEEN @start_d AND @end_d
SET t.dm_date = s.date_screen , t.dm_risk= s.risk;
/**cvd**/
UPDATE t_aged t INNER JOIN t_cvdrisk_fl s ON t.cid = s.cid 
SET  t.cvd_score= s.L_RISK_SCORE;
/**dental**/
UPDATE t_aged t INNER JOIN 
(
SELECT
s1.CID,s1.DATE_SERV,s1.PPSPECIAL
FROM
tmp_specialpp s1 INNER JOIN tmp_specialpp s2 ON s1.CID=s2.CID AND s2.DATE_SERV >= s1.DATE_SERV
WHERE s1.PPSPECIAL  IN('1B1260','1B1261','1B1269') AND s2.PPSPECIAL  IN('1B1260','1B1261','1B1269')
AND s1.DATE_SERV BETWEEN @start_d AND @end_d
AND s2.DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY s1.CID,s1.DATE_SERV
HAVING COUNT(*) = 1
)
s ON t.cid = s.cid AND s.date_serv BETWEEN @start_d AND @end_d
SET t.dent_date = s.date_serv , t.dent_code= s.PPSPECIAL;
/**amt**/
UPDATE t_aged t INNER JOIN 
(
SELECT
s1.CID,s1.DATE_SERV,s1.PPSPECIAL
FROM
tmp_specialpp s1 INNER JOIN tmp_specialpp s2 ON s1.CID=s2.CID AND s2.DATE_SERV >= s1.DATE_SERV
WHERE s1.PPSPECIAL  IN('1B1220','1B1221','1B1223','1B1229') AND s2.PPSPECIAL  IN('1B1220','1B1221','1B1223','1B1229')
AND s1.DATE_SERV BETWEEN @start_d AND @end_d
AND s2.DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY s1.CID,s1.DATE_SERV
HAVING COUNT(*) = 1
)
s ON t.cid = s.cid AND s.date_serv BETWEEN @start_d AND @end_d
SET t.amt_date = s.date_serv , t.amt_code= s.PPSPECIAL;
/**2q**/
UPDATE t_aged t INNER JOIN 
(
SELECT s1.CID,s1.DATE_SERV,s1.PPSPECIAL
FROM tmp_specialpp s1 INNER JOIN tmp_specialpp s2 ON s1.CID=s2.CID AND s2.DATE_SERV >= s1.DATE_SERV
WHERE s1.PPSPECIAL  IN('1B0280','1B0281') AND s2.PPSPECIAL  IN('1B0280','1B0281')
		AND s1.DATE_SERV BETWEEN @start_d AND @end_d
		AND s2.DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY s1.CID,s1.DATE_SERV
HAVING COUNT(*) = 1
) s ON t.cid = s.cid AND s.date_serv BETWEEN @start_d AND @end_d
SET t.2q_date = s.date_serv , t.2q_code= s.PPSPECIAL;
/**knee**/
UPDATE t_aged t INNER JOIN 
(
SELECT s1.CID,s1.DATE_SERV,s1.PPSPECIAL
FROM tmp_specialpp s1 INNER JOIN tmp_specialpp s2 ON s1.CID=s2.CID AND s2.DATE_SERV >= s1.DATE_SERV
WHERE s1.PPSPECIAL  IN('1B1270','1B1271','1B1272','1B1279') AND s2.PPSPECIAL  IN('1B1270','1B1271','1B1272','1B1279')
		AND s1.DATE_SERV BETWEEN @start_d AND @end_d
		AND s2.DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY s1.CID,s1.DATE_SERV
HAVING COUNT(*) = 1
) s ON t.cid = s.cid AND s.date_serv BETWEEN @start_d AND @end_d
SET t.knee_date = s.date_serv , t.knee_code= s.PPSPECIAL;
/**fall**/
UPDATE t_aged t INNER JOIN 
(
SELECT s1.CID,s1.DATE_SERV,s1.PPSPECIAL
FROM tmp_specialpp s1 INNER JOIN tmp_specialpp s2 ON s1.CID=s2.CID AND s2.DATE_SERV >= s1.DATE_SERV
WHERE s1.PPSPECIAL  IN('1B1200','1B1201','1B1202','1B1209') AND s2.PPSPECIAL  IN('1B1200','1B1201','1B1202','1B1209')
		AND s1.DATE_SERV BETWEEN @start_d AND @end_d
		AND s2.DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY s1.CID,s1.DATE_SERV
HAVING COUNT(*) = 1
) s ON t.cid = s.cid AND s.date_serv BETWEEN @start_d AND @end_d
SET t.fall_date = s.date_serv , t.fall_code= s.PPSPECIAL;
/**adl**/
UPDATE t_aged t INNER JOIN 
(
SELECT s1.CID,s1.DATE_SERV,s1.PPSPECIAL
FROM tmp_specialpp s1 INNER JOIN tmp_specialpp s2 ON s1.CID=s2.CID AND s2.DATE_SERV >= s1.DATE_SERV
WHERE s1.PPSPECIAL  IN('1B1280','1B1281','1B1282') AND s2.PPSPECIAL  IN('1B1280','1B1281','1B1282')
		AND s1.DATE_SERV BETWEEN @start_d AND @end_d
		AND s2.DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY s1.CID,s1.DATE_SERV
HAVING COUNT(*) = 1
) s ON t.cid = s.cid AND s.date_serv BETWEEN @start_d AND @end_d
SET t.adl_date = s.date_serv , t.adl_code= s.PPSPECIAL;
/**bmi**/
UPDATE  t_aged t INNER JOIN  ws_person_nutrition n ON t.cid=n.cid  AND n.date_serv BETWEEN @start_d AND @end_d
SET  t.bmi_date = n.date_serv , t.bmi= n.bmi;

 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.641458;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:389;a:5:{i:0;s:9324:"CREATE PROCEDURE t_adl()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '60';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
/*ประวัติการรับบริการตรวจ ADL ประชากรทุกคนไม่เฉพาะในเขต*/
#DROP TABLE IF EXISTS t_adl_last_regist;
CREATE TABLE IF NOT EXISTS t_adl_last_regist(
 `CID` varchar(13) DEFAULT NULL,
 `DATE_SERV` date DEFAULT NULL,
 `PPSPECIAL` VARCHAR(6) DEFAULT NULL,
  `PPSPLACE` VARCHAR(5) DEFAULT NULL,	
PRIMARY KEY (`CID`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

REPLACE INTO t_adl_last_regist 
(SELECT CID,NULL,NULL,NULL
FROM
tmp_specialpp 
WHERE LENGTH(cid)=13 AND PPSPECIAL IN('1B1280','1B1281','1B1282') 
GROUP BY CID
);

UPDATE t_adl_last_regist  t INNER JOIN
(
SELECT s1.hospcode,s1.CID,s1.DATE_SERV,s1.PPSPECIAL,s1.PPSPLACE
FROM tmp_specialpp s1 INNER JOIN tmp_specialpp s2 ON s1.CID=s2.CID AND s2.DATE_SERV >= s1.DATE_SERV
WHERE s1.PPSPECIAL  IN('1B1280','1B1281','1B1282') AND s2.PPSPECIAL  IN('1B1280','1B1281','1B1282')
		AND s1.DATE_SERV BETWEEN @start_d AND @end_d
		AND s2.DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY s1.CID,s1.DATE_SERV
HAVING COUNT(*) = 1
) s ON t.cid = s.cid AND s.date_serv BETWEEN @start_d AND @end_d
SET t.DATE_SERV = s.date_serv , t.PPSPECIAL= s.PPSPECIAL
, t.PPSPLACE=IF(ISNULL(s.PPSPLACE) OR LENGTH(s.PPSPLACE) !=5 ,s.hospcode,s.PPSPLACE);

/*ประวัติการรับบริการตรวจ ADL ประชากรทุกคนเฉพาะในเขตและผลครั้งสุดท้ายของรอบนั้นๆ*/
DROP TABLE IF EXISTS t_adl;
CREATE TABLE IF NOT EXISTS t_adl(
 `HOSPCODE` varchar(5) NOT NULL,
 `CID` varchar(13) DEFAULT NULL,
 `PID` varchar(15) NOT NULL,
 `BIRTH` DATE,
 `AGE_Y` varchar(3) DEFAULT '0',
 `TYPEAREA` varchar(1) DEFAULT NULL,
 `DATE_SERV1` date DEFAULT NULL,
 `PPSPECIAL1` VARCHAR(6) DEFAULT NULL,
  `PP_HOSP1` VARCHAR(5) DEFAULT NULL,	
 `DATE_SERV2` date DEFAULT NULL,
 `PPSPECIAL2` VARCHAR(6) DEFAULT NULL,
  `PP_HOSP2` VARCHAR(5) DEFAULT NULL,	
PRIMARY KEY (`CID`),
  KEY  (`HOSPCODE`,`PID`),
  KEY  (`HOSPCODE`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO t_adl (HOSPCODE,CID,PID,BIRTH,AGE_Y,TYPEAREA)
(
SELECT check_hosp,CID,PID,BIRTH,AGE_Y,check_typearea 
FROM t_person_cid 
WHERE LENGTH(cid)=13  AND check_typearea in(1,3) AND NATION in(99) AND age_y >=60 AND age_y < 200 AND DISCHARGE in(9)
);
/*max date_serv1*/
UPDATE t_adl t INNER JOIN
(SELECT s1.hospcode,s1.CID,s1.DATE_SERV,s1.PPSPECIAL
FROM tmp_specialpp s1 INNER JOIN tmp_specialpp s2 ON s1.CID=s2.CID AND s2.DATE_SERV >= s1.DATE_SERV
WHERE s1.PPSPECIAL  IN('1B1280','1B1281','1B1282') AND s2.PPSPECIAL  IN('1B1280','1B1281','1B1282')
		AND s1.DATE_SERV BETWEEN  CONCAT(@b_year-1,'1001') AND CONCAT(@b_year,'0331') 
		AND s2.DATE_SERV BETWEEN  CONCAT(@b_year-1,'1001') AND CONCAT(@b_year,'0331') 
GROUP BY s1.CID,s1.DATE_SERV
HAVING COUNT(*) = 1
)
s ON t.cid=s.cid SET t.DATE_SERV1=s.date_serv ,t.PPSPECIAL1=s.PPSPECIAL ,t.PP_HOSP1=s.hospcode;

UPDATE t_adl t INNER JOIN
(SELECT s1.hospcode,s1.CID,s1.DATE_SERV,s1.PPSPECIAL
FROM tmp_specialpp s1 INNER JOIN tmp_specialpp s2 ON s1.CID=s2.CID AND s2.DATE_SERV >= s1.DATE_SERV
WHERE s1.PPSPECIAL  IN('1B1280','1B1281','1B1282') AND s2.PPSPECIAL  IN('1B1280','1B1281','1B1282')
		AND s1.DATE_SERV BETWEEN   CONCAT(@b_year,'0401') AND CONCAT(@b_year,'0930') 
		AND s2.DATE_SERV BETWEEN   CONCAT(@b_year,'0401') AND CONCAT(@b_year,'0930')  
GROUP BY s1.CID,s1.DATE_SERV
HAVING COUNT(*) = 1
)
s ON t.cid=s.cid SET t.DATE_SERV2=s.date_serv ,t.PPSPECIAL2=s.PPSPECIAL ,t.PP_HOSP2=s.hospcode;

DROP  TABLE IF EXISTS t_aged;
CREATE  TABLE IF NOT EXISTS t_aged(
  `HOSPCODE` varchar(5) NOT NULL,
  `PID` varchar(15) NOT NULL,
  `CID` varchar(13) NOT NULL,
  `SEX` varchar(1) NOT NULL ,
  `BIRTH` date  DEFAULT NULL,
	`NATION` varchar(3)  DEFAULT NULL,
	`DISCHARGE` varchar(1) DEFAULT NULL,
	`TYPEAREA` varchar(1)  DEFAULT NULL,
	`AGE_Y` int(3) DEFAULT NULL,
	`VHID` varchar(8) DEFAULT NULL,
	 ht_date DATE,
	 ht_risk int(1) DEFAULT NULL,
	 dm_date DATE DEFAULT NULL,
	 dm_risk int(1) DEFAULT NULL,
	 cvd_score decimal(5,2) NOT NULL DEFAULT '0.00',
	 dent_date DATE DEFAULT NULL,
	 dent_code varchar(6) DEFAULT NULL,
	 amt_date DATE DEFAULT NULL,
	 amt_code varchar(6) DEFAULT NULL,
	 2q_date DATE DEFAULT NULL,
	 2q_code varchar(6) DEFAULT NULL,
	 knee_date DATE DEFAULT NULL,
	 knee_code varchar(6) DEFAULT NULL,
	 fall_date DATE DEFAULT NULL,
	 fall_code varchar(6) DEFAULT NULL,
	 adl_date DATE DEFAULT NULL,
	 adl_code varchar(6) DEFAULT NULL,
	 bmi_date DATE DEFAULT NULL,
	 bmi decimal(5,2) NOT NULL DEFAULT '0.00',
		PRIMARY KEY (cid),
		KEY (cid),
		KEY (hospcode,pid)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;
INSERT IGNORE INTO t_aged (hospcode,pid,cid,sex,birth,nation,discharge,typearea,age_y,vhid)
SELECT
check_hosp,pid,cid , sex,birth ,nation,discharge, check_typearea,age_y ,check_vhid
FROM t_person_cid p  
WHERE  p.check_typearea in(1,3) AND p.NATION in(99) AND p.DISCHARGE in(9) AND LENGTH(TRIM(p.CID)) = 13
AND p.age_y >= 60 AND p.age_y < 200;
/**ht**/
UPDATE t_aged t INNER JOIN t_person_ht_screen s ON t.cid = s.cid AND s.date_screen BETWEEN @start_d AND @end_d
SET t.ht_date = s.date_screen , t.ht_risk= s.risk;
/**dm**/
UPDATE t_aged t INNER JOIN t_person_dm_screen s ON t.cid = s.cid AND s.date_screen BETWEEN @start_d AND @end_d
SET t.dm_date = s.date_screen , t.dm_risk= s.risk;
/**cvd**/
UPDATE t_aged t INNER JOIN t_cvdrisk_fl s ON t.cid = s.cid 
SET  t.cvd_score= s.L_RISK_SCORE;
/**dental**/
UPDATE t_aged t INNER JOIN 
(
SELECT
s1.CID,s1.DATE_SERV,s1.PPSPECIAL
FROM
tmp_specialpp s1 INNER JOIN tmp_specialpp s2 ON s1.CID=s2.CID AND s2.DATE_SERV >= s1.DATE_SERV
WHERE s1.PPSPECIAL  IN('1B1260','1B1261','1B1269') AND s2.PPSPECIAL  IN('1B1260','1B1261','1B1269')
AND s1.DATE_SERV BETWEEN @start_d AND @end_d
AND s2.DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY s1.CID,s1.DATE_SERV
HAVING COUNT(*) = 1
)
s ON t.cid = s.cid AND s.date_serv BETWEEN @start_d AND @end_d
SET t.dent_date = s.date_serv , t.dent_code= s.PPSPECIAL;
/**amt**/
UPDATE t_aged t INNER JOIN 
(
SELECT
s1.CID,s1.DATE_SERV,s1.PPSPECIAL
FROM
tmp_specialpp s1 INNER JOIN tmp_specialpp s2 ON s1.CID=s2.CID AND s2.DATE_SERV >= s1.DATE_SERV
WHERE s1.PPSPECIAL  IN('1B1220','1B1221','1B1223','1B1229') AND s2.PPSPECIAL  IN('1B1220','1B1221','1B1223','1B1229')
AND s1.DATE_SERV BETWEEN @start_d AND @end_d
AND s2.DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY s1.CID,s1.DATE_SERV
HAVING COUNT(*) = 1
)
s ON t.cid = s.cid AND s.date_serv BETWEEN @start_d AND @end_d
SET t.amt_date = s.date_serv , t.amt_code= s.PPSPECIAL;
/**2q**/
UPDATE t_aged t INNER JOIN 
(
SELECT s1.CID,s1.DATE_SERV,s1.PPSPECIAL
FROM tmp_specialpp s1 INNER JOIN tmp_specialpp s2 ON s1.CID=s2.CID AND s2.DATE_SERV >= s1.DATE_SERV
WHERE s1.PPSPECIAL  IN('1B0280','1B0281') AND s2.PPSPECIAL  IN('1B0280','1B0281')
		AND s1.DATE_SERV BETWEEN @start_d AND @end_d
		AND s2.DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY s1.CID,s1.DATE_SERV
HAVING COUNT(*) = 1
) s ON t.cid = s.cid AND s.date_serv BETWEEN @start_d AND @end_d
SET t.2q_date = s.date_serv , t.2q_code= s.PPSPECIAL;
/**knee**/
UPDATE t_aged t INNER JOIN 
(
SELECT s1.CID,s1.DATE_SERV,s1.PPSPECIAL
FROM tmp_specialpp s1 INNER JOIN tmp_specialpp s2 ON s1.CID=s2.CID AND s2.DATE_SERV >= s1.DATE_SERV
WHERE s1.PPSPECIAL  IN('1B1270','1B1271','1B1272','1B1279') AND s2.PPSPECIAL  IN('1B1270','1B1271','1B1272','1B1279')
		AND s1.DATE_SERV BETWEEN @start_d AND @end_d
		AND s2.DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY s1.CID,s1.DATE_SERV
HAVING COUNT(*) = 1
) s ON t.cid = s.cid AND s.date_serv BETWEEN @start_d AND @end_d
SET t.knee_date = s.date_serv , t.knee_code= s.PPSPECIAL;
/**fall**/
UPDATE t_aged t INNER JOIN 
(
SELECT s1.CID,s1.DATE_SERV,s1.PPSPECIAL
FROM tmp_specialpp s1 INNER JOIN tmp_specialpp s2 ON s1.CID=s2.CID AND s2.DATE_SERV >= s1.DATE_SERV
WHERE s1.PPSPECIAL  IN('1B1200','1B1201','1B1202','1B1209') AND s2.PPSPECIAL  IN('1B1200','1B1201','1B1202','1B1209')
		AND s1.DATE_SERV BETWEEN @start_d AND @end_d
		AND s2.DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY s1.CID,s1.DATE_SERV
HAVING COUNT(*) = 1
) s ON t.cid = s.cid AND s.date_serv BETWEEN @start_d AND @end_d
SET t.fall_date = s.date_serv , t.fall_code= s.PPSPECIAL;
/**adl**/
UPDATE t_aged t INNER JOIN 
(
SELECT s1.CID,s1.DATE_SERV,s1.PPSPECIAL
FROM tmp_specialpp s1 INNER JOIN tmp_specialpp s2 ON s1.CID=s2.CID AND s2.DATE_SERV >= s1.DATE_SERV
WHERE s1.PPSPECIAL  IN('1B1280','1B1281','1B1282') AND s2.PPSPECIAL  IN('1B1280','1B1281','1B1282')
		AND s1.DATE_SERV BETWEEN @start_d AND @end_d
		AND s2.DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY s1.CID,s1.DATE_SERV
HAVING COUNT(*) = 1
) s ON t.cid = s.cid AND s.date_serv BETWEEN @start_d AND @end_d
SET t.adl_date = s.date_serv , t.adl_code= s.PPSPECIAL;
/**bmi**/
UPDATE  t_aged t INNER JOIN  ws_person_nutrition n ON t.cid=n.cid  AND n.date_serv BETWEEN @start_d AND @end_d
SET  t.bmi_date = n.date_serv , t.bmi= n.bmi;

 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.7194581;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:391;a:5:{i:0;s:36:"DROP PROCEDURE IF EXISTS t_postnatal";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.7194581;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:392;a:5:{i:0;s:36:"DROP PROCEDURE IF EXISTS t_postnatal";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.781858;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:394;a:5:{i:0;s:2793:"CREATE PROCEDURE t_postnatal()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '61';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS t_postnatal;
CREATE TABLE IF NOT EXISTS t_postnatal(
`HOSPCODE` varchar(5) NOT NULL,
  `PID` varchar(15) NOT NULL,
  `GRAVIDA` varchar(2) NOT NULL,
  `BDATE` date NOT NULL,
  `cid` varchar(13) DEFAULT NULL,
  `nation` varchar(3) DEFAULT '',
  `occupat` varchar(4) DEFAULT NULL,
  `birth` date DEFAULT NULL,
  `vhid` varchar(8) DEFAULT NULL,
  `ppcare1` date DEFAULT NULL,
  `ppcare1_hosp` varchar(5) DEFAULT NULL,
	`ppcare1_input_hosp` varchar(5) DEFAULT NULL,
  `ppcare2` date DEFAULT NULL,
  `ppcare2_hosp` varchar(5) DEFAULT NULL,
	`ppcare2_input_hosp` varchar(5) DEFAULT NULL,
  `ppcare3` date DEFAULT NULL,
  `ppcare3_hosp` varchar(5) DEFAULT NULL,
	`ppcare3_input_hosp` varchar(5) DEFAULT NULL,
  PRIMARY KEY (`CID`,bdate),
  KEY  (`cid`),
	KEY `HOSPCODE` (`HOSPCODE`,`PID`),
  KEY `BDATE` (`BDATE`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO t_postnatal (HOSPCODE,PID,GRAVIDA,BDATE,cid,nation,occupat,birth,vhid)
(SELECT 
HOSPCODE,PID,GRAVIDA,BDATE,cid,nation,occupat,birth,vhid
FROM	tmp_postnatal p
WHERE  p.BDATE BETWEEN @start_d AND @end_d
GROUP BY cid,BDATE
);

UPDATE IGNORE  t_postnatal p INNER JOIN (
SELECT min(PPCARE) PPCARE,BDATE,cid 
FROM tmp_postnatal WHERE TIMESTAMPDIFF(day,bdate,ppcare) <=7
GROUP BY cid,BDATE
) l ON p.cid=l.cid AND p.bdate=l.bdate 
SET p.ppcare1=l.ppcare;

UPDATE IGNORE  t_postnatal p INNER JOIN (
SELECT PPCARE,PPPLACE,BDATE,HOSPCODE,cid FROM tmp_postnatal 
) l ON p.cid=l.cid AND p.bdate=l.bdate AND  p.ppcare1=l.ppcare
SET p.ppcare1_hosp=l.PPPLACE , p.ppcare1_input_hosp=l.HOSPCODE;

UPDATE IGNORE  t_postnatal p INNER JOIN (
SELECT min(PPCARE) PPCARE,BDATE,cid 
FROM tmp_postnatal WHERE TIMESTAMPDIFF(day,bdate,ppcare) BETWEEN 8 AND 15
GROUP BY cid,BDATE
) l ON p.cid=l.cid AND p.bdate=l.bdate 
SET p.ppcare2=l.ppcare;

UPDATE IGNORE  t_postnatal p INNER JOIN (
SELECT PPCARE,PPPLACE,BDATE,HOSPCODE,cid FROM tmp_postnatal 
) l ON p.cid=l.cid AND p.bdate=l.bdate AND  p.ppcare2=l.ppcare
SET p.ppcare2_hosp=l.PPPLACE , p.ppcare2_input_hosp=l.HOSPCODE;

UPDATE IGNORE  t_postnatal p INNER JOIN (
SELECT min(PPCARE) PPCARE,BDATE,cid 
FROM tmp_postnatal WHERE TIMESTAMPDIFF(day,bdate,ppcare) BETWEEN 16 AND 42
GROUP BY cid,BDATE
) l ON p.cid=l.cid AND p.bdate=l.bdate 
SET p.ppcare3=l.ppcare;

UPDATE IGNORE  t_postnatal p INNER JOIN (
SELECT PPCARE,PPPLACE,BDATE,HOSPCODE,cid FROM tmp_postnatal 
) l ON p.cid=l.cid AND p.bdate=l.bdate AND  p.ppcare3=l.ppcare
SET p.ppcare3_hosp=l.PPPLACE , p.ppcare3_input_hosp=l.HOSPCODE;
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.781858;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:395;a:5:{i:0;s:2793:"CREATE PROCEDURE t_postnatal()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '61';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS t_postnatal;
CREATE TABLE IF NOT EXISTS t_postnatal(
`HOSPCODE` varchar(5) NOT NULL,
  `PID` varchar(15) NOT NULL,
  `GRAVIDA` varchar(2) NOT NULL,
  `BDATE` date NOT NULL,
  `cid` varchar(13) DEFAULT NULL,
  `nation` varchar(3) DEFAULT '',
  `occupat` varchar(4) DEFAULT NULL,
  `birth` date DEFAULT NULL,
  `vhid` varchar(8) DEFAULT NULL,
  `ppcare1` date DEFAULT NULL,
  `ppcare1_hosp` varchar(5) DEFAULT NULL,
	`ppcare1_input_hosp` varchar(5) DEFAULT NULL,
  `ppcare2` date DEFAULT NULL,
  `ppcare2_hosp` varchar(5) DEFAULT NULL,
	`ppcare2_input_hosp` varchar(5) DEFAULT NULL,
  `ppcare3` date DEFAULT NULL,
  `ppcare3_hosp` varchar(5) DEFAULT NULL,
	`ppcare3_input_hosp` varchar(5) DEFAULT NULL,
  PRIMARY KEY (`CID`,bdate),
  KEY  (`cid`),
	KEY `HOSPCODE` (`HOSPCODE`,`PID`),
  KEY `BDATE` (`BDATE`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO t_postnatal (HOSPCODE,PID,GRAVIDA,BDATE,cid,nation,occupat,birth,vhid)
(SELECT 
HOSPCODE,PID,GRAVIDA,BDATE,cid,nation,occupat,birth,vhid
FROM	tmp_postnatal p
WHERE  p.BDATE BETWEEN @start_d AND @end_d
GROUP BY cid,BDATE
);

UPDATE IGNORE  t_postnatal p INNER JOIN (
SELECT min(PPCARE) PPCARE,BDATE,cid 
FROM tmp_postnatal WHERE TIMESTAMPDIFF(day,bdate,ppcare) <=7
GROUP BY cid,BDATE
) l ON p.cid=l.cid AND p.bdate=l.bdate 
SET p.ppcare1=l.ppcare;

UPDATE IGNORE  t_postnatal p INNER JOIN (
SELECT PPCARE,PPPLACE,BDATE,HOSPCODE,cid FROM tmp_postnatal 
) l ON p.cid=l.cid AND p.bdate=l.bdate AND  p.ppcare1=l.ppcare
SET p.ppcare1_hosp=l.PPPLACE , p.ppcare1_input_hosp=l.HOSPCODE;

UPDATE IGNORE  t_postnatal p INNER JOIN (
SELECT min(PPCARE) PPCARE,BDATE,cid 
FROM tmp_postnatal WHERE TIMESTAMPDIFF(day,bdate,ppcare) BETWEEN 8 AND 15
GROUP BY cid,BDATE
) l ON p.cid=l.cid AND p.bdate=l.bdate 
SET p.ppcare2=l.ppcare;

UPDATE IGNORE  t_postnatal p INNER JOIN (
SELECT PPCARE,PPPLACE,BDATE,HOSPCODE,cid FROM tmp_postnatal 
) l ON p.cid=l.cid AND p.bdate=l.bdate AND  p.ppcare2=l.ppcare
SET p.ppcare2_hosp=l.PPPLACE , p.ppcare2_input_hosp=l.HOSPCODE;

UPDATE IGNORE  t_postnatal p INNER JOIN (
SELECT min(PPCARE) PPCARE,BDATE,cid 
FROM tmp_postnatal WHERE TIMESTAMPDIFF(day,bdate,ppcare) BETWEEN 16 AND 42
GROUP BY cid,BDATE
) l ON p.cid=l.cid AND p.bdate=l.bdate 
SET p.ppcare3=l.ppcare;

UPDATE IGNORE  t_postnatal p INNER JOIN (
SELECT PPCARE,PPPLACE,BDATE,HOSPCODE,cid FROM tmp_postnatal 
) l ON p.cid=l.cid AND p.bdate=l.bdate AND  p.ppcare3=l.ppcare
SET p.ppcare3_hosp=l.PPPLACE , p.ppcare3_input_hosp=l.HOSPCODE;
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.8286581;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:397;a:5:{i:0;s:36:"DROP PROCEDURE IF EXISTS t_cigarette";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.8286581;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:398;a:5:{i:0;s:36:"DROP PROCEDURE IF EXISTS t_cigarette";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.891058;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:400;a:5:{i:0;s:909:"CREATE PROCEDURE t_cigarette()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '62';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'0701');
SET @end_d:=concat(@b_year,'0930');


DROP TABLE IF EXISTS t_cigarette;
CREATE TABLE IF NOT EXISTS t_cigarette(
 `CID` varchar(13) NOT NULL,
 `HOSPCODE` varchar(5) NOT NULL,
 `PID` varchar(15) NOT NULL,
 `DATE_SERV` date NOT NULL,
 `SOURCE` varchar(30) NOT NULL,
PRIMARY KEY (cid)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO t_cigarette (
SELECT CID,HOSPCODE,PID,DATE_SERV,'SPECIALPP'
FROM tmp_specialpp 
WHERE DATE_SERV BETWEEN @start_d AND @end_d
AND SUBSTR(PPSPECIAL,1,4) IN('1B50','1B53','1B54','1B55','1B56')
);

INSERT IGNORE INTO t_cigarette (
SELECT CID,HOSPCODE,PID,DATE_SERV,'NCDSCREEN'
FROM tmp_ncdscreen 
WHERE DATE_SERV BETWEEN @start_d AND @end_d
AND smoke in(2,3,4)
);
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.891058;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:401;a:5:{i:0;s:909:"CREATE PROCEDURE t_cigarette()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '62';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'0701');
SET @end_d:=concat(@b_year,'0930');


DROP TABLE IF EXISTS t_cigarette;
CREATE TABLE IF NOT EXISTS t_cigarette(
 `CID` varchar(13) NOT NULL,
 `HOSPCODE` varchar(5) NOT NULL,
 `PID` varchar(15) NOT NULL,
 `DATE_SERV` date NOT NULL,
 `SOURCE` varchar(30) NOT NULL,
PRIMARY KEY (cid)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO t_cigarette (
SELECT CID,HOSPCODE,PID,DATE_SERV,'SPECIALPP'
FROM tmp_specialpp 
WHERE DATE_SERV BETWEEN @start_d AND @end_d
AND SUBSTR(PPSPECIAL,1,4) IN('1B50','1B53','1B54','1B55','1B56')
);

INSERT IGNORE INTO t_cigarette (
SELECT CID,HOSPCODE,PID,DATE_SERV,'NCDSCREEN'
FROM tmp_ncdscreen 
WHERE DATE_SERV BETWEEN @start_d AND @end_d
AND smoke in(2,3,4)
);
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.9378581;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:403;a:5:{i:0;s:40:"DROP PROCEDURE IF EXISTS t_breast_screen";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.9378581;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:404;a:5:{i:0;s:40:"DROP PROCEDURE IF EXISTS t_breast_screen";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.000258;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:406;a:5:{i:0;s:2217:"CREATE PROCEDURE t_breast_screen()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '63';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');


DROP TABLE IF EXISTS tmp_breast_screen;
CREATE TABLE IF NOT EXISTS tmp_breast_screen(
PRIMARY KEY (HOSPCODE,PID,DATE_SERV,PPSPECIAL) 
,KEY (cid)
,KEY (hospcode,pid)
,KEY (date_serv)
,KEY (ppspecial)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 AS (
SELECT 
*
FROM tmp_specialpp s 
WHERE s.DATE_SERV BETWEEN @start_d AND @end_d AND SUBSTR(s.ppspecial,1,5) IN('1B003')
);

DROP TABLE IF EXISTS tmp_breast_screen_doctor;
CREATE TABLE IF NOT EXISTS tmp_breast_screen_doctor(
PRIMARY KEY (HOSPCODE,PID,DATE_SERV,DIAGCODE) 
,KEY (cid)
,KEY (hospcode,pid)
,KEY (date_serv)
,KEY (DIAGCODE)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 AS (
SELECT hospcode,pid,seq,date_serv,diagcode,cid 
FROM tmp_diag_opd 
WHERE date_serv BETWEEN @start_d AND @end_d AND SUBSTR(DIAGCODE,1,4) IN('Z123')
GROUP BY HOSPCODE,PID,DATE_SERV,DIAGCODE
);

DROP TABLE IF EXISTS t_breast_screen;
CREATE TABLE IF NOT EXISTS t_breast_screen(
CID varchar(13) NOT NULL,
self_screen varchar(6) DEFAULT NULL,
self_screen_date date DEFAULT NULL,
self_screen_hospcode varchar(5) DEFAULT NULL,
self_screen_input varchar(5) DEFAULT NULL,
doctor_screen varchar(7) DEFAULT NULL,
doctor_screen_date date DEFAULT NULL,
doctor_screen_hospcode varchar(5) DEFAULT NULL,
PRIMARY KEY (CID) 
) ENGINE=MyISAM DEFAULT CHARSET=utf8 ;

INSERT IGNORE INTO t_breast_screen (cid)
(SELECT cid FROM tmp_breast_screen GROUP BY cid);

INSERT IGNORE INTO t_breast_screen (cid)
(SELECT cid FROM tmp_breast_screen_doctor GROUP BY cid);

UPDATE IGNORE t_breast_screen t INNER JOIN (SELECT * FROM tmp_breast_screen ORDER BY DATE_SERV DESC) s ON  t.cid=s.cid
SET t.self_screen=s.PPSPECIAL ,t.self_screen_date =s.date_serv , t.self_screen_hospcode=s.PPSPLACE,t.self_screen_input=s.hospcode;

UPDATE IGNORE t_breast_screen t INNER JOIN (SELECT * FROM tmp_breast_screen_doctor ORDER BY DATE_SERV DESC) s ON  t.cid=s.cid
SET t.doctor_screen=s.diagcode ,t.doctor_screen_date =s.date_serv , t.doctor_screen_hospcode=s.hospcode;
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.000258;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:407;a:5:{i:0;s:2217:"CREATE PROCEDURE t_breast_screen()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '63';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');


DROP TABLE IF EXISTS tmp_breast_screen;
CREATE TABLE IF NOT EXISTS tmp_breast_screen(
PRIMARY KEY (HOSPCODE,PID,DATE_SERV,PPSPECIAL) 
,KEY (cid)
,KEY (hospcode,pid)
,KEY (date_serv)
,KEY (ppspecial)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 AS (
SELECT 
*
FROM tmp_specialpp s 
WHERE s.DATE_SERV BETWEEN @start_d AND @end_d AND SUBSTR(s.ppspecial,1,5) IN('1B003')
);

DROP TABLE IF EXISTS tmp_breast_screen_doctor;
CREATE TABLE IF NOT EXISTS tmp_breast_screen_doctor(
PRIMARY KEY (HOSPCODE,PID,DATE_SERV,DIAGCODE) 
,KEY (cid)
,KEY (hospcode,pid)
,KEY (date_serv)
,KEY (DIAGCODE)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 AS (
SELECT hospcode,pid,seq,date_serv,diagcode,cid 
FROM tmp_diag_opd 
WHERE date_serv BETWEEN @start_d AND @end_d AND SUBSTR(DIAGCODE,1,4) IN('Z123')
GROUP BY HOSPCODE,PID,DATE_SERV,DIAGCODE
);

DROP TABLE IF EXISTS t_breast_screen;
CREATE TABLE IF NOT EXISTS t_breast_screen(
CID varchar(13) NOT NULL,
self_screen varchar(6) DEFAULT NULL,
self_screen_date date DEFAULT NULL,
self_screen_hospcode varchar(5) DEFAULT NULL,
self_screen_input varchar(5) DEFAULT NULL,
doctor_screen varchar(7) DEFAULT NULL,
doctor_screen_date date DEFAULT NULL,
doctor_screen_hospcode varchar(5) DEFAULT NULL,
PRIMARY KEY (CID) 
) ENGINE=MyISAM DEFAULT CHARSET=utf8 ;

INSERT IGNORE INTO t_breast_screen (cid)
(SELECT cid FROM tmp_breast_screen GROUP BY cid);

INSERT IGNORE INTO t_breast_screen (cid)
(SELECT cid FROM tmp_breast_screen_doctor GROUP BY cid);

UPDATE IGNORE t_breast_screen t INNER JOIN (SELECT * FROM tmp_breast_screen ORDER BY DATE_SERV DESC) s ON  t.cid=s.cid
SET t.self_screen=s.PPSPECIAL ,t.self_screen_date =s.date_serv , t.self_screen_hospcode=s.PPSPLACE,t.self_screen_input=s.hospcode;

UPDATE IGNORE t_breast_screen t INNER JOIN (SELECT * FROM tmp_breast_screen_doctor ORDER BY DATE_SERV DESC) s ON  t.cid=s.cid
SET t.doctor_screen=s.diagcode ,t.doctor_screen_date =s.date_serv , t.doctor_screen_hospcode=s.hospcode;
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.0470581;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:409;a:5:{i:0;s:40:"DROP PROCEDURE IF EXISTS t_cervix_screen";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.0470581;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:410;a:5:{i:0;s:40:"DROP PROCEDURE IF EXISTS t_cervix_screen";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.093858;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:412;a:5:{i:0;s:1658:"CREATE PROCEDURE t_cervix_screen()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '64';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @year_start:=(SELECT `year` FROM ccervix_year WHERE  `year` <= @b_year LIMIT 1);
SET @start_d:=concat(@year_start,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS tmp_cervix_diag5;
CREATE TABLE IF NOT EXISTS tmp_cervix_diag5(
PRIMARY KEY (HOSPCODE,PID,SEQ)
,KEY (cid)
,KEY (date_serv)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 AS
(SELECT o.hospcode,o.pid,o.seq,o.date_serv,o.diagcode,p.cid
FROM diagnosis_opd o  INNER JOIN person p ON o.hospcode=p.hospcode AND o.pid=p.pid
WHERE o.DATE_SERV  BETWEEN @start_d AND @end_d 
AND SUBSTR(o.DIAGCODE,1,4) IN('Z014','Z124')
GROUP BY o.HOSPCODE,o.PID,o.SEQ
);

DROP TABLE IF EXISTS t_cervix_screen;
CREATE TABLE IF NOT EXISTS t_cervix_screen(
CID varchar(13) NOT NULL,
screen_code varchar(7) DEFAULT NULL,
screen_date date DEFAULT NULL,
screen_source varchar(30) DEFAULT NULL,
screen_hospcode varchar(5) DEFAULT NULL,
screen_input varchar(5) DEFAULT NULL,
PRIMARY KEY (CID,screen_date) 
,KEY (cid)
,KEY (screen_date)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 ;

INSERT IGNORE INTO t_cervix_screen (
SELECT cid,PPSPECIAL,DATE_SERV,'SPECIALPP',PPSPLACE,HOSPCODE
FROM tmp_specialpp s 
WHERE s.DATE_SERV BETWEEN @start_d AND @end_d 
AND SUBSTR(s.ppspecial,1,5) IN('1B004') AND LENGTH(cid)=13
GROUP BY CID
);

INSERT IGNORE INTO t_cervix_screen (
SELECT cid,DIAGCODE,DATE_SERV,'DIAGNOSIS_OPD',HOSPCODE,HOSPCODE
FROM tmp_cervix_diag5 s 
WHERE s.DATE_SERV BETWEEN @start_d AND @end_d  AND LENGTH(cid)=13
GROUP BY CID
);
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.109458;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:413;a:5:{i:0;s:1658:"CREATE PROCEDURE t_cervix_screen()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '64';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @year_start:=(SELECT `year` FROM ccervix_year WHERE  `year` <= @b_year LIMIT 1);
SET @start_d:=concat(@year_start,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS tmp_cervix_diag5;
CREATE TABLE IF NOT EXISTS tmp_cervix_diag5(
PRIMARY KEY (HOSPCODE,PID,SEQ)
,KEY (cid)
,KEY (date_serv)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 AS
(SELECT o.hospcode,o.pid,o.seq,o.date_serv,o.diagcode,p.cid
FROM diagnosis_opd o  INNER JOIN person p ON o.hospcode=p.hospcode AND o.pid=p.pid
WHERE o.DATE_SERV  BETWEEN @start_d AND @end_d 
AND SUBSTR(o.DIAGCODE,1,4) IN('Z014','Z124')
GROUP BY o.HOSPCODE,o.PID,o.SEQ
);

DROP TABLE IF EXISTS t_cervix_screen;
CREATE TABLE IF NOT EXISTS t_cervix_screen(
CID varchar(13) NOT NULL,
screen_code varchar(7) DEFAULT NULL,
screen_date date DEFAULT NULL,
screen_source varchar(30) DEFAULT NULL,
screen_hospcode varchar(5) DEFAULT NULL,
screen_input varchar(5) DEFAULT NULL,
PRIMARY KEY (CID,screen_date) 
,KEY (cid)
,KEY (screen_date)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 ;

INSERT IGNORE INTO t_cervix_screen (
SELECT cid,PPSPECIAL,DATE_SERV,'SPECIALPP',PPSPLACE,HOSPCODE
FROM tmp_specialpp s 
WHERE s.DATE_SERV BETWEEN @start_d AND @end_d 
AND SUBSTR(s.ppspecial,1,5) IN('1B004') AND LENGTH(cid)=13
GROUP BY CID
);

INSERT IGNORE INTO t_cervix_screen (
SELECT cid,DIAGCODE,DATE_SERV,'DIAGNOSIS_OPD',HOSPCODE,HOSPCODE
FROM tmp_cervix_diag5 s 
WHERE s.DATE_SERV BETWEEN @start_d AND @end_d  AND LENGTH(cid)=13
GROUP BY CID
);
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.1562591;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:415;a:5:{i:0;s:33:"DROP PROCEDURE IF EXISTS t_ttm1_5";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.1562591;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:416;a:5:{i:0;s:33:"DROP PROCEDURE IF EXISTS t_ttm1_5";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.2154601;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:418;a:5:{i:0;s:12670:"CREATE PROCEDURE t_ttm1_5()
 BEGIN 
SET @provid = '58';
SET@id:= '65';
SET @rep_year = (SELECT yearprocess FROM sys_config LIMIT 1);

/**********ttm1*****************/
DROP TEMPORARY TABLE IF  EXISTS mother_service;
CREATE TEMPORARY TABLE IF NOT EXISTS 
mother_service (INDEX(CID)) 
ENGINE=MYISAM IGNORE AS 
SELECT 
e.HOSPCODE, 
e.PID, 
e.SEQ, 
e.DATE_SERV,
s.INSTYPE,
GROUP_CONCAT(e.PROCEDCODE) PROCEDCODE,
p.BIRTH,
p.CID,
LENGTH(GROUP_CONCAT(e.PROCEDCODE)) length_str
FROM tmp_procedure_opd e 
LEFT JOIN tmp_service s ON e.HOSPCODE = s.HOSPCODE AND e.PID = s.PID AND e.SEQ = s.SEQ 
LEFT JOIN person p ON e.HOSPCODE = p.HOSPCODE AND e.PID = p.PID AND s.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
WHERE e.PROCEDCODE IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND 
e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') AND 
p.SEX = 2 
GROUP BY e.HOSPCODE, e.PID, e.SEQ 
;

DROP TEMPORARY TABLE IF  EXISTS labor_rep;
CREATE TEMPORARY TABLE IF NOT EXISTS 
labor_rep (INDEX(CID)) 
ENGINE=MYISAM IGNORE AS 
SELECT 
p.CID,
l.BDATE
FROM 
tmp_labor l
LEFT JOIN person p ON l.HOSPCODE = p.HOSPCODE AND l.PID = p.PID  
WHERE 
l.BDATE BETWEEN CONCAT((@rep_year-1),'0701') AND CONCAT(@rep_year,'0930') AND 
p.CID IS NOT NULL 
GROUP BY p.CID 
;

DROP TABLE IF  EXISTS t_ttm_opd_1;
CREATE TABLE IF NOT EXISTS t_ttm_opd_1( 
PRIMARY KEY (hospcode,code_rep ),
KEY (hospcode)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT SQL_BIG_RESULT
e.HOSPCODE ,
CONCAT(e.HOSPCODE,'-',e.PID) code_rep,
@rep_year year_rep,
TIMESTAMPDIFF(YEAR,e.BIRTH,e.DATE_SERV) age,
MIN(e.DATE_SERV) begin_date_serv,
COUNT(DISTINCT   l.CID) all_mother,
COUNT(IF(e.length_str=39,1,NULL)) have_service,
COUNT(1) all_service,
COUNT(IF(e.PROCEDCODE LIKE '%9007712%',1,NULL)) ttm_service,
IF(DATEDIFF(MIN(e.DATE_SERV),l.BDATE) BETWEEN 0 AND 45,0,1) not_in_time,
IF(DATEDIFF(MAX(e.DATE_SERV),MIN(e.DATE_SERV)) BETWEEN 0 AND 90,0,1) not_less90days,

COUNT(DISTINCT IF(e.INSTYPE='0100',l.CID,NULL)) all_uc_mother,
COUNT(IF(e.length_str=39 AND e.INSTYPE='0100',1,NULL)) uc_have_service,
COUNT(IF(e.INSTYPE='0100',1,NULL)) uc_all_service,
IF(e.INSTYPE='0100',IF(DATEDIFF(MIN(e.DATE_SERV),l.BDATE) BETWEEN 0 AND 45,0,1),0) uc_not_in_time,
IF(e.INSTYPE='0100',IF(DATEDIFF(MAX(e.DATE_SERV),MIN(e.DATE_SERV)) BETWEEN 0 AND 90,0,1),0) uc_not_less90days 
FROM mother_service e 
LEFT JOIN labor_rep l ON l.CID = e.CID
LEFT JOIN chospital i ON e.HOSPCODE = i.hoscode 
WHERE 
i.provcode=@provid 
GROUP BY e.HOSPCODE, e.PID ;

/**********ttm2*****************/
DROP TABLE IF  EXISTS tmp_planthai_drug_use;
CREATE  TABLE IF NOT EXISTS 
tmp_planthai_drug_use (INDEX(HOSPCODE),INDEX(PID),INDEX(SEQ)) 
ENGINE=MYISAM IGNORE AS 
SELECT
e.HOSPCODE,
e.PID,
e.SEQ,
e.DATE_SERV,
e.DIDSTD,
e.AMOUNT,
e.DRUGPRICE,
e.DRUGCOST,
d.didstd PASS,
d.drug_name,
d.drug_type ,
d.ed
FROM 
tmp_drug_opd e 
LEFT JOIN cdrug_planthai d ON d.didstd=e.DIDSTD 
WHERE
e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIDSTD,2) IN ('41','42') 
;

DROP TABLE IF  EXISTS t_ttm_opd_2;
CREATE TABLE IF NOT EXISTS t_ttm_opd_2( 
PRIMARY KEY (hospcode,code_rep ),
KEY (hospcode)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
e.HOSPCODE ,
IFNULL(e.code_rep,CONCAT(@rep_year,'-07')) code_rep,
IFNULL(
IF(e.code_name=1,'มกราคม',
IF(e.code_name=2,'กุมภาพันธ์',
IF(e.code_name=3,'มีนาคม',
IF(e.code_name=4,'เมษายน',
IF(e.code_name=5,'พฤษภาคม',
IF(e.code_name=6,'มิถุนายน',
IF(e.code_name=7,'กรกฏาคม',
IF(e.code_name=8,'สิงหาคม',
IF(e.code_name=9,'กันยายน',
IF(e.code_name=10,'ตุลาคม',
IF(e.code_name=11,'พฤศจิกายน',
'ธันวาคม')))))))))))
,'กรกฏาคม') code_name,
IFNULL(e.year_rep,@rep_year) year_rep,
IFNULL(e.all_visit,0) all_visit,
IFNULL(e.all_drug,0) all_drug,
IFNULL(e.uc_visit,0) uc_visit,
IFNULL(e.uc_drug,0) uc_drug,
IFNULL(e.all_visit_error,0) all_visit_error,
IFNULL(e.all_drug_error,0) all_drug_error,
IFNULL(e.uc_visit_error,0) uc_visit_error,
IFNULL(e.uc_drug_error,0) uc_drug_error
FROM chospital o 
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE, 
LEFT(DATE(e.DATE_SERV),7) code_rep,
MONTH(e.DATE_SERV) code_name,
@rep_year year_rep, 
COUNT(DISTINCT CONCAT(e.PID,'-',e.SEQ)) as all_visit, 
COUNT(*) as all_drug, 
COUNT(DISTINCT (IF(s.INSTYPE='0100',CONCAT(e.PID,'-',e.SEQ),NULL))) as uc_visit , 
COUNT(IF(s.INSTYPE='0100',1,NULL)) as uc_drug,
COUNT(DISTINCT IF(e.PASS IS NULL,CONCAT(e.PID,'-',e.SEQ),NULL)) as all_visit_error, 
COUNT(IF(e.PASS IS NULL,CONCAT(e.PID,'-',e.SEQ),NULL)) as all_drug_error, 
COUNT(DISTINCT (IF(s.INSTYPE='0100' AND e.PASS IS NULL,CONCAT(e.PID,'-',e.SEQ),NULL))) as uc_visit_error , 
COUNT(IF(s.INSTYPE='0100' AND e.PASS IS NULL,1,NULL)) as uc_drug_error  
FROM 
tmp_planthai_drug_use e
LEFT JOIN tmp_service s ON e.HOSPCODE = s.HOSPCODE AND e.PID = s.PID AND e.SEQ = s.SEQ 
GROUP BY e.HOSPCODE, MONTH(e.DATE_SERV) 
) e ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid  AND e.code_rep IS NOT NULL ;

/***************ttm3****************/
DROP TABLE IF  EXISTS t_ttm_opd_3;
CREATE TABLE IF NOT EXISTS t_ttm_opd_3( 
PRIMARY KEY (hospcode,servplace,age,sex),
KEY (hospcode),
KEY (servplace),
KEY (age),
KEY (sex)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
e.HOSPCODE ,
e.servplace,
e.age,
e.sex,
@rep_year year_rep,
IFNULL(e.total_pt_q1,0) total_pt_q1,	
IFNULL(e.total_q1,0) total_q1,
IFNULL(e.didstd_q1,0) didstd_q1,
IFNULL(e.total_pt_q2,0) total_pt_q2,	
IFNULL(e.total_q2,0) total_q2,
IFNULL(e.didstd_q2,0) didstd_q2,
IFNULL(e.total_pt_q3,0) total_pt_q3,	
IFNULL(e.total_q3,0) total_q3,
IFNULL(e.didstd_q3,0) didstd_q3,	
IFNULL(e.total_pt_q4,0) total_pt_q4,	
IFNULL(e.total_q4,0) total_q4,
IFNULL(e.didstd_q4,0) didstd_q4
FROM chospital o 
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE, 
e.DATE_SERV,
s.SERVPLACE servplace,
TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'1001')) age,
p.SEX sex,
@rep_year year_rep, 
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) total_pt_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ,'-',e.DIDSTD),NULL)) didstd_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) total_pt_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ,'-',e.DIDSTD),NULL)) didstd_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) total_pt_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ,'-',e.DIDSTD),NULL)) didstd_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) total_pt_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ,'-',e.DIDSTD),NULL)) didstd_q4 
FROM 
tmp_planthai_drug_use e
LEFT JOIN tmp_service s ON e.HOSPCODE = s.HOSPCODE AND e.PID = s.PID AND e.SEQ = s.SEQ 
LEFT JOIN person p ON e.HOSPCODE = p.HOSPCODE AND e.PID = p.PID 
GROUP BY e.HOSPCODE, s.SERVPLACE, p.SEX, TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'1001'))
) e ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.servplace IN ('1','2') AND e.HOSPCODE IS NOT NULL ;

/*********************ttm4**************/
DROP TABLE IF  EXISTS t_ttm_opd_4;
CREATE TABLE IF NOT EXISTS t_ttm_opd_4( 
PRIMARY KEY (hospcode,didstd),
KEY (hospcode),
KEY (didstd)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
o.hoscode hospcode ,
e.didstd,
IFNULL(CONCAT(e.drug_name,', ',e.drug_type),e.didstd) code_name,
@rep_year year_rep,
IFNULL(e.all_visit,0) all_visit,
IFNULL(e.all_drug,0) all_drug,
IFNULL(e.uc_visit,0) uc_visit,
IFNULL(e.uc_drug,0) uc_drug,
IFNULL(e.all_visit_error,0) all_visit_error,
IFNULL(e.all_drug_error,0) all_drug_error,
IFNULL(e.uc_visit_error,0) uc_visit_error,
IFNULL(e.uc_drug_error,0) uc_drug_error
FROM chospital o 
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE, 
e.DIDSTD didstd,
e.drug_name, 
e.drug_type,
@rep_year year_rep, 
COUNT(DISTINCT CONCAT(e.PID,'-',e.SEQ)) as all_visit, 
COUNT(*) as all_drug, 
COUNT(DISTINCT (IF(s.INSTYPE='0100',CONCAT(e.PID,'-',e.SEQ),NULL))) as uc_visit , 
COUNT(IF(s.INSTYPE='0100',1,NULL)) as uc_drug,
COUNT(DISTINCT IF(e.PASS IS NULL,CONCAT(e.PID,'-',e.SEQ),NULL)) as all_visit_error, 
COUNT(IF(e.PASS IS NULL,CONCAT(e.PID,'-',e.SEQ),NULL)) as all_drug_error, 
COUNT(DISTINCT (IF(s.INSTYPE='0100' AND e.PASS IS NULL,CONCAT(e.PID,'-',e.SEQ),NULL))) as uc_visit_error , 
COUNT(IF(s.INSTYPE='0100' AND e.PASS IS NULL,1,NULL)) as uc_drug_error  
FROM 
tmp_planthai_drug_use e
LEFT JOIN tmp_service s ON e.HOSPCODE = s.HOSPCODE AND e.PID = s.PID AND e.SEQ = s.SEQ 
GROUP BY e.HOSPCODE, e.DIDSTD ) e ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.didstd IS NOT NULL ;

/**************ttm5**********************/
DROP TABLE IF  EXISTS t_ttm_opd_5;
CREATE TABLE IF NOT EXISTS t_ttm_opd_5( 
PRIMARY KEY (hospcode,didstd,instype),
KEY (hospcode),
KEY (didstd),
KEY (instype)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
o.hoscode hospcode , 
e.didstd, 
IFNULL(CONCAT(e.drug_name,', ',e.drug_type),e.didstd) code_name, 
IF(e.INSTYPE='0100','UC','OTHER') instype, 
@rep_year year_rep, 
IFNULL(e.total_pt_q1,0) total_pt_q1, 
IFNULL(e.total_q1,0) total_q1, 
IFNULL(e.total_amount_q1,0) total_amount_q1, 
IFNULL(e.total_price_q1,0) total_price_q1, 
IFNULL(e.total_cost_q1,0) total_cost_q1, 
IFNULL(e.total_pt_q2,0) total_pt_q2, 
IFNULL(e.total_q2,0) total_q2, 
IFNULL(e.total_amount_q2,0) total_amount_q2, 
IFNULL(e.total_price_q2,0) total_price_q2, 
IFNULL(e.total_cost_q2,0) total_cost_q2, 
IFNULL(e.total_pt_q3,0) total_pt_q3, 
IFNULL(e.total_q3,0) total_q3, 
IFNULL(e.total_amount_q3,0) total_amount_q3, 
IFNULL(e.total_price_q3,0) total_price_q3, 
IFNULL(e.total_cost_q3,0) total_cost_q3, 
IFNULL(e.total_pt_q4,0) total_pt_q4, 
IFNULL(e.total_q4,0) total_q4, 
IFNULL(e.total_amount_q4,0) total_amount_q4, 
IFNULL(e.total_price_q4,0) total_price_q4, 
IFNULL(e.total_cost_q4,0) total_cost_q4 
FROM chospital o 
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE, 
e.DIDSTD didstd,
e.drug_name, 
e.drug_type,
s.INSTYPE,
@rep_year year_rep, 
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) total_pt_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q1,
SUM(IF(MONTH(e.DATE_SERV) IN (10,11,12),e.AMOUNT,0)) total_amount_q1,
SUM(IF(MONTH(e.DATE_SERV) IN (10,11,12),e.AMOUNT*e.DRUGPRICE,0)) total_price_q1,
SUM(IF(MONTH(e.DATE_SERV) IN (10,11,12),e.AMOUNT*e.DRUGCOST,0)) total_cost_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) total_pt_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q2,
SUM(IF(MONTH(e.DATE_SERV) IN (1,2,3),e.AMOUNT,0)) total_amount_q2,
SUM(IF(MONTH(e.DATE_SERV) IN (1,2,3),e.AMOUNT*e.DRUGPRICE,0)) total_price_q2,
SUM(IF(MONTH(e.DATE_SERV) IN (1,2,3),e.AMOUNT*e.DRUGCOST,0)) total_cost_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) total_pt_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q3,
SUM(IF(MONTH(e.DATE_SERV) IN (4,5,6),e.AMOUNT,0)) total_amount_q3,
SUM(IF(MONTH(e.DATE_SERV) IN (4,5,6),e.AMOUNT*e.DRUGPRICE,0)) total_price_q3,
SUM(IF(MONTH(e.DATE_SERV) IN (4,5,6),e.AMOUNT*e.DRUGCOST,0)) total_cost_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) total_pt_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q4,
SUM(IF(MONTH(e.DATE_SERV) IN (7,8,9),e.AMOUNT,0)) total_amount_q4,
SUM(IF(MONTH(e.DATE_SERV) IN (7,8,9),e.AMOUNT*e.DRUGPRICE,0)) total_price_q4,
SUM(IF(MONTH(e.DATE_SERV) IN (7,8,9),e.AMOUNT*e.DRUGCOST,0)) total_cost_q4
FROM 
tmp_planthai_drug_use e
LEFT JOIN tmp_service s ON e.HOSPCODE = s.HOSPCODE AND e.PID = s.PID AND e.SEQ = s.SEQ 
GROUP BY e.HOSPCODE,IF(s.INSTYPE='0100','UC','OTHER'), e.DIDSTD ) e ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.HOSPCODE IS NOT NULL  AND e.didstd IS NOT NULL ;

 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.23106;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:419;a:5:{i:0;s:12670:"CREATE PROCEDURE t_ttm1_5()
 BEGIN 
SET @provid = '58';
SET@id:= '65';
SET @rep_year = (SELECT yearprocess FROM sys_config LIMIT 1);

/**********ttm1*****************/
DROP TEMPORARY TABLE IF  EXISTS mother_service;
CREATE TEMPORARY TABLE IF NOT EXISTS 
mother_service (INDEX(CID)) 
ENGINE=MYISAM IGNORE AS 
SELECT 
e.HOSPCODE, 
e.PID, 
e.SEQ, 
e.DATE_SERV,
s.INSTYPE,
GROUP_CONCAT(e.PROCEDCODE) PROCEDCODE,
p.BIRTH,
p.CID,
LENGTH(GROUP_CONCAT(e.PROCEDCODE)) length_str
FROM tmp_procedure_opd e 
LEFT JOIN tmp_service s ON e.HOSPCODE = s.HOSPCODE AND e.PID = s.PID AND e.SEQ = s.SEQ 
LEFT JOIN person p ON e.HOSPCODE = p.HOSPCODE AND e.PID = p.PID AND s.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
WHERE e.PROCEDCODE IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND 
e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') AND 
p.SEX = 2 
GROUP BY e.HOSPCODE, e.PID, e.SEQ 
;

DROP TEMPORARY TABLE IF  EXISTS labor_rep;
CREATE TEMPORARY TABLE IF NOT EXISTS 
labor_rep (INDEX(CID)) 
ENGINE=MYISAM IGNORE AS 
SELECT 
p.CID,
l.BDATE
FROM 
tmp_labor l
LEFT JOIN person p ON l.HOSPCODE = p.HOSPCODE AND l.PID = p.PID  
WHERE 
l.BDATE BETWEEN CONCAT((@rep_year-1),'0701') AND CONCAT(@rep_year,'0930') AND 
p.CID IS NOT NULL 
GROUP BY p.CID 
;

DROP TABLE IF  EXISTS t_ttm_opd_1;
CREATE TABLE IF NOT EXISTS t_ttm_opd_1( 
PRIMARY KEY (hospcode,code_rep ),
KEY (hospcode)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT SQL_BIG_RESULT
e.HOSPCODE ,
CONCAT(e.HOSPCODE,'-',e.PID) code_rep,
@rep_year year_rep,
TIMESTAMPDIFF(YEAR,e.BIRTH,e.DATE_SERV) age,
MIN(e.DATE_SERV) begin_date_serv,
COUNT(DISTINCT   l.CID) all_mother,
COUNT(IF(e.length_str=39,1,NULL)) have_service,
COUNT(1) all_service,
COUNT(IF(e.PROCEDCODE LIKE '%9007712%',1,NULL)) ttm_service,
IF(DATEDIFF(MIN(e.DATE_SERV),l.BDATE) BETWEEN 0 AND 45,0,1) not_in_time,
IF(DATEDIFF(MAX(e.DATE_SERV),MIN(e.DATE_SERV)) BETWEEN 0 AND 90,0,1) not_less90days,

COUNT(DISTINCT IF(e.INSTYPE='0100',l.CID,NULL)) all_uc_mother,
COUNT(IF(e.length_str=39 AND e.INSTYPE='0100',1,NULL)) uc_have_service,
COUNT(IF(e.INSTYPE='0100',1,NULL)) uc_all_service,
IF(e.INSTYPE='0100',IF(DATEDIFF(MIN(e.DATE_SERV),l.BDATE) BETWEEN 0 AND 45,0,1),0) uc_not_in_time,
IF(e.INSTYPE='0100',IF(DATEDIFF(MAX(e.DATE_SERV),MIN(e.DATE_SERV)) BETWEEN 0 AND 90,0,1),0) uc_not_less90days 
FROM mother_service e 
LEFT JOIN labor_rep l ON l.CID = e.CID
LEFT JOIN chospital i ON e.HOSPCODE = i.hoscode 
WHERE 
i.provcode=@provid 
GROUP BY e.HOSPCODE, e.PID ;

/**********ttm2*****************/
DROP TABLE IF  EXISTS tmp_planthai_drug_use;
CREATE  TABLE IF NOT EXISTS 
tmp_planthai_drug_use (INDEX(HOSPCODE),INDEX(PID),INDEX(SEQ)) 
ENGINE=MYISAM IGNORE AS 
SELECT
e.HOSPCODE,
e.PID,
e.SEQ,
e.DATE_SERV,
e.DIDSTD,
e.AMOUNT,
e.DRUGPRICE,
e.DRUGCOST,
d.didstd PASS,
d.drug_name,
d.drug_type ,
d.ed
FROM 
tmp_drug_opd e 
LEFT JOIN cdrug_planthai d ON d.didstd=e.DIDSTD 
WHERE
e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIDSTD,2) IN ('41','42') 
;

DROP TABLE IF  EXISTS t_ttm_opd_2;
CREATE TABLE IF NOT EXISTS t_ttm_opd_2( 
PRIMARY KEY (hospcode,code_rep ),
KEY (hospcode)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
e.HOSPCODE ,
IFNULL(e.code_rep,CONCAT(@rep_year,'-07')) code_rep,
IFNULL(
IF(e.code_name=1,'มกราคม',
IF(e.code_name=2,'กุมภาพันธ์',
IF(e.code_name=3,'มีนาคม',
IF(e.code_name=4,'เมษายน',
IF(e.code_name=5,'พฤษภาคม',
IF(e.code_name=6,'มิถุนายน',
IF(e.code_name=7,'กรกฏาคม',
IF(e.code_name=8,'สิงหาคม',
IF(e.code_name=9,'กันยายน',
IF(e.code_name=10,'ตุลาคม',
IF(e.code_name=11,'พฤศจิกายน',
'ธันวาคม')))))))))))
,'กรกฏาคม') code_name,
IFNULL(e.year_rep,@rep_year) year_rep,
IFNULL(e.all_visit,0) all_visit,
IFNULL(e.all_drug,0) all_drug,
IFNULL(e.uc_visit,0) uc_visit,
IFNULL(e.uc_drug,0) uc_drug,
IFNULL(e.all_visit_error,0) all_visit_error,
IFNULL(e.all_drug_error,0) all_drug_error,
IFNULL(e.uc_visit_error,0) uc_visit_error,
IFNULL(e.uc_drug_error,0) uc_drug_error
FROM chospital o 
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE, 
LEFT(DATE(e.DATE_SERV),7) code_rep,
MONTH(e.DATE_SERV) code_name,
@rep_year year_rep, 
COUNT(DISTINCT CONCAT(e.PID,'-',e.SEQ)) as all_visit, 
COUNT(*) as all_drug, 
COUNT(DISTINCT (IF(s.INSTYPE='0100',CONCAT(e.PID,'-',e.SEQ),NULL))) as uc_visit , 
COUNT(IF(s.INSTYPE='0100',1,NULL)) as uc_drug,
COUNT(DISTINCT IF(e.PASS IS NULL,CONCAT(e.PID,'-',e.SEQ),NULL)) as all_visit_error, 
COUNT(IF(e.PASS IS NULL,CONCAT(e.PID,'-',e.SEQ),NULL)) as all_drug_error, 
COUNT(DISTINCT (IF(s.INSTYPE='0100' AND e.PASS IS NULL,CONCAT(e.PID,'-',e.SEQ),NULL))) as uc_visit_error , 
COUNT(IF(s.INSTYPE='0100' AND e.PASS IS NULL,1,NULL)) as uc_drug_error  
FROM 
tmp_planthai_drug_use e
LEFT JOIN tmp_service s ON e.HOSPCODE = s.HOSPCODE AND e.PID = s.PID AND e.SEQ = s.SEQ 
GROUP BY e.HOSPCODE, MONTH(e.DATE_SERV) 
) e ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid  AND e.code_rep IS NOT NULL ;

/***************ttm3****************/
DROP TABLE IF  EXISTS t_ttm_opd_3;
CREATE TABLE IF NOT EXISTS t_ttm_opd_3( 
PRIMARY KEY (hospcode,servplace,age,sex),
KEY (hospcode),
KEY (servplace),
KEY (age),
KEY (sex)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
e.HOSPCODE ,
e.servplace,
e.age,
e.sex,
@rep_year year_rep,
IFNULL(e.total_pt_q1,0) total_pt_q1,	
IFNULL(e.total_q1,0) total_q1,
IFNULL(e.didstd_q1,0) didstd_q1,
IFNULL(e.total_pt_q2,0) total_pt_q2,	
IFNULL(e.total_q2,0) total_q2,
IFNULL(e.didstd_q2,0) didstd_q2,
IFNULL(e.total_pt_q3,0) total_pt_q3,	
IFNULL(e.total_q3,0) total_q3,
IFNULL(e.didstd_q3,0) didstd_q3,	
IFNULL(e.total_pt_q4,0) total_pt_q4,	
IFNULL(e.total_q4,0) total_q4,
IFNULL(e.didstd_q4,0) didstd_q4
FROM chospital o 
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE, 
e.DATE_SERV,
s.SERVPLACE servplace,
TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'1001')) age,
p.SEX sex,
@rep_year year_rep, 
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) total_pt_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ,'-',e.DIDSTD),NULL)) didstd_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) total_pt_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ,'-',e.DIDSTD),NULL)) didstd_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) total_pt_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ,'-',e.DIDSTD),NULL)) didstd_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) total_pt_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ,'-',e.DIDSTD),NULL)) didstd_q4 
FROM 
tmp_planthai_drug_use e
LEFT JOIN tmp_service s ON e.HOSPCODE = s.HOSPCODE AND e.PID = s.PID AND e.SEQ = s.SEQ 
LEFT JOIN person p ON e.HOSPCODE = p.HOSPCODE AND e.PID = p.PID 
GROUP BY e.HOSPCODE, s.SERVPLACE, p.SEX, TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'1001'))
) e ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.servplace IN ('1','2') AND e.HOSPCODE IS NOT NULL ;

/*********************ttm4**************/
DROP TABLE IF  EXISTS t_ttm_opd_4;
CREATE TABLE IF NOT EXISTS t_ttm_opd_4( 
PRIMARY KEY (hospcode,didstd),
KEY (hospcode),
KEY (didstd)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
o.hoscode hospcode ,
e.didstd,
IFNULL(CONCAT(e.drug_name,', ',e.drug_type),e.didstd) code_name,
@rep_year year_rep,
IFNULL(e.all_visit,0) all_visit,
IFNULL(e.all_drug,0) all_drug,
IFNULL(e.uc_visit,0) uc_visit,
IFNULL(e.uc_drug,0) uc_drug,
IFNULL(e.all_visit_error,0) all_visit_error,
IFNULL(e.all_drug_error,0) all_drug_error,
IFNULL(e.uc_visit_error,0) uc_visit_error,
IFNULL(e.uc_drug_error,0) uc_drug_error
FROM chospital o 
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE, 
e.DIDSTD didstd,
e.drug_name, 
e.drug_type,
@rep_year year_rep, 
COUNT(DISTINCT CONCAT(e.PID,'-',e.SEQ)) as all_visit, 
COUNT(*) as all_drug, 
COUNT(DISTINCT (IF(s.INSTYPE='0100',CONCAT(e.PID,'-',e.SEQ),NULL))) as uc_visit , 
COUNT(IF(s.INSTYPE='0100',1,NULL)) as uc_drug,
COUNT(DISTINCT IF(e.PASS IS NULL,CONCAT(e.PID,'-',e.SEQ),NULL)) as all_visit_error, 
COUNT(IF(e.PASS IS NULL,CONCAT(e.PID,'-',e.SEQ),NULL)) as all_drug_error, 
COUNT(DISTINCT (IF(s.INSTYPE='0100' AND e.PASS IS NULL,CONCAT(e.PID,'-',e.SEQ),NULL))) as uc_visit_error , 
COUNT(IF(s.INSTYPE='0100' AND e.PASS IS NULL,1,NULL)) as uc_drug_error  
FROM 
tmp_planthai_drug_use e
LEFT JOIN tmp_service s ON e.HOSPCODE = s.HOSPCODE AND e.PID = s.PID AND e.SEQ = s.SEQ 
GROUP BY e.HOSPCODE, e.DIDSTD ) e ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.didstd IS NOT NULL ;

/**************ttm5**********************/
DROP TABLE IF  EXISTS t_ttm_opd_5;
CREATE TABLE IF NOT EXISTS t_ttm_opd_5( 
PRIMARY KEY (hospcode,didstd,instype),
KEY (hospcode),
KEY (didstd),
KEY (instype)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
o.hoscode hospcode , 
e.didstd, 
IFNULL(CONCAT(e.drug_name,', ',e.drug_type),e.didstd) code_name, 
IF(e.INSTYPE='0100','UC','OTHER') instype, 
@rep_year year_rep, 
IFNULL(e.total_pt_q1,0) total_pt_q1, 
IFNULL(e.total_q1,0) total_q1, 
IFNULL(e.total_amount_q1,0) total_amount_q1, 
IFNULL(e.total_price_q1,0) total_price_q1, 
IFNULL(e.total_cost_q1,0) total_cost_q1, 
IFNULL(e.total_pt_q2,0) total_pt_q2, 
IFNULL(e.total_q2,0) total_q2, 
IFNULL(e.total_amount_q2,0) total_amount_q2, 
IFNULL(e.total_price_q2,0) total_price_q2, 
IFNULL(e.total_cost_q2,0) total_cost_q2, 
IFNULL(e.total_pt_q3,0) total_pt_q3, 
IFNULL(e.total_q3,0) total_q3, 
IFNULL(e.total_amount_q3,0) total_amount_q3, 
IFNULL(e.total_price_q3,0) total_price_q3, 
IFNULL(e.total_cost_q3,0) total_cost_q3, 
IFNULL(e.total_pt_q4,0) total_pt_q4, 
IFNULL(e.total_q4,0) total_q4, 
IFNULL(e.total_amount_q4,0) total_amount_q4, 
IFNULL(e.total_price_q4,0) total_price_q4, 
IFNULL(e.total_cost_q4,0) total_cost_q4 
FROM chospital o 
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE, 
e.DIDSTD didstd,
e.drug_name, 
e.drug_type,
s.INSTYPE,
@rep_year year_rep, 
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) total_pt_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q1,
SUM(IF(MONTH(e.DATE_SERV) IN (10,11,12),e.AMOUNT,0)) total_amount_q1,
SUM(IF(MONTH(e.DATE_SERV) IN (10,11,12),e.AMOUNT*e.DRUGPRICE,0)) total_price_q1,
SUM(IF(MONTH(e.DATE_SERV) IN (10,11,12),e.AMOUNT*e.DRUGCOST,0)) total_cost_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) total_pt_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q2,
SUM(IF(MONTH(e.DATE_SERV) IN (1,2,3),e.AMOUNT,0)) total_amount_q2,
SUM(IF(MONTH(e.DATE_SERV) IN (1,2,3),e.AMOUNT*e.DRUGPRICE,0)) total_price_q2,
SUM(IF(MONTH(e.DATE_SERV) IN (1,2,3),e.AMOUNT*e.DRUGCOST,0)) total_cost_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) total_pt_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q3,
SUM(IF(MONTH(e.DATE_SERV) IN (4,5,6),e.AMOUNT,0)) total_amount_q3,
SUM(IF(MONTH(e.DATE_SERV) IN (4,5,6),e.AMOUNT*e.DRUGPRICE,0)) total_price_q3,
SUM(IF(MONTH(e.DATE_SERV) IN (4,5,6),e.AMOUNT*e.DRUGCOST,0)) total_cost_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) total_pt_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q4,
SUM(IF(MONTH(e.DATE_SERV) IN (7,8,9),e.AMOUNT,0)) total_amount_q4,
SUM(IF(MONTH(e.DATE_SERV) IN (7,8,9),e.AMOUNT*e.DRUGPRICE,0)) total_price_q4,
SUM(IF(MONTH(e.DATE_SERV) IN (7,8,9),e.AMOUNT*e.DRUGCOST,0)) total_cost_q4
FROM 
tmp_planthai_drug_use e
LEFT JOIN tmp_service s ON e.HOSPCODE = s.HOSPCODE AND e.PID = s.PID AND e.SEQ = s.SEQ 
GROUP BY e.HOSPCODE,IF(s.INSTYPE='0100','UC','OTHER'), e.DIDSTD ) e ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.HOSPCODE IS NOT NULL  AND e.didstd IS NOT NULL ;

 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.2778599;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:421;a:5:{i:0;s:34:"DROP PROCEDURE IF EXISTS t_ttm6_10";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.2778599;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:422;a:5:{i:0;s:34:"DROP PROCEDURE IF EXISTS t_ttm6_10";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.34026;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:424;a:5:{i:0;s:40399:"CREATE PROCEDURE t_ttm6_10()
 BEGIN 
SET @provid = '58';
SET@id:= '66';
SET @rep_year = (SELECT yearprocess FROM sys_config LIMIT 1);
/*************ttm6*************/
DROP TEMPORARY TABLE IF  EXISTS tmp_planthai_diag_clinic;
CREATE TEMPORARY TABLE IF NOT EXISTS 
tmp_planthai_diag_clinic (INDEX(HOSPCODE),INDEX(PID),INDEX(SEQ)) 
ENGINE=MYISAM IGNORE AS 
SELECT 
e.HOSPCODE, 
e.PID, 
e.SEQ, 
e.DATE_SERV, 
e.DIAGCODE
FROM 
tmp_diag_opd e 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND (e.DIAGCODE IN ('U5750', 'U5752', 'U5753', 'U5755', 'U5759', 'U7141', 'U7142', 'U610', 'U611', 'U6110', 'U6111', 'U6112', 'U6113', 'U6114', 'U6115', 'U6118', 'U6119', 'U612', 'U743', 'U5943')
OR e.DIAGCODE BETWEEN 'M17' AND 'M179'
OR e.DIAGCODE BETWEEN 'G81' AND 'G839'
OR e.DIAGCODE BETWEEN 'J301' AND 'J304'
OR e.DIAGCODE BETWEEN 'G43' AND 'G439')
;

DROP TEMPORARY TABLE IF  EXISTS tmp_planthai_diag_clinic_u;
CREATE TEMPORARY TABLE IF NOT EXISTS 
tmp_planthai_diag_clinic_u (INDEX(HOSPCODE),INDEX(PID),INDEX(SEQ)) 
ENGINE=MYISAM IGNORE AS 
SELECT 
e.HOSPCODE, 
e.PID, 
e.SEQ, 
e.DATE_SERV, 
e.DIAGCODE
FROM 
tmp_diag_opd e 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND e.DIAGCODE IN ('U5750', 'U5752', 'U5753', 'U5755', 'U5759', 'U7141', 'U7142', 'U610', 'U611', 'U6110', 'U6111', 'U6112', 'U6113', 'U6114', 'U6115', 'U6118', 'U6119', 'U612', 'U743', 'U5943')
;

DROP TABLE IF  EXISTS t_ttm_opd_6;
CREATE TABLE IF NOT EXISTS t_ttm_opd_6( 
PRIMARY KEY (hospcode,instype),
KEY (hospcode),
KEY (instype)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT SQL_BIG_RESULT 
e.HOSPCODE , 
IF(s.INSTYPE='0100','UC','OTHER') instype,
@rep_year year_rep,  

COUNT(DISTINCT IF(e.DIAGCODE='U5750' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u5750_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U5750' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u5750_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U5750' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u5750_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U5750' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u5750_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U5752' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u5752_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U5752' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u5752_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U5752' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u5752_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U5752' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u5752_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U5753' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u5753_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U5753' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u5753_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U5753' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u5753_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U5753' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u5753_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U5755' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u5755_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U5755' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u5755_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U5755' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u5755_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U5755' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u5755_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U5759' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u5759_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U5759' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u5759_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U5759' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u5759_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U5759' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u5759_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U7141' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u7141_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U7141' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u7141_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U7141' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u7141_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U7141' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u7141_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U7142' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u7142_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U7142' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u7142_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U7142' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u7142_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U7142' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u7142_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U612' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u612_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U612' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u612_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U612' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u612_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U612' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u612_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U743' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u743_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U743' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u743_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U743' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u743_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U743' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u743_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U5943' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u5943_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U5943' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u5943_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U5943' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u5943_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U5943' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u5943_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U610' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u610_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U610' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u610_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U610' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u610_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U610' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u610_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U611' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u611_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U611' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u611_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U611' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u611_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U611' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u611_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U6110' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u6110_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U6110' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u6110_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U6110' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u6110_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U6110' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u6110_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U6111' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u6111_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U6111' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u6111_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U6111' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u6111_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U6111' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u6111_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U6112' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u6112_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U6112' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u6112_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U6112' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u6112_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U6112' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u6112_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U6113' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u6113_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U6113' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u6113_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U6113' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u6113_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U6113' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u6113_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U6114' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u6114_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U6114' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u6114_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U6114' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u6114_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U6114' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u6114_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U6115' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u6115_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U6115' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u6115_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U6115' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u6115_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U6115' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u6115_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U6118' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u6118_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U6118' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u6118_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U6118' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u6118_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U6118' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u6118_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U6119' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u6119_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U6119' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u6119_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U6119' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u6119_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U6119' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u6119_q4,

COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'M17' AND 'M179' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) m179_q1,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'M17' AND 'M179' AND e2.DIAGCODE IN ('U5750', 'U5752', 'U5753', 'U5755', 'U5759', 'U7141', 'U7142') AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_m179_q1,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'M17' AND 'M179' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) m179_q2,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'M17' AND 'M179' AND e2.DIAGCODE IN ('U5750', 'U5752', 'U5753', 'U5755', 'U5759', 'U7141', 'U7142') AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_m179_q2,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'M17' AND 'M179' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) m179_q3,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'M17' AND 'M179' AND e2.DIAGCODE IN ('U5750', 'U5752', 'U5753', 'U5755', 'U5759', 'U7141', 'U7142') AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_m179_q3,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'M17' AND 'M179' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) m179_q4,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'M17' AND 'M179' AND e2.DIAGCODE IN ('U5750', 'U5752', 'U5753', 'U5755', 'U5759', 'U7141', 'U7142') AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_m179_q4,


COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G81' AND 'G839' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) g431_q1,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G81' AND 'G839' AND e2.DIAGCODE = 'U612' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_g431_q1,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G81' AND 'G839' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) g431_q2,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G81' AND 'G839' AND e2.DIAGCODE = 'U612' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_g431_q2,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G81' AND 'G839' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) g431_q3,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G81' AND 'G839' AND e2.DIAGCODE = 'U612' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_g431_q3,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G81' AND 'G839' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) g431_q4,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G81' AND 'G839' AND e2.DIAGCODE = 'U612' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_g431_q4,

COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'J301' AND 'J304' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) j304_q1,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'J301' AND 'J304' AND e2.DIAGCODE IN ('U743','UU5943') AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_j304_q1,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'J301' AND 'J304' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) j304_q2,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'J301' AND 'J304' AND e2.DIAGCODE IN ('U743','UU5943') AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_j304_q2,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'J301' AND 'J304' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) j304_q3,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'J301' AND 'J304' AND e2.DIAGCODE IN ('U743','UU5943') AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_j304_q3,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'J301' AND 'J304' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) j304_q4,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'J301' AND 'J304' AND e2.DIAGCODE IN ('U743','UU5943') AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_j304_q4,

COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G43' AND 'G439' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) g819_q1,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G43' AND 'G439' AND e2.DIAGCODE IN ('U610', 'U611', 'U6110', 'U6111', 'U6112', 'U6113', 'U6114', 'U6115', 'U6118', 'U6119') AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_g819_q1,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G43' AND 'G439' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) g819_q2,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G43' AND 'G439' AND e2.DIAGCODE IN ('U610', 'U611', 'U6110', 'U6111', 'U6112', 'U6113', 'U6114', 'U6115', 'U6118', 'U6119') AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_g819_q2,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G43' AND 'G439' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) g819_q3,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G43' AND 'G439' AND e2.DIAGCODE IN ('U610', 'U611', 'U6110', 'U6111', 'U6112', 'U6113', 'U6114', 'U6115', 'U6118', 'U6119') AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_g819_q3,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G43' AND 'G439' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) g819_q4,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G43' AND 'G439' AND e2.DIAGCODE IN ('U610', 'U611', 'U6110', 'U6111', 'U6112', 'U6113', 'U6114', 'U6115', 'U6118', 'U6119') AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_g819_q4
FROM 
tmp_planthai_diag_clinic e 
LEFT JOIN tmp_service s ON s.HOSPCODE = e.HOSPCODE AND s.PID = e.PID AND s.SEQ = e.SEQ 
LEFT JOIN tmp_planthai_diag_clinic_u e2 ON e.HOSPCODE = e2.HOSPCODE AND e.PID = e2.PID AND e.SEQ = e2.SEQ 
LEFT JOIN chospital o ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.HOSPCODE IS NOT NULL 
GROUP BY e.HOSPCODE, IF(s.INSTYPE='0100','UC','OTHER') ;

/****************ttm7*************/
DROP TABLE IF  EXISTS t_ttm_opd_7;
CREATE TABLE IF NOT EXISTS t_ttm_opd_7( 
PRIMARY KEY (hospcode,code_rep),
KEY (hospcode),
KEY (code_rep),
KEY (code_name)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS

SELECT SQL_BIG_RESULT
e.HOSPCODE ,
LEFT(DATE(e.DATE_SERV),7) code_rep,
IF(MONTH(e.DATE_SERV)=1,'มกราคม',
IF(MONTH(e.DATE_SERV)=2,'กุมภาพันธ์',
IF(MONTH(e.DATE_SERV)=3,'มีนาคม',
IF(MONTH(e.DATE_SERV)=4,'เมษายน',
IF(MONTH(e.DATE_SERV)=5,'พฤษภาคม',
IF(MONTH(e.DATE_SERV)=6,'มิถุนายน',
IF(MONTH(e.DATE_SERV)=7,'กรกฏาคม',
IF(MONTH(e.DATE_SERV)=8,'สิงหาคม',
IF(MONTH(e.DATE_SERV)=9,'กันยายน',
IF(MONTH(e.DATE_SERV)=10,'ตุลาคม',
IF(MONTH(e.DATE_SERV)=11,'พฤศจิกายน',
'ธันวาคม'))))))))))) code_name,
@rep_year year_rep,
SUM(IF(LEFT(e.DIDSTD,2) <> '41' AND LEFT(e.DIDSTD,2) <> '42',e.AMOUNT*e.DRUGPRICE,0))  price_drug ,
SUM(IF(LEFT(e.DIDSTD,2) = '41' OR LEFT(e.DIDSTD,2) = '42',e.AMOUNT*e.DRUGPRICE,0))  price_planthai_drug
FROM 
tmp_drug_opd e 
LEFT JOIN chospital i ON e.HOSPCODE = i.hoscode 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930')  AND i.provcode=@provid 
GROUP BY e.HOSPCODE, MONTH(e.DATE_SERV);

/*************ttm8*****************/
DROP TEMPORARY TABLE IF  EXISTS tmp_planthai_procedure;
CREATE TEMPORARY TABLE IF NOT EXISTS 
tmp_planthai_procedure (INDEX(HOSPCODE),INDEX(PID),INDEX(SEQ)) 
ENGINE=MYISAM IGNORE AS 
SELECT 
e.HOSPCODE, 
e.PID, 
e.SEQ, 
e.DATE_SERV, 
e.PROCEDCODE, 
icd.tmtype 
FROM 
tmp_procedure_opd e 
LEFT JOIN cicd9ttm_planthai icd ON icd.`code` = e.PROCEDCODE 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND icd.`code`IS NOT NULL 
;

DROP TABLE IF  EXISTS t_ttm_opd_8;
CREATE TABLE IF NOT EXISTS t_ttm_opd_8( 
PRIMARY KEY (hospcode,instype),
KEY (hospcode),
KEY (instype)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
e.HOSPCODE ,
IF(e.INSTYPE='0100','UC','OTHER') instype,
IFNULL(e.year_rep,@rep_year) year_rep,

IFNULL(e.pt_nod_q1,0) pt_nod_q1,
IFNULL(e.service_nod_q1,0) service_nod_q1,
IFNULL(e.pt_obb_q1,0) pt_obb_q1,
IFNULL(e.service_obb_q1,0) service_obb_q1,
IFNULL(e.pt_cop_q1,0) pt_cop_q1,
IFNULL(e.service_cop_q1,0) service_cop_q1,
IFNULL(e.pt_other_q1,0) pt_other_q1,
IFNULL(e.service_other_q1,0) service_other_q1,
IFNULL(e.pt_total_q1,0) pt_total_q1,
IFNULL(e.service_total_q1,0) service_total_q1,

IFNULL(e.out_pt_nod_q1,0) out_pt_nod_q1,
IFNULL(e.out_service_nod_q1,0) out_service_nod_q1,
IFNULL(e.out_pt_obb_q1,0) out_pt_obb_q1,
IFNULL(e.out_service_obb_q1,0) out_service_obb_q1,
IFNULL(e.out_pt_cop_q1,0) out_pt_cop_q1,
IFNULL(e.out_service_cop_q1,0) out_service_cop_q1,
IFNULL(e.out_pt_other_q1,0) out_pt_other_q1,
IFNULL(e.out_service_other_q1,0) out_service_other_q1,
IFNULL(e.out_pt_total_q1,0) out_pt_total_q1,
IFNULL(e.out_service_total_q1,0) out_service_total_q1,

IFNULL(e.pt_nod_q2,0) pt_nod_q2,
IFNULL(e.service_nod_q2,0) service_nod_q2,
IFNULL(e.pt_obb_q2,0) pt_obb_q2,
IFNULL(e.service_obb_q2,0) service_obb_q2,
IFNULL(e.pt_cop_q2,0) pt_cop_q2,
IFNULL(e.service_cop_q2,0) service_cop_q2,
IFNULL(e.pt_other_q2,0) pt_other_q2,
IFNULL(e.service_other_q2,0) service_other_q2,
IFNULL(e.pt_total_q2,0) pt_total_q2,
IFNULL(e.service_total_q2,0) service_total_q2,

IFNULL(e.out_pt_nod_q2,0) out_pt_nod_q2,
IFNULL(e.out_service_nod_q2,0) out_service_nod_q2,
IFNULL(e.out_pt_obb_q2,0) out_pt_obb_q2,
IFNULL(e.out_service_obb_q2,0) out_service_obb_q2,
IFNULL(e.out_pt_cop_q2,0) out_pt_cop_q2,
IFNULL(e.out_service_cop_q2,0) out_service_cop_q2,
IFNULL(e.out_pt_other_q2,0) out_pt_other_q2,
IFNULL(e.out_service_other_q2,0) out_service_other_q2,
IFNULL(e.out_pt_total_q2,0) out_pt_total_q2,
IFNULL(e.out_service_total_q2,0) out_service_total_q2,

IFNULL(e.pt_nod_q3,0) pt_nod_q3,
IFNULL(e.service_nod_q3,0) service_nod_q3,
IFNULL(e.pt_obb_q3,0) pt_obb_q3,
IFNULL(e.service_obb_q3,0) service_obb_q3,
IFNULL(e.pt_cop_q3,0) pt_cop_q3,
IFNULL(e.service_cop_q3,0) service_cop_q3,
IFNULL(e.pt_other_q3,0) pt_other_q3,
IFNULL(e.service_other_q3,0) service_other_q3,
IFNULL(e.pt_total_q3,0) pt_total_q3,
IFNULL(e.service_total_q3,0) service_total_q3,

IFNULL(e.out_pt_nod_q3,0) out_pt_nod_q3,
IFNULL(e.out_service_nod_q3,0) out_service_nod_q3,
IFNULL(e.out_pt_obb_q3,0) out_pt_obb_q3,
IFNULL(e.out_service_obb_q3,0) out_service_obb_q3,
IFNULL(e.out_pt_cop_q3,0) out_pt_cop_q3,
IFNULL(e.out_service_cop_q3,0) out_service_cop_q3,
IFNULL(e.out_pt_other_q3,0) out_pt_other_q3,
IFNULL(e.out_service_other_q3,0) out_service_other_q3,
IFNULL(e.out_pt_total_q3,0) out_pt_total_q3,
IFNULL(e.out_service_total_q3,0) out_service_total_q3,

IFNULL(e.pt_nod_q4,0) pt_nod_q4,
IFNULL(e.service_nod_q4,0) service_nod_q4,
IFNULL(e.pt_obb_q4,0) pt_obb_q4,
IFNULL(e.service_obb_q4,0) service_obb_q4,
IFNULL(e.pt_cop_q4,0) pt_cop_q4,
IFNULL(e.service_cop_q4,0) service_cop_q4,
IFNULL(e.pt_other_q4,0) pt_other_q4,
IFNULL(e.service_other_q4,0) service_other_q4,
IFNULL(e.pt_total_q4,0) pt_total_q4,
IFNULL(e.service_total_q4,0) service_total_q4,

IFNULL(e.out_pt_nod_q4,0) out_pt_nod_q4,
IFNULL(e.out_service_nod_q4,0) out_service_nod_q4,
IFNULL(e.out_pt_obb_q4,0) out_pt_obb_q4,
IFNULL(e.out_service_obb_q4,0) out_service_obb_q4,
IFNULL(e.out_pt_cop_q4,0) out_pt_cop_q4,
IFNULL(e.out_service_cop_q4,0) out_service_cop_q4,
IFNULL(e.out_pt_other_q4,0) out_pt_other_q4,
IFNULL(e.out_service_other_q4,0) out_service_other_q4,
IFNULL(e.out_pt_total_q4,0) out_pt_total_q4,
IFNULL(e.out_service_total_q4,0) out_service_total_q4
FROM chospital o
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE, 
s.INSTYPE,
s.SERVPLACE,
@rep_year year_rep,  

COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) pt_nod_q1,
COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) service_nod_q1,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) pt_obb_q1,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) service_obb_q1,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) pt_cop_q1,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) service_cop_q1,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) pt_other_q1,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) service_other_q1,
COUNT(DISTINCT IF(s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) pt_total_q1,
COUNT(DISTINCT IF(s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) service_total_q1,

COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) out_pt_nod_q1,
COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_nod_q1,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) out_pt_obb_q1,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_obb_q1,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) out_pt_cop_q1,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_cop_q1,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) out_pt_other_q1,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_other_q1,
COUNT(DISTINCT IF(s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) out_pt_total_q1,
COUNT(DISTINCT IF(s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_total_q1,

COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) pt_nod_q2,
COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) service_nod_q2,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) pt_obb_q2,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) service_obb_q2,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) pt_cop_q2,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) service_cop_q2,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) pt_other_q2,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) service_other_q2,
COUNT(DISTINCT IF(s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) pt_total_q2,
COUNT(DISTINCT IF(s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) service_total_q2,

COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) out_pt_nod_q2,
COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_nod_q2,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) out_pt_obb_q2,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_obb_q2,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) out_pt_cop_q2,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_cop_q2,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) out_pt_other_q2,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_other_q2,
COUNT(DISTINCT IF(s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) out_pt_total_q2,
COUNT(DISTINCT IF(s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_total_q2,

COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) pt_nod_q3,
COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) service_nod_q3,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) pt_obb_q3,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) service_obb_q3,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) pt_cop_q3,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) service_cop_q3,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) pt_other_q3,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) service_other_q3,
COUNT(DISTINCT IF(s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) pt_total_q3,
COUNT(DISTINCT IF(s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) service_total_q3,

COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) out_pt_nod_q3,
COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_nod_q3,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) out_pt_obb_q3,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_obb_q3,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) out_pt_cop_q3,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_cop_q3,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) out_pt_other_q3,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_other_q3,
COUNT(DISTINCT IF(s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) out_pt_total_q3,
COUNT(DISTINCT IF(s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_total_q3,

COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) pt_nod_q4,
COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) service_nod_q4,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) pt_obb_q4,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) service_obb_q4,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) pt_cop_q4,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) service_cop_q4,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) pt_other_q4,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) service_other_q4,
COUNT(DISTINCT IF(s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) pt_total_q4,
COUNT(DISTINCT IF(s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) service_total_q4,

COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) out_pt_nod_q4,
COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_nod_q4,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) out_pt_obb_q4,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_obb_q4,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) out_pt_cop_q4,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_cop_q4,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) out_pt_other_q4,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_other_q4,
COUNT(DISTINCT IF(s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) out_pt_total_q4,
COUNT(DISTINCT IF(s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_total_q4,
NOW() 
FROM 
tmp_planthai_procedure e 
LEFT JOIN tmp_service s ON s.HOSPCODE = e.HOSPCODE AND s.PID = e.PID AND s.SEQ = e.SEQ 
WHERE s.SERVPLACE IN ('1','2') 
GROUP BY e.HOSPCODE,  IF(s.INSTYPE='0100','UC','OTHER') 
) e ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.HOSPCODE IS NOT NULL ;

/*********************ttm9**************************/
DROP TEMPORARY TABLE IF  EXISTS tmp_planthai_diag_u;
CREATE TEMPORARY TABLE IF NOT EXISTS 
tmp_planthai_diag_u (INDEX(HOSPCODE),INDEX(PID),INDEX(SEQ)) 
ENGINE=MYISAM IGNORE AS 
SELECT 
e.HOSPCODE, 
e.PID, 
e.SEQ, 
e.DATE_SERV, 
e.DIAGCODE, 
d.SEQ DRUG ,
TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'1001')) age,
p.SEX 
FROM 
tmp_diag_opd e 
LEFT JOIN person p ON e.HOSPCODE = p.HOSPCODE AND e.PID = p.PID 
LEFT JOIN tmp_drug_opd d ON d.HOSPCODE = e.HOSPCODE AND d.PID = e.PID AND d.SEQ = e.SEQ AND LEFT(d.DIDSTD,2) IN ('41','42') 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIAGCODE,1) = 'U' AND LEFT(e.DIAGCODE,3)<>'U77' 
;

DROP TABLE IF  EXISTS t_ttm_opd_9;
CREATE TABLE IF NOT EXISTS t_ttm_opd_9( 
PRIMARY KEY (hospcode,instype,diagcode,age,sex),
KEY (hospcode),
KEY (instype),
KEY (diagcode),
KEY (age),
KEY (sex)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS

SELECT 
e.HOSPCODE ,
IF(e.INSTYPE='0100','UC','OTHER') instype,
e.DIAGCODE diagcode,
e.diseasename,
IFNULL(e.year_rep,@rep_year) year_rep,
IFNULL(e.age,0) age,
e.sex,

IFNULL(e.total_pt_q1,0) total_pt_q1,	
IFNULL(e.total_q1,0) total_q1,

IFNULL(e.total_pt_q2,0) total_pt_q2,	
IFNULL(e.total_q2,0) total_q2,

IFNULL(e.total_pt_q3,0) total_pt_q3,	
IFNULL(e.total_q3,0) total_q3,

IFNULL(e.total_pt_q4,0) total_pt_q4,	
IFNULL(e.total_q4,0) total_q4,
IFNULL(e.total_drug,0) total_drug
FROM chospital o
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE, 
s.INSTYPE,
e.DIAGCODE,
IFNULL(d.diseasethai,e.DIAGCODE) diseasename,
@rep_year year_rep,  
e.age age,
e.SEX sex,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) total_pt_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q1,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) total_pt_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q2,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) total_pt_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q3,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) total_pt_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q4,

COUNT(DISTINCT e.DRUG) total_drug
FROM 
tmp_planthai_diag_u e 
LEFT JOIN tmp_service s ON s.HOSPCODE = e.HOSPCODE AND s.PID = e.PID AND s.SEQ = e.SEQ 
LEFT JOIN cdisease d ON d.diagcode = e.DIAGCODE 
WHERE e.SEX IN (1,2)
GROUP BY e.HOSPCODE, IF(s.INSTYPE='0100','UC','OTHER'), e.DIAGCODE , e.age , e.SEX 
) e ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.HOSPCODE IS NOT NULL ;

/***********************ttm10******************/
DROP TABLE IF  EXISTS t_ttm_opd_10;
CREATE TABLE IF NOT EXISTS t_ttm_opd_10( 
PRIMARY KEY (hospcode,instype),
KEY (hospcode),
KEY (instype)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS

SELECT SQL_BIG_RESULT 
e.HOSPCODE ,
IF(s.INSTYPE='0100','UC','OTHER') instype,
@rep_year year_rep,

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) ed_pt_q1,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) non_ed_pt_q1,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) other_pt_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) total_pt_q1,	

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) ed_q1,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) non_ed_q1,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) other_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q1,	

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) ed_pt_q2,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) non_ed_pt_q2,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) other_pt_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) total_pt_q2,	

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) ed_q2,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) non_ed_q2,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) other_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q2,	

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) ed_pt_q3,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) non_ed_pt_q3,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) other_pt_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) total_pt_q3,	

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) ed_q3,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) non_ed_q3,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) other_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q3,	
 
COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) ed_pt_q4,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) non_ed_pt_q4,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) other_pt_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) total_pt_q4,	

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) ed_q4,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) non_ed_q4,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) other_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q4 
FROM 
tmp_planthai_drug_use e
LEFT JOIN tmp_service s ON e.HOSPCODE = s.HOSPCODE AND e.PID = s.PID AND e.SEQ = s.SEQ 
LEFT JOIN chospital o ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.HOSPCODE IS NOT NULL  AND e.DIDSTD IS NOT NULL 
GROUP BY e.HOSPCODE, IF(s.INSTYPE='0100','UC','OTHER');


 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.34026;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:425;a:5:{i:0;s:40399:"CREATE PROCEDURE t_ttm6_10()
 BEGIN 
SET @provid = '58';
SET@id:= '66';
SET @rep_year = (SELECT yearprocess FROM sys_config LIMIT 1);
/*************ttm6*************/
DROP TEMPORARY TABLE IF  EXISTS tmp_planthai_diag_clinic;
CREATE TEMPORARY TABLE IF NOT EXISTS 
tmp_planthai_diag_clinic (INDEX(HOSPCODE),INDEX(PID),INDEX(SEQ)) 
ENGINE=MYISAM IGNORE AS 
SELECT 
e.HOSPCODE, 
e.PID, 
e.SEQ, 
e.DATE_SERV, 
e.DIAGCODE
FROM 
tmp_diag_opd e 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND (e.DIAGCODE IN ('U5750', 'U5752', 'U5753', 'U5755', 'U5759', 'U7141', 'U7142', 'U610', 'U611', 'U6110', 'U6111', 'U6112', 'U6113', 'U6114', 'U6115', 'U6118', 'U6119', 'U612', 'U743', 'U5943')
OR e.DIAGCODE BETWEEN 'M17' AND 'M179'
OR e.DIAGCODE BETWEEN 'G81' AND 'G839'
OR e.DIAGCODE BETWEEN 'J301' AND 'J304'
OR e.DIAGCODE BETWEEN 'G43' AND 'G439')
;

DROP TEMPORARY TABLE IF  EXISTS tmp_planthai_diag_clinic_u;
CREATE TEMPORARY TABLE IF NOT EXISTS 
tmp_planthai_diag_clinic_u (INDEX(HOSPCODE),INDEX(PID),INDEX(SEQ)) 
ENGINE=MYISAM IGNORE AS 
SELECT 
e.HOSPCODE, 
e.PID, 
e.SEQ, 
e.DATE_SERV, 
e.DIAGCODE
FROM 
tmp_diag_opd e 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND e.DIAGCODE IN ('U5750', 'U5752', 'U5753', 'U5755', 'U5759', 'U7141', 'U7142', 'U610', 'U611', 'U6110', 'U6111', 'U6112', 'U6113', 'U6114', 'U6115', 'U6118', 'U6119', 'U612', 'U743', 'U5943')
;

DROP TABLE IF  EXISTS t_ttm_opd_6;
CREATE TABLE IF NOT EXISTS t_ttm_opd_6( 
PRIMARY KEY (hospcode,instype),
KEY (hospcode),
KEY (instype)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT SQL_BIG_RESULT 
e.HOSPCODE , 
IF(s.INSTYPE='0100','UC','OTHER') instype,
@rep_year year_rep,  

COUNT(DISTINCT IF(e.DIAGCODE='U5750' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u5750_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U5750' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u5750_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U5750' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u5750_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U5750' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u5750_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U5752' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u5752_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U5752' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u5752_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U5752' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u5752_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U5752' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u5752_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U5753' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u5753_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U5753' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u5753_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U5753' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u5753_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U5753' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u5753_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U5755' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u5755_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U5755' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u5755_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U5755' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u5755_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U5755' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u5755_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U5759' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u5759_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U5759' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u5759_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U5759' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u5759_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U5759' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u5759_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U7141' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u7141_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U7141' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u7141_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U7141' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u7141_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U7141' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u7141_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U7142' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u7142_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U7142' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u7142_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U7142' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u7142_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U7142' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u7142_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U612' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u612_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U612' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u612_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U612' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u612_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U612' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u612_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U743' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u743_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U743' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u743_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U743' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u743_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U743' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u743_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U5943' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u5943_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U5943' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u5943_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U5943' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u5943_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U5943' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u5943_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U610' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u610_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U610' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u610_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U610' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u610_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U610' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u610_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U611' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u611_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U611' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u611_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U611' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u611_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U611' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u611_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U6110' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u6110_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U6110' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u6110_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U6110' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u6110_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U6110' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u6110_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U6111' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u6111_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U6111' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u6111_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U6111' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u6111_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U6111' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u6111_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U6112' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u6112_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U6112' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u6112_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U6112' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u6112_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U6112' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u6112_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U6113' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u6113_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U6113' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u6113_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U6113' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u6113_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U6113' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u6113_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U6114' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u6114_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U6114' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u6114_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U6114' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u6114_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U6114' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u6114_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U6115' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u6115_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U6115' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u6115_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U6115' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u6115_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U6115' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u6115_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U6118' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u6118_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U6118' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u6118_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U6118' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u6118_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U6118' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u6118_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U6119' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u6119_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U6119' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u6119_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U6119' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u6119_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U6119' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u6119_q4,

COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'M17' AND 'M179' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) m179_q1,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'M17' AND 'M179' AND e2.DIAGCODE IN ('U5750', 'U5752', 'U5753', 'U5755', 'U5759', 'U7141', 'U7142') AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_m179_q1,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'M17' AND 'M179' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) m179_q2,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'M17' AND 'M179' AND e2.DIAGCODE IN ('U5750', 'U5752', 'U5753', 'U5755', 'U5759', 'U7141', 'U7142') AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_m179_q2,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'M17' AND 'M179' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) m179_q3,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'M17' AND 'M179' AND e2.DIAGCODE IN ('U5750', 'U5752', 'U5753', 'U5755', 'U5759', 'U7141', 'U7142') AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_m179_q3,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'M17' AND 'M179' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) m179_q4,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'M17' AND 'M179' AND e2.DIAGCODE IN ('U5750', 'U5752', 'U5753', 'U5755', 'U5759', 'U7141', 'U7142') AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_m179_q4,


COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G81' AND 'G839' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) g431_q1,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G81' AND 'G839' AND e2.DIAGCODE = 'U612' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_g431_q1,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G81' AND 'G839' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) g431_q2,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G81' AND 'G839' AND e2.DIAGCODE = 'U612' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_g431_q2,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G81' AND 'G839' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) g431_q3,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G81' AND 'G839' AND e2.DIAGCODE = 'U612' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_g431_q3,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G81' AND 'G839' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) g431_q4,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G81' AND 'G839' AND e2.DIAGCODE = 'U612' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_g431_q4,

COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'J301' AND 'J304' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) j304_q1,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'J301' AND 'J304' AND e2.DIAGCODE IN ('U743','UU5943') AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_j304_q1,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'J301' AND 'J304' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) j304_q2,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'J301' AND 'J304' AND e2.DIAGCODE IN ('U743','UU5943') AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_j304_q2,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'J301' AND 'J304' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) j304_q3,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'J301' AND 'J304' AND e2.DIAGCODE IN ('U743','UU5943') AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_j304_q3,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'J301' AND 'J304' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) j304_q4,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'J301' AND 'J304' AND e2.DIAGCODE IN ('U743','UU5943') AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_j304_q4,

COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G43' AND 'G439' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) g819_q1,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G43' AND 'G439' AND e2.DIAGCODE IN ('U610', 'U611', 'U6110', 'U6111', 'U6112', 'U6113', 'U6114', 'U6115', 'U6118', 'U6119') AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_g819_q1,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G43' AND 'G439' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) g819_q2,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G43' AND 'G439' AND e2.DIAGCODE IN ('U610', 'U611', 'U6110', 'U6111', 'U6112', 'U6113', 'U6114', 'U6115', 'U6118', 'U6119') AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_g819_q2,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G43' AND 'G439' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) g819_q3,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G43' AND 'G439' AND e2.DIAGCODE IN ('U610', 'U611', 'U6110', 'U6111', 'U6112', 'U6113', 'U6114', 'U6115', 'U6118', 'U6119') AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_g819_q3,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G43' AND 'G439' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) g819_q4,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G43' AND 'G439' AND e2.DIAGCODE IN ('U610', 'U611', 'U6110', 'U6111', 'U6112', 'U6113', 'U6114', 'U6115', 'U6118', 'U6119') AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_g819_q4
FROM 
tmp_planthai_diag_clinic e 
LEFT JOIN tmp_service s ON s.HOSPCODE = e.HOSPCODE AND s.PID = e.PID AND s.SEQ = e.SEQ 
LEFT JOIN tmp_planthai_diag_clinic_u e2 ON e.HOSPCODE = e2.HOSPCODE AND e.PID = e2.PID AND e.SEQ = e2.SEQ 
LEFT JOIN chospital o ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.HOSPCODE IS NOT NULL 
GROUP BY e.HOSPCODE, IF(s.INSTYPE='0100','UC','OTHER') ;

/****************ttm7*************/
DROP TABLE IF  EXISTS t_ttm_opd_7;
CREATE TABLE IF NOT EXISTS t_ttm_opd_7( 
PRIMARY KEY (hospcode,code_rep),
KEY (hospcode),
KEY (code_rep),
KEY (code_name)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS

SELECT SQL_BIG_RESULT
e.HOSPCODE ,
LEFT(DATE(e.DATE_SERV),7) code_rep,
IF(MONTH(e.DATE_SERV)=1,'มกราคม',
IF(MONTH(e.DATE_SERV)=2,'กุมภาพันธ์',
IF(MONTH(e.DATE_SERV)=3,'มีนาคม',
IF(MONTH(e.DATE_SERV)=4,'เมษายน',
IF(MONTH(e.DATE_SERV)=5,'พฤษภาคม',
IF(MONTH(e.DATE_SERV)=6,'มิถุนายน',
IF(MONTH(e.DATE_SERV)=7,'กรกฏาคม',
IF(MONTH(e.DATE_SERV)=8,'สิงหาคม',
IF(MONTH(e.DATE_SERV)=9,'กันยายน',
IF(MONTH(e.DATE_SERV)=10,'ตุลาคม',
IF(MONTH(e.DATE_SERV)=11,'พฤศจิกายน',
'ธันวาคม'))))))))))) code_name,
@rep_year year_rep,
SUM(IF(LEFT(e.DIDSTD,2) <> '41' AND LEFT(e.DIDSTD,2) <> '42',e.AMOUNT*e.DRUGPRICE,0))  price_drug ,
SUM(IF(LEFT(e.DIDSTD,2) = '41' OR LEFT(e.DIDSTD,2) = '42',e.AMOUNT*e.DRUGPRICE,0))  price_planthai_drug
FROM 
tmp_drug_opd e 
LEFT JOIN chospital i ON e.HOSPCODE = i.hoscode 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930')  AND i.provcode=@provid 
GROUP BY e.HOSPCODE, MONTH(e.DATE_SERV);

/*************ttm8*****************/
DROP TEMPORARY TABLE IF  EXISTS tmp_planthai_procedure;
CREATE TEMPORARY TABLE IF NOT EXISTS 
tmp_planthai_procedure (INDEX(HOSPCODE),INDEX(PID),INDEX(SEQ)) 
ENGINE=MYISAM IGNORE AS 
SELECT 
e.HOSPCODE, 
e.PID, 
e.SEQ, 
e.DATE_SERV, 
e.PROCEDCODE, 
icd.tmtype 
FROM 
tmp_procedure_opd e 
LEFT JOIN cicd9ttm_planthai icd ON icd.`code` = e.PROCEDCODE 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND icd.`code`IS NOT NULL 
;

DROP TABLE IF  EXISTS t_ttm_opd_8;
CREATE TABLE IF NOT EXISTS t_ttm_opd_8( 
PRIMARY KEY (hospcode,instype),
KEY (hospcode),
KEY (instype)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
e.HOSPCODE ,
IF(e.INSTYPE='0100','UC','OTHER') instype,
IFNULL(e.year_rep,@rep_year) year_rep,

IFNULL(e.pt_nod_q1,0) pt_nod_q1,
IFNULL(e.service_nod_q1,0) service_nod_q1,
IFNULL(e.pt_obb_q1,0) pt_obb_q1,
IFNULL(e.service_obb_q1,0) service_obb_q1,
IFNULL(e.pt_cop_q1,0) pt_cop_q1,
IFNULL(e.service_cop_q1,0) service_cop_q1,
IFNULL(e.pt_other_q1,0) pt_other_q1,
IFNULL(e.service_other_q1,0) service_other_q1,
IFNULL(e.pt_total_q1,0) pt_total_q1,
IFNULL(e.service_total_q1,0) service_total_q1,

IFNULL(e.out_pt_nod_q1,0) out_pt_nod_q1,
IFNULL(e.out_service_nod_q1,0) out_service_nod_q1,
IFNULL(e.out_pt_obb_q1,0) out_pt_obb_q1,
IFNULL(e.out_service_obb_q1,0) out_service_obb_q1,
IFNULL(e.out_pt_cop_q1,0) out_pt_cop_q1,
IFNULL(e.out_service_cop_q1,0) out_service_cop_q1,
IFNULL(e.out_pt_other_q1,0) out_pt_other_q1,
IFNULL(e.out_service_other_q1,0) out_service_other_q1,
IFNULL(e.out_pt_total_q1,0) out_pt_total_q1,
IFNULL(e.out_service_total_q1,0) out_service_total_q1,

IFNULL(e.pt_nod_q2,0) pt_nod_q2,
IFNULL(e.service_nod_q2,0) service_nod_q2,
IFNULL(e.pt_obb_q2,0) pt_obb_q2,
IFNULL(e.service_obb_q2,0) service_obb_q2,
IFNULL(e.pt_cop_q2,0) pt_cop_q2,
IFNULL(e.service_cop_q2,0) service_cop_q2,
IFNULL(e.pt_other_q2,0) pt_other_q2,
IFNULL(e.service_other_q2,0) service_other_q2,
IFNULL(e.pt_total_q2,0) pt_total_q2,
IFNULL(e.service_total_q2,0) service_total_q2,

IFNULL(e.out_pt_nod_q2,0) out_pt_nod_q2,
IFNULL(e.out_service_nod_q2,0) out_service_nod_q2,
IFNULL(e.out_pt_obb_q2,0) out_pt_obb_q2,
IFNULL(e.out_service_obb_q2,0) out_service_obb_q2,
IFNULL(e.out_pt_cop_q2,0) out_pt_cop_q2,
IFNULL(e.out_service_cop_q2,0) out_service_cop_q2,
IFNULL(e.out_pt_other_q2,0) out_pt_other_q2,
IFNULL(e.out_service_other_q2,0) out_service_other_q2,
IFNULL(e.out_pt_total_q2,0) out_pt_total_q2,
IFNULL(e.out_service_total_q2,0) out_service_total_q2,

IFNULL(e.pt_nod_q3,0) pt_nod_q3,
IFNULL(e.service_nod_q3,0) service_nod_q3,
IFNULL(e.pt_obb_q3,0) pt_obb_q3,
IFNULL(e.service_obb_q3,0) service_obb_q3,
IFNULL(e.pt_cop_q3,0) pt_cop_q3,
IFNULL(e.service_cop_q3,0) service_cop_q3,
IFNULL(e.pt_other_q3,0) pt_other_q3,
IFNULL(e.service_other_q3,0) service_other_q3,
IFNULL(e.pt_total_q3,0) pt_total_q3,
IFNULL(e.service_total_q3,0) service_total_q3,

IFNULL(e.out_pt_nod_q3,0) out_pt_nod_q3,
IFNULL(e.out_service_nod_q3,0) out_service_nod_q3,
IFNULL(e.out_pt_obb_q3,0) out_pt_obb_q3,
IFNULL(e.out_service_obb_q3,0) out_service_obb_q3,
IFNULL(e.out_pt_cop_q3,0) out_pt_cop_q3,
IFNULL(e.out_service_cop_q3,0) out_service_cop_q3,
IFNULL(e.out_pt_other_q3,0) out_pt_other_q3,
IFNULL(e.out_service_other_q3,0) out_service_other_q3,
IFNULL(e.out_pt_total_q3,0) out_pt_total_q3,
IFNULL(e.out_service_total_q3,0) out_service_total_q3,

IFNULL(e.pt_nod_q4,0) pt_nod_q4,
IFNULL(e.service_nod_q4,0) service_nod_q4,
IFNULL(e.pt_obb_q4,0) pt_obb_q4,
IFNULL(e.service_obb_q4,0) service_obb_q4,
IFNULL(e.pt_cop_q4,0) pt_cop_q4,
IFNULL(e.service_cop_q4,0) service_cop_q4,
IFNULL(e.pt_other_q4,0) pt_other_q4,
IFNULL(e.service_other_q4,0) service_other_q4,
IFNULL(e.pt_total_q4,0) pt_total_q4,
IFNULL(e.service_total_q4,0) service_total_q4,

IFNULL(e.out_pt_nod_q4,0) out_pt_nod_q4,
IFNULL(e.out_service_nod_q4,0) out_service_nod_q4,
IFNULL(e.out_pt_obb_q4,0) out_pt_obb_q4,
IFNULL(e.out_service_obb_q4,0) out_service_obb_q4,
IFNULL(e.out_pt_cop_q4,0) out_pt_cop_q4,
IFNULL(e.out_service_cop_q4,0) out_service_cop_q4,
IFNULL(e.out_pt_other_q4,0) out_pt_other_q4,
IFNULL(e.out_service_other_q4,0) out_service_other_q4,
IFNULL(e.out_pt_total_q4,0) out_pt_total_q4,
IFNULL(e.out_service_total_q4,0) out_service_total_q4
FROM chospital o
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE, 
s.INSTYPE,
s.SERVPLACE,
@rep_year year_rep,  

COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) pt_nod_q1,
COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) service_nod_q1,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) pt_obb_q1,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) service_obb_q1,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) pt_cop_q1,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) service_cop_q1,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) pt_other_q1,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) service_other_q1,
COUNT(DISTINCT IF(s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) pt_total_q1,
COUNT(DISTINCT IF(s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) service_total_q1,

COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) out_pt_nod_q1,
COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_nod_q1,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) out_pt_obb_q1,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_obb_q1,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) out_pt_cop_q1,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_cop_q1,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) out_pt_other_q1,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_other_q1,
COUNT(DISTINCT IF(s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) out_pt_total_q1,
COUNT(DISTINCT IF(s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_total_q1,

COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) pt_nod_q2,
COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) service_nod_q2,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) pt_obb_q2,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) service_obb_q2,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) pt_cop_q2,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) service_cop_q2,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) pt_other_q2,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) service_other_q2,
COUNT(DISTINCT IF(s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) pt_total_q2,
COUNT(DISTINCT IF(s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) service_total_q2,

COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) out_pt_nod_q2,
COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_nod_q2,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) out_pt_obb_q2,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_obb_q2,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) out_pt_cop_q2,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_cop_q2,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) out_pt_other_q2,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_other_q2,
COUNT(DISTINCT IF(s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) out_pt_total_q2,
COUNT(DISTINCT IF(s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_total_q2,

COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) pt_nod_q3,
COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) service_nod_q3,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) pt_obb_q3,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) service_obb_q3,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) pt_cop_q3,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) service_cop_q3,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) pt_other_q3,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) service_other_q3,
COUNT(DISTINCT IF(s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) pt_total_q3,
COUNT(DISTINCT IF(s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) service_total_q3,

COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) out_pt_nod_q3,
COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_nod_q3,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) out_pt_obb_q3,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_obb_q3,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) out_pt_cop_q3,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_cop_q3,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) out_pt_other_q3,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_other_q3,
COUNT(DISTINCT IF(s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) out_pt_total_q3,
COUNT(DISTINCT IF(s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_total_q3,

COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) pt_nod_q4,
COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) service_nod_q4,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) pt_obb_q4,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) service_obb_q4,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) pt_cop_q4,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) service_cop_q4,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) pt_other_q4,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) service_other_q4,
COUNT(DISTINCT IF(s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) pt_total_q4,
COUNT(DISTINCT IF(s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) service_total_q4,

COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) out_pt_nod_q4,
COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_nod_q4,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) out_pt_obb_q4,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_obb_q4,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) out_pt_cop_q4,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_cop_q4,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) out_pt_other_q4,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_other_q4,
COUNT(DISTINCT IF(s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) out_pt_total_q4,
COUNT(DISTINCT IF(s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_total_q4,
NOW() 
FROM 
tmp_planthai_procedure e 
LEFT JOIN tmp_service s ON s.HOSPCODE = e.HOSPCODE AND s.PID = e.PID AND s.SEQ = e.SEQ 
WHERE s.SERVPLACE IN ('1','2') 
GROUP BY e.HOSPCODE,  IF(s.INSTYPE='0100','UC','OTHER') 
) e ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.HOSPCODE IS NOT NULL ;

/*********************ttm9**************************/
DROP TEMPORARY TABLE IF  EXISTS tmp_planthai_diag_u;
CREATE TEMPORARY TABLE IF NOT EXISTS 
tmp_planthai_diag_u (INDEX(HOSPCODE),INDEX(PID),INDEX(SEQ)) 
ENGINE=MYISAM IGNORE AS 
SELECT 
e.HOSPCODE, 
e.PID, 
e.SEQ, 
e.DATE_SERV, 
e.DIAGCODE, 
d.SEQ DRUG ,
TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'1001')) age,
p.SEX 
FROM 
tmp_diag_opd e 
LEFT JOIN person p ON e.HOSPCODE = p.HOSPCODE AND e.PID = p.PID 
LEFT JOIN tmp_drug_opd d ON d.HOSPCODE = e.HOSPCODE AND d.PID = e.PID AND d.SEQ = e.SEQ AND LEFT(d.DIDSTD,2) IN ('41','42') 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIAGCODE,1) = 'U' AND LEFT(e.DIAGCODE,3)<>'U77' 
;

DROP TABLE IF  EXISTS t_ttm_opd_9;
CREATE TABLE IF NOT EXISTS t_ttm_opd_9( 
PRIMARY KEY (hospcode,instype,diagcode,age,sex),
KEY (hospcode),
KEY (instype),
KEY (diagcode),
KEY (age),
KEY (sex)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS

SELECT 
e.HOSPCODE ,
IF(e.INSTYPE='0100','UC','OTHER') instype,
e.DIAGCODE diagcode,
e.diseasename,
IFNULL(e.year_rep,@rep_year) year_rep,
IFNULL(e.age,0) age,
e.sex,

IFNULL(e.total_pt_q1,0) total_pt_q1,	
IFNULL(e.total_q1,0) total_q1,

IFNULL(e.total_pt_q2,0) total_pt_q2,	
IFNULL(e.total_q2,0) total_q2,

IFNULL(e.total_pt_q3,0) total_pt_q3,	
IFNULL(e.total_q3,0) total_q3,

IFNULL(e.total_pt_q4,0) total_pt_q4,	
IFNULL(e.total_q4,0) total_q4,
IFNULL(e.total_drug,0) total_drug
FROM chospital o
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE, 
s.INSTYPE,
e.DIAGCODE,
IFNULL(d.diseasethai,e.DIAGCODE) diseasename,
@rep_year year_rep,  
e.age age,
e.SEX sex,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) total_pt_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q1,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) total_pt_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q2,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) total_pt_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q3,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) total_pt_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q4,

COUNT(DISTINCT e.DRUG) total_drug
FROM 
tmp_planthai_diag_u e 
LEFT JOIN tmp_service s ON s.HOSPCODE = e.HOSPCODE AND s.PID = e.PID AND s.SEQ = e.SEQ 
LEFT JOIN cdisease d ON d.diagcode = e.DIAGCODE 
WHERE e.SEX IN (1,2)
GROUP BY e.HOSPCODE, IF(s.INSTYPE='0100','UC','OTHER'), e.DIAGCODE , e.age , e.SEX 
) e ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.HOSPCODE IS NOT NULL ;

/***********************ttm10******************/
DROP TABLE IF  EXISTS t_ttm_opd_10;
CREATE TABLE IF NOT EXISTS t_ttm_opd_10( 
PRIMARY KEY (hospcode,instype),
KEY (hospcode),
KEY (instype)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS

SELECT SQL_BIG_RESULT 
e.HOSPCODE ,
IF(s.INSTYPE='0100','UC','OTHER') instype,
@rep_year year_rep,

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) ed_pt_q1,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) non_ed_pt_q1,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) other_pt_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) total_pt_q1,	

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) ed_q1,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) non_ed_q1,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) other_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q1,	

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) ed_pt_q2,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) non_ed_pt_q2,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) other_pt_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) total_pt_q2,	

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) ed_q2,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) non_ed_q2,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) other_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q2,	

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) ed_pt_q3,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) non_ed_pt_q3,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) other_pt_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) total_pt_q3,	

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) ed_q3,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) non_ed_q3,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) other_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q3,	
 
COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) ed_pt_q4,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) non_ed_pt_q4,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) other_pt_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) total_pt_q4,	

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) ed_q4,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) non_ed_q4,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) other_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q4 
FROM 
tmp_planthai_drug_use e
LEFT JOIN tmp_service s ON e.HOSPCODE = s.HOSPCODE AND e.PID = s.PID AND e.SEQ = s.SEQ 
LEFT JOIN chospital o ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.HOSPCODE IS NOT NULL  AND e.DIDSTD IS NOT NULL 
GROUP BY e.HOSPCODE, IF(s.INSTYPE='0100','UC','OTHER');


 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.406863;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:427;a:5:{i:0;s:35:"DROP PROCEDURE IF EXISTS t_ttm11_15";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.406863;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:428;a:5:{i:0;s:35:"DROP PROCEDURE IF EXISTS t_ttm11_15";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.4586639;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:430;a:5:{i:0;s:18100:"CREATE PROCEDURE t_ttm11_15()
 BEGIN 
SET @provid = '58';
SET@id:= '67';
SET @rep_year = (SELECT yearprocess FROM sys_config LIMIT 1);
/**********************ttm11***************/
DROP TEMPORARY TABLE IF  EXISTS diag_u77;
CREATE TEMPORARY TABLE IF NOT EXISTS 
diag_u77 (INDEX(pcucode,instype,age)) 
ENGINE=MYISAM IGNORE AS 
SELECT SQL_BIG_RESULT
e.HOSPCODE pcucode, 
IF(s.INSTYPE='0100','UC','OTHER') instype, 
TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'1001')) age,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12) ,CONCAT(e.PID,'-',e.SEQ),NULL)) total_u77_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3) ,CONCAT(e.PID,'-',e.SEQ),NULL)) total_u77_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6) ,CONCAT(e.PID,'-',e.SEQ),NULL)) total_u77_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9) ,CONCAT(e.PID,'-',e.SEQ),NULL)) total_u77_q4,
COUNT(DISTINCT CONCAT(e.PID,'-',e.SEQ)) total_u77
FROM 
tmp_diag_opd e 
LEFT JOIN tmp_service s ON s.HOSPCODE = e.HOSPCODE AND s.PID = e.PID AND s.SEQ = e.SEQ 
LEFT JOIN person p ON e.HOSPCODE = p.HOSPCODE AND e.PID = p.PID 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIAGCODE,3) = 'U77' 
GROUP BY e.HOSPCODE,  IF(s.INSTYPE='0100','UC','OTHER'), TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'1001'))
;

DROP TEMPORARY TABLE IF  EXISTS proced_u77;
CREATE TEMPORARY TABLE IF NOT EXISTS 
proced_u77 (INDEX(pcucode,instype,age)) 
ENGINE=MYISAM  IGNORE AS 
SELECT SQL_BIG_RESULT 
e.HOSPCODE pcucode, 
IF(s.INSTYPE='0100','UC','OTHER') instype, 
TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'-10-01')) age,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,e.PID,NULL)) total_planthai_pt_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,CONCAT(e.PID,'-',e.SEQ),NULL)) total_planthai_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),e.PID,NULL)) total_pt_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,e.PID,NULL)) total_planthai_pt_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,CONCAT(e.PID,'-',e.SEQ),NULL)) total_planthai_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),e.PID,NULL)) total_pt_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,e.PID,NULL)) total_planthai_pt_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,CONCAT(e.PID,'-',e.SEQ),NULL)) total_planthai_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),e.PID,NULL)) total_pt_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,e.PID,NULL)) total_planthai_pt_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,CONCAT(e.PID,'-',e.SEQ),NULL)) total_planthai_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),e.PID,NULL)) total_pt_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q4
FROM 
(
SELECT 
e.HOSPCODE, 
e.PID, 
e.SEQ, 
e.DATE_SERV, 
e.PROCEDCODE 
FROM 
tmp_procedure_opd e 
LEFT JOIN tmp_diag_opd d ON d.HOSPCODE = e.HOSPCODE AND d.PID = e.PID AND d.SEQ = e.SEQ 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007903','9007904','9007998','9007999') 
AND LEFT(d.DIAGCODE,3) = 'U77' 
) e 
LEFT JOIN tmp_service s ON s.HOSPCODE = e.HOSPCODE AND s.PID = e.PID AND s.SEQ = e.SEQ 
LEFT JOIN person p ON e.HOSPCODE = p.HOSPCODE AND e.PID = p.PID 
WHERE e.HOSPCODE IS NOT NULL 
GROUP BY e.HOSPCODE,  IF(s.INSTYPE='0100','UC','OTHER'), TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'1001'))
;

DROP TABLE IF  EXISTS t_ttm_opd_11;
CREATE TABLE IF NOT EXISTS t_ttm_opd_11( 
PRIMARY KEY (hospcode,instype,age),
KEY (hospcode),
KEY (instype),
KEY (age)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE  AS

SELECT SQL_BIG_RESULT 
e.pcucode hospcode, 
e.instype, 
e.age,
@rep_year year_rep, 
e.total_u77_q1,
IFNULL(p.total_planthai_pt_q1,0) total_planthai_pt_q1,
IFNULL(p.total_planthai_q1,0) total_planthai_q1,
IFNULL(p.total_pt_q1,0) total_pt_q1,
IFNULL(p.total_q1,0) total_q1,
e.total_u77_q2,
IFNULL(p.total_planthai_pt_q2,0) total_planthai_pt_q2,
IFNULL(p.total_planthai_q2,0) total_planthai_q2,
IFNULL(p.total_pt_q2,0) total_pt_q2,
IFNULL(p.total_q2,0) total_q2,
e.total_u77_q3,
IFNULL(p.total_planthai_pt_q3,0) total_planthai_pt_q3,
IFNULL(p.total_planthai_q3,0) total_planthai_q3,
IFNULL(p.total_pt_q3,0) total_pt_q3,
IFNULL(p.total_q3,0) total_q3,
e.total_u77_q4,
IFNULL(p.total_planthai_pt_q4,0) total_planthai_pt_q4,
IFNULL(p.total_planthai_q4,0) total_planthai_q4,
IFNULL(p.total_pt_q4,0) total_pt_q4,
IFNULL(p.total_q4,0) total_q4,
(IFNULL(p.total_planthai_q1,0)+IFNULL(p.total_planthai_q2,0)+IFNULL(p.total_planthai_q3,0)+IFNULL(p.total_planthai_q4,0)) total_planthai,
(IFNULL(p.total_q1,0)+IFNULL(p.total_q2,0)+IFNULL(p.total_q3,0)+IFNULL(p.total_q4,0)) total_choice,
e.total_u77
FROM 
diag_u77 e 
LEFT JOIN proced_u77 p ON p.pcucode = e.pcucode AND p.instype = e.instype AND p.age = e.age 
LEFT JOIN chospital o ON e.pcucode = o.hoscode 
WHERE o.provcode=@provid ;

/***********************ttm12*******************/

DROP TEMPORARY TABLE IF  EXISTS tmp_planthai_opd_no_z;
CREATE TEMPORARY TABLE IF NOT EXISTS 
tmp_planthai_opd_no_z (INDEX(HOSPCODE),INDEX(code_rep)) 
ENGINE=MYISAM IGNORE AS
SELECT SQL_BIG_RESULT
e.HOSPCODE,
LEFT(DATE(e.DATE_SERV),7) code_rep,
COUNT(DISTINCT CONCAT(e.PID,'-',e.SEQ)) OP_SERVICE,
COUNT(DISTINCT e.PID) OP_SERVICE_PT
FROM tmp_service e 
LEFT JOIN tmp_diag_opd d ON d.HOSPCODE = e.HOSPCODE AND d.PID = e.PID AND d.SEQ = e.SEQ AND d.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(d.DIAGCODE,1) <> 'Z' 
GROUP BY e.HOSPCODE, MONTH(e.DATE_SERV)
;

DROP TEMPORARY TABLE IF  EXISTS tmp_ttm_service;
CREATE TEMPORARY TABLE IF NOT EXISTS 
tmp_ttm_service (
`HOSPCODE`  char(5) NOT NULL ,
`PID`  varchar(16) NOT NULL ,
`SEQ`  varchar(16) NOT NULL ,
`DATE_SERV`  date NULL ,
PRIMARY KEY (`HOSPCODE`, `PID`, `SEQ`)
);

REPLACE INTO tmp_ttm_service 
SELECT e.HOSPCODE, 
e.PID,
e.SEQ, 
e.DATE_SERV 
FROM tmp_diag_opd e 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIAGCODE,1) = 'U';

REPLACE INTO tmp_ttm_service
SELECT e.HOSPCODE, 
e.PID,
e.SEQ, 
e.DATE_SERV 
FROM tmp_drug_opd e 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIDSTD,2) IN ('41','42') ;

REPLACE INTO tmp_ttm_service
SELECT e.HOSPCODE, 
e.PID,
e.SEQ, 
e.DATE_SERV 
FROM tmp_procedure_opd  e 
LEFT JOIN cicd9ttm_planthai p ON e.PROCEDCODE=p.`code` 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND p.code IS NOT NULL ;


DROP TABLE IF  EXISTS t_ttm_opd_12;
CREATE TABLE IF NOT EXISTS t_ttm_opd_12( 
PRIMARY KEY (hospcode),
KEY (hospcode)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
o.hoscode hospcode,
e.code_rep quarterly,
@rep_year year_rep,
IFNULL(e.OP_SERVICE_PT,0) op_service_pt,
IFNULL(e.OP_SERVICE,0) op_service,
IFNULL(t.TM_SERVICE_PT,0) tm_service_pt,
IFNULL(t.TM_SERVICE,0) tm_service
FROM chospital o 
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE,
'' code_rep,
SUM(e.OP_SERVICE_PT) OP_SERVICE_PT, 
SUM(e.OP_SERVICE) OP_SERVICE  
FROM tmp_planthai_opd_no_z e 
GROUP BY e.HOSPCODE 
) e ON e.HOSPCODE = o.hoscode 

LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE,
e.PID,
'' code_rep,
COUNT(DISTINCT e.PID) TM_SERVICE_PT, 
COUNT(DISTINCT CONCAT(e.PID,'-',e.SEQ)) TM_SERVICE 
FROM
tmp_ttm_service e
GROUP BY e.HOSPCODE 
) t ON t.HOSPCODE = e.HOSPCODE AND t.code_rep = e.code_rep
WHERE o.provcode=@provid AND e.HOSPCODE IS NOT NULL;

/******************************ttm13*******************/
DROP TEMPORARY TABLE IF  EXISTS tmp_planthai_opd_no_z;
CREATE TEMPORARY TABLE IF NOT EXISTS 
tmp_planthai_opd_no_z (INDEX(HOSPCODE),INDEX(code_rep)) 
ENGINE=MYISAM IGNORE AS 
SELECT SQL_BIG_RESULT
e.HOSPCODE,
LEFT(DATE(e.DATE_SERV),7) code_rep,
IF(MONTH(e.DATE_SERV)=1,'มกราคม',
IF(MONTH(e.DATE_SERV)=2,'กุมภาพันธ์',
IF(MONTH(e.DATE_SERV)=3,'มีนาคม',
IF(MONTH(e.DATE_SERV)=4,'เมษายน',
IF(MONTH(e.DATE_SERV)=5,'พฤษภาคม',
IF(MONTH(e.DATE_SERV)=6,'มิถุนายน',
IF(MONTH(e.DATE_SERV)=7,'กรกฏาคม',
IF(MONTH(e.DATE_SERV)=8,'สิงหาคม',
IF(MONTH(e.DATE_SERV)=9,'กันยายน',
IF(MONTH(e.DATE_SERV)=10,'ตุลาคม',
IF(MONTH(e.DATE_SERV)=11,'พฤศจิกายน',
'ธันวาคม'))))))))))) code_name, 
COUNT(DISTINCT CONCAT(e.PID,'-',e.SEQ)) OP_SERVICE,
COUNT(DISTINCT e.PID) OP_SERVICE_PT
FROM tmp_service e 
LEFT JOIN tmp_diag_opd d ON d.HOSPCODE = e.HOSPCODE AND d.PID = e.PID AND d.SEQ = e.SEQ AND d.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(d.DIAGCODE,1) <> 'Z'
GROUP BY e.HOSPCODE, MONTH(e.DATE_SERV)
;

DROP TEMPORARY TABLE IF  EXISTS tmp_ttm_service;
CREATE TEMPORARY TABLE IF NOT EXISTS 
tmp_ttm_service (
`HOSPCODE`  char(5) NOT NULL ,
`PID`  varchar(16) NOT NULL ,
`SEQ`  varchar(16) NOT NULL ,
`DATE_SERV`  date NULL ,
PRIMARY KEY (`HOSPCODE`, `PID`, `SEQ`)
);

INSERT IGNORE INTO tmp_ttm_service 
SELECT e.HOSPCODE, 
e.PID,
e.SEQ, 
e.DATE_SERV 
FROM tmp_diag_opd e 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIAGCODE,1) = 'U';

INSERT IGNORE INTO tmp_ttm_service
SELECT e.HOSPCODE, 
e.PID,
e.SEQ, 
e.DATE_SERV 
FROM tmp_drug_opd e 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIDSTD,2) IN ('41','42') ;

INSERT IGNORE INTO tmp_ttm_service
SELECT e.HOSPCODE, 
e.PID,
e.SEQ, 
e.DATE_SERV 
FROM tmp_procedure_opd e 
LEFT JOIN cicd9ttm_planthai p ON e.PROCEDCODE=p.`code` 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND p.code IS NOT NULL ;

DROP TABLE IF  EXISTS t_ttm_opd_13;
CREATE TABLE IF NOT EXISTS t_ttm_opd_13( 
PRIMARY KEY (hospcode,code_rep),
KEY (hospcode),
KEY (code_rep)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
o.hoscode hospcode,
IFNULL(e.code_rep,CONCAT(@rep_year,'-10')) code_rep,
IFNULL(e.code_name,'ตุลาคม') code_name,
@rep_year year_rep,
IFNULL(e.OP_SERVICE_PT,0) op_service_pt,
IFNULL(e.OP_SERVICE,0) op_service,
IFNULL(t.TM_SERVICE_PT,0) tm_service_pt,
IFNULL(t.TM_SERVICE,0) tm_service
FROM chospital o 
LEFT JOIN 
tmp_planthai_opd_no_z e ON e.HOSPCODE = o.hoscode 
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE,
LEFT(DATE(e.DATE_SERV),7) code_rep,
COUNT(DISTINCT CONCAT(e.PID,'-',e.SEQ)) TM_SERVICE, 
COUNT(DISTINCT e.PID) TM_SERVICE_PT 
FROM
tmp_ttm_service e
GROUP BY e.HOSPCODE, LEFT(DATE(e.DATE_SERV),7)
) t ON t.HOSPCODE = e.HOSPCODE AND t.code_rep = e.code_rep
WHERE o.provcode=@provid 
HAVING op_service<>0  ; 

/***********************ttm14*****************/
DROP TEMPORARY TABLE IF  EXISTS ttm_service_tmp;
CREATE TEMPORARY TABLE IF NOT EXISTS 
ttm_service_tmp (
`HOSPCODE`  char(5) NOT NULL ,
`SEQ`  varchar(16) NOT NULL ,
`DATE_SERV`  date NULL ,
PRIMARY KEY (`HOSPCODE`, `SEQ`)
);

REPLACE INTO ttm_service_tmp 
SELECT e.HOSPCODE, 
e.SEQ, 
e.DATE_SERV 
FROM tmp_diag_opd e 
LEFT JOIN tmp_service s ON  s.HOSPCODE = e.HOSPCODE AND s.PID = e.PID AND s.SEQ = e.SEQ 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIAGCODE,1) = 'U' AND e.DIAGCODE<>'U77' AND s.INSTYPE='0100';

REPLACE INTO ttm_service_tmp
SELECT e.HOSPCODE, 
e.SEQ, 
e.DATE_SERV 
FROM tmp_drug_opd e 
LEFT JOIN tmp_service s ON  s.HOSPCODE = e.HOSPCODE AND s.PID = e.PID AND s.SEQ = e.SEQ 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIDSTD,2) IN ('41','42') AND s.INSTYPE='0100' ;

REPLACE INTO ttm_service_tmp
SELECT e.HOSPCODE, 
e.SEQ, 
e.DATE_SERV 
FROM tmp_procedure_opd e 
LEFT JOIN tmp_service s ON  s.HOSPCODE = e.HOSPCODE AND s.PID = e.PID AND s.SEQ = e.SEQ 
LEFT JOIN cicd9ttm_planthai p ON e.PROCEDCODE=p.`code` AND p.code NOT IN ('9007900','9007901','9007902','9007903','9007904','9007998','9007999')
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND p.code IS NOT NULL AND s.INSTYPE='0100' ;


DROP TABLE IF  EXISTS t_ttm_opd_14;
CREATE TABLE IF NOT EXISTS t_ttm_opd_14( 
PRIMARY KEY (hospcode,code_rep),
KEY (hospcode),
KEY (code_rep)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
o.hoscode hospcode,
IFNULL(e.code_rep,CONCAT(@rep_year,'-10')) code_rep,
IFNULL(e.code_name,'ตุลาคม') code_name,
@rep_year year_rep,
IFNULL(e.OP_SERVICE,0) op_service,
IFNULL(t.TM_SERVICE,0) tm_service
FROM chospital o 
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE,
LEFT(DATE(e.DATE_SERV),7) code_rep,
IF(MONTH(e.DATE_SERV)=1,'มกราคม',
IF(MONTH(e.DATE_SERV)=2,'กุมภาพันธ์',
IF(MONTH(e.DATE_SERV)=3,'มีนาคม',
IF(MONTH(e.DATE_SERV)=4,'เมษายน',
IF(MONTH(e.DATE_SERV)=5,'พฤษภาคม',
IF(MONTH(e.DATE_SERV)=6,'มิถุนายน',
IF(MONTH(e.DATE_SERV)=7,'กรกฏาคม',
IF(MONTH(e.DATE_SERV)=8,'สิงหาคม',
IF(MONTH(e.DATE_SERV)=9,'กันยายน',
IF(MONTH(e.DATE_SERV)=10,'ตุลาคม',
IF(MONTH(e.DATE_SERV)=11,'พฤศจิกายน',
'ธันวาคม'))))))))))) code_name, 
COUNT(DISTINCT CONCAT(e.PID,'-',e.SEQ)) OP_SERVICE 
FROM tmp_service e 
LEFT JOIN tmp_diag_opd d ON d.HOSPCODE = e.HOSPCODE AND d.PID = e.PID AND d.SEQ = e.SEQ AND d.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(d.DIAGCODE,1) <> 'Z' AND e.INSTYPE='0100'
GROUP BY e.HOSPCODE, MONTH(e.DATE_SERV)
) e ON e.HOSPCODE = o.hoscode 

LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE,
LEFT(DATE(e.DATE_SERV),7) code_rep,
COUNT(e.SEQ) TM_SERVICE 
FROM ttm_service_tmp e
GROUP BY e.HOSPCODE, MONTH(e.DATE_SERV)
) t ON t.HOSPCODE = e.HOSPCODE AND t.code_rep = e.code_rep

WHERE o.provcode=@provid 
HAVING op_service<>0  ;

/***********************ttm15*****************/
DROP TEMPORARY TABLE IF  EXISTS mother_service_ipd;
CREATE TEMPORARY TABLE IF NOT EXISTS 
mother_service_ipd (INDEX(CID)) 
ENGINE=MYISAM IGNORE AS 
SELECT 
e.HOSPCODE, 
e.PID, 
e.AN SEQ, 
DATE(e.TIMESTART) DATE_SERV,
a.INSTYPE,
GROUP_CONCAT(e.PROCEDCODE) PROCEDCODE,
p.BIRTH,
p.CID,
LENGTH(GROUP_CONCAT(e.PROCEDCODE)) length_str
FROM tmp_procedure_ipd e 
LEFT JOIN tmp_admission a ON e.HOSPCODE = a.HOSPCODE AND e.PID = a.PID AND e.AN = a.AN 
LEFT JOIN person p ON e.HOSPCODE = p.HOSPCODE AND e.PID = p.PID 
WHERE e.PROCEDCODE IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND 
DATE(e.TIMESTART) BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') AND 
p.SEX = 2 
GROUP BY e.HOSPCODE, e.PID, e.AN 
;

DROP TEMPORARY TABLE IF  EXISTS labor_rep;
CREATE TEMPORARY TABLE IF NOT EXISTS 
labor_rep (INDEX(CID)) 
ENGINE=MYISAM  IGNORE AS 
SELECT 
p.CID,
l.BDATE
FROM 
tmp_labor l
LEFT JOIN person p ON l.HOSPCODE = p.HOSPCODE AND l.PID = p.PID  
WHERE 
l.BDATE BETWEEN CONCAT((@rep_year-1),'0701') AND CONCAT(@rep_year,'0930') AND 
p.CID IS NOT NULL 
GROUP BY p.CID 
;

DROP TABLE IF  EXISTS t_ttm_ipd_15;
CREATE TABLE IF NOT EXISTS t_ttm_ipd_15( 
PRIMARY KEY (hospcode,code_rep),
KEY (hospcode),
KEY (code_rep)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT SQL_BIG_RESULT
e.HOSPCODE ,
CONCAT(e.HOSPCODE,'-',e.PID) code_rep,
@rep_year year_rep,
TIMESTAMPDIFF(YEAR,e.BIRTH,e.DATE_SERV) age,
MIN(e.DATE_SERV) begin_date_serv,
COUNT(DISTINCT l.CID) all_mother,
COUNT(IF(e.length_str=39,1,NULL)) have_service,
COUNT(1) all_service,
COUNT(IF(e.PROCEDCODE LIKE '%9007712%',1,NULL)) ttm_service,
IF(DATEDIFF(MIN(e.DATE_SERV),l.BDATE) BETWEEN 0 AND 45,0,1) not_in_time,
IF(DATEDIFF(MAX(e.DATE_SERV),MIN(e.DATE_SERV)) BETWEEN 0 AND 90,0,1) not_less90days,

COUNT(DISTINCT IF(e.INSTYPE='0100',l.CID,NULL)) all_uc_mother,
COUNT(IF(e.length_str=39 AND e.INSTYPE='0100',1,NULL)) uc_have_service,
COUNT(IF(e.INSTYPE='0100',1,NULL)) uc_all_service,
IF(e.INSTYPE='0100',IF(DATEDIFF(MIN(e.DATE_SERV),l.BDATE) BETWEEN 0 AND 45,0,1),0) uc_not_in_time,
IF(e.INSTYPE='0100',IF(DATEDIFF(MAX(e.DATE_SERV),MIN(e.DATE_SERV)) BETWEEN 0 AND 90,0,1),0) uc_not_less90days 
FROM mother_service_ipd e 
LEFT JOIN labor_rep l ON l.CID = e.CID
LEFT JOIN chospital i ON e.HOSPCODE = i.hoscode 
WHERE 
i.provcode=@provid 
GROUP BY e.HOSPCODE, e.PID ;


 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.4586639;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:431;a:5:{i:0;s:18100:"CREATE PROCEDURE t_ttm11_15()
 BEGIN 
SET @provid = '58';
SET@id:= '67';
SET @rep_year = (SELECT yearprocess FROM sys_config LIMIT 1);
/**********************ttm11***************/
DROP TEMPORARY TABLE IF  EXISTS diag_u77;
CREATE TEMPORARY TABLE IF NOT EXISTS 
diag_u77 (INDEX(pcucode,instype,age)) 
ENGINE=MYISAM IGNORE AS 
SELECT SQL_BIG_RESULT
e.HOSPCODE pcucode, 
IF(s.INSTYPE='0100','UC','OTHER') instype, 
TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'1001')) age,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12) ,CONCAT(e.PID,'-',e.SEQ),NULL)) total_u77_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3) ,CONCAT(e.PID,'-',e.SEQ),NULL)) total_u77_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6) ,CONCAT(e.PID,'-',e.SEQ),NULL)) total_u77_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9) ,CONCAT(e.PID,'-',e.SEQ),NULL)) total_u77_q4,
COUNT(DISTINCT CONCAT(e.PID,'-',e.SEQ)) total_u77
FROM 
tmp_diag_opd e 
LEFT JOIN tmp_service s ON s.HOSPCODE = e.HOSPCODE AND s.PID = e.PID AND s.SEQ = e.SEQ 
LEFT JOIN person p ON e.HOSPCODE = p.HOSPCODE AND e.PID = p.PID 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIAGCODE,3) = 'U77' 
GROUP BY e.HOSPCODE,  IF(s.INSTYPE='0100','UC','OTHER'), TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'1001'))
;

DROP TEMPORARY TABLE IF  EXISTS proced_u77;
CREATE TEMPORARY TABLE IF NOT EXISTS 
proced_u77 (INDEX(pcucode,instype,age)) 
ENGINE=MYISAM  IGNORE AS 
SELECT SQL_BIG_RESULT 
e.HOSPCODE pcucode, 
IF(s.INSTYPE='0100','UC','OTHER') instype, 
TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'-10-01')) age,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,e.PID,NULL)) total_planthai_pt_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,CONCAT(e.PID,'-',e.SEQ),NULL)) total_planthai_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),e.PID,NULL)) total_pt_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,e.PID,NULL)) total_planthai_pt_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,CONCAT(e.PID,'-',e.SEQ),NULL)) total_planthai_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),e.PID,NULL)) total_pt_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,e.PID,NULL)) total_planthai_pt_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,CONCAT(e.PID,'-',e.SEQ),NULL)) total_planthai_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),e.PID,NULL)) total_pt_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,e.PID,NULL)) total_planthai_pt_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,CONCAT(e.PID,'-',e.SEQ),NULL)) total_planthai_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),e.PID,NULL)) total_pt_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q4
FROM 
(
SELECT 
e.HOSPCODE, 
e.PID, 
e.SEQ, 
e.DATE_SERV, 
e.PROCEDCODE 
FROM 
tmp_procedure_opd e 
LEFT JOIN tmp_diag_opd d ON d.HOSPCODE = e.HOSPCODE AND d.PID = e.PID AND d.SEQ = e.SEQ 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007903','9007904','9007998','9007999') 
AND LEFT(d.DIAGCODE,3) = 'U77' 
) e 
LEFT JOIN tmp_service s ON s.HOSPCODE = e.HOSPCODE AND s.PID = e.PID AND s.SEQ = e.SEQ 
LEFT JOIN person p ON e.HOSPCODE = p.HOSPCODE AND e.PID = p.PID 
WHERE e.HOSPCODE IS NOT NULL 
GROUP BY e.HOSPCODE,  IF(s.INSTYPE='0100','UC','OTHER'), TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'1001'))
;

DROP TABLE IF  EXISTS t_ttm_opd_11;
CREATE TABLE IF NOT EXISTS t_ttm_opd_11( 
PRIMARY KEY (hospcode,instype,age),
KEY (hospcode),
KEY (instype),
KEY (age)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE  AS

SELECT SQL_BIG_RESULT 
e.pcucode hospcode, 
e.instype, 
e.age,
@rep_year year_rep, 
e.total_u77_q1,
IFNULL(p.total_planthai_pt_q1,0) total_planthai_pt_q1,
IFNULL(p.total_planthai_q1,0) total_planthai_q1,
IFNULL(p.total_pt_q1,0) total_pt_q1,
IFNULL(p.total_q1,0) total_q1,
e.total_u77_q2,
IFNULL(p.total_planthai_pt_q2,0) total_planthai_pt_q2,
IFNULL(p.total_planthai_q2,0) total_planthai_q2,
IFNULL(p.total_pt_q2,0) total_pt_q2,
IFNULL(p.total_q2,0) total_q2,
e.total_u77_q3,
IFNULL(p.total_planthai_pt_q3,0) total_planthai_pt_q3,
IFNULL(p.total_planthai_q3,0) total_planthai_q3,
IFNULL(p.total_pt_q3,0) total_pt_q3,
IFNULL(p.total_q3,0) total_q3,
e.total_u77_q4,
IFNULL(p.total_planthai_pt_q4,0) total_planthai_pt_q4,
IFNULL(p.total_planthai_q4,0) total_planthai_q4,
IFNULL(p.total_pt_q4,0) total_pt_q4,
IFNULL(p.total_q4,0) total_q4,
(IFNULL(p.total_planthai_q1,0)+IFNULL(p.total_planthai_q2,0)+IFNULL(p.total_planthai_q3,0)+IFNULL(p.total_planthai_q4,0)) total_planthai,
(IFNULL(p.total_q1,0)+IFNULL(p.total_q2,0)+IFNULL(p.total_q3,0)+IFNULL(p.total_q4,0)) total_choice,
e.total_u77
FROM 
diag_u77 e 
LEFT JOIN proced_u77 p ON p.pcucode = e.pcucode AND p.instype = e.instype AND p.age = e.age 
LEFT JOIN chospital o ON e.pcucode = o.hoscode 
WHERE o.provcode=@provid ;

/***********************ttm12*******************/

DROP TEMPORARY TABLE IF  EXISTS tmp_planthai_opd_no_z;
CREATE TEMPORARY TABLE IF NOT EXISTS 
tmp_planthai_opd_no_z (INDEX(HOSPCODE),INDEX(code_rep)) 
ENGINE=MYISAM IGNORE AS
SELECT SQL_BIG_RESULT
e.HOSPCODE,
LEFT(DATE(e.DATE_SERV),7) code_rep,
COUNT(DISTINCT CONCAT(e.PID,'-',e.SEQ)) OP_SERVICE,
COUNT(DISTINCT e.PID) OP_SERVICE_PT
FROM tmp_service e 
LEFT JOIN tmp_diag_opd d ON d.HOSPCODE = e.HOSPCODE AND d.PID = e.PID AND d.SEQ = e.SEQ AND d.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(d.DIAGCODE,1) <> 'Z' 
GROUP BY e.HOSPCODE, MONTH(e.DATE_SERV)
;

DROP TEMPORARY TABLE IF  EXISTS tmp_ttm_service;
CREATE TEMPORARY TABLE IF NOT EXISTS 
tmp_ttm_service (
`HOSPCODE`  char(5) NOT NULL ,
`PID`  varchar(16) NOT NULL ,
`SEQ`  varchar(16) NOT NULL ,
`DATE_SERV`  date NULL ,
PRIMARY KEY (`HOSPCODE`, `PID`, `SEQ`)
);

REPLACE INTO tmp_ttm_service 
SELECT e.HOSPCODE, 
e.PID,
e.SEQ, 
e.DATE_SERV 
FROM tmp_diag_opd e 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIAGCODE,1) = 'U';

REPLACE INTO tmp_ttm_service
SELECT e.HOSPCODE, 
e.PID,
e.SEQ, 
e.DATE_SERV 
FROM tmp_drug_opd e 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIDSTD,2) IN ('41','42') ;

REPLACE INTO tmp_ttm_service
SELECT e.HOSPCODE, 
e.PID,
e.SEQ, 
e.DATE_SERV 
FROM tmp_procedure_opd  e 
LEFT JOIN cicd9ttm_planthai p ON e.PROCEDCODE=p.`code` 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND p.code IS NOT NULL ;


DROP TABLE IF  EXISTS t_ttm_opd_12;
CREATE TABLE IF NOT EXISTS t_ttm_opd_12( 
PRIMARY KEY (hospcode),
KEY (hospcode)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
o.hoscode hospcode,
e.code_rep quarterly,
@rep_year year_rep,
IFNULL(e.OP_SERVICE_PT,0) op_service_pt,
IFNULL(e.OP_SERVICE,0) op_service,
IFNULL(t.TM_SERVICE_PT,0) tm_service_pt,
IFNULL(t.TM_SERVICE,0) tm_service
FROM chospital o 
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE,
'' code_rep,
SUM(e.OP_SERVICE_PT) OP_SERVICE_PT, 
SUM(e.OP_SERVICE) OP_SERVICE  
FROM tmp_planthai_opd_no_z e 
GROUP BY e.HOSPCODE 
) e ON e.HOSPCODE = o.hoscode 

LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE,
e.PID,
'' code_rep,
COUNT(DISTINCT e.PID) TM_SERVICE_PT, 
COUNT(DISTINCT CONCAT(e.PID,'-',e.SEQ)) TM_SERVICE 
FROM
tmp_ttm_service e
GROUP BY e.HOSPCODE 
) t ON t.HOSPCODE = e.HOSPCODE AND t.code_rep = e.code_rep
WHERE o.provcode=@provid AND e.HOSPCODE IS NOT NULL;

/******************************ttm13*******************/
DROP TEMPORARY TABLE IF  EXISTS tmp_planthai_opd_no_z;
CREATE TEMPORARY TABLE IF NOT EXISTS 
tmp_planthai_opd_no_z (INDEX(HOSPCODE),INDEX(code_rep)) 
ENGINE=MYISAM IGNORE AS 
SELECT SQL_BIG_RESULT
e.HOSPCODE,
LEFT(DATE(e.DATE_SERV),7) code_rep,
IF(MONTH(e.DATE_SERV)=1,'มกราคม',
IF(MONTH(e.DATE_SERV)=2,'กุมภาพันธ์',
IF(MONTH(e.DATE_SERV)=3,'มีนาคม',
IF(MONTH(e.DATE_SERV)=4,'เมษายน',
IF(MONTH(e.DATE_SERV)=5,'พฤษภาคม',
IF(MONTH(e.DATE_SERV)=6,'มิถุนายน',
IF(MONTH(e.DATE_SERV)=7,'กรกฏาคม',
IF(MONTH(e.DATE_SERV)=8,'สิงหาคม',
IF(MONTH(e.DATE_SERV)=9,'กันยายน',
IF(MONTH(e.DATE_SERV)=10,'ตุลาคม',
IF(MONTH(e.DATE_SERV)=11,'พฤศจิกายน',
'ธันวาคม'))))))))))) code_name, 
COUNT(DISTINCT CONCAT(e.PID,'-',e.SEQ)) OP_SERVICE,
COUNT(DISTINCT e.PID) OP_SERVICE_PT
FROM tmp_service e 
LEFT JOIN tmp_diag_opd d ON d.HOSPCODE = e.HOSPCODE AND d.PID = e.PID AND d.SEQ = e.SEQ AND d.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(d.DIAGCODE,1) <> 'Z'
GROUP BY e.HOSPCODE, MONTH(e.DATE_SERV)
;

DROP TEMPORARY TABLE IF  EXISTS tmp_ttm_service;
CREATE TEMPORARY TABLE IF NOT EXISTS 
tmp_ttm_service (
`HOSPCODE`  char(5) NOT NULL ,
`PID`  varchar(16) NOT NULL ,
`SEQ`  varchar(16) NOT NULL ,
`DATE_SERV`  date NULL ,
PRIMARY KEY (`HOSPCODE`, `PID`, `SEQ`)
);

INSERT IGNORE INTO tmp_ttm_service 
SELECT e.HOSPCODE, 
e.PID,
e.SEQ, 
e.DATE_SERV 
FROM tmp_diag_opd e 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIAGCODE,1) = 'U';

INSERT IGNORE INTO tmp_ttm_service
SELECT e.HOSPCODE, 
e.PID,
e.SEQ, 
e.DATE_SERV 
FROM tmp_drug_opd e 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIDSTD,2) IN ('41','42') ;

INSERT IGNORE INTO tmp_ttm_service
SELECT e.HOSPCODE, 
e.PID,
e.SEQ, 
e.DATE_SERV 
FROM tmp_procedure_opd e 
LEFT JOIN cicd9ttm_planthai p ON e.PROCEDCODE=p.`code` 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND p.code IS NOT NULL ;

DROP TABLE IF  EXISTS t_ttm_opd_13;
CREATE TABLE IF NOT EXISTS t_ttm_opd_13( 
PRIMARY KEY (hospcode,code_rep),
KEY (hospcode),
KEY (code_rep)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
o.hoscode hospcode,
IFNULL(e.code_rep,CONCAT(@rep_year,'-10')) code_rep,
IFNULL(e.code_name,'ตุลาคม') code_name,
@rep_year year_rep,
IFNULL(e.OP_SERVICE_PT,0) op_service_pt,
IFNULL(e.OP_SERVICE,0) op_service,
IFNULL(t.TM_SERVICE_PT,0) tm_service_pt,
IFNULL(t.TM_SERVICE,0) tm_service
FROM chospital o 
LEFT JOIN 
tmp_planthai_opd_no_z e ON e.HOSPCODE = o.hoscode 
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE,
LEFT(DATE(e.DATE_SERV),7) code_rep,
COUNT(DISTINCT CONCAT(e.PID,'-',e.SEQ)) TM_SERVICE, 
COUNT(DISTINCT e.PID) TM_SERVICE_PT 
FROM
tmp_ttm_service e
GROUP BY e.HOSPCODE, LEFT(DATE(e.DATE_SERV),7)
) t ON t.HOSPCODE = e.HOSPCODE AND t.code_rep = e.code_rep
WHERE o.provcode=@provid 
HAVING op_service<>0  ; 

/***********************ttm14*****************/
DROP TEMPORARY TABLE IF  EXISTS ttm_service_tmp;
CREATE TEMPORARY TABLE IF NOT EXISTS 
ttm_service_tmp (
`HOSPCODE`  char(5) NOT NULL ,
`SEQ`  varchar(16) NOT NULL ,
`DATE_SERV`  date NULL ,
PRIMARY KEY (`HOSPCODE`, `SEQ`)
);

REPLACE INTO ttm_service_tmp 
SELECT e.HOSPCODE, 
e.SEQ, 
e.DATE_SERV 
FROM tmp_diag_opd e 
LEFT JOIN tmp_service s ON  s.HOSPCODE = e.HOSPCODE AND s.PID = e.PID AND s.SEQ = e.SEQ 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIAGCODE,1) = 'U' AND e.DIAGCODE<>'U77' AND s.INSTYPE='0100';

REPLACE INTO ttm_service_tmp
SELECT e.HOSPCODE, 
e.SEQ, 
e.DATE_SERV 
FROM tmp_drug_opd e 
LEFT JOIN tmp_service s ON  s.HOSPCODE = e.HOSPCODE AND s.PID = e.PID AND s.SEQ = e.SEQ 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIDSTD,2) IN ('41','42') AND s.INSTYPE='0100' ;

REPLACE INTO ttm_service_tmp
SELECT e.HOSPCODE, 
e.SEQ, 
e.DATE_SERV 
FROM tmp_procedure_opd e 
LEFT JOIN tmp_service s ON  s.HOSPCODE = e.HOSPCODE AND s.PID = e.PID AND s.SEQ = e.SEQ 
LEFT JOIN cicd9ttm_planthai p ON e.PROCEDCODE=p.`code` AND p.code NOT IN ('9007900','9007901','9007902','9007903','9007904','9007998','9007999')
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND p.code IS NOT NULL AND s.INSTYPE='0100' ;


DROP TABLE IF  EXISTS t_ttm_opd_14;
CREATE TABLE IF NOT EXISTS t_ttm_opd_14( 
PRIMARY KEY (hospcode,code_rep),
KEY (hospcode),
KEY (code_rep)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
o.hoscode hospcode,
IFNULL(e.code_rep,CONCAT(@rep_year,'-10')) code_rep,
IFNULL(e.code_name,'ตุลาคม') code_name,
@rep_year year_rep,
IFNULL(e.OP_SERVICE,0) op_service,
IFNULL(t.TM_SERVICE,0) tm_service
FROM chospital o 
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE,
LEFT(DATE(e.DATE_SERV),7) code_rep,
IF(MONTH(e.DATE_SERV)=1,'มกราคม',
IF(MONTH(e.DATE_SERV)=2,'กุมภาพันธ์',
IF(MONTH(e.DATE_SERV)=3,'มีนาคม',
IF(MONTH(e.DATE_SERV)=4,'เมษายน',
IF(MONTH(e.DATE_SERV)=5,'พฤษภาคม',
IF(MONTH(e.DATE_SERV)=6,'มิถุนายน',
IF(MONTH(e.DATE_SERV)=7,'กรกฏาคม',
IF(MONTH(e.DATE_SERV)=8,'สิงหาคม',
IF(MONTH(e.DATE_SERV)=9,'กันยายน',
IF(MONTH(e.DATE_SERV)=10,'ตุลาคม',
IF(MONTH(e.DATE_SERV)=11,'พฤศจิกายน',
'ธันวาคม'))))))))))) code_name, 
COUNT(DISTINCT CONCAT(e.PID,'-',e.SEQ)) OP_SERVICE 
FROM tmp_service e 
LEFT JOIN tmp_diag_opd d ON d.HOSPCODE = e.HOSPCODE AND d.PID = e.PID AND d.SEQ = e.SEQ AND d.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(d.DIAGCODE,1) <> 'Z' AND e.INSTYPE='0100'
GROUP BY e.HOSPCODE, MONTH(e.DATE_SERV)
) e ON e.HOSPCODE = o.hoscode 

LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE,
LEFT(DATE(e.DATE_SERV),7) code_rep,
COUNT(e.SEQ) TM_SERVICE 
FROM ttm_service_tmp e
GROUP BY e.HOSPCODE, MONTH(e.DATE_SERV)
) t ON t.HOSPCODE = e.HOSPCODE AND t.code_rep = e.code_rep

WHERE o.provcode=@provid 
HAVING op_service<>0  ;

/***********************ttm15*****************/
DROP TEMPORARY TABLE IF  EXISTS mother_service_ipd;
CREATE TEMPORARY TABLE IF NOT EXISTS 
mother_service_ipd (INDEX(CID)) 
ENGINE=MYISAM IGNORE AS 
SELECT 
e.HOSPCODE, 
e.PID, 
e.AN SEQ, 
DATE(e.TIMESTART) DATE_SERV,
a.INSTYPE,
GROUP_CONCAT(e.PROCEDCODE) PROCEDCODE,
p.BIRTH,
p.CID,
LENGTH(GROUP_CONCAT(e.PROCEDCODE)) length_str
FROM tmp_procedure_ipd e 
LEFT JOIN tmp_admission a ON e.HOSPCODE = a.HOSPCODE AND e.PID = a.PID AND e.AN = a.AN 
LEFT JOIN person p ON e.HOSPCODE = p.HOSPCODE AND e.PID = p.PID 
WHERE e.PROCEDCODE IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND 
DATE(e.TIMESTART) BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') AND 
p.SEX = 2 
GROUP BY e.HOSPCODE, e.PID, e.AN 
;

DROP TEMPORARY TABLE IF  EXISTS labor_rep;
CREATE TEMPORARY TABLE IF NOT EXISTS 
labor_rep (INDEX(CID)) 
ENGINE=MYISAM  IGNORE AS 
SELECT 
p.CID,
l.BDATE
FROM 
tmp_labor l
LEFT JOIN person p ON l.HOSPCODE = p.HOSPCODE AND l.PID = p.PID  
WHERE 
l.BDATE BETWEEN CONCAT((@rep_year-1),'0701') AND CONCAT(@rep_year,'0930') AND 
p.CID IS NOT NULL 
GROUP BY p.CID 
;

DROP TABLE IF  EXISTS t_ttm_ipd_15;
CREATE TABLE IF NOT EXISTS t_ttm_ipd_15( 
PRIMARY KEY (hospcode,code_rep),
KEY (hospcode),
KEY (code_rep)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT SQL_BIG_RESULT
e.HOSPCODE ,
CONCAT(e.HOSPCODE,'-',e.PID) code_rep,
@rep_year year_rep,
TIMESTAMPDIFF(YEAR,e.BIRTH,e.DATE_SERV) age,
MIN(e.DATE_SERV) begin_date_serv,
COUNT(DISTINCT l.CID) all_mother,
COUNT(IF(e.length_str=39,1,NULL)) have_service,
COUNT(1) all_service,
COUNT(IF(e.PROCEDCODE LIKE '%9007712%',1,NULL)) ttm_service,
IF(DATEDIFF(MIN(e.DATE_SERV),l.BDATE) BETWEEN 0 AND 45,0,1) not_in_time,
IF(DATEDIFF(MAX(e.DATE_SERV),MIN(e.DATE_SERV)) BETWEEN 0 AND 90,0,1) not_less90days,

COUNT(DISTINCT IF(e.INSTYPE='0100',l.CID,NULL)) all_uc_mother,
COUNT(IF(e.length_str=39 AND e.INSTYPE='0100',1,NULL)) uc_have_service,
COUNT(IF(e.INSTYPE='0100',1,NULL)) uc_all_service,
IF(e.INSTYPE='0100',IF(DATEDIFF(MIN(e.DATE_SERV),l.BDATE) BETWEEN 0 AND 45,0,1),0) uc_not_in_time,
IF(e.INSTYPE='0100',IF(DATEDIFF(MAX(e.DATE_SERV),MIN(e.DATE_SERV)) BETWEEN 0 AND 90,0,1),0) uc_not_less90days 
FROM mother_service_ipd e 
LEFT JOIN labor_rep l ON l.CID = e.CID
LEFT JOIN chospital i ON e.HOSPCODE = i.hoscode 
WHERE 
i.provcode=@provid 
GROUP BY e.HOSPCODE, e.PID ;


 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.521064;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:433;a:5:{i:0;s:35:"DROP PROCEDURE IF EXISTS t_ttm16_20";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.521064;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:434;a:5:{i:0;s:35:"DROP PROCEDURE IF EXISTS t_ttm16_20";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.5678639;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:436;a:5:{i:0;s:15882:"CREATE PROCEDURE t_ttm16_20()
 BEGIN 
SET @provid = '58';
SET @id:= '68';
SET @rep_year = (SELECT yearprocess FROM sys_config LIMIT 1);
/*************************ttmp16***************/

DROP TABLE IF  EXISTS tmp_drug_ipd;
CREATE TABLE IF NOT EXISTS tmp_drug_ipd(
PRIMARY KEY (`HOSPCODE`,`PID`,`AN`,`DATETIME_ADMIT`,`TYPEDRUG`,`DIDSTD`),
  KEY  (`HOSPCODE`,`PID`),
  KEY (`HOSPCODE`),
  KEY (`DATETIME_ADMIT`),
  KEY (`WARDSTAY`),
  KEY (`TYPEDRUG`),
  KEY (`DIDSTD`),
  KEY (`DATESTART`),
  KEY  (`DATEFINISH`),
  KEY  (`HOSPCODE`,`AN`),
  KEY  (`AN`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT i.*,p.cid FROM drug_ipd i INNER JOIN person p ON i.HOSPCODE=p.HOSPCODE AND i.PID=p.PID
WHERE  DATESTART BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') ;

DROP TABLE IF  EXISTS tmp_planthai_drug_use_ipd;
CREATE  TABLE IF NOT EXISTS 
tmp_planthai_drug_use_ipd (INDEX(HOSPCODE),INDEX(PID),INDEX(SEQ)) 
ENGINE=MYISAM IGNORE AS 
SELECT
e.HOSPCODE,
e.PID,
e.AN SEQ,
e.DATESTART DATE_SERV,
e.DIDSTD,
e.AMOUNT,
e.DRUGPRICE,
e.DRUGCOST,
d.didstd PASS,
d.drug_name,
d.drug_type ,
d.ed
FROM 
tmp_drug_ipd  e 
LEFT JOIN cdrug_planthai d ON d.didstd=e.DIDSTD 
WHERE
e.DATESTART BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIDSTD,2) IN ('41','42') 
;

DROP TABLE IF  EXISTS t_ttm_ipd_16;
CREATE TABLE IF NOT EXISTS t_ttm_ipd_16( 
PRIMARY KEY (hospcode,code_rep),
KEY (hospcode),
KEY (code_rep)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
e.HOSPCODE ,
IFNULL(e.code_rep,CONCAT(@rep_year,'-07')) code_rep,
IFNULL(
IF(e.code_name=1,'มกราคม',
IF(e.code_name=2,'กุมภาพันธ์',
IF(e.code_name=3,'มีนาคม',
IF(e.code_name=4,'เมษายน',
IF(e.code_name=5,'พฤษภาคม',
IF(e.code_name=6,'มิถุนายน',
IF(e.code_name=7,'กรกฏาคม',
IF(e.code_name=8,'สิงหาคม',
IF(e.code_name=9,'กันยายน',
IF(e.code_name=10,'ตุลาคม',
IF(e.code_name=11,'พฤศจิกายน',
'ธันวาคม')))))))))))
,'กรกฏาคม') code_name,
IFNULL(e.year_rep,@rep_year) year_rep,
IFNULL(e.all_visit,0) all_visit,
IFNULL(e.all_drug,0) all_drug,
IFNULL(e.uc_visit,0) uc_visit,
IFNULL(e.uc_drug,0) uc_drug,
IFNULL(e.all_visit_error,0) all_visit_error,
IFNULL(e.all_drug_error,0) all_drug_error,
IFNULL(e.uc_visit_error,0) uc_visit_error,
IFNULL(e.uc_drug_error,0) uc_drug_error
FROM chospital o 
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE, 
LEFT(DATE(e.DATE_SERV),7) code_rep,
MONTH(e.DATE_SERV) code_name,
@rep_year year_rep, 
COUNT(DISTINCT e.SEQ) as all_visit, 
COUNT(*) as all_drug, 
COUNT(DISTINCT (IF(s.INSTYPE='0100',e.SEQ,NULL))) as uc_visit , 
COUNT(IF(s.INSTYPE='0100',1,NULL)) as uc_drug,
COUNT(DISTINCT IF(e.PASS IS NULL,e.SEQ,NULL)) as all_visit_error, 
COUNT(IF(e.PASS IS NULL,e.SEQ,NULL)) as all_drug_error, 
COUNT(DISTINCT (IF(s.INSTYPE='0100' AND e.PASS IS NULL,e.SEQ,NULL))) as uc_visit_error , 
COUNT(IF(s.INSTYPE='0100' AND e.PASS IS NULL,1,NULL)) as uc_drug_error  
FROM 
tmp_planthai_drug_use_ipd e
LEFT JOIN tmp_admission s ON e.HOSPCODE = s.HOSPCODE AND e.PID = s.PID AND e.SEQ = s.AN 
GROUP BY e.HOSPCODE, MONTH(e.DATE_SERV) ) e ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid  AND e.code_rep IS NOT NULL ;

/*************************ttmp17***************/
DROP TABLE IF  EXISTS t_ttm_ipd_17;
CREATE TABLE IF NOT EXISTS t_ttm_ipd_17( 
PRIMARY KEY (hospcode,servplace,age,sex),
KEY (hospcode),
KEY (servplace),
KEY (age),
KEY (sex)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
e.HOSPCODE ,
e.servplace,
e.age,
e.sex,
@rep_year year_rep,

IFNULL(e.total_pt_q1,0) total_pt_q1,	
IFNULL(e.total_q1,0) total_q1,
IFNULL(e.didstd_q1,0) didstd_q1,

IFNULL(e.total_pt_q2,0) total_pt_q2,	
IFNULL(e.total_q2,0) total_q2,
IFNULL(e.didstd_q2,0) didstd_q2,

IFNULL(e.total_pt_q3,0) total_pt_q3,	
IFNULL(e.total_q3,0) total_q3,
IFNULL(e.didstd_q3,0) didstd_q3,	

IFNULL(e.total_pt_q4,0) total_pt_q4,	
IFNULL(e.total_q4,0) total_q4,
IFNULL(e.didstd_q4,0) didstd_q4
FROM chospital o 
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE, 
e.DATE_SERV,
1 servplace,
TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'1001')) age,
p.SEX sex,
@rep_year year_rep, 

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) total_pt_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.SEQ,NULL)) total_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.SEQ,'-',e.DIDSTD),NULL)) didstd_q1,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) total_pt_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.SEQ,NULL)) total_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.SEQ,'-',e.DIDSTD),NULL)) didstd_q2,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) total_pt_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.SEQ,NULL)) total_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.SEQ,'-',e.DIDSTD),NULL)) didstd_q3,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) total_pt_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.SEQ,NULL)) total_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.SEQ,'-',e.DIDSTD),NULL)) didstd_q4 
FROM 
tmp_planthai_drug_use_ipd e
LEFT JOIN tmp_admission s ON e.HOSPCODE = s.HOSPCODE AND e.PID = s.PID AND e.SEQ = s.AN 
INNER JOIN person p ON e.HOSPCODE = p.HOSPCODE AND e.PID = p.PID 
GROUP BY e.HOSPCODE, p.SEX, TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'1001'))
) e ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.HOSPCODE IS NOT NULL ;

/*************************ttmp18***************/
DROP TABLE IF  EXISTS t_ttm_ipd_18;
CREATE TABLE IF NOT EXISTS t_ttm_ipd_18( 
PRIMARY KEY (hospcode,code_rep),
KEY (hospcode),
KEY (code_rep)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
o.hoscode hospcode,
e.didstd code_rep,
IFNULL(CONCAT(e.drug_name,', ',e.drug_type),e.didstd) code_name,
@rep_year year_rep,
IFNULL(e.all_visit,0) all_visit,
IFNULL(e.all_drug,0) all_drug,
IFNULL(e.uc_visit,0) uc_visit,
IFNULL(e.uc_drug,0) uc_drug,
IFNULL(e.all_visit_error,0) all_visit_error,
IFNULL(e.all_drug_error,0) all_drug_error,
IFNULL(e.uc_visit_error,0) uc_visit_error,
IFNULL(e.uc_drug_error,0) uc_drug_error
FROM chospital o 
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE, 
e.DIDSTD didstd,
e.drug_name, 
e.drug_type,
@rep_year year_rep, 
COUNT(DISTINCT e.SEQ) as all_visit, 
COUNT(*) as all_drug, 
COUNT(DISTINCT (IF(s.INSTYPE='0100',e.SEQ,NULL))) as uc_visit , 
COUNT(IF(s.INSTYPE='0100',1,NULL)) as uc_drug,
COUNT(DISTINCT IF(e.PASS IS NULL,e.SEQ,NULL)) as all_visit_error, 
COUNT(IF(e.PASS IS NULL,e.SEQ,NULL)) as all_drug_error, 
COUNT(DISTINCT (IF(s.INSTYPE='0100' AND e.PASS IS NULL,e.SEQ,NULL))) as uc_visit_error , 
COUNT(IF(s.INSTYPE='0100' AND e.PASS IS NULL,1,NULL)) as uc_drug_error  
FROM 
tmp_planthai_drug_use_ipd e
LEFT JOIN tmp_admission s ON e.HOSPCODE = s.HOSPCODE AND e.PID = s.PID AND e.SEQ = s.AN 
GROUP BY e.HOSPCODE, e.DIDSTD 
) e ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.didstd IS NOT NULL ;

/****************ttm19******************/
DROP TABLE IF  EXISTS t_ttm_ipd_19;
CREATE TABLE IF NOT EXISTS t_ttm_ipd_19( 
PRIMARY KEY (hospcode,code_rep),
KEY (hospcode),
KEY (code_rep)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT SQL_BIG_RESULT
e.HOSPCODE ,
LEFT(DATE(e.DATESTART),7) code_rep,
IF(MONTH(e.DATESTART)=1,'มกราคม',
IF(MONTH(e.DATESTART)=2,'กุมภาพันธ์',
IF(MONTH(e.DATESTART)=3,'มีนาคม',
IF(MONTH(e.DATESTART)=4,'เมษายน',
IF(MONTH(e.DATESTART)=5,'พฤษภาคม',
IF(MONTH(e.DATESTART)=6,'มิถุนายน',
IF(MONTH(e.DATESTART)=7,'กรกฏาคม',
IF(MONTH(e.DATESTART)=8,'สิงหาคม',
IF(MONTH(e.DATESTART)=9,'กันยายน',
IF(MONTH(e.DATESTART)=10,'ตุลาคม',
IF(MONTH(e.DATESTART)=11,'พฤศจิกายน',
'ธันวาคม'))))))))))) code_name,
@rep_year year_rep,
SUM(IF(LEFT(e.DIDSTD,2) <> '41' AND LEFT(e.DIDSTD,2) <> '42',e.AMOUNT*e.DRUGPRICE,0))  price_drug ,
SUM(IF(LEFT(e.DIDSTD,2) = '41' OR LEFT(e.DIDSTD,2) = '42',e.AMOUNT*e.DRUGPRICE,0))  price_planthai_drug
FROM 
tmp_drug_ipd e 
LEFT JOIN chospital i ON e.HOSPCODE = i.hoscode 
WHERE e.DATESTART BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930')  AND i.provcode=@provid 
GROUP BY e.HOSPCODE, MONTH(e.DATESTART);

/******************************ttm20******************/
DROP TEMPORARY TABLE IF  EXISTS tmp_planthai_procedure_ipd;
CREATE TEMPORARY TABLE IF NOT EXISTS 
tmp_planthai_procedure_ipd (INDEX(HOSPCODE),INDEX(PID),INDEX(SEQ)) 
ENGINE=MYISAM IGNORE  AS 
SELECT 
e.HOSPCODE, 
e.PID, 
e.AN SEQ, 
DATE(e.TIMESTART) DATE_SERV, 
e.PROCEDCODE, 
icd.tmtype 
FROM 
tmp_procedure_ipd e 
LEFT JOIN cicd9ttm_planthai icd ON icd.`code` = e.PROCEDCODE 
WHERE DATE(e.TIMESTART) BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND icd.`code`IS NOT NULL 
;

DROP TABLE IF  EXISTS t_ttm_ipd_20;
CREATE TABLE IF NOT EXISTS t_ttm_ipd_20( 
PRIMARY KEY (hospcode,instype),
KEY (hospcode),
KEY (instype)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
e.HOSPCODE ,
IF(e.INSTYPE='0100','UC','OTHER') instype,
IFNULL(e.year_rep,@rep_year) year_rep,

IFNULL(e.pt_nod_q1,0) pt_nod_q1,
IFNULL(e.service_nod_q1,0) service_nod_q1,
IFNULL(e.pt_obb_q1,0) pt_obb_q1,
IFNULL(e.service_obb_q1,0) service_obb_q1,
IFNULL(e.pt_cop_q1,0) pt_cop_q1,
IFNULL(e.service_cop_q1,0) service_cop_q1,
IFNULL(e.pt_other_q1,0) pt_other_q1,
IFNULL(e.service_other_q1,0) service_other_q1,
IFNULL(e.pt_total_q1,0) pt_total_q1,
IFNULL(e.service_total_q1,0) service_total_q1,

IFNULL(e.pt_nod_q2,0) pt_nod_q2,
IFNULL(e.service_nod_q2,0) service_nod_q2,
IFNULL(e.pt_obb_q2,0) pt_obb_q2,
IFNULL(e.service_obb_q2,0) service_obb_q2,
IFNULL(e.pt_cop_q2,0) pt_cop_q2,
IFNULL(e.service_cop_q2,0) service_cop_q2,
IFNULL(e.pt_other_q2,0) pt_other_q2,
IFNULL(e.service_other_q2,0) service_other_q2,
IFNULL(e.pt_total_q2,0) pt_total_q2,
IFNULL(e.service_total_q2,0) service_total_q2,

IFNULL(e.pt_nod_q3,0) pt_nod_q3,
IFNULL(e.service_nod_q3,0) service_nod_q3,
IFNULL(e.pt_obb_q3,0) pt_obb_q3,
IFNULL(e.service_obb_q3,0) service_obb_q3,
IFNULL(e.pt_cop_q3,0) pt_cop_q3,
IFNULL(e.service_cop_q3,0) service_cop_q3,
IFNULL(e.pt_other_q3,0) pt_other_q3,
IFNULL(e.service_other_q3,0) service_other_q3,
IFNULL(e.pt_total_q3,0) pt_total_q3,
IFNULL(e.service_total_q3,0) service_total_q3,

IFNULL(e.pt_nod_q4,0) pt_nod_q4,
IFNULL(e.service_nod_q4,0) service_nod_q4,
IFNULL(e.pt_obb_q4,0) pt_obb_q4,
IFNULL(e.service_obb_q4,0) service_obb_q4,
IFNULL(e.pt_cop_q4,0) pt_cop_q4,
IFNULL(e.service_cop_q4,0) service_cop_q4,
IFNULL(e.pt_other_q4,0) pt_other_q4,
IFNULL(e.service_other_q4,0) service_other_q4,
IFNULL(e.pt_total_q4,0) pt_total_q4,
IFNULL(e.service_total_q4,0) service_total_q4
FROM chospital o
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE, 
s.INSTYPE,
1 SERVPLACE,
@rep_year year_rep,  

COUNT(DISTINCT IF(e.tmtype=1 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) pt_nod_q1,
COUNT(DISTINCT IF(e.tmtype=1 AND MONTH(e.DATE_SERV) IN (10,11,12),e.SEQ,NULL)) service_nod_q1,
COUNT(DISTINCT IF(e.tmtype=2 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) pt_obb_q1,
COUNT(DISTINCT IF(e.tmtype=2 AND MONTH(e.DATE_SERV) IN (10,11,12),e.SEQ,NULL)) service_obb_q1,
COUNT(DISTINCT IF(e.tmtype=3 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) pt_cop_q1,
COUNT(DISTINCT IF(e.tmtype=3 AND MONTH(e.DATE_SERV) IN (10,11,12),e.SEQ,NULL)) service_cop_q1,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) pt_other_q1,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND MONTH(e.DATE_SERV) IN (10,11,12),e.SEQ,NULL)) service_other_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) pt_total_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.SEQ,NULL)) service_total_q1,


COUNT(DISTINCT IF(e.tmtype=1 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) pt_nod_q2,
COUNT(DISTINCT IF(e.tmtype=1 AND MONTH(e.DATE_SERV) IN (1,2,3),e.SEQ,NULL)) service_nod_q2,
COUNT(DISTINCT IF(e.tmtype=2 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) pt_obb_q2,
COUNT(DISTINCT IF(e.tmtype=2 AND MONTH(e.DATE_SERV) IN (1,2,3),e.SEQ,NULL)) service_obb_q2,
COUNT(DISTINCT IF(e.tmtype=3 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) pt_cop_q2,
COUNT(DISTINCT IF(e.tmtype=3 AND MONTH(e.DATE_SERV) IN (1,2,3),e.SEQ,NULL)) service_cop_q2,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) pt_other_q2,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND MONTH(e.DATE_SERV) IN (1,2,3),e.SEQ,NULL)) service_other_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) pt_total_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.SEQ,NULL)) service_total_q2,


COUNT(DISTINCT IF(e.tmtype=1 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) pt_nod_q3,
COUNT(DISTINCT IF(e.tmtype=1 AND MONTH(e.DATE_SERV) IN (4,5,6),e.SEQ,NULL)) service_nod_q3,
COUNT(DISTINCT IF(e.tmtype=2 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) pt_obb_q3,
COUNT(DISTINCT IF(e.tmtype=2 AND MONTH(e.DATE_SERV) IN (4,5,6),e.SEQ,NULL)) service_obb_q3,
COUNT(DISTINCT IF(e.tmtype=3 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) pt_cop_q3,
COUNT(DISTINCT IF(e.tmtype=3 AND MONTH(e.DATE_SERV) IN (4,5,6),e.SEQ,NULL)) service_cop_q3,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) pt_other_q3,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND MONTH(e.DATE_SERV) IN (4,5,6),e.SEQ,NULL)) service_other_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) pt_total_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.SEQ,NULL)) service_total_q3,


COUNT(DISTINCT IF(e.tmtype=1 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) pt_nod_q4,
COUNT(DISTINCT IF(e.tmtype=1 AND MONTH(e.DATE_SERV) IN (7,8,9),e.SEQ,NULL)) service_nod_q4,
COUNT(DISTINCT IF(e.tmtype=2 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) pt_obb_q4,
COUNT(DISTINCT IF(e.tmtype=2 AND MONTH(e.DATE_SERV) IN (7,8,9),e.SEQ,NULL)) service_obb_q4,
COUNT(DISTINCT IF(e.tmtype=3 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) pt_cop_q4,
COUNT(DISTINCT IF(e.tmtype=3 AND MONTH(e.DATE_SERV) IN (7,8,9),e.SEQ,NULL)) service_cop_q4,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) pt_other_q4,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND MONTH(e.DATE_SERV) IN (7,8,9),e.SEQ,NULL)) service_other_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) pt_total_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.SEQ,NULL)) service_total_q4,

NOW() 
FROM 
tmp_planthai_procedure_ipd e 
LEFT JOIN tmp_admission s ON s.HOSPCODE = e.HOSPCODE AND s.PID = e.PID AND s.AN = e.SEQ 
GROUP BY e.HOSPCODE,  IF(s.INSTYPE='0100','UC','OTHER') 
) e ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.HOSPCODE IS NOT NULL;


 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.5834639;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:437;a:5:{i:0;s:15882:"CREATE PROCEDURE t_ttm16_20()
 BEGIN 
SET @provid = '58';
SET @id:= '68';
SET @rep_year = (SELECT yearprocess FROM sys_config LIMIT 1);
/*************************ttmp16***************/

DROP TABLE IF  EXISTS tmp_drug_ipd;
CREATE TABLE IF NOT EXISTS tmp_drug_ipd(
PRIMARY KEY (`HOSPCODE`,`PID`,`AN`,`DATETIME_ADMIT`,`TYPEDRUG`,`DIDSTD`),
  KEY  (`HOSPCODE`,`PID`),
  KEY (`HOSPCODE`),
  KEY (`DATETIME_ADMIT`),
  KEY (`WARDSTAY`),
  KEY (`TYPEDRUG`),
  KEY (`DIDSTD`),
  KEY (`DATESTART`),
  KEY  (`DATEFINISH`),
  KEY  (`HOSPCODE`,`AN`),
  KEY  (`AN`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT i.*,p.cid FROM drug_ipd i INNER JOIN person p ON i.HOSPCODE=p.HOSPCODE AND i.PID=p.PID
WHERE  DATESTART BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') ;

DROP TABLE IF  EXISTS tmp_planthai_drug_use_ipd;
CREATE  TABLE IF NOT EXISTS 
tmp_planthai_drug_use_ipd (INDEX(HOSPCODE),INDEX(PID),INDEX(SEQ)) 
ENGINE=MYISAM IGNORE AS 
SELECT
e.HOSPCODE,
e.PID,
e.AN SEQ,
e.DATESTART DATE_SERV,
e.DIDSTD,
e.AMOUNT,
e.DRUGPRICE,
e.DRUGCOST,
d.didstd PASS,
d.drug_name,
d.drug_type ,
d.ed
FROM 
tmp_drug_ipd  e 
LEFT JOIN cdrug_planthai d ON d.didstd=e.DIDSTD 
WHERE
e.DATESTART BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIDSTD,2) IN ('41','42') 
;

DROP TABLE IF  EXISTS t_ttm_ipd_16;
CREATE TABLE IF NOT EXISTS t_ttm_ipd_16( 
PRIMARY KEY (hospcode,code_rep),
KEY (hospcode),
KEY (code_rep)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
e.HOSPCODE ,
IFNULL(e.code_rep,CONCAT(@rep_year,'-07')) code_rep,
IFNULL(
IF(e.code_name=1,'มกราคม',
IF(e.code_name=2,'กุมภาพันธ์',
IF(e.code_name=3,'มีนาคม',
IF(e.code_name=4,'เมษายน',
IF(e.code_name=5,'พฤษภาคม',
IF(e.code_name=6,'มิถุนายน',
IF(e.code_name=7,'กรกฏาคม',
IF(e.code_name=8,'สิงหาคม',
IF(e.code_name=9,'กันยายน',
IF(e.code_name=10,'ตุลาคม',
IF(e.code_name=11,'พฤศจิกายน',
'ธันวาคม')))))))))))
,'กรกฏาคม') code_name,
IFNULL(e.year_rep,@rep_year) year_rep,
IFNULL(e.all_visit,0) all_visit,
IFNULL(e.all_drug,0) all_drug,
IFNULL(e.uc_visit,0) uc_visit,
IFNULL(e.uc_drug,0) uc_drug,
IFNULL(e.all_visit_error,0) all_visit_error,
IFNULL(e.all_drug_error,0) all_drug_error,
IFNULL(e.uc_visit_error,0) uc_visit_error,
IFNULL(e.uc_drug_error,0) uc_drug_error
FROM chospital o 
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE, 
LEFT(DATE(e.DATE_SERV),7) code_rep,
MONTH(e.DATE_SERV) code_name,
@rep_year year_rep, 
COUNT(DISTINCT e.SEQ) as all_visit, 
COUNT(*) as all_drug, 
COUNT(DISTINCT (IF(s.INSTYPE='0100',e.SEQ,NULL))) as uc_visit , 
COUNT(IF(s.INSTYPE='0100',1,NULL)) as uc_drug,
COUNT(DISTINCT IF(e.PASS IS NULL,e.SEQ,NULL)) as all_visit_error, 
COUNT(IF(e.PASS IS NULL,e.SEQ,NULL)) as all_drug_error, 
COUNT(DISTINCT (IF(s.INSTYPE='0100' AND e.PASS IS NULL,e.SEQ,NULL))) as uc_visit_error , 
COUNT(IF(s.INSTYPE='0100' AND e.PASS IS NULL,1,NULL)) as uc_drug_error  
FROM 
tmp_planthai_drug_use_ipd e
LEFT JOIN tmp_admission s ON e.HOSPCODE = s.HOSPCODE AND e.PID = s.PID AND e.SEQ = s.AN 
GROUP BY e.HOSPCODE, MONTH(e.DATE_SERV) ) e ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid  AND e.code_rep IS NOT NULL ;

/*************************ttmp17***************/
DROP TABLE IF  EXISTS t_ttm_ipd_17;
CREATE TABLE IF NOT EXISTS t_ttm_ipd_17( 
PRIMARY KEY (hospcode,servplace,age,sex),
KEY (hospcode),
KEY (servplace),
KEY (age),
KEY (sex)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
e.HOSPCODE ,
e.servplace,
e.age,
e.sex,
@rep_year year_rep,

IFNULL(e.total_pt_q1,0) total_pt_q1,	
IFNULL(e.total_q1,0) total_q1,
IFNULL(e.didstd_q1,0) didstd_q1,

IFNULL(e.total_pt_q2,0) total_pt_q2,	
IFNULL(e.total_q2,0) total_q2,
IFNULL(e.didstd_q2,0) didstd_q2,

IFNULL(e.total_pt_q3,0) total_pt_q3,	
IFNULL(e.total_q3,0) total_q3,
IFNULL(e.didstd_q3,0) didstd_q3,	

IFNULL(e.total_pt_q4,0) total_pt_q4,	
IFNULL(e.total_q4,0) total_q4,
IFNULL(e.didstd_q4,0) didstd_q4
FROM chospital o 
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE, 
e.DATE_SERV,
1 servplace,
TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'1001')) age,
p.SEX sex,
@rep_year year_rep, 

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) total_pt_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.SEQ,NULL)) total_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.SEQ,'-',e.DIDSTD),NULL)) didstd_q1,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) total_pt_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.SEQ,NULL)) total_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.SEQ,'-',e.DIDSTD),NULL)) didstd_q2,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) total_pt_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.SEQ,NULL)) total_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.SEQ,'-',e.DIDSTD),NULL)) didstd_q3,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) total_pt_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.SEQ,NULL)) total_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.SEQ,'-',e.DIDSTD),NULL)) didstd_q4 
FROM 
tmp_planthai_drug_use_ipd e
LEFT JOIN tmp_admission s ON e.HOSPCODE = s.HOSPCODE AND e.PID = s.PID AND e.SEQ = s.AN 
INNER JOIN person p ON e.HOSPCODE = p.HOSPCODE AND e.PID = p.PID 
GROUP BY e.HOSPCODE, p.SEX, TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'1001'))
) e ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.HOSPCODE IS NOT NULL ;

/*************************ttmp18***************/
DROP TABLE IF  EXISTS t_ttm_ipd_18;
CREATE TABLE IF NOT EXISTS t_ttm_ipd_18( 
PRIMARY KEY (hospcode,code_rep),
KEY (hospcode),
KEY (code_rep)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
o.hoscode hospcode,
e.didstd code_rep,
IFNULL(CONCAT(e.drug_name,', ',e.drug_type),e.didstd) code_name,
@rep_year year_rep,
IFNULL(e.all_visit,0) all_visit,
IFNULL(e.all_drug,0) all_drug,
IFNULL(e.uc_visit,0) uc_visit,
IFNULL(e.uc_drug,0) uc_drug,
IFNULL(e.all_visit_error,0) all_visit_error,
IFNULL(e.all_drug_error,0) all_drug_error,
IFNULL(e.uc_visit_error,0) uc_visit_error,
IFNULL(e.uc_drug_error,0) uc_drug_error
FROM chospital o 
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE, 
e.DIDSTD didstd,
e.drug_name, 
e.drug_type,
@rep_year year_rep, 
COUNT(DISTINCT e.SEQ) as all_visit, 
COUNT(*) as all_drug, 
COUNT(DISTINCT (IF(s.INSTYPE='0100',e.SEQ,NULL))) as uc_visit , 
COUNT(IF(s.INSTYPE='0100',1,NULL)) as uc_drug,
COUNT(DISTINCT IF(e.PASS IS NULL,e.SEQ,NULL)) as all_visit_error, 
COUNT(IF(e.PASS IS NULL,e.SEQ,NULL)) as all_drug_error, 
COUNT(DISTINCT (IF(s.INSTYPE='0100' AND e.PASS IS NULL,e.SEQ,NULL))) as uc_visit_error , 
COUNT(IF(s.INSTYPE='0100' AND e.PASS IS NULL,1,NULL)) as uc_drug_error  
FROM 
tmp_planthai_drug_use_ipd e
LEFT JOIN tmp_admission s ON e.HOSPCODE = s.HOSPCODE AND e.PID = s.PID AND e.SEQ = s.AN 
GROUP BY e.HOSPCODE, e.DIDSTD 
) e ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.didstd IS NOT NULL ;

/****************ttm19******************/
DROP TABLE IF  EXISTS t_ttm_ipd_19;
CREATE TABLE IF NOT EXISTS t_ttm_ipd_19( 
PRIMARY KEY (hospcode,code_rep),
KEY (hospcode),
KEY (code_rep)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT SQL_BIG_RESULT
e.HOSPCODE ,
LEFT(DATE(e.DATESTART),7) code_rep,
IF(MONTH(e.DATESTART)=1,'มกราคม',
IF(MONTH(e.DATESTART)=2,'กุมภาพันธ์',
IF(MONTH(e.DATESTART)=3,'มีนาคม',
IF(MONTH(e.DATESTART)=4,'เมษายน',
IF(MONTH(e.DATESTART)=5,'พฤษภาคม',
IF(MONTH(e.DATESTART)=6,'มิถุนายน',
IF(MONTH(e.DATESTART)=7,'กรกฏาคม',
IF(MONTH(e.DATESTART)=8,'สิงหาคม',
IF(MONTH(e.DATESTART)=9,'กันยายน',
IF(MONTH(e.DATESTART)=10,'ตุลาคม',
IF(MONTH(e.DATESTART)=11,'พฤศจิกายน',
'ธันวาคม'))))))))))) code_name,
@rep_year year_rep,
SUM(IF(LEFT(e.DIDSTD,2) <> '41' AND LEFT(e.DIDSTD,2) <> '42',e.AMOUNT*e.DRUGPRICE,0))  price_drug ,
SUM(IF(LEFT(e.DIDSTD,2) = '41' OR LEFT(e.DIDSTD,2) = '42',e.AMOUNT*e.DRUGPRICE,0))  price_planthai_drug
FROM 
tmp_drug_ipd e 
LEFT JOIN chospital i ON e.HOSPCODE = i.hoscode 
WHERE e.DATESTART BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930')  AND i.provcode=@provid 
GROUP BY e.HOSPCODE, MONTH(e.DATESTART);

/******************************ttm20******************/
DROP TEMPORARY TABLE IF  EXISTS tmp_planthai_procedure_ipd;
CREATE TEMPORARY TABLE IF NOT EXISTS 
tmp_planthai_procedure_ipd (INDEX(HOSPCODE),INDEX(PID),INDEX(SEQ)) 
ENGINE=MYISAM IGNORE  AS 
SELECT 
e.HOSPCODE, 
e.PID, 
e.AN SEQ, 
DATE(e.TIMESTART) DATE_SERV, 
e.PROCEDCODE, 
icd.tmtype 
FROM 
tmp_procedure_ipd e 
LEFT JOIN cicd9ttm_planthai icd ON icd.`code` = e.PROCEDCODE 
WHERE DATE(e.TIMESTART) BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND icd.`code`IS NOT NULL 
;

DROP TABLE IF  EXISTS t_ttm_ipd_20;
CREATE TABLE IF NOT EXISTS t_ttm_ipd_20( 
PRIMARY KEY (hospcode,instype),
KEY (hospcode),
KEY (instype)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
e.HOSPCODE ,
IF(e.INSTYPE='0100','UC','OTHER') instype,
IFNULL(e.year_rep,@rep_year) year_rep,

IFNULL(e.pt_nod_q1,0) pt_nod_q1,
IFNULL(e.service_nod_q1,0) service_nod_q1,
IFNULL(e.pt_obb_q1,0) pt_obb_q1,
IFNULL(e.service_obb_q1,0) service_obb_q1,
IFNULL(e.pt_cop_q1,0) pt_cop_q1,
IFNULL(e.service_cop_q1,0) service_cop_q1,
IFNULL(e.pt_other_q1,0) pt_other_q1,
IFNULL(e.service_other_q1,0) service_other_q1,
IFNULL(e.pt_total_q1,0) pt_total_q1,
IFNULL(e.service_total_q1,0) service_total_q1,

IFNULL(e.pt_nod_q2,0) pt_nod_q2,
IFNULL(e.service_nod_q2,0) service_nod_q2,
IFNULL(e.pt_obb_q2,0) pt_obb_q2,
IFNULL(e.service_obb_q2,0) service_obb_q2,
IFNULL(e.pt_cop_q2,0) pt_cop_q2,
IFNULL(e.service_cop_q2,0) service_cop_q2,
IFNULL(e.pt_other_q2,0) pt_other_q2,
IFNULL(e.service_other_q2,0) service_other_q2,
IFNULL(e.pt_total_q2,0) pt_total_q2,
IFNULL(e.service_total_q2,0) service_total_q2,

IFNULL(e.pt_nod_q3,0) pt_nod_q3,
IFNULL(e.service_nod_q3,0) service_nod_q3,
IFNULL(e.pt_obb_q3,0) pt_obb_q3,
IFNULL(e.service_obb_q3,0) service_obb_q3,
IFNULL(e.pt_cop_q3,0) pt_cop_q3,
IFNULL(e.service_cop_q3,0) service_cop_q3,
IFNULL(e.pt_other_q3,0) pt_other_q3,
IFNULL(e.service_other_q3,0) service_other_q3,
IFNULL(e.pt_total_q3,0) pt_total_q3,
IFNULL(e.service_total_q3,0) service_total_q3,

IFNULL(e.pt_nod_q4,0) pt_nod_q4,
IFNULL(e.service_nod_q4,0) service_nod_q4,
IFNULL(e.pt_obb_q4,0) pt_obb_q4,
IFNULL(e.service_obb_q4,0) service_obb_q4,
IFNULL(e.pt_cop_q4,0) pt_cop_q4,
IFNULL(e.service_cop_q4,0) service_cop_q4,
IFNULL(e.pt_other_q4,0) pt_other_q4,
IFNULL(e.service_other_q4,0) service_other_q4,
IFNULL(e.pt_total_q4,0) pt_total_q4,
IFNULL(e.service_total_q4,0) service_total_q4
FROM chospital o
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE, 
s.INSTYPE,
1 SERVPLACE,
@rep_year year_rep,  

COUNT(DISTINCT IF(e.tmtype=1 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) pt_nod_q1,
COUNT(DISTINCT IF(e.tmtype=1 AND MONTH(e.DATE_SERV) IN (10,11,12),e.SEQ,NULL)) service_nod_q1,
COUNT(DISTINCT IF(e.tmtype=2 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) pt_obb_q1,
COUNT(DISTINCT IF(e.tmtype=2 AND MONTH(e.DATE_SERV) IN (10,11,12),e.SEQ,NULL)) service_obb_q1,
COUNT(DISTINCT IF(e.tmtype=3 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) pt_cop_q1,
COUNT(DISTINCT IF(e.tmtype=3 AND MONTH(e.DATE_SERV) IN (10,11,12),e.SEQ,NULL)) service_cop_q1,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) pt_other_q1,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND MONTH(e.DATE_SERV) IN (10,11,12),e.SEQ,NULL)) service_other_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) pt_total_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.SEQ,NULL)) service_total_q1,


COUNT(DISTINCT IF(e.tmtype=1 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) pt_nod_q2,
COUNT(DISTINCT IF(e.tmtype=1 AND MONTH(e.DATE_SERV) IN (1,2,3),e.SEQ,NULL)) service_nod_q2,
COUNT(DISTINCT IF(e.tmtype=2 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) pt_obb_q2,
COUNT(DISTINCT IF(e.tmtype=2 AND MONTH(e.DATE_SERV) IN (1,2,3),e.SEQ,NULL)) service_obb_q2,
COUNT(DISTINCT IF(e.tmtype=3 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) pt_cop_q2,
COUNT(DISTINCT IF(e.tmtype=3 AND MONTH(e.DATE_SERV) IN (1,2,3),e.SEQ,NULL)) service_cop_q2,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) pt_other_q2,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND MONTH(e.DATE_SERV) IN (1,2,3),e.SEQ,NULL)) service_other_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) pt_total_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.SEQ,NULL)) service_total_q2,


COUNT(DISTINCT IF(e.tmtype=1 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) pt_nod_q3,
COUNT(DISTINCT IF(e.tmtype=1 AND MONTH(e.DATE_SERV) IN (4,5,6),e.SEQ,NULL)) service_nod_q3,
COUNT(DISTINCT IF(e.tmtype=2 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) pt_obb_q3,
COUNT(DISTINCT IF(e.tmtype=2 AND MONTH(e.DATE_SERV) IN (4,5,6),e.SEQ,NULL)) service_obb_q3,
COUNT(DISTINCT IF(e.tmtype=3 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) pt_cop_q3,
COUNT(DISTINCT IF(e.tmtype=3 AND MONTH(e.DATE_SERV) IN (4,5,6),e.SEQ,NULL)) service_cop_q3,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) pt_other_q3,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND MONTH(e.DATE_SERV) IN (4,5,6),e.SEQ,NULL)) service_other_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) pt_total_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.SEQ,NULL)) service_total_q3,


COUNT(DISTINCT IF(e.tmtype=1 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) pt_nod_q4,
COUNT(DISTINCT IF(e.tmtype=1 AND MONTH(e.DATE_SERV) IN (7,8,9),e.SEQ,NULL)) service_nod_q4,
COUNT(DISTINCT IF(e.tmtype=2 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) pt_obb_q4,
COUNT(DISTINCT IF(e.tmtype=2 AND MONTH(e.DATE_SERV) IN (7,8,9),e.SEQ,NULL)) service_obb_q4,
COUNT(DISTINCT IF(e.tmtype=3 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) pt_cop_q4,
COUNT(DISTINCT IF(e.tmtype=3 AND MONTH(e.DATE_SERV) IN (7,8,9),e.SEQ,NULL)) service_cop_q4,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) pt_other_q4,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND MONTH(e.DATE_SERV) IN (7,8,9),e.SEQ,NULL)) service_other_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) pt_total_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.SEQ,NULL)) service_total_q4,

NOW() 
FROM 
tmp_planthai_procedure_ipd e 
LEFT JOIN tmp_admission s ON s.HOSPCODE = e.HOSPCODE AND s.PID = e.PID AND s.AN = e.SEQ 
GROUP BY e.HOSPCODE,  IF(s.INSTYPE='0100','UC','OTHER') 
) e ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.HOSPCODE IS NOT NULL;


 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.630264;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:439;a:5:{i:0;s:35:"DROP PROCEDURE IF EXISTS t_ttm21_25";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.630264;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:440;a:5:{i:0;s:35:"DROP PROCEDURE IF EXISTS t_ttm21_25";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.6926639;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:442;a:5:{i:0;s:19458:"CREATE PROCEDURE t_ttm21_25()
 BEGIN 
SET @provid = '58';
SET @id:= '69';
SET @rep_year = (SELECT yearprocess FROM sys_config LIMIT 1);

/*******************ttm21***********************/
DROP TEMPORARY TABLE IF  EXISTS tmp_planthai_diag_u_ipd;
CREATE TEMPORARY TABLE IF NOT EXISTS 
tmp_planthai_diag_u_ipd (INDEX(HOSPCODE),INDEX(PID),INDEX(SEQ)) 
ENGINE=MYISAM  IGNORE AS 
SELECT 
e.HOSPCODE, 
e.PID, 
e.AN SEQ, 
DATE(e.DATETIME_ADMIT) DATE_SERV, 
e.DIAGCODE, 
d.AN DRUG ,
TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'1001')) age,
p.SEX 
FROM 
tmp_diag_ipd e 
LEFT JOIN person p ON e.HOSPCODE = p.HOSPCODE AND e.PID = p.PID 
LEFT JOIN tmp_drug_ipd d ON d.HOSPCODE = e.HOSPCODE AND d.PID = e.PID AND d.AN = e.AN AND LEFT(d.DIDSTD,2) IN ('41','42') 
WHERE DATE(e.DATETIME_ADMIT) BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIAGCODE,1) = 'U' AND LEFT(e.DIAGCODE,3)<>'U77' 
;

DROP TABLE IF  EXISTS t_ttm_ipd_21;
CREATE TABLE IF NOT EXISTS t_ttm_ipd_21( 
PRIMARY KEY (hospcode,instype,diagcode,age,sex),
KEY (hospcode),
KEY (instype),
KEY (diagcode),
KEY (age),
KEY (sex)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
e.HOSPCODE ,
IF(e.INSTYPE='0100','UC','OTHER') instype,
e.DIAGCODE diagcode,
e.diseasename,
IFNULL(e.year_rep,@rep_year) year_rep,
IFNULL(e.age,0) age,
e.sex,

IFNULL(e.total_pt_q1,0) total_pt_q1,	
IFNULL(e.total_q1,0) total_q1,

IFNULL(e.total_pt_q2,0) total_pt_q2,	
IFNULL(e.total_q2,0) total_q2,

IFNULL(e.total_pt_q3,0) total_pt_q3,	
IFNULL(e.total_q3,0) total_q3,

IFNULL(e.total_pt_q4,0) total_pt_q4,	
IFNULL(e.total_q4,0) total_q4,
IFNULL(e.total_drug,0) total_drug
FROM chospital o
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE, 
s.INSTYPE,
e.DIAGCODE,
IFNULL(d.diseasethai,e.DIAGCODE) diseasename,
@rep_year year_rep,  
e.age age,
e.SEX sex,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) total_pt_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.SEQ,NULL)) total_q1,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) total_pt_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.SEQ,NULL)) total_q2,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) total_pt_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.SEQ,NULL)) total_q3,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) total_pt_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.SEQ,NULL)) total_q4,

COUNT(DISTINCT e.DRUG) total_drug
FROM 
tmp_planthai_diag_u_ipd e 
LEFT JOIN tmp_admission s ON s.HOSPCODE = e.HOSPCODE AND s.PID = e.PID AND s.AN = e.SEQ 
LEFT JOIN cdisease d ON d.diagcode = e.DIAGCODE 
WHERE e.SEX IN (1,2)
GROUP BY e.HOSPCODE, IF(s.INSTYPE='0100','UC','OTHER'), e.DIAGCODE , e.age , e.SEX 
) e ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.HOSPCODE IS NOT NULL ;

/****************************ttm22*********************/
DROP TABLE IF  EXISTS t_ttm_ipd_22;
CREATE TABLE IF NOT EXISTS t_ttm_ipd_22( 
PRIMARY KEY (hospcode,instype),
KEY (hospcode),
KEY (instype)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT SQL_BIG_RESULT 
e.HOSPCODE ,
IF(s.INSTYPE='0100','UC','OTHER') instype,
@rep_year year_rep,

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) ed_pt_q1,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) non_ed_pt_q1,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) other_pt_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) total_pt_q1,	

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (10,11,12),e.SEQ,NULL)) ed_q1,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (10,11,12),e.SEQ,NULL)) non_ed_q1,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (10,11,12),e.SEQ,NULL)) other_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.SEQ,NULL)) total_q1,	

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) ed_pt_q2,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) non_ed_pt_q2,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) other_pt_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) total_pt_q2,	

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (1,2,3),e.SEQ,NULL)) ed_q2,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (1,2,3),e.SEQ,NULL)) non_ed_q2,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (1,2,3),e.SEQ,NULL)) other_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.SEQ,NULL)) total_q2,	

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) ed_pt_q3,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) non_ed_pt_q3,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) other_pt_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) total_pt_q3,	

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (4,5,6),e.SEQ,NULL)) ed_q3,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (4,5,6),e.SEQ,NULL)) non_ed_q3,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (4,5,6),e.SEQ,NULL)) other_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.SEQ,NULL)) total_q3,	
 
COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) ed_pt_q4,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) non_ed_pt_q4,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) other_pt_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) total_pt_q4,	

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (7,8,9),e.SEQ,NULL)) ed_q4,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (7,8,9),e.SEQ,NULL)) non_ed_q4,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (7,8,9),e.SEQ,NULL)) other_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.SEQ,NULL)) total_q4 
FROM 
(
SELECT
e.HOSPCODE,
e.PID,
e.AN SEQ,
e.DATESTART DATE_SERV,
e.DIDSTD,
d.didstd PASS,
d.drug_name,
d.drug_type,
d.ed   
FROM 
tmp_drug_ipd e 
LEFT JOIN cdrug_planthai d ON d.didstd=e.DIDSTD 
WHERE 
e.DATESTART BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIDSTD,2) IN ('41','42') 
) e
LEFT JOIN tmp_admission s ON e.HOSPCODE = s.HOSPCODE AND e.PID = s.PID AND e.SEQ = s.AN 
LEFT JOIN chospital o ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.HOSPCODE IS NOT NULL  AND e.DIDSTD IS NOT NULL 
GROUP BY e.HOSPCODE, IF(s.INSTYPE='0100','UC','OTHER');

/**************************ttm23********************/
DROP TEMPORARY TABLE IF  EXISTS diag_u77_ipd;
CREATE TEMPORARY TABLE IF NOT EXISTS 
diag_u77_ipd (INDEX(pcucode,instype,age)) 
ENGINE=MYISAM IGNORE AS 
SELECT SQL_BIG_RESULT
e.HOSPCODE pcucode, 
IF(s.INSTYPE='0100','UC','OTHER') instype, 
TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'1001')) age,
COUNT(DISTINCT IF(MONTH(e.DATETIME_ADMIT) IN (10,11,12) ,e.AN,NULL)) total_u77_q1,
COUNT(DISTINCT IF(MONTH(e.DATETIME_ADMIT) IN (1,2,3) ,e.AN,NULL)) total_u77_q2,
COUNT(DISTINCT IF(MONTH(e.DATETIME_ADMIT) IN (4,5,6) ,e.AN,NULL)) total_u77_q3,
COUNT(DISTINCT IF(MONTH(e.DATETIME_ADMIT) IN (7,8,9) ,e.AN,NULL)) total_u77_q4,
COUNT(DISTINCT e.AN) total_u77
FROM 
tmp_diag_ipd e 
LEFT JOIN tmp_admission s ON s.HOSPCODE = e.HOSPCODE AND s.PID = e.PID AND s.AN = e.AN 
LEFT JOIN person p ON e.HOSPCODE = p.HOSPCODE AND e.PID = p.PID 
WHERE DATE(e.DATETIME_ADMIT) BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIAGCODE,3) = 'U77' 
GROUP BY e.HOSPCODE,  IF(s.INSTYPE='0100','UC','OTHER'), TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'1001'))
;

DROP TEMPORARY TABLE IF  EXISTS proced_u77_ipd;
CREATE TEMPORARY TABLE IF NOT EXISTS 
proced_u77_ipd (INDEX(pcucode,instype,age)) 
ENGINE=MYISAM IGNORE AS 
SELECT SQL_BIG_RESULT 
e.HOSPCODE pcucode, 
IF(s.INSTYPE='0100','UC','OTHER') instype, 
TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'-10-01')) age,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,e.PID,NULL)) total_planthai_pt_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,e.SEQ,NULL)) total_planthai_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),e.PID,NULL)) total_pt_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),e.SEQ,NULL)) total_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,e.PID,NULL)) total_planthai_pt_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,e.SEQ,NULL)) total_planthai_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),e.PID,NULL)) total_pt_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),e.SEQ,NULL)) total_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,e.PID,NULL)) total_planthai_pt_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,e.SEQ,NULL)) total_planthai_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),e.PID,NULL)) total_pt_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),e.SEQ,NULL)) total_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,e.PID,NULL)) total_planthai_pt_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,e.SEQ,NULL)) total_planthai_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),e.PID,NULL)) total_pt_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),e.SEQ,NULL)) total_q4
FROM 
(
SELECT 
e.HOSPCODE, 
e.PID, 
e.AN SEQ, 
DATE(e.TIMESTART) DATE_SERV, 
e.PROCEDCODE 
FROM 
tmp_procedure_ipd e 
LEFT JOIN tmp_diag_ipd d ON d.HOSPCODE = e.HOSPCODE AND d.PID = e.PID AND d.AN = e.AN 
WHERE DATE(e.TIMESTART) BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007903','9007904','9007998','9007999') 
AND LEFT(d.DIAGCODE,3) = 'U77' 
) e 
LEFT JOIN tmp_admission s ON s.HOSPCODE = e.HOSPCODE AND s.PID = e.PID AND s.AN = e.SEQ 
LEFT JOIN person p ON e.HOSPCODE = p.HOSPCODE AND e.PID = p.PID 
WHERE e.HOSPCODE IS NOT NULL 
GROUP BY e.HOSPCODE,  IF(s.INSTYPE='0100','UC','OTHER'), TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'1001'))
;

DROP TABLE IF  EXISTS t_ttm_ipd_23;
CREATE TABLE IF NOT EXISTS t_ttm_ipd_23( 
PRIMARY KEY (hospcode,instype,age),
KEY (hospcode),
KEY (instype),
KEY (age)
) ENGINE=MyISAM DEFAULT CHARSET=utf8  IGNORE AS
SELECT SQL_BIG_RESULT 
e.pcucode hospcode, 
e.instype, 
e.age,
@rep_year year_rep, 
e.total_u77_q1,
IFNULL(p.total_planthai_pt_q1,0) total_planthai_pt_q1,
IFNULL(p.total_planthai_q1,0) total_planthai_q1,
IFNULL(p.total_pt_q1,0) total_pt_q1,
IFNULL(p.total_q1,0) total_q1,
e.total_u77_q2,
IFNULL(p.total_planthai_pt_q2,0) total_planthai_pt_q2,
IFNULL(p.total_planthai_q2,0) total_planthai_q2,
IFNULL(p.total_pt_q2,0) total_pt_q2,
IFNULL(p.total_q2,0) total_q2,
e.total_u77_q3,
IFNULL(p.total_planthai_pt_q3,0) total_planthai_pt_q3,
IFNULL(p.total_planthai_q3,0) total_planthai_q3,
IFNULL(p.total_pt_q3,0) total_pt_q3,
IFNULL(p.total_q3,0) total_q3,
e.total_u77_q4,
IFNULL(p.total_planthai_pt_q4,0) total_planthai_pt_q4,
IFNULL(p.total_planthai_q4,0) total_planthai_q4,
IFNULL(p.total_pt_q4,0) total_pt_q4,
IFNULL(p.total_q4,0) total_q4,
(IFNULL(p.total_planthai_q1,0)+IFNULL(p.total_planthai_q2,0)+IFNULL(p.total_planthai_q3,0)+IFNULL(p.total_planthai_q4,0)) total_planthai,
(IFNULL(p.total_q1,0)+IFNULL(p.total_q2,0)+IFNULL(p.total_q3,0)+IFNULL(p.total_q4,0)) total_choice,
e.total_u77
FROM 
diag_u77_ipd e 
LEFT JOIN proced_u77_ipd p ON p.pcucode = e.pcucode AND p.instype = e.instype AND p.age = e.age 
LEFT JOIN chospital o ON e.pcucode = o.hoscode 
WHERE o.provcode=@provid ;

/**********************ttm24***************************/
DROP TEMPORARY TABLE IF  EXISTS tmp_planthai_ipd_no_z;
CREATE TEMPORARY TABLE IF NOT EXISTS 
tmp_planthai_ipd_no_z (INDEX(HOSPCODE),INDEX(code_rep)) 
ENGINE=MYISAM IGNORE AS 
SELECT SQL_BIG_RESULT
e.HOSPCODE,
LEFT(DATE(e.DATETIME_ADMIT),7) code_rep,
IF(MONTH(e.DATETIME_ADMIT)=1,'มกราคม',
IF(MONTH(e.DATETIME_ADMIT)=2,'กุมภาพันธ์',
IF(MONTH(e.DATETIME_ADMIT)=3,'มีนาคม',
IF(MONTH(e.DATETIME_ADMIT)=4,'เมษายน',
IF(MONTH(e.DATETIME_ADMIT)=5,'พฤษภาคม',
IF(MONTH(e.DATETIME_ADMIT)=6,'มิถุนายน',
IF(MONTH(e.DATETIME_ADMIT)=7,'กรกฏาคม',
IF(MONTH(e.DATETIME_ADMIT)=8,'สิงหาคม',
IF(MONTH(e.DATETIME_ADMIT)=9,'กันยายน',
IF(MONTH(e.DATETIME_ADMIT)=10,'ตุลาคม',
IF(MONTH(e.DATETIME_ADMIT)=11,'พฤศจิกายน',
'ธันวาคม'))))))))))) code_name, 
COUNT(DISTINCT e.SEQ) OP_SERVICE,
COUNT(DISTINCT e.PID) OP_SERVICE_PT
FROM tmp_admission e 
LEFT JOIN tmp_diag_ipd d ON d.HOSPCODE = e.HOSPCODE AND d.PID = e.PID AND d.AN = e.AN AND DATE(d.DATETIME_ADMIT) BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
WHERE DATE(e.DATETIME_ADMIT) BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(d.DIAGCODE,1) <> 'Z'
GROUP BY e.HOSPCODE, MONTH(e.DATETIME_ADMIT)
;

DROP TEMPORARY TABLE IF  EXISTS tmp_ttm_service_ipd;
CREATE TEMPORARY TABLE IF NOT EXISTS 
tmp_ttm_service_ipd (
`HOSPCODE`  char(5) NOT NULL ,
`PID`  varchar(16) NOT NULL ,
`SEQ`  varchar(16) NOT NULL ,
`DATE_SERV`  date NULL ,
PRIMARY KEY (`HOSPCODE`, `PID`, `SEQ`)
);

INSERT IGNORE INTO tmp_ttm_service_ipd 
SELECT e.HOSPCODE, 
e.PID,
e.AN SEQ, 
DATE(e.DATETIME_ADMIT) DATE_SERV 
FROM tmp_diag_ipd e 
WHERE DATE(e.DATETIME_ADMIT) BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIAGCODE,1) = 'U';

INSERT IGNORE INTO tmp_ttm_service_ipd
SELECT e.HOSPCODE, 
e.PID,
e.AN SEQ, 
e.DATESTART DATE_SERV 
FROM drug_ipd e 
WHERE e.DATESTART BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIDSTD,2) IN ('41','42') ;

INSERT IGNORE INTO tmp_ttm_service_ipd
SELECT e.HOSPCODE, 
e.PID,
e.AN SEQ, 
DATE(e.TIMESTART) DATE_SERV 
FROM tmp_procedure_ipd  e 
LEFT JOIN cicd9ttm_planthai p ON e.PROCEDCODE=p.`code` 
WHERE DATE(e.TIMESTART) BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND p.code IS NOT NULL ;

DROP TABLE IF  EXISTS t_ttm_ipd_24;
CREATE TABLE IF NOT EXISTS t_ttm_ipd_24( 
PRIMARY KEY (hospcode,code_rep),
KEY (hospcode),
KEY (code_rep)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
o.hoscode hospcode,
IFNULL(e.code_rep,CONCAT(@rep_year,'-10')) code_rep,
IFNULL(e.code_name,'ตุลาคม') code_name,
@rep_year year_rep,
IFNULL(e.OP_SERVICE_PT,0) op_service_pt,
IFNULL(e.OP_SERVICE,0) op_service,
IFNULL(t.TM_SERVICE_PT,0) tm_service_pt,
IFNULL(t.TM_SERVICE,0) tm_service
FROM chospital o 
LEFT JOIN 
tmp_planthai_ipd_no_z e ON e.HOSPCODE = o.hoscode 
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE,
LEFT(DATE(e.DATE_SERV),7) code_rep,
COUNT(DISTINCT e.SEQ) TM_SERVICE, 
COUNT(DISTINCT e.PID) TM_SERVICE_PT 
FROM
tmp_ttm_service_ipd e
GROUP BY e.HOSPCODE, LEFT(DATE(e.DATE_SERV),7)
) t ON t.HOSPCODE = e.HOSPCODE AND t.code_rep = e.code_rep

WHERE o.provcode=@provid 
HAVING op_service<>0  ; 

/****************************************ttm25********************/
DROP TABLE IF  EXISTS t_ttm_ipd_25;
CREATE TABLE IF NOT EXISTS t_ttm_ipd_25( 
PRIMARY KEY (hospcode,instype,didstd),
KEY (hospcode),
KEY (instype),
KEY (didstd)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS

SELECT 
o.hoscode hospcode, 
e.didstd, 
IFNULL(CONCAT(e.drug_name,', ',e.drug_type),e.didstd) code_name, 
IF(e.INSTYPE='0100','UC','OTHER') instype, 
@rep_year year_rep, 

IFNULL(e.total_pt_q1,0) total_pt_q1, 
IFNULL(e.total_q1,0) total_q1, 
IFNULL(e.total_amount_q1,0) total_amount_q1, 
IFNULL(e.total_price_q1,0) total_price_q1, 
IFNULL(e.total_cost_q1,0) total_cost_q1, 

IFNULL(e.total_pt_q2,0) total_pt_q2, 
IFNULL(e.total_q2,0) total_q2, 
IFNULL(e.total_amount_q2,0) total_amount_q2, 
IFNULL(e.total_price_q2,0) total_price_q2, 
IFNULL(e.total_cost_q2,0) total_cost_q2, 

IFNULL(e.total_pt_q3,0) total_pt_q3, 
IFNULL(e.total_q3,0) total_q3, 
IFNULL(e.total_amount_q3,0) total_amount_q3, 
IFNULL(e.total_price_q3,0) total_price_q3, 
IFNULL(e.total_cost_q3,0) total_cost_q3, 

IFNULL(e.total_pt_q4,0) total_pt_q4, 
IFNULL(e.total_q4,0) total_q4, 
IFNULL(e.total_amount_q4,0) total_amount_q4, 
IFNULL(e.total_price_q4,0) total_price_q4, 
IFNULL(e.total_cost_q4,0) total_cost_q4 
FROM chospital o 
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE, 
e.DIDSTD didstd,
e.drug_name, 
e.drug_type,
s.INSTYPE,
@rep_year year_rep, 

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) total_pt_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.SEQ,NULL)) total_q1,
SUM(IF(MONTH(e.DATE_SERV) IN (10,11,12),e.AMOUNT,0)) total_amount_q1,
SUM(IF(MONTH(e.DATE_SERV) IN (10,11,12),e.AMOUNT*e.DRUGPRICE,0)) total_price_q1,
SUM(IF(MONTH(e.DATE_SERV) IN (10,11,12),e.AMOUNT*e.DRUGCOST,0)) total_cost_q1,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) total_pt_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.SEQ,NULL)) total_q2,
SUM(IF(MONTH(e.DATE_SERV) IN (1,2,3),e.AMOUNT,0)) total_amount_q2,
SUM(IF(MONTH(e.DATE_SERV) IN (1,2,3),e.AMOUNT*e.DRUGPRICE,0)) total_price_q2,
SUM(IF(MONTH(e.DATE_SERV) IN (1,2,3),e.AMOUNT*e.DRUGCOST,0)) total_cost_q2,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) total_pt_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.SEQ,NULL)) total_q3,
SUM(IF(MONTH(e.DATE_SERV) IN (4,5,6),e.AMOUNT,0)) total_amount_q3,
SUM(IF(MONTH(e.DATE_SERV) IN (4,5,6),e.AMOUNT*e.DRUGPRICE,0)) total_price_q3,
SUM(IF(MONTH(e.DATE_SERV) IN (4,5,6),e.AMOUNT*e.DRUGCOST,0)) total_cost_q3,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) total_pt_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.SEQ,NULL)) total_q4,
SUM(IF(MONTH(e.DATE_SERV) IN (7,8,9),e.AMOUNT,0)) total_amount_q4,
SUM(IF(MONTH(e.DATE_SERV) IN (7,8,9),e.AMOUNT*e.DRUGPRICE,0)) total_price_q4,
SUM(IF(MONTH(e.DATE_SERV) IN (7,8,9),e.AMOUNT*e.DRUGCOST,0)) total_cost_q4

FROM 
 tmp_planthai_drug_use_ipd e
LEFT JOIN tmp_admission s ON e.HOSPCODE = s.HOSPCODE AND e.PID = s.PID AND e.SEQ = s.AN 
GROUP BY e.HOSPCODE,IF(s.INSTYPE='0100','UC','OTHER'), e.DIDSTD 
) e ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.HOSPCODE IS NOT NULL  AND e.didstd IS NOT NULL 



;
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.6926639;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:443;a:5:{i:0;s:19458:"CREATE PROCEDURE t_ttm21_25()
 BEGIN 
SET @provid = '58';
SET @id:= '69';
SET @rep_year = (SELECT yearprocess FROM sys_config LIMIT 1);

/*******************ttm21***********************/
DROP TEMPORARY TABLE IF  EXISTS tmp_planthai_diag_u_ipd;
CREATE TEMPORARY TABLE IF NOT EXISTS 
tmp_planthai_diag_u_ipd (INDEX(HOSPCODE),INDEX(PID),INDEX(SEQ)) 
ENGINE=MYISAM  IGNORE AS 
SELECT 
e.HOSPCODE, 
e.PID, 
e.AN SEQ, 
DATE(e.DATETIME_ADMIT) DATE_SERV, 
e.DIAGCODE, 
d.AN DRUG ,
TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'1001')) age,
p.SEX 
FROM 
tmp_diag_ipd e 
LEFT JOIN person p ON e.HOSPCODE = p.HOSPCODE AND e.PID = p.PID 
LEFT JOIN tmp_drug_ipd d ON d.HOSPCODE = e.HOSPCODE AND d.PID = e.PID AND d.AN = e.AN AND LEFT(d.DIDSTD,2) IN ('41','42') 
WHERE DATE(e.DATETIME_ADMIT) BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIAGCODE,1) = 'U' AND LEFT(e.DIAGCODE,3)<>'U77' 
;

DROP TABLE IF  EXISTS t_ttm_ipd_21;
CREATE TABLE IF NOT EXISTS t_ttm_ipd_21( 
PRIMARY KEY (hospcode,instype,diagcode,age,sex),
KEY (hospcode),
KEY (instype),
KEY (diagcode),
KEY (age),
KEY (sex)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
e.HOSPCODE ,
IF(e.INSTYPE='0100','UC','OTHER') instype,
e.DIAGCODE diagcode,
e.diseasename,
IFNULL(e.year_rep,@rep_year) year_rep,
IFNULL(e.age,0) age,
e.sex,

IFNULL(e.total_pt_q1,0) total_pt_q1,	
IFNULL(e.total_q1,0) total_q1,

IFNULL(e.total_pt_q2,0) total_pt_q2,	
IFNULL(e.total_q2,0) total_q2,

IFNULL(e.total_pt_q3,0) total_pt_q3,	
IFNULL(e.total_q3,0) total_q3,

IFNULL(e.total_pt_q4,0) total_pt_q4,	
IFNULL(e.total_q4,0) total_q4,
IFNULL(e.total_drug,0) total_drug
FROM chospital o
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE, 
s.INSTYPE,
e.DIAGCODE,
IFNULL(d.diseasethai,e.DIAGCODE) diseasename,
@rep_year year_rep,  
e.age age,
e.SEX sex,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) total_pt_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.SEQ,NULL)) total_q1,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) total_pt_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.SEQ,NULL)) total_q2,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) total_pt_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.SEQ,NULL)) total_q3,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) total_pt_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.SEQ,NULL)) total_q4,

COUNT(DISTINCT e.DRUG) total_drug
FROM 
tmp_planthai_diag_u_ipd e 
LEFT JOIN tmp_admission s ON s.HOSPCODE = e.HOSPCODE AND s.PID = e.PID AND s.AN = e.SEQ 
LEFT JOIN cdisease d ON d.diagcode = e.DIAGCODE 
WHERE e.SEX IN (1,2)
GROUP BY e.HOSPCODE, IF(s.INSTYPE='0100','UC','OTHER'), e.DIAGCODE , e.age , e.SEX 
) e ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.HOSPCODE IS NOT NULL ;

/****************************ttm22*********************/
DROP TABLE IF  EXISTS t_ttm_ipd_22;
CREATE TABLE IF NOT EXISTS t_ttm_ipd_22( 
PRIMARY KEY (hospcode,instype),
KEY (hospcode),
KEY (instype)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT SQL_BIG_RESULT 
e.HOSPCODE ,
IF(s.INSTYPE='0100','UC','OTHER') instype,
@rep_year year_rep,

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) ed_pt_q1,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) non_ed_pt_q1,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) other_pt_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) total_pt_q1,	

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (10,11,12),e.SEQ,NULL)) ed_q1,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (10,11,12),e.SEQ,NULL)) non_ed_q1,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (10,11,12),e.SEQ,NULL)) other_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.SEQ,NULL)) total_q1,	

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) ed_pt_q2,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) non_ed_pt_q2,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) other_pt_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) total_pt_q2,	

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (1,2,3),e.SEQ,NULL)) ed_q2,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (1,2,3),e.SEQ,NULL)) non_ed_q2,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (1,2,3),e.SEQ,NULL)) other_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.SEQ,NULL)) total_q2,	

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) ed_pt_q3,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) non_ed_pt_q3,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) other_pt_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) total_pt_q3,	

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (4,5,6),e.SEQ,NULL)) ed_q3,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (4,5,6),e.SEQ,NULL)) non_ed_q3,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (4,5,6),e.SEQ,NULL)) other_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.SEQ,NULL)) total_q3,	
 
COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) ed_pt_q4,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) non_ed_pt_q4,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) other_pt_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) total_pt_q4,	

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (7,8,9),e.SEQ,NULL)) ed_q4,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (7,8,9),e.SEQ,NULL)) non_ed_q4,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (7,8,9),e.SEQ,NULL)) other_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.SEQ,NULL)) total_q4 
FROM 
(
SELECT
e.HOSPCODE,
e.PID,
e.AN SEQ,
e.DATESTART DATE_SERV,
e.DIDSTD,
d.didstd PASS,
d.drug_name,
d.drug_type,
d.ed   
FROM 
tmp_drug_ipd e 
LEFT JOIN cdrug_planthai d ON d.didstd=e.DIDSTD 
WHERE 
e.DATESTART BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIDSTD,2) IN ('41','42') 
) e
LEFT JOIN tmp_admission s ON e.HOSPCODE = s.HOSPCODE AND e.PID = s.PID AND e.SEQ = s.AN 
LEFT JOIN chospital o ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.HOSPCODE IS NOT NULL  AND e.DIDSTD IS NOT NULL 
GROUP BY e.HOSPCODE, IF(s.INSTYPE='0100','UC','OTHER');

/**************************ttm23********************/
DROP TEMPORARY TABLE IF  EXISTS diag_u77_ipd;
CREATE TEMPORARY TABLE IF NOT EXISTS 
diag_u77_ipd (INDEX(pcucode,instype,age)) 
ENGINE=MYISAM IGNORE AS 
SELECT SQL_BIG_RESULT
e.HOSPCODE pcucode, 
IF(s.INSTYPE='0100','UC','OTHER') instype, 
TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'1001')) age,
COUNT(DISTINCT IF(MONTH(e.DATETIME_ADMIT) IN (10,11,12) ,e.AN,NULL)) total_u77_q1,
COUNT(DISTINCT IF(MONTH(e.DATETIME_ADMIT) IN (1,2,3) ,e.AN,NULL)) total_u77_q2,
COUNT(DISTINCT IF(MONTH(e.DATETIME_ADMIT) IN (4,5,6) ,e.AN,NULL)) total_u77_q3,
COUNT(DISTINCT IF(MONTH(e.DATETIME_ADMIT) IN (7,8,9) ,e.AN,NULL)) total_u77_q4,
COUNT(DISTINCT e.AN) total_u77
FROM 
tmp_diag_ipd e 
LEFT JOIN tmp_admission s ON s.HOSPCODE = e.HOSPCODE AND s.PID = e.PID AND s.AN = e.AN 
LEFT JOIN person p ON e.HOSPCODE = p.HOSPCODE AND e.PID = p.PID 
WHERE DATE(e.DATETIME_ADMIT) BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIAGCODE,3) = 'U77' 
GROUP BY e.HOSPCODE,  IF(s.INSTYPE='0100','UC','OTHER'), TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'1001'))
;

DROP TEMPORARY TABLE IF  EXISTS proced_u77_ipd;
CREATE TEMPORARY TABLE IF NOT EXISTS 
proced_u77_ipd (INDEX(pcucode,instype,age)) 
ENGINE=MYISAM IGNORE AS 
SELECT SQL_BIG_RESULT 
e.HOSPCODE pcucode, 
IF(s.INSTYPE='0100','UC','OTHER') instype, 
TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'-10-01')) age,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,e.PID,NULL)) total_planthai_pt_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,e.SEQ,NULL)) total_planthai_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),e.PID,NULL)) total_pt_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),e.SEQ,NULL)) total_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,e.PID,NULL)) total_planthai_pt_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,e.SEQ,NULL)) total_planthai_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),e.PID,NULL)) total_pt_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),e.SEQ,NULL)) total_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,e.PID,NULL)) total_planthai_pt_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,e.SEQ,NULL)) total_planthai_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),e.PID,NULL)) total_pt_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),e.SEQ,NULL)) total_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,e.PID,NULL)) total_planthai_pt_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,e.SEQ,NULL)) total_planthai_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),e.PID,NULL)) total_pt_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),e.SEQ,NULL)) total_q4
FROM 
(
SELECT 
e.HOSPCODE, 
e.PID, 
e.AN SEQ, 
DATE(e.TIMESTART) DATE_SERV, 
e.PROCEDCODE 
FROM 
tmp_procedure_ipd e 
LEFT JOIN tmp_diag_ipd d ON d.HOSPCODE = e.HOSPCODE AND d.PID = e.PID AND d.AN = e.AN 
WHERE DATE(e.TIMESTART) BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007903','9007904','9007998','9007999') 
AND LEFT(d.DIAGCODE,3) = 'U77' 
) e 
LEFT JOIN tmp_admission s ON s.HOSPCODE = e.HOSPCODE AND s.PID = e.PID AND s.AN = e.SEQ 
LEFT JOIN person p ON e.HOSPCODE = p.HOSPCODE AND e.PID = p.PID 
WHERE e.HOSPCODE IS NOT NULL 
GROUP BY e.HOSPCODE,  IF(s.INSTYPE='0100','UC','OTHER'), TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'1001'))
;

DROP TABLE IF  EXISTS t_ttm_ipd_23;
CREATE TABLE IF NOT EXISTS t_ttm_ipd_23( 
PRIMARY KEY (hospcode,instype,age),
KEY (hospcode),
KEY (instype),
KEY (age)
) ENGINE=MyISAM DEFAULT CHARSET=utf8  IGNORE AS
SELECT SQL_BIG_RESULT 
e.pcucode hospcode, 
e.instype, 
e.age,
@rep_year year_rep, 
e.total_u77_q1,
IFNULL(p.total_planthai_pt_q1,0) total_planthai_pt_q1,
IFNULL(p.total_planthai_q1,0) total_planthai_q1,
IFNULL(p.total_pt_q1,0) total_pt_q1,
IFNULL(p.total_q1,0) total_q1,
e.total_u77_q2,
IFNULL(p.total_planthai_pt_q2,0) total_planthai_pt_q2,
IFNULL(p.total_planthai_q2,0) total_planthai_q2,
IFNULL(p.total_pt_q2,0) total_pt_q2,
IFNULL(p.total_q2,0) total_q2,
e.total_u77_q3,
IFNULL(p.total_planthai_pt_q3,0) total_planthai_pt_q3,
IFNULL(p.total_planthai_q3,0) total_planthai_q3,
IFNULL(p.total_pt_q3,0) total_pt_q3,
IFNULL(p.total_q3,0) total_q3,
e.total_u77_q4,
IFNULL(p.total_planthai_pt_q4,0) total_planthai_pt_q4,
IFNULL(p.total_planthai_q4,0) total_planthai_q4,
IFNULL(p.total_pt_q4,0) total_pt_q4,
IFNULL(p.total_q4,0) total_q4,
(IFNULL(p.total_planthai_q1,0)+IFNULL(p.total_planthai_q2,0)+IFNULL(p.total_planthai_q3,0)+IFNULL(p.total_planthai_q4,0)) total_planthai,
(IFNULL(p.total_q1,0)+IFNULL(p.total_q2,0)+IFNULL(p.total_q3,0)+IFNULL(p.total_q4,0)) total_choice,
e.total_u77
FROM 
diag_u77_ipd e 
LEFT JOIN proced_u77_ipd p ON p.pcucode = e.pcucode AND p.instype = e.instype AND p.age = e.age 
LEFT JOIN chospital o ON e.pcucode = o.hoscode 
WHERE o.provcode=@provid ;

/**********************ttm24***************************/
DROP TEMPORARY TABLE IF  EXISTS tmp_planthai_ipd_no_z;
CREATE TEMPORARY TABLE IF NOT EXISTS 
tmp_planthai_ipd_no_z (INDEX(HOSPCODE),INDEX(code_rep)) 
ENGINE=MYISAM IGNORE AS 
SELECT SQL_BIG_RESULT
e.HOSPCODE,
LEFT(DATE(e.DATETIME_ADMIT),7) code_rep,
IF(MONTH(e.DATETIME_ADMIT)=1,'มกราคม',
IF(MONTH(e.DATETIME_ADMIT)=2,'กุมภาพันธ์',
IF(MONTH(e.DATETIME_ADMIT)=3,'มีนาคม',
IF(MONTH(e.DATETIME_ADMIT)=4,'เมษายน',
IF(MONTH(e.DATETIME_ADMIT)=5,'พฤษภาคม',
IF(MONTH(e.DATETIME_ADMIT)=6,'มิถุนายน',
IF(MONTH(e.DATETIME_ADMIT)=7,'กรกฏาคม',
IF(MONTH(e.DATETIME_ADMIT)=8,'สิงหาคม',
IF(MONTH(e.DATETIME_ADMIT)=9,'กันยายน',
IF(MONTH(e.DATETIME_ADMIT)=10,'ตุลาคม',
IF(MONTH(e.DATETIME_ADMIT)=11,'พฤศจิกายน',
'ธันวาคม'))))))))))) code_name, 
COUNT(DISTINCT e.SEQ) OP_SERVICE,
COUNT(DISTINCT e.PID) OP_SERVICE_PT
FROM tmp_admission e 
LEFT JOIN tmp_diag_ipd d ON d.HOSPCODE = e.HOSPCODE AND d.PID = e.PID AND d.AN = e.AN AND DATE(d.DATETIME_ADMIT) BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
WHERE DATE(e.DATETIME_ADMIT) BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(d.DIAGCODE,1) <> 'Z'
GROUP BY e.HOSPCODE, MONTH(e.DATETIME_ADMIT)
;

DROP TEMPORARY TABLE IF  EXISTS tmp_ttm_service_ipd;
CREATE TEMPORARY TABLE IF NOT EXISTS 
tmp_ttm_service_ipd (
`HOSPCODE`  char(5) NOT NULL ,
`PID`  varchar(16) NOT NULL ,
`SEQ`  varchar(16) NOT NULL ,
`DATE_SERV`  date NULL ,
PRIMARY KEY (`HOSPCODE`, `PID`, `SEQ`)
);

INSERT IGNORE INTO tmp_ttm_service_ipd 
SELECT e.HOSPCODE, 
e.PID,
e.AN SEQ, 
DATE(e.DATETIME_ADMIT) DATE_SERV 
FROM tmp_diag_ipd e 
WHERE DATE(e.DATETIME_ADMIT) BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIAGCODE,1) = 'U';

INSERT IGNORE INTO tmp_ttm_service_ipd
SELECT e.HOSPCODE, 
e.PID,
e.AN SEQ, 
e.DATESTART DATE_SERV 
FROM drug_ipd e 
WHERE e.DATESTART BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIDSTD,2) IN ('41','42') ;

INSERT IGNORE INTO tmp_ttm_service_ipd
SELECT e.HOSPCODE, 
e.PID,
e.AN SEQ, 
DATE(e.TIMESTART) DATE_SERV 
FROM tmp_procedure_ipd  e 
LEFT JOIN cicd9ttm_planthai p ON e.PROCEDCODE=p.`code` 
WHERE DATE(e.TIMESTART) BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND p.code IS NOT NULL ;

DROP TABLE IF  EXISTS t_ttm_ipd_24;
CREATE TABLE IF NOT EXISTS t_ttm_ipd_24( 
PRIMARY KEY (hospcode,code_rep),
KEY (hospcode),
KEY (code_rep)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
o.hoscode hospcode,
IFNULL(e.code_rep,CONCAT(@rep_year,'-10')) code_rep,
IFNULL(e.code_name,'ตุลาคม') code_name,
@rep_year year_rep,
IFNULL(e.OP_SERVICE_PT,0) op_service_pt,
IFNULL(e.OP_SERVICE,0) op_service,
IFNULL(t.TM_SERVICE_PT,0) tm_service_pt,
IFNULL(t.TM_SERVICE,0) tm_service
FROM chospital o 
LEFT JOIN 
tmp_planthai_ipd_no_z e ON e.HOSPCODE = o.hoscode 
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE,
LEFT(DATE(e.DATE_SERV),7) code_rep,
COUNT(DISTINCT e.SEQ) TM_SERVICE, 
COUNT(DISTINCT e.PID) TM_SERVICE_PT 
FROM
tmp_ttm_service_ipd e
GROUP BY e.HOSPCODE, LEFT(DATE(e.DATE_SERV),7)
) t ON t.HOSPCODE = e.HOSPCODE AND t.code_rep = e.code_rep

WHERE o.provcode=@provid 
HAVING op_service<>0  ; 

/****************************************ttm25********************/
DROP TABLE IF  EXISTS t_ttm_ipd_25;
CREATE TABLE IF NOT EXISTS t_ttm_ipd_25( 
PRIMARY KEY (hospcode,instype,didstd),
KEY (hospcode),
KEY (instype),
KEY (didstd)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS

SELECT 
o.hoscode hospcode, 
e.didstd, 
IFNULL(CONCAT(e.drug_name,', ',e.drug_type),e.didstd) code_name, 
IF(e.INSTYPE='0100','UC','OTHER') instype, 
@rep_year year_rep, 

IFNULL(e.total_pt_q1,0) total_pt_q1, 
IFNULL(e.total_q1,0) total_q1, 
IFNULL(e.total_amount_q1,0) total_amount_q1, 
IFNULL(e.total_price_q1,0) total_price_q1, 
IFNULL(e.total_cost_q1,0) total_cost_q1, 

IFNULL(e.total_pt_q2,0) total_pt_q2, 
IFNULL(e.total_q2,0) total_q2, 
IFNULL(e.total_amount_q2,0) total_amount_q2, 
IFNULL(e.total_price_q2,0) total_price_q2, 
IFNULL(e.total_cost_q2,0) total_cost_q2, 

IFNULL(e.total_pt_q3,0) total_pt_q3, 
IFNULL(e.total_q3,0) total_q3, 
IFNULL(e.total_amount_q3,0) total_amount_q3, 
IFNULL(e.total_price_q3,0) total_price_q3, 
IFNULL(e.total_cost_q3,0) total_cost_q3, 

IFNULL(e.total_pt_q4,0) total_pt_q4, 
IFNULL(e.total_q4,0) total_q4, 
IFNULL(e.total_amount_q4,0) total_amount_q4, 
IFNULL(e.total_price_q4,0) total_price_q4, 
IFNULL(e.total_cost_q4,0) total_cost_q4 
FROM chospital o 
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE, 
e.DIDSTD didstd,
e.drug_name, 
e.drug_type,
s.INSTYPE,
@rep_year year_rep, 

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) total_pt_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.SEQ,NULL)) total_q1,
SUM(IF(MONTH(e.DATE_SERV) IN (10,11,12),e.AMOUNT,0)) total_amount_q1,
SUM(IF(MONTH(e.DATE_SERV) IN (10,11,12),e.AMOUNT*e.DRUGPRICE,0)) total_price_q1,
SUM(IF(MONTH(e.DATE_SERV) IN (10,11,12),e.AMOUNT*e.DRUGCOST,0)) total_cost_q1,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) total_pt_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.SEQ,NULL)) total_q2,
SUM(IF(MONTH(e.DATE_SERV) IN (1,2,3),e.AMOUNT,0)) total_amount_q2,
SUM(IF(MONTH(e.DATE_SERV) IN (1,2,3),e.AMOUNT*e.DRUGPRICE,0)) total_price_q2,
SUM(IF(MONTH(e.DATE_SERV) IN (1,2,3),e.AMOUNT*e.DRUGCOST,0)) total_cost_q2,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) total_pt_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.SEQ,NULL)) total_q3,
SUM(IF(MONTH(e.DATE_SERV) IN (4,5,6),e.AMOUNT,0)) total_amount_q3,
SUM(IF(MONTH(e.DATE_SERV) IN (4,5,6),e.AMOUNT*e.DRUGPRICE,0)) total_price_q3,
SUM(IF(MONTH(e.DATE_SERV) IN (4,5,6),e.AMOUNT*e.DRUGCOST,0)) total_cost_q3,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) total_pt_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.SEQ,NULL)) total_q4,
SUM(IF(MONTH(e.DATE_SERV) IN (7,8,9),e.AMOUNT,0)) total_amount_q4,
SUM(IF(MONTH(e.DATE_SERV) IN (7,8,9),e.AMOUNT*e.DRUGPRICE,0)) total_price_q4,
SUM(IF(MONTH(e.DATE_SERV) IN (7,8,9),e.AMOUNT*e.DRUGCOST,0)) total_cost_q4

FROM 
 tmp_planthai_drug_use_ipd e
LEFT JOIN tmp_admission s ON e.HOSPCODE = s.HOSPCODE AND e.PID = s.PID AND e.SEQ = s.AN 
GROUP BY e.HOSPCODE,IF(s.INSTYPE='0100','UC','OTHER'), e.DIDSTD 
) e ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.HOSPCODE IS NOT NULL  AND e.didstd IS NOT NULL 



;
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.8018639;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:445;a:5:{i:0;s:30:"DROP PROCEDURE IF EXISTS t_rdu";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.8018639;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:446;a:5:{i:0;s:30:"DROP PROCEDURE IF EXISTS t_rdu";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.848664;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:448;a:5:{i:0;s:2531:"CREATE PROCEDURE t_rdu()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '70';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS tmp_diag_asu;
CREATE TABLE IF NOT EXISTS tmp_diag_asu (
PRIMARY KEY (`HOSPCODE`,`PID`,`SEQ`,`GROUP_ASU_PROJECT`),
KEY(hospcode,pid,seq),
KEY (GROUP_ASU_PROJECT),
KEY(cid),KEY(hospcode),KEY(pid),KEY(seq),KEY(date_serv),KEY(diagcode),KEY(diagtype)
) ENGINE=MyISAM IGNORE  AS
SELECT o.*,a.GROUP_ASU_PROJECT FROM	tmp_diag_opd o INNER JOIN cdiag_asu a 
   ON (SUBSTR(o.DIAGCODE,1,3)=a.`CODE` OR SUBSTR(o.DIAGCODE,1,4)=a.`CODE`)
WHERE	DATE_SERV BETWEEN  @start_d AND @end_d 
GROUP BY HOSPCODE,PID,SEQ,GROUP_ASU_PROJECT;

/***ตรวจสอบการจ่ายยา ไม่มีไม่นับ****/
DELETE o  FROM tmp_diag_asu o LEFT JOIN tmp_drug_opd d ON o.hospcode=d.HOSPCODE AND o.pid=d.pid AND o.seq=d.SEQ
WHERE  d.HOSPCODE is NULL;
/**หาเฉพาะ visit ที่มีการจ่ายยาปฏิชีวนะจะมีกี่ตัวก็แล้วแต่นับมา 1 visit**/
DROP TABLE IF EXISTS tmp_drug_asu;
CREATE TABLE IF NOT EXISTS tmp_drug_asu (
	cid VARCHAR(13) DEFAULT NULL,
	PRIMARY KEY (`HOSPCODE`,`PID`,`SEQ`), 
  KEY (`HOSPCODE`,`PID`,`SEQ`),
  KEY `idx1` (`HOSPCODE`,`PID`),
  KEY `idx2` (`DATE_SERV`),
  KEY `idx4` (`DIDSTD`),
	KEY (cid)
	) ENGINE=MyISAM  AS(
SELECT y.* FROM	tmp_drug_opd y INNER JOIN cdrug_asu s ON SUBSTR(y.DIDSTD,1,19) =SUBSTR(s.drugcode,1,19)
WHERE	DATE_SERV BETWEEN  @start_d AND @end_d
GROUP BY HOSPCODE,PID,SEQ
);

/**หาเฉพาะ AN ที่มีการจ่ายยาปฏิชีวนะตามวันที่จ่ายเพื่อไป mapping กับวันที่คลอด**/
DROP TABLE IF EXISTS tmp_drug_asu_ipd;
CREATE TABLE IF NOT EXISTS tmp_drug_asu_ipd (
	cid VARCHAR(13) DEFAULT NULL,
	PRIMARY KEY (`HOSPCODE`,`PID`,`AN`,`DATETIME_ADMIT`,`TYPEDRUG`,`DIDSTD`),
  KEY (`HOSPCODE`,`PID`,`AN`),
	KEY (`HOSPCODE`,`AN`),
  KEY  (`HOSPCODE`,`PID`),
  KEY  (`DATESTART`),
  KEY  (`DATEFINISH`),
  KEY  (`DIDSTD`),
	KEY (cid)
	) ENGINE=MyISAM  AS(
SELECT y.* FROM	tmp_drug_ipd y INNER JOIN cdrug_asu s ON SUBSTR(y.DIDSTD,1,19) =SUBSTR(s.drugcode,1,19)
WHERE	(DATETIME_ADMIT BETWEEN  @start_d AND @end_d) OR (DATEFINISH  BETWEEN  @start_d AND @end_d)
GROUP BY HOSPCODE,PID,AN,DATETIME_ADMIT,TYPEDRUG,DIDSTD
);

 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.848664;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:449;a:5:{i:0;s:2531:"CREATE PROCEDURE t_rdu()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '70';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS tmp_diag_asu;
CREATE TABLE IF NOT EXISTS tmp_diag_asu (
PRIMARY KEY (`HOSPCODE`,`PID`,`SEQ`,`GROUP_ASU_PROJECT`),
KEY(hospcode,pid,seq),
KEY (GROUP_ASU_PROJECT),
KEY(cid),KEY(hospcode),KEY(pid),KEY(seq),KEY(date_serv),KEY(diagcode),KEY(diagtype)
) ENGINE=MyISAM IGNORE  AS
SELECT o.*,a.GROUP_ASU_PROJECT FROM	tmp_diag_opd o INNER JOIN cdiag_asu a 
   ON (SUBSTR(o.DIAGCODE,1,3)=a.`CODE` OR SUBSTR(o.DIAGCODE,1,4)=a.`CODE`)
WHERE	DATE_SERV BETWEEN  @start_d AND @end_d 
GROUP BY HOSPCODE,PID,SEQ,GROUP_ASU_PROJECT;

/***ตรวจสอบการจ่ายยา ไม่มีไม่นับ****/
DELETE o  FROM tmp_diag_asu o LEFT JOIN tmp_drug_opd d ON o.hospcode=d.HOSPCODE AND o.pid=d.pid AND o.seq=d.SEQ
WHERE  d.HOSPCODE is NULL;
/**หาเฉพาะ visit ที่มีการจ่ายยาปฏิชีวนะจะมีกี่ตัวก็แล้วแต่นับมา 1 visit**/
DROP TABLE IF EXISTS tmp_drug_asu;
CREATE TABLE IF NOT EXISTS tmp_drug_asu (
	cid VARCHAR(13) DEFAULT NULL,
	PRIMARY KEY (`HOSPCODE`,`PID`,`SEQ`), 
  KEY (`HOSPCODE`,`PID`,`SEQ`),
  KEY `idx1` (`HOSPCODE`,`PID`),
  KEY `idx2` (`DATE_SERV`),
  KEY `idx4` (`DIDSTD`),
	KEY (cid)
	) ENGINE=MyISAM  AS(
SELECT y.* FROM	tmp_drug_opd y INNER JOIN cdrug_asu s ON SUBSTR(y.DIDSTD,1,19) =SUBSTR(s.drugcode,1,19)
WHERE	DATE_SERV BETWEEN  @start_d AND @end_d
GROUP BY HOSPCODE,PID,SEQ
);

/**หาเฉพาะ AN ที่มีการจ่ายยาปฏิชีวนะตามวันที่จ่ายเพื่อไป mapping กับวันที่คลอด**/
DROP TABLE IF EXISTS tmp_drug_asu_ipd;
CREATE TABLE IF NOT EXISTS tmp_drug_asu_ipd (
	cid VARCHAR(13) DEFAULT NULL,
	PRIMARY KEY (`HOSPCODE`,`PID`,`AN`,`DATETIME_ADMIT`,`TYPEDRUG`,`DIDSTD`),
  KEY (`HOSPCODE`,`PID`,`AN`),
	KEY (`HOSPCODE`,`AN`),
  KEY  (`HOSPCODE`,`PID`),
  KEY  (`DATESTART`),
  KEY  (`DATEFINISH`),
  KEY  (`DIDSTD`),
	KEY (cid)
	) ENGINE=MyISAM  AS(
SELECT y.* FROM	tmp_drug_ipd y INNER JOIN cdrug_asu s ON SUBSTR(y.DIDSTD,1,19) =SUBSTR(s.drugcode,1,19)
WHERE	(DATETIME_ADMIT BETWEEN  @start_d AND @end_d) OR (DATEFINISH  BETWEEN  @start_d AND @end_d)
GROUP BY HOSPCODE,PID,AN,DATETIME_ADMIT,TYPEDRUG,DIDSTD
);

 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.9110651;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:451;a:5:{i:0;s:38:"DROP PROCEDURE IF EXISTS t_person_home";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.9110651;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:452;a:5:{i:0;s:38:"DROP PROCEDURE IF EXISTS t_person_home";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.051465;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:454;a:5:{i:0;s:414:"CREATE PROCEDURE t_person_home()
 BEGIN 
DROP TABLE IF EXISTS t_person_home;

CREATE TABLE t_person_home (
KEY (cid),
KEY (hospcode,cid),
KEY (hid)
)ENGINE=MyISAM  AS(
SELECT  SQL_BIG_RESULT 
 t.HOSPCODE,t.PID,t.CID ,CONCAT(t.HOSPCODE,t.HID) HID ,h.HOUSE_ID,h.LATITUDE,h.LONGITUDE
FROM t_person_cid t 
LEFT JOIN home h ON t.HOSPCODE = h.HOSPCODE AND t.HID = h.HID
WHERE t.TYPEAREA in (1,3,5)
);
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.051465;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:455;a:5:{i:0;s:414:"CREATE PROCEDURE t_person_home()
 BEGIN 
DROP TABLE IF EXISTS t_person_home;

CREATE TABLE t_person_home (
KEY (cid),
KEY (hospcode,cid),
KEY (hid)
)ENGINE=MyISAM  AS(
SELECT  SQL_BIG_RESULT 
 t.HOSPCODE,t.PID,t.CID ,CONCAT(t.HOSPCODE,t.HID) HID ,h.HOUSE_ID,h.LATITUDE,h.LONGITUDE
FROM t_person_cid t 
LEFT JOIN home h ON t.HOSPCODE = h.HOSPCODE AND t.HID = h.HID
WHERE t.TYPEAREA in (1,3,5)
);
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.0982649;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:457;a:5:{i:0;s:36:"DROP PROCEDURE IF EXISTS t_house_gis";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.0982649;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:458;a:5:{i:0;s:36:"DROP PROCEDURE IF EXISTS t_house_gis";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.1450651;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:460;a:5:{i:0;s:533:"CREATE PROCEDURE t_house_gis()
 BEGIN 
DROP TABLE IF EXISTS t_house_gis;
CREATE TABLE IF NOT EXISTS t_house_gis (
SELECT h.HOSPCODE,h.HID,h.HOUSE_ID,CONCAT(h.CHANGWAT,h.AMPUR,h.TAMBON,h.VILLAGE) AREACODE,h.HEADID
,'' HEAD_NAME,h.HOUSE,h.VILLAGE,h.TAMBON,tmb.tambonname TAMBON_NAMT,h.LATITUDE,h.LONGITUDE 
,if((h.LATITUDE BETWEEN 4 AND 25) and (h.LONGITUDE BETWEEN 95 AND 108),'Y',NULL) GIS
from home h 
LEFT JOIN ctambon_amp tmb on tmb.tamboncodefull = CONCAT(h.CHANGWAT,h.AMPUR,h.TAMBON)
GROUP BY h.HOSPCODE,h.HID
);
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.1450651;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:461;a:5:{i:0;s:533:"CREATE PROCEDURE t_house_gis()
 BEGIN 
DROP TABLE IF EXISTS t_house_gis;
CREATE TABLE IF NOT EXISTS t_house_gis (
SELECT h.HOSPCODE,h.HID,h.HOUSE_ID,CONCAT(h.CHANGWAT,h.AMPUR,h.TAMBON,h.VILLAGE) AREACODE,h.HEADID
,'' HEAD_NAME,h.HOUSE,h.VILLAGE,h.TAMBON,tmb.tambonname TAMBON_NAMT,h.LATITUDE,h.LONGITUDE 
,if((h.LATITUDE BETWEEN 4 AND 25) and (h.LONGITUDE BETWEEN 95 AND 108),'Y',NULL) GIS
from home h 
LEFT JOIN ctambon_amp tmb on tmb.tamboncodefull = CONCAT(h.CHANGWAT,h.AMPUR,h.TAMBON)
GROUP BY h.HOSPCODE,h.HID
);
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.191865;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:463;a:5:{i:0;s:35:"DROP PROCEDURE IF EXISTS t_home_gis";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.191865;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:464;a:5:{i:0;s:35:"DROP PROCEDURE IF EXISTS t_home_gis";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.2386651;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:466;a:5:{i:0;s:197:"CREATE PROCEDURE t_home_gis()
 BEGIN 
REPLACE INTO t_home_gis (
SELECT t.HOSPCODE,CONCAT(t.CHANGWAT,t.AMPUR,t.TAMBON,t.VILLAGE) VCODE,t.HID,t.HOUSE,t.LATITUDE,t.LONGITUDE 
FROM home t
);
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.2386651;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:467;a:5:{i:0;s:197:"CREATE PROCEDURE t_home_gis()
 BEGIN 
REPLACE INTO t_home_gis (
SELECT t.HOSPCODE,CONCAT(t.CHANGWAT,t.AMPUR,t.TAMBON,t.VILLAGE) VCODE,t.HID,t.HOUSE,t.LATITUDE,t.LONGITUDE 
FROM home t
);
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.301065;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:469;a:5:{i:0;s:32:"DROP PROCEDURE IF EXISTS tst_pop";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.301065;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:470;a:5:{i:0;s:32:"DROP PROCEDURE IF EXISTS tst_pop";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.3654649;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:472;a:5:{i:0;s:5601:"CREATE PROCEDURE tst_pop()
 BEGIN 
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS tst_pop;

CREATE TABLE `tst_pop` (
  `cid` varchar(255) NOT NULL,
  `birth` varchar(255) DEFAULT NULL,
  `sex` varchar(255) DEFAULT NULL,
  `s_age` decimal(11,2) DEFAULT NULL,
  `e_age` decimal(11,2) DEFAULT NULL,
  `pop_group` varchar(255) DEFAULT NULL,
  PRIMARY KEY (`cid`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;


REPLACE INTO tst_pop (
SELECT t.CID,t.BIRTH,t.SEX
,TIMESTAMPDIFF(MONTH,t.BIRTH,@start_d)/12
,TIMESTAMPDIFF(MONTH,t.BIRTH,@end_d)/12
,'' FROM t_person_cid t WHERE t.TYPEAREA in (1,3)
AND t.DISCHARGE =9
);

#1
UPDATE tst_pop t,tmp_labor a set t.pop_group = CONCAT(t.pop_group,',',1)
WHERE (a.cid = t.cid) AND (a.BDATE BETWEEN @start_d AND @end_d);

#2
UPDATE tst_pop t,tmp_labor a set t.pop_group = CONCAT(t.pop_group,',',2)
WHERE (a.cid = t.cid) AND a.BTYPE <> '6' AND  (a.BDATE BETWEEN @start_d AND @end_d);

#3
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',3)
WHERE  t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 6 MONTH) AND DATE_SUB(@end_d,INTERVAL 0 MONTH);

#4
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',4)
WHERE  t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 4 MONTH) AND DATE_SUB(@end_d,INTERVAL 4 MONTH);

#5
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',5)
WHERE  t.birth BETWEEN DATE_SUB(@start_d,INTERVAL 5 YEAR) AND DATE_SUB(@end_d,INTERVAL 0 YEAR);

#6
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',6)
WHERE  t.birth > DATE_SUB(@start_d,INTERVAL 7 YEAR);

#7
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',7)
WHERE  t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 1 YEAR) AND DATE_SUB(@end_d,INTERVAL 1 YEAR);

#8
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',8)
WHERE  t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 2 YEAR) AND DATE_SUB(@end_d,INTERVAL 2 YEAR);

#9
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',9)
WHERE  t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 3 YEAR) AND DATE_SUB(@end_d,INTERVAL 3 YEAR);

#10
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',10)
WHERE  t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 5 YEAR) AND DATE_SUB(@end_d,INTERVAL 5 YEAR);

#11
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',11)
WHERE   t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 12 YEAR) AND DATE_SUB(@end_d,INTERVAL 6 YEAR);

#12
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',12)
WHERE   t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 7 YEAR) AND DATE_SUB(@end_d,INTERVAL 7 YEAR);

#13
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',13)
WHERE   t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 8 YEAR) AND DATE_SUB(@end_d,INTERVAL 8 YEAR);

#14
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',14)
WHERE   t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 12 YEAR) AND DATE_SUB(@end_d,INTERVAL 12 YEAR);

#15
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',15)
WHERE   t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 12 YEAR) AND DATE_SUB(@end_d,INTERVAL 6 YEAR);

#16
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',16)
WHERE   t.birth >  DATE_SUB(@start_d,INTERVAL 12 YEAR);

#17
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',17)
WHERE   t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 18 YEAR) AND DATE_SUB(@end_d,INTERVAL 18 YEAR);

#18
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',18)
WHERE   t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 19 YEAR) AND DATE_SUB(@end_d,INTERVAL 15 YEAR)
AND t.sex=2;

#19
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',19)
WHERE   t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 20 YEAR) AND DATE_SUB(@end_d,INTERVAL 15 YEAR)
AND t.sex=2;

#20
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',20)
WHERE   t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 60 YEAR) AND DATE_SUB(@end_d,INTERVAL 30 YEAR)
AND t.sex=2;

#21
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',21)
WHERE   t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 70 YEAR) AND DATE_SUB(@end_d,INTERVAL 30 YEAR)
AND t.sex=2;

#22
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',22)
WHERE   t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 120 YEAR) AND DATE_SUB(@end_d,INTERVAL 35 YEAR);

#23
UPDATE tst_pop t,(
SELECT o.CID,d.codemental FROM tmp_diag_opd o, cdisease d WHERE o.diagcode= d.diagcode AND d.codemental is not NULL
) a SET t.pop_group = CONCAT(t.pop_group,',',23)
WHERE t.cid = a.CID;

#24
UPDATE tst_pop t,(
SELECT t.cid from t_dmht t WHERE  FIND_IN_SET('E',t.t_mix_dx) AND NOT FIND_IN_SET('I',t.t_mix_dx)
) a SET t.pop_group = CONCAT(t.pop_group,',',24)
WHERE t.cid = a.CID;

#25
UPDATE tst_pop t,(
SELECT t.cid from t_dmht t WHERE  FIND_IN_SET('I',t.t_mix_dx) AND NOT FIND_IN_SET('E',t.t_mix_dx)
) a SET t.pop_group = CONCAT(t.pop_group,',',25)
WHERE t.cid = a.CID;

#26
UPDATE tst_pop t,(
SELECT t.cid from t_dmht t WHERE  FIND_IN_SET('E',t.t_mix_dx) AND  FIND_IN_SET('I',t.t_mix_dx)
) a SET t.pop_group = CONCAT(t.pop_group,',',26)
WHERE t.cid = a.CID;

#27
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',27)
WHERE   t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 120 YEAR) AND DATE_SUB(@end_d,INTERVAL 60 YEAR);

#28
UPDATE tst_pop t,(

SELECT t.HOSPCODE,t.PID,p.CID from disability t
LEFT JOIN t_person_cid p on p.HOSPCODE = t.HOSPCODE AND p.PID = t.PID

) a SET t.pop_group = CONCAT(t.pop_group,',',28)
WHERE t.cid = a.CID;
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.3654649;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:473;a:5:{i:0;s:5601:"CREATE PROCEDURE tst_pop()
 BEGIN 
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS tst_pop;

CREATE TABLE `tst_pop` (
  `cid` varchar(255) NOT NULL,
  `birth` varchar(255) DEFAULT NULL,
  `sex` varchar(255) DEFAULT NULL,
  `s_age` decimal(11,2) DEFAULT NULL,
  `e_age` decimal(11,2) DEFAULT NULL,
  `pop_group` varchar(255) DEFAULT NULL,
  PRIMARY KEY (`cid`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;


REPLACE INTO tst_pop (
SELECT t.CID,t.BIRTH,t.SEX
,TIMESTAMPDIFF(MONTH,t.BIRTH,@start_d)/12
,TIMESTAMPDIFF(MONTH,t.BIRTH,@end_d)/12
,'' FROM t_person_cid t WHERE t.TYPEAREA in (1,3)
AND t.DISCHARGE =9
);

#1
UPDATE tst_pop t,tmp_labor a set t.pop_group = CONCAT(t.pop_group,',',1)
WHERE (a.cid = t.cid) AND (a.BDATE BETWEEN @start_d AND @end_d);

#2
UPDATE tst_pop t,tmp_labor a set t.pop_group = CONCAT(t.pop_group,',',2)
WHERE (a.cid = t.cid) AND a.BTYPE <> '6' AND  (a.BDATE BETWEEN @start_d AND @end_d);

#3
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',3)
WHERE  t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 6 MONTH) AND DATE_SUB(@end_d,INTERVAL 0 MONTH);

#4
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',4)
WHERE  t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 4 MONTH) AND DATE_SUB(@end_d,INTERVAL 4 MONTH);

#5
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',5)
WHERE  t.birth BETWEEN DATE_SUB(@start_d,INTERVAL 5 YEAR) AND DATE_SUB(@end_d,INTERVAL 0 YEAR);

#6
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',6)
WHERE  t.birth > DATE_SUB(@start_d,INTERVAL 7 YEAR);

#7
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',7)
WHERE  t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 1 YEAR) AND DATE_SUB(@end_d,INTERVAL 1 YEAR);

#8
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',8)
WHERE  t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 2 YEAR) AND DATE_SUB(@end_d,INTERVAL 2 YEAR);

#9
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',9)
WHERE  t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 3 YEAR) AND DATE_SUB(@end_d,INTERVAL 3 YEAR);

#10
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',10)
WHERE  t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 5 YEAR) AND DATE_SUB(@end_d,INTERVAL 5 YEAR);

#11
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',11)
WHERE   t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 12 YEAR) AND DATE_SUB(@end_d,INTERVAL 6 YEAR);

#12
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',12)
WHERE   t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 7 YEAR) AND DATE_SUB(@end_d,INTERVAL 7 YEAR);

#13
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',13)
WHERE   t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 8 YEAR) AND DATE_SUB(@end_d,INTERVAL 8 YEAR);

#14
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',14)
WHERE   t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 12 YEAR) AND DATE_SUB(@end_d,INTERVAL 12 YEAR);

#15
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',15)
WHERE   t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 12 YEAR) AND DATE_SUB(@end_d,INTERVAL 6 YEAR);

#16
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',16)
WHERE   t.birth >  DATE_SUB(@start_d,INTERVAL 12 YEAR);

#17
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',17)
WHERE   t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 18 YEAR) AND DATE_SUB(@end_d,INTERVAL 18 YEAR);

#18
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',18)
WHERE   t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 19 YEAR) AND DATE_SUB(@end_d,INTERVAL 15 YEAR)
AND t.sex=2;

#19
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',19)
WHERE   t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 20 YEAR) AND DATE_SUB(@end_d,INTERVAL 15 YEAR)
AND t.sex=2;

#20
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',20)
WHERE   t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 60 YEAR) AND DATE_SUB(@end_d,INTERVAL 30 YEAR)
AND t.sex=2;

#21
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',21)
WHERE   t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 70 YEAR) AND DATE_SUB(@end_d,INTERVAL 30 YEAR)
AND t.sex=2;

#22
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',22)
WHERE   t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 120 YEAR) AND DATE_SUB(@end_d,INTERVAL 35 YEAR);

#23
UPDATE tst_pop t,(
SELECT o.CID,d.codemental FROM tmp_diag_opd o, cdisease d WHERE o.diagcode= d.diagcode AND d.codemental is not NULL
) a SET t.pop_group = CONCAT(t.pop_group,',',23)
WHERE t.cid = a.CID;

#24
UPDATE tst_pop t,(
SELECT t.cid from t_dmht t WHERE  FIND_IN_SET('E',t.t_mix_dx) AND NOT FIND_IN_SET('I',t.t_mix_dx)
) a SET t.pop_group = CONCAT(t.pop_group,',',24)
WHERE t.cid = a.CID;

#25
UPDATE tst_pop t,(
SELECT t.cid from t_dmht t WHERE  FIND_IN_SET('I',t.t_mix_dx) AND NOT FIND_IN_SET('E',t.t_mix_dx)
) a SET t.pop_group = CONCAT(t.pop_group,',',25)
WHERE t.cid = a.CID;

#26
UPDATE tst_pop t,(
SELECT t.cid from t_dmht t WHERE  FIND_IN_SET('E',t.t_mix_dx) AND  FIND_IN_SET('I',t.t_mix_dx)
) a SET t.pop_group = CONCAT(t.pop_group,',',26)
WHERE t.cid = a.CID;

#27
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',27)
WHERE   t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 120 YEAR) AND DATE_SUB(@end_d,INTERVAL 60 YEAR);

#28
UPDATE tst_pop t,(

SELECT t.HOSPCODE,t.PID,p.CID from disability t
LEFT JOIN t_person_cid p on p.HOSPCODE = t.HOSPCODE AND p.PID = t.PID

) a SET t.pop_group = CONCAT(t.pop_group,',',28)
WHERE t.cid = a.CID;
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.427866;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:475;a:5:{i:0;s:43:"DROP PROCEDURE IF EXISTS tst_add_cid_to_kpi";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.427866;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:476;a:5:{i:0;s:43:"DROP PROCEDURE IF EXISTS tst_add_cid_to_kpi";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.4902661;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:478;a:5:{i:0;s:12947:"CREATE PROCEDURE tst_add_cid_to_kpi()
 BEGIN 
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

#1
DROP TABLE IF EXISTS tst_kpi1;
CREATE TABLE tst_kpi1 (
SELECT @b_year+543 as byear,l.cid ,CURDATE() dupdate
FROM	tmp_labor l  INNER JOIN t_person_anc a ON l.cid=a.cid AND l.bdate =a.bdate AND a.g1_ga <=12
WHERE l.BDATE BETWEEN @start_d AND @end_d  GROUP BY l.cid
);

#2
DROP TABLE IF EXISTS tst_kpi2;
CREATE TABLE tst_kpi2 (
SELECT @b_year+543 as byear,l.cid ,CURDATE() dupdate
FROM	tmp_labor l  INNER JOIN t_person_anc a ON l.cid=a.cid AND l.bdate =a.bdate 
AND a.g1_date is not null AND a.g2_date is not null AND a.g3_date is not null 
AND a.g4_date is not null AND a.g5_date is not null
WHERE l.BDATE BETWEEN @start_d AND @end_d  GROUP BY l.cid
);

#3
DROP TABLE IF EXISTS tst_kpi3;
CREATE TABLE tst_kpi3 (
SELECT @b_year+543 as byear,a.cid ,CURDATE() dupdate
FROM tmp_anc a 
INNER JOIN tmp_drug_opd d on a.cid = d.CID 
AND d.DIDSTD in('201120320037726221781506','201110100019999920381199','101110000003082121781506'
,'201110100019999920381341','201110100019999921881341')
WHERE a.DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY a.cid
);

#4
DROP TABLE IF EXISTS tst_kpi4;
CREATE TABLE tst_kpi4 (
SELECT @b_year+543 as byear,'' cid ,CURDATE() dupdate
);

#5
DROP TABLE IF EXISTS tst_kpi5;
CREATE TABLE tst_kpi5 (
SELECT @b_year+543 as byear,p.cid ,CURDATE() dupdate
FROM prenatal t 
INNER JOIN t_person_cid p ON p.hospcode = t.hospcode AND p.pid = t.pid
WHERE t.HCT_RESULT <= 33  AND t.DATE_HCT BETWEEN @start_d AND @end_d
GROUP BY p.CID
);

#6
DROP TABLE IF EXISTS tst_kpi6;
CREATE TABLE tst_kpi6 (
SELECT @b_year+543 as byear,a.cid ,CURDATE() dupdate
FROM  t_postnatal a 
INNER JOIN tmp_labor l on l.cid = a.cid AND l.BDATE BETWEEN @start_d AND @end_d AND l.BTYPE NOT IN(6)
WHERE a.ppcare1 is not null AND a.ppcare2 is not null AND a.ppcare3 is not null 
GROUP BY l.cid
);

#7
DROP TABLE IF EXISTS tst_kpi7;
CREATE TABLE tst_kpi7 (
SELECT @b_year+543 as byear,t.cid ,CURDATE() dupdate
FROM (
SELECT n.HOSPCODE,n.PID,p.CID,p.BIRTH,n.DATE_SERV,n.FOOD,DATE_FORMAT(n.DATE_SERV,'%m') m
FROM nutrition n INNER JOIN person p ON n.HOSPCODE=p.HOSPCODE AND n.PID=p.PID 
WHERE n.DATE_SERV BETWEEN @start_d AND @end_d AND n.FOOD in('1')
GROUP BY n.HOSPCODE,n.PID
HAVING TIMESTAMPDIFF(MONTH,p.BIRTH,n.DATE_SERV) BETWEEN 0 AND 6 
ORDER BY n.DATE_SERV DESC
) t GROUP BY t.CID
);

#8
DROP TABLE IF EXISTS tst_kpi8;
CREATE TABLE tst_kpi8 (
SELECT @b_year+543 as byear,e.cid ,CURDATE() dupdate
FROM tmp_epi e WHERE e.VACCINETYPE in('401')
AND e.DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY e.cid
);

#9
DROP TABLE IF EXISTS tst_kpi9;
CREATE TABLE tst_kpi9 (
SELECT @b_year+543 as byear,t.cid ,CURDATE() dupdate
FROM t_childdev_specialpp t WHERE (INSTR(t.status1,'1') or INSTR(t.status2,'1'))
AND t.date_serv_first BETWEEN @start_d AND @end_d 
GROUP BY t.cid

);

#10
DROP TABLE IF EXISTS tst_kpi10;
CREATE TABLE tst_kpi10 (
SELECT @b_year+543 as byear,p.cid ,CURDATE() dupdate
FROM t_nutrition_service n 
INNER JOIN t_person_cid p ON p.HOSPCODE = n.hospcode AND p.PID = n.pid
WHERE TIMESTAMPDIFF(YEAR,n.birth,n.DATE_SERV) <= 5
AND nutri2 in(3,4,5) AND nutri3 in(3)
);

#11
DROP TABLE IF EXISTS tst_kpi11;
CREATE TABLE tst_kpi11 (
SELECT @b_year+543 as byear,t.cid ,CURDATE() dupdate
FROM t_childdev_specialpp t 
WHERE t.sp_first ='1B261'
AND t.status2 is not NULL AND t.date_serv_first BETWEEN @start_d AND @end_d 
);

#12
DROP TABLE IF EXISTS tst_kpi12;
CREATE TABLE tst_kpi12 (
SELECT @b_year+543 as byear,n.cid ,CURDATE() dupdate
from t_nutrition05 n
WHERE n.DATE_SERV1  BETWEEN @start_d AND @end_d 
);

#13
DROP TABLE IF EXISTS tst_kpi13;
CREATE TABLE tst_kpi13 (
SELECT @b_year+543 as byear,'' cid ,CURDATE() dupdate
);

#14
DROP TABLE IF EXISTS tst_kpi14;
CREATE TABLE tst_kpi14 (
SELECT @b_year+543 as byear,t1.cid ,CURDATE() dupdate
FROM t_person_epi t1
WHERE t1.bcg_date is not null AND t1.hbv1_date is not null AND t1.opv3_date is not null AND t1.dtp3_date is not null 
AND t1.mmr1_date is not null AND t1.hbv3_date is not null AND t1.ipv2_date is not null
);

#15
DROP TABLE IF EXISTS tst_kpi15;
CREATE TABLE tst_kpi15 (
SELECT @b_year+543 as byear,t1.cid ,CURDATE() dupdate
 FROM t_person_epi t1
WHERE t1.dtp4_date is not null AND t1.opv4_date is not null 
AND ((je1_date is not null and je2_date is not null and je2_date > je1_date) or (j11_date is not null)) 
);

#16
DROP TABLE IF EXISTS tst_kpi16;
CREATE TABLE tst_kpi16 (
SELECT @b_year+543 as byear,t1.cid ,CURDATE() dupdate
 FROM t_person_epi t1
WHERE t1.mmr2_date is not null 
AND ((je1_date is not null AND je2_date is not null AND je3_date is not null 
AND je3_date > je2_date AND je2_date > je1_date)
or (je1_date is not null AND je2_date is not null AND j11_date is not null AND je2_date > je1_date AND j11_date > je2_date)
or (j11_date is not null AND j12_date is not null AND j12_date > j11_date)
or (j11_date is not null AND je1_date is not null AND je1_date > j11_date ))
);

#17
DROP TABLE IF EXISTS tst_kpi17;
CREATE TABLE tst_kpi17 (
SELECT @b_year+543 as byear,t1.cid ,CURDATE() dupdate
 FROM t_person_epi t1
WHERE t1.opv5_date is not null AND t1.dtp5_date is not null 
);

#18
DROP TABLE IF EXISTS tst_kpi18;
CREATE TABLE tst_kpi18 (
SELECT @b_year+543 as byear,p.cid ,CURDATE() dupdate
FROM t_nutrition_service n
INNER JOIN t_person_cid p on p.HOSPCODE= n.hospcode AND p.PID = n.pid
WHERE n.nutri3 in (6)
);

#19
DROP TABLE IF EXISTS tst_kpi19;
CREATE TABLE tst_kpi19 (
SELECT @b_year+543 as byear,p.cid ,CURDATE() dupdate
FROM t_nutrition_service n
INNER JOIN t_person_cid p on p.HOSPCODE= n.hospcode AND p.PID = n.pid
WHERE  nutri2 in(3,4,5) AND nutri3 in(3)

);

#20
DROP TABLE IF EXISTS tst_kpi20;
CREATE TABLE tst_kpi20 (
SELECT @b_year+543 as byear,p.cid ,CURDATE() dupdate
from dental t
INNER JOIN t_person_cid p on p.HOSPCODE = t.HOSPCODE AND p.PID = t.PID
WHERE t.DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY p.CID
);

#21
DROP TABLE IF EXISTS tst_kpi21;
CREATE TABLE tst_kpi21 (
SELECT @b_year+543 as byear,p.cid ,CURDATE() dupdate
FROM procedure_opd t
INNER JOIN t_person_cid p on p.HOSPCODE = t.HOSPCODE AND p.PID = t.PID
WHERE t.DATE_SERV BETWEEN @start_d AND @end_d  
AND t.PROCEDCODE = '2387030'
GROUP BY p.CID
);

#22
DROP TABLE IF EXISTS tst_kpi22;
CREATE TABLE tst_kpi22 (
SELECT @b_year+543 as byear,t1.cid ,CURDATE() dupdate
FROM t_person_epi t1
WHERE t1.mmrs_date IS NOT NULL
);

#23
DROP TABLE IF EXISTS tst_kpi23;
CREATE TABLE tst_kpi23(
SELECT @b_year+543 as byear,'' cid ,CURDATE() dupdate

);

#24
DROP TABLE IF EXISTS tst_kpi24;
CREATE TABLE tst_kpi24(
SELECT @b_year+543 as byear,t1.cid ,CURDATE() dupdate
FROM t_person_epi t1
WHERE t1.dts4_date IS NOT NULL
);

#25
DROP TABLE IF EXISTS tst_kpi25;
CREATE TABLE tst_kpi25(
SELECT @b_year+543 as byear,p.cid ,CURDATE() dupdate
FROM tmp_procedure_opd p
INNER JOIN cwh_dent_icd10tm i ON p.PROCEDCODE=i.ICD10TM 
WHERE DATE_SERV BETWEEN @start_d AND @end_d AND p.CID is not NULL
GROUP BY p.CID 
);

#26
DROP TABLE IF EXISTS tst_kpi26;
CREATE TABLE tst_kpi26(
SELECT @b_year+543 as byear,t.cid ,CURDATE() dupdate
from tmp_diag_opd t WHERE t.DIAGCODE LIKE 'K02%'
AND DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY t.CID
);

#27
DROP TABLE IF EXISTS tst_kpi27;
CREATE TABLE tst_kpi27(
SELECT @b_year+543 as byear,cid ,CURDATE() dupdate
from t_nutrition6up n
WHERE age_ms1 BETWEEN 72 AND 228
AND DATE_SERV1 BETWEEN @start_d AND @end_d
GROUP BY CID
);

#28
DROP TABLE IF EXISTS tst_kpi28;
CREATE TABLE tst_kpi28(
SELECT @b_year+543 as byear,'' cid ,CURDATE() dupdate

);

#29
DROP TABLE IF EXISTS tst_kpi29;
CREATE TABLE tst_kpi29(
SELECT @b_year+543 as byear,'' cid ,CURDATE() dupdate

);

#30
DROP TABLE IF EXISTS tst_kpi30;
CREATE TABLE tst_kpi30(
SELECT @b_year+543 as byear,cid ,CURDATE() dupdate
from (
SELECT d.HOSPCODE,d.PID,d.DIAGCODE,d.DATE_SERV from diagnosis_opd d WHERE LEFT(d.DIAGCODE,4) in ('Z014','Z124') 
AND d.DATE_SERV  BETWEEN DATE_SUB(@start_d,INTERVAL 5 YEAR) AND DATE_SUB(@end_d,INTERVAL 0 YEAR)
) t  INNER JOIN t_person_cid p ON p.HOSPCODE = t.hospcode AND p.PID = t.pid
GROUP BY p.CID
);

#31
DROP TABLE IF EXISTS tst_kpi31;
CREATE TABLE tst_kpi31(
SELECT @b_year+543 as byear,cid ,CURDATE() dupdate
 from (
SELECT d.HOSPCODE,d.PID,d.DIAGCODE,d.DATE_SERV from diagnosis_opd d WHERE LEFT(d.DIAGCODE,4) in ('Z123') 
AND d.DATE_SERV  BETWEEN DATE_SUB(@start_d,INTERVAL 0 YEAR) AND DATE_SUB(@end_d,INTERVAL 0 YEAR)
) t  INNER JOIN t_person_cid p ON p.HOSPCODE = t.hospcode AND p.PID = t.pid
GROUP BY p.CID
);

#32
DROP TABLE IF EXISTS tst_kpi32;
CREATE TABLE tst_kpi32(
SELECT @b_year+543 as byear,cid ,CURDATE() dupdate
from (
SELECT p.HOSPCODE,p.PID,p.CID,p.SEX,n.DATE_SERV,round(n.WAIST_CM) WAIST_CM
,n.WEIGHT,n.HEIGHT,round(n.WEIGHT/((n.HEIGHT/100)*(n.HEIGHT/100)),2) bmi
,if(p.sex='1' AND round(n.WAIST_CM)<=90,1,if(p.sex='2' AND round(n.WAIST_CM)<=80,1,0)) fat
,DATE_FORMAT(n.DATE_SERV,'%m') m
FROM t_ncdscreen n 
INNER JOIN t_person_db p ON n.HOSPCODE=p.HOSPCODE AND n.PID=p.PID 
WHERE 
n.DATE_SERV BETWEEN @start_d AND @end_d 
AND TIMESTAMPDIFF(YEAR,p.BIRTH,n.DATE_SERV)>=35 
GROUP BY p.HOSPCODE,p.PID 
HAVING fat=1
ORDER BY n.DATE_SERV
) t GROUP BY cid
);

#33
DROP TABLE IF EXISTS tst_kpi33;
CREATE TABLE tst_kpi33(
SELECT @b_year+543 as byear,cid ,CURDATE() dupdate
FROM t_person_dm_screen 
WHERE date_screen is not null AND bslevel >70
AND date_screen BETWEEN @start_d AND @end_d
GROUP BY cid
);

#34
DROP TABLE IF EXISTS tst_kpi34;
CREATE TABLE tst_kpi34(
SELECT @b_year+543 as byear,cid ,CURDATE() dupdate
FROM t_person_ht_screen   
WHERE sbp_1>50 AND dbp_1 >50
AND date_screen BETWEEN @start_d AND @end_d
GROUP BY cid
);

#35
DROP TABLE IF EXISTS tst_kpi35;
CREATE TABLE tst_kpi35(
SELECT @b_year+543 as byear,t.cid ,CURDATE() dupdate
FROM tst_pop t 
INNER JOIN tmp_diag_opd d on d.CID = t.cid  AND d.DATE_SERV BETWEEN @start_d AND @end_d
INNER JOIN cdisease c ON d.DIAGCODE = c.diagcode AND c.codemental IS NOT NULL
WHERE FIND_IN_SET('23',t.pop_group)
GROUP BY t.cid
);


#36
DROP TABLE IF EXISTS tst_kpi36;
CREATE TABLE tst_kpi36(
SELECT @b_year+543 as byear,t.cid ,CURDATE() dupdate
from t_chronic t
WHERE date_dx BETWEEN @start_d AND @end_d
AND t.diagcode LIKE 'E%'
GROUP BY t.cid
);

#37
DROP TABLE IF EXISTS tst_kpi37;
CREATE TABLE tst_kpi37(
SELECT @b_year+543 as byear,f.cid ,CURDATE() dupdate
FROM t_chronicfu f 
INNER JOIN t_dmht d ON f.cid=d.cid
WHERE  f.control_dm IN(1) AND f.ld_hba1c BETWEEN @start_d AND @end_d
GROUP BY f.cid
);

#38
DROP TABLE IF EXISTS tst_kpi38;
CREATE TABLE tst_kpi38(
SELECT @b_year+543 as byear,p.cid ,CURDATE() dupdate
FROM tmp_procedure_opd p
INNER JOIN cwh_dent_icd10tm i ON p.PROCEDCODE=i.ICD10TM 
INNER JOIN tst_pop tp ON tp.cid = p.CID AND  FIND_IN_SET('24',tp.pop_group)
WHERE DATE_SERV BETWEEN @start_d AND @end_d AND p.CID is not NULL
GROUP BY p.CID 
);

#39
DROP TABLE IF EXISTS tst_kpi39;
CREATE TABLE tst_kpi39(
SELECT @b_year+543 as byear,t.cid ,CURDATE() dupdate
 FROM t_chronicfu t
INNER JOIN tst_pop p ON p.cid = t.cid AND FIND_IN_SET('24',p.pop_group)
AND t.ld_foot BETWEEN @start_d AND @end_d
GROUP BY t.cid
);


#40
DROP TABLE IF EXISTS tst_kpi40;
CREATE TABLE tst_kpi40(
SELECT @b_year+543 as byear,t.cid ,CURDATE() dupdate
FROM t_chronicfu t
INNER JOIN tst_pop p ON p.cid = t.cid AND FIND_IN_SET('24',p.pop_group)
AND t.ld_retina BETWEEN @start_d AND @end_d
GROUP BY t.cid
);

#41
DROP TABLE IF EXISTS tst_kpi41;
CREATE TABLE tst_kpi41(
SELECT @b_year+543 as byear,t.cid ,CURDATE() dupdate
from t_chronic t
WHERE date_dx BETWEEN @start_d AND @end_d
AND t.diagcode LIKE 'I%'
GROUP BY t.cid
);

#42
DROP TABLE IF EXISTS tst_kpi42;
CREATE TABLE tst_kpi42(
SELECT @b_year+543 as byear,f.cid ,CURDATE() dupdate
FROM t_chronicfu f 
INNER JOIN t_dmht d ON f.cid=d.cid
WHERE  f.control_ht IN(1) AND f.ld_bp1 BETWEEN @start_d AND @end_d
GROUP BY f.cid
);

#43
DROP TABLE IF EXISTS tst_kpi43;
CREATE TABLE tst_kpi43(
SELECT @b_year+543 as byear,t.CID ,CURDATE() dupdate

from t_cvdrisk_fl t WHERE t.L_RISK_SCORE > 0
GROUP BY t.CID

);

#44
DROP TABLE IF EXISTS tst_kpi44;
CREATE TABLE tst_kpi44(
SELECT @b_year+543 as byear,t.CID ,CURDATE() dupdate
FROM t_adl_last_regist t
WHERE t.DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY t.CID

);

#45
DROP TABLE IF EXISTS tst_kpi45;
CREATE TABLE tst_kpi45(
SELECT @b_year+543 as byear,''CID ,CURDATE() dupdate


);

#46
DROP TABLE IF EXISTS tst_kpi46;
CREATE TABLE tst_kpi46(
SELECT @b_year+543 as byear,'' CID ,CURDATE() dupdate


);
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.4902661;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:479;a:5:{i:0;s:12947:"CREATE PROCEDURE tst_add_cid_to_kpi()
 BEGIN 
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

#1
DROP TABLE IF EXISTS tst_kpi1;
CREATE TABLE tst_kpi1 (
SELECT @b_year+543 as byear,l.cid ,CURDATE() dupdate
FROM	tmp_labor l  INNER JOIN t_person_anc a ON l.cid=a.cid AND l.bdate =a.bdate AND a.g1_ga <=12
WHERE l.BDATE BETWEEN @start_d AND @end_d  GROUP BY l.cid
);

#2
DROP TABLE IF EXISTS tst_kpi2;
CREATE TABLE tst_kpi2 (
SELECT @b_year+543 as byear,l.cid ,CURDATE() dupdate
FROM	tmp_labor l  INNER JOIN t_person_anc a ON l.cid=a.cid AND l.bdate =a.bdate 
AND a.g1_date is not null AND a.g2_date is not null AND a.g3_date is not null 
AND a.g4_date is not null AND a.g5_date is not null
WHERE l.BDATE BETWEEN @start_d AND @end_d  GROUP BY l.cid
);

#3
DROP TABLE IF EXISTS tst_kpi3;
CREATE TABLE tst_kpi3 (
SELECT @b_year+543 as byear,a.cid ,CURDATE() dupdate
FROM tmp_anc a 
INNER JOIN tmp_drug_opd d on a.cid = d.CID 
AND d.DIDSTD in('201120320037726221781506','201110100019999920381199','101110000003082121781506'
,'201110100019999920381341','201110100019999921881341')
WHERE a.DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY a.cid
);

#4
DROP TABLE IF EXISTS tst_kpi4;
CREATE TABLE tst_kpi4 (
SELECT @b_year+543 as byear,'' cid ,CURDATE() dupdate
);

#5
DROP TABLE IF EXISTS tst_kpi5;
CREATE TABLE tst_kpi5 (
SELECT @b_year+543 as byear,p.cid ,CURDATE() dupdate
FROM prenatal t 
INNER JOIN t_person_cid p ON p.hospcode = t.hospcode AND p.pid = t.pid
WHERE t.HCT_RESULT <= 33  AND t.DATE_HCT BETWEEN @start_d AND @end_d
GROUP BY p.CID
);

#6
DROP TABLE IF EXISTS tst_kpi6;
CREATE TABLE tst_kpi6 (
SELECT @b_year+543 as byear,a.cid ,CURDATE() dupdate
FROM  t_postnatal a 
INNER JOIN tmp_labor l on l.cid = a.cid AND l.BDATE BETWEEN @start_d AND @end_d AND l.BTYPE NOT IN(6)
WHERE a.ppcare1 is not null AND a.ppcare2 is not null AND a.ppcare3 is not null 
GROUP BY l.cid
);

#7
DROP TABLE IF EXISTS tst_kpi7;
CREATE TABLE tst_kpi7 (
SELECT @b_year+543 as byear,t.cid ,CURDATE() dupdate
FROM (
SELECT n.HOSPCODE,n.PID,p.CID,p.BIRTH,n.DATE_SERV,n.FOOD,DATE_FORMAT(n.DATE_SERV,'%m') m
FROM nutrition n INNER JOIN person p ON n.HOSPCODE=p.HOSPCODE AND n.PID=p.PID 
WHERE n.DATE_SERV BETWEEN @start_d AND @end_d AND n.FOOD in('1')
GROUP BY n.HOSPCODE,n.PID
HAVING TIMESTAMPDIFF(MONTH,p.BIRTH,n.DATE_SERV) BETWEEN 0 AND 6 
ORDER BY n.DATE_SERV DESC
) t GROUP BY t.CID
);

#8
DROP TABLE IF EXISTS tst_kpi8;
CREATE TABLE tst_kpi8 (
SELECT @b_year+543 as byear,e.cid ,CURDATE() dupdate
FROM tmp_epi e WHERE e.VACCINETYPE in('401')
AND e.DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY e.cid
);

#9
DROP TABLE IF EXISTS tst_kpi9;
CREATE TABLE tst_kpi9 (
SELECT @b_year+543 as byear,t.cid ,CURDATE() dupdate
FROM t_childdev_specialpp t WHERE (INSTR(t.status1,'1') or INSTR(t.status2,'1'))
AND t.date_serv_first BETWEEN @start_d AND @end_d 
GROUP BY t.cid

);

#10
DROP TABLE IF EXISTS tst_kpi10;
CREATE TABLE tst_kpi10 (
SELECT @b_year+543 as byear,p.cid ,CURDATE() dupdate
FROM t_nutrition_service n 
INNER JOIN t_person_cid p ON p.HOSPCODE = n.hospcode AND p.PID = n.pid
WHERE TIMESTAMPDIFF(YEAR,n.birth,n.DATE_SERV) <= 5
AND nutri2 in(3,4,5) AND nutri3 in(3)
);

#11
DROP TABLE IF EXISTS tst_kpi11;
CREATE TABLE tst_kpi11 (
SELECT @b_year+543 as byear,t.cid ,CURDATE() dupdate
FROM t_childdev_specialpp t 
WHERE t.sp_first ='1B261'
AND t.status2 is not NULL AND t.date_serv_first BETWEEN @start_d AND @end_d 
);

#12
DROP TABLE IF EXISTS tst_kpi12;
CREATE TABLE tst_kpi12 (
SELECT @b_year+543 as byear,n.cid ,CURDATE() dupdate
from t_nutrition05 n
WHERE n.DATE_SERV1  BETWEEN @start_d AND @end_d 
);

#13
DROP TABLE IF EXISTS tst_kpi13;
CREATE TABLE tst_kpi13 (
SELECT @b_year+543 as byear,'' cid ,CURDATE() dupdate
);

#14
DROP TABLE IF EXISTS tst_kpi14;
CREATE TABLE tst_kpi14 (
SELECT @b_year+543 as byear,t1.cid ,CURDATE() dupdate
FROM t_person_epi t1
WHERE t1.bcg_date is not null AND t1.hbv1_date is not null AND t1.opv3_date is not null AND t1.dtp3_date is not null 
AND t1.mmr1_date is not null AND t1.hbv3_date is not null AND t1.ipv2_date is not null
);

#15
DROP TABLE IF EXISTS tst_kpi15;
CREATE TABLE tst_kpi15 (
SELECT @b_year+543 as byear,t1.cid ,CURDATE() dupdate
 FROM t_person_epi t1
WHERE t1.dtp4_date is not null AND t1.opv4_date is not null 
AND ((je1_date is not null and je2_date is not null and je2_date > je1_date) or (j11_date is not null)) 
);

#16
DROP TABLE IF EXISTS tst_kpi16;
CREATE TABLE tst_kpi16 (
SELECT @b_year+543 as byear,t1.cid ,CURDATE() dupdate
 FROM t_person_epi t1
WHERE t1.mmr2_date is not null 
AND ((je1_date is not null AND je2_date is not null AND je3_date is not null 
AND je3_date > je2_date AND je2_date > je1_date)
or (je1_date is not null AND je2_date is not null AND j11_date is not null AND je2_date > je1_date AND j11_date > je2_date)
or (j11_date is not null AND j12_date is not null AND j12_date > j11_date)
or (j11_date is not null AND je1_date is not null AND je1_date > j11_date ))
);

#17
DROP TABLE IF EXISTS tst_kpi17;
CREATE TABLE tst_kpi17 (
SELECT @b_year+543 as byear,t1.cid ,CURDATE() dupdate
 FROM t_person_epi t1
WHERE t1.opv5_date is not null AND t1.dtp5_date is not null 
);

#18
DROP TABLE IF EXISTS tst_kpi18;
CREATE TABLE tst_kpi18 (
SELECT @b_year+543 as byear,p.cid ,CURDATE() dupdate
FROM t_nutrition_service n
INNER JOIN t_person_cid p on p.HOSPCODE= n.hospcode AND p.PID = n.pid
WHERE n.nutri3 in (6)
);

#19
DROP TABLE IF EXISTS tst_kpi19;
CREATE TABLE tst_kpi19 (
SELECT @b_year+543 as byear,p.cid ,CURDATE() dupdate
FROM t_nutrition_service n
INNER JOIN t_person_cid p on p.HOSPCODE= n.hospcode AND p.PID = n.pid
WHERE  nutri2 in(3,4,5) AND nutri3 in(3)

);

#20
DROP TABLE IF EXISTS tst_kpi20;
CREATE TABLE tst_kpi20 (
SELECT @b_year+543 as byear,p.cid ,CURDATE() dupdate
from dental t
INNER JOIN t_person_cid p on p.HOSPCODE = t.HOSPCODE AND p.PID = t.PID
WHERE t.DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY p.CID
);

#21
DROP TABLE IF EXISTS tst_kpi21;
CREATE TABLE tst_kpi21 (
SELECT @b_year+543 as byear,p.cid ,CURDATE() dupdate
FROM procedure_opd t
INNER JOIN t_person_cid p on p.HOSPCODE = t.HOSPCODE AND p.PID = t.PID
WHERE t.DATE_SERV BETWEEN @start_d AND @end_d  
AND t.PROCEDCODE = '2387030'
GROUP BY p.CID
);

#22
DROP TABLE IF EXISTS tst_kpi22;
CREATE TABLE tst_kpi22 (
SELECT @b_year+543 as byear,t1.cid ,CURDATE() dupdate
FROM t_person_epi t1
WHERE t1.mmrs_date IS NOT NULL
);

#23
DROP TABLE IF EXISTS tst_kpi23;
CREATE TABLE tst_kpi23(
SELECT @b_year+543 as byear,'' cid ,CURDATE() dupdate

);

#24
DROP TABLE IF EXISTS tst_kpi24;
CREATE TABLE tst_kpi24(
SELECT @b_year+543 as byear,t1.cid ,CURDATE() dupdate
FROM t_person_epi t1
WHERE t1.dts4_date IS NOT NULL
);

#25
DROP TABLE IF EXISTS tst_kpi25;
CREATE TABLE tst_kpi25(
SELECT @b_year+543 as byear,p.cid ,CURDATE() dupdate
FROM tmp_procedure_opd p
INNER JOIN cwh_dent_icd10tm i ON p.PROCEDCODE=i.ICD10TM 
WHERE DATE_SERV BETWEEN @start_d AND @end_d AND p.CID is not NULL
GROUP BY p.CID 
);

#26
DROP TABLE IF EXISTS tst_kpi26;
CREATE TABLE tst_kpi26(
SELECT @b_year+543 as byear,t.cid ,CURDATE() dupdate
from tmp_diag_opd t WHERE t.DIAGCODE LIKE 'K02%'
AND DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY t.CID
);

#27
DROP TABLE IF EXISTS tst_kpi27;
CREATE TABLE tst_kpi27(
SELECT @b_year+543 as byear,cid ,CURDATE() dupdate
from t_nutrition6up n
WHERE age_ms1 BETWEEN 72 AND 228
AND DATE_SERV1 BETWEEN @start_d AND @end_d
GROUP BY CID
);

#28
DROP TABLE IF EXISTS tst_kpi28;
CREATE TABLE tst_kpi28(
SELECT @b_year+543 as byear,'' cid ,CURDATE() dupdate

);

#29
DROP TABLE IF EXISTS tst_kpi29;
CREATE TABLE tst_kpi29(
SELECT @b_year+543 as byear,'' cid ,CURDATE() dupdate

);

#30
DROP TABLE IF EXISTS tst_kpi30;
CREATE TABLE tst_kpi30(
SELECT @b_year+543 as byear,cid ,CURDATE() dupdate
from (
SELECT d.HOSPCODE,d.PID,d.DIAGCODE,d.DATE_SERV from diagnosis_opd d WHERE LEFT(d.DIAGCODE,4) in ('Z014','Z124') 
AND d.DATE_SERV  BETWEEN DATE_SUB(@start_d,INTERVAL 5 YEAR) AND DATE_SUB(@end_d,INTERVAL 0 YEAR)
) t  INNER JOIN t_person_cid p ON p.HOSPCODE = t.hospcode AND p.PID = t.pid
GROUP BY p.CID
);

#31
DROP TABLE IF EXISTS tst_kpi31;
CREATE TABLE tst_kpi31(
SELECT @b_year+543 as byear,cid ,CURDATE() dupdate
 from (
SELECT d.HOSPCODE,d.PID,d.DIAGCODE,d.DATE_SERV from diagnosis_opd d WHERE LEFT(d.DIAGCODE,4) in ('Z123') 
AND d.DATE_SERV  BETWEEN DATE_SUB(@start_d,INTERVAL 0 YEAR) AND DATE_SUB(@end_d,INTERVAL 0 YEAR)
) t  INNER JOIN t_person_cid p ON p.HOSPCODE = t.hospcode AND p.PID = t.pid
GROUP BY p.CID
);

#32
DROP TABLE IF EXISTS tst_kpi32;
CREATE TABLE tst_kpi32(
SELECT @b_year+543 as byear,cid ,CURDATE() dupdate
from (
SELECT p.HOSPCODE,p.PID,p.CID,p.SEX,n.DATE_SERV,round(n.WAIST_CM) WAIST_CM
,n.WEIGHT,n.HEIGHT,round(n.WEIGHT/((n.HEIGHT/100)*(n.HEIGHT/100)),2) bmi
,if(p.sex='1' AND round(n.WAIST_CM)<=90,1,if(p.sex='2' AND round(n.WAIST_CM)<=80,1,0)) fat
,DATE_FORMAT(n.DATE_SERV,'%m') m
FROM t_ncdscreen n 
INNER JOIN t_person_db p ON n.HOSPCODE=p.HOSPCODE AND n.PID=p.PID 
WHERE 
n.DATE_SERV BETWEEN @start_d AND @end_d 
AND TIMESTAMPDIFF(YEAR,p.BIRTH,n.DATE_SERV)>=35 
GROUP BY p.HOSPCODE,p.PID 
HAVING fat=1
ORDER BY n.DATE_SERV
) t GROUP BY cid
);

#33
DROP TABLE IF EXISTS tst_kpi33;
CREATE TABLE tst_kpi33(
SELECT @b_year+543 as byear,cid ,CURDATE() dupdate
FROM t_person_dm_screen 
WHERE date_screen is not null AND bslevel >70
AND date_screen BETWEEN @start_d AND @end_d
GROUP BY cid
);

#34
DROP TABLE IF EXISTS tst_kpi34;
CREATE TABLE tst_kpi34(
SELECT @b_year+543 as byear,cid ,CURDATE() dupdate
FROM t_person_ht_screen   
WHERE sbp_1>50 AND dbp_1 >50
AND date_screen BETWEEN @start_d AND @end_d
GROUP BY cid
);

#35
DROP TABLE IF EXISTS tst_kpi35;
CREATE TABLE tst_kpi35(
SELECT @b_year+543 as byear,t.cid ,CURDATE() dupdate
FROM tst_pop t 
INNER JOIN tmp_diag_opd d on d.CID = t.cid  AND d.DATE_SERV BETWEEN @start_d AND @end_d
INNER JOIN cdisease c ON d.DIAGCODE = c.diagcode AND c.codemental IS NOT NULL
WHERE FIND_IN_SET('23',t.pop_group)
GROUP BY t.cid
);


#36
DROP TABLE IF EXISTS tst_kpi36;
CREATE TABLE tst_kpi36(
SELECT @b_year+543 as byear,t.cid ,CURDATE() dupdate
from t_chronic t
WHERE date_dx BETWEEN @start_d AND @end_d
AND t.diagcode LIKE 'E%'
GROUP BY t.cid
);

#37
DROP TABLE IF EXISTS tst_kpi37;
CREATE TABLE tst_kpi37(
SELECT @b_year+543 as byear,f.cid ,CURDATE() dupdate
FROM t_chronicfu f 
INNER JOIN t_dmht d ON f.cid=d.cid
WHERE  f.control_dm IN(1) AND f.ld_hba1c BETWEEN @start_d AND @end_d
GROUP BY f.cid
);

#38
DROP TABLE IF EXISTS tst_kpi38;
CREATE TABLE tst_kpi38(
SELECT @b_year+543 as byear,p.cid ,CURDATE() dupdate
FROM tmp_procedure_opd p
INNER JOIN cwh_dent_icd10tm i ON p.PROCEDCODE=i.ICD10TM 
INNER JOIN tst_pop tp ON tp.cid = p.CID AND  FIND_IN_SET('24',tp.pop_group)
WHERE DATE_SERV BETWEEN @start_d AND @end_d AND p.CID is not NULL
GROUP BY p.CID 
);

#39
DROP TABLE IF EXISTS tst_kpi39;
CREATE TABLE tst_kpi39(
SELECT @b_year+543 as byear,t.cid ,CURDATE() dupdate
 FROM t_chronicfu t
INNER JOIN tst_pop p ON p.cid = t.cid AND FIND_IN_SET('24',p.pop_group)
AND t.ld_foot BETWEEN @start_d AND @end_d
GROUP BY t.cid
);


#40
DROP TABLE IF EXISTS tst_kpi40;
CREATE TABLE tst_kpi40(
SELECT @b_year+543 as byear,t.cid ,CURDATE() dupdate
FROM t_chronicfu t
INNER JOIN tst_pop p ON p.cid = t.cid AND FIND_IN_SET('24',p.pop_group)
AND t.ld_retina BETWEEN @start_d AND @end_d
GROUP BY t.cid
);

#41
DROP TABLE IF EXISTS tst_kpi41;
CREATE TABLE tst_kpi41(
SELECT @b_year+543 as byear,t.cid ,CURDATE() dupdate
from t_chronic t
WHERE date_dx BETWEEN @start_d AND @end_d
AND t.diagcode LIKE 'I%'
GROUP BY t.cid
);

#42
DROP TABLE IF EXISTS tst_kpi42;
CREATE TABLE tst_kpi42(
SELECT @b_year+543 as byear,f.cid ,CURDATE() dupdate
FROM t_chronicfu f 
INNER JOIN t_dmht d ON f.cid=d.cid
WHERE  f.control_ht IN(1) AND f.ld_bp1 BETWEEN @start_d AND @end_d
GROUP BY f.cid
);

#43
DROP TABLE IF EXISTS tst_kpi43;
CREATE TABLE tst_kpi43(
SELECT @b_year+543 as byear,t.CID ,CURDATE() dupdate

from t_cvdrisk_fl t WHERE t.L_RISK_SCORE > 0
GROUP BY t.CID

);

#44
DROP TABLE IF EXISTS tst_kpi44;
CREATE TABLE tst_kpi44(
SELECT @b_year+543 as byear,t.CID ,CURDATE() dupdate
FROM t_adl_last_regist t
WHERE t.DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY t.CID

);

#45
DROP TABLE IF EXISTS tst_kpi45;
CREATE TABLE tst_kpi45(
SELECT @b_year+543 as byear,''CID ,CURDATE() dupdate


);

#46
DROP TABLE IF EXISTS tst_kpi46;
CREATE TABLE tst_kpi46(
SELECT @b_year+543 as byear,'' CID ,CURDATE() dupdate


);
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.537066;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:481;a:5:{i:0;s:41:"DROP PROCEDURE IF EXISTS t_version_update";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.537066;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:482;a:5:{i:0;s:41:"DROP PROCEDURE IF EXISTS t_version_update";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.5994661;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:484;a:5:{i:0;s:102:"CREATE PROCEDURE t_version_update()
 BEGIN 
UPDATE sys_version t SET t.version = '2017.01.27';
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.5994661;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:485;a:5:{i:0;s:102:"CREATE PROCEDURE t_version_update()
 BEGIN 
UPDATE sys_version t SET t.version = '2017.01.27';
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.646266;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:487;a:5:{i:0;s:35:"DROP PROCEDURE IF EXISTS hdc_all_t;";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.646266;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:150;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:488;a:5:{i:0;s:35:"DROP PROCEDURE IF EXISTS hdc_all_t;";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.7086661;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:150;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:490;a:5:{i:0;s:6477:"CREATE PROCEDURE hdc_all_t()
 BEGIN
# build at 2017-05-17 09:27:29
CALL start_process;
UPDATE sys_check_process t set t.fnc_name = 'hdc_all_t' , t.time = NOW();
TRUNCATE hdc_log;
INSERT INTO hdc_log(p_date,p_name)values(now(),'start');
#start here

INSERT INTO hdc_log(p_date,p_name)values(now(),'t_person');
CALL t_person;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_person_anc');
CALL t_person_anc;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_person_epi');
CALL t_person_epi;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_village');
CALL t_village;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_surveil');
CALL t_surveil;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_pt_surveil');
CALL t_pt_surveil;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_person_sex_age');
CALL t_person_sex_age;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_diagopd');
CALL t_diagopd;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_diagipd');
CALL t_diagipd;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_chronic');
CALL t_chronic;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_dmht');
CALL t_dmht;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_ncdscreen');
CALL t_ncdscreen;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_service');
CALL t_service;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_admission');
CALL t_admission;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_death');
CALL t_death;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_newborn');
CALL t_newborn;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_card');
CALL t_card;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_drug_opd');
CALL t_drug_opd;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_planthai');
CALL t_planthai;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_planthai1');
CALL t_planthai1;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_cmi1');
CALL t_cmi1;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_bp');
CALL t_bp;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_fp');
CALL t_fp;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_charge_opd');
CALL t_charge_opd;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_nation_labor');
CALL t_nation_labor;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_refer');
CALL t_refer;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_childdev1830');
CALL t_childdev1830;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_cmi_referin');
CALL t_cmi_referin;
INSERT INTO hdc_log(p_date,p_name)values(now(),'ws_person_dmht');
CALL ws_person_dmht;
INSERT INTO hdc_log(p_date,p_name)values(now(),'ws_person_nutrition');
CALL ws_person_nutrition;
INSERT INTO hdc_log(p_date,p_name)values(now(),'ws_person_drugallergy');
CALL ws_person_drugallergy;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_cmi_dead');
CALL t_cmi_dead;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_procedure_ipd');
CALL t_procedure_ipd;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_ckd_ill_all');
CALL t_ckd_ill_all;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_influ');
CALL t_influ;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_ckd_service');
CALL t_ckd_service;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_ckd_egfr');
CALL t_ckd_egfr;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_death_hosp');
CALL t_death_hosp;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_labor_abort');
CALL t_labor_abort;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_nutrition05');
CALL t_nutrition05;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_nutrition6');
CALL t_nutrition6;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_nutrition15');
CALL t_nutrition15;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_tb');
CALL t_tb;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_refer_sp5');
CALL t_refer_sp5;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_accident');
CALL t_accident;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_dental');
CALL t_dental;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_all_alien');
CALL t_all_alien;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_alcoholic');
CALL t_alcoholic;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_envocc');
CALL t_envocc;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_refer_4pa');
CALL t_refer_4pa;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_death28pa');
CALL t_death28pa;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_occupat_new');
CALL t_occupat_new;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_person_envocc');
CALL t_person_envocc;
INSERT INTO hdc_log(p_date,p_name)values(now(),'tmp_specialpp');
CALL tmp_specialpp;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_nutrition_service');
CALL t_nutrition_service;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_cvdrisk');
CALL t_cvdrisk;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_screen_last');
CALL t_screen_last;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_adl');
CALL t_adl;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_postnatal');
CALL t_postnatal;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_cigarette');
CALL t_cigarette;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_breast_screen');
CALL t_breast_screen;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_cervix_screen');
CALL t_cervix_screen;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_ttm1_5');
CALL t_ttm1_5;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_ttm6_10');
CALL t_ttm6_10;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_ttm11_15');
CALL t_ttm11_15;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_ttm16_20');
CALL t_ttm16_20;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_ttm21_25');
CALL t_ttm21_25;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_rdu');
CALL t_rdu;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_person_home');
CALL t_person_home;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_house_gis');
CALL t_house_gis;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_home_gis');
CALL t_home_gis;
INSERT INTO hdc_log(p_date,p_name)values(now(),'tst_pop');
CALL tst_pop;
INSERT INTO hdc_log(p_date,p_name)values(now(),'tst_add_cid_to_kpi');
CALL tst_add_cid_to_kpi;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_version_update');
CALL t_version_update;

#end here
INSERT INTO hdc_log(p_date,p_name)values(now(),'end');
CALL end_process; 

 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.7086661;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:151;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:491;a:5:{i:0;s:6477:"CREATE PROCEDURE hdc_all_t()
 BEGIN
# build at 2017-05-17 09:27:29
CALL start_process;
UPDATE sys_check_process t set t.fnc_name = 'hdc_all_t' , t.time = NOW();
TRUNCATE hdc_log;
INSERT INTO hdc_log(p_date,p_name)values(now(),'start');
#start here

INSERT INTO hdc_log(p_date,p_name)values(now(),'t_person');
CALL t_person;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_person_anc');
CALL t_person_anc;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_person_epi');
CALL t_person_epi;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_village');
CALL t_village;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_surveil');
CALL t_surveil;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_pt_surveil');
CALL t_pt_surveil;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_person_sex_age');
CALL t_person_sex_age;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_diagopd');
CALL t_diagopd;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_diagipd');
CALL t_diagipd;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_chronic');
CALL t_chronic;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_dmht');
CALL t_dmht;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_ncdscreen');
CALL t_ncdscreen;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_service');
CALL t_service;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_admission');
CALL t_admission;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_death');
CALL t_death;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_newborn');
CALL t_newborn;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_card');
CALL t_card;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_drug_opd');
CALL t_drug_opd;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_planthai');
CALL t_planthai;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_planthai1');
CALL t_planthai1;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_cmi1');
CALL t_cmi1;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_bp');
CALL t_bp;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_fp');
CALL t_fp;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_charge_opd');
CALL t_charge_opd;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_nation_labor');
CALL t_nation_labor;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_refer');
CALL t_refer;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_childdev1830');
CALL t_childdev1830;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_cmi_referin');
CALL t_cmi_referin;
INSERT INTO hdc_log(p_date,p_name)values(now(),'ws_person_dmht');
CALL ws_person_dmht;
INSERT INTO hdc_log(p_date,p_name)values(now(),'ws_person_nutrition');
CALL ws_person_nutrition;
INSERT INTO hdc_log(p_date,p_name)values(now(),'ws_person_drugallergy');
CALL ws_person_drugallergy;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_cmi_dead');
CALL t_cmi_dead;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_procedure_ipd');
CALL t_procedure_ipd;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_ckd_ill_all');
CALL t_ckd_ill_all;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_influ');
CALL t_influ;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_ckd_service');
CALL t_ckd_service;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_ckd_egfr');
CALL t_ckd_egfr;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_death_hosp');
CALL t_death_hosp;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_labor_abort');
CALL t_labor_abort;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_nutrition05');
CALL t_nutrition05;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_nutrition6');
CALL t_nutrition6;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_nutrition15');
CALL t_nutrition15;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_tb');
CALL t_tb;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_refer_sp5');
CALL t_refer_sp5;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_accident');
CALL t_accident;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_dental');
CALL t_dental;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_all_alien');
CALL t_all_alien;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_alcoholic');
CALL t_alcoholic;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_envocc');
CALL t_envocc;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_refer_4pa');
CALL t_refer_4pa;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_death28pa');
CALL t_death28pa;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_occupat_new');
CALL t_occupat_new;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_person_envocc');
CALL t_person_envocc;
INSERT INTO hdc_log(p_date,p_name)values(now(),'tmp_specialpp');
CALL tmp_specialpp;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_nutrition_service');
CALL t_nutrition_service;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_cvdrisk');
CALL t_cvdrisk;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_screen_last');
CALL t_screen_last;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_adl');
CALL t_adl;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_postnatal');
CALL t_postnatal;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_cigarette');
CALL t_cigarette;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_breast_screen');
CALL t_breast_screen;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_cervix_screen');
CALL t_cervix_screen;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_ttm1_5');
CALL t_ttm1_5;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_ttm6_10');
CALL t_ttm6_10;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_ttm11_15');
CALL t_ttm11_15;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_ttm16_20');
CALL t_ttm16_20;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_ttm21_25');
CALL t_ttm21_25;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_rdu');
CALL t_rdu;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_person_home');
CALL t_person_home;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_house_gis');
CALL t_house_gis;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_home_gis');
CALL t_home_gis;
INSERT INTO hdc_log(p_date,p_name)values(now(),'tst_pop');
CALL tst_pop;
INSERT INTO hdc_log(p_date,p_name)values(now(),'tst_add_cid_to_kpi');
CALL tst_add_cid_to_kpi;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_version_update');
CALL t_version_update;

#end here
INSERT INTO hdc_log(p_date,p_name)values(now(),'end');
CALL end_process; 

 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.755466;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:151;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:493;a:5:{i:0;s:34:"CALL zz_sys_process_running_false;";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.755466;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:152;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:494;a:5:{i:0;s:34:"CALL zz_sys_process_running_false;";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.755466;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:152;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:496;a:5:{i:0;s:17:"call hdc_all_t();";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988063.76948;i:4;a:1:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:49;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}}}}}s:2:"db";a:1:{s:8:"messages";a:323:{i:13;a:5:{i:0;s:35:"SELECT * FROM `sys_process_running`";i:1;i:80;i:2;s:21:"yii\db\Command::query";i:3;d:1494988044.3474071;i:4;a:1:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:40;s:8:"function";s:3:"one";s:5:"class";s:18:"yii\db\ActiveQuery";s:4:"type";s:2:"->";}}}i:14;a:5:{i:0;s:35:"SELECT * FROM `sys_process_running`";i:1;i:96;i:2;s:21:"yii\db\Command::query";i:3;d:1494988044.3474071;i:4;a:1:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:40;s:8:"function";s:3:"one";s:5:"class";s:18:"yii\db\ActiveQuery";s:4:"type";s:2:"->";}}}i:16;a:5:{i:0;s:44:"SHOW FULL COLUMNS FROM `sys_process_running`";i:1;i:80;i:2;s:21:"yii\db\Command::query";i:3;d:1494988044.3474071;i:4;a:1:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:40;s:8:"function";s:3:"one";s:5:"class";s:18:"yii\db\ActiveQuery";s:4:"type";s:2:"->";}}}i:17;a:5:{i:0;s:44:"SHOW FULL COLUMNS FROM `sys_process_running`";i:1;i:96;i:2;s:21:"yii\db\Command::query";i:3;d:1494988044.3474071;i:4;a:1:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:40;s:8:"function";s:3:"one";s:5:"class";s:18:"yii\db\ActiveQuery";s:4:"type";s:2:"->";}}}i:19;a:5:{i:0;s:625:"SELECT
    kcu.constraint_name,
    kcu.column_name,
    kcu.referenced_table_name,
    kcu.referenced_column_name
FROM information_schema.referential_constraints AS rc
JOIN information_schema.key_column_usage AS kcu ON
    (
        kcu.constraint_catalog = rc.constraint_catalog OR
        (kcu.constraint_catalog IS NULL AND rc.constraint_catalog IS NULL)
    ) AND
    kcu.constraint_schema = rc.constraint_schema AND
    kcu.constraint_name = rc.constraint_name
WHERE rc.constraint_schema = database() AND kcu.table_schema = database()
AND rc.table_name = 'sys_process_running' AND kcu.table_name = 'sys_process_running'";i:1;i:80;i:2;s:21:"yii\db\Command::query";i:3;d:1494988044.3474071;i:4;a:1:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:40;s:8:"function";s:3:"one";s:5:"class";s:18:"yii\db\ActiveQuery";s:4:"type";s:2:"->";}}}i:20;a:5:{i:0;s:625:"SELECT
    kcu.constraint_name,
    kcu.column_name,
    kcu.referenced_table_name,
    kcu.referenced_column_name
FROM information_schema.referential_constraints AS rc
JOIN information_schema.key_column_usage AS kcu ON
    (
        kcu.constraint_catalog = rc.constraint_catalog OR
        (kcu.constraint_catalog IS NULL AND rc.constraint_catalog IS NULL)
    ) AND
    kcu.constraint_schema = rc.constraint_schema AND
    kcu.constraint_name = rc.constraint_name
WHERE rc.constraint_schema = database() AND kcu.table_schema = database()
AND rc.table_name = 'sys_process_running' AND kcu.table_name = 'sys_process_running'";i:1;i:96;i:2;s:21:"yii\db\Command::query";i:3;d:1494988044.3474071;i:4;a:1:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:40;s:8:"function";s:3:"one";s:5:"class";s:18:"yii\db\ActiveQuery";s:4:"type";s:2:"->";}}}i:22;a:5:{i:0;s:335:" CREATE TABLE IF NOT EXISTS `sys_transform_all` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `t_name` varchar(100) DEFAULT NULL,
  `t_sql` longtext,
  `active` varchar(1) DEFAULT '1',
  `bycase` varchar(15) DEFAULT NULL,
  `version` varchar(14) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=MyISAM AUTO_INCREMENT=59 DEFAULT CHARSET=utf8; ";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988044.3474071;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:67;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:23;a:5:{i:0;s:335:" CREATE TABLE IF NOT EXISTS `sys_transform_all` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `t_name` varchar(100) DEFAULT NULL,
  `t_sql` longtext,
  `active` varchar(1) DEFAULT '1',
  `bycase` varchar(15) DEFAULT NULL,
  `version` varchar(14) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=MyISAM AUTO_INCREMENT=59 DEFAULT CHARSET=utf8; ";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988044.394208;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:67;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:25;a:5:{i:0;s:27:"TRUNCATE sys_transform_all;";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988049.39604;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:71;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:26;a:5:{i:0;s:27:"TRUNCATE sys_transform_all;";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988049.4428401;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:71;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:28;a:5:{i:0;s:123:"INSERT INTO sys_transform_all (SELECT '',t.t_name,t.t_sql,t.active,t.bycase,t.version FROM sys_transform t  ORDER BY t.id);";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988049.4428401;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:73;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:29;a:5:{i:0;s:123:"INSERT INTO sys_transform_all (SELECT '',t.t_name,t.t_sql,t.active,t.bycase,t.version FROM sys_transform t  ORDER BY t.id);";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988049.583241;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:73;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:31;a:5:{i:0;s:128:"INSERT INTO sys_transform_all (SELECT '',t.t_name,t.t_sql,t.active,t.bycase,t.version FROM sys_transform_plus t  ORDER BY t.id);";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988049.583241;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:75;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:32;a:5:{i:0;s:128:"INSERT INTO sys_transform_all (SELECT '',t.t_name,t.t_sql,t.active,t.bycase,t.version FROM sys_transform_plus t  ORDER BY t.id);";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988049.676841;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:75;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:34;a:5:{i:0;s:24:"SELECT DATABASE() as db;";i:1;i:80;i:2;s:21:"yii\db\Command::query";i:3;d:1494988049.676841;i:4;a:2:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:78;s:8:"function";s:8:"queryOne";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:35;a:5:{i:0;s:24:"SELECT DATABASE() as db;";i:1;i:96;i:2;s:21:"yii\db\Command::query";i:3;d:1494988049.676841;i:4;a:2:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:78;s:8:"function";s:8:"queryOne";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:37;a:5:{i:0;s:44:"select provcode from sys_config_main limit 1";i:1;i:80;i:2;s:21:"yii\db\Command::query";i:3;d:1494988049.676841;i:4;a:2:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:82;s:8:"function";s:8:"queryOne";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:38;a:5:{i:0;s:44:"select provcode from sys_config_main limit 1";i:1;i:96;i:2;s:21:"yii\db\Command::query";i:3;d:1494988049.676841;i:4;a:2:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:82;s:8:"function";s:8:"queryOne";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:40;a:5:{i:0;s:141:" select t.* from sys_transform_all t
WHERE  t.bycase NOT IN ('dbpop')
AND t.t_name NOT IN ('t_update_tb','count_43tables')
ORDER BY t.id ASC ";i:1;i:80;i:2;s:21:"yii\db\Command::query";i:3;d:1494988049.676841;i:4;a:2:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:90;s:8:"function";s:8:"queryAll";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:41;a:5:{i:0;s:141:" select t.* from sys_transform_all t
WHERE  t.bycase NOT IN ('dbpop')
AND t.t_name NOT IN ('t_update_tb','count_43tables')
ORDER BY t.id ASC ";i:1;i:96;i:2;s:21:"yii\db\Command::query";i:3;d:1494988049.692441;i:4;a:2:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:90;s:8:"function";s:8:"queryAll";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:43;a:5:{i:0;s:33:"DROP PROCEDURE IF EXISTS t_person";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988049.692441;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:44;a:5:{i:0;s:33:"DROP PROCEDURE IF EXISTS t_person";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988049.7392409;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:46;a:5:{i:0;s:14780:"CREATE PROCEDURE t_person()
 BEGIN 
SET @prov_c := '58';
SET @id :='3';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);

DROP TABLE IF EXISTS t_person_db;
CREATE TABLE t_person_db (
  HOSPCODE varchar(5) NOT NULL,
  CID varchar(13) DEFAULT NULL,
  PID varchar(15) NOT NULL,
  HID varchar(14) DEFAULT NULL,
  PRENAME varchar(3) NOT NULL DEFAULT '',
  NAME varchar(50) NOT NULL DEFAULT '',
  LNAME varchar(50) NOT NULL DEFAULT '',
  HN varchar(15) DEFAULT NULL,
  SEX varchar(1) NOT NULL DEFAULT '',
  BIRTH date NOT NULL DEFAULT '0000-00-00',
  MSTATUS char(1) DEFAULT NULL,
  OCCUPATION_OLD varchar(3) DEFAULT NULL,
  OCCUPATION_NEW varchar(4) DEFAULT NULL,
  RACE varchar(3) DEFAULT NULL,
  NATION varchar(3) NOT NULL DEFAULT '',
  RELIGION varchar(2) DEFAULT NULL,
  EDUCATION varchar(2) DEFAULT NULL,
  FSTATUS varchar(1) DEFAULT NULL,
  FATHER varchar(13) DEFAULT NULL,
  MOTHER varchar(13) DEFAULT NULL,
  COUPLE varchar(13) DEFAULT NULL,
  VSTATUS varchar(1) DEFAULT NULL,
  MOVEIN date DEFAULT NULL,
  DISCHARGE varchar(1) DEFAULT NULL,
  DDISCHARGE date DEFAULT NULL,
  ABOGROUP varchar(1) DEFAULT NULL,
  RHGROUP varchar(1) DEFAULT NULL,
  LABOR varchar(2) DEFAULT NULL,
  PASSPORT varchar(8) DEFAULT NULL,
  TYPEAREA varchar(1) NOT NULL DEFAULT '',
  D_UPDATE datetime NOT NULL DEFAULT '0000-00-00 00:00:00',
  check_hosp varchar(5) NOT NULL DEFAULT '',
  check_typearea varchar(1) NOT NULL DEFAULT '',
  addr varchar(100) DEFAULT NULL,
	vhid varchar(8) DEFAULT NULL,
  check_vhid varchar(8) DEFAULT NULL,
  maininscl varchar(5) DEFAULT NULL,
  inscl varchar(5) DEFAULT NULL,
	error_code varchar(255) DEFAULT NULL,
  PRIMARY KEY (HOSPCODE,PID),
	KEY (HOSPCODE,PID),
  KEY (HOSPCODE),
  KEY  (PID),
  KEY  (CID),
  KEY (TYPEAREA),
  KEY (check_typearea),
  KEY (vhid),
  KEY  (check_vhid),
  KEY (LABOR),
  KEY (NATION),
  KEY (BIRTH),
  KEY (error_code)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO t_person_db 
(
	HOSPCODE,CID,PID,HID,PRENAME,NAME,LNAME,HN,SEX,BIRTH,MSTATUS,OCCUPATION_OLD,OCCUPATION_NEW,RACE,NATION
	,RELIGION,EDUCATION,FSTATUS,FATHER,MOTHER,COUPLE,VSTATUS,MOVEIN,DISCHARGE,DDISCHARGE,ABOGROUP,RHGROUP,LABOR
	,PASSPORT,TYPEAREA,D_UPDATE,check_hosp,check_typearea,vhid,check_vhid,addr
)
(	SELECT SQL_BIG_RESULT 
				p.HOSPCODE,p.CID,p.PID,p.HID,p.PRENAME,p.NAME,p.LNAME,p.HN,p.SEX,p.BIRTH,p.MSTATUS,p.OCCUPATION_OLD,p.OCCUPATION_NEW
				,p.RACE,p.NATION,p.RELIGION,p.EDUCATION,p.FSTATUS,p.FATHER,p.MOTHER,p.COUPLE,p.VSTATUS,p.MOVEIN,p.DISCHARGE
				,p.DDISCHARGE,p.ABOGROUP,p.RHGROUP,p.LABOR,p.PASSPORT,p.TYPEAREA,p.D_UPDATE,p.HOSPCODE as check_hosp
				,p.TYPEAREA as check_typearea 
				,if(ho.CHANGWAT is not null,concat(ho.CHANGWAT,ho.AMPUR,ho.TAMBON,SUBSTR(CONCAT('00',ho.VILLAGE),-2)),null) as vhid
				,if(ho.CHANGWAT is not null,concat(ho.CHANGWAT,ho.AMPUR,ho.TAMBON,SUBSTR(CONCAT('00',ho.VILLAGE),-2)),null) as check_vhid
				,ho.house as addr
	FROM
		person as p 
		LEFT JOIN home ho ON p.HOSPCODE=ho.HOSPCODE AND p.HID=ho.HID
);


UPDATE t_person_db t,chospital h
			SET t.vhid=concat(h.provcode,h.distcode,h.subdistcode,SUBSTR(CONCAT('00',h.mu),-2))
			,t.check_vhid=concat(h.provcode,h.distcode,h.subdistcode,SUBSTR(CONCAT('00',h.mu),-2))
			,t.addr=h.address
WHERE t.hospcode=h.hoscode AND (t.vhid is null OR t.check_vhid is null) ;



UPDATE t_person_db 
SET error_code =IF(ISNULL(error_code),'PE0001',CONCAT(error_code,',','PE0001') ) 
WHERE  NATION in(99) AND DISCHARGE in(9) AND (cid is null or LENGTH(trim(cid))=0);

UPDATE t_person_db 
SET error_code =IF(ISNULL(error_code),'PE0002',CONCAT(error_code,',','PE0002') ) 
WHERE  NATION in(99) AND DISCHARGE in(9) AND mod11(cid)=0 AND (cid IS NOT null OR LENGTH(TRIM(cid)) >0 );


UPDATE t_person_db p LEFT JOIN chospital h ON p.HOSPCODE=h.hoscode 
SET error_code =IF(ISNULL(error_code),'PE0003',CONCAT(error_code,',','PE0003') ) 
WHERE  NATION in(99) AND DISCHARGE in(9) AND (
substr(cid,1,5) in(hoscode)
OR
CONCAT('0',substr(cid,2,5)) = CONCAT('0',hoscode)
);

UPDATE t_person_db p LEFT JOIN chospital h ON p.HOSPCODE=h.hoscode 
SET error_code =IF(ISNULL(error_code),'PE0004',CONCAT(error_code,',','PE0004') ) 
WHERE  NATION in(99) AND DISCHARGE in(9) 
AND (`NAME`  LIKE '%พม่า%' OR LNAME  LIKE '%พม่า%' 
					OR `NAME`  LIKE '%ลาว%' OR LNAME  LIKE '%ลาว%'  
				 OR `NAME`  LIKE '%เขมร%' OR LNAME  LIKE '%เขมร%'  
				 OR `NAME`  LIKE '%กัมพูชา%' OR LNAME  LIKE '%กัมพูชา%'  
				 OR `NAME`  LIKE '%มอญ%' OR LNAME  LIKE '%มอญ%'  
				 OR `NAME`  LIKE '%กระเหรี่ยง%' OR LNAME  LIKE '%กระเหรี่ยง%'  
				 OR `NAME`  LIKE '%กะเหรี่ยง%' OR LNAME  LIKE '%กะเหรี่ยง%'  
				 OR `NAME`  LIKE '%ญวน%' OR LNAME  LIKE '%ญวน%'  
				 OR `NAME`  LIKE '%อาข่า%' OR LNAME  LIKE '%อาข่า%'  
				 OR `NAME`  LIKE '%เวียดนาม%' OR LNAME  LIKE '%เวียดนาม%'  
				 OR `NAME`  LIKE '%ชาวเขา%' OR LNAME  LIKE '%ชาวเขา%'  
OR UPPER(`NAME`) REGEXP '^[A-Z]' OR UPPER(LNAME) REGEXP '^[A-Z]' 
				)
AND (
substr(cid,1,5) in(hoscode)
OR
CONCAT('0',substr(cid,2,5)) = CONCAT('0',hoscode)
);

UPDATE t_person_db p LEFT JOIN home h ON p.HOSPCODE=h.HOSPCODE AND p.HID=h.HID
SET error_code =IF(ISNULL(error_code),'PE0005',CONCAT(error_code,',','PE0005') ) 
WHERE   DISCHARGE in(9) AND TYPEAREA in(1,3) AND h.HOSPCODE is null;

UPDATE t_person_db 
SET error_code =IF(ISNULL(error_code),'PE0006',CONCAT(error_code,',','PE0006') ) 
WHERE   DISCHARGE in(9) AND (sex NOT in(1,2) OR sex is null);

UPDATE t_person_db 
SET error_code =IF(ISNULL(error_code),'PE0007',CONCAT(error_code,',','PE0007') ) 
WHERE   DISCHARGE in(9) AND TYPEAREA in(1,3)  
AND ( TIMESTAMPDIFF(year,BIRTH,NOW()) >100  
	OR BIRTH > NOW()  );

UPDATE t_person_db 
SET error_code =IF(ISNULL(error_code),'PE0008',CONCAT(error_code,',','PE0008') ) 
WHERE   DISCHARGE in(9) AND NATION NOT IN(99) AND (LENGTH(TRIM(LABOR)) =0   OR LABOR is null);

UPDATE t_person_db p LEFT JOIN chospital h ON p.HOSPCODE=h.hoscode 
SET error_code =IF(ISNULL(error_code),'PE0009',CONCAT(error_code,',','PE0009') ) 
WHERE   h.hoscode is null;

UPDATE t_person_db p 
SET error_code =IF(ISNULL(error_code),'PE0011',CONCAT(error_code,',','PE0011') ) 
WHERE   mstatus  in(6) AND  p.prename NOT BETWEEN 800 AND  959;

UPDATE t_person_db p 
SET error_code =IF(ISNULL(error_code),'PE0012',CONCAT(error_code,',','PE0012') ) 
WHERE   mstatus not in(6) AND (p.prename BETWEEN 800 AND 862 OR  p.prename BETWEEN 865 AND 959);

UPDATE t_person_db p 
SET error_code =IF(ISNULL(error_code),'PE0013',CONCAT(error_code,',','PE0013') ) 
WHERE   sex not in(1) AND (p.prename BETWEEN 800 AND 862 OR  p.prename BETWEEN 865 AND 959);

UPDATE t_person_db p 
SET error_code =IF(ISNULL(error_code),'PE0014',CONCAT(error_code,',','PE0014') ) 
WHERE  sex not in(1) AND mstatus  in(6);

DROP TABLE IF EXISTS t_person_cid;
CREATE TABLE t_person_cid (
  HOSPCODE varchar(5) NOT NULL DEFAULT '',
  CID varchar(13) not null,
  PID varchar(15) NOT NULL DEFAULT '',
  HID varchar(14) DEFAULT NULL,
  PRENAME varchar(3) NOT NULL DEFAULT '',
  NAME varchar(50) NOT NULL DEFAULT '',
  LNAME varchar(50) NOT NULL DEFAULT '',
  HN varchar(15) DEFAULT NULL,
  SEX varchar(1) NOT NULL DEFAULT '',
  BIRTH date NOT NULL DEFAULT '0000-00-00',
  MSTATUS char(1) DEFAULT NULL,
  OCCUPATION_OLD varchar(3) DEFAULT NULL,
  OCCUPATION_NEW varchar(4) DEFAULT NULL,
  RACE varchar(3) DEFAULT NULL,
  NATION varchar(3) NOT NULL DEFAULT '',
  RELIGION varchar(2) DEFAULT NULL,
  EDUCATION varchar(2) DEFAULT NULL,
  FSTATUS varchar(1) DEFAULT NULL,
  FATHER varchar(13) DEFAULT NULL,
  MOTHER varchar(13) DEFAULT NULL,
  COUPLE varchar(13) DEFAULT NULL,
  VSTATUS varchar(1) DEFAULT NULL,
  MOVEIN date DEFAULT NULL,
  DISCHARGE varchar(1) DEFAULT NULL,
  DDISCHARGE date DEFAULT NULL,
  ABOGROUP varchar(1) DEFAULT NULL,
  RHGROUP varchar(1) DEFAULT NULL,
  LABOR varchar(2) DEFAULT NULL,
  PASSPORT varchar(8) DEFAULT NULL,
  TYPEAREA varchar(1) NOT NULL DEFAULT '',
  D_UPDATE datetime NOT NULL DEFAULT '0000-00-00 00:00:00',
  check_hosp varchar(5) NOT NULL DEFAULT '',
  check_typearea varchar(1) NOT NULL DEFAULT '',
  vhid varchar(8) DEFAULT NULL,
  check_vhid varchar(8) DEFAULT NULL,
  maininscl varchar(5) DEFAULT NULL,
  inscl varchar(5) DEFAULT NULL,
  age_y int(3) DEFAULT NULL,
	addr varchar(100) DEFAULT NULL,
  PRIMARY KEY (CID),
  KEY HOSPCODE_PID (HOSPCODE,PID),
  KEY HOSPCODE (HOSPCODE),
  KEY PID (PID),
  KEY TYPEAREA (TYPEAREA),
  KEY vhid (vhid),
  KEY check_vhid (check_vhid),
  KEY check_typearea (check_typearea),
  KEY check_hosp (check_hosp),
  KEY BIRTH (BIRTH),
  KEY LABOR (LABOR),
  KEY NATION (NATION)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;


INSERT IGNORE INTO t_person_cid
(
		SELECT SQL_BIG_RESULT 
				p.HOSPCODE,p.CID,p.PID,p.HID,p.PRENAME,p.NAME,p.LNAME,p.HN,p.SEX,p.BIRTH
				,p.MSTATUS,p.OCCUPATION_OLD,p.OCCUPATION_NEW,p.RACE,p.NATION,p.RELIGION,p.EDUCATION,p.FSTATUS
				,p.FATHER,p.MOTHER,p.COUPLE,p.VSTATUS,p.MOVEIN,p.DISCHARGE
				,p.DDISCHARGE,p.ABOGROUP,p.RHGROUP,p.LABOR,p.PASSPORT,p.TYPEAREA,p.D_UPDATE,
				p.HOSPCODE as check_hosp	,p.TYPEAREA as check_typearea ,vhid,check_vhid,maininscl,inscl
				,age(DATE_FORMAT(CONCAT(@b_year,'0101'),'%Y%m%d'),birth,'y') as age_y,p.addr
				
		FROM
			t_person_db p
		WHERE LENGTH(TRIM(p.cid))=13 AND p.TYPEAREA in('1','3')
		ORDER BY  p.D_UPDATE DESC ,p.TYPEAREA ASC
);

INSERT IGNORE INTO t_person_cid
(
		SELECT SQL_BIG_RESULT 
				p.HOSPCODE,p.CID,p.PID,p.HID,p.PRENAME,p.NAME,p.LNAME,p.HN,p.SEX,p.BIRTH
				,p.MSTATUS,p.OCCUPATION_OLD,p.OCCUPATION_NEW,p.RACE,p.NATION,p.RELIGION,p.EDUCATION,p.FSTATUS
				,p.FATHER,p.MOTHER,p.COUPLE,p.VSTATUS,p.MOVEIN,p.DISCHARGE
				,p.DDISCHARGE,p.ABOGROUP,p.RHGROUP,p.LABOR,p.PASSPORT,p.TYPEAREA,p.D_UPDATE,
				p.HOSPCODE as check_hosp	,p.TYPEAREA as check_typearea ,vhid,check_vhid,maininscl,inscl
				,age(DATE_FORMAT(CONCAT(@b_year,'0101'),'%Y%m%d'),birth,'y') as age_y,p.addr
		FROM
			t_person_db p
		WHERE LENGTH(TRIM(p.cid))=13 AND p.TYPEAREA in('2','4','5')
		ORDER BY p.TYPEAREA ASC
);

#################################
UPDATE  t_person_db  pd INNER JOIN t_person_cid p ON pd.CID=p.CID 
LEFT JOIN address a ON pd.HOSPCODE=a.HOSPCODE AND pd.PID=a.PID
SET pd.error_code =IF(ISNULL(pd.error_code),'PE0015',CONCAT(pd.error_code,',','PE0015') ) 
WHERE  p.check_typearea in(4,5) AND p.DISCHARGE in(9) AND a.CHANGWAT in(@prov_c);

DROP TABLE IF EXISTS tmpz_error_person;
CREATE TABLE IF NOT EXISTS tmpz_error_person (error_name text ,KEY (hospcode,pid),KEY(cid),key(error_code) )
ENGINE=myisam DEFAULT CHARSET=utf8 as(
SELECT
HOSPCODE,PID,cid
,SUBSTRING_INDEX(p.error_code,',',1) error_code
,null as error_name
FROM t_person_db p WHERE 
error_code is not null
);
INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',2),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*2)+1 ;

INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',3),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*3)+2 ;
 
INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',4),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*4)+3 ;

INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',5),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*5)+4 ;

INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',6),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*6)+5 ;

INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',7),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*7)+6 ;

INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',8),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*8)+7 ;

INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',9),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*9)+8 ;

INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',10),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*10)+9 ;

INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',11),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*11)+10 ;

INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',12),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*12)+11 ;

INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',13),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*13)+12 ;

INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',14),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*14)+13 ;

INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',15),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*15)+14 ;

UPDATE tmpz_error_person p INNER JOIN cerror_new c ON p.error_code=c.err_code 
SET p.error_name=c.err_name;

DROP TABLE IF EXISTS tmp_exchange_person;
CREATE TABLE IF NOT EXISTS tmp_exchange_person (error_code VARCHAR(255),KEY (hospcode,pid),KEY(cid),KEY(error_code))
ENGINE=myisam DEFAULT CHARSET=utf8 as(
SELECT
HOSPCODE,PID,cid,GROUP_CONCAT(error_code separator ' :: ') error_code, GROUP_CONCAT(error_name separator ' :: ') error_name
FROM tmpz_error_person 
GROUP BY HOSPCODE,PID
);
DROP TABLE IF EXISTS tmpz_error_person;


 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988049.7392409;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:47;a:5:{i:0;s:14780:"CREATE PROCEDURE t_person()
 BEGIN 
SET @prov_c := '58';
SET @id :='3';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);

DROP TABLE IF EXISTS t_person_db;
CREATE TABLE t_person_db (
  HOSPCODE varchar(5) NOT NULL,
  CID varchar(13) DEFAULT NULL,
  PID varchar(15) NOT NULL,
  HID varchar(14) DEFAULT NULL,
  PRENAME varchar(3) NOT NULL DEFAULT '',
  NAME varchar(50) NOT NULL DEFAULT '',
  LNAME varchar(50) NOT NULL DEFAULT '',
  HN varchar(15) DEFAULT NULL,
  SEX varchar(1) NOT NULL DEFAULT '',
  BIRTH date NOT NULL DEFAULT '0000-00-00',
  MSTATUS char(1) DEFAULT NULL,
  OCCUPATION_OLD varchar(3) DEFAULT NULL,
  OCCUPATION_NEW varchar(4) DEFAULT NULL,
  RACE varchar(3) DEFAULT NULL,
  NATION varchar(3) NOT NULL DEFAULT '',
  RELIGION varchar(2) DEFAULT NULL,
  EDUCATION varchar(2) DEFAULT NULL,
  FSTATUS varchar(1) DEFAULT NULL,
  FATHER varchar(13) DEFAULT NULL,
  MOTHER varchar(13) DEFAULT NULL,
  COUPLE varchar(13) DEFAULT NULL,
  VSTATUS varchar(1) DEFAULT NULL,
  MOVEIN date DEFAULT NULL,
  DISCHARGE varchar(1) DEFAULT NULL,
  DDISCHARGE date DEFAULT NULL,
  ABOGROUP varchar(1) DEFAULT NULL,
  RHGROUP varchar(1) DEFAULT NULL,
  LABOR varchar(2) DEFAULT NULL,
  PASSPORT varchar(8) DEFAULT NULL,
  TYPEAREA varchar(1) NOT NULL DEFAULT '',
  D_UPDATE datetime NOT NULL DEFAULT '0000-00-00 00:00:00',
  check_hosp varchar(5) NOT NULL DEFAULT '',
  check_typearea varchar(1) NOT NULL DEFAULT '',
  addr varchar(100) DEFAULT NULL,
	vhid varchar(8) DEFAULT NULL,
  check_vhid varchar(8) DEFAULT NULL,
  maininscl varchar(5) DEFAULT NULL,
  inscl varchar(5) DEFAULT NULL,
	error_code varchar(255) DEFAULT NULL,
  PRIMARY KEY (HOSPCODE,PID),
	KEY (HOSPCODE,PID),
  KEY (HOSPCODE),
  KEY  (PID),
  KEY  (CID),
  KEY (TYPEAREA),
  KEY (check_typearea),
  KEY (vhid),
  KEY  (check_vhid),
  KEY (LABOR),
  KEY (NATION),
  KEY (BIRTH),
  KEY (error_code)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO t_person_db 
(
	HOSPCODE,CID,PID,HID,PRENAME,NAME,LNAME,HN,SEX,BIRTH,MSTATUS,OCCUPATION_OLD,OCCUPATION_NEW,RACE,NATION
	,RELIGION,EDUCATION,FSTATUS,FATHER,MOTHER,COUPLE,VSTATUS,MOVEIN,DISCHARGE,DDISCHARGE,ABOGROUP,RHGROUP,LABOR
	,PASSPORT,TYPEAREA,D_UPDATE,check_hosp,check_typearea,vhid,check_vhid,addr
)
(	SELECT SQL_BIG_RESULT 
				p.HOSPCODE,p.CID,p.PID,p.HID,p.PRENAME,p.NAME,p.LNAME,p.HN,p.SEX,p.BIRTH,p.MSTATUS,p.OCCUPATION_OLD,p.OCCUPATION_NEW
				,p.RACE,p.NATION,p.RELIGION,p.EDUCATION,p.FSTATUS,p.FATHER,p.MOTHER,p.COUPLE,p.VSTATUS,p.MOVEIN,p.DISCHARGE
				,p.DDISCHARGE,p.ABOGROUP,p.RHGROUP,p.LABOR,p.PASSPORT,p.TYPEAREA,p.D_UPDATE,p.HOSPCODE as check_hosp
				,p.TYPEAREA as check_typearea 
				,if(ho.CHANGWAT is not null,concat(ho.CHANGWAT,ho.AMPUR,ho.TAMBON,SUBSTR(CONCAT('00',ho.VILLAGE),-2)),null) as vhid
				,if(ho.CHANGWAT is not null,concat(ho.CHANGWAT,ho.AMPUR,ho.TAMBON,SUBSTR(CONCAT('00',ho.VILLAGE),-2)),null) as check_vhid
				,ho.house as addr
	FROM
		person as p 
		LEFT JOIN home ho ON p.HOSPCODE=ho.HOSPCODE AND p.HID=ho.HID
);


UPDATE t_person_db t,chospital h
			SET t.vhid=concat(h.provcode,h.distcode,h.subdistcode,SUBSTR(CONCAT('00',h.mu),-2))
			,t.check_vhid=concat(h.provcode,h.distcode,h.subdistcode,SUBSTR(CONCAT('00',h.mu),-2))
			,t.addr=h.address
WHERE t.hospcode=h.hoscode AND (t.vhid is null OR t.check_vhid is null) ;



UPDATE t_person_db 
SET error_code =IF(ISNULL(error_code),'PE0001',CONCAT(error_code,',','PE0001') ) 
WHERE  NATION in(99) AND DISCHARGE in(9) AND (cid is null or LENGTH(trim(cid))=0);

UPDATE t_person_db 
SET error_code =IF(ISNULL(error_code),'PE0002',CONCAT(error_code,',','PE0002') ) 
WHERE  NATION in(99) AND DISCHARGE in(9) AND mod11(cid)=0 AND (cid IS NOT null OR LENGTH(TRIM(cid)) >0 );


UPDATE t_person_db p LEFT JOIN chospital h ON p.HOSPCODE=h.hoscode 
SET error_code =IF(ISNULL(error_code),'PE0003',CONCAT(error_code,',','PE0003') ) 
WHERE  NATION in(99) AND DISCHARGE in(9) AND (
substr(cid,1,5) in(hoscode)
OR
CONCAT('0',substr(cid,2,5)) = CONCAT('0',hoscode)
);

UPDATE t_person_db p LEFT JOIN chospital h ON p.HOSPCODE=h.hoscode 
SET error_code =IF(ISNULL(error_code),'PE0004',CONCAT(error_code,',','PE0004') ) 
WHERE  NATION in(99) AND DISCHARGE in(9) 
AND (`NAME`  LIKE '%พม่า%' OR LNAME  LIKE '%พม่า%' 
					OR `NAME`  LIKE '%ลาว%' OR LNAME  LIKE '%ลาว%'  
				 OR `NAME`  LIKE '%เขมร%' OR LNAME  LIKE '%เขมร%'  
				 OR `NAME`  LIKE '%กัมพูชา%' OR LNAME  LIKE '%กัมพูชา%'  
				 OR `NAME`  LIKE '%มอญ%' OR LNAME  LIKE '%มอญ%'  
				 OR `NAME`  LIKE '%กระเหรี่ยง%' OR LNAME  LIKE '%กระเหรี่ยง%'  
				 OR `NAME`  LIKE '%กะเหรี่ยง%' OR LNAME  LIKE '%กะเหรี่ยง%'  
				 OR `NAME`  LIKE '%ญวน%' OR LNAME  LIKE '%ญวน%'  
				 OR `NAME`  LIKE '%อาข่า%' OR LNAME  LIKE '%อาข่า%'  
				 OR `NAME`  LIKE '%เวียดนาม%' OR LNAME  LIKE '%เวียดนาม%'  
				 OR `NAME`  LIKE '%ชาวเขา%' OR LNAME  LIKE '%ชาวเขา%'  
OR UPPER(`NAME`) REGEXP '^[A-Z]' OR UPPER(LNAME) REGEXP '^[A-Z]' 
				)
AND (
substr(cid,1,5) in(hoscode)
OR
CONCAT('0',substr(cid,2,5)) = CONCAT('0',hoscode)
);

UPDATE t_person_db p LEFT JOIN home h ON p.HOSPCODE=h.HOSPCODE AND p.HID=h.HID
SET error_code =IF(ISNULL(error_code),'PE0005',CONCAT(error_code,',','PE0005') ) 
WHERE   DISCHARGE in(9) AND TYPEAREA in(1,3) AND h.HOSPCODE is null;

UPDATE t_person_db 
SET error_code =IF(ISNULL(error_code),'PE0006',CONCAT(error_code,',','PE0006') ) 
WHERE   DISCHARGE in(9) AND (sex NOT in(1,2) OR sex is null);

UPDATE t_person_db 
SET error_code =IF(ISNULL(error_code),'PE0007',CONCAT(error_code,',','PE0007') ) 
WHERE   DISCHARGE in(9) AND TYPEAREA in(1,3)  
AND ( TIMESTAMPDIFF(year,BIRTH,NOW()) >100  
	OR BIRTH > NOW()  );

UPDATE t_person_db 
SET error_code =IF(ISNULL(error_code),'PE0008',CONCAT(error_code,',','PE0008') ) 
WHERE   DISCHARGE in(9) AND NATION NOT IN(99) AND (LENGTH(TRIM(LABOR)) =0   OR LABOR is null);

UPDATE t_person_db p LEFT JOIN chospital h ON p.HOSPCODE=h.hoscode 
SET error_code =IF(ISNULL(error_code),'PE0009',CONCAT(error_code,',','PE0009') ) 
WHERE   h.hoscode is null;

UPDATE t_person_db p 
SET error_code =IF(ISNULL(error_code),'PE0011',CONCAT(error_code,',','PE0011') ) 
WHERE   mstatus  in(6) AND  p.prename NOT BETWEEN 800 AND  959;

UPDATE t_person_db p 
SET error_code =IF(ISNULL(error_code),'PE0012',CONCAT(error_code,',','PE0012') ) 
WHERE   mstatus not in(6) AND (p.prename BETWEEN 800 AND 862 OR  p.prename BETWEEN 865 AND 959);

UPDATE t_person_db p 
SET error_code =IF(ISNULL(error_code),'PE0013',CONCAT(error_code,',','PE0013') ) 
WHERE   sex not in(1) AND (p.prename BETWEEN 800 AND 862 OR  p.prename BETWEEN 865 AND 959);

UPDATE t_person_db p 
SET error_code =IF(ISNULL(error_code),'PE0014',CONCAT(error_code,',','PE0014') ) 
WHERE  sex not in(1) AND mstatus  in(6);

DROP TABLE IF EXISTS t_person_cid;
CREATE TABLE t_person_cid (
  HOSPCODE varchar(5) NOT NULL DEFAULT '',
  CID varchar(13) not null,
  PID varchar(15) NOT NULL DEFAULT '',
  HID varchar(14) DEFAULT NULL,
  PRENAME varchar(3) NOT NULL DEFAULT '',
  NAME varchar(50) NOT NULL DEFAULT '',
  LNAME varchar(50) NOT NULL DEFAULT '',
  HN varchar(15) DEFAULT NULL,
  SEX varchar(1) NOT NULL DEFAULT '',
  BIRTH date NOT NULL DEFAULT '0000-00-00',
  MSTATUS char(1) DEFAULT NULL,
  OCCUPATION_OLD varchar(3) DEFAULT NULL,
  OCCUPATION_NEW varchar(4) DEFAULT NULL,
  RACE varchar(3) DEFAULT NULL,
  NATION varchar(3) NOT NULL DEFAULT '',
  RELIGION varchar(2) DEFAULT NULL,
  EDUCATION varchar(2) DEFAULT NULL,
  FSTATUS varchar(1) DEFAULT NULL,
  FATHER varchar(13) DEFAULT NULL,
  MOTHER varchar(13) DEFAULT NULL,
  COUPLE varchar(13) DEFAULT NULL,
  VSTATUS varchar(1) DEFAULT NULL,
  MOVEIN date DEFAULT NULL,
  DISCHARGE varchar(1) DEFAULT NULL,
  DDISCHARGE date DEFAULT NULL,
  ABOGROUP varchar(1) DEFAULT NULL,
  RHGROUP varchar(1) DEFAULT NULL,
  LABOR varchar(2) DEFAULT NULL,
  PASSPORT varchar(8) DEFAULT NULL,
  TYPEAREA varchar(1) NOT NULL DEFAULT '',
  D_UPDATE datetime NOT NULL DEFAULT '0000-00-00 00:00:00',
  check_hosp varchar(5) NOT NULL DEFAULT '',
  check_typearea varchar(1) NOT NULL DEFAULT '',
  vhid varchar(8) DEFAULT NULL,
  check_vhid varchar(8) DEFAULT NULL,
  maininscl varchar(5) DEFAULT NULL,
  inscl varchar(5) DEFAULT NULL,
  age_y int(3) DEFAULT NULL,
	addr varchar(100) DEFAULT NULL,
  PRIMARY KEY (CID),
  KEY HOSPCODE_PID (HOSPCODE,PID),
  KEY HOSPCODE (HOSPCODE),
  KEY PID (PID),
  KEY TYPEAREA (TYPEAREA),
  KEY vhid (vhid),
  KEY check_vhid (check_vhid),
  KEY check_typearea (check_typearea),
  KEY check_hosp (check_hosp),
  KEY BIRTH (BIRTH),
  KEY LABOR (LABOR),
  KEY NATION (NATION)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;


INSERT IGNORE INTO t_person_cid
(
		SELECT SQL_BIG_RESULT 
				p.HOSPCODE,p.CID,p.PID,p.HID,p.PRENAME,p.NAME,p.LNAME,p.HN,p.SEX,p.BIRTH
				,p.MSTATUS,p.OCCUPATION_OLD,p.OCCUPATION_NEW,p.RACE,p.NATION,p.RELIGION,p.EDUCATION,p.FSTATUS
				,p.FATHER,p.MOTHER,p.COUPLE,p.VSTATUS,p.MOVEIN,p.DISCHARGE
				,p.DDISCHARGE,p.ABOGROUP,p.RHGROUP,p.LABOR,p.PASSPORT,p.TYPEAREA,p.D_UPDATE,
				p.HOSPCODE as check_hosp	,p.TYPEAREA as check_typearea ,vhid,check_vhid,maininscl,inscl
				,age(DATE_FORMAT(CONCAT(@b_year,'0101'),'%Y%m%d'),birth,'y') as age_y,p.addr
				
		FROM
			t_person_db p
		WHERE LENGTH(TRIM(p.cid))=13 AND p.TYPEAREA in('1','3')
		ORDER BY  p.D_UPDATE DESC ,p.TYPEAREA ASC
);

INSERT IGNORE INTO t_person_cid
(
		SELECT SQL_BIG_RESULT 
				p.HOSPCODE,p.CID,p.PID,p.HID,p.PRENAME,p.NAME,p.LNAME,p.HN,p.SEX,p.BIRTH
				,p.MSTATUS,p.OCCUPATION_OLD,p.OCCUPATION_NEW,p.RACE,p.NATION,p.RELIGION,p.EDUCATION,p.FSTATUS
				,p.FATHER,p.MOTHER,p.COUPLE,p.VSTATUS,p.MOVEIN,p.DISCHARGE
				,p.DDISCHARGE,p.ABOGROUP,p.RHGROUP,p.LABOR,p.PASSPORT,p.TYPEAREA,p.D_UPDATE,
				p.HOSPCODE as check_hosp	,p.TYPEAREA as check_typearea ,vhid,check_vhid,maininscl,inscl
				,age(DATE_FORMAT(CONCAT(@b_year,'0101'),'%Y%m%d'),birth,'y') as age_y,p.addr
		FROM
			t_person_db p
		WHERE LENGTH(TRIM(p.cid))=13 AND p.TYPEAREA in('2','4','5')
		ORDER BY p.TYPEAREA ASC
);

#################################
UPDATE  t_person_db  pd INNER JOIN t_person_cid p ON pd.CID=p.CID 
LEFT JOIN address a ON pd.HOSPCODE=a.HOSPCODE AND pd.PID=a.PID
SET pd.error_code =IF(ISNULL(pd.error_code),'PE0015',CONCAT(pd.error_code,',','PE0015') ) 
WHERE  p.check_typearea in(4,5) AND p.DISCHARGE in(9) AND a.CHANGWAT in(@prov_c);

DROP TABLE IF EXISTS tmpz_error_person;
CREATE TABLE IF NOT EXISTS tmpz_error_person (error_name text ,KEY (hospcode,pid),KEY(cid),key(error_code) )
ENGINE=myisam DEFAULT CHARSET=utf8 as(
SELECT
HOSPCODE,PID,cid
,SUBSTRING_INDEX(p.error_code,',',1) error_code
,null as error_name
FROM t_person_db p WHERE 
error_code is not null
);
INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',2),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*2)+1 ;

INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',3),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*3)+2 ;
 
INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',4),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*4)+3 ;

INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',5),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*5)+4 ;

INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',6),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*6)+5 ;

INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',7),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*7)+6 ;

INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',8),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*8)+7 ;

INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',9),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*9)+8 ;

INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',10),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*10)+9 ;

INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',11),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*11)+10 ;

INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',12),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*12)+11 ;

INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',13),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*13)+12 ;

INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',14),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*14)+13 ;

INSERT IGNORE INTO tmpz_error_person (hospcode,pid,cid,error_code)
SELECT
HOSPCODE,PID,cid
,SUBSTR(SUBSTRING_INDEX(p.error_code,',',15),-6)  error_code
FROM t_person_db p WHERE 
LENGTH(TRIM(error_code)) >= (6*15)+14 ;

UPDATE tmpz_error_person p INNER JOIN cerror_new c ON p.error_code=c.err_code 
SET p.error_name=c.err_name;

DROP TABLE IF EXISTS tmp_exchange_person;
CREATE TABLE IF NOT EXISTS tmp_exchange_person (error_code VARCHAR(255),KEY (hospcode,pid),KEY(cid),KEY(error_code))
ENGINE=myisam DEFAULT CHARSET=utf8 as(
SELECT
HOSPCODE,PID,cid,GROUP_CONCAT(error_code separator ' :: ') error_code, GROUP_CONCAT(error_name separator ' :: ') error_name
FROM tmpz_error_person 
GROUP BY HOSPCODE,PID
);
DROP TABLE IF EXISTS tmpz_error_person;


 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988049.8484409;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:49;a:5:{i:0;s:37:"DROP PROCEDURE IF EXISTS t_person_anc";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988049.8484409;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:50;a:5:{i:0;s:37:"DROP PROCEDURE IF EXISTS t_person_anc";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988049.9576409;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:52;a:5:{i:0;s:5429:"CREATE PROCEDURE t_person_anc()
 BEGIN 
SET @prov_c := '58';
SET @id := '4';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
SET	@date_3:=concat(@b_year-2,'1001');

DROP TABLE IF EXISTS tmp_anc;

CREATE TABLE IF NOT EXISTS tmp_anc (
KEY (cid),
KEY (hospcode,pid),
KEY (date_serv),
KEY (ga),
KEY (gravida)
)ENGINE=MyISAM  AS(
SELECT  SQL_BIG_RESULT 
		tt.HOSPCODE,tt.PID,tt.SEQ,tt.DATE_SERV,tt.GRAVIDA,tt.ancno,tt.GA,tt.ANCRESULT,tt.ANCPLACE,tt.PROVIDER,tt.D_UPDATE,pe.cid,pe.nation,pe.birth,pe.sex
FROM
			anc tt LEFT JOIN person pe ON tt.HOSPCODE=pe.HOSPCODE AND tt.pid=pe.pid 
WHERE
		tt.date_serv BETWEEN @date_3 AND @end_d
);

DROP TABLE IF EXISTS tmp_labor;
CREATE TABLE IF NOT EXISTS tmp_labor (
KEY (cid),
KEY (hospcode,pid),
KEY (bdate)
) ENGINE=MyISAM  AS(
SELECT  SQL_BIG_RESULT 
		lb.*,pe.cid,pe.birth,age(lb.bdate,pe.birth,'y') as age_y
FROM
			labor lb  LEFT JOIN person pe ON lb.HOSPCODE=pe.HOSPCODE AND lb.pid=pe.pid 
WHERE
		 lb.bdate BETWEEN @date_3 AND @end_d
);

DROP TABLE IF EXISTS t_labor;
CREATE TABLE IF NOT EXISTS t_labor (
PRIMARY KEY (CID,BDATE)
) ENGINE=MyISAM  IGNORE AS
SELECT l.* FROM tmp_labor l INNER JOIN chospital h ON l.hospcode=h.hoscode WHERE  h.hostype in(5,6,7,11);

INSERT IGNORE t_labor (SELECT * FROM tmp_labor);



DROP TABLE IF EXISTS t_person_anc;

CREATE TABLE IF NOT EXISTS t_person_anc(
		id int(15) NOT NULL AUTO_INCREMENT
		,hospcode varchar(5) NOT NULL
	  ,pid varchar(15) NOT NULL 
		,typearea varchar(1) NOT NULL 
		,cid VARCHAR(13) NOT NULL
		,birth date
		,sex VARCHAR(1) DEFAULT NULL 
		,nation VARCHAR(3) DEFAULT NULL 
		,occupat_new VARCHAR(4) DEFAULT NULL 
		,gravida VARCHAR(2) DEFAULT NULL 
		,bdate date
		,bhosp VARCHAR(5) DEFAULT NULL
		,input_bhosp VARCHAR(5) DEFAULT NULL 
		,g1_ga VARCHAR(2) DEFAULT NULL 
		,g1_date date
		,g1_hospcode VARCHAR(5) DEFAULT NULL 
		,g1_input_hosp VARCHAR(5) DEFAULT NULL 
		
		,g2_ga VARCHAR(2) DEFAULT NULL 
		,g2_date date
		,g2_hospcode VARCHAR(5) DEFAULT NULL 
		,g2_input_hosp VARCHAR(5) DEFAULT NULL 

		,g3_ga VARCHAR(2) DEFAULT NULL 
		,g3_date date
		,g3_hospcode VARCHAR(5) DEFAULT NULL 
		,g3_input_hosp VARCHAR(5) DEFAULT NULL 

		,g4_ga VARCHAR(2) DEFAULT NULL 
		,g4_date date
		,g4_hospcode VARCHAR(5) DEFAULT NULL 
		,g4_input_hosp VARCHAR(5) DEFAULT NULL 

		,g5_ga VARCHAR(2) DEFAULT NULL 
		,g5_date date
		,g5_hospcode VARCHAR(5) DEFAULT NULL 
		,g5_input_hosp VARCHAR(5) DEFAULT NULL 
	
	,PRIMARY KEY (id)
	,KEY cid (cid)
,KEY  (hospcode)
,KEY  (pid)
,KEY  (typearea)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

TRUNCATE TABLE t_person_anc;

/*GROUP BY CID Gravida */
INSERT IGNORE INTO t_person_anc
(
hospcode,pid,typearea,cid,birth,sex,nation,occupat_new,gravida
)
(
SELECT	pe.hospcode,pe.pid,pe.check_typearea,pe.cid,pe.BIRTH,pe.SEX,pe.NATION,pe.OCCUPATION_NEW,tt.GRAVIDA
FROM		tmp_anc as tt LEFT JOIN t_person_cid as pe ON tt.CID=pe.CID 
WHERE	 tt.DATE_SERV BETWEEN @date_3 AND @end_d AND LENGTH(pe.cid) = 13
GROUP BY pe.CID,tt.GRAVIDA
ORDER BY  pe.CID
);

UPDATE t_person_anc a INNER JOIN
	(
	SELECT 			cid,date_serv ,gravida,ancplace,ga,hospcode
	FROM		tmp_anc	WHERE			ga <= 12 
	GROUP BY cid,gravida
	)	 as g ON a.cid=g.cid AND g.gravida=a.gravida
SET a.g1_ga= g.ga 		,a.g1_date=g.date_serv ,a.g1_hospcode =g.ancplace 			,a.g1_input_hosp= g.hospcode;

UPDATE t_person_anc a INNER JOIN
	(
	SELECT 	cid,date_serv ,gravida,ancplace,ga,hospcode
	FROM		tmp_anc	WHERE		ga BETWEEN 16 AND 20 
	GROUP BY cid,gravida
	)	 as g ON a.cid=g.cid AND g.gravida=a.gravida
SET a.g2_ga= g.ga  ,a.g2_date=g.date_serv 	,a.g2_hospcode =g.ancplace 		,a.g2_input_hosp= g.hospcode;

UPDATE t_person_anc a INNER JOIN
	(
	SELECT 	cid,date_serv ,gravida,ancplace,ga,hospcode
	FROM		tmp_anc	WHERE		ga BETWEEN 24 AND 28 
	GROUP BY cid,gravida
	)	 as g ON a.cid=g.cid AND g.gravida=a.gravida
SET a.g3_ga= g.ga  	,a.g3_date=g.date_serv 	,a.g3_hospcode =g.ancplace 		,a.g3_input_hosp= g.hospcode;

UPDATE t_person_anc a INNER JOIN
	(
	SELECT 	cid,date_serv ,gravida,ancplace,ga,hospcode
	FROM		tmp_anc	WHERE		 ga BETWEEN 30 AND 34 
	GROUP BY cid,gravida
	)	 as g ON a.cid=g.cid AND g.gravida=a.gravida
SET a.g4_ga= g.ga 	,a.g4_date=g.date_serv 		,a.g4_hospcode =g.ancplace 		,a.g4_input_hosp= g.hospcode;

UPDATE t_person_anc a INNER JOIN
	(	
  SELECT 			cid,date_serv ,gravida,ancplace,ga,hospcode
	FROM		tmp_anc	WHERE			ga BETWEEN 36 AND 40 
	GROUP BY cid,gravida
	)	 as g ON a.cid=g.cid AND g.gravida=a.gravida
SET a.g5_ga= g.ga  	,a.g5_date=g.date_serv 		,a.g5_hospcode =g.ancplace 		,a.g5_input_hosp= g.hospcode;

UPDATE t_person_anc a INNER JOIN
	(
	SELECT cid,bdate,gravida,bhosp,hospcode 	FROM	tmp_labor l INNER JOIN chospital h ON l.hospcode=h.hoscode AND h.hostype IN(5,6,7,11)
	WHERE	bdate BETWEEN @start_d AND @end_d AND  BHOSP=HOSPCODE
	GROUP BY cid,gravida
	)	 as g ON a.cid=g.cid AND g.gravida=a.gravida
SET a.bdate=g.bdate	,a.bhosp=g.bhosp	,a.input_bhosp=g.hospcode;

UPDATE t_person_anc a INNER JOIN
	(
	SELECT cid,bdate,gravida,bhosp,hospcode 	FROM	tmp_labor
	WHERE	bdate BETWEEN @start_d AND @end_d 
	GROUP BY cid,gravida
	)	 as g ON a.cid=g.cid AND g.gravida=a.gravida
SET a.bdate=g.bdate	,a.bhosp=g.bhosp	,a.input_bhosp=g.hospcode
WHERE ISNULL(a.bdate);


 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988049.9576409;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:53;a:5:{i:0;s:5429:"CREATE PROCEDURE t_person_anc()
 BEGIN 
SET @prov_c := '58';
SET @id := '4';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
SET	@date_3:=concat(@b_year-2,'1001');

DROP TABLE IF EXISTS tmp_anc;

CREATE TABLE IF NOT EXISTS tmp_anc (
KEY (cid),
KEY (hospcode,pid),
KEY (date_serv),
KEY (ga),
KEY (gravida)
)ENGINE=MyISAM  AS(
SELECT  SQL_BIG_RESULT 
		tt.HOSPCODE,tt.PID,tt.SEQ,tt.DATE_SERV,tt.GRAVIDA,tt.ancno,tt.GA,tt.ANCRESULT,tt.ANCPLACE,tt.PROVIDER,tt.D_UPDATE,pe.cid,pe.nation,pe.birth,pe.sex
FROM
			anc tt LEFT JOIN person pe ON tt.HOSPCODE=pe.HOSPCODE AND tt.pid=pe.pid 
WHERE
		tt.date_serv BETWEEN @date_3 AND @end_d
);

DROP TABLE IF EXISTS tmp_labor;
CREATE TABLE IF NOT EXISTS tmp_labor (
KEY (cid),
KEY (hospcode,pid),
KEY (bdate)
) ENGINE=MyISAM  AS(
SELECT  SQL_BIG_RESULT 
		lb.*,pe.cid,pe.birth,age(lb.bdate,pe.birth,'y') as age_y
FROM
			labor lb  LEFT JOIN person pe ON lb.HOSPCODE=pe.HOSPCODE AND lb.pid=pe.pid 
WHERE
		 lb.bdate BETWEEN @date_3 AND @end_d
);

DROP TABLE IF EXISTS t_labor;
CREATE TABLE IF NOT EXISTS t_labor (
PRIMARY KEY (CID,BDATE)
) ENGINE=MyISAM  IGNORE AS
SELECT l.* FROM tmp_labor l INNER JOIN chospital h ON l.hospcode=h.hoscode WHERE  h.hostype in(5,6,7,11);

INSERT IGNORE t_labor (SELECT * FROM tmp_labor);



DROP TABLE IF EXISTS t_person_anc;

CREATE TABLE IF NOT EXISTS t_person_anc(
		id int(15) NOT NULL AUTO_INCREMENT
		,hospcode varchar(5) NOT NULL
	  ,pid varchar(15) NOT NULL 
		,typearea varchar(1) NOT NULL 
		,cid VARCHAR(13) NOT NULL
		,birth date
		,sex VARCHAR(1) DEFAULT NULL 
		,nation VARCHAR(3) DEFAULT NULL 
		,occupat_new VARCHAR(4) DEFAULT NULL 
		,gravida VARCHAR(2) DEFAULT NULL 
		,bdate date
		,bhosp VARCHAR(5) DEFAULT NULL
		,input_bhosp VARCHAR(5) DEFAULT NULL 
		,g1_ga VARCHAR(2) DEFAULT NULL 
		,g1_date date
		,g1_hospcode VARCHAR(5) DEFAULT NULL 
		,g1_input_hosp VARCHAR(5) DEFAULT NULL 
		
		,g2_ga VARCHAR(2) DEFAULT NULL 
		,g2_date date
		,g2_hospcode VARCHAR(5) DEFAULT NULL 
		,g2_input_hosp VARCHAR(5) DEFAULT NULL 

		,g3_ga VARCHAR(2) DEFAULT NULL 
		,g3_date date
		,g3_hospcode VARCHAR(5) DEFAULT NULL 
		,g3_input_hosp VARCHAR(5) DEFAULT NULL 

		,g4_ga VARCHAR(2) DEFAULT NULL 
		,g4_date date
		,g4_hospcode VARCHAR(5) DEFAULT NULL 
		,g4_input_hosp VARCHAR(5) DEFAULT NULL 

		,g5_ga VARCHAR(2) DEFAULT NULL 
		,g5_date date
		,g5_hospcode VARCHAR(5) DEFAULT NULL 
		,g5_input_hosp VARCHAR(5) DEFAULT NULL 
	
	,PRIMARY KEY (id)
	,KEY cid (cid)
,KEY  (hospcode)
,KEY  (pid)
,KEY  (typearea)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

TRUNCATE TABLE t_person_anc;

/*GROUP BY CID Gravida */
INSERT IGNORE INTO t_person_anc
(
hospcode,pid,typearea,cid,birth,sex,nation,occupat_new,gravida
)
(
SELECT	pe.hospcode,pe.pid,pe.check_typearea,pe.cid,pe.BIRTH,pe.SEX,pe.NATION,pe.OCCUPATION_NEW,tt.GRAVIDA
FROM		tmp_anc as tt LEFT JOIN t_person_cid as pe ON tt.CID=pe.CID 
WHERE	 tt.DATE_SERV BETWEEN @date_3 AND @end_d AND LENGTH(pe.cid) = 13
GROUP BY pe.CID,tt.GRAVIDA
ORDER BY  pe.CID
);

UPDATE t_person_anc a INNER JOIN
	(
	SELECT 			cid,date_serv ,gravida,ancplace,ga,hospcode
	FROM		tmp_anc	WHERE			ga <= 12 
	GROUP BY cid,gravida
	)	 as g ON a.cid=g.cid AND g.gravida=a.gravida
SET a.g1_ga= g.ga 		,a.g1_date=g.date_serv ,a.g1_hospcode =g.ancplace 			,a.g1_input_hosp= g.hospcode;

UPDATE t_person_anc a INNER JOIN
	(
	SELECT 	cid,date_serv ,gravida,ancplace,ga,hospcode
	FROM		tmp_anc	WHERE		ga BETWEEN 16 AND 20 
	GROUP BY cid,gravida
	)	 as g ON a.cid=g.cid AND g.gravida=a.gravida
SET a.g2_ga= g.ga  ,a.g2_date=g.date_serv 	,a.g2_hospcode =g.ancplace 		,a.g2_input_hosp= g.hospcode;

UPDATE t_person_anc a INNER JOIN
	(
	SELECT 	cid,date_serv ,gravida,ancplace,ga,hospcode
	FROM		tmp_anc	WHERE		ga BETWEEN 24 AND 28 
	GROUP BY cid,gravida
	)	 as g ON a.cid=g.cid AND g.gravida=a.gravida
SET a.g3_ga= g.ga  	,a.g3_date=g.date_serv 	,a.g3_hospcode =g.ancplace 		,a.g3_input_hosp= g.hospcode;

UPDATE t_person_anc a INNER JOIN
	(
	SELECT 	cid,date_serv ,gravida,ancplace,ga,hospcode
	FROM		tmp_anc	WHERE		 ga BETWEEN 30 AND 34 
	GROUP BY cid,gravida
	)	 as g ON a.cid=g.cid AND g.gravida=a.gravida
SET a.g4_ga= g.ga 	,a.g4_date=g.date_serv 		,a.g4_hospcode =g.ancplace 		,a.g4_input_hosp= g.hospcode;

UPDATE t_person_anc a INNER JOIN
	(	
  SELECT 			cid,date_serv ,gravida,ancplace,ga,hospcode
	FROM		tmp_anc	WHERE			ga BETWEEN 36 AND 40 
	GROUP BY cid,gravida
	)	 as g ON a.cid=g.cid AND g.gravida=a.gravida
SET a.g5_ga= g.ga  	,a.g5_date=g.date_serv 		,a.g5_hospcode =g.ancplace 		,a.g5_input_hosp= g.hospcode;

UPDATE t_person_anc a INNER JOIN
	(
	SELECT cid,bdate,gravida,bhosp,hospcode 	FROM	tmp_labor l INNER JOIN chospital h ON l.hospcode=h.hoscode AND h.hostype IN(5,6,7,11)
	WHERE	bdate BETWEEN @start_d AND @end_d AND  BHOSP=HOSPCODE
	GROUP BY cid,gravida
	)	 as g ON a.cid=g.cid AND g.gravida=a.gravida
SET a.bdate=g.bdate	,a.bhosp=g.bhosp	,a.input_bhosp=g.hospcode;

UPDATE t_person_anc a INNER JOIN
	(
	SELECT cid,bdate,gravida,bhosp,hospcode 	FROM	tmp_labor
	WHERE	bdate BETWEEN @start_d AND @end_d 
	GROUP BY cid,gravida
	)	 as g ON a.cid=g.cid AND g.gravida=a.gravida
SET a.bdate=g.bdate	,a.bhosp=g.bhosp	,a.input_bhosp=g.hospcode
WHERE ISNULL(a.bdate);


 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.020041;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:55;a:5:{i:0;s:37:"DROP PROCEDURE IF EXISTS t_person_epi";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.035641;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:56;a:5:{i:0;s:37:"DROP PROCEDURE IF EXISTS t_person_epi";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.129241;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:58;a:5:{i:0;s:17586:"CREATE PROCEDURE t_person_epi()
 BEGIN 
SET @prov_c := '58';
SET @id := '5';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
SET	@date_3:=concat(@b_year-14,'1001');

DROP TABLE IF EXISTS tmp_epi;
CREATE TABLE tmp_epi (
KEY (cid),
KEY (hospcode,pid),
KEY (vaccinetype)
) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		tt.HOSPCODE,tt.PID,tt.SEQ,tt.DATE_SERV,tt.VACCINETYPE,tt.VACCINEPLACE,tt.PROVIDER,tt.D_UPDATE,pe.cid
FROM
			epi tt LEFT JOIN  t_person_db pe ON tt.HOSPCODE=pe.HOSPCODE AND tt.pid=pe.pid 
WHERE
tt.date_serv BETWEEN @date_3 AND @end_d
);

DROP TABLE IF EXISTS tmp_newborn;
CREATE TABLE tmp_newborn (
KEY (cid),
KEY (hospcode,pid),
KEY (bweight)
) ENGINE=MyISAM  AS(
SELECT t.HOSPCODE,t.PID,t.MPID,t.GRAVIDA,t.GA,t.BDATE,t.BTIME,t.BPLACE,t.bhosp,t.BIRTHNO,t.btype
,t.bdoctor,t.BWEIGHT,t.ASPHYXIA,t.VITK,t.TSH,t.TSHRESULT,t.D_UPDATE
,p.CID,p.nation,p.sex,p.check_hosp,p.check_vhid,p.check_typearea,p.vhid,p.typearea
FROM		newborn t LEFT JOIN t_person_db p ON t.HOSPCODE=p.HOSPCODE AND t.pid=p.pid 
WHERE t.bdate BETWEEN @date_3 AND @end_d
);

DROP TABLE IF EXISTS tmp_nutrition;
CREATE TABLE tmp_nutrition (
error_code varchar(255) DEFAULT NULL,
KEY (cid),
KEY (hospcode,pid),
KEY (food,childdevelop)
) ENGINE=MyISAM  AS(
SELECT 
		t.HOSPCODE,t.PID,t.SEQ,t.DATE_SERV,t.NUTRITIONPLACE,t.WEIGHT,t.HEIGHT,t.HEADCIRCUM,t.CHILDDEVELOP,t.FOOD,t.BOTTLE,t.PROVIDER,t.D_UPDATE,pe.cid,null as error_code
FROM
			nutrition t LEFT JOIN t_person_db pe ON t.HOSPCODE=pe.HOSPCODE AND t.pid=pe.pid 
WHERE
t.date_serv BETWEEN @date_3 AND @end_d
);
UPDATE tmp_nutrition n INNER JOIN person p  ON n.HOSPCODE=p.HOSPCODE AND n.PID=p.PID
SET error_code =IF(ISNULL(n.error_code),'NU0001',CONCAT(n.error_code,',','NU0001') ) 
WHERE  DATE_SERV BETWEEN @start_d AND @end_d AND n.DATE_SERV < p.BIRTH;


DROP TABLE IF EXISTS t_person_epi;
CREATE TABLE IF NOT EXISTS t_person_epi (
		id int(15) NOT NULL AUTO_INCREMENT
		,hospcode varchar(5) NOT NULL
	  ,pid varchar(15) NOT NULL 
		,typearea varchar(1) NOT NULL 
		,vhid varchar(8) DEFAULT NULL 
		,cid VARCHAR(13) NOT NULL
		,birth date
		,sex VARCHAR(1) DEFAULT NULL 
		,nation VARCHAR(3) DEFAULT NULL 
		,bweight int(4) DEFAULT 0
		,bw_input_hosp VARCHAR(5) DEFAULT NULL 
		,food VARCHAR(1) DEFAULT NULL 
		,food_date date
		,food_input_hosp VARCHAR(5) DEFAULT NULL 

		,childdevelop VARCHAR(1) DEFAULT NULL 
		,childdevelop_date date
		,childdevelop_input_hosp VARCHAR(5) DEFAULT NULL 
		
		,bcg_date date
		,bcg_hospcode VARCHAR(5) DEFAULT NULL
		,bcg_input_hosp VARCHAR(5) DEFAULT NULL 

		,hbv1_date date
		,hbv1_hospcode VARCHAR(5) DEFAULT NULL
		,hbv1_input_hosp VARCHAR(5) DEFAULT NULL 
		,hbv2_date date
		,hbv2_hospcode VARCHAR(5) DEFAULT NULL
		,hbv2_input_hosp VARCHAR(5) DEFAULT NULL 
		,hbv3_date date
		,hbv3_hospcode VARCHAR(5) DEFAULT NULL
		,hbv3_input_hosp VARCHAR(5) DEFAULT NULL 
	
		,opv1_date date
		,opv1_hospcode VARCHAR(5) DEFAULT NULL
		,opv1_input_hosp VARCHAR(5) DEFAULT NULL 
		,opv2_date date
		,opv2_hospcode VARCHAR(5) DEFAULT NULL
		,opv2_input_hosp VARCHAR(5) DEFAULT NULL 
		,opv3_date date
		,opv3_hospcode VARCHAR(5) DEFAULT NULL
		,opv3_input_hosp VARCHAR(5) DEFAULT NULL 
		,opv4_date date
		,opv4_hospcode VARCHAR(5) DEFAULT NULL
		,opv4_input_hosp VARCHAR(5) DEFAULT NULL 
		,opv5_date date
		,opv5_hospcode VARCHAR(5) DEFAULT NULL
		,opv5_input_hosp VARCHAR(5) DEFAULT NULL 

		,opvs1_date date
		,opvs1_hospcode VARCHAR(5) DEFAULT NULL
		,opvs1_input_hosp VARCHAR(5) DEFAULT NULL 
		,opvs2_date date
		,opvs2_hospcode VARCHAR(5) DEFAULT NULL
		,opvs2_input_hosp VARCHAR(5) DEFAULT NULL 
		,opvs3_date date
		,opvs3_hospcode VARCHAR(5) DEFAULT NULL
		,opvs3_input_hosp VARCHAR(5) DEFAULT NULL 

		,dtp1_date date
		,dtp1_hospcode VARCHAR(5) DEFAULT NULL
		,dtp1_input_hosp VARCHAR(5) DEFAULT NULL 
		,dtp2_date date
		,dtp2_hospcode VARCHAR(5) DEFAULT NULL
		,dtp2_input_hosp VARCHAR(5) DEFAULT NULL 
		,dtp3_date date
		,dtp3_hospcode VARCHAR(5) DEFAULT NULL
		,dtp3_input_hosp VARCHAR(5) DEFAULT NULL 
		,dtp4_date date
		,dtp4_hospcode VARCHAR(5) DEFAULT NULL
		,dtp4_input_hosp VARCHAR(5) DEFAULT NULL 
		,dtp5_date date
		,dtp5_hospcode VARCHAR(5) DEFAULT NULL
		,dtp5_input_hosp VARCHAR(5) DEFAULT NULL 

		,bcgs_date date
		,bcgs_hospcode VARCHAR(5) DEFAULT NULL
		,bcgs_input_hosp VARCHAR(5) DEFAULT NULL 

		,dts1_date date
		,dts1_hospcode VARCHAR(5) DEFAULT NULL
		,dts1_input_hosp VARCHAR(5) DEFAULT NULL 
		,dts2_date date
		,dts2_hospcode VARCHAR(5) DEFAULT NULL
		,dts2_input_hosp VARCHAR(5) DEFAULT NULL 
		,dts3_date date
		,dts3_hospcode VARCHAR(5) DEFAULT NULL
		,dts3_input_hosp VARCHAR(5) DEFAULT NULL 
		,dts4_date date
		,dts4_hospcode VARCHAR(5) DEFAULT NULL
		,dts4_input_hosp VARCHAR(5) DEFAULT NULL 

		,je1_date date
		,je1_hospcode VARCHAR(5) DEFAULT NULL
		,je1_input_hosp VARCHAR(5) DEFAULT NULL 
		,je2_date date
		,je2_hospcode VARCHAR(5) DEFAULT NULL
		,je2_input_hosp VARCHAR(5) DEFAULT NULL 
		,je3_date date
		,je3_hospcode VARCHAR(5) DEFAULT NULL
		,je3_input_hosp VARCHAR(5) DEFAULT NULL 

		,j11_date date
		,j11_hospcode VARCHAR(5) DEFAULT NULL
		,j11_input_hosp VARCHAR(5) DEFAULT NULL 
		,j12_date date
		,j12_hospcode VARCHAR(5) DEFAULT NULL
		,j12_input_hosp VARCHAR(5) DEFAULT NULL 

		,mmr1_date date
		,mmr1_hospcode VARCHAR(5) DEFAULT NULL
		,mmr1_input_hosp VARCHAR(5) DEFAULT NULL 
		,mmr2_date date
		,mmr2_hospcode VARCHAR(5) DEFAULT NULL
		,mmr2_input_hosp VARCHAR(5) DEFAULT NULL 
		,mmrs_date date
		,mmrs_hospcode VARCHAR(5) DEFAULT NULL
		,mmrs_input_hosp VARCHAR(5) DEFAULT NULL 
		,mrs_date date
		,mrs_hospcode VARCHAR(5) DEFAULT NULL
		,mrs_input_hosp VARCHAR(5) DEFAULT NULL 
		,mrc_date date
		,mrc_hospcode VARCHAR(5) DEFAULT NULL
		,mrc_input_hosp VARCHAR(5) DEFAULT NULL 
		,mmrc_date date
		,mmrc_hospcode VARCHAR(5) DEFAULT NULL
		,mmrc_input_hosp VARCHAR(5) DEFAULT NULL 

		,hpv1_date date
		,hpv1_hospcode VARCHAR(5) DEFAULT NULL
		,hpv1_input_hosp VARCHAR(5) DEFAULT NULL 
		,hpv2_date date
		,hpv2_hospcode VARCHAR(5) DEFAULT NULL
		,hpv2_input_hosp VARCHAR(5) DEFAULT NULL 
		,hpv3_date date
		,hpv3_hospcode VARCHAR(5) DEFAULT NULL
		,hpv3_input_hosp VARCHAR(5) DEFAULT NULL 

		,ipv2_date date
		,ipv2_hospcode VARCHAR(5) DEFAULT NULL
		,ipv2_input_hosp VARCHAR(5) DEFAULT NULL 

		,rv21_date date
		,rv21_hospcode VARCHAR(5) DEFAULT NULL
		,rv21_input_hosp VARCHAR(5) DEFAULT NULL 
		,rv22_date date
		,rv22_hospcode VARCHAR(5) DEFAULT NULL
		,rv22_input_hosp VARCHAR(5) DEFAULT NULL 

		,rv31_date date
		,rv31_hospcode VARCHAR(5) DEFAULT NULL
		,rv31_input_hosp VARCHAR(5) DEFAULT NULL 
		,rv32_date date
		,rv32_hospcode VARCHAR(5) DEFAULT NULL
		,rv32_input_hosp VARCHAR(5) DEFAULT NULL 
		,rv33_date date
		,rv33_hospcode VARCHAR(5) DEFAULT NULL
		,rv33_input_hosp VARCHAR(5) DEFAULT NULL 


	,PRIMARY KEY (id)
	,KEY cid (cid)
,KEY  (hospcode)
,KEY  (typearea)

) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO t_person_epi (cid,hospcode,pid,typearea,BIRTH,SEX,NATION,vhid)
(	SELECT 
					pe.cid,pe.check_hosp,pe.pid,pe.check_typearea,pe.BIRTH,pe.SEX,pe.NATION,check_vhid
	FROM
					tmp_epi as tt
				LEFT JOIN t_person_cid as pe ON tt.CID=pe.CID
	WHERE pe.age_y < 14	
	GROUP BY pe.CID
);

/****BCG******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.bcg_date =e.DATE_SERV, p.bcg_hospcode =e.VACCINEPLACE, p.bcg_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('010');

/****HBV1******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.hbv1_date =e.DATE_SERV, p.hbv1_hospcode =e.VACCINEPLACE, p.hbv1_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('041','091','D51','H31');
/****HBV2******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.hbv2_date =e.DATE_SERV, p.hbv2_hospcode =e.VACCINEPLACE, p.hbv2_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('042','092','D52','H32');
/****HBV3******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.hbv3_date =e.DATE_SERV, p.hbv3_hospcode =e.VACCINEPLACE, p.hbv3_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('043','093','H33','D23','D53');

/****OPV1******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.opv1_date =e.DATE_SERV, p.opv1_hospcode =e.VACCINEPLACE, p.opv1_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('081','D31','D41','D51','I11');
/****OPV2******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.opv2_date =e.DATE_SERV, p.opv2_hospcode =e.VACCINEPLACE, p.opv2_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('082','D32','D42','D52','I12');
/****OPV3******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.opv3_date =e.DATE_SERV, p.opv3_hospcode =e.VACCINEPLACE, p.opv3_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('083','D33','D43','D53','I13');
/****OPV4******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.opv4_date =e.DATE_SERV, p.opv4_hospcode =e.VACCINEPLACE, p.opv4_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('084','D34','D44','D54','I14');
/****OPV5******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.opv5_date =e.DATE_SERV, p.opv5_hospcode =e.VACCINEPLACE, p.opv5_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('085','D35','D45','D55','I15');
/****OPVS1******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.opvs1_date =e.DATE_SERV, p.opvs1_hospcode =e.VACCINEPLACE, p.opvs1_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('086');
/****OPVS2******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.opvs2_date =e.DATE_SERV, p.opvs2_hospcode =e.VACCINEPLACE, p.opvs2_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('087');
/****OPVS3******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.opvs3_date =e.DATE_SERV, p.opvs3_hospcode =e.VACCINEPLACE, p.opvs3_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('088');

/****DTP1******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.dtp1_date =e.DATE_SERV, p.dtp1_hospcode =e.VACCINEPLACE, p.dtp1_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('031','091','D11','D21','D31','D41','D51');
/****DTP2******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.dtp2_date =e.DATE_SERV, p.dtp2_hospcode =e.VACCINEPLACE, p.dtp2_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('032','092','D12','D22','D32','D42','D52');
/****DTP3******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.dtp3_date =e.DATE_SERV, p.dtp3_hospcode =e.VACCINEPLACE, p.dtp3_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('033','093','D13','D23','D33','D43','D53');
/****DTP4******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.dtp4_date =e.DATE_SERV, p.dtp4_hospcode =e.VACCINEPLACE, p.dtp4_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('034','D14','D24','D34','D44','D54');
/****DTP5******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.dtp5_date =e.DATE_SERV, p.dtp5_hospcode =e.VACCINEPLACE, p.dtp5_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('035','D35','D45','D55');

/****BCGS******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.bcgs_date =e.DATE_SERV, p.bcgs_hospcode =e.VACCINEPLACE, p.bcgs_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('011');

/****DTS1******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.dts1_date =e.DATE_SERV, p.dts1_hospcode =e.VACCINEPLACE, p.dts1_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('021');
/****DTS2******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.dts2_date =e.DATE_SERV, p.dts2_hospcode =e.VACCINEPLACE, p.dts2_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('022');
/****DTS3******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.dts3_date =e.DATE_SERV, p.dts3_hospcode =e.VACCINEPLACE, p.dts3_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('023');
/****DTS4******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.dts4_date =e.DATE_SERV, p.dts4_hospcode =e.VACCINEPLACE, p.dts4_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('024');

/****JE1******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.je1_date =e.DATE_SERV, p.je1_hospcode =e.VACCINEPLACE, p.je1_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('051');
/****JE2******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.je2_date =e.DATE_SERV, p.je2_hospcode =e.VACCINEPLACE, p.je2_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('052');
/****JE3******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.je3_date =e.DATE_SERV, p.je3_hospcode =e.VACCINEPLACE, p.je3_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('053');

/****J11******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.j11_date =e.DATE_SERV, p.j11_hospcode =e.VACCINEPLACE, p.j11_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('J11');
/****J12******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.j12_date =e.DATE_SERV, p.j12_hospcode =e.VACCINEPLACE, p.j12_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('J12');

/****MMR1=MMR 9 เดือน******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.mmr1_date =e.DATE_SERV, p.mmr1_hospcode =e.VACCINEPLACE, p.mmr1_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('061','M11');
/****MMR2* 2ปี /หรือห่าง mmr1 6wks*****/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.mmr2_date =e.DATE_SERV, p.mmr2_hospcode =e.VACCINEPLACE, p.mmr2_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('073','M12');

/****MMRS ป1******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.mmrs_date =e.DATE_SERV, p.mmrs_hospcode =e.VACCINEPLACE, p.mmrs_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('072');
/****MRS ป1******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.mrs_date =e.DATE_SERV, p.mrs_hospcode =e.VACCINEPLACE, p.mrs_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('075');

/****MRC******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.mrc_date =e.DATE_SERV, p.mrc_hospcode =e.VACCINEPLACE, p.mrc_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('074');

/****MMRC******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.mmrc_date =e.DATE_SERV, p.mmrc_hospcode =e.VACCINEPLACE, p.mmrc_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('076');


/****HPV1******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.hpv1_date =e.DATE_SERV, p.hpv1_hospcode =e.VACCINEPLACE, p.hpv1_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('H31','310');
/****HPV2******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.hpv2_date =e.DATE_SERV, p.hpv2_hospcode =e.VACCINEPLACE, p.hpv2_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('H32','320');
/****HPV3******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.hpv3_date =e.DATE_SERV, p.hpv3_hospcode =e.VACCINEPLACE, p.hpv3_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('H33','311');

/****IPV2******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.ipv2_date =e.DATE_SERV, p.ipv2_hospcode =e.VACCINEPLACE, p.ipv2_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('401','D32','D42','D52','I12');

/****RV21******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.rv21_date =e.DATE_SERV, p.rv21_hospcode =e.VACCINEPLACE, p.rv21_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('R11');
/****RV22******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.rv22_date =e.DATE_SERV, p.rv22_hospcode =e.VACCINEPLACE, p.rv22_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('R12');
/****RV31******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.rv31_date =e.DATE_SERV, p.rv31_hospcode =e.VACCINEPLACE, p.rv31_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('R21');
/****RV32******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.rv32_date =e.DATE_SERV, p.rv32_hospcode =e.VACCINEPLACE, p.rv32_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('R22');
/****RV33******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.rv33_date =e.DATE_SERV, p.rv33_hospcode =e.VACCINEPLACE, p.rv33_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('R23');

/****food******/
UPDATE  t_person_epi p INNER JOIN (
	SELECT cid,food,DATE_SERV,hospcode FROM tmp_nutrition WHERE food in(1,2,3,4) ORDER BY CONCAT(cid,DATE_SERV) DESC 
) n ON p.cid=n.cid 
SET p.food_date =n.DATE_SERV, p.food =n.food, p.food_input_hosp =n.hospcode;
/****childdev******/
UPDATE  t_person_epi p INNER JOIN (
	SELECT cid,childdevelop,DATE_SERV,hospcode FROM tmp_nutrition WHERE childdevelop in(1,2,3) ORDER BY CONCAT(cid,DATE_SERV) DESC 
) n ON p.cid=n.cid 
SET p.childdevelop_date =n.DATE_SERV, p.childdevelop =n.childdevelop, p.childdevelop_input_hosp =n.hospcode;

/****newborn******/
UPDATE  t_person_epi p INNER JOIN 
(SELECT n.* FROM tmp_newborn  n INNER JOIN chospital h ON n.hospcode=h.hoscode 
WHERE h.hostype IN(5,6,7,11) AND n.HOSPCODE= n.BHOSP 
) n ON p.cid=n.cid 
SET p.bweight =n.BWEIGHT, p.bw_input_hosp =n.hospcode;

UPDATE  t_person_epi p INNER JOIN tmp_newborn  n ON p.cid=n.cid 
SET p.bweight =n.BWEIGHT, p.bw_input_hosp =n.hospcode
WHERE ISNULL(p.bweight);

 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.129241;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:59;a:5:{i:0;s:17586:"CREATE PROCEDURE t_person_epi()
 BEGIN 
SET @prov_c := '58';
SET @id := '5';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
SET	@date_3:=concat(@b_year-14,'1001');

DROP TABLE IF EXISTS tmp_epi;
CREATE TABLE tmp_epi (
KEY (cid),
KEY (hospcode,pid),
KEY (vaccinetype)
) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		tt.HOSPCODE,tt.PID,tt.SEQ,tt.DATE_SERV,tt.VACCINETYPE,tt.VACCINEPLACE,tt.PROVIDER,tt.D_UPDATE,pe.cid
FROM
			epi tt LEFT JOIN  t_person_db pe ON tt.HOSPCODE=pe.HOSPCODE AND tt.pid=pe.pid 
WHERE
tt.date_serv BETWEEN @date_3 AND @end_d
);

DROP TABLE IF EXISTS tmp_newborn;
CREATE TABLE tmp_newborn (
KEY (cid),
KEY (hospcode,pid),
KEY (bweight)
) ENGINE=MyISAM  AS(
SELECT t.HOSPCODE,t.PID,t.MPID,t.GRAVIDA,t.GA,t.BDATE,t.BTIME,t.BPLACE,t.bhosp,t.BIRTHNO,t.btype
,t.bdoctor,t.BWEIGHT,t.ASPHYXIA,t.VITK,t.TSH,t.TSHRESULT,t.D_UPDATE
,p.CID,p.nation,p.sex,p.check_hosp,p.check_vhid,p.check_typearea,p.vhid,p.typearea
FROM		newborn t LEFT JOIN t_person_db p ON t.HOSPCODE=p.HOSPCODE AND t.pid=p.pid 
WHERE t.bdate BETWEEN @date_3 AND @end_d
);

DROP TABLE IF EXISTS tmp_nutrition;
CREATE TABLE tmp_nutrition (
error_code varchar(255) DEFAULT NULL,
KEY (cid),
KEY (hospcode,pid),
KEY (food,childdevelop)
) ENGINE=MyISAM  AS(
SELECT 
		t.HOSPCODE,t.PID,t.SEQ,t.DATE_SERV,t.NUTRITIONPLACE,t.WEIGHT,t.HEIGHT,t.HEADCIRCUM,t.CHILDDEVELOP,t.FOOD,t.BOTTLE,t.PROVIDER,t.D_UPDATE,pe.cid,null as error_code
FROM
			nutrition t LEFT JOIN t_person_db pe ON t.HOSPCODE=pe.HOSPCODE AND t.pid=pe.pid 
WHERE
t.date_serv BETWEEN @date_3 AND @end_d
);
UPDATE tmp_nutrition n INNER JOIN person p  ON n.HOSPCODE=p.HOSPCODE AND n.PID=p.PID
SET error_code =IF(ISNULL(n.error_code),'NU0001',CONCAT(n.error_code,',','NU0001') ) 
WHERE  DATE_SERV BETWEEN @start_d AND @end_d AND n.DATE_SERV < p.BIRTH;


DROP TABLE IF EXISTS t_person_epi;
CREATE TABLE IF NOT EXISTS t_person_epi (
		id int(15) NOT NULL AUTO_INCREMENT
		,hospcode varchar(5) NOT NULL
	  ,pid varchar(15) NOT NULL 
		,typearea varchar(1) NOT NULL 
		,vhid varchar(8) DEFAULT NULL 
		,cid VARCHAR(13) NOT NULL
		,birth date
		,sex VARCHAR(1) DEFAULT NULL 
		,nation VARCHAR(3) DEFAULT NULL 
		,bweight int(4) DEFAULT 0
		,bw_input_hosp VARCHAR(5) DEFAULT NULL 
		,food VARCHAR(1) DEFAULT NULL 
		,food_date date
		,food_input_hosp VARCHAR(5) DEFAULT NULL 

		,childdevelop VARCHAR(1) DEFAULT NULL 
		,childdevelop_date date
		,childdevelop_input_hosp VARCHAR(5) DEFAULT NULL 
		
		,bcg_date date
		,bcg_hospcode VARCHAR(5) DEFAULT NULL
		,bcg_input_hosp VARCHAR(5) DEFAULT NULL 

		,hbv1_date date
		,hbv1_hospcode VARCHAR(5) DEFAULT NULL
		,hbv1_input_hosp VARCHAR(5) DEFAULT NULL 
		,hbv2_date date
		,hbv2_hospcode VARCHAR(5) DEFAULT NULL
		,hbv2_input_hosp VARCHAR(5) DEFAULT NULL 
		,hbv3_date date
		,hbv3_hospcode VARCHAR(5) DEFAULT NULL
		,hbv3_input_hosp VARCHAR(5) DEFAULT NULL 
	
		,opv1_date date
		,opv1_hospcode VARCHAR(5) DEFAULT NULL
		,opv1_input_hosp VARCHAR(5) DEFAULT NULL 
		,opv2_date date
		,opv2_hospcode VARCHAR(5) DEFAULT NULL
		,opv2_input_hosp VARCHAR(5) DEFAULT NULL 
		,opv3_date date
		,opv3_hospcode VARCHAR(5) DEFAULT NULL
		,opv3_input_hosp VARCHAR(5) DEFAULT NULL 
		,opv4_date date
		,opv4_hospcode VARCHAR(5) DEFAULT NULL
		,opv4_input_hosp VARCHAR(5) DEFAULT NULL 
		,opv5_date date
		,opv5_hospcode VARCHAR(5) DEFAULT NULL
		,opv5_input_hosp VARCHAR(5) DEFAULT NULL 

		,opvs1_date date
		,opvs1_hospcode VARCHAR(5) DEFAULT NULL
		,opvs1_input_hosp VARCHAR(5) DEFAULT NULL 
		,opvs2_date date
		,opvs2_hospcode VARCHAR(5) DEFAULT NULL
		,opvs2_input_hosp VARCHAR(5) DEFAULT NULL 
		,opvs3_date date
		,opvs3_hospcode VARCHAR(5) DEFAULT NULL
		,opvs3_input_hosp VARCHAR(5) DEFAULT NULL 

		,dtp1_date date
		,dtp1_hospcode VARCHAR(5) DEFAULT NULL
		,dtp1_input_hosp VARCHAR(5) DEFAULT NULL 
		,dtp2_date date
		,dtp2_hospcode VARCHAR(5) DEFAULT NULL
		,dtp2_input_hosp VARCHAR(5) DEFAULT NULL 
		,dtp3_date date
		,dtp3_hospcode VARCHAR(5) DEFAULT NULL
		,dtp3_input_hosp VARCHAR(5) DEFAULT NULL 
		,dtp4_date date
		,dtp4_hospcode VARCHAR(5) DEFAULT NULL
		,dtp4_input_hosp VARCHAR(5) DEFAULT NULL 
		,dtp5_date date
		,dtp5_hospcode VARCHAR(5) DEFAULT NULL
		,dtp5_input_hosp VARCHAR(5) DEFAULT NULL 

		,bcgs_date date
		,bcgs_hospcode VARCHAR(5) DEFAULT NULL
		,bcgs_input_hosp VARCHAR(5) DEFAULT NULL 

		,dts1_date date
		,dts1_hospcode VARCHAR(5) DEFAULT NULL
		,dts1_input_hosp VARCHAR(5) DEFAULT NULL 
		,dts2_date date
		,dts2_hospcode VARCHAR(5) DEFAULT NULL
		,dts2_input_hosp VARCHAR(5) DEFAULT NULL 
		,dts3_date date
		,dts3_hospcode VARCHAR(5) DEFAULT NULL
		,dts3_input_hosp VARCHAR(5) DEFAULT NULL 
		,dts4_date date
		,dts4_hospcode VARCHAR(5) DEFAULT NULL
		,dts4_input_hosp VARCHAR(5) DEFAULT NULL 

		,je1_date date
		,je1_hospcode VARCHAR(5) DEFAULT NULL
		,je1_input_hosp VARCHAR(5) DEFAULT NULL 
		,je2_date date
		,je2_hospcode VARCHAR(5) DEFAULT NULL
		,je2_input_hosp VARCHAR(5) DEFAULT NULL 
		,je3_date date
		,je3_hospcode VARCHAR(5) DEFAULT NULL
		,je3_input_hosp VARCHAR(5) DEFAULT NULL 

		,j11_date date
		,j11_hospcode VARCHAR(5) DEFAULT NULL
		,j11_input_hosp VARCHAR(5) DEFAULT NULL 
		,j12_date date
		,j12_hospcode VARCHAR(5) DEFAULT NULL
		,j12_input_hosp VARCHAR(5) DEFAULT NULL 

		,mmr1_date date
		,mmr1_hospcode VARCHAR(5) DEFAULT NULL
		,mmr1_input_hosp VARCHAR(5) DEFAULT NULL 
		,mmr2_date date
		,mmr2_hospcode VARCHAR(5) DEFAULT NULL
		,mmr2_input_hosp VARCHAR(5) DEFAULT NULL 
		,mmrs_date date
		,mmrs_hospcode VARCHAR(5) DEFAULT NULL
		,mmrs_input_hosp VARCHAR(5) DEFAULT NULL 
		,mrs_date date
		,mrs_hospcode VARCHAR(5) DEFAULT NULL
		,mrs_input_hosp VARCHAR(5) DEFAULT NULL 
		,mrc_date date
		,mrc_hospcode VARCHAR(5) DEFAULT NULL
		,mrc_input_hosp VARCHAR(5) DEFAULT NULL 
		,mmrc_date date
		,mmrc_hospcode VARCHAR(5) DEFAULT NULL
		,mmrc_input_hosp VARCHAR(5) DEFAULT NULL 

		,hpv1_date date
		,hpv1_hospcode VARCHAR(5) DEFAULT NULL
		,hpv1_input_hosp VARCHAR(5) DEFAULT NULL 
		,hpv2_date date
		,hpv2_hospcode VARCHAR(5) DEFAULT NULL
		,hpv2_input_hosp VARCHAR(5) DEFAULT NULL 
		,hpv3_date date
		,hpv3_hospcode VARCHAR(5) DEFAULT NULL
		,hpv3_input_hosp VARCHAR(5) DEFAULT NULL 

		,ipv2_date date
		,ipv2_hospcode VARCHAR(5) DEFAULT NULL
		,ipv2_input_hosp VARCHAR(5) DEFAULT NULL 

		,rv21_date date
		,rv21_hospcode VARCHAR(5) DEFAULT NULL
		,rv21_input_hosp VARCHAR(5) DEFAULT NULL 
		,rv22_date date
		,rv22_hospcode VARCHAR(5) DEFAULT NULL
		,rv22_input_hosp VARCHAR(5) DEFAULT NULL 

		,rv31_date date
		,rv31_hospcode VARCHAR(5) DEFAULT NULL
		,rv31_input_hosp VARCHAR(5) DEFAULT NULL 
		,rv32_date date
		,rv32_hospcode VARCHAR(5) DEFAULT NULL
		,rv32_input_hosp VARCHAR(5) DEFAULT NULL 
		,rv33_date date
		,rv33_hospcode VARCHAR(5) DEFAULT NULL
		,rv33_input_hosp VARCHAR(5) DEFAULT NULL 


	,PRIMARY KEY (id)
	,KEY cid (cid)
,KEY  (hospcode)
,KEY  (typearea)

) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO t_person_epi (cid,hospcode,pid,typearea,BIRTH,SEX,NATION,vhid)
(	SELECT 
					pe.cid,pe.check_hosp,pe.pid,pe.check_typearea,pe.BIRTH,pe.SEX,pe.NATION,check_vhid
	FROM
					tmp_epi as tt
				LEFT JOIN t_person_cid as pe ON tt.CID=pe.CID
	WHERE pe.age_y < 14	
	GROUP BY pe.CID
);

/****BCG******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.bcg_date =e.DATE_SERV, p.bcg_hospcode =e.VACCINEPLACE, p.bcg_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('010');

/****HBV1******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.hbv1_date =e.DATE_SERV, p.hbv1_hospcode =e.VACCINEPLACE, p.hbv1_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('041','091','D51','H31');
/****HBV2******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.hbv2_date =e.DATE_SERV, p.hbv2_hospcode =e.VACCINEPLACE, p.hbv2_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('042','092','D52','H32');
/****HBV3******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.hbv3_date =e.DATE_SERV, p.hbv3_hospcode =e.VACCINEPLACE, p.hbv3_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('043','093','H33','D23','D53');

/****OPV1******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.opv1_date =e.DATE_SERV, p.opv1_hospcode =e.VACCINEPLACE, p.opv1_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('081','D31','D41','D51','I11');
/****OPV2******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.opv2_date =e.DATE_SERV, p.opv2_hospcode =e.VACCINEPLACE, p.opv2_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('082','D32','D42','D52','I12');
/****OPV3******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.opv3_date =e.DATE_SERV, p.opv3_hospcode =e.VACCINEPLACE, p.opv3_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('083','D33','D43','D53','I13');
/****OPV4******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.opv4_date =e.DATE_SERV, p.opv4_hospcode =e.VACCINEPLACE, p.opv4_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('084','D34','D44','D54','I14');
/****OPV5******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.opv5_date =e.DATE_SERV, p.opv5_hospcode =e.VACCINEPLACE, p.opv5_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('085','D35','D45','D55','I15');
/****OPVS1******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.opvs1_date =e.DATE_SERV, p.opvs1_hospcode =e.VACCINEPLACE, p.opvs1_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('086');
/****OPVS2******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.opvs2_date =e.DATE_SERV, p.opvs2_hospcode =e.VACCINEPLACE, p.opvs2_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('087');
/****OPVS3******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.opvs3_date =e.DATE_SERV, p.opvs3_hospcode =e.VACCINEPLACE, p.opvs3_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('088');

/****DTP1******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.dtp1_date =e.DATE_SERV, p.dtp1_hospcode =e.VACCINEPLACE, p.dtp1_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('031','091','D11','D21','D31','D41','D51');
/****DTP2******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.dtp2_date =e.DATE_SERV, p.dtp2_hospcode =e.VACCINEPLACE, p.dtp2_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('032','092','D12','D22','D32','D42','D52');
/****DTP3******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.dtp3_date =e.DATE_SERV, p.dtp3_hospcode =e.VACCINEPLACE, p.dtp3_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('033','093','D13','D23','D33','D43','D53');
/****DTP4******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.dtp4_date =e.DATE_SERV, p.dtp4_hospcode =e.VACCINEPLACE, p.dtp4_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('034','D14','D24','D34','D44','D54');
/****DTP5******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.dtp5_date =e.DATE_SERV, p.dtp5_hospcode =e.VACCINEPLACE, p.dtp5_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('035','D35','D45','D55');

/****BCGS******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.bcgs_date =e.DATE_SERV, p.bcgs_hospcode =e.VACCINEPLACE, p.bcgs_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('011');

/****DTS1******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.dts1_date =e.DATE_SERV, p.dts1_hospcode =e.VACCINEPLACE, p.dts1_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('021');
/****DTS2******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.dts2_date =e.DATE_SERV, p.dts2_hospcode =e.VACCINEPLACE, p.dts2_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('022');
/****DTS3******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.dts3_date =e.DATE_SERV, p.dts3_hospcode =e.VACCINEPLACE, p.dts3_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('023');
/****DTS4******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.dts4_date =e.DATE_SERV, p.dts4_hospcode =e.VACCINEPLACE, p.dts4_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('024');

/****JE1******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.je1_date =e.DATE_SERV, p.je1_hospcode =e.VACCINEPLACE, p.je1_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('051');
/****JE2******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.je2_date =e.DATE_SERV, p.je2_hospcode =e.VACCINEPLACE, p.je2_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('052');
/****JE3******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.je3_date =e.DATE_SERV, p.je3_hospcode =e.VACCINEPLACE, p.je3_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('053');

/****J11******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.j11_date =e.DATE_SERV, p.j11_hospcode =e.VACCINEPLACE, p.j11_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('J11');
/****J12******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.j12_date =e.DATE_SERV, p.j12_hospcode =e.VACCINEPLACE, p.j12_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('J12');

/****MMR1=MMR 9 เดือน******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.mmr1_date =e.DATE_SERV, p.mmr1_hospcode =e.VACCINEPLACE, p.mmr1_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('061','M11');
/****MMR2* 2ปี /หรือห่าง mmr1 6wks*****/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.mmr2_date =e.DATE_SERV, p.mmr2_hospcode =e.VACCINEPLACE, p.mmr2_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('073','M12');

/****MMRS ป1******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.mmrs_date =e.DATE_SERV, p.mmrs_hospcode =e.VACCINEPLACE, p.mmrs_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('072');
/****MRS ป1******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.mrs_date =e.DATE_SERV, p.mrs_hospcode =e.VACCINEPLACE, p.mrs_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('075');

/****MRC******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.mrc_date =e.DATE_SERV, p.mrc_hospcode =e.VACCINEPLACE, p.mrc_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('074');

/****MMRC******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.mmrc_date =e.DATE_SERV, p.mmrc_hospcode =e.VACCINEPLACE, p.mmrc_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('076');


/****HPV1******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.hpv1_date =e.DATE_SERV, p.hpv1_hospcode =e.VACCINEPLACE, p.hpv1_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('H31','310');
/****HPV2******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.hpv2_date =e.DATE_SERV, p.hpv2_hospcode =e.VACCINEPLACE, p.hpv2_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('H32','320');
/****HPV3******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.hpv3_date =e.DATE_SERV, p.hpv3_hospcode =e.VACCINEPLACE, p.hpv3_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('H33','311');

/****IPV2******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.ipv2_date =e.DATE_SERV, p.ipv2_hospcode =e.VACCINEPLACE, p.ipv2_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('401','D32','D42','D52','I12');

/****RV21******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.rv21_date =e.DATE_SERV, p.rv21_hospcode =e.VACCINEPLACE, p.rv21_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('R11');
/****RV22******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.rv22_date =e.DATE_SERV, p.rv22_hospcode =e.VACCINEPLACE, p.rv22_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('R12');
/****RV31******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.rv31_date =e.DATE_SERV, p.rv31_hospcode =e.VACCINEPLACE, p.rv31_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('R21');
/****RV32******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.rv32_date =e.DATE_SERV, p.rv32_hospcode =e.VACCINEPLACE, p.rv32_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('R22');
/****RV33******/
UPDATE  t_person_epi p INNER JOIN tmp_epi e ON p.cid=e.cid 
SET p.rv33_date =e.DATE_SERV, p.rv33_hospcode =e.VACCINEPLACE, p.rv33_input_hosp =e.hospcode
WHERE e.VACCINETYPE in('R23');

/****food******/
UPDATE  t_person_epi p INNER JOIN (
	SELECT cid,food,DATE_SERV,hospcode FROM tmp_nutrition WHERE food in(1,2,3,4) ORDER BY CONCAT(cid,DATE_SERV) DESC 
) n ON p.cid=n.cid 
SET p.food_date =n.DATE_SERV, p.food =n.food, p.food_input_hosp =n.hospcode;
/****childdev******/
UPDATE  t_person_epi p INNER JOIN (
	SELECT cid,childdevelop,DATE_SERV,hospcode FROM tmp_nutrition WHERE childdevelop in(1,2,3) ORDER BY CONCAT(cid,DATE_SERV) DESC 
) n ON p.cid=n.cid 
SET p.childdevelop_date =n.DATE_SERV, p.childdevelop =n.childdevelop, p.childdevelop_input_hosp =n.hospcode;

/****newborn******/
UPDATE  t_person_epi p INNER JOIN 
(SELECT n.* FROM tmp_newborn  n INNER JOIN chospital h ON n.hospcode=h.hoscode 
WHERE h.hostype IN(5,6,7,11) AND n.HOSPCODE= n.BHOSP 
) n ON p.cid=n.cid 
SET p.bweight =n.BWEIGHT, p.bw_input_hosp =n.hospcode;

UPDATE  t_person_epi p INNER JOIN tmp_newborn  n ON p.cid=n.cid 
SET p.bweight =n.BWEIGHT, p.bw_input_hosp =n.hospcode
WHERE ISNULL(p.bweight);

 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.222842;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:61;a:5:{i:0;s:34:"DROP PROCEDURE IF EXISTS t_village";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.222842;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:62;a:5:{i:0;s:34:"DROP PROCEDURE IF EXISTS t_village";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.2852421;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:64;a:5:{i:0;s:642:"CREATE PROCEDURE t_village()
 BEGIN 
SET @prov_c := '58';
SET @id := '6';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS t_village ;

CREATE TABLE t_village (
KEY (hospcode,vid)
) ENGINE=MyISAM  AS(

SELECT
*
FROM
(
	(SELECT 
		v.HOSPCODE,v.VID
	FROM
		village v
	GROUP BY v.HOSPCODE,v.VID
	)
	UNION
	(SELECT 
		v.HOSPCODE,CONCAT(h.provcode,h.distcode,h.subdistcode,'00')
	FROM
		village v ,chospital h
	WHERE v.HOSPCODE=h.hoscode
	GROUP BY v.HOSPCODE
	) 
) as vv
ORDER BY hospcode,vid
);


 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.2852421;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:65;a:5:{i:0;s:642:"CREATE PROCEDURE t_village()
 BEGIN 
SET @prov_c := '58';
SET @id := '6';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS t_village ;

CREATE TABLE t_village (
KEY (hospcode,vid)
) ENGINE=MyISAM  AS(

SELECT
*
FROM
(
	(SELECT 
		v.HOSPCODE,v.VID
	FROM
		village v
	GROUP BY v.HOSPCODE,v.VID
	)
	UNION
	(SELECT 
		v.HOSPCODE,CONCAT(h.provcode,h.distcode,h.subdistcode,'00')
	FROM
		village v ,chospital h
	WHERE v.HOSPCODE=h.hoscode
	GROUP BY v.HOSPCODE
	) 
) as vv
ORDER BY hospcode,vid
);


 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.3476419;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:67;a:5:{i:0;s:34:"DROP PROCEDURE IF EXISTS t_surveil";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.3476419;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:68;a:5:{i:0;s:34:"DROP PROCEDURE IF EXISTS t_surveil";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.410042;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:70;a:5:{i:0;s:2675:"CREATE PROCEDURE t_surveil()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '7';
SET @b_year:=IF(MONTH(NOW())=1 AND DAY(NOW())<=5,year(NOW())-1,year(NOW()));
SET @start_d:=concat(@b_year,'0101');
SET @end_d:=concat(@b_year,'1231');

DROP TABLE IF EXISTS t_surveil;
CREATE TABLE IF NOT EXISTS t_surveil (
  `hospcode` varchar(5) not null,
  `pid` varchar(15) not null,
  `cid` varchar(13) not null,
	`seq` varchar(16) not null,
	`fname` varchar(100) not null,
	`lname` varchar(100) not null,
	`sex` varchar(1) not null,
	`areacode` varchar(8) not null,
	`birth` date not null,
	`age_y` int(3) not null,
	`age_m` int(3) not null,
	`age_d` int(3) not null,
  `date_serv` date not null,
  `an` varchar(9) default null,
  `datetime_admit` datetime default null,
  `diagcode` varchar(6) not null,
  `diagcodelast` varchar(6) default null,
  `code506` varchar(2) not null,
  `code506last` varchar(2) default null,
  `illdate` date not null,
  `illhouse` varchar(75) default null,
  `ill_areacode` varchar(8) default null,
  `ptstatus` char(1) not null,
  `date_death` date default null,
  `groupname1560` varchar(50) default null,
	`groupname190` varchar(50) default null,		
	`groupname506` varchar(255) default null,  
	key (`hospcode`,`pid`,`seq`,`code506`),
	key (`code506`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO t_surveil
(
`hospcode`,`pid`,`cid`,`seq`,`fname`,`lname`,`sex`,`areacode`,`birth`
,`age_y`,`age_m`,`age_d`,`date_serv`,`an`,`datetime_admit`,`diagcode`
,`diagcodelast`,`code506`,`code506last`,`illdate`,`illhouse`,`ill_areacode`
,`ptstatus`,`date_death`,`groupname1560`,`groupname190`,`groupname506`
)
(
SELECT SQL_BIG_RESULT 
	t1.*,a.groupname1560,a.groupname190
	,if(l.group506code is not null,l.group506name
	,if(l.group506code is null,r.group506name,NULL
	))
FROM
(SELECT
	s.HOSPCODE,s.PID,p.CID,s.SEQ,p.`NAME` as fname,p.LNAME,p.SEX,concat(h.provcode,h.distcode,h.subdistcode,SUBSTR(CONCAT('00',h.mu),-2))
	,p.BIRTH,age(s.ILLDATE,p.BIRTH,'y') as yy ,age(s.ILLDATE,p.BIRTH,'m') as mm , age(s.ILLDATE,p.BIRTH,'d') as dd,s.DATE_SERV
	,s.AN,s.DATETIME_ADMIT,s.DIAGCODE,s.DIAGCODELAST,s.CODE506,s.CODE506LAST,s.ILLDATE,s.ILLHOUSE
	,CONCAT(s.ILLCHANGWAT,s.ILLAMPUR,s.ILLTAMBON,SUBSTR(CONCAT('00',s.ILLVILLAGE),-2)) as ill_areacode,s.PTSTATUS,s.DATE_DEATH
 
FROM
		surveillance s 
		LEFT JOIN t_person_db p  ON s.HOSPCODE=p.HOSPCODE AND s.PID=p.PID 
		LEFT JOIN chospital h ON  s.HOSPCODE=h.hoscode
WHERE 
 (s.DATE_SERV BETWEEN @start_d AND @end_d)
) as t1 ,cage a,cdisease506 r,cdisease506 l
WHERE  t1.yy=a.age AND t1.CODE506=r.group506code AND t1.CODE506LAST=l.group506code
);


 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.410042;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:71;a:5:{i:0;s:2675:"CREATE PROCEDURE t_surveil()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '7';
SET @b_year:=IF(MONTH(NOW())=1 AND DAY(NOW())<=5,year(NOW())-1,year(NOW()));
SET @start_d:=concat(@b_year,'0101');
SET @end_d:=concat(@b_year,'1231');

DROP TABLE IF EXISTS t_surveil;
CREATE TABLE IF NOT EXISTS t_surveil (
  `hospcode` varchar(5) not null,
  `pid` varchar(15) not null,
  `cid` varchar(13) not null,
	`seq` varchar(16) not null,
	`fname` varchar(100) not null,
	`lname` varchar(100) not null,
	`sex` varchar(1) not null,
	`areacode` varchar(8) not null,
	`birth` date not null,
	`age_y` int(3) not null,
	`age_m` int(3) not null,
	`age_d` int(3) not null,
  `date_serv` date not null,
  `an` varchar(9) default null,
  `datetime_admit` datetime default null,
  `diagcode` varchar(6) not null,
  `diagcodelast` varchar(6) default null,
  `code506` varchar(2) not null,
  `code506last` varchar(2) default null,
  `illdate` date not null,
  `illhouse` varchar(75) default null,
  `ill_areacode` varchar(8) default null,
  `ptstatus` char(1) not null,
  `date_death` date default null,
  `groupname1560` varchar(50) default null,
	`groupname190` varchar(50) default null,		
	`groupname506` varchar(255) default null,  
	key (`hospcode`,`pid`,`seq`,`code506`),
	key (`code506`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO t_surveil
(
`hospcode`,`pid`,`cid`,`seq`,`fname`,`lname`,`sex`,`areacode`,`birth`
,`age_y`,`age_m`,`age_d`,`date_serv`,`an`,`datetime_admit`,`diagcode`
,`diagcodelast`,`code506`,`code506last`,`illdate`,`illhouse`,`ill_areacode`
,`ptstatus`,`date_death`,`groupname1560`,`groupname190`,`groupname506`
)
(
SELECT SQL_BIG_RESULT 
	t1.*,a.groupname1560,a.groupname190
	,if(l.group506code is not null,l.group506name
	,if(l.group506code is null,r.group506name,NULL
	))
FROM
(SELECT
	s.HOSPCODE,s.PID,p.CID,s.SEQ,p.`NAME` as fname,p.LNAME,p.SEX,concat(h.provcode,h.distcode,h.subdistcode,SUBSTR(CONCAT('00',h.mu),-2))
	,p.BIRTH,age(s.ILLDATE,p.BIRTH,'y') as yy ,age(s.ILLDATE,p.BIRTH,'m') as mm , age(s.ILLDATE,p.BIRTH,'d') as dd,s.DATE_SERV
	,s.AN,s.DATETIME_ADMIT,s.DIAGCODE,s.DIAGCODELAST,s.CODE506,s.CODE506LAST,s.ILLDATE,s.ILLHOUSE
	,CONCAT(s.ILLCHANGWAT,s.ILLAMPUR,s.ILLTAMBON,SUBSTR(CONCAT('00',s.ILLVILLAGE),-2)) as ill_areacode,s.PTSTATUS,s.DATE_DEATH
 
FROM
		surveillance s 
		LEFT JOIN t_person_db p  ON s.HOSPCODE=p.HOSPCODE AND s.PID=p.PID 
		LEFT JOIN chospital h ON  s.HOSPCODE=h.hoscode
WHERE 
 (s.DATE_SERV BETWEEN @start_d AND @end_d)
) as t1 ,cage a,cdisease506 r,cdisease506 l
WHERE  t1.yy=a.age AND t1.CODE506=r.group506code AND t1.CODE506LAST=l.group506code
);


 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.4724419;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:73;a:5:{i:0;s:37:"DROP PROCEDURE IF EXISTS t_pt_surveil";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.4724419;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:74;a:5:{i:0;s:37:"DROP PROCEDURE IF EXISTS t_pt_surveil";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.534842;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:76;a:5:{i:0;s:1648:"CREATE PROCEDURE t_pt_surveil()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '8';
SET @b_year:=IF(MONTH(NOW())=1 AND DAY(NOW())<=5,year(NOW())-1,year(NOW()));
SET @start_d:=concat(@b_year,'0101');
SET @end_d:=concat(@b_year,'1231');

#DROP TABLE IF EXISTS t_pt_surveil;
CREATE TABLE IF NOT EXISTS t_pt_surveil (
  `id` varchar(32) not null,
  `code506` varchar(2) not null,
	`groupname506` varchar(255) default null,  
  `hospcode` varchar(5) not null,
	`pt_areacode` varchar(8) not null,
	`sex` varchar(1) not null,
	`age_y` int(3) not null,
  `groupname1560` varchar(50) default null,
  `yymm` varchar(50) default null,
  `wks` int(2) default 0,
	`seq` int(9) default 0,
  `pid` int(9) default 0,
  `death` int(9) default 0,
	key (groupname506,hospcode,pt_areacode,sex,groupname1560,wks)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

DELETE FROM t_pt_surveil WHERE (SUBSTR(yymm,1,4)-543)=year(now());

INSERT IGNORE INTO t_pt_surveil
(
`id`,`code506`,`groupname506`,`hospcode`,`pt_areacode`,`sex`,`age_y`,`groupname1560`,`yymm`,`wks`,`seq`,`pid`,`death`)
(
SELECT  SQL_BIG_RESULT 
	@id,if(code506last is not null,code506last,if(code506last is null,code506,NULL)) as code506
	,groupname506,hospcode,ill_areacode,sex,age_y
	,groupname1560,CONCAT((DATE_FORMAT(illdate,'%Y')+543),DATE_FORMAT(illdate,'%m')) as yymm
	,epid_wks(epiddate,illdate)
	,COUNT(seq) as seq,COUNT(DISTINCT pid) as pid
	,SUM(CASE WHEN ptstatus=2 THEN 1 ELSE 0 END) as death
FROM
	t_surveil ,sys_config
WHERE
	SUBSTR(illdate,1,4) = @b_year
GROUP BY 
	groupname506,hospcode,areacode,sex,groupname1560,yymm
ORDER BY 
groupname506,hospcode
);
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.534842;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:77;a:5:{i:0;s:1648:"CREATE PROCEDURE t_pt_surveil()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '8';
SET @b_year:=IF(MONTH(NOW())=1 AND DAY(NOW())<=5,year(NOW())-1,year(NOW()));
SET @start_d:=concat(@b_year,'0101');
SET @end_d:=concat(@b_year,'1231');

#DROP TABLE IF EXISTS t_pt_surveil;
CREATE TABLE IF NOT EXISTS t_pt_surveil (
  `id` varchar(32) not null,
  `code506` varchar(2) not null,
	`groupname506` varchar(255) default null,  
  `hospcode` varchar(5) not null,
	`pt_areacode` varchar(8) not null,
	`sex` varchar(1) not null,
	`age_y` int(3) not null,
  `groupname1560` varchar(50) default null,
  `yymm` varchar(50) default null,
  `wks` int(2) default 0,
	`seq` int(9) default 0,
  `pid` int(9) default 0,
  `death` int(9) default 0,
	key (groupname506,hospcode,pt_areacode,sex,groupname1560,wks)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

DELETE FROM t_pt_surveil WHERE (SUBSTR(yymm,1,4)-543)=year(now());

INSERT IGNORE INTO t_pt_surveil
(
`id`,`code506`,`groupname506`,`hospcode`,`pt_areacode`,`sex`,`age_y`,`groupname1560`,`yymm`,`wks`,`seq`,`pid`,`death`)
(
SELECT  SQL_BIG_RESULT 
	@id,if(code506last is not null,code506last,if(code506last is null,code506,NULL)) as code506
	,groupname506,hospcode,ill_areacode,sex,age_y
	,groupname1560,CONCAT((DATE_FORMAT(illdate,'%Y')+543),DATE_FORMAT(illdate,'%m')) as yymm
	,epid_wks(epiddate,illdate)
	,COUNT(seq) as seq,COUNT(DISTINCT pid) as pid
	,SUM(CASE WHEN ptstatus=2 THEN 1 ELSE 0 END) as death
FROM
	t_surveil ,sys_config
WHERE
	SUBSTR(illdate,1,4) = @b_year
GROUP BY 
	groupname506,hospcode,areacode,sex,groupname1560,yymm
ORDER BY 
groupname506,hospcode
);
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.5972421;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:79;a:5:{i:0;s:41:"DROP PROCEDURE IF EXISTS t_person_sex_age";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.5972421;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:80;a:5:{i:0;s:41:"DROP PROCEDURE IF EXISTS t_person_sex_age";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.659642;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:82;a:5:{i:0;s:7125:"CREATE PROCEDURE t_person_sex_age()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '9';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);

DROP TABLE IF EXISTS tmp_person_agegroup;

CREATE TABLE tmp_person_agegroup (
KEY (hospcode),
KEY (vhid)
) ENGINE=MyISAM  AS(
	SELECT SQL_BIG_RESULT 
			check_hosp as hospcode,check_vhid as vhid,sex,age_y as age
		,ca.groupcode190,ca.groupname190,ca.groupcode1560,ca.groupname1560,ca.groupcode060,ca.groupname060
		,ca.groupcode3560,ca.groupname3560
	FROM 
		t_person_cid p,cage ca
	WHERE
		ca.age=age_y AND p.check_typearea in(1,3)
		AND p.DISCHARGE=9 AND nation=99 
);


DROP TABLE IF EXISTS tmp_labor_agegroup;

CREATE TABLE tmp_labor_agegroup (
KEY (hospcode),
KEY (vhid)
) ENGINE=MyISAM  AS(
	SELECT SQL_BIG_RESULT 
			check_hosp as hospcode,check_vhid as vhid,sex,age_y as age
		,ca.groupcode190,ca.groupname190,ca.groupcode1560,ca.groupname1560,ca.groupcode060,ca.groupname060
		,ca.groupcode3560,ca.groupname3560
	FROM 
		t_person_cid p,cage ca
	WHERE
		ca.age=age_y AND p.check_typearea in(1,3)
		AND p.DISCHARGE=9 AND (p.labor >= 1 OR p.nation !='099')
);



DROP TABLE IF EXISTS t_person_sex_age190 ;

CREATE TABLE IF NOT EXISTS t_person_sex_age190  (
  `id` varchar(32) not null default '',
	`year` varchar(4) not null default '',
	`hospcode` varchar(5) not null default '',
  `areacode` varchar(8) not null default '',
  `sex` varchar(15) not null default '',
  `groupcode` int(2) not null default 0,
  `groupname` varchar(255) not null default '',
  `result` int(9) not null default 0,
  KEY `hospcode` (`hospcode`),
  KEY `areacode` (`areacode`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

#DELETE FROM t_person_sex_age190 WHERE year= year(now())+543;

INSERT INTO t_person_sex_age190
(
`id`,`year`,`hospcode`,`areacode`,`sex`,`groupcode`,`groupname`,`result`
)
(
	SELECT SQL_BIG_RESULT 
	@id as id,(@b_year+543) as year,ag.hospcode,ag.vhid,ag.sex,ag.groupcode,ag.groupname,ag.result
	FROM
			(SELECT
			hospcode,vhid,if(sex=1,'ชาย',if(sex=2,'หญิง','ระบุไม่ได้' )) as sex ,groupcode190 as groupcode,groupname190 as groupname,COUNT(*) as result
			FROM
			tmp_person_agegroup
			GROUP BY
			hospcode,vhid,sex,groupcode190 
			ORDER BY hospcode,vhid
			) as ag
);

DROP TABLE IF EXISTS t_labor_sex_age190 ;

CREATE TABLE IF NOT EXISTS t_labor_sex_age190 (
  `id` varchar(32) not null default '',
	`year` varchar(4) not null default '',
	`hospcode` varchar(5) not null default '',
  `areacode` varchar(8) not null default '',
  `sex` varchar(15) not null default '',
  `groupcode` int(2) not null default 0,
  `groupname` varchar(255) not null default '',
  `result` int(9) not null default 0,
  KEY `hospcode` (`hospcode`),
  KEY `areacode` (`areacode`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

#DELETE FROM t_labor_sex_age190 WHERE year= year(now())+543;

INSERT INTO t_labor_sex_age190
(
`id`,`year`,`hospcode`,`areacode`,`sex`,`groupcode`,`groupname`,`result`
)
(
	SELECT SQL_BIG_RESULT 
	@id as id,(@b_year+543) as year,ag.hospcode,ag.vhid,ag.sex,ag.groupcode,ag.groupname,ag.result
	FROM
			(SELECT
			hospcode,vhid,if(sex=1,'ชาย',if(sex=2,'หญิง','ระบุไม่ได้' )) as sex ,groupcode190 as groupcode,groupname190 as groupname,COUNT(*) as result
			FROM
			tmp_labor_agegroup
			GROUP BY
			hospcode,vhid,sex,groupcode190 
			ORDER BY hospcode,vhid
			) as ag
);


DROP TABLE IF EXISTS t_person_sex_age1560 ;

CREATE TABLE IF NOT EXISTS t_person_sex_age1560 (
  `id` varchar(32) not null default '',
	`year` varchar(4) not null default '',
	`hospcode` varchar(5) not null default '',
  `areacode` varchar(8) not null default '',
  `sex` varchar(15) not null default '',
  `groupcode` int(2) not null default 0,
  `groupname` varchar(255) not null default '',
  `result` int(9) not null default 0,
  KEY `hospcode` (`hospcode`),
  KEY `areacode` (`areacode`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

#DELETE FROM t_person_sex_age1560 WHERE year= year(now())+543;


INSERT INTO t_person_sex_age1560
(
`id`,`year`,`hospcode`,`areacode`,`sex`,`groupcode`,`groupname`,`result`
)
(
	SELECT SQL_BIG_RESULT 
	@id as id,(@b_year+543) as year,ag.hospcode,ag.vhid,ag.sex,ag.groupcode,ag.groupname,ag.result
	FROM
			(SELECT
			hospcode,vhid,if(sex=1,'ชาย',if(sex=2,'หญิง','ระบุไม่ได้' )) as sex ,groupcode1560 as groupcode ,groupname1560 as groupname,COUNT(*) as result
			FROM
			tmp_person_agegroup
			GROUP BY
			hospcode,vhid,sex,groupcode1560
			ORDER BY hospcode,vhid
			) as ag
);


DROP TABLE IF EXISTS t_person_sex_age060 ;

CREATE TABLE IF NOT EXISTS t_person_sex_age060 (
  `id` varchar(32) not null default '',
	`year` varchar(4) not null default '',
	`hospcode` varchar(5) not null default '',
  `areacode` varchar(8) not null default '',
  `sex` varchar(15) not null default '',
  `groupcode` int(2) not null default 0,
  `groupname` varchar(255) not null default '',
  `result` int(9) not null default 0,
  KEY `hospcode` (`hospcode`),
  KEY `areacode` (`areacode`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

#DELETE FROM t_person_sex_age060 WHERE year= year(now())+543;


INSERT INTO t_person_sex_age060
(
`id`,`year`,`hospcode`,`areacode`,`sex`,`groupcode`,`groupname`,`result`
)
(
	SELECT SQL_BIG_RESULT 
	@id as id,(@b_year+543) as year,ag.hospcode,ag.vhid,ag.sex,ag.groupcode,ag.groupname,ag.result
	FROM
			(SELECT
			hospcode,vhid,if(sex=1,'ชาย',if(sex=2,'หญิง','ระบุไม่ได้' )) as sex ,groupcode060 as groupcode ,groupname060 as groupname,COUNT(*) as result
			FROM
			tmp_person_agegroup
			GROUP BY
			hospcode,vhid,sex,groupcode060
			ORDER BY hospcode,vhid
			) as ag
);


DROP TABLE IF EXISTS t_person_sex_age3560 ;

CREATE TABLE IF NOT EXISTS t_person_sex_age3560 (
  `id` varchar(32) not null default '',
	`year` varchar(4) not null default '',
	`hospcode` varchar(5) not null default '',
  `areacode` varchar(8) not null default '',
  `sex` varchar(15) not null default '',
  `groupcode` int(2) not null default 0,
  `groupname` varchar(255) not null default '',
  `result` int(9) not null default 0,
  KEY `hospcode` (`hospcode`),
  KEY `areacode` (`areacode`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

#DELETE FROM t_person_sex_age3560 WHERE year= year(now())+543;


INSERT INTO t_person_sex_age3560
(
`id`,`year`,`hospcode`,`areacode`,`sex`,`groupcode`,`groupname`,`result`
)
(
	SELECT SQL_BIG_RESULT 
	@id as id,(@b_year+543) as year,ag.hospcode,ag.vhid,ag.sex,ag.groupcode,ag.groupname,ag.result
	FROM
			(SELECT
			hospcode,vhid,if(sex=1,'ชาย',if(sex=2,'หญิง','ระบุไม่ได้' )) as sex ,groupcode3560 as groupcode ,groupname3560 as groupname,COUNT(*) as result
			FROM
			tmp_person_agegroup
			GROUP BY
			hospcode,vhid,sex,groupcode3560
			ORDER BY hospcode,vhid
			) as ag
);

DROP TABLE IF EXISTS tmp_person_agegroup;
DROP TABLE IF EXISTS tmp_labor_agegroup;

 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.659642;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:83;a:5:{i:0;s:7125:"CREATE PROCEDURE t_person_sex_age()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '9';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);

DROP TABLE IF EXISTS tmp_person_agegroup;

CREATE TABLE tmp_person_agegroup (
KEY (hospcode),
KEY (vhid)
) ENGINE=MyISAM  AS(
	SELECT SQL_BIG_RESULT 
			check_hosp as hospcode,check_vhid as vhid,sex,age_y as age
		,ca.groupcode190,ca.groupname190,ca.groupcode1560,ca.groupname1560,ca.groupcode060,ca.groupname060
		,ca.groupcode3560,ca.groupname3560
	FROM 
		t_person_cid p,cage ca
	WHERE
		ca.age=age_y AND p.check_typearea in(1,3)
		AND p.DISCHARGE=9 AND nation=99 
);


DROP TABLE IF EXISTS tmp_labor_agegroup;

CREATE TABLE tmp_labor_agegroup (
KEY (hospcode),
KEY (vhid)
) ENGINE=MyISAM  AS(
	SELECT SQL_BIG_RESULT 
			check_hosp as hospcode,check_vhid as vhid,sex,age_y as age
		,ca.groupcode190,ca.groupname190,ca.groupcode1560,ca.groupname1560,ca.groupcode060,ca.groupname060
		,ca.groupcode3560,ca.groupname3560
	FROM 
		t_person_cid p,cage ca
	WHERE
		ca.age=age_y AND p.check_typearea in(1,3)
		AND p.DISCHARGE=9 AND (p.labor >= 1 OR p.nation !='099')
);



DROP TABLE IF EXISTS t_person_sex_age190 ;

CREATE TABLE IF NOT EXISTS t_person_sex_age190  (
  `id` varchar(32) not null default '',
	`year` varchar(4) not null default '',
	`hospcode` varchar(5) not null default '',
  `areacode` varchar(8) not null default '',
  `sex` varchar(15) not null default '',
  `groupcode` int(2) not null default 0,
  `groupname` varchar(255) not null default '',
  `result` int(9) not null default 0,
  KEY `hospcode` (`hospcode`),
  KEY `areacode` (`areacode`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

#DELETE FROM t_person_sex_age190 WHERE year= year(now())+543;

INSERT INTO t_person_sex_age190
(
`id`,`year`,`hospcode`,`areacode`,`sex`,`groupcode`,`groupname`,`result`
)
(
	SELECT SQL_BIG_RESULT 
	@id as id,(@b_year+543) as year,ag.hospcode,ag.vhid,ag.sex,ag.groupcode,ag.groupname,ag.result
	FROM
			(SELECT
			hospcode,vhid,if(sex=1,'ชาย',if(sex=2,'หญิง','ระบุไม่ได้' )) as sex ,groupcode190 as groupcode,groupname190 as groupname,COUNT(*) as result
			FROM
			tmp_person_agegroup
			GROUP BY
			hospcode,vhid,sex,groupcode190 
			ORDER BY hospcode,vhid
			) as ag
);

DROP TABLE IF EXISTS t_labor_sex_age190 ;

CREATE TABLE IF NOT EXISTS t_labor_sex_age190 (
  `id` varchar(32) not null default '',
	`year` varchar(4) not null default '',
	`hospcode` varchar(5) not null default '',
  `areacode` varchar(8) not null default '',
  `sex` varchar(15) not null default '',
  `groupcode` int(2) not null default 0,
  `groupname` varchar(255) not null default '',
  `result` int(9) not null default 0,
  KEY `hospcode` (`hospcode`),
  KEY `areacode` (`areacode`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

#DELETE FROM t_labor_sex_age190 WHERE year= year(now())+543;

INSERT INTO t_labor_sex_age190
(
`id`,`year`,`hospcode`,`areacode`,`sex`,`groupcode`,`groupname`,`result`
)
(
	SELECT SQL_BIG_RESULT 
	@id as id,(@b_year+543) as year,ag.hospcode,ag.vhid,ag.sex,ag.groupcode,ag.groupname,ag.result
	FROM
			(SELECT
			hospcode,vhid,if(sex=1,'ชาย',if(sex=2,'หญิง','ระบุไม่ได้' )) as sex ,groupcode190 as groupcode,groupname190 as groupname,COUNT(*) as result
			FROM
			tmp_labor_agegroup
			GROUP BY
			hospcode,vhid,sex,groupcode190 
			ORDER BY hospcode,vhid
			) as ag
);


DROP TABLE IF EXISTS t_person_sex_age1560 ;

CREATE TABLE IF NOT EXISTS t_person_sex_age1560 (
  `id` varchar(32) not null default '',
	`year` varchar(4) not null default '',
	`hospcode` varchar(5) not null default '',
  `areacode` varchar(8) not null default '',
  `sex` varchar(15) not null default '',
  `groupcode` int(2) not null default 0,
  `groupname` varchar(255) not null default '',
  `result` int(9) not null default 0,
  KEY `hospcode` (`hospcode`),
  KEY `areacode` (`areacode`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

#DELETE FROM t_person_sex_age1560 WHERE year= year(now())+543;


INSERT INTO t_person_sex_age1560
(
`id`,`year`,`hospcode`,`areacode`,`sex`,`groupcode`,`groupname`,`result`
)
(
	SELECT SQL_BIG_RESULT 
	@id as id,(@b_year+543) as year,ag.hospcode,ag.vhid,ag.sex,ag.groupcode,ag.groupname,ag.result
	FROM
			(SELECT
			hospcode,vhid,if(sex=1,'ชาย',if(sex=2,'หญิง','ระบุไม่ได้' )) as sex ,groupcode1560 as groupcode ,groupname1560 as groupname,COUNT(*) as result
			FROM
			tmp_person_agegroup
			GROUP BY
			hospcode,vhid,sex,groupcode1560
			ORDER BY hospcode,vhid
			) as ag
);


DROP TABLE IF EXISTS t_person_sex_age060 ;

CREATE TABLE IF NOT EXISTS t_person_sex_age060 (
  `id` varchar(32) not null default '',
	`year` varchar(4) not null default '',
	`hospcode` varchar(5) not null default '',
  `areacode` varchar(8) not null default '',
  `sex` varchar(15) not null default '',
  `groupcode` int(2) not null default 0,
  `groupname` varchar(255) not null default '',
  `result` int(9) not null default 0,
  KEY `hospcode` (`hospcode`),
  KEY `areacode` (`areacode`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

#DELETE FROM t_person_sex_age060 WHERE year= year(now())+543;


INSERT INTO t_person_sex_age060
(
`id`,`year`,`hospcode`,`areacode`,`sex`,`groupcode`,`groupname`,`result`
)
(
	SELECT SQL_BIG_RESULT 
	@id as id,(@b_year+543) as year,ag.hospcode,ag.vhid,ag.sex,ag.groupcode,ag.groupname,ag.result
	FROM
			(SELECT
			hospcode,vhid,if(sex=1,'ชาย',if(sex=2,'หญิง','ระบุไม่ได้' )) as sex ,groupcode060 as groupcode ,groupname060 as groupname,COUNT(*) as result
			FROM
			tmp_person_agegroup
			GROUP BY
			hospcode,vhid,sex,groupcode060
			ORDER BY hospcode,vhid
			) as ag
);


DROP TABLE IF EXISTS t_person_sex_age3560 ;

CREATE TABLE IF NOT EXISTS t_person_sex_age3560 (
  `id` varchar(32) not null default '',
	`year` varchar(4) not null default '',
	`hospcode` varchar(5) not null default '',
  `areacode` varchar(8) not null default '',
  `sex` varchar(15) not null default '',
  `groupcode` int(2) not null default 0,
  `groupname` varchar(255) not null default '',
  `result` int(9) not null default 0,
  KEY `hospcode` (`hospcode`),
  KEY `areacode` (`areacode`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

#DELETE FROM t_person_sex_age3560 WHERE year= year(now())+543;


INSERT INTO t_person_sex_age3560
(
`id`,`year`,`hospcode`,`areacode`,`sex`,`groupcode`,`groupname`,`result`
)
(
	SELECT SQL_BIG_RESULT 
	@id as id,(@b_year+543) as year,ag.hospcode,ag.vhid,ag.sex,ag.groupcode,ag.groupname,ag.result
	FROM
			(SELECT
			hospcode,vhid,if(sex=1,'ชาย',if(sex=2,'หญิง','ระบุไม่ได้' )) as sex ,groupcode3560 as groupcode ,groupname3560 as groupname,COUNT(*) as result
			FROM
			tmp_person_agegroup
			GROUP BY
			hospcode,vhid,sex,groupcode3560
			ORDER BY hospcode,vhid
			) as ag
);

DROP TABLE IF EXISTS tmp_person_agegroup;
DROP TABLE IF EXISTS tmp_labor_agegroup;

 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.7064431;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:85;a:5:{i:0;s:34:"DROP PROCEDURE IF EXISTS t_diagopd";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.7064431;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:86;a:5:{i:0;s:34:"DROP PROCEDURE IF EXISTS t_diagopd";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.7688429;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:88;a:5:{i:0;s:2357:"CREATE PROCEDURE t_diagopd()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '10';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'0701');
SET @end_d:=concat(@b_year,'0930');

DROP TABLES IF EXISTS tmp_diag_opd;
CREATE TABLE IF NOT EXISTS tmp_diag_opd (
KEY(cid),KEY(hospcode),KEY(pid),KEY(seq),KEY(date_serv),KEY(diagcode),KEY(diagtype),KEY(hospcode,pid,seq)
) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		o.*,p.CID
FROM
	diagnosis_opd o 
	LEFT JOIN t_person_db p ON o.HOSPCODE=p.HOSPCODE AND o.PID=p.PID
WHERE	DATE_SERV BETWEEN @start_d AND @end_d
);


DROP TABLES IF EXISTS tmp_procedure_opd;
CREATE TABLE IF NOT EXISTS tmp_procedure_opd(
KEY(cid),KEY(hospcode),KEY(pid),KEY(seq),KEY(date_serv),KEY(procedcode),KEY(hospcode,pid,seq),KEY(hospcode,pid,procedcode)
) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		o.HOSPCODE,o.PID,o.SEQ,o.DATE_SERV,o.CLINIC,o.PROCEDCODE,o.serviceprice,o.PROVIDER,o.D_UPDATE,p.CID
FROM
	procedure_opd o 
	LEFT JOIN t_person_db p ON o.HOSPCODE=p.HOSPCODE AND o.PID=p.PID
WHERE	DATE_SERV BETWEEN @start_d AND @end_d
);

DROP TABLES IF EXISTS tmp_diag_opd1;
CREATE TABLE IF NOT EXISTS tmp_diag_opd1 ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
	o.HOSPCODE,p.CID,p.SEX,p.BIRTH,age(o.DATE_SERV,p.BIRTH,'y') as age_y
	,p.NATION,SUBSTR(DATE_FORMAT(DATE_SERV,'%Y%m'),1,6) as yymm,o.diagcode,d.code298
FROM
	tmp_diag_opd o 
	LEFT JOIN cdisease d ON o.diagcode=d.diagcode
	LEFT JOIN t_person_db p ON o.hospcode=p.hospcode AND o.pid=p.pid
WHERE o.diagtype in('1')
);

DROP TABLES IF EXISTS t_diag_opd;
CREATE TABLE IF NOT EXISTS t_diag_opd ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
	o.HOSPCODE,concat(h.provcode,h.distcode,h.subdistcode,SUBSTR(CONCAT('00',h.mu),-2)) as areacode,o.CID,o.SEX,age_y,o.NATION,o.yymm,o.diagcode
	,o.code298,groupcode190,groupcode1560,groupcode060,groupcode3560
FROM
	tmp_diag_opd1 o 
	LEFT JOIN cage c ON o.age_y=c.age
	LEFT JOIN chospital h ON o.hospcode=h.hoscode
WHERE h.provcode =@prov_c
);

DROP TABLES IF EXISTS t_diag_opd_sex;
CREATE TABLE IF NOT EXISTS t_diag_opd_sex ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
	hospcode,areacode, sex,code298,COUNT(*) as result
FROM 
	t_diag_opd 
GROUP BY 
hospcode,areacode,sex,code298
);

DROP TABLES IF EXISTS tmp_diag_opd1;
#DROP TABLES IF EXISTS tmp_diag_opd;
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.7688429;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:89;a:5:{i:0;s:2357:"CREATE PROCEDURE t_diagopd()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '10';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'0701');
SET @end_d:=concat(@b_year,'0930');

DROP TABLES IF EXISTS tmp_diag_opd;
CREATE TABLE IF NOT EXISTS tmp_diag_opd (
KEY(cid),KEY(hospcode),KEY(pid),KEY(seq),KEY(date_serv),KEY(diagcode),KEY(diagtype),KEY(hospcode,pid,seq)
) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		o.*,p.CID
FROM
	diagnosis_opd o 
	LEFT JOIN t_person_db p ON o.HOSPCODE=p.HOSPCODE AND o.PID=p.PID
WHERE	DATE_SERV BETWEEN @start_d AND @end_d
);


DROP TABLES IF EXISTS tmp_procedure_opd;
CREATE TABLE IF NOT EXISTS tmp_procedure_opd(
KEY(cid),KEY(hospcode),KEY(pid),KEY(seq),KEY(date_serv),KEY(procedcode),KEY(hospcode,pid,seq),KEY(hospcode,pid,procedcode)
) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		o.HOSPCODE,o.PID,o.SEQ,o.DATE_SERV,o.CLINIC,o.PROCEDCODE,o.serviceprice,o.PROVIDER,o.D_UPDATE,p.CID
FROM
	procedure_opd o 
	LEFT JOIN t_person_db p ON o.HOSPCODE=p.HOSPCODE AND o.PID=p.PID
WHERE	DATE_SERV BETWEEN @start_d AND @end_d
);

DROP TABLES IF EXISTS tmp_diag_opd1;
CREATE TABLE IF NOT EXISTS tmp_diag_opd1 ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
	o.HOSPCODE,p.CID,p.SEX,p.BIRTH,age(o.DATE_SERV,p.BIRTH,'y') as age_y
	,p.NATION,SUBSTR(DATE_FORMAT(DATE_SERV,'%Y%m'),1,6) as yymm,o.diagcode,d.code298
FROM
	tmp_diag_opd o 
	LEFT JOIN cdisease d ON o.diagcode=d.diagcode
	LEFT JOIN t_person_db p ON o.hospcode=p.hospcode AND o.pid=p.pid
WHERE o.diagtype in('1')
);

DROP TABLES IF EXISTS t_diag_opd;
CREATE TABLE IF NOT EXISTS t_diag_opd ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
	o.HOSPCODE,concat(h.provcode,h.distcode,h.subdistcode,SUBSTR(CONCAT('00',h.mu),-2)) as areacode,o.CID,o.SEX,age_y,o.NATION,o.yymm,o.diagcode
	,o.code298,groupcode190,groupcode1560,groupcode060,groupcode3560
FROM
	tmp_diag_opd1 o 
	LEFT JOIN cage c ON o.age_y=c.age
	LEFT JOIN chospital h ON o.hospcode=h.hoscode
WHERE h.provcode =@prov_c
);

DROP TABLES IF EXISTS t_diag_opd_sex;
CREATE TABLE IF NOT EXISTS t_diag_opd_sex ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
	hospcode,areacode, sex,code298,COUNT(*) as result
FROM 
	t_diag_opd 
GROUP BY 
hospcode,areacode,sex,code298
);

DROP TABLES IF EXISTS tmp_diag_opd1;
#DROP TABLES IF EXISTS tmp_diag_opd;
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.831243;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:91;a:5:{i:0;s:34:"DROP PROCEDURE IF EXISTS t_diagipd";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.831243;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:92;a:5:{i:0;s:34:"DROP PROCEDURE IF EXISTS t_diagipd";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.8780429;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:94;a:5:{i:0;s:2498:"CREATE PROCEDURE t_diagipd()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '11';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLES IF EXISTS tmp_diag_ipd;
CREATE TABLE IF NOT EXISTS tmp_diag_ipd (
KEY(cid), KEY(hospcode), KEY(datetime_admit), KEY(datetime_disch), KEY(diagcode), KEY(diagtype),KEY(an),KEY(hospcode,an)
)ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		i.*,p.CID,a.datetime_disch
FROM
	diagnosis_ipd i 
	LEFT JOIN t_person_db p ON  i.HOSPCODE=p.HOSPCODE AND i.PID=p.PID
	LEFT JOIN admission a ON i.HOSPCODE=a.HOSPCODE AND i.pid=a.pid AND i.an=a.an
WHERE	(DATE_FORMAT(i.DATETIME_ADMIT,'%Y%m%d') BETWEEN @start_d AND @end_d OR DATE_FORMAT(a.DATETIME_DISCH,'%Y%m%d') BETWEEN @start_d AND @end_d)
);



DROP TABLES IF EXISTS tmp_procedure_ipd;
CREATE TABLE IF NOT EXISTS tmp_procedure_ipd (
KEY(cid), KEY(hospcode), KEY(datetime_admit), KEY(procedcode) ,KEY(an),KEY(hospcode,an),KEY(hospcode,an,procedcode)
) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		i.*,p.CID
FROM
	procedure_ipd i 
	LEFT JOIN t_person_db p ON i.HOSPCODE=p.HOSPCODE AND i.PID=p.PID
WHERE	DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d') BETWEEN @start_d AND @end_d
);

DROP TABLES IF EXISTS tmp_diag_ipd1;
CREATE TABLE IF NOT EXISTS tmp_diag_ipd1 ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
	o.HOSPCODE,p.CID,p.SEX,p.BIRTH,age(o.DATETIME_DISCH,p.BIRTH,'y') as age_y
	,p.NATION,SUBSTR(DATE_FORMAT(DATETIME_DISCH,'%Y%m'),1,6) as yymm,o.diagcode,d.code298
FROM
	tmp_diag_ipd o LEFT JOIN cdisease d ON o.diagcode=d.diagcode 
  LEFT JOIN t_person_db p ON o.hospcode=p.hospcode AND o.pid=p.pid
WHERE o.diagtype in('1')
);

DROP TABLES IF EXISTS t_diag_ipd;
CREATE TABLE IF NOT EXISTS t_diag_ipd ENGINE=MyISAM  AS(
SELECT
	o.HOSPCODE,concat(h.provcode,h.distcode,h.subdistcode,SUBSTR(CONCAT('00',h.mu),-2)) as areacode,o.CID,o.SEX,age_y,o.NATION,o.yymm,o.diagcode
	,o.code298,groupcode190,groupcode1560,groupcode060,groupcode3560
FROM
	tmp_diag_ipd1 o 
	LEFT JOIN cage c ON o.age_y=c.age
  LEFT JOIN chospital h ON o.hospcode=h.hoscode
WHERE h.provcode =@prov_c
);

DROP TABLES IF EXISTS t_diag_ipd_sex;
CREATE TABLE IF NOT EXISTS t_diag_ipd_sex ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
	hospcode,areacode, sex,code298,COUNT(*) as result
FROM 
	t_diag_ipd 
GROUP BY 
hospcode,areacode,sex,code298
);

DROP TABLES IF EXISTS tmp_diag_ipd1;
#DROP TABLES IF EXISTS tmp_diag_ipd;

 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.8780429;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:95;a:5:{i:0;s:2498:"CREATE PROCEDURE t_diagipd()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '11';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLES IF EXISTS tmp_diag_ipd;
CREATE TABLE IF NOT EXISTS tmp_diag_ipd (
KEY(cid), KEY(hospcode), KEY(datetime_admit), KEY(datetime_disch), KEY(diagcode), KEY(diagtype),KEY(an),KEY(hospcode,an)
)ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		i.*,p.CID,a.datetime_disch
FROM
	diagnosis_ipd i 
	LEFT JOIN t_person_db p ON  i.HOSPCODE=p.HOSPCODE AND i.PID=p.PID
	LEFT JOIN admission a ON i.HOSPCODE=a.HOSPCODE AND i.pid=a.pid AND i.an=a.an
WHERE	(DATE_FORMAT(i.DATETIME_ADMIT,'%Y%m%d') BETWEEN @start_d AND @end_d OR DATE_FORMAT(a.DATETIME_DISCH,'%Y%m%d') BETWEEN @start_d AND @end_d)
);



DROP TABLES IF EXISTS tmp_procedure_ipd;
CREATE TABLE IF NOT EXISTS tmp_procedure_ipd (
KEY(cid), KEY(hospcode), KEY(datetime_admit), KEY(procedcode) ,KEY(an),KEY(hospcode,an),KEY(hospcode,an,procedcode)
) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		i.*,p.CID
FROM
	procedure_ipd i 
	LEFT JOIN t_person_db p ON i.HOSPCODE=p.HOSPCODE AND i.PID=p.PID
WHERE	DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d') BETWEEN @start_d AND @end_d
);

DROP TABLES IF EXISTS tmp_diag_ipd1;
CREATE TABLE IF NOT EXISTS tmp_diag_ipd1 ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
	o.HOSPCODE,p.CID,p.SEX,p.BIRTH,age(o.DATETIME_DISCH,p.BIRTH,'y') as age_y
	,p.NATION,SUBSTR(DATE_FORMAT(DATETIME_DISCH,'%Y%m'),1,6) as yymm,o.diagcode,d.code298
FROM
	tmp_diag_ipd o LEFT JOIN cdisease d ON o.diagcode=d.diagcode 
  LEFT JOIN t_person_db p ON o.hospcode=p.hospcode AND o.pid=p.pid
WHERE o.diagtype in('1')
);

DROP TABLES IF EXISTS t_diag_ipd;
CREATE TABLE IF NOT EXISTS t_diag_ipd ENGINE=MyISAM  AS(
SELECT
	o.HOSPCODE,concat(h.provcode,h.distcode,h.subdistcode,SUBSTR(CONCAT('00',h.mu),-2)) as areacode,o.CID,o.SEX,age_y,o.NATION,o.yymm,o.diagcode
	,o.code298,groupcode190,groupcode1560,groupcode060,groupcode3560
FROM
	tmp_diag_ipd1 o 
	LEFT JOIN cage c ON o.age_y=c.age
  LEFT JOIN chospital h ON o.hospcode=h.hoscode
WHERE h.provcode =@prov_c
);

DROP TABLES IF EXISTS t_diag_ipd_sex;
CREATE TABLE IF NOT EXISTS t_diag_ipd_sex ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
	hospcode,areacode, sex,code298,COUNT(*) as result
FROM 
	t_diag_ipd 
GROUP BY 
hospcode,areacode,sex,code298
);

DROP TABLES IF EXISTS tmp_diag_ipd1;
#DROP TABLES IF EXISTS tmp_diag_ipd;

 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.9248431;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:97;a:5:{i:0;s:34:"DROP PROCEDURE IF EXISTS t_chronic";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988050.9248431;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:98;a:5:{i:0;s:34:"DROP PROCEDURE IF EXISTS t_chronic";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.0028429;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:100;a:5:{i:0;s:5259:"CREATE PROCEDURE t_chronic()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '12';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'0701');
SET @end_d:=concat(@b_year,'0930');


DROP TABLES IF EXISTS tmp_chronic;

CREATE TABLE IF NOT EXISTS tmp_chronic (
KEY(cid),
KEY(chronic)
) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		c.*,p.CID
FROM
		chronic c
		INNER JOIN t_person_db  p on p.HOSPCODE=c.HOSPCODE AND p.PID=c.PID
WHERE 
	c.CHRONIC in(SELECT id_chronic FROM cchronic )
  AND c.typedisch between 1 and 9
ORDER BY c.DATE_DIAG
);

DROP TABLES IF EXISTS tmp_chronic_opd;
CREATE TABLE IF NOT EXISTS tmp_chronic_opd (
KEY(cid),
KEY(diagcode)
) ENGINE=MyISAM  AS(
SELECT
		c.*
FROM
	tmp_diag_opd c
WHERE c.DATE_SERV BETWEEN @start_d AND @end_d
	AND c.DIAGCODE in(SELECT id_chronic FROM cchronic )
GROUP BY c.HOSPCODE,c.PID,c.DIAGCODE
ORDER BY c.DATE_SERV
);

DROP TABLES IF EXISTS tmp_chronic_ipd;
CREATE TABLE IF NOT EXISTS tmp_chronic_ipd (
KEY(cid),
KEY(diagcode)
) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		c.*
FROM
	tmp_diag_ipd c
WHERE DATE_FORMAT(c.DATETIME_ADMIT,'%Y%m%d') BETWEEN @start_d AND @end_d
		AND c.DIAGCODE in(SELECT id_chronic FROM cchronic )
GROUP BY c.HOSPCODE,c.PID,c.DIAGCODE
ORDER BY DATETIME_ADMIT
);


DROP TABLES IF EXISTS t_chronic;
CREATE TABLE IF NOT EXISTS t_chronic(
		cid VARCHAR(13) NOT NULL
		,birth date
		,age_y INT(3) DEFAULT 0
		,age_y_dx INT(3) DEFAULT 0
		,groupcode INT(3) DEFAULT 0
		,sex VARCHAR(1) DEFAULT NULL 
		,nation VARCHAR(3) DEFAULT NULL 
		,p_hospcode VARCHAR(5) DEFAULT NULL 
		,d_hospcode VARCHAR(5) DEFAULT NULL 
		,p_pt_vhid VARCHAR(8) DEFAULT NULL 
		,d_pt_vhid VARCHAR(8) DEFAULT NULL 
		,p_typearea VARCHAR(1) DEFAULT NULL 
		,d_typearea VARCHAR(1) DEFAULT NULL 
		,input_hosp VARCHAR(5) DEFAULT NULL 
		,input_pid VARCHAR(15) DEFAULT NULL 
		,source_tb VARCHAR(20) DEFAULT NULL 
		,diagcode VARCHAR(10) NOT NULL
		,date_dx date DEFAULT NULL 
		,hosp_dx VARCHAR(5) DEFAULT NULL 
		,hosp_rx VARCHAR(5) DEFAULT NULL 
		,typedisch VARCHAR(2) DEFAULT NULL 
		,datedisch date DEFAULT NULL 
		,minscl VARCHAR(5) DEFAULT NULL 
		,inscl VARCHAR(3) DEFAULT NULL 
	,PRIMARY KEY (cid,diagcode)
	,KEY (cid)
	,KEY (diagcode)

) ENGINE=MyISAM DEFAULT CHARSET=utf8;

/*import from chronic*/
INSERT IGNORE INTO t_chronic
(
	cid,birth,age_y,age_y_dx,sex,nation,p_hospcode,d_hospcode,p_pt_vhid,d_pt_vhid
	,p_typearea,d_typearea,input_hosp,input_pid,source_tb,diagcode,date_dx
	,hosp_dx,hosp_rx,typedisch,datedisch,minscl,inscl
)
(
SELECT SQL_BIG_RESULT 
	p.CID,p.BIRTH,age(NOW(),p.BIRTH,'y'),age(t.date_diag,p.BIRTH,'y'),p.SEX,p.NATION
	,p.HOSPCODE,p.check_hosp,p.vhid,p.check_vhid,p.TYPEAREA,p.check_typearea
	,t.hosp_input,t.pid_input,t.pt_from,t.diagcode,t.date_diag,t.hosp_dx,t.hosp_rx,t.typedisch,t.datedisch
	,p.maininscl,p.inscl

FROM
	(     SELECT
			c.cid,c.HOSPCODE as hosp_input,c.pid as pid_input,date_diag,c.CHRONIC as diagcode
			,IFNULL(c.HOSP_DX,'00000') as HOSP_DX,c.HOSP_RX,c.TYPEDISCH,c.DATE_DISCH as datedisch,'chronic' as pt_from
		FROM
			tmp_chronic c
		GROUP BY c.CID,c.CHRONIC
	) as t INNER JOIN t_person_cid p ON p.cid=t.cid
);

/*import from diagopd*/
INSERT IGNORE INTO t_chronic
(
	cid,birth,age_y,age_y_dx,sex,nation,p_hospcode,d_hospcode,p_pt_vhid,d_pt_vhid
	,p_typearea,d_typearea,input_hosp,input_pid,source_tb,diagcode,date_dx
	,hosp_dx,hosp_rx,minscl,inscl
)
(
SELECT SQL_BIG_RESULT 
	p.CID,p.BIRTH,age(NOW(),p.BIRTH,'y'),age(t.date_diag,p.BIRTH,'y'),p.SEX,p.NATION
	,p.HOSPCODE,p.check_hosp,p.vhid,p.check_vhid,p.TYPEAREA,p.check_typearea
	,t.hosp_input,t.pid_input,t.pt_from,t.diagcode,t.date_diag,t.hosp_dx,t.hosp_rx
	,p.maininscl,p.inscl

FROM
	(
		SELECT
			o.cid,o.HOSPCODE hosp_input,o.pid pid_input,o.date_serv date_diag,o.diagcode
			,o.HOSPCODE hosp_dx,o.HOSPCODE hosp_rx,'diag_opd' as pt_from
		FROM
			tmp_chronic_opd o
		GROUP BY o.cid,o.diagcode
	) as t INNER JOIN t_person_cid p ON p.cid=t.cid
);

/*import from diagipd*/
INSERT IGNORE INTO t_chronic
(
	cid,birth,age_y,age_y_dx,sex,nation,p_hospcode,d_hospcode,p_pt_vhid,d_pt_vhid
	,p_typearea,d_typearea,input_hosp,input_pid,source_tb,diagcode,date_dx
	,hosp_dx,hosp_rx,minscl,inscl
)
(
SELECT SQL_BIG_RESULT 
	p.CID,p.BIRTH,age(NOW(),p.BIRTH,'y'),age(t.date_diag,p.BIRTH,'y'),p.SEX,p.NATION
	,p.HOSPCODE,p.check_hosp,p.vhid,p.check_vhid,p.TYPEAREA,p.check_typearea
	,t.hosp_input,t.pid_input,t.pt_from,t.diagcode,t.date_diag,t.hosp_dx,t.hosp_rx
	,p.maininscl,p.inscl

FROM
	(
		SELECT
			i.cid,i.HOSPCODE hosp_input,i.pid pid_input,DATE_FORMAT(i.DATETIME_ADMIT,'%Y-%m-%d') date_diag,i.diagcode
			,i.HOSPCODE hosp_dx,i.HOSPCODE hosp_rx,'diag_ipd' as pt_from
		FROM
			tmp_chronic_ipd i
		GROUP BY i.cid,i.diagcode
	) as t INNER JOIN t_person_cid p ON p.cid=t.cid
);





UPDATE t_chronic t ,cage  ag SET t.groupcode=ag.groupcode1560
WHERE t.age_y=ag.age ;

/*
UPDATE t_chronic c,tmp_chronic tc
		SET c.typedisch=tc.typedisch,c.date_dx=tc.DATE_DIAG
WHERE c.cid = tc.cid AND c.diagcode=tc.chronic;
*/

UPDATE t_chronic c,t_person_cid p SET c.typedisch='02'  
WHERE c.cid=p.cid AND p.DISCHARGE=1;

 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.0028429;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:101;a:5:{i:0;s:5259:"CREATE PROCEDURE t_chronic()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '12';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'0701');
SET @end_d:=concat(@b_year,'0930');


DROP TABLES IF EXISTS tmp_chronic;

CREATE TABLE IF NOT EXISTS tmp_chronic (
KEY(cid),
KEY(chronic)
) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		c.*,p.CID
FROM
		chronic c
		INNER JOIN t_person_db  p on p.HOSPCODE=c.HOSPCODE AND p.PID=c.PID
WHERE 
	c.CHRONIC in(SELECT id_chronic FROM cchronic )
  AND c.typedisch between 1 and 9
ORDER BY c.DATE_DIAG
);

DROP TABLES IF EXISTS tmp_chronic_opd;
CREATE TABLE IF NOT EXISTS tmp_chronic_opd (
KEY(cid),
KEY(diagcode)
) ENGINE=MyISAM  AS(
SELECT
		c.*
FROM
	tmp_diag_opd c
WHERE c.DATE_SERV BETWEEN @start_d AND @end_d
	AND c.DIAGCODE in(SELECT id_chronic FROM cchronic )
GROUP BY c.HOSPCODE,c.PID,c.DIAGCODE
ORDER BY c.DATE_SERV
);

DROP TABLES IF EXISTS tmp_chronic_ipd;
CREATE TABLE IF NOT EXISTS tmp_chronic_ipd (
KEY(cid),
KEY(diagcode)
) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		c.*
FROM
	tmp_diag_ipd c
WHERE DATE_FORMAT(c.DATETIME_ADMIT,'%Y%m%d') BETWEEN @start_d AND @end_d
		AND c.DIAGCODE in(SELECT id_chronic FROM cchronic )
GROUP BY c.HOSPCODE,c.PID,c.DIAGCODE
ORDER BY DATETIME_ADMIT
);


DROP TABLES IF EXISTS t_chronic;
CREATE TABLE IF NOT EXISTS t_chronic(
		cid VARCHAR(13) NOT NULL
		,birth date
		,age_y INT(3) DEFAULT 0
		,age_y_dx INT(3) DEFAULT 0
		,groupcode INT(3) DEFAULT 0
		,sex VARCHAR(1) DEFAULT NULL 
		,nation VARCHAR(3) DEFAULT NULL 
		,p_hospcode VARCHAR(5) DEFAULT NULL 
		,d_hospcode VARCHAR(5) DEFAULT NULL 
		,p_pt_vhid VARCHAR(8) DEFAULT NULL 
		,d_pt_vhid VARCHAR(8) DEFAULT NULL 
		,p_typearea VARCHAR(1) DEFAULT NULL 
		,d_typearea VARCHAR(1) DEFAULT NULL 
		,input_hosp VARCHAR(5) DEFAULT NULL 
		,input_pid VARCHAR(15) DEFAULT NULL 
		,source_tb VARCHAR(20) DEFAULT NULL 
		,diagcode VARCHAR(10) NOT NULL
		,date_dx date DEFAULT NULL 
		,hosp_dx VARCHAR(5) DEFAULT NULL 
		,hosp_rx VARCHAR(5) DEFAULT NULL 
		,typedisch VARCHAR(2) DEFAULT NULL 
		,datedisch date DEFAULT NULL 
		,minscl VARCHAR(5) DEFAULT NULL 
		,inscl VARCHAR(3) DEFAULT NULL 
	,PRIMARY KEY (cid,diagcode)
	,KEY (cid)
	,KEY (diagcode)

) ENGINE=MyISAM DEFAULT CHARSET=utf8;

/*import from chronic*/
INSERT IGNORE INTO t_chronic
(
	cid,birth,age_y,age_y_dx,sex,nation,p_hospcode,d_hospcode,p_pt_vhid,d_pt_vhid
	,p_typearea,d_typearea,input_hosp,input_pid,source_tb,diagcode,date_dx
	,hosp_dx,hosp_rx,typedisch,datedisch,minscl,inscl
)
(
SELECT SQL_BIG_RESULT 
	p.CID,p.BIRTH,age(NOW(),p.BIRTH,'y'),age(t.date_diag,p.BIRTH,'y'),p.SEX,p.NATION
	,p.HOSPCODE,p.check_hosp,p.vhid,p.check_vhid,p.TYPEAREA,p.check_typearea
	,t.hosp_input,t.pid_input,t.pt_from,t.diagcode,t.date_diag,t.hosp_dx,t.hosp_rx,t.typedisch,t.datedisch
	,p.maininscl,p.inscl

FROM
	(     SELECT
			c.cid,c.HOSPCODE as hosp_input,c.pid as pid_input,date_diag,c.CHRONIC as diagcode
			,IFNULL(c.HOSP_DX,'00000') as HOSP_DX,c.HOSP_RX,c.TYPEDISCH,c.DATE_DISCH as datedisch,'chronic' as pt_from
		FROM
			tmp_chronic c
		GROUP BY c.CID,c.CHRONIC
	) as t INNER JOIN t_person_cid p ON p.cid=t.cid
);

/*import from diagopd*/
INSERT IGNORE INTO t_chronic
(
	cid,birth,age_y,age_y_dx,sex,nation,p_hospcode,d_hospcode,p_pt_vhid,d_pt_vhid
	,p_typearea,d_typearea,input_hosp,input_pid,source_tb,diagcode,date_dx
	,hosp_dx,hosp_rx,minscl,inscl
)
(
SELECT SQL_BIG_RESULT 
	p.CID,p.BIRTH,age(NOW(),p.BIRTH,'y'),age(t.date_diag,p.BIRTH,'y'),p.SEX,p.NATION
	,p.HOSPCODE,p.check_hosp,p.vhid,p.check_vhid,p.TYPEAREA,p.check_typearea
	,t.hosp_input,t.pid_input,t.pt_from,t.diagcode,t.date_diag,t.hosp_dx,t.hosp_rx
	,p.maininscl,p.inscl

FROM
	(
		SELECT
			o.cid,o.HOSPCODE hosp_input,o.pid pid_input,o.date_serv date_diag,o.diagcode
			,o.HOSPCODE hosp_dx,o.HOSPCODE hosp_rx,'diag_opd' as pt_from
		FROM
			tmp_chronic_opd o
		GROUP BY o.cid,o.diagcode
	) as t INNER JOIN t_person_cid p ON p.cid=t.cid
);

/*import from diagipd*/
INSERT IGNORE INTO t_chronic
(
	cid,birth,age_y,age_y_dx,sex,nation,p_hospcode,d_hospcode,p_pt_vhid,d_pt_vhid
	,p_typearea,d_typearea,input_hosp,input_pid,source_tb,diagcode,date_dx
	,hosp_dx,hosp_rx,minscl,inscl
)
(
SELECT SQL_BIG_RESULT 
	p.CID,p.BIRTH,age(NOW(),p.BIRTH,'y'),age(t.date_diag,p.BIRTH,'y'),p.SEX,p.NATION
	,p.HOSPCODE,p.check_hosp,p.vhid,p.check_vhid,p.TYPEAREA,p.check_typearea
	,t.hosp_input,t.pid_input,t.pt_from,t.diagcode,t.date_diag,t.hosp_dx,t.hosp_rx
	,p.maininscl,p.inscl

FROM
	(
		SELECT
			i.cid,i.HOSPCODE hosp_input,i.pid pid_input,DATE_FORMAT(i.DATETIME_ADMIT,'%Y-%m-%d') date_diag,i.diagcode
			,i.HOSPCODE hosp_dx,i.HOSPCODE hosp_rx,'diag_ipd' as pt_from
		FROM
			tmp_chronic_ipd i
		GROUP BY i.cid,i.diagcode
	) as t INNER JOIN t_person_cid p ON p.cid=t.cid
);





UPDATE t_chronic t ,cage  ag SET t.groupcode=ag.groupcode1560
WHERE t.age_y=ag.age ;

/*
UPDATE t_chronic c,tmp_chronic tc
		SET c.typedisch=tc.typedisch,c.date_dx=tc.DATE_DIAG
WHERE c.cid = tc.cid AND c.diagcode=tc.chronic;
*/

UPDATE t_chronic c,t_person_cid p SET c.typedisch='02'  
WHERE c.cid=p.cid AND p.DISCHARGE=1;

 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.049643;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:103;a:5:{i:0;s:31:"DROP PROCEDURE IF EXISTS t_dmht";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.049643;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:104;a:5:{i:0;s:31:"DROP PROCEDURE IF EXISTS t_dmht";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.1276431;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:106;a:5:{i:0;s:17166:"CREATE PROCEDURE t_dmht()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '13';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-2,'1001');
SET	@start_d1:=concat(@b_year-1,'0701');
SET	@start_d2:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLES IF EXISTS tmp_labfu;
CREATE TABLE IF NOT EXISTS tmp_labfu( 
  `HOSPCODE` varchar(5) NOT NULL,
  `PID` varchar(15) NOT NULL,
  `SEQ` varchar(16) NOT NULL,
  `DATE_SERV` date NOT NULL,
  `LABTEST` varchar(7) NOT NULL DEFAULT '',
  `LABRESULT` double(6,2) NOT NULL,
  `D_UPDATE` datetime NOT NULL,
  `CID` varchar(13) DEFAULT NULL,
  `LABTEST_SEND` varchar(7) DEFAULT NULL,
  `LABTEST_NEW` varchar(7) DEFAULT NULL,
PRIMARY KEY (HOSPCODE,PID,SEQ,LABTEST_SEND),
KEY (hospcode),KEY (pid),KEY (seq),KEY (cid),
KEY (date_serv),KEY (labtest),KEY (labresult),
KEY (LABTEST_SEND), KEY (LABTEST_NEW)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO tmp_labfu (HOSPCODE,PID,SEQ,DATE_SERV,LABTEST_SEND,LABRESULT,D_UPDATE,CID)
(SELECT SQL_BIG_RESULT 
				l.HOSPCODE,l.PID,l.SEQ,l.DATE_SERV,l.LABTEST,l.LABRESULT,l.D_UPDATE,p.CID
FROM
	labfu l LEFT JOIN t_person_db p ON  l.HOSPCODE=p.HOSPCODE AND l.PID=p.PID
WHERE	DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY HOSPCODE,PID,SEQ,LABTEST
);

UPDATE tmp_labfu l SET l.LABTEST=l.LABTEST_SEND WHERE LENGTH(TRIM(l.LABTEST_SEND)) =2;

UPDATE tmp_labfu l INNER JOIN clabtest_new c ON l.LABTEST=c.old_code 
SET l.LABTEST_NEW=c.`code`
WHERE LENGTH(TRIM(l.LABTEST)) =2;

UPDATE tmp_labfu l INNER JOIN clabtest_new c ON l.LABTEST_SEND=c.`code` 
SET l.LABTEST=c.old_code , l.LABTEST_NEW=c.`code`
WHERE LENGTH(TRIM(l.LABTEST_SEND)) > 2;


DROP TABLES IF EXISTS tmp_chronicfu;
CREATE TABLE IF NOT EXISTS tmp_chronicfu (
KEY (hospcode),
KEY (pid),
KEY (seq),
KEY (cid),
KEY (date_serv),
KEY (sbp),
KEY (dbp),
KEY (foot),
KEY (retina)
)ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		c.*,p.CID
FROM
	chronicfu c LEFT JOIN t_person_db p ON c.HOSPCODE=p.HOSPCODE AND c.PID=p.PID
WHERE	DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY HOSPCODE,PID,SEQ
	);

DROP TABLE IF EXISTS t_chronicfu;
CREATE  TABLE IF NOT EXISTS t_chronicfu(
hospcode VARCHAR(5) NOT NULL,
pid VARCHAR(15) NOT NULL,
cid VARCHAR(13) NOT NULL,
ld_bp1 date DEFAULT NULL,
ld_bp2 date DEFAULT NULL,
sbp_1 VARCHAR(10) DEFAULT NULL,
dbp_1 VARCHAR(10) DEFAULT NULL,
sbp_2 VARCHAR(10) DEFAULT NULL,
dbp_2 VARCHAR(10) DEFAULT NULL,
ld_hba1c date DEFAULT NULL,
hba1c  VARCHAR(10) DEFAULT NULL,
ld_foot date DEFAULT NULL ,
foot VARCHAR(10)  DEFAULT NULL,
ld_retina date DEFAULT NULL, 
retina VARCHAR(10)  DEFAULT NULL ,
control_dm int(1) DEFAULT '0',
control_ht int(1) DEFAULT '0',
PRIMARY KEY (cid,hospcode),
KEY (cid),
KEY (hospcode)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 AS
(
SELECT hospcode,pid,cid,null as sbp_1 ,null as dbp_1,null as sbp_2,null as dbp_2,null as hba1c
,null as ld_foot,null as foot,null as ld_retina,null as retina,0 as control_dm ,0 as control_ht
FROM tmp_chronicfu 
WHERE LENGTH(cid)=13  AND DATE_SERV BETWEEN @start_d2 AND @end_d
GROUP BY HOSPCODE,cid
);
UPDATE t_chronicfu f INNER JOIN (
	SELECT hospcode , pid ,max(date_serv) date_serv 
	FROM tmp_labfu WHERE labtest in(5) 
	GROUP BY hospcode,PID
) l ON f.hospcode=l.hospcode AND f.pid=l.pid
SET f.ld_hba1c=l.date_serv;

UPDATE t_chronicfu f INNER JOIN tmp_labfu l ON f.hospcode=l.hospcode AND f.pid=l.pid AND f.ld_hba1c=l.DATE_SERV 
SET f.hba1c=l.LABRESULT
WHERE l.LABTEST in(5);

UPDATE t_chronicfu SET control_dm='1' WHERE  (hba1c BETWEEN 0.1  AND 6.99)	AND ld_hba1c BETWEEN @start_d2 AND @end_d	;

UPDATE t_chronicfu d ,	
								(SELECT c.HOSPCODE, c.PID ,c.DATE_SERV,c.SBP,c.DBP
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV =
								(SELECT c1.DATE_SERV FROM tmp_chronicfu c1 WHERE c1.HOSPCODE=c.HOSPCODE  AND c1.pid=c.pid 
									and c1.SBP >0 AND c1.DBP>0  GROUP BY c1.HOSPCODE,c1.PID,c1.DATE_SERV 
									ORDER BY c1.date_serv desc LIMIT 0,1)
								GROUP BY hospcode,PID) as t
		SET ld_bp1 =t.DATE_SERV,sbp_1 =t.SBP,dbp_1 =t.DBP
WHERE		d.HOSPCODE=t.HOSPCODE  AND d.pid=t.pid  ;
/*last_bp2*/
UPDATE t_chronicfu d ,	
								(SELECT c.HOSPCODE, c.PID ,c.DATE_SERV,c.SBP,c.DBP
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV =
								(SELECT c1.DATE_SERV FROM tmp_chronicfu c1 WHERE c1.HOSPCODE=c.HOSPCODE  AND c1.pid=c.pid 
									and c1.SBP >0 AND c1.DBP>0  GROUP BY c1.HOSPCODE,c1.PID,c1.DATE_SERV 
									ORDER BY c1.date_serv desc LIMIT 1,1)
								GROUP BY hospcode,PID) as t
		SET ld_bp2 =t.DATE_SERV,sbp_2 =t.SBP,dbp_2 =t.DBP
WHERE		d.HOSPCODE=t.HOSPCODE  AND d.pid=t.pid  ;

UPDATE t_chronicfu SET control_ht ='1'	 WHERE 		
 (sbp_1  > 50 AND sbp_1 <= 139) AND (sbp_2 > 50 AND sbp_2 <=139 )
AND (dbp_1 > 50 AND dbp_1 <= 89) AND (dbp_1 > 50 AND dbp_1 <= 89) AND ld_bp1 BETWEEN @start_d2 AND @end_d ;

UPDATE t_chronicfu f INNER JOIN (
	SELECT hospcode , pid ,max(date_serv) date_serv 
	FROM tmp_chronicfu WHERE foot in(1,3) 
	GROUP BY hospcode,PID
) l ON f.hospcode=l.hospcode AND f.pid=l.pid
SET f.ld_foot=l.date_serv;

UPDATE t_chronicfu f INNER JOIN tmp_chronicfu l ON f.hospcode=l.hospcode AND f.pid=l.pid AND f.ld_foot=l.DATE_SERV 
SET f.foot=l.foot;

UPDATE t_chronicfu f INNER JOIN (
	SELECT hospcode , pid ,max(date_serv) date_serv 
	FROM tmp_chronicfu WHERE retina in(1,2,3,4) 
	GROUP BY hospcode,PID
) l ON f.hospcode=l.hospcode AND f.pid=l.pid
SET f.ld_retina=l.date_serv;

UPDATE t_chronicfu f INNER JOIN tmp_chronicfu l ON f.hospcode=l.hospcode AND f.pid=l.pid AND f.ld_retina=l.DATE_SERV 
SET f.retina=l.retina;


DROP TABLES IF EXISTS t_dmht;
CREATE TABLE IF NOT EXISTS t_dmht (
		id int(15) NOT NULL AUTO_INCREMENT
		,hospcode VARCHAR(5) DEFAULT NULL 
		,pid VARCHAR(15)  DEFAULT NULL 
		,vhid VARCHAR(8) DEFAULT NULL 
		,typearea VARCHAR(1) DEFAULT NULL 
		,cid VARCHAR(13) NOT NULL
		,birth date
		,age_y INT(3) DEFAULT 0
		,groupcode1560 VARCHAR(100) DEFAULT NULL 
		,groupname1560 VARCHAR(100) DEFAULT NULL 
		,sex VARCHAR(1) DEFAULT NULL 
		,nation VARCHAR(3) DEFAULT NULL 
		,source_tb VARCHAR(255) DEFAULT NULL 
		,mix_dx VARCHAR(255) DEFAULT NULL 	
		,t_mix_dx VARCHAR(255) DEFAULT NULL 	
		,type_dx VARCHAR(2) DEFAULT NULL 
		,date_dx VARCHAR(255) DEFAULT NULL 
		,hosp_dx varchar(255) DEFAULT NULL 
		,minscl VARCHAR(5) DEFAULT NULL 
		,inscl VARCHAR(3) DEFAULT NULL 
		,ld_hba1c date  DEFAULT NULL 
		,rs_hba1c VARCHAR(10)  DEFAULT NULL
		,ih_hba1c  VARCHAR(5)  DEFAULT NULL
		,ld_fpg1 date DEFAULT NULL 
		,rs_fpg1 VARCHAR(10)  DEFAULT NULL 
		,ih_fpg1  VARCHAR(5)  DEFAULT NULL
		,ld_fpg2 date DEFAULT NULL 
		,rs_fpg2 VARCHAR(10)  DEFAULT NULL 
		,ih_fpg2  VARCHAR(5)  DEFAULT NULL
		,ld_fpg3 date DEFAULT NULL 
		,rs_fpg3 VARCHAR(10)  DEFAULT NULL 
		,ih_fpg3  VARCHAR(5)  DEFAULT NULL
		,ld_creatinine date DEFAULT NULL 
		,rs_creatinine VARCHAR(10)  DEFAULT NULL 
		,ih_creatinine VARCHAR(5)  DEFAULT NULL
		,ld_lipid date DEFAULT NULL 
		,rs_lipid VARCHAR(10)  DEFAULT NULL 
		,ih_lipid VARCHAR(5)  DEFAULT NULL
		,ld_foot date DEFAULT NULL 
		,rs_foot VARCHAR(10)  DEFAULT NULL
		,ih_foot VARCHAR(5)  DEFAULT NULL 
		,ld_retina date DEFAULT NULL 
		,rs_retina VARCHAR(10)  DEFAULT NULL 
		,ih_retina VARCHAR(5)  DEFAULT NULL 
		,ld_bp1 date DEFAULT NULL 
		,ih_bp1 VARCHAR(5)  DEFAULT NULL 
		,rs_bps1 VARCHAR(10)  DEFAULT NULL 
		,rs_bpd1 VARCHAR(10)  DEFAULT NULL 
		,ld_bp2 date  DEFAULT NULL 
		,ih_bp2 VARCHAR(5)  DEFAULT NULL 
		,rs_bps2 VARCHAR(10)  DEFAULT NULL 
		,rs_bpd2 VARCHAR(10)  DEFAULT NULL 
		,`complication_dm` varchar(20) DEFAULT '0',
  `complication_ht` varchar(20) DEFAULT '0',
  `control_dm` int(1) DEFAULT '0',
  `control_ht` int(1) DEFAULT '0',
  `bmi` decimal(10,2) DEFAULT '0',
  `obes` int(1) DEFAULT '0',
  `height` smallint(6) DEFAULT '0',
  `weight` mediumint(9) DEFAULT '0',
	`waist_cm`  smallint(6) NULL DEFAULT 0 ,
	PRIMARY KEY (cid)
	,KEY (cid)
  ,KEY (id)
	,KEY (type_dx)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO t_dmht(
	hospcode,vhid,typearea,cid,birth,age_y,groupcode1560,groupname1560,sex,nation,minscl,inscl,source_tb,hosp_dx,mix_dx,t_mix_dx,date_dx
)
(
	SELECT SQL_BIG_RESULT 
			p.check_hosp,p.check_vhid,p.check_typearea,p.cid,p.birth,p.age_y,a.groupcode1560,a.groupname1560,p.sex,p.nation
			,p.maininscl,p.inscl
			,GROUP_CONCAT(c.source_tb ORDER BY c.date_dx ) source_tb
			,GROUP_CONCAT(c.hosp_dx ORDER BY c.date_dx ) hosp_dx
			,GROUP_CONCAT(c.diagcode ORDER BY c.date_dx  ) diagcode
			,GROUP_CONCAT(DISTINCT  substr(c.diagcode,1,1) ORDER BY SUBSTR(c.diagcode,1,1)  ) 
			,GROUP_CONCAT(c.date_dx  ORDER BY c.date_dx ) date_dx
FROM
(SELECT * FROM t_chronic 
WHERE  (SUBSTR(UPPER(diagcode),1,3) BETWEEN  'E10' and 'E14'  OR 	SUBSTR(UPPER(diagcode),1,3) BETWEEN  'I10' and 'I15')  
GROUP BY concat(cid,'-',diagcode) ) c 
INNER JOIN t_person_cid  p ON c.cid = p.cid
LEFT JOIN cage a ON	 p.age_y=a.age
WHERE p.nation IN(99)  AND p.DISCHARGE  IN(9)
GROUP BY p.cid
);

/*update pid*/
UPDATE t_dmht d,t_person_cid p  SET d.pid=p.pid WHERE d.cid=p.cid AND d.hospcode=p.hospcode;

/*up_mixdiag*/
UPDATE t_dmht 
	SET type_dx = if(t_mix_dx ='I' ,'01'  
							,if(t_mix_dx ='E' ,'02'
							,if(t_mix_dx ='E,I','03',NULL)));


/*up_hba1c*/
UPDATE IGNORE t_dmht d INNER JOIN 
(SELECT cid,MAX(date_serv) date_serv FROM  tmp_labfu WHERE labtest IN(5) GROUP BY cid) l ON d.cid=l.cid 
SET d.ld_hba1c =l.date_serv;

UPDATE IGNORE t_dmht d INNER JOIN tmp_labfu l ON d.cid=l.cid  AND d.ld_hba1c =l.date_serv
SET d.rs_hba1c =l.labresult ,d.ih_hba1c=l.HOSPCODE
WHERE l.labtest IN(5);


/*up_fpg1*/
UPDATE t_dmht d ,
								(SELECT l.cid,l.HOSPCODE,l.DATE_SERV,l.LABRESULT 
								FROM tmp_labfu l
								WHERE l.labtest in(1,3) 
								    AND l.DATE_SERV =
								(SELECT l1.DATE_SERV FROM tmp_labfu l1 WHERE l1.labtest in(1,3) AND l1.cid=l.cid GROUP BY l1.cid,l1.DATE_SERV ORDER BY l1.date_serv desc LIMIT 0,1)
								GROUP BY cid) as t
		SET ld_fpg1 =t.DATE_SERV,rs_fpg1 =t.LABRESULT ,ih_fpg1=t.hospcode
WHERE
		d.cid=t.cid ;

/*up_fpg2*/
UPDATE t_dmht d ,
								(SELECT l.cid,l.DATE_SERV,l.LABRESULT,l.HOSPCODE
								FROM tmp_labfu l
								WHERE l.labtest in(1,3) 
								    AND l.DATE_SERV =
								(SELECT l1.DATE_SERV FROM tmp_labfu l1 WHERE l1.labtest in(1,3) AND l1.cid=l.cid GROUP BY l1.cid,l1.DATE_SERV ORDER BY l1.date_serv desc LIMIT 1,1)
								GROUP BY cid) as t
		SET ld_fpg2 =t.DATE_SERV,rs_fpg2 =t.LABRESULT ,ih_fpg2=t.hospcode
WHERE
		d.cid=t.cid ;

/*up_fpg3*/
UPDATE t_dmht d ,
								(SELECT l.cid,l.DATE_SERV,l.LABRESULT,l.HOSPCODE
								FROM tmp_labfu l
								WHERE l.labtest in(1,3) 
								    AND l.DATE_SERV =
								(SELECT l1.DATE_SERV FROM tmp_labfu l1 WHERE l1.labtest in(1,3) AND l1.cid=l.cid GROUP BY l1.cid,l1.DATE_SERV ORDER BY l1.date_serv desc LIMIT 2,1)
								GROUP BY cid) as t
		SET ld_fpg3 =t.DATE_SERV,rs_fpg3 =t.LABRESULT,ih_fpg3=t.hospcode
WHERE
		d.cid=t.cid ;
/*Creatinine*/ 
UPDATE t_dmht d ,	
								(SELECT l.cid,l.DATE_SERV,l.LABRESULT,l.HOSPCODE
								FROM tmp_labfu l
								WHERE l.labtest in(11,13) 
								    AND l.DATE_SERV =
								(SELECT l1.DATE_SERV FROM tmp_labfu l1 WHERE l1.labtest in(11,13) AND l1.cid=l.cid GROUP BY l1.cid,l1.DATE_SERV ORDER BY l1.date_serv desc LIMIT 0,1)
								GROUP BY cid) as t
		SET ld_creatinine =t.DATE_SERV,rs_creatinine =t.LABRESULT,ih_creatinine=t.hospcode 
WHERE
		d.cid=t.cid ;

/*lipid TotalCholesterol*/
UPDATE t_dmht d ,	
								(SELECT l.cid,l.DATE_SERV,l.LABRESULT,l.HOSPCODE 
								FROM tmp_labfu l
								WHERE l.labtest in(7) 
								    AND l.DATE_SERV =
								(SELECT l1.DATE_SERV FROM tmp_labfu l1 WHERE l1.labtest in(7) AND l1.cid=l.cid GROUP BY l1.cid,l1.DATE_SERV ORDER BY l1.date_serv desc LIMIT 0,1)
								GROUP BY cid) as t
		SET ld_lipid =t.DATE_SERV,rs_lipid =t.LABRESULT ,ih_lipid=t.hospcode 
WHERE
		d.cid=t.cid ;

/*foot*/
UPDATE t_dmht d ,	
								(SELECT c.cid,c.DATE_SERV,c.FOOT,c.HOSPCODE
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV =
								(SELECT c1.DATE_SERV FROM tmp_chronicfu c1 WHERE c1.cid=c.cid and c1.foot in(1,3) GROUP BY c1.cid,c1.DATE_SERV ORDER BY c1.date_serv desc LIMIT 0,1)
								GROUP BY cid) as t
		SET ld_foot =t.DATE_SERV,rs_foot =t.FOOT,ih_foot=t.hospcode
WHERE
		d.cid=t.cid ;

/*retina*/ 
UPDATE t_dmht d ,	
								(SELECT c.cid,c.DATE_SERV,c.RETINA,c.HOSPCODE
								FROM tmp_chronicfu c
								WHERE c.RETINA in(1,2,3,4)  AND c.DATE_SERV =
								(SELECT c1.DATE_SERV FROM tmp_chronicfu c1 WHERE c1.cid=c.cid and c1.RETINA in(1,2,3,4) GROUP BY c1.cid,c1.DATE_SERV ORDER BY c1.date_serv desc LIMIT 0,1)
								GROUP BY cid) as t
		SET ld_retina =t.DATE_SERV,rs_retina =t.RETINA ,ih_retina=t.hospcode
WHERE
		d.cid=t.cid ;

/*last_bp1*/ 
UPDATE t_dmht d ,	
								(SELECT c.cid,c.DATE_SERV,c.SBP,c.DBP,c.HOSPCODE
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV =
								(SELECT c1.DATE_SERV FROM tmp_chronicfu c1 WHERE c1.cid=c.cid and c1.SBP >0 AND c1.DBP>0  GROUP BY c1.cid,c1.DATE_SERV ORDER BY c1.date_serv desc LIMIT 0,1)
								GROUP BY cid) as t
		SET ld_bp1 =t.DATE_SERV,rs_bps1 =t.SBP,rs_bpd1 =t.DBP,ih_bp1=t.hospcode
WHERE
		d.cid=t.cid ;

/*last_bp2*/
UPDATE t_dmht d ,	
								(SELECT c.cid,c.DATE_SERV,c.SBP,c.DBP,c.HOSPCODE
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV =
								(SELECT c1.DATE_SERV FROM tmp_chronicfu c1 WHERE c1.cid=c.cid and c1.SBP >0 AND c1.DBP>0 GROUP BY c1.cid,c1.DATE_SERV ORDER BY c1.date_serv desc LIMIT 1,1)
								GROUP BY cid) as t
		SET ld_bp2 =t.DATE_SERV,rs_bps2 =t.SBP,rs_bpd2 =t.DBP,ih_bp2=t.hospcode
WHERE
		d.cid=t.cid ;

/*ภาวะแทรกซ้อนทางตา*/
UPDATE t_dmht t , (
					SELECT 
							cid
					FROM
					tmp_chronic_opd 
					WHERE diagcode in('E103','E113','E123','E133','E143','H360','H280')
)  d SET complication_dm='1' WHERE t.cid=d.cid AND d.cid is not null AND t.type_dx in(2,3);
/*ไต*/
UPDATE t_dmht t , (
					SELECT 
							cid
					FROM
					tmp_chronic_opd 
					WHERE diagcode in('E102','E112','E122','E132','E142','N083')
)  d SET complication_dm='2' WHERE t.cid=d.cid AND d.cid is not null AND t.type_dx in(2,3);

/*เท้า*/
UPDATE t_dmht t , (
					SELECT 
							cid
					FROM
					tmp_chronic_opd 
					WHERE diagcode in('E104','E114','E124','E134','E144','I792','E105','E115','E125','E135','E145' )
)  d SET complication_dm='3' WHERE t.cid=d.cid AND d.cid is not null AND t.type_dx in(2,3);

/*หลายอย่าง*/
UPDATE t_dmht t , (
					SELECT 
							cid
					FROM
					tmp_chronic_opd 
					WHERE diagcode in('E107','E117','E127','E137','E147')
)  d SET complication_dm='4' WHERE t.cid=d.cid AND d.cid is not null AND t.type_dx in(2,3);
/*ภาวะนำ้ตาลตำ่*/
UPDATE t_dmht t , (
					SELECT 
							cid
					FROM
					tmp_chronic_opd 
					WHERE diagcode in('E16')
)  d SET complication_dm='5' WHERE t.cid=d.cid AND d.cid is not null AND t.type_dx in(2,3);

UPDATE t_dmht t , (
					SELECT 
							cid
					FROM
					tmp_chronic_opd 
					WHERE diagcode in('E131')
)  d SET complication_dm='6' WHERE t.cid=d.cid AND d.cid is not null AND t.type_dx in(2,3);
/*หัวใจ*/
UPDATE t_dmht t , (
					SELECT 
							cid
					FROM
					tmp_chronic_opd 
					WHERE diagcode in('I110','I119')
)  d SET complication_ht='1' WHERE t.cid=d.cid AND d.cid is not null AND t.type_dx in(1,3);
/*ไต*/
UPDATE t_dmht t , (
					SELECT 
							cid
					FROM
					tmp_chronic_opd 
					WHERE diagcode in('I120','I129')
)  d SET complication_ht='2' WHERE t.cid=d.cid AND d.cid is not null AND t.type_dx in(1,3);

/*ไตหัวใจ*/
UPDATE t_dmht t , (
					SELECT 
							cid
					FROM
					tmp_chronic_opd 
					WHERE diagcode in('I130','I131','I132','I139')
)  d SET complication_ht='3' WHERE t.cid=d.cid AND d.cid is not null AND t.type_dx in(1,3);

/*w,h*/
UPDATE t_dmht t , (
				SELECT
				*
				FROM
				(SELECT 
							cid,weight,height,WAIST_CM
					FROM
					tmp_chronicfu
					WHERE  weight is not null  and height is not null
					ORDER BY DATE_SERV DESC
					) pre
					GROUP BY cid
)  d SET t.weight=d.weight ,t.height=d.height,t.waist_cm=d.waist_cm  WHERE t.cid=d.cid AND d.cid is not null ;

/*up control dm 1 ok 0 not ok*/
UPDATE t_dmht SET control_dm='1' WHERE type_dx in(2,3) AND 
			(rs_hba1c BETWEEN 0.1  AND 6.99)	AND ld_hba1c BETWEEN @start_d2 AND @end_d	;
/*bp control*/
UPDATE t_dmht SET control_ht ='1'	 WHERE 		
type_dx in(1,3) AND (rs_bps1  > 50 AND rs_bps1 <= 139) AND (rs_bps2 > 50 AND rs_bps2 <=139 )
AND (rs_bpd1 > 50 AND rs_bpd1 <= 89) AND (rs_bpd2 > 50 AND rs_bpd2 <= 89) AND ld_bp1 BETWEEN @start_d2 AND @end_d ;

UPDATE t_dmht SET bmi=round(WEIGHT/((HEIGHT/100)*(HEIGHT/100)),2) ;


UPDATE t_dmht SET obes =1 WHERE
(sex='1' AND round(WAIST_CM)>90) OR (sex='2' AND round(WAIST_CM)>80)
OR bmi>=25;

 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.1432431;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:107;a:5:{i:0;s:17166:"CREATE PROCEDURE t_dmht()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '13';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-2,'1001');
SET	@start_d1:=concat(@b_year-1,'0701');
SET	@start_d2:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLES IF EXISTS tmp_labfu;
CREATE TABLE IF NOT EXISTS tmp_labfu( 
  `HOSPCODE` varchar(5) NOT NULL,
  `PID` varchar(15) NOT NULL,
  `SEQ` varchar(16) NOT NULL,
  `DATE_SERV` date NOT NULL,
  `LABTEST` varchar(7) NOT NULL DEFAULT '',
  `LABRESULT` double(6,2) NOT NULL,
  `D_UPDATE` datetime NOT NULL,
  `CID` varchar(13) DEFAULT NULL,
  `LABTEST_SEND` varchar(7) DEFAULT NULL,
  `LABTEST_NEW` varchar(7) DEFAULT NULL,
PRIMARY KEY (HOSPCODE,PID,SEQ,LABTEST_SEND),
KEY (hospcode),KEY (pid),KEY (seq),KEY (cid),
KEY (date_serv),KEY (labtest),KEY (labresult),
KEY (LABTEST_SEND), KEY (LABTEST_NEW)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO tmp_labfu (HOSPCODE,PID,SEQ,DATE_SERV,LABTEST_SEND,LABRESULT,D_UPDATE,CID)
(SELECT SQL_BIG_RESULT 
				l.HOSPCODE,l.PID,l.SEQ,l.DATE_SERV,l.LABTEST,l.LABRESULT,l.D_UPDATE,p.CID
FROM
	labfu l LEFT JOIN t_person_db p ON  l.HOSPCODE=p.HOSPCODE AND l.PID=p.PID
WHERE	DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY HOSPCODE,PID,SEQ,LABTEST
);

UPDATE tmp_labfu l SET l.LABTEST=l.LABTEST_SEND WHERE LENGTH(TRIM(l.LABTEST_SEND)) =2;

UPDATE tmp_labfu l INNER JOIN clabtest_new c ON l.LABTEST=c.old_code 
SET l.LABTEST_NEW=c.`code`
WHERE LENGTH(TRIM(l.LABTEST)) =2;

UPDATE tmp_labfu l INNER JOIN clabtest_new c ON l.LABTEST_SEND=c.`code` 
SET l.LABTEST=c.old_code , l.LABTEST_NEW=c.`code`
WHERE LENGTH(TRIM(l.LABTEST_SEND)) > 2;


DROP TABLES IF EXISTS tmp_chronicfu;
CREATE TABLE IF NOT EXISTS tmp_chronicfu (
KEY (hospcode),
KEY (pid),
KEY (seq),
KEY (cid),
KEY (date_serv),
KEY (sbp),
KEY (dbp),
KEY (foot),
KEY (retina)
)ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		c.*,p.CID
FROM
	chronicfu c LEFT JOIN t_person_db p ON c.HOSPCODE=p.HOSPCODE AND c.PID=p.PID
WHERE	DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY HOSPCODE,PID,SEQ
	);

DROP TABLE IF EXISTS t_chronicfu;
CREATE  TABLE IF NOT EXISTS t_chronicfu(
hospcode VARCHAR(5) NOT NULL,
pid VARCHAR(15) NOT NULL,
cid VARCHAR(13) NOT NULL,
ld_bp1 date DEFAULT NULL,
ld_bp2 date DEFAULT NULL,
sbp_1 VARCHAR(10) DEFAULT NULL,
dbp_1 VARCHAR(10) DEFAULT NULL,
sbp_2 VARCHAR(10) DEFAULT NULL,
dbp_2 VARCHAR(10) DEFAULT NULL,
ld_hba1c date DEFAULT NULL,
hba1c  VARCHAR(10) DEFAULT NULL,
ld_foot date DEFAULT NULL ,
foot VARCHAR(10)  DEFAULT NULL,
ld_retina date DEFAULT NULL, 
retina VARCHAR(10)  DEFAULT NULL ,
control_dm int(1) DEFAULT '0',
control_ht int(1) DEFAULT '0',
PRIMARY KEY (cid,hospcode),
KEY (cid),
KEY (hospcode)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 AS
(
SELECT hospcode,pid,cid,null as sbp_1 ,null as dbp_1,null as sbp_2,null as dbp_2,null as hba1c
,null as ld_foot,null as foot,null as ld_retina,null as retina,0 as control_dm ,0 as control_ht
FROM tmp_chronicfu 
WHERE LENGTH(cid)=13  AND DATE_SERV BETWEEN @start_d2 AND @end_d
GROUP BY HOSPCODE,cid
);
UPDATE t_chronicfu f INNER JOIN (
	SELECT hospcode , pid ,max(date_serv) date_serv 
	FROM tmp_labfu WHERE labtest in(5) 
	GROUP BY hospcode,PID
) l ON f.hospcode=l.hospcode AND f.pid=l.pid
SET f.ld_hba1c=l.date_serv;

UPDATE t_chronicfu f INNER JOIN tmp_labfu l ON f.hospcode=l.hospcode AND f.pid=l.pid AND f.ld_hba1c=l.DATE_SERV 
SET f.hba1c=l.LABRESULT
WHERE l.LABTEST in(5);

UPDATE t_chronicfu SET control_dm='1' WHERE  (hba1c BETWEEN 0.1  AND 6.99)	AND ld_hba1c BETWEEN @start_d2 AND @end_d	;

UPDATE t_chronicfu d ,	
								(SELECT c.HOSPCODE, c.PID ,c.DATE_SERV,c.SBP,c.DBP
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV =
								(SELECT c1.DATE_SERV FROM tmp_chronicfu c1 WHERE c1.HOSPCODE=c.HOSPCODE  AND c1.pid=c.pid 
									and c1.SBP >0 AND c1.DBP>0  GROUP BY c1.HOSPCODE,c1.PID,c1.DATE_SERV 
									ORDER BY c1.date_serv desc LIMIT 0,1)
								GROUP BY hospcode,PID) as t
		SET ld_bp1 =t.DATE_SERV,sbp_1 =t.SBP,dbp_1 =t.DBP
WHERE		d.HOSPCODE=t.HOSPCODE  AND d.pid=t.pid  ;
/*last_bp2*/
UPDATE t_chronicfu d ,	
								(SELECT c.HOSPCODE, c.PID ,c.DATE_SERV,c.SBP,c.DBP
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV =
								(SELECT c1.DATE_SERV FROM tmp_chronicfu c1 WHERE c1.HOSPCODE=c.HOSPCODE  AND c1.pid=c.pid 
									and c1.SBP >0 AND c1.DBP>0  GROUP BY c1.HOSPCODE,c1.PID,c1.DATE_SERV 
									ORDER BY c1.date_serv desc LIMIT 1,1)
								GROUP BY hospcode,PID) as t
		SET ld_bp2 =t.DATE_SERV,sbp_2 =t.SBP,dbp_2 =t.DBP
WHERE		d.HOSPCODE=t.HOSPCODE  AND d.pid=t.pid  ;

UPDATE t_chronicfu SET control_ht ='1'	 WHERE 		
 (sbp_1  > 50 AND sbp_1 <= 139) AND (sbp_2 > 50 AND sbp_2 <=139 )
AND (dbp_1 > 50 AND dbp_1 <= 89) AND (dbp_1 > 50 AND dbp_1 <= 89) AND ld_bp1 BETWEEN @start_d2 AND @end_d ;

UPDATE t_chronicfu f INNER JOIN (
	SELECT hospcode , pid ,max(date_serv) date_serv 
	FROM tmp_chronicfu WHERE foot in(1,3) 
	GROUP BY hospcode,PID
) l ON f.hospcode=l.hospcode AND f.pid=l.pid
SET f.ld_foot=l.date_serv;

UPDATE t_chronicfu f INNER JOIN tmp_chronicfu l ON f.hospcode=l.hospcode AND f.pid=l.pid AND f.ld_foot=l.DATE_SERV 
SET f.foot=l.foot;

UPDATE t_chronicfu f INNER JOIN (
	SELECT hospcode , pid ,max(date_serv) date_serv 
	FROM tmp_chronicfu WHERE retina in(1,2,3,4) 
	GROUP BY hospcode,PID
) l ON f.hospcode=l.hospcode AND f.pid=l.pid
SET f.ld_retina=l.date_serv;

UPDATE t_chronicfu f INNER JOIN tmp_chronicfu l ON f.hospcode=l.hospcode AND f.pid=l.pid AND f.ld_retina=l.DATE_SERV 
SET f.retina=l.retina;


DROP TABLES IF EXISTS t_dmht;
CREATE TABLE IF NOT EXISTS t_dmht (
		id int(15) NOT NULL AUTO_INCREMENT
		,hospcode VARCHAR(5) DEFAULT NULL 
		,pid VARCHAR(15)  DEFAULT NULL 
		,vhid VARCHAR(8) DEFAULT NULL 
		,typearea VARCHAR(1) DEFAULT NULL 
		,cid VARCHAR(13) NOT NULL
		,birth date
		,age_y INT(3) DEFAULT 0
		,groupcode1560 VARCHAR(100) DEFAULT NULL 
		,groupname1560 VARCHAR(100) DEFAULT NULL 
		,sex VARCHAR(1) DEFAULT NULL 
		,nation VARCHAR(3) DEFAULT NULL 
		,source_tb VARCHAR(255) DEFAULT NULL 
		,mix_dx VARCHAR(255) DEFAULT NULL 	
		,t_mix_dx VARCHAR(255) DEFAULT NULL 	
		,type_dx VARCHAR(2) DEFAULT NULL 
		,date_dx VARCHAR(255) DEFAULT NULL 
		,hosp_dx varchar(255) DEFAULT NULL 
		,minscl VARCHAR(5) DEFAULT NULL 
		,inscl VARCHAR(3) DEFAULT NULL 
		,ld_hba1c date  DEFAULT NULL 
		,rs_hba1c VARCHAR(10)  DEFAULT NULL
		,ih_hba1c  VARCHAR(5)  DEFAULT NULL
		,ld_fpg1 date DEFAULT NULL 
		,rs_fpg1 VARCHAR(10)  DEFAULT NULL 
		,ih_fpg1  VARCHAR(5)  DEFAULT NULL
		,ld_fpg2 date DEFAULT NULL 
		,rs_fpg2 VARCHAR(10)  DEFAULT NULL 
		,ih_fpg2  VARCHAR(5)  DEFAULT NULL
		,ld_fpg3 date DEFAULT NULL 
		,rs_fpg3 VARCHAR(10)  DEFAULT NULL 
		,ih_fpg3  VARCHAR(5)  DEFAULT NULL
		,ld_creatinine date DEFAULT NULL 
		,rs_creatinine VARCHAR(10)  DEFAULT NULL 
		,ih_creatinine VARCHAR(5)  DEFAULT NULL
		,ld_lipid date DEFAULT NULL 
		,rs_lipid VARCHAR(10)  DEFAULT NULL 
		,ih_lipid VARCHAR(5)  DEFAULT NULL
		,ld_foot date DEFAULT NULL 
		,rs_foot VARCHAR(10)  DEFAULT NULL
		,ih_foot VARCHAR(5)  DEFAULT NULL 
		,ld_retina date DEFAULT NULL 
		,rs_retina VARCHAR(10)  DEFAULT NULL 
		,ih_retina VARCHAR(5)  DEFAULT NULL 
		,ld_bp1 date DEFAULT NULL 
		,ih_bp1 VARCHAR(5)  DEFAULT NULL 
		,rs_bps1 VARCHAR(10)  DEFAULT NULL 
		,rs_bpd1 VARCHAR(10)  DEFAULT NULL 
		,ld_bp2 date  DEFAULT NULL 
		,ih_bp2 VARCHAR(5)  DEFAULT NULL 
		,rs_bps2 VARCHAR(10)  DEFAULT NULL 
		,rs_bpd2 VARCHAR(10)  DEFAULT NULL 
		,`complication_dm` varchar(20) DEFAULT '0',
  `complication_ht` varchar(20) DEFAULT '0',
  `control_dm` int(1) DEFAULT '0',
  `control_ht` int(1) DEFAULT '0',
  `bmi` decimal(10,2) DEFAULT '0',
  `obes` int(1) DEFAULT '0',
  `height` smallint(6) DEFAULT '0',
  `weight` mediumint(9) DEFAULT '0',
	`waist_cm`  smallint(6) NULL DEFAULT 0 ,
	PRIMARY KEY (cid)
	,KEY (cid)
  ,KEY (id)
	,KEY (type_dx)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO t_dmht(
	hospcode,vhid,typearea,cid,birth,age_y,groupcode1560,groupname1560,sex,nation,minscl,inscl,source_tb,hosp_dx,mix_dx,t_mix_dx,date_dx
)
(
	SELECT SQL_BIG_RESULT 
			p.check_hosp,p.check_vhid,p.check_typearea,p.cid,p.birth,p.age_y,a.groupcode1560,a.groupname1560,p.sex,p.nation
			,p.maininscl,p.inscl
			,GROUP_CONCAT(c.source_tb ORDER BY c.date_dx ) source_tb
			,GROUP_CONCAT(c.hosp_dx ORDER BY c.date_dx ) hosp_dx
			,GROUP_CONCAT(c.diagcode ORDER BY c.date_dx  ) diagcode
			,GROUP_CONCAT(DISTINCT  substr(c.diagcode,1,1) ORDER BY SUBSTR(c.diagcode,1,1)  ) 
			,GROUP_CONCAT(c.date_dx  ORDER BY c.date_dx ) date_dx
FROM
(SELECT * FROM t_chronic 
WHERE  (SUBSTR(UPPER(diagcode),1,3) BETWEEN  'E10' and 'E14'  OR 	SUBSTR(UPPER(diagcode),1,3) BETWEEN  'I10' and 'I15')  
GROUP BY concat(cid,'-',diagcode) ) c 
INNER JOIN t_person_cid  p ON c.cid = p.cid
LEFT JOIN cage a ON	 p.age_y=a.age
WHERE p.nation IN(99)  AND p.DISCHARGE  IN(9)
GROUP BY p.cid
);

/*update pid*/
UPDATE t_dmht d,t_person_cid p  SET d.pid=p.pid WHERE d.cid=p.cid AND d.hospcode=p.hospcode;

/*up_mixdiag*/
UPDATE t_dmht 
	SET type_dx = if(t_mix_dx ='I' ,'01'  
							,if(t_mix_dx ='E' ,'02'
							,if(t_mix_dx ='E,I','03',NULL)));


/*up_hba1c*/
UPDATE IGNORE t_dmht d INNER JOIN 
(SELECT cid,MAX(date_serv) date_serv FROM  tmp_labfu WHERE labtest IN(5) GROUP BY cid) l ON d.cid=l.cid 
SET d.ld_hba1c =l.date_serv;

UPDATE IGNORE t_dmht d INNER JOIN tmp_labfu l ON d.cid=l.cid  AND d.ld_hba1c =l.date_serv
SET d.rs_hba1c =l.labresult ,d.ih_hba1c=l.HOSPCODE
WHERE l.labtest IN(5);


/*up_fpg1*/
UPDATE t_dmht d ,
								(SELECT l.cid,l.HOSPCODE,l.DATE_SERV,l.LABRESULT 
								FROM tmp_labfu l
								WHERE l.labtest in(1,3) 
								    AND l.DATE_SERV =
								(SELECT l1.DATE_SERV FROM tmp_labfu l1 WHERE l1.labtest in(1,3) AND l1.cid=l.cid GROUP BY l1.cid,l1.DATE_SERV ORDER BY l1.date_serv desc LIMIT 0,1)
								GROUP BY cid) as t
		SET ld_fpg1 =t.DATE_SERV,rs_fpg1 =t.LABRESULT ,ih_fpg1=t.hospcode
WHERE
		d.cid=t.cid ;

/*up_fpg2*/
UPDATE t_dmht d ,
								(SELECT l.cid,l.DATE_SERV,l.LABRESULT,l.HOSPCODE
								FROM tmp_labfu l
								WHERE l.labtest in(1,3) 
								    AND l.DATE_SERV =
								(SELECT l1.DATE_SERV FROM tmp_labfu l1 WHERE l1.labtest in(1,3) AND l1.cid=l.cid GROUP BY l1.cid,l1.DATE_SERV ORDER BY l1.date_serv desc LIMIT 1,1)
								GROUP BY cid) as t
		SET ld_fpg2 =t.DATE_SERV,rs_fpg2 =t.LABRESULT ,ih_fpg2=t.hospcode
WHERE
		d.cid=t.cid ;

/*up_fpg3*/
UPDATE t_dmht d ,
								(SELECT l.cid,l.DATE_SERV,l.LABRESULT,l.HOSPCODE
								FROM tmp_labfu l
								WHERE l.labtest in(1,3) 
								    AND l.DATE_SERV =
								(SELECT l1.DATE_SERV FROM tmp_labfu l1 WHERE l1.labtest in(1,3) AND l1.cid=l.cid GROUP BY l1.cid,l1.DATE_SERV ORDER BY l1.date_serv desc LIMIT 2,1)
								GROUP BY cid) as t
		SET ld_fpg3 =t.DATE_SERV,rs_fpg3 =t.LABRESULT,ih_fpg3=t.hospcode
WHERE
		d.cid=t.cid ;
/*Creatinine*/ 
UPDATE t_dmht d ,	
								(SELECT l.cid,l.DATE_SERV,l.LABRESULT,l.HOSPCODE
								FROM tmp_labfu l
								WHERE l.labtest in(11,13) 
								    AND l.DATE_SERV =
								(SELECT l1.DATE_SERV FROM tmp_labfu l1 WHERE l1.labtest in(11,13) AND l1.cid=l.cid GROUP BY l1.cid,l1.DATE_SERV ORDER BY l1.date_serv desc LIMIT 0,1)
								GROUP BY cid) as t
		SET ld_creatinine =t.DATE_SERV,rs_creatinine =t.LABRESULT,ih_creatinine=t.hospcode 
WHERE
		d.cid=t.cid ;

/*lipid TotalCholesterol*/
UPDATE t_dmht d ,	
								(SELECT l.cid,l.DATE_SERV,l.LABRESULT,l.HOSPCODE 
								FROM tmp_labfu l
								WHERE l.labtest in(7) 
								    AND l.DATE_SERV =
								(SELECT l1.DATE_SERV FROM tmp_labfu l1 WHERE l1.labtest in(7) AND l1.cid=l.cid GROUP BY l1.cid,l1.DATE_SERV ORDER BY l1.date_serv desc LIMIT 0,1)
								GROUP BY cid) as t
		SET ld_lipid =t.DATE_SERV,rs_lipid =t.LABRESULT ,ih_lipid=t.hospcode 
WHERE
		d.cid=t.cid ;

/*foot*/
UPDATE t_dmht d ,	
								(SELECT c.cid,c.DATE_SERV,c.FOOT,c.HOSPCODE
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV =
								(SELECT c1.DATE_SERV FROM tmp_chronicfu c1 WHERE c1.cid=c.cid and c1.foot in(1,3) GROUP BY c1.cid,c1.DATE_SERV ORDER BY c1.date_serv desc LIMIT 0,1)
								GROUP BY cid) as t
		SET ld_foot =t.DATE_SERV,rs_foot =t.FOOT,ih_foot=t.hospcode
WHERE
		d.cid=t.cid ;

/*retina*/ 
UPDATE t_dmht d ,	
								(SELECT c.cid,c.DATE_SERV,c.RETINA,c.HOSPCODE
								FROM tmp_chronicfu c
								WHERE c.RETINA in(1,2,3,4)  AND c.DATE_SERV =
								(SELECT c1.DATE_SERV FROM tmp_chronicfu c1 WHERE c1.cid=c.cid and c1.RETINA in(1,2,3,4) GROUP BY c1.cid,c1.DATE_SERV ORDER BY c1.date_serv desc LIMIT 0,1)
								GROUP BY cid) as t
		SET ld_retina =t.DATE_SERV,rs_retina =t.RETINA ,ih_retina=t.hospcode
WHERE
		d.cid=t.cid ;

/*last_bp1*/ 
UPDATE t_dmht d ,	
								(SELECT c.cid,c.DATE_SERV,c.SBP,c.DBP,c.HOSPCODE
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV =
								(SELECT c1.DATE_SERV FROM tmp_chronicfu c1 WHERE c1.cid=c.cid and c1.SBP >0 AND c1.DBP>0  GROUP BY c1.cid,c1.DATE_SERV ORDER BY c1.date_serv desc LIMIT 0,1)
								GROUP BY cid) as t
		SET ld_bp1 =t.DATE_SERV,rs_bps1 =t.SBP,rs_bpd1 =t.DBP,ih_bp1=t.hospcode
WHERE
		d.cid=t.cid ;

/*last_bp2*/
UPDATE t_dmht d ,	
								(SELECT c.cid,c.DATE_SERV,c.SBP,c.DBP,c.HOSPCODE
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV =
								(SELECT c1.DATE_SERV FROM tmp_chronicfu c1 WHERE c1.cid=c.cid and c1.SBP >0 AND c1.DBP>0 GROUP BY c1.cid,c1.DATE_SERV ORDER BY c1.date_serv desc LIMIT 1,1)
								GROUP BY cid) as t
		SET ld_bp2 =t.DATE_SERV,rs_bps2 =t.SBP,rs_bpd2 =t.DBP,ih_bp2=t.hospcode
WHERE
		d.cid=t.cid ;

/*ภาวะแทรกซ้อนทางตา*/
UPDATE t_dmht t , (
					SELECT 
							cid
					FROM
					tmp_chronic_opd 
					WHERE diagcode in('E103','E113','E123','E133','E143','H360','H280')
)  d SET complication_dm='1' WHERE t.cid=d.cid AND d.cid is not null AND t.type_dx in(2,3);
/*ไต*/
UPDATE t_dmht t , (
					SELECT 
							cid
					FROM
					tmp_chronic_opd 
					WHERE diagcode in('E102','E112','E122','E132','E142','N083')
)  d SET complication_dm='2' WHERE t.cid=d.cid AND d.cid is not null AND t.type_dx in(2,3);

/*เท้า*/
UPDATE t_dmht t , (
					SELECT 
							cid
					FROM
					tmp_chronic_opd 
					WHERE diagcode in('E104','E114','E124','E134','E144','I792','E105','E115','E125','E135','E145' )
)  d SET complication_dm='3' WHERE t.cid=d.cid AND d.cid is not null AND t.type_dx in(2,3);

/*หลายอย่าง*/
UPDATE t_dmht t , (
					SELECT 
							cid
					FROM
					tmp_chronic_opd 
					WHERE diagcode in('E107','E117','E127','E137','E147')
)  d SET complication_dm='4' WHERE t.cid=d.cid AND d.cid is not null AND t.type_dx in(2,3);
/*ภาวะนำ้ตาลตำ่*/
UPDATE t_dmht t , (
					SELECT 
							cid
					FROM
					tmp_chronic_opd 
					WHERE diagcode in('E16')
)  d SET complication_dm='5' WHERE t.cid=d.cid AND d.cid is not null AND t.type_dx in(2,3);

UPDATE t_dmht t , (
					SELECT 
							cid
					FROM
					tmp_chronic_opd 
					WHERE diagcode in('E131')
)  d SET complication_dm='6' WHERE t.cid=d.cid AND d.cid is not null AND t.type_dx in(2,3);
/*หัวใจ*/
UPDATE t_dmht t , (
					SELECT 
							cid
					FROM
					tmp_chronic_opd 
					WHERE diagcode in('I110','I119')
)  d SET complication_ht='1' WHERE t.cid=d.cid AND d.cid is not null AND t.type_dx in(1,3);
/*ไต*/
UPDATE t_dmht t , (
					SELECT 
							cid
					FROM
					tmp_chronic_opd 
					WHERE diagcode in('I120','I129')
)  d SET complication_ht='2' WHERE t.cid=d.cid AND d.cid is not null AND t.type_dx in(1,3);

/*ไตหัวใจ*/
UPDATE t_dmht t , (
					SELECT 
							cid
					FROM
					tmp_chronic_opd 
					WHERE diagcode in('I130','I131','I132','I139')
)  d SET complication_ht='3' WHERE t.cid=d.cid AND d.cid is not null AND t.type_dx in(1,3);

/*w,h*/
UPDATE t_dmht t , (
				SELECT
				*
				FROM
				(SELECT 
							cid,weight,height,WAIST_CM
					FROM
					tmp_chronicfu
					WHERE  weight is not null  and height is not null
					ORDER BY DATE_SERV DESC
					) pre
					GROUP BY cid
)  d SET t.weight=d.weight ,t.height=d.height,t.waist_cm=d.waist_cm  WHERE t.cid=d.cid AND d.cid is not null ;

/*up control dm 1 ok 0 not ok*/
UPDATE t_dmht SET control_dm='1' WHERE type_dx in(2,3) AND 
			(rs_hba1c BETWEEN 0.1  AND 6.99)	AND ld_hba1c BETWEEN @start_d2 AND @end_d	;
/*bp control*/
UPDATE t_dmht SET control_ht ='1'	 WHERE 		
type_dx in(1,3) AND (rs_bps1  > 50 AND rs_bps1 <= 139) AND (rs_bps2 > 50 AND rs_bps2 <=139 )
AND (rs_bpd1 > 50 AND rs_bpd1 <= 89) AND (rs_bpd2 > 50 AND rs_bpd2 <= 89) AND ld_bp1 BETWEEN @start_d2 AND @end_d ;

UPDATE t_dmht SET bmi=round(WEIGHT/((HEIGHT/100)*(HEIGHT/100)),2) ;


UPDATE t_dmht SET obes =1 WHERE
(sex='1' AND round(WAIST_CM)>90) OR (sex='2' AND round(WAIST_CM)>80)
OR bmi>=25;

 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.2056429;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:109;a:5:{i:0;s:36:"DROP PROCEDURE IF EXISTS t_ncdscreen";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.2056429;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:110;a:5:{i:0;s:36:"DROP PROCEDURE IF EXISTS t_ncdscreen";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.283644;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:112;a:5:{i:0;s:7505:"CREATE PROCEDURE t_ncdscreen()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '14';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-2,'1001');
SET	@start_d1:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
SET @end_d1:=concat(@b_year-1,'0930');

DROP TABLES IF EXISTS tmp_ncdscreen;
CREATE TABLE IF NOT EXISTS tmp_ncdscreen (error_code varchar(255) DEFAULT NULL, KEY(cid)) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		n.*,p.CID,null as error_code
FROM
	ncdscreen n left join t_person_db p ON n.HOSPCODE=p.HOSPCODE AND n.PID=p.PID
WHERE	DATE_SERV BETWEEN @start_d AND @end_d
);

UPDATE tmp_ncdscreen 
SET error_code =IF(ISNULL(error_code),'NCD0001',CONCAT(error_code,',','NCD0001') ) 
WHERE  DATE_SERV BETWEEN @start_d1 AND @end_d AND HEIGHT NOT BETWEEN 90 AND 250;

UPDATE tmp_ncdscreen 
SET error_code =IF(ISNULL(error_code),'NCD0002',CONCAT(error_code,',','NCD0002') ) 
WHERE  DATE_SERV BETWEEN @start_d1 AND @end_d AND WEIGHT NOT BETWEEN  10 AND 300;

UPDATE tmp_ncdscreen n INNER JOIN person p  ON n.HOSPCODE=p.HOSPCODE AND n.PID=p.PID
SET error_code =IF(ISNULL(n.error_code),'NCD0003',CONCAT(n.error_code,',','NCD0003') ) 
WHERE  DATE_SERV BETWEEN @start_d1 AND @end_d AND n.DATE_SERV < p.BIRTH;


DROP TABLES IF EXISTS t_ncdscreen;
CREATE TABLE IF NOT EXISTS t_ncdscreen (
KEY(hospcode),KEY(check_hosp),KEY(cid),KEY(date_serv),KEY(bslevel),KEY(bstest),KEY(sbp_1,dbp_1),KEY(sbp_2,dbp_2),KEY(sex)
) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
ns.*,c.groupcode3560,c.groupname3560
FROM
		(SELECT
				n.*,age(n.DATE_SERV,p.BIRTH,'y') as age_y,p.check_hosp,p.check_typearea,p.TYPEAREA,p.check_vhid,p.vhid,p.nation,p.sex
		FROM
			tmp_ncdscreen n LEFT JOIN t_person_cid p ON n.cid=p.cid
		WHERE	DATE_SERV BETWEEN @start_d AND @end_d
		) as ns,cage c 
WHERE ns.age_y=c.age
);
/*เบาหวาน*/
DROP  TABLE IF EXISTS  t_person_dm_screen;
CREATE  TABLE IF NOT EXISTS t_person_dm_screen (
  hospcode varchar(5) DEFAULT NULL,
  areacode varchar(8) DEFAULT NULL,
  cid varchar(13) NOT NULL DEFAULT '',
  pid varchar(15) DEFAULT NULL,
	age_y int(3) DEFAULT '0',
	typearea  varchar(1) DEFAULT NULL,
	date_screen date ,
  bslevel int(6)  DEFAULT '0',
	bstest  varchar(1) DEFAULT NULL,
  ill varchar(1) default null,
  risk varchar(1) default null,
PRIMARY KEY (cid),
	KEY (hospcode),
	KEY (areacode),
	KEY (pid),
	KEY (typearea),
  KEY (risk)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO t_person_dm_screen(
  hospcode,areacode,cid,pid,age_y,typearea
)
SELECT pe.check_hosp HOSPCODE
								,pe.check_vhid as areacode
								,pe.CID,pe.PID,pe.age_y,pe.check_typearea TYPEAREA
				FROM
						t_person_cid pe
				WHERE
						substr(pe.check_vhid,1,2)=@prov_c
						AND pe.nation=99 
						AND pe.DISCHARGE=9 
						AND pe.age_y>=15 
						AND pe.check_typearea in(1,3)
						AND cid not in(SELECT cid FROM t_dmht WHERE type_dx in(2,3))
ORDER BY check_hosp,check_typearea
;

UPDATE t_person_dm_screen p,t_ncdscreen n SET p.date_screen=n.DATE_SERV  ,p.bslevel=n.BSLEVEL, p.bstest=n.bstest
WHERE p.cid=n.cid AND n.DATE_SERV BETWEEN @start_d1 AND @end_d;

update t_person_dm_screen p inner join t_dmht d 
SET ill='1'
WHERE p.cid=d.cid AND d.type_dx in(2,3);

update t_person_dm_screen SET risk='0'
where (((bstest in('1','3') OR bstest is null) AND bslevel >= 70 AND bslevel <= 100 ) OR
(bstest in('2','4') AND bslevel >= 70 AND bslevel <= 140));

update t_person_dm_screen SET risk='1'
where (((bstest in('1','3') OR bstest is null) AND bslevel > 100 AND bslevel <= 125 ) OR 
(bstest in('2','4')   AND bslevel > 140 AND bslevel <= 200 ));

update t_person_dm_screen SET risk='2'
where (((bstest in('1','3') OR bstest is null) AND bslevel > 125) OR
(bstest in('2','4') AND bslevel > 200));


/*ความดัน*/
DROP  TABLE IF EXISTS  t_person_ht_screen;
CREATE  TABLE IF NOT EXISTS t_person_ht_screen (
  hospcode varchar(5) DEFAULT NULL,
  areacode varchar(8) DEFAULT NULL,
  cid varchar(13) NOT NULL DEFAULT '',
  pid varchar(15) DEFAULT NULL,
	age_y int(3) DEFAULT '0',
	typearea  varchar(1) DEFAULT NULL,
	date_screen date ,
  sbp_1 int(3)  DEFAULT 0,
	dbp_1 int(3)  DEFAULT 0,
	sbp_2 int(3)  DEFAULT 0,
	dbp_2 int(3)  DEFAULT 0,
  ill varchar(1) default null,
	sbp int(3)  DEFAULT 0,
	dbp int(3)  DEFAULT 0,
	risk varchar(1) default null,
PRIMARY KEY (cid),
	KEY (hospcode),
	KEY (areacode),
	KEY (pid),
	KEY (typearea),
	KEY (risk)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO t_person_ht_screen(
  hospcode,areacode,cid,pid,age_y,typearea
)
SELECT pe.check_hosp HOSPCODE
								,pe.check_vhid as areacode
								,pe.CID,pe.PID,pe.age_y,pe.check_typearea TYPEAREA
				FROM
						t_person_cid pe
				WHERE
						substr(pe.check_vhid,1,2)=@prov_c
						AND pe.nation=99 
						AND pe.DISCHARGE=9 
						AND pe.age_y>=15 
						AND pe.check_typearea in(1,3)
						AND cid not in(SELECT cid FROM t_dmht WHERE type_dx in(1,3))
ORDER BY check_hosp,check_typearea
;

UPDATE t_person_ht_screen p,t_ncdscreen n SET p.date_screen=n.DATE_SERV  ,p.sbp_1=n.SBP_1,p.sbp_2=n.SBP_2,p.dbp_1=n.dBP_1,p.dbp_2=n.dBP_2
WHERE p.cid=n.cid AND n.DATE_SERV BETWEEN @start_d1 AND @end_d;

update t_person_ht_screen p inner join t_dmht d 
SET ill='1'
WHERE p.cid=d.cid AND d.type_dx in(1,3);

update t_person_ht_screen SET sbp=sbp_2 ,dbp=dbp_2
WHERE sbp_2 >0  ; 

update t_person_ht_screen SET sbp=sbp_1 ,dbp=dbp_1
WHERE sbp =0 and sbp_1 >0  ;

update t_person_ht_screen SET risk='0'
where (sbp  > 50 AND sbp < 120) and  (dbp > 50 AND dbp < 80);

update t_person_ht_screen SET risk='1'
where (sbp BETWEEN 120 AND 139) OR (dbp BETWEEN 80 AND 89);

update t_person_ht_screen SET risk='2'
where sbp >=140 OR dbp >=90;

DROP TABLE IF EXISTS tmp_ncdscreen_last;
CREATE TABLE IF NOT EXISTS tmp_ncdscreen_last(
  `HOSPCODE` varchar(5) DEFAULT NULL,
  `PID` varchar(15)  DEFAULT NULL,
  `SEQ` varchar(16) DEFAULT NULL,
  `DATE_SERV` date NOT NULL,
  `BSLEVEL` int(6) DEFAULT NULL,
  `BSTEST` char(1) DEFAULT NULL,
  `SCREENPLACE` varchar(5) DEFAULT NULL,
  `CID` varchar(13) DEFAULT NULL,
  `age_y` int(3) DEFAULT NULL,
  `pcheck_hosp` varchar(5) DEFAULT '',
  `pcheck_typearea` varchar(1) DEFAULT '',
  `pcheck_vhid` varchar(8) DEFAULT NULL,
  `nation` varchar(3) DEFAULT '',
  `sex` varchar(1) DEFAULT '',
	diagcode VARCHAR(8) DEFAULT NULL,
	diag_hospcode VARCHAR(5) DEFAULT NULL,
	diag_date date DEFAULT NULL,
PRIMARY KEY (cid),
	KEY (hospcode),
	KEY (pcheck_hosp),
	KEY (pcheck_typearea),
	KEY (pcheck_vhid)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;
INSERT INTO tmp_ncdscreen_last (cid,date_serv)
(SELECT cid,max(DATE_SERV) DATE_SERV  
FROM t_ncdscreen WHERE DATE_SERV BETWEEN @start_d AND @end_d1 AND BSLEVEL > 70
GROUP BY cid
);

UPDATE tmp_ncdscreen_last l INNER JOIN t_ncdscreen n ON l.cid=n.cid AND l.date_serv=n.date_serv
SET l.HOSPCODE = n.HOSPCODE ,l.PID=n.PID ,l.SEQ =n.SEQ ,l.BSLEVEL=n.BSLEVEL ,l.BSTEST=.n.BSTEST
,l.SCREENPLACE=n.SCREENPLACE,l.age_y=n.age_y ,l.pcheck_hosp =n.check_hosp , l.pcheck_typearea=n.check_typearea 
,l.pcheck_vhid = n.check_vhid,l.nation=n.nation,l.sex=n.sex;

UPDATE tmp_ncdscreen_last l INNER JOIN  t_chronic  c ON l.cid=c.cid
SET l.diagcode=c.diagcode , l.diag_hospcode=IFNULL(c.hosp_dx,c.input_hosp) ,l.diag_date=c.date_dx
WHERE  SUBSTR(c.diagcode ,1,3) BETWEEN 'E10' AND 'E14' AND c.date_dx>l.date_serv;
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.283644;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:113;a:5:{i:0;s:7505:"CREATE PROCEDURE t_ncdscreen()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '14';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-2,'1001');
SET	@start_d1:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
SET @end_d1:=concat(@b_year-1,'0930');

DROP TABLES IF EXISTS tmp_ncdscreen;
CREATE TABLE IF NOT EXISTS tmp_ncdscreen (error_code varchar(255) DEFAULT NULL, KEY(cid)) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		n.*,p.CID,null as error_code
FROM
	ncdscreen n left join t_person_db p ON n.HOSPCODE=p.HOSPCODE AND n.PID=p.PID
WHERE	DATE_SERV BETWEEN @start_d AND @end_d
);

UPDATE tmp_ncdscreen 
SET error_code =IF(ISNULL(error_code),'NCD0001',CONCAT(error_code,',','NCD0001') ) 
WHERE  DATE_SERV BETWEEN @start_d1 AND @end_d AND HEIGHT NOT BETWEEN 90 AND 250;

UPDATE tmp_ncdscreen 
SET error_code =IF(ISNULL(error_code),'NCD0002',CONCAT(error_code,',','NCD0002') ) 
WHERE  DATE_SERV BETWEEN @start_d1 AND @end_d AND WEIGHT NOT BETWEEN  10 AND 300;

UPDATE tmp_ncdscreen n INNER JOIN person p  ON n.HOSPCODE=p.HOSPCODE AND n.PID=p.PID
SET error_code =IF(ISNULL(n.error_code),'NCD0003',CONCAT(n.error_code,',','NCD0003') ) 
WHERE  DATE_SERV BETWEEN @start_d1 AND @end_d AND n.DATE_SERV < p.BIRTH;


DROP TABLES IF EXISTS t_ncdscreen;
CREATE TABLE IF NOT EXISTS t_ncdscreen (
KEY(hospcode),KEY(check_hosp),KEY(cid),KEY(date_serv),KEY(bslevel),KEY(bstest),KEY(sbp_1,dbp_1),KEY(sbp_2,dbp_2),KEY(sex)
) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
ns.*,c.groupcode3560,c.groupname3560
FROM
		(SELECT
				n.*,age(n.DATE_SERV,p.BIRTH,'y') as age_y,p.check_hosp,p.check_typearea,p.TYPEAREA,p.check_vhid,p.vhid,p.nation,p.sex
		FROM
			tmp_ncdscreen n LEFT JOIN t_person_cid p ON n.cid=p.cid
		WHERE	DATE_SERV BETWEEN @start_d AND @end_d
		) as ns,cage c 
WHERE ns.age_y=c.age
);
/*เบาหวาน*/
DROP  TABLE IF EXISTS  t_person_dm_screen;
CREATE  TABLE IF NOT EXISTS t_person_dm_screen (
  hospcode varchar(5) DEFAULT NULL,
  areacode varchar(8) DEFAULT NULL,
  cid varchar(13) NOT NULL DEFAULT '',
  pid varchar(15) DEFAULT NULL,
	age_y int(3) DEFAULT '0',
	typearea  varchar(1) DEFAULT NULL,
	date_screen date ,
  bslevel int(6)  DEFAULT '0',
	bstest  varchar(1) DEFAULT NULL,
  ill varchar(1) default null,
  risk varchar(1) default null,
PRIMARY KEY (cid),
	KEY (hospcode),
	KEY (areacode),
	KEY (pid),
	KEY (typearea),
  KEY (risk)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO t_person_dm_screen(
  hospcode,areacode,cid,pid,age_y,typearea
)
SELECT pe.check_hosp HOSPCODE
								,pe.check_vhid as areacode
								,pe.CID,pe.PID,pe.age_y,pe.check_typearea TYPEAREA
				FROM
						t_person_cid pe
				WHERE
						substr(pe.check_vhid,1,2)=@prov_c
						AND pe.nation=99 
						AND pe.DISCHARGE=9 
						AND pe.age_y>=15 
						AND pe.check_typearea in(1,3)
						AND cid not in(SELECT cid FROM t_dmht WHERE type_dx in(2,3))
ORDER BY check_hosp,check_typearea
;

UPDATE t_person_dm_screen p,t_ncdscreen n SET p.date_screen=n.DATE_SERV  ,p.bslevel=n.BSLEVEL, p.bstest=n.bstest
WHERE p.cid=n.cid AND n.DATE_SERV BETWEEN @start_d1 AND @end_d;

update t_person_dm_screen p inner join t_dmht d 
SET ill='1'
WHERE p.cid=d.cid AND d.type_dx in(2,3);

update t_person_dm_screen SET risk='0'
where (((bstest in('1','3') OR bstest is null) AND bslevel >= 70 AND bslevel <= 100 ) OR
(bstest in('2','4') AND bslevel >= 70 AND bslevel <= 140));

update t_person_dm_screen SET risk='1'
where (((bstest in('1','3') OR bstest is null) AND bslevel > 100 AND bslevel <= 125 ) OR 
(bstest in('2','4')   AND bslevel > 140 AND bslevel <= 200 ));

update t_person_dm_screen SET risk='2'
where (((bstest in('1','3') OR bstest is null) AND bslevel > 125) OR
(bstest in('2','4') AND bslevel > 200));


/*ความดัน*/
DROP  TABLE IF EXISTS  t_person_ht_screen;
CREATE  TABLE IF NOT EXISTS t_person_ht_screen (
  hospcode varchar(5) DEFAULT NULL,
  areacode varchar(8) DEFAULT NULL,
  cid varchar(13) NOT NULL DEFAULT '',
  pid varchar(15) DEFAULT NULL,
	age_y int(3) DEFAULT '0',
	typearea  varchar(1) DEFAULT NULL,
	date_screen date ,
  sbp_1 int(3)  DEFAULT 0,
	dbp_1 int(3)  DEFAULT 0,
	sbp_2 int(3)  DEFAULT 0,
	dbp_2 int(3)  DEFAULT 0,
  ill varchar(1) default null,
	sbp int(3)  DEFAULT 0,
	dbp int(3)  DEFAULT 0,
	risk varchar(1) default null,
PRIMARY KEY (cid),
	KEY (hospcode),
	KEY (areacode),
	KEY (pid),
	KEY (typearea),
	KEY (risk)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO t_person_ht_screen(
  hospcode,areacode,cid,pid,age_y,typearea
)
SELECT pe.check_hosp HOSPCODE
								,pe.check_vhid as areacode
								,pe.CID,pe.PID,pe.age_y,pe.check_typearea TYPEAREA
				FROM
						t_person_cid pe
				WHERE
						substr(pe.check_vhid,1,2)=@prov_c
						AND pe.nation=99 
						AND pe.DISCHARGE=9 
						AND pe.age_y>=15 
						AND pe.check_typearea in(1,3)
						AND cid not in(SELECT cid FROM t_dmht WHERE type_dx in(1,3))
ORDER BY check_hosp,check_typearea
;

UPDATE t_person_ht_screen p,t_ncdscreen n SET p.date_screen=n.DATE_SERV  ,p.sbp_1=n.SBP_1,p.sbp_2=n.SBP_2,p.dbp_1=n.dBP_1,p.dbp_2=n.dBP_2
WHERE p.cid=n.cid AND n.DATE_SERV BETWEEN @start_d1 AND @end_d;

update t_person_ht_screen p inner join t_dmht d 
SET ill='1'
WHERE p.cid=d.cid AND d.type_dx in(1,3);

update t_person_ht_screen SET sbp=sbp_2 ,dbp=dbp_2
WHERE sbp_2 >0  ; 

update t_person_ht_screen SET sbp=sbp_1 ,dbp=dbp_1
WHERE sbp =0 and sbp_1 >0  ;

update t_person_ht_screen SET risk='0'
where (sbp  > 50 AND sbp < 120) and  (dbp > 50 AND dbp < 80);

update t_person_ht_screen SET risk='1'
where (sbp BETWEEN 120 AND 139) OR (dbp BETWEEN 80 AND 89);

update t_person_ht_screen SET risk='2'
where sbp >=140 OR dbp >=90;

DROP TABLE IF EXISTS tmp_ncdscreen_last;
CREATE TABLE IF NOT EXISTS tmp_ncdscreen_last(
  `HOSPCODE` varchar(5) DEFAULT NULL,
  `PID` varchar(15)  DEFAULT NULL,
  `SEQ` varchar(16) DEFAULT NULL,
  `DATE_SERV` date NOT NULL,
  `BSLEVEL` int(6) DEFAULT NULL,
  `BSTEST` char(1) DEFAULT NULL,
  `SCREENPLACE` varchar(5) DEFAULT NULL,
  `CID` varchar(13) DEFAULT NULL,
  `age_y` int(3) DEFAULT NULL,
  `pcheck_hosp` varchar(5) DEFAULT '',
  `pcheck_typearea` varchar(1) DEFAULT '',
  `pcheck_vhid` varchar(8) DEFAULT NULL,
  `nation` varchar(3) DEFAULT '',
  `sex` varchar(1) DEFAULT '',
	diagcode VARCHAR(8) DEFAULT NULL,
	diag_hospcode VARCHAR(5) DEFAULT NULL,
	diag_date date DEFAULT NULL,
PRIMARY KEY (cid),
	KEY (hospcode),
	KEY (pcheck_hosp),
	KEY (pcheck_typearea),
	KEY (pcheck_vhid)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;
INSERT INTO tmp_ncdscreen_last (cid,date_serv)
(SELECT cid,max(DATE_SERV) DATE_SERV  
FROM t_ncdscreen WHERE DATE_SERV BETWEEN @start_d AND @end_d1 AND BSLEVEL > 70
GROUP BY cid
);

UPDATE tmp_ncdscreen_last l INNER JOIN t_ncdscreen n ON l.cid=n.cid AND l.date_serv=n.date_serv
SET l.HOSPCODE = n.HOSPCODE ,l.PID=n.PID ,l.SEQ =n.SEQ ,l.BSLEVEL=n.BSLEVEL ,l.BSTEST=.n.BSTEST
,l.SCREENPLACE=n.SCREENPLACE,l.age_y=n.age_y ,l.pcheck_hosp =n.check_hosp , l.pcheck_typearea=n.check_typearea 
,l.pcheck_vhid = n.check_vhid,l.nation=n.nation,l.sex=n.sex;

UPDATE tmp_ncdscreen_last l INNER JOIN  t_chronic  c ON l.cid=c.cid
SET l.diagcode=c.diagcode , l.diag_hospcode=IFNULL(c.hosp_dx,c.input_hosp) ,l.diag_date=c.date_dx
WHERE  SUBSTR(c.diagcode ,1,3) BETWEEN 'E10' AND 'E14' AND c.date_dx>l.date_serv;
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.3304441;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:115;a:5:{i:0;s:34:"DROP PROCEDURE IF EXISTS t_service";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.3304441;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:116;a:5:{i:0;s:34:"DROP PROCEDURE IF EXISTS t_service";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.392844;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:118;a:5:{i:0;s:954:"CREATE PROCEDURE t_service()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '15';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');


DROP TABLES IF EXISTS tmp_service;
CREATE TABLE IF NOT EXISTS tmp_service (
KEY(cid),KEY(hospcode),KEY(pid),KEY(seq),
KEY(date_serv),KEY(instype),KEY(typein),
KEY(typeout),KEY(CAUSEIN),KEY(hospcode,pid),
KEY(hospcode,pid,seq),KEY(hospcode,pid,instype),
KEY(hospcode,pid,typein)
) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		s.hospcode,s.pid,s.seq,s.date_serv,s.intime,s.location,s.instype,s.main,s.typein,s.referinhosp
		,s.causein,s.servplace,s.sbp,s.dbp,s.typeout,s.referouthosp,s.causeout,s.cost,s.price
,s.payprice,s.actualpay,p.CID,p.nation
FROM
	service s LEFT JOIN t_person_db p ON s.HOSPCODE=p.HOSPCODE AND s.PID=p.PID
WHERE	DATE_SERV BETWEEN @start_d AND @end_d
);
#DROP TABLES IF EXISTS tmp_diag_ipd;

 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.392844;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:119;a:5:{i:0;s:954:"CREATE PROCEDURE t_service()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '15';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');


DROP TABLES IF EXISTS tmp_service;
CREATE TABLE IF NOT EXISTS tmp_service (
KEY(cid),KEY(hospcode),KEY(pid),KEY(seq),
KEY(date_serv),KEY(instype),KEY(typein),
KEY(typeout),KEY(CAUSEIN),KEY(hospcode,pid),
KEY(hospcode,pid,seq),KEY(hospcode,pid,instype),
KEY(hospcode,pid,typein)
) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		s.hospcode,s.pid,s.seq,s.date_serv,s.intime,s.location,s.instype,s.main,s.typein,s.referinhosp
		,s.causein,s.servplace,s.sbp,s.dbp,s.typeout,s.referouthosp,s.causeout,s.cost,s.price
,s.payprice,s.actualpay,p.CID,p.nation
FROM
	service s LEFT JOIN t_person_db p ON s.HOSPCODE=p.HOSPCODE AND s.PID=p.PID
WHERE	DATE_SERV BETWEEN @start_d AND @end_d
);
#DROP TABLES IF EXISTS tmp_diag_ipd;

 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.4396441;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:121;a:5:{i:0;s:36:"DROP PROCEDURE IF EXISTS t_admission";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.4396441;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:122;a:5:{i:0;s:36:"DROP PROCEDURE IF EXISTS t_admission";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.502044;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:124;a:5:{i:0;s:936:"CREATE PROCEDURE t_admission()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '16';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'0701');
SET @end_d:=concat(@b_year,'0930');


DROP TABLES IF EXISTS tmp_admission;
CREATE TABLE IF NOT EXISTS tmp_admission (
KEY (cid),
KEY (hospcode),
KEY (pid),
KEY (datetime_admit),
KEY (datetime_disch),
KEY (instype),
KEY (TYPEIN),
KEY (REFERINHOSP),
KEY (DISCHSTATUS),
KEY (DISCHTYPE),
KEY (REFEROUTHOSP),
KEY (an),
KEY (hospcode,an)
) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		a.*,IF(DATEDIFF(DATETIME_DISCH,DATETIME_ADMIT)!=0,DATEDIFF(DATETIME_DISCH,DATETIME_ADMIT),1) as day,p.CID,p.nation
FROM
	admission a LEFT JOIN t_person_db p ON a.HOSPCODE=p.HOSPCODE AND a.PID=p.PID
WHERE	(DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d') BETWEEN @start_d AND @end_d OR DATE_FORMAT(DATETIME_DISCH,'%Y%m%d') BETWEEN @start_d AND @end_d)
);



 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.502044;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:125;a:5:{i:0;s:936:"CREATE PROCEDURE t_admission()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '16';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'0701');
SET @end_d:=concat(@b_year,'0930');


DROP TABLES IF EXISTS tmp_admission;
CREATE TABLE IF NOT EXISTS tmp_admission (
KEY (cid),
KEY (hospcode),
KEY (pid),
KEY (datetime_admit),
KEY (datetime_disch),
KEY (instype),
KEY (TYPEIN),
KEY (REFERINHOSP),
KEY (DISCHSTATUS),
KEY (DISCHTYPE),
KEY (REFEROUTHOSP),
KEY (an),
KEY (hospcode,an)
) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		a.*,IF(DATEDIFF(DATETIME_DISCH,DATETIME_ADMIT)!=0,DATEDIFF(DATETIME_DISCH,DATETIME_ADMIT),1) as day,p.CID,p.nation
FROM
	admission a LEFT JOIN t_person_db p ON a.HOSPCODE=p.HOSPCODE AND a.PID=p.PID
WHERE	(DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d') BETWEEN @start_d AND @end_d OR DATE_FORMAT(DATETIME_DISCH,'%Y%m%d') BETWEEN @start_d AND @end_d)
);



 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.5644441;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:127;a:5:{i:0;s:32:"DROP PROCEDURE IF EXISTS t_death";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.5644441;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:128;a:5:{i:0;s:32:"DROP PROCEDURE IF EXISTS t_death";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.6580441;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:130;a:5:{i:0;s:4295:"CREATE PROCEDURE t_death()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '17';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLES IF EXISTS tmp_death;
CREATE TABLE IF NOT EXISTS tmp_death (
error_code varchar(255) DEFAULT null,
correct_cause varchar(9)  DEFAULT null,
KEY(cid),
KEY(hospcode),
KEY(pid),
KEY(DDEATH),
KEY(CDEATH)
) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		a.HOSPCODE,a.PID,a.HOSPDEATH,a.AN,a.SEQ,a.ddeath,a.cdeath_a,a.CDEATH_B,a.CDEATH_C,a.CDEATH_D,a.ODISEASE,a.cdeath,a.PREGDEATH,a.pdeath,a.PROVIDER,a.d_update,p.CID,p.nation,age(a.ddeath,p.birth,'y') as age_y,p.sex,p.check_hosp,p.check_vhid,p.check_typearea,p.vhid,p.typearea,null as error_code,null as correct_cause
FROM
	death a LEFT JOIN t_person_db p ON a.HOSPCODE=p.HOSPCODE AND a.PID=p.PID 
WHERE	DDEATH BETWEEN @start_d AND @end_d 
		);

UPDATE tmp_death d INNER JOIN person p ON d.HOSPCODE=p.HOSPCODE AND d.PID=p.PID
SET error_code =IF(ISNULL(error_code),'DE0001',CONCAT(error_code,',','DE0001') ) 
WHERE   p.DISCHARGE NOT IN(1) ;

UPDATE tmp_death d INNER JOIN chronic c ON d.HOSPCODE=c.HOSPCODE AND d.PID=c.PID
SET error_code =IF(ISNULL(error_code),'DE0002',CONCAT(error_code,',','DE0002') ) 
WHERE  c.date_disch is null  AND c.typedisch NOT IN(2)   ;

UPDATE tmp_death d INNER JOIN ncdscreen n ON d.HOSPCODE=n.HOSPCODE AND d.PID=n.PID
SET error_code =IF(ISNULL(error_code),'DE0003',CONCAT(error_code,',','DE0003') ) 
WHERE    n.DATE_SERV > d.DDEATH ;

UPDATE tmp_death d INNER JOIN tmp_service s ON d.HOSPCODE=s.HOSPCODE AND d.PID=s.PID
SET error_code =IF(ISNULL(error_code),'DE0004',CONCAT(error_code,',','DE0004') ) 
WHERE    s.DATE_SERV > d.DDEATH ;

UPDATE tmp_death d  SET correct_cause = cdeath_a;
UPDATE tmp_death d  SET correct_cause = cdeath_b
WHERE  cdeath_b is not null AND TRIM(cdeath_b) !='';
UPDATE tmp_death d  SET correct_cause = cdeath_c
WHERE  cdeath_c is not null AND TRIM(cdeath_c) !='';
UPDATE tmp_death d  SET correct_cause = cdeath_d
WHERE  cdeath_d is not null AND TRIM(cdeath_d) !='';

UPDATE tmp_death d 
SET error_code =IF(ISNULL(error_code),'DE0005',CONCAT(error_code,',','DE0005') ) 
WHERE  trim(correct_cause) != trim(cdeath);

UPDATE tmp_death d 
SET error_code =IF(ISNULL(error_code),'DE0006',CONCAT(error_code,',','DE0006') ) 
WHERE  SUBSTR(d.CDEATH,1,3) BETWEEN 'R00' AND 'R99' OR
					SUBSTR(d.CDEATH,1,3) BETWEEN 'Y10' AND 'Y34' OR
					SUBSTR(d.CDEATH,1,3) IN('C80','C97','I46','I50') OR
					SUBSTR(d.CDEATH,1,4) IN('I490','I709') OR
					d.CDEATH IN('Y872','I472','I514','I515','I516','I519');

UPDATE tmp_death d 
SET error_code =IF(ISNULL(error_code),'DE0008',CONCAT(error_code,',','DE0008') ) 
WHERE  pdeath IN(1) AND (LENGTH(TRIM(HOSPDEATH)) != 5 OR HOSPDEATH IS NULL) ;


DROP TABLES IF EXISTS t_death;
CREATE TABLE IF NOT EXISTS t_death (
KEY(cid),
KEY(hospcode),
KEY(pid),
KEY(DDEATH),
KEY(CDEATH)
) ENGINE=MyISAM  AS(
SELECT
		a.*,g.groupcode1560,groupcode3560,groupcode190,g.groupname1560,groupname3560,groupname190
FROM
	tmp_death a,cage g
WHERE	 a.age_y=g.age AND check_typearea in(1,3)
);


DROP TABLES IF EXISTS t_death_sex_age1560;
CREATE TABLE IF NOT EXISTS t_death_sex_age1560 (
  `id` varchar(32) not null default '',
	`year` varchar(4) not null default '',
	`hospcode` varchar(5) not null default '',
  `areacode` varchar(8) not null default '',
  `sex` varchar(15) not null default '',
  `diagcode` varchar(9) not null default '',
  `groupcode` int(2) not null default 0,
  `groupname` varchar(255) not null default '',
  `result` int(9) not null default 0,
  KEY `hospcode` (`hospcode`),
  KEY `areacode` (`areacode`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

DELETE FROM t_death_sex_age1560 WHERE year= year(now())+543;

INSERT IGNORE INTO t_death_sex_age1560
(
	SELECT
	@id ,(@b_year+543) as year,ag.hospcode,ag.vhid,ag.sex,cdeath,ag.groupcode,ag.groupname,ag.result
	FROM
			(SELECT
			check_hosp as hospcode,check_vhid as vhid,sex,cdeath ,groupcode1560 as groupcode ,groupname1560 as groupname,COUNT(*) as result
			FROM
			t_death
			GROUP BY
			check_hosp,check_vhid,sex,cdeath,groupcode1560
			ORDER BY check_hosp,check_vhid
			) as ag
);


 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.6580441;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:131;a:5:{i:0;s:4295:"CREATE PROCEDURE t_death()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '17';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLES IF EXISTS tmp_death;
CREATE TABLE IF NOT EXISTS tmp_death (
error_code varchar(255) DEFAULT null,
correct_cause varchar(9)  DEFAULT null,
KEY(cid),
KEY(hospcode),
KEY(pid),
KEY(DDEATH),
KEY(CDEATH)
) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		a.HOSPCODE,a.PID,a.HOSPDEATH,a.AN,a.SEQ,a.ddeath,a.cdeath_a,a.CDEATH_B,a.CDEATH_C,a.CDEATH_D,a.ODISEASE,a.cdeath,a.PREGDEATH,a.pdeath,a.PROVIDER,a.d_update,p.CID,p.nation,age(a.ddeath,p.birth,'y') as age_y,p.sex,p.check_hosp,p.check_vhid,p.check_typearea,p.vhid,p.typearea,null as error_code,null as correct_cause
FROM
	death a LEFT JOIN t_person_db p ON a.HOSPCODE=p.HOSPCODE AND a.PID=p.PID 
WHERE	DDEATH BETWEEN @start_d AND @end_d 
		);

UPDATE tmp_death d INNER JOIN person p ON d.HOSPCODE=p.HOSPCODE AND d.PID=p.PID
SET error_code =IF(ISNULL(error_code),'DE0001',CONCAT(error_code,',','DE0001') ) 
WHERE   p.DISCHARGE NOT IN(1) ;

UPDATE tmp_death d INNER JOIN chronic c ON d.HOSPCODE=c.HOSPCODE AND d.PID=c.PID
SET error_code =IF(ISNULL(error_code),'DE0002',CONCAT(error_code,',','DE0002') ) 
WHERE  c.date_disch is null  AND c.typedisch NOT IN(2)   ;

UPDATE tmp_death d INNER JOIN ncdscreen n ON d.HOSPCODE=n.HOSPCODE AND d.PID=n.PID
SET error_code =IF(ISNULL(error_code),'DE0003',CONCAT(error_code,',','DE0003') ) 
WHERE    n.DATE_SERV > d.DDEATH ;

UPDATE tmp_death d INNER JOIN tmp_service s ON d.HOSPCODE=s.HOSPCODE AND d.PID=s.PID
SET error_code =IF(ISNULL(error_code),'DE0004',CONCAT(error_code,',','DE0004') ) 
WHERE    s.DATE_SERV > d.DDEATH ;

UPDATE tmp_death d  SET correct_cause = cdeath_a;
UPDATE tmp_death d  SET correct_cause = cdeath_b
WHERE  cdeath_b is not null AND TRIM(cdeath_b) !='';
UPDATE tmp_death d  SET correct_cause = cdeath_c
WHERE  cdeath_c is not null AND TRIM(cdeath_c) !='';
UPDATE tmp_death d  SET correct_cause = cdeath_d
WHERE  cdeath_d is not null AND TRIM(cdeath_d) !='';

UPDATE tmp_death d 
SET error_code =IF(ISNULL(error_code),'DE0005',CONCAT(error_code,',','DE0005') ) 
WHERE  trim(correct_cause) != trim(cdeath);

UPDATE tmp_death d 
SET error_code =IF(ISNULL(error_code),'DE0006',CONCAT(error_code,',','DE0006') ) 
WHERE  SUBSTR(d.CDEATH,1,3) BETWEEN 'R00' AND 'R99' OR
					SUBSTR(d.CDEATH,1,3) BETWEEN 'Y10' AND 'Y34' OR
					SUBSTR(d.CDEATH,1,3) IN('C80','C97','I46','I50') OR
					SUBSTR(d.CDEATH,1,4) IN('I490','I709') OR
					d.CDEATH IN('Y872','I472','I514','I515','I516','I519');

UPDATE tmp_death d 
SET error_code =IF(ISNULL(error_code),'DE0008',CONCAT(error_code,',','DE0008') ) 
WHERE  pdeath IN(1) AND (LENGTH(TRIM(HOSPDEATH)) != 5 OR HOSPDEATH IS NULL) ;


DROP TABLES IF EXISTS t_death;
CREATE TABLE IF NOT EXISTS t_death (
KEY(cid),
KEY(hospcode),
KEY(pid),
KEY(DDEATH),
KEY(CDEATH)
) ENGINE=MyISAM  AS(
SELECT
		a.*,g.groupcode1560,groupcode3560,groupcode190,g.groupname1560,groupname3560,groupname190
FROM
	tmp_death a,cage g
WHERE	 a.age_y=g.age AND check_typearea in(1,3)
);


DROP TABLES IF EXISTS t_death_sex_age1560;
CREATE TABLE IF NOT EXISTS t_death_sex_age1560 (
  `id` varchar(32) not null default '',
	`year` varchar(4) not null default '',
	`hospcode` varchar(5) not null default '',
  `areacode` varchar(8) not null default '',
  `sex` varchar(15) not null default '',
  `diagcode` varchar(9) not null default '',
  `groupcode` int(2) not null default 0,
  `groupname` varchar(255) not null default '',
  `result` int(9) not null default 0,
  KEY `hospcode` (`hospcode`),
  KEY `areacode` (`areacode`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

DELETE FROM t_death_sex_age1560 WHERE year= year(now())+543;

INSERT IGNORE INTO t_death_sex_age1560
(
	SELECT
	@id ,(@b_year+543) as year,ag.hospcode,ag.vhid,ag.sex,cdeath,ag.groupcode,ag.groupname,ag.result
	FROM
			(SELECT
			check_hosp as hospcode,check_vhid as vhid,sex,cdeath ,groupcode1560 as groupcode ,groupname1560 as groupname,COUNT(*) as result
			FROM
			t_death
			GROUP BY
			check_hosp,check_vhid,sex,cdeath,groupcode1560
			ORDER BY check_hosp,check_vhid
			) as ag
);


 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.704844;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:133;a:5:{i:0;s:34:"DROP PROCEDURE IF EXISTS t_newborn";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.704844;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:134;a:5:{i:0;s:34:"DROP PROCEDURE IF EXISTS t_newborn";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.798444;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:136;a:5:{i:0;s:519:"CREATE PROCEDURE t_newborn()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '18';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS t_newborn;
CREATE TABLE IF NOT EXISTS t_newborn (
PRIMARY KEY (CID,BDATE)
) ENGINE=MyISAM  IGNORE AS
SELECT n.* FROM tmp_newborn n INNER JOIN chospital h ON n.hospcode=h.hoscode WHERE  h.hostype in(5,6,7,11);

INSERT IGNORE t_newborn (SELECT * FROM tmp_newborn);



 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.798444;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:137;a:5:{i:0;s:519:"CREATE PROCEDURE t_newborn()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '18';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS t_newborn;
CREATE TABLE IF NOT EXISTS t_newborn (
PRIMARY KEY (CID,BDATE)
) ENGINE=MyISAM  IGNORE AS
SELECT n.* FROM tmp_newborn n INNER JOIN chospital h ON n.hospcode=h.hoscode WHERE  h.hostype in(5,6,7,11);

INSERT IGNORE t_newborn (SELECT * FROM tmp_newborn);



 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.8608451;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:139;a:5:{i:0;s:31:"DROP PROCEDURE IF EXISTS t_card";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.8608451;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:140;a:5:{i:0;s:31:"DROP PROCEDURE IF EXISTS t_card";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.907645;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:142;a:5:{i:0;s:675:"CREATE PROCEDURE t_card()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '19';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
DROP TABLES IF EXISTS tmp_card;
CREATE TABLE IF NOT EXISTS tmp_card (
KEY(cid),
KEY(hospcode),
KEY(pid)
) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
	c.*
FROM
		(SELECT 
				a.*,p.CID,p.nation,p.sex,p.check_hosp,p.check_vhid,p.check_typearea,p.vhid,p.typearea
		FROM
			card a LEFT JOIN t_person_db p ON a.HOSPCODE=p.HOSPCODE AND a.PID=p.PID 
		WHERE	 p.check_typearea in(1,3)
		ORDER BY cid ASC,d_update DESC
		) as c
GROUP BY cid
);



 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.907645;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:143;a:5:{i:0;s:675:"CREATE PROCEDURE t_card()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '19';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
DROP TABLES IF EXISTS tmp_card;
CREATE TABLE IF NOT EXISTS tmp_card (
KEY(cid),
KEY(hospcode),
KEY(pid)
) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
	c.*
FROM
		(SELECT 
				a.*,p.CID,p.nation,p.sex,p.check_hosp,p.check_vhid,p.check_typearea,p.vhid,p.typearea
		FROM
			card a LEFT JOIN t_person_db p ON a.HOSPCODE=p.HOSPCODE AND a.PID=p.PID 
		WHERE	 p.check_typearea in(1,3)
		ORDER BY cid ASC,d_update DESC
		) as c
GROUP BY cid
);



 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.9544449;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:145;a:5:{i:0;s:35:"DROP PROCEDURE IF EXISTS t_drug_opd";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988051.9544449;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:146;a:5:{i:0;s:35:"DROP PROCEDURE IF EXISTS t_drug_opd";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.001245;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:148;a:5:{i:0;s:3018:"CREATE PROCEDURE t_drug_opd()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '20';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLES IF EXISTS tmp_drug_opd;
CREATE TABLE IF NOT EXISTS tmp_drug_opd (
  `HOSPCODE` varchar(5) NOT NULL,
  `PID` varchar(15) NOT NULL,
  `SEQ` varchar(16) NOT NULL,
  `DATE_SERV` date NOT NULL,
  `CLINIC` varchar(5) NOT NULL,
  `DIDSTD` varchar(24) NOT NULL,
  `DNAME` varchar(255) DEFAULT NULL,
  `AMOUNT` int(12) DEFAULT NULL,
  `UNIT` varchar(3) DEFAULT NULL,
  `UNIT_PACKING` varchar(20) DEFAULT NULL,
  `DRUGPRICE` decimal(11,2) DEFAULT NULL,
  `DRUGCOST` decimal(11,2) DEFAULT NULL,
  `PROVIDER` varchar(15) DEFAULT NULL,
  `D_UPDATE` datetime NOT NULL,
  `CID` varchar(13) DEFAULT NULL,
	`nation` varchar(4) DEFAULT NULL,
	`sex` varchar(1) DEFAULT NULL,
	`check_hosp` varchar(5) DEFAULT NULL,
	`check_vhid` varchar(8) DEFAULT NULL,
	`check_typearea` varchar(1) DEFAULT NULL,
	`vhid` varchar(8) DEFAULT NULL,
	`typearea` varchar(1) DEFAULT NULL,
	`drug_name` varchar(255) DEFAULT NULL,
	`drug_type` varchar(50) DEFAULT NULL,
	`ed` varchar(1) DEFAULT NULL,
	`age_y` int(3) DEFAULT 0,
	`instype` varchar(4) DEFAULT NULL,
	`instypegroup` int(3) DEFAULT 0,
	`groupcode060` int(3) DEFAULT 0,
  PRIMARY KEY (`HOSPCODE`,`PID`,`SEQ`,`DIDSTD`),
  KEY `idx1` (`HOSPCODE`,`PID`),
  KEY `idx2` (`DATE_SERV`),
  KEY `idx3` (`HOSPCODE`),
  KEY `idx4` (`DIDSTD`),
  KEY `idx5` (`HOSPCODE`,`PROVIDER`),
  KEY `idx6` (`cid`),
  KEY `idx7` (`seq`),
  KEY `idx8` (`pid`),
  KEY `idx9` (`check_typearea`),
  KEY `idx10` (`check_vhid`),
  KEY `idx11` (`drug_type`),
  KEY `idx13` (`ed`),
	KEY `idx14` (`age_y`),
	KEY `idx15` (`instype`),
	KEY `idx16` (`instypegroup`),
	KEY `idx17` (`groupcode060`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO tmp_drug_opd
(
	HOSPCODE,PID,SEQ,DATE_SERV,CLINIC,DIDSTD,DNAME,AMOUNT,UNIT,UNIT_PACKING,DRUGPRICE,DRUGCOST,PROVIDER,D_UPDATE
	,CID,nation,sex,check_hosp,check_vhid,check_typearea,vhid,typearea,age_y
)
(
SELECT SQL_BIG_RESULT 
		a.HOSPCODE,a.PID,a.SEQ,a.DATE_SERV,a.CLINIC,a.DIDSTD,a.DNAME,a.amount,a.unit,a.unit_packing,a.drugprice,a.drugcost,a.PROVIDER,a.D_UPDATE,pe.CID,pe.nation,pe.sex,pe.check_hosp,pe.check_vhid,pe.check_typearea,pe.vhid,pe.typearea,age(a.date_serv,pe.birth,'y')
FROM
	drug_opd a LEFT JOIN t_person_db pe ON  a.HOSPCODE=pe.HOSPCODE AND a.PID=pe.PID
WHERE	date_serv BETWEEN @start_d AND @end_d 
);

UPDATE tmp_drug_opd d,cage ag SET d.groupcode060=ag.groupcode060
WHERE d.age_y=ag.age; 

UPDATE tmp_drug_opd d,tmp_service s SET d.instype=s.instype
WHERE d.HOSPCODE=s.HOSPCODE AND d.PID=s.PID AND d.seq=s.seq ; 

UPDATE tmp_drug_opd d,cinstype_new i SET d.instypegroup=i.instypegroup
WHERE d.instype=i.instypecode; 


UPDATE tmp_drug_opd d,cdrug_planthai p SET d.drug_name=p.drug_name ,d.drug_type=p.drug_type ,d.ed=p.ed
WHERE d.didstd=p.DIDSTD; 


 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.016845;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:149;a:5:{i:0;s:3018:"CREATE PROCEDURE t_drug_opd()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '20';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLES IF EXISTS tmp_drug_opd;
CREATE TABLE IF NOT EXISTS tmp_drug_opd (
  `HOSPCODE` varchar(5) NOT NULL,
  `PID` varchar(15) NOT NULL,
  `SEQ` varchar(16) NOT NULL,
  `DATE_SERV` date NOT NULL,
  `CLINIC` varchar(5) NOT NULL,
  `DIDSTD` varchar(24) NOT NULL,
  `DNAME` varchar(255) DEFAULT NULL,
  `AMOUNT` int(12) DEFAULT NULL,
  `UNIT` varchar(3) DEFAULT NULL,
  `UNIT_PACKING` varchar(20) DEFAULT NULL,
  `DRUGPRICE` decimal(11,2) DEFAULT NULL,
  `DRUGCOST` decimal(11,2) DEFAULT NULL,
  `PROVIDER` varchar(15) DEFAULT NULL,
  `D_UPDATE` datetime NOT NULL,
  `CID` varchar(13) DEFAULT NULL,
	`nation` varchar(4) DEFAULT NULL,
	`sex` varchar(1) DEFAULT NULL,
	`check_hosp` varchar(5) DEFAULT NULL,
	`check_vhid` varchar(8) DEFAULT NULL,
	`check_typearea` varchar(1) DEFAULT NULL,
	`vhid` varchar(8) DEFAULT NULL,
	`typearea` varchar(1) DEFAULT NULL,
	`drug_name` varchar(255) DEFAULT NULL,
	`drug_type` varchar(50) DEFAULT NULL,
	`ed` varchar(1) DEFAULT NULL,
	`age_y` int(3) DEFAULT 0,
	`instype` varchar(4) DEFAULT NULL,
	`instypegroup` int(3) DEFAULT 0,
	`groupcode060` int(3) DEFAULT 0,
  PRIMARY KEY (`HOSPCODE`,`PID`,`SEQ`,`DIDSTD`),
  KEY `idx1` (`HOSPCODE`,`PID`),
  KEY `idx2` (`DATE_SERV`),
  KEY `idx3` (`HOSPCODE`),
  KEY `idx4` (`DIDSTD`),
  KEY `idx5` (`HOSPCODE`,`PROVIDER`),
  KEY `idx6` (`cid`),
  KEY `idx7` (`seq`),
  KEY `idx8` (`pid`),
  KEY `idx9` (`check_typearea`),
  KEY `idx10` (`check_vhid`),
  KEY `idx11` (`drug_type`),
  KEY `idx13` (`ed`),
	KEY `idx14` (`age_y`),
	KEY `idx15` (`instype`),
	KEY `idx16` (`instypegroup`),
	KEY `idx17` (`groupcode060`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO tmp_drug_opd
(
	HOSPCODE,PID,SEQ,DATE_SERV,CLINIC,DIDSTD,DNAME,AMOUNT,UNIT,UNIT_PACKING,DRUGPRICE,DRUGCOST,PROVIDER,D_UPDATE
	,CID,nation,sex,check_hosp,check_vhid,check_typearea,vhid,typearea,age_y
)
(
SELECT SQL_BIG_RESULT 
		a.HOSPCODE,a.PID,a.SEQ,a.DATE_SERV,a.CLINIC,a.DIDSTD,a.DNAME,a.amount,a.unit,a.unit_packing,a.drugprice,a.drugcost,a.PROVIDER,a.D_UPDATE,pe.CID,pe.nation,pe.sex,pe.check_hosp,pe.check_vhid,pe.check_typearea,pe.vhid,pe.typearea,age(a.date_serv,pe.birth,'y')
FROM
	drug_opd a LEFT JOIN t_person_db pe ON  a.HOSPCODE=pe.HOSPCODE AND a.PID=pe.PID
WHERE	date_serv BETWEEN @start_d AND @end_d 
);

UPDATE tmp_drug_opd d,cage ag SET d.groupcode060=ag.groupcode060
WHERE d.age_y=ag.age; 

UPDATE tmp_drug_opd d,tmp_service s SET d.instype=s.instype
WHERE d.HOSPCODE=s.HOSPCODE AND d.PID=s.PID AND d.seq=s.seq ; 

UPDATE tmp_drug_opd d,cinstype_new i SET d.instypegroup=i.instypegroup
WHERE d.instype=i.instypecode; 


UPDATE tmp_drug_opd d,cdrug_planthai p SET d.drug_name=p.drug_name ,d.drug_type=p.drug_type ,d.ed=p.ed
WHERE d.didstd=p.DIDSTD; 


 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.0636449;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:151;a:5:{i:0;s:35:"DROP PROCEDURE IF EXISTS t_planthai";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.0636449;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:152;a:5:{i:0;s:35:"DROP PROCEDURE IF EXISTS t_planthai";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.1270449;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:154;a:5:{i:0;s:4017:"CREATE PROCEDURE t_planthai()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '21';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLES IF EXISTS t_planthai_proced;
CREATE TABLE IF NOT EXISTS t_planthai_proced(
	`hospcode` varchar(5) NOT null,
  `pid` varchar(15) NOT null,
	`seq` varchar(16) NOT null,
	`date_serv` date NOT NULL,
	`procedcode` varchar(8) default null,
	`instype` varchar(4) default null,
	`instypegroup` varchar(2) default null,
	`tmtype` varchar(1)  default null,
	`servplace` varchar(1)  default null,
	`age_y` int(3)  default 0,
	`cid` varchar(13)  default null,
  KEY `hospcode` (`hospcode`),
  KEY `pid` (`pid`),
	KEY `cid` (`cid`),
  KEY `seq` (`seq`),
  KEY `date_serv` (`date_serv`),
	KEY `procedcode` (`procedcode`),
	KEY `instype` (`instype`),
	KEY `instypegroup` (`instypegroup`),
	KEY `tmtype` (`tmtype`),
	KEY `servplace` (`servplace`),
  KEY `HOSPCODE_PID` (`hospcode`,`pid`,`seq`)
)ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT INTO t_planthai_proced
(
		hospcode,pid,seq,date_serv,procedcode,tmtype
)
(
SELECT SQL_BIG_RESULT  p.hospcode,p.pid,p.seq,p.date_serv,PROCEDCODE,tmtype
FROM
		tmp_procedure_opd p 
		INNER JOIN cicd9ttm_planthai t ON p.PROCEDCODE= t.code
	WHERE
		t.code is not null
		AND p.date_serv BETWEEN @start_d AND @end_d 
);

INSERT INTO t_planthai_proced
(
		hospcode,pid,seq,date_serv,procedcode
)
(
SELECT SQL_BIG_RESULT  p.hospcode,p.pid,p.seq,p.date_serv,PROCEDCODE
FROM
		tmp_procedure_opd p 
WHERE
PROCEDCODE IN ('9991','9992','9335') 
AND p.date_serv BETWEEN @start_d AND @end_d 
);

UPDATE t_planthai_proced p,tmp_service s SET p.instype=s.instype,p.servplace=s.servplace
WHERE 
	s.hospcode = p.hospcode AND s.pid = p.pid AND s.seq = p.seq ;

UPDATE t_planthai_proced p,cinstype_new i SET p.instypegroup=i.instypegroup
WHERE 
	p.instype = i.instypecode ;

UPDATE t_planthai_proced p,t_person_db pe  SET p.age_y= age(p.date_serv,pe.BIRTH,'y'),p.cid=pe.cid
WHERE 
	p.hospcode=pe.hospcode AND p.pid=pe.pid  ;

/**************/

DROP TABLES IF EXISTS t_planthai_diag_proced;

CREATE TABLE IF NOT EXISTS t_planthai_diag_proced(
	`hospcode` varchar(5) NOT null,
  `pid` varchar(15) NOT null,
	`seq` varchar(16) NOT null,
	`date_serv` date NOT NULL,
	`diagcode` varchar(8) default null,
	`diagtype` varchar(1) default null,
	`procedcode` varchar(8) default null,
	`instype` varchar(4) default null,
	`instypegroup` varchar(2) default null,
	`diseasethai` varchar(255) default null,
	`tmtype` varchar(1)  default null,
	`servplace` varchar(1)  default null,
	`age_y` int(3)  default 0,
`cid` varchar(13)  default null,
  KEY `hospcode` (`hospcode`),
  KEY `pid` (`pid`),
KEY `cid` (`cid`),
  KEY `seq` (`seq`),
  KEY `date_serv` (`date_serv`),
	KEY `diagcode` (`diagcode`),
	KEY `diagtype` (`diagtype`),
	KEY `procedcode` (`procedcode`),
	KEY `instype` (`instype`),
	KEY `instypegroup` (`instypegroup`),
	KEY `tmtype` (`tmtype`),
	KEY `servplace` (`servplace`),
	KEY `age_y` (`age_y`),
  KEY `HOSPCODE_PID` (`hospcode`,`pid`,`seq`)
)ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT INTO t_planthai_diag_proced
(
		hospcode,pid,seq,date_serv,diagcode,diagtype,procedcode,tmtype,servplace,instype,instypegroup
)
(
		SELECT SQL_BIG_RESULT  a.hospcode,a.pid,a.seq,a.date_serv,a.diagcode,a.diagtype,p.PROCEDCODE,p.tmtype,p.servplace,p.instype,p.instypegroup
		FROM
			tmp_diag_opd a
			LEFT JOIN t_planthai_proced p ON a.hospcode=p.hospcode AND a.pid=p.pid AND a.seq=p.seq AND a.date_serv=p.date_serv
		WHERE	a.date_serv BETWEEN @start_d AND @end_d 
		AND SUBSTR(a.diagcode,1,1)='U'
);

UPDATE t_planthai_diag_proced p,cdisease d  SET p.diseasethai=d.diseasethai
WHERE 
	d.diagcode = p.diagcode  ;


UPDATE t_planthai_diag_proced p,t_person_db pe  SET p.age_y= age(p.date_serv,pe.BIRTH,'y'),p.cid=pe.cid
WHERE 
	p.hospcode=pe.hospcode AND p.pid=pe.pid  ;

 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.1270449;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:155;a:5:{i:0;s:4017:"CREATE PROCEDURE t_planthai()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '21';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLES IF EXISTS t_planthai_proced;
CREATE TABLE IF NOT EXISTS t_planthai_proced(
	`hospcode` varchar(5) NOT null,
  `pid` varchar(15) NOT null,
	`seq` varchar(16) NOT null,
	`date_serv` date NOT NULL,
	`procedcode` varchar(8) default null,
	`instype` varchar(4) default null,
	`instypegroup` varchar(2) default null,
	`tmtype` varchar(1)  default null,
	`servplace` varchar(1)  default null,
	`age_y` int(3)  default 0,
	`cid` varchar(13)  default null,
  KEY `hospcode` (`hospcode`),
  KEY `pid` (`pid`),
	KEY `cid` (`cid`),
  KEY `seq` (`seq`),
  KEY `date_serv` (`date_serv`),
	KEY `procedcode` (`procedcode`),
	KEY `instype` (`instype`),
	KEY `instypegroup` (`instypegroup`),
	KEY `tmtype` (`tmtype`),
	KEY `servplace` (`servplace`),
  KEY `HOSPCODE_PID` (`hospcode`,`pid`,`seq`)
)ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT INTO t_planthai_proced
(
		hospcode,pid,seq,date_serv,procedcode,tmtype
)
(
SELECT SQL_BIG_RESULT  p.hospcode,p.pid,p.seq,p.date_serv,PROCEDCODE,tmtype
FROM
		tmp_procedure_opd p 
		INNER JOIN cicd9ttm_planthai t ON p.PROCEDCODE= t.code
	WHERE
		t.code is not null
		AND p.date_serv BETWEEN @start_d AND @end_d 
);

INSERT INTO t_planthai_proced
(
		hospcode,pid,seq,date_serv,procedcode
)
(
SELECT SQL_BIG_RESULT  p.hospcode,p.pid,p.seq,p.date_serv,PROCEDCODE
FROM
		tmp_procedure_opd p 
WHERE
PROCEDCODE IN ('9991','9992','9335') 
AND p.date_serv BETWEEN @start_d AND @end_d 
);

UPDATE t_planthai_proced p,tmp_service s SET p.instype=s.instype,p.servplace=s.servplace
WHERE 
	s.hospcode = p.hospcode AND s.pid = p.pid AND s.seq = p.seq ;

UPDATE t_planthai_proced p,cinstype_new i SET p.instypegroup=i.instypegroup
WHERE 
	p.instype = i.instypecode ;

UPDATE t_planthai_proced p,t_person_db pe  SET p.age_y= age(p.date_serv,pe.BIRTH,'y'),p.cid=pe.cid
WHERE 
	p.hospcode=pe.hospcode AND p.pid=pe.pid  ;

/**************/

DROP TABLES IF EXISTS t_planthai_diag_proced;

CREATE TABLE IF NOT EXISTS t_planthai_diag_proced(
	`hospcode` varchar(5) NOT null,
  `pid` varchar(15) NOT null,
	`seq` varchar(16) NOT null,
	`date_serv` date NOT NULL,
	`diagcode` varchar(8) default null,
	`diagtype` varchar(1) default null,
	`procedcode` varchar(8) default null,
	`instype` varchar(4) default null,
	`instypegroup` varchar(2) default null,
	`diseasethai` varchar(255) default null,
	`tmtype` varchar(1)  default null,
	`servplace` varchar(1)  default null,
	`age_y` int(3)  default 0,
`cid` varchar(13)  default null,
  KEY `hospcode` (`hospcode`),
  KEY `pid` (`pid`),
KEY `cid` (`cid`),
  KEY `seq` (`seq`),
  KEY `date_serv` (`date_serv`),
	KEY `diagcode` (`diagcode`),
	KEY `diagtype` (`diagtype`),
	KEY `procedcode` (`procedcode`),
	KEY `instype` (`instype`),
	KEY `instypegroup` (`instypegroup`),
	KEY `tmtype` (`tmtype`),
	KEY `servplace` (`servplace`),
	KEY `age_y` (`age_y`),
  KEY `HOSPCODE_PID` (`hospcode`,`pid`,`seq`)
)ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT INTO t_planthai_diag_proced
(
		hospcode,pid,seq,date_serv,diagcode,diagtype,procedcode,tmtype,servplace,instype,instypegroup
)
(
		SELECT SQL_BIG_RESULT  a.hospcode,a.pid,a.seq,a.date_serv,a.diagcode,a.diagtype,p.PROCEDCODE,p.tmtype,p.servplace,p.instype,p.instypegroup
		FROM
			tmp_diag_opd a
			LEFT JOIN t_planthai_proced p ON a.hospcode=p.hospcode AND a.pid=p.pid AND a.seq=p.seq AND a.date_serv=p.date_serv
		WHERE	a.date_serv BETWEEN @start_d AND @end_d 
		AND SUBSTR(a.diagcode,1,1)='U'
);

UPDATE t_planthai_diag_proced p,cdisease d  SET p.diseasethai=d.diseasethai
WHERE 
	d.diagcode = p.diagcode  ;


UPDATE t_planthai_diag_proced p,t_person_db pe  SET p.age_y= age(p.date_serv,pe.BIRTH,'y'),p.cid=pe.cid
WHERE 
	p.hospcode=pe.hospcode AND p.pid=pe.pid  ;

 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.193445;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:157;a:5:{i:0;s:36:"DROP PROCEDURE IF EXISTS t_planthai1";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.195446;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:158;a:5:{i:0;s:36:"DROP PROCEDURE IF EXISTS t_planthai1";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.248647;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:160;a:5:{i:0;s:2120:"CREATE PROCEDURE t_planthai1()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '22';
SET	@send :=  IF((SELECT active FROM sys_report WHERE cat_id = @cat_id and id = @id )=1,0,2);
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS tmp_diag_no_z;
CREATE  TABLE IF NOT EXISTS  tmp_diag_no_z(index (hospcode,pid,seq)) ENGINE MyIsam
AS
(
SELECT hospcode,pid,seq FROM tmp_diag_opd 
WHERE  substr(diagcode ,1,1)  != 'Z' AND DATE_SERV BETWEEN @start_d AND @end_d 
GROUP BY hospcode,pid,seq
);

DROP TABLE IF EXISTS t_planthai1;
CREATE TABLE IF NOT EXISTS t_planthai1(
hospcode VARCHAR(5) NOT NULL,
pid VARCHAR(18) NOT NULL,
seq VARCHAR(18) NOT NULL,
date_serv date,
instypegroup INT(2) DEFAULT NULL,
planthai INT(1) DEFAULT NULL,
KEY hospcode (hospcode),
KEY pid (pid),
KEY seq (seq),
KEY date_serv (date_serv),
KEY planthai (planthai),
KEY instypegroup (instypegroup)

)ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT INTO t_planthai1
(
	HOSPCODE,PID,SEQ,DATE_SERV,instypegroup
)
(
SELECT SQL_BIG_RESULT s.HOSPCODE,s.PID,s.SEQ,s.DATE_SERV,i.instypegroup
FROM tmp_service s LEFT JOIN cinstype_new i ON s.instype = i.instypecode
INNER JOIN tmp_diag_no_z d ON s.hospcode=d.hospcode AND s.pid=d.pid AND s.seq=d.seq
WHERE s.DATE_SERV BETWEEN @start_d AND @end_d
);

UPDATE
	t_planthai1 p1,
	(
			SELECT SQL_BIG_RESULT 
			e3.*
			FROM
			(
			SELECT HOSPCODE,PID,SEQ,DATE_SERV,instypegroup
			FROM t_planthai_diag_proced 
			WHERE DATE_SERV BETWEEN @start_d AND @end_d
			AND LEFT(DIAGCODE,1) = 'U'

			UNION
			SELECT HOSPCODE,PID,SEQ,DATE_SERV,instypegroup 
			FROM tmp_drug_opd
			WHERE DATE_SERV BETWEEN @start_d AND @end_d
			AND LEFT(DIDSTD,2) IN ('41','42') 
			
			UNION
			SELECT HOSPCODE,PID,SEQ,DATE_SERV,instypegroup 
			FROM t_planthai_proced
			WHERE DATE_SERV BETWEEN @start_d AND @end_d
			) as e3
			GROUP BY HOSPCODE,PID,SEQ,DATE_SERV,instypegroup

	) p2
		SET planthai=1 
WHERE p1.hospcode=p2.hospcode AND p1.pid=p2.pid AND p1.seq=p2.seq;
	
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.248647;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:161;a:5:{i:0;s:2120:"CREATE PROCEDURE t_planthai1()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '22';
SET	@send :=  IF((SELECT active FROM sys_report WHERE cat_id = @cat_id and id = @id )=1,0,2);
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS tmp_diag_no_z;
CREATE  TABLE IF NOT EXISTS  tmp_diag_no_z(index (hospcode,pid,seq)) ENGINE MyIsam
AS
(
SELECT hospcode,pid,seq FROM tmp_diag_opd 
WHERE  substr(diagcode ,1,1)  != 'Z' AND DATE_SERV BETWEEN @start_d AND @end_d 
GROUP BY hospcode,pid,seq
);

DROP TABLE IF EXISTS t_planthai1;
CREATE TABLE IF NOT EXISTS t_planthai1(
hospcode VARCHAR(5) NOT NULL,
pid VARCHAR(18) NOT NULL,
seq VARCHAR(18) NOT NULL,
date_serv date,
instypegroup INT(2) DEFAULT NULL,
planthai INT(1) DEFAULT NULL,
KEY hospcode (hospcode),
KEY pid (pid),
KEY seq (seq),
KEY date_serv (date_serv),
KEY planthai (planthai),
KEY instypegroup (instypegroup)

)ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT INTO t_planthai1
(
	HOSPCODE,PID,SEQ,DATE_SERV,instypegroup
)
(
SELECT SQL_BIG_RESULT s.HOSPCODE,s.PID,s.SEQ,s.DATE_SERV,i.instypegroup
FROM tmp_service s LEFT JOIN cinstype_new i ON s.instype = i.instypecode
INNER JOIN tmp_diag_no_z d ON s.hospcode=d.hospcode AND s.pid=d.pid AND s.seq=d.seq
WHERE s.DATE_SERV BETWEEN @start_d AND @end_d
);

UPDATE
	t_planthai1 p1,
	(
			SELECT SQL_BIG_RESULT 
			e3.*
			FROM
			(
			SELECT HOSPCODE,PID,SEQ,DATE_SERV,instypegroup
			FROM t_planthai_diag_proced 
			WHERE DATE_SERV BETWEEN @start_d AND @end_d
			AND LEFT(DIAGCODE,1) = 'U'

			UNION
			SELECT HOSPCODE,PID,SEQ,DATE_SERV,instypegroup 
			FROM tmp_drug_opd
			WHERE DATE_SERV BETWEEN @start_d AND @end_d
			AND LEFT(DIDSTD,2) IN ('41','42') 
			
			UNION
			SELECT HOSPCODE,PID,SEQ,DATE_SERV,instypegroup 
			FROM t_planthai_proced
			WHERE DATE_SERV BETWEEN @start_d AND @end_d
			) as e3
			GROUP BY HOSPCODE,PID,SEQ,DATE_SERV,instypegroup

	) p2
		SET planthai=1 
WHERE p1.hospcode=p2.hospcode AND p1.pid=p2.pid AND p1.seq=p2.seq;
	
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.2954471;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:163;a:5:{i:0;s:31:"DROP PROCEDURE IF EXISTS t_cmi1";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.2954471;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:164;a:5:{i:0;s:31:"DROP PROCEDURE IF EXISTS t_cmi1";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.342247;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:166;a:5:{i:0;s:3727:"CREATE PROCEDURE t_cmi1()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '23';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLES IF EXISTS tmp_cmiadmission;
CREATE TABLE IF NOT EXISTS tmp_cmiadmission(
SELECT SQL_BIG_RESULT t.hospcode, t.drg, count(t.an) as cntan, sum(t.adjrw) as sumadj
, count(if(month(t.datetime_disch)=10 and t.ERROR=0,t.an,null)) as cntm10
, sum(if(month(t.datetime_disch)=10 and t.ERROR=0,t.adjrw,0)) as adjm10
, count(if(month(t.datetime_disch)=11 and t.ERROR=0,t.an,null)) as cntm11
, sum(if(month(t.datetime_disch)=11 and t.ERROR=0,t.adjrw,0)) as adjm11
, count(if(month(t.datetime_disch)=12 and t.ERROR=0,t.an,null)) as cntm12
, sum(if(month(t.datetime_disch)=12 and t.ERROR=0,t.adjrw,0)) as adjm12
, count(if(month(t.datetime_disch)=1 and t.ERROR=0,t.an,null)) as cntm01
, sum(if(month(t.datetime_disch)=1 and t.ERROR=0,t.adjrw,0)) as adjm01
, count(if(month(t.datetime_disch)=2 and t.ERROR=0,t.an,null)) as cntm02
, sum(if(month(t.datetime_disch)=2 and t.ERROR=0,t.adjrw,0)) as adjm02
, count(if(month(t.datetime_disch)=3 and t.ERROR=0,t.an,null)) as cntm03
, sum(if(month(t.datetime_disch)=3 and t.ERROR=0,t.adjrw,0)) as adjm03
, count(if(month(t.datetime_disch)=4 and t.ERROR=0,t.an,null)) as cntm04
, sum(if(month(t.datetime_disch)=4 and t.ERROR=0,t.adjrw,0)) as adjm04
, count(if(month(t.datetime_disch)=5 and t.ERROR=0,t.an,null)) as cntm05
, sum(if(month(t.datetime_disch)=5 and t.ERROR=0,t.adjrw,0)) as adjm05
, count(if(month(t.datetime_disch)=6 and t.ERROR=0,t.an,null)) as cntm06
, sum(if(month(t.datetime_disch)=6 and t.ERROR=0,t.adjrw,0)) as adjm06
, count(if(month(t.datetime_disch)=7 and t.ERROR=0,t.an,null)) as cntm07
, sum(if(month(t.datetime_disch)=7 and t.ERROR=0,t.adjrw,0)) as adjm07
, count(if(month(t.datetime_disch)=8 and t.ERROR=0,t.an,null)) as cntm08
, sum(if(month(t.datetime_disch)=8 and t.ERROR=0, t.adjrw,0)) as adjm08
, count(if(month(t.datetime_disch)=9 and t.ERROR=0,t.an,null)) as cntm09
, sum(if(month(t.datetime_disch)=9 and t.ERROR=0,t.adjrw,0)) as adjm09
, count(if(t.error=0, t.HOSPCODE,null)) as cntok
FROM admission t
WHERE date_format(t.datetime_disch,'%Y%m%d') BETWEEN @start_d and @end_d
GROUP BY t.hospcode, t.drg
);
ALTER TABLE tmp_cmiadmission ADD KEY(hospcode);

DROP TABLES IF EXISTS tmp_ccmihosp;
CREATE TABLE IF NOT EXISTS tmp_ccmihosp(
SELECT
t.hcode, t.hname, t.chwcode, t.chwname, t.region, t.regbed, t.actbed, t.splevel
FROM ccmihosp t
WHERE t.byear=@b_year+543
);
ALTER TABLE tmp_ccmihosp ADD KEY(hcode);
ALTER TABLE tmp_ccmihosp ADD KEY(splevel);

DROP TABLES IF EXISTS tmp_ccmistd;
CREATE TABLE IF NOT EXISTS tmp_ccmistd(
SELECT
t.splevel, t.refcmi, t.pctlowcmi
FROM ccmistd t
WHERE t.byear=@b_year+543
);
ALTER TABLE tmp_ccmistd ADD KEY(splevel);

DROP TABLES IF EXISTS t_cmi_admission;
CREATE TABLE IF NOT EXISTS t_cmi_admission(
SELECT SQL_BIG_RESULT
t.hospcode, t.drg, t.cntan, t.sumadj
, h.hname, h.chwcode, h.chwname, h.region, h.regbed, h.actbed, h.splevel
, s.refcmi, s.pctlowcmi, @b_year as byear
, t.cntm10, t.adjm10, t.cntm11, t.adjm11, t.cntm12, t.adjm12, t.cntm01, t.adjm01
, t.cntm02, t.adjm02, t.cntm03, t.adjm03, t.cntm04, t.adjm04, t.cntm05, t.adjm05
, t.cntm06, t.adjm06, t.cntm07, t.adjm07, t.cntm08, t.adjm08, t.cntm09, t.adjm09
, t.cntok
FROM tmp_cmiadmission t JOIN tmp_ccmihosp h ON t.hospcode = h.hcode
JOIN tmp_ccmistd s ON h.splevel = s.splevel
);
ALTER TABLE tmp_ccmistd ADD KEY(splevel);

DROP TABLES IF EXISTS tmp_cmiadmission;
#DROP TABLES IF EXISTS tmp_diag_ipd;
DROP TABLES IF EXISTS tmp_ccmihosp;
DROP TABLES IF EXISTS tmp_ccmistd;
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.342247;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:167;a:5:{i:0;s:3727:"CREATE PROCEDURE t_cmi1()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '23';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLES IF EXISTS tmp_cmiadmission;
CREATE TABLE IF NOT EXISTS tmp_cmiadmission(
SELECT SQL_BIG_RESULT t.hospcode, t.drg, count(t.an) as cntan, sum(t.adjrw) as sumadj
, count(if(month(t.datetime_disch)=10 and t.ERROR=0,t.an,null)) as cntm10
, sum(if(month(t.datetime_disch)=10 and t.ERROR=0,t.adjrw,0)) as adjm10
, count(if(month(t.datetime_disch)=11 and t.ERROR=0,t.an,null)) as cntm11
, sum(if(month(t.datetime_disch)=11 and t.ERROR=0,t.adjrw,0)) as adjm11
, count(if(month(t.datetime_disch)=12 and t.ERROR=0,t.an,null)) as cntm12
, sum(if(month(t.datetime_disch)=12 and t.ERROR=0,t.adjrw,0)) as adjm12
, count(if(month(t.datetime_disch)=1 and t.ERROR=0,t.an,null)) as cntm01
, sum(if(month(t.datetime_disch)=1 and t.ERROR=0,t.adjrw,0)) as adjm01
, count(if(month(t.datetime_disch)=2 and t.ERROR=0,t.an,null)) as cntm02
, sum(if(month(t.datetime_disch)=2 and t.ERROR=0,t.adjrw,0)) as adjm02
, count(if(month(t.datetime_disch)=3 and t.ERROR=0,t.an,null)) as cntm03
, sum(if(month(t.datetime_disch)=3 and t.ERROR=0,t.adjrw,0)) as adjm03
, count(if(month(t.datetime_disch)=4 and t.ERROR=0,t.an,null)) as cntm04
, sum(if(month(t.datetime_disch)=4 and t.ERROR=0,t.adjrw,0)) as adjm04
, count(if(month(t.datetime_disch)=5 and t.ERROR=0,t.an,null)) as cntm05
, sum(if(month(t.datetime_disch)=5 and t.ERROR=0,t.adjrw,0)) as adjm05
, count(if(month(t.datetime_disch)=6 and t.ERROR=0,t.an,null)) as cntm06
, sum(if(month(t.datetime_disch)=6 and t.ERROR=0,t.adjrw,0)) as adjm06
, count(if(month(t.datetime_disch)=7 and t.ERROR=0,t.an,null)) as cntm07
, sum(if(month(t.datetime_disch)=7 and t.ERROR=0,t.adjrw,0)) as adjm07
, count(if(month(t.datetime_disch)=8 and t.ERROR=0,t.an,null)) as cntm08
, sum(if(month(t.datetime_disch)=8 and t.ERROR=0, t.adjrw,0)) as adjm08
, count(if(month(t.datetime_disch)=9 and t.ERROR=0,t.an,null)) as cntm09
, sum(if(month(t.datetime_disch)=9 and t.ERROR=0,t.adjrw,0)) as adjm09
, count(if(t.error=0, t.HOSPCODE,null)) as cntok
FROM admission t
WHERE date_format(t.datetime_disch,'%Y%m%d') BETWEEN @start_d and @end_d
GROUP BY t.hospcode, t.drg
);
ALTER TABLE tmp_cmiadmission ADD KEY(hospcode);

DROP TABLES IF EXISTS tmp_ccmihosp;
CREATE TABLE IF NOT EXISTS tmp_ccmihosp(
SELECT
t.hcode, t.hname, t.chwcode, t.chwname, t.region, t.regbed, t.actbed, t.splevel
FROM ccmihosp t
WHERE t.byear=@b_year+543
);
ALTER TABLE tmp_ccmihosp ADD KEY(hcode);
ALTER TABLE tmp_ccmihosp ADD KEY(splevel);

DROP TABLES IF EXISTS tmp_ccmistd;
CREATE TABLE IF NOT EXISTS tmp_ccmistd(
SELECT
t.splevel, t.refcmi, t.pctlowcmi
FROM ccmistd t
WHERE t.byear=@b_year+543
);
ALTER TABLE tmp_ccmistd ADD KEY(splevel);

DROP TABLES IF EXISTS t_cmi_admission;
CREATE TABLE IF NOT EXISTS t_cmi_admission(
SELECT SQL_BIG_RESULT
t.hospcode, t.drg, t.cntan, t.sumadj
, h.hname, h.chwcode, h.chwname, h.region, h.regbed, h.actbed, h.splevel
, s.refcmi, s.pctlowcmi, @b_year as byear
, t.cntm10, t.adjm10, t.cntm11, t.adjm11, t.cntm12, t.adjm12, t.cntm01, t.adjm01
, t.cntm02, t.adjm02, t.cntm03, t.adjm03, t.cntm04, t.adjm04, t.cntm05, t.adjm05
, t.cntm06, t.adjm06, t.cntm07, t.adjm07, t.cntm08, t.adjm08, t.cntm09, t.adjm09
, t.cntok
FROM tmp_cmiadmission t JOIN tmp_ccmihosp h ON t.hospcode = h.hcode
JOIN tmp_ccmistd s ON h.splevel = s.splevel
);
ALTER TABLE tmp_ccmistd ADD KEY(splevel);

DROP TABLES IF EXISTS tmp_cmiadmission;
#DROP TABLES IF EXISTS tmp_diag_ipd;
DROP TABLES IF EXISTS tmp_ccmihosp;
DROP TABLES IF EXISTS tmp_ccmistd;
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.3998489;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:169;a:5:{i:0;s:29:"DROP PROCEDURE IF EXISTS t_bp";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.3998489;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:170;a:5:{i:0;s:29:"DROP PROCEDURE IF EXISTS t_bp";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.4440501;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:172;a:5:{i:0;s:5446:"CREATE PROCEDURE t_bp()
 BEGIN 
SET	@prov_c := '58';
SET @id := '24';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d1:=concat(@b_year-1,'1001');
SET @end_d1:=concat(@b_year-1,'1231');
SET	@start_d2:=concat(@b_year,'0101');
SET @end_d2:=concat(@b_year,'0331');
SET	@start_d3:=concat(@b_year,'0401');
SET @end_d3:=concat(@b_year,'0630');
SET	@start_d4:=concat(@b_year,'0701');
SET @end_d4:=concat(@b_year,'0930');

DROP  TABLE IF EXISTS tmp_bp;
CREATE  TABLE IF NOT EXISTS tmp_bp  (
		cid  VARCHAR(13) not null 
		,bp_date1_tr1 date
		,sbp1_tr1 int(3) DEFAULT 0
		,dbp1_tr1 int(3) DEFAULT 0
		,bp_date2_tr1 date
		,sbp2_tr1 int(3) DEFAULT 0
		,dbp2_tr1 int(3) DEFAULT 0

		,bp_date1_tr2 date
		,sbp1_tr2 int(3) DEFAULT 0
		,dbp1_tr2 int(3) DEFAULT 0
		,bp_date2_tr2 date
		,sbp2_tr2 int(3) DEFAULT 0
		,dbp2_tr2 int(3) DEFAULT 0

		,bp_date1_tr3 date
		,sbp1_tr3 int(3) DEFAULT 0
		,dbp1_tr3 int(3) DEFAULT 0
		,bp_date2_tr3 date
		,sbp2_tr3 int(3) DEFAULT 0
		,dbp2_tr3 int(3) DEFAULT 0

		,bp_date1_tr4 date
		,sbp1_tr4 int(3) DEFAULT 0
		,dbp1_tr4 int(3) DEFAULT 0
		,bp_date2_tr4 date
		,sbp2_tr4 int(3) DEFAULT 0
		,dbp2_tr4 int(3) DEFAULT 0
		
,INDEX(CID)
) ENGINE=MyISAM  ;

INSERT INTO tmp_bp (
cid
)
(
	SELECT c.cid
	FROM tmp_chronicfu c
	INNER JOIN (SELECT cid,type_dx FROM t_dmht WHERE type_dx in('01','03')) dh ON dh.cid=c.CID
	WHERE  LENGTH(TRIM(c.cid))=13 AND c.DATE_SERV BETWEEN @start_d1 AND @end_d4
	GROUP BY c.cid
);

UPDATE tmp_bp bp,( SELECT c.cid,c.DATE_SERV,c.SBP,c.DBP
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV<=@end_d1 AND c.DATE_SERV =
								(SELECT c1.DATE_SERV 
								FROM tmp_chronicfu c1
								WHERE c1.cid=c.cid AND c1.DATE_SERV <=@end_d1
								GROUP BY c1.cid,c1.DATE_SERV 
								ORDER BY c1.date_serv desc LIMIT 0,1)
								GROUP BY cid
										) tbp
	SET bp.bp_date1_tr1=tbp.DATE_SERV ,bp.sbp1_tr1=tbp.sbp , bp.dbp1_tr1=tbp.dbp 
WHERE bp.cid=tbp.cid
;

UPDATE tmp_bp bp,( SELECT c.cid,c.DATE_SERV,c.SBP,c.DBP
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV<=@end_d1 AND c.DATE_SERV =
								(SELECT c1.DATE_SERV 
								FROM tmp_chronicfu c1
								WHERE c1.cid=c.cid AND c1.DATE_SERV <=@end_d1
								GROUP BY c1.cid,c1.DATE_SERV 
								ORDER BY c1.date_serv desc LIMIT 1,1)
								GROUP BY cid
										) tbp
	SET bp.bp_date2_tr1=tbp.DATE_SERV ,bp.sbp2_tr1=tbp.sbp , bp.dbp2_tr1=tbp.dbp 
WHERE bp.cid=tbp.cid
;

UPDATE tmp_bp bp,( SELECT c.cid,c.DATE_SERV,c.SBP,c.DBP
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV<=@end_d2 AND c.DATE_SERV =
								(SELECT c1.DATE_SERV 
								FROM tmp_chronicfu c1
								WHERE c1.cid=c.cid AND c1.DATE_SERV <=@end_d2
								GROUP BY c1.cid,c1.DATE_SERV 
								ORDER BY c1.date_serv desc LIMIT 0,1)
								GROUP BY cid
										) tbp
	SET bp.bp_date1_tr2=tbp.DATE_SERV ,bp.sbp1_tr2=tbp.sbp , bp.dbp1_tr2=tbp.dbp 
WHERE bp.cid=tbp.cid
;

UPDATE tmp_bp bp,( SELECT c.cid,c.DATE_SERV,c.SBP,c.DBP
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV<=@end_d2 AND c.DATE_SERV =
								(SELECT c1.DATE_SERV 
								FROM tmp_chronicfu c1
								WHERE c1.cid=c.cid AND c1.DATE_SERV <=@end_d2
								GROUP BY c1.cid,c1.DATE_SERV 
								ORDER BY c1.date_serv desc LIMIT 1,1)
								GROUP BY cid
										) tbp
	SET bp.bp_date2_tr2=tbp.DATE_SERV ,bp.sbp2_tr2=tbp.sbp , bp.dbp2_tr2=tbp.dbp 
WHERE bp.cid=tbp.cid
;


UPDATE tmp_bp bp,( SELECT c.cid,c.DATE_SERV,c.SBP,c.DBP
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV<=@end_d3 AND c.DATE_SERV =
								(SELECT c1.DATE_SERV 
								FROM tmp_chronicfu c1
								WHERE c1.cid=c.cid AND c1.DATE_SERV <=@end_d3
								GROUP BY c1.cid,c1.DATE_SERV 
								ORDER BY c1.date_serv desc LIMIT 0,1)
								GROUP BY cid
										) tbp
	SET bp.bp_date1_tr3=tbp.DATE_SERV ,bp.sbp1_tr3=tbp.sbp , bp.dbp1_tr3=tbp.dbp 
WHERE bp.cid=tbp.cid
;

UPDATE tmp_bp bp,( SELECT c.cid,c.DATE_SERV,c.SBP,c.DBP
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV<=@end_d3 AND c.DATE_SERV =
								(SELECT c1.DATE_SERV 
								FROM tmp_chronicfu c1
								WHERE c1.cid=c.cid AND c1.DATE_SERV <=@end_d3
								GROUP BY c1.cid,c1.DATE_SERV 
								ORDER BY c1.date_serv desc LIMIT 1,1)
								GROUP BY cid
										) tbp
	SET bp.bp_date2_tr3=tbp.DATE_SERV ,bp.sbp2_tr3=tbp.sbp , bp.dbp2_tr3=tbp.dbp 
WHERE bp.cid=tbp.cid
;


UPDATE tmp_bp bp,( SELECT c.cid,c.DATE_SERV,c.SBP,c.DBP
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV<=@end_d4 AND c.DATE_SERV =
								(SELECT c1.DATE_SERV 
								FROM tmp_chronicfu c1
								WHERE c1.cid=c.cid AND c1.DATE_SERV <=@end_d4
								GROUP BY c1.cid,c1.DATE_SERV 
								ORDER BY c1.date_serv desc LIMIT 0,1)
								GROUP BY cid
										) tbp
	SET bp.bp_date1_tr4=tbp.DATE_SERV ,bp.sbp1_tr4=tbp.sbp , bp.dbp1_tr4=tbp.dbp 
WHERE bp.cid=tbp.cid
;

UPDATE tmp_bp bp,( SELECT c.cid,c.DATE_SERV,c.SBP,c.DBP
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV<=@end_d4 AND c.DATE_SERV =
								(SELECT c1.DATE_SERV 
								FROM tmp_chronicfu c1
								WHERE c1.cid=c.cid AND c1.DATE_SERV <=@end_d4
								GROUP BY c1.cid,c1.DATE_SERV 
								ORDER BY c1.date_serv desc LIMIT 1,1)
								GROUP BY cid
										) tbp
	SET bp.bp_date2_tr4=tbp.DATE_SERV ,bp.sbp2_tr4=tbp.sbp , bp.dbp2_tr4=tbp.dbp 
WHERE bp.cid=tbp.cid
;

 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.4440501;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:173;a:5:{i:0;s:5446:"CREATE PROCEDURE t_bp()
 BEGIN 
SET	@prov_c := '58';
SET @id := '24';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d1:=concat(@b_year-1,'1001');
SET @end_d1:=concat(@b_year-1,'1231');
SET	@start_d2:=concat(@b_year,'0101');
SET @end_d2:=concat(@b_year,'0331');
SET	@start_d3:=concat(@b_year,'0401');
SET @end_d3:=concat(@b_year,'0630');
SET	@start_d4:=concat(@b_year,'0701');
SET @end_d4:=concat(@b_year,'0930');

DROP  TABLE IF EXISTS tmp_bp;
CREATE  TABLE IF NOT EXISTS tmp_bp  (
		cid  VARCHAR(13) not null 
		,bp_date1_tr1 date
		,sbp1_tr1 int(3) DEFAULT 0
		,dbp1_tr1 int(3) DEFAULT 0
		,bp_date2_tr1 date
		,sbp2_tr1 int(3) DEFAULT 0
		,dbp2_tr1 int(3) DEFAULT 0

		,bp_date1_tr2 date
		,sbp1_tr2 int(3) DEFAULT 0
		,dbp1_tr2 int(3) DEFAULT 0
		,bp_date2_tr2 date
		,sbp2_tr2 int(3) DEFAULT 0
		,dbp2_tr2 int(3) DEFAULT 0

		,bp_date1_tr3 date
		,sbp1_tr3 int(3) DEFAULT 0
		,dbp1_tr3 int(3) DEFAULT 0
		,bp_date2_tr3 date
		,sbp2_tr3 int(3) DEFAULT 0
		,dbp2_tr3 int(3) DEFAULT 0

		,bp_date1_tr4 date
		,sbp1_tr4 int(3) DEFAULT 0
		,dbp1_tr4 int(3) DEFAULT 0
		,bp_date2_tr4 date
		,sbp2_tr4 int(3) DEFAULT 0
		,dbp2_tr4 int(3) DEFAULT 0
		
,INDEX(CID)
) ENGINE=MyISAM  ;

INSERT INTO tmp_bp (
cid
)
(
	SELECT c.cid
	FROM tmp_chronicfu c
	INNER JOIN (SELECT cid,type_dx FROM t_dmht WHERE type_dx in('01','03')) dh ON dh.cid=c.CID
	WHERE  LENGTH(TRIM(c.cid))=13 AND c.DATE_SERV BETWEEN @start_d1 AND @end_d4
	GROUP BY c.cid
);

UPDATE tmp_bp bp,( SELECT c.cid,c.DATE_SERV,c.SBP,c.DBP
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV<=@end_d1 AND c.DATE_SERV =
								(SELECT c1.DATE_SERV 
								FROM tmp_chronicfu c1
								WHERE c1.cid=c.cid AND c1.DATE_SERV <=@end_d1
								GROUP BY c1.cid,c1.DATE_SERV 
								ORDER BY c1.date_serv desc LIMIT 0,1)
								GROUP BY cid
										) tbp
	SET bp.bp_date1_tr1=tbp.DATE_SERV ,bp.sbp1_tr1=tbp.sbp , bp.dbp1_tr1=tbp.dbp 
WHERE bp.cid=tbp.cid
;

UPDATE tmp_bp bp,( SELECT c.cid,c.DATE_SERV,c.SBP,c.DBP
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV<=@end_d1 AND c.DATE_SERV =
								(SELECT c1.DATE_SERV 
								FROM tmp_chronicfu c1
								WHERE c1.cid=c.cid AND c1.DATE_SERV <=@end_d1
								GROUP BY c1.cid,c1.DATE_SERV 
								ORDER BY c1.date_serv desc LIMIT 1,1)
								GROUP BY cid
										) tbp
	SET bp.bp_date2_tr1=tbp.DATE_SERV ,bp.sbp2_tr1=tbp.sbp , bp.dbp2_tr1=tbp.dbp 
WHERE bp.cid=tbp.cid
;

UPDATE tmp_bp bp,( SELECT c.cid,c.DATE_SERV,c.SBP,c.DBP
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV<=@end_d2 AND c.DATE_SERV =
								(SELECT c1.DATE_SERV 
								FROM tmp_chronicfu c1
								WHERE c1.cid=c.cid AND c1.DATE_SERV <=@end_d2
								GROUP BY c1.cid,c1.DATE_SERV 
								ORDER BY c1.date_serv desc LIMIT 0,1)
								GROUP BY cid
										) tbp
	SET bp.bp_date1_tr2=tbp.DATE_SERV ,bp.sbp1_tr2=tbp.sbp , bp.dbp1_tr2=tbp.dbp 
WHERE bp.cid=tbp.cid
;

UPDATE tmp_bp bp,( SELECT c.cid,c.DATE_SERV,c.SBP,c.DBP
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV<=@end_d2 AND c.DATE_SERV =
								(SELECT c1.DATE_SERV 
								FROM tmp_chronicfu c1
								WHERE c1.cid=c.cid AND c1.DATE_SERV <=@end_d2
								GROUP BY c1.cid,c1.DATE_SERV 
								ORDER BY c1.date_serv desc LIMIT 1,1)
								GROUP BY cid
										) tbp
	SET bp.bp_date2_tr2=tbp.DATE_SERV ,bp.sbp2_tr2=tbp.sbp , bp.dbp2_tr2=tbp.dbp 
WHERE bp.cid=tbp.cid
;


UPDATE tmp_bp bp,( SELECT c.cid,c.DATE_SERV,c.SBP,c.DBP
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV<=@end_d3 AND c.DATE_SERV =
								(SELECT c1.DATE_SERV 
								FROM tmp_chronicfu c1
								WHERE c1.cid=c.cid AND c1.DATE_SERV <=@end_d3
								GROUP BY c1.cid,c1.DATE_SERV 
								ORDER BY c1.date_serv desc LIMIT 0,1)
								GROUP BY cid
										) tbp
	SET bp.bp_date1_tr3=tbp.DATE_SERV ,bp.sbp1_tr3=tbp.sbp , bp.dbp1_tr3=tbp.dbp 
WHERE bp.cid=tbp.cid
;

UPDATE tmp_bp bp,( SELECT c.cid,c.DATE_SERV,c.SBP,c.DBP
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV<=@end_d3 AND c.DATE_SERV =
								(SELECT c1.DATE_SERV 
								FROM tmp_chronicfu c1
								WHERE c1.cid=c.cid AND c1.DATE_SERV <=@end_d3
								GROUP BY c1.cid,c1.DATE_SERV 
								ORDER BY c1.date_serv desc LIMIT 1,1)
								GROUP BY cid
										) tbp
	SET bp.bp_date2_tr3=tbp.DATE_SERV ,bp.sbp2_tr3=tbp.sbp , bp.dbp2_tr3=tbp.dbp 
WHERE bp.cid=tbp.cid
;


UPDATE tmp_bp bp,( SELECT c.cid,c.DATE_SERV,c.SBP,c.DBP
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV<=@end_d4 AND c.DATE_SERV =
								(SELECT c1.DATE_SERV 
								FROM tmp_chronicfu c1
								WHERE c1.cid=c.cid AND c1.DATE_SERV <=@end_d4
								GROUP BY c1.cid,c1.DATE_SERV 
								ORDER BY c1.date_serv desc LIMIT 0,1)
								GROUP BY cid
										) tbp
	SET bp.bp_date1_tr4=tbp.DATE_SERV ,bp.sbp1_tr4=tbp.sbp , bp.dbp1_tr4=tbp.dbp 
WHERE bp.cid=tbp.cid
;

UPDATE tmp_bp bp,( SELECT c.cid,c.DATE_SERV,c.SBP,c.DBP
								FROM tmp_chronicfu c
								WHERE c.DATE_SERV<=@end_d4 AND c.DATE_SERV =
								(SELECT c1.DATE_SERV 
								FROM tmp_chronicfu c1
								WHERE c1.cid=c.cid AND c1.DATE_SERV <=@end_d4
								GROUP BY c1.cid,c1.DATE_SERV 
								ORDER BY c1.date_serv desc LIMIT 1,1)
								GROUP BY cid
										) tbp
	SET bp.bp_date2_tr4=tbp.DATE_SERV ,bp.sbp2_tr4=tbp.sbp , bp.dbp2_tr4=tbp.dbp 
WHERE bp.cid=tbp.cid
;

 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.5064499;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:175;a:5:{i:0;s:29:"DROP PROCEDURE IF EXISTS t_fp";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.5064499;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:176;a:5:{i:0;s:29:"DROP PROCEDURE IF EXISTS t_fp";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.56885;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:178;a:5:{i:0;s:1249:"CREATE PROCEDURE t_fp()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '25';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-2,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP  TABLE IF EXISTS tmp_fp;
CREATE TABLE IF NOT EXISTS tmp_fp(
  `HOSPCODE` varchar(5) NOT NULL,
  `PID` varchar(15) NOT NULL,
  `SEQ` varchar(16) DEFAULT NULL,
  `DATE_SERV` date NOT NULL,
  `FPTYPE` char(1) NOT NULL,
  `FPPLACE` varchar(5) DEFAULT NULL,
  `PROVIDER` varchar(15) DEFAULT NULL,
  `D_UPDATE` datetime NOT NULL,
	 cid varchar(13) DEFAULT NULL,
	 nation varchar(3)  DEFAULT NULL,
	 age_y int(3)  DEFAULT 0,
  PRIMARY KEY (`HOSPCODE`,`PID`,`DATE_SERV`,`FPTYPE`),
  KEY `idx1` (`HOSPCODE`,`PID`),
  KEY `idx2` (`HOSPCODE`),
  KEY `idx3` (`DATE_SERV`),
  KEY `idx4` (`FPTYPE`),
  KEY `idx5` (`FPPLACE`),
  KEY `idx6` (`HOSPCODE`,`PROVIDER`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT INTO tmp_fp 
(
SELECT SQL_BIG_RESULT 
	fp.HOSPCODE,fp.PID,fp.SEQ,fp.DATE_SERV,fp.FPTYPE,fp.FPPLACE,fp.PROVIDER,fp.D_UPDATE,p.cid,p.nation,age(fp.date_serv,p.birth,'y') age_y
FROM
	fp LEFT JOIN person p ON fp.HOSPCODE=p.HOSPCODE AND fp.PID=p.PID
WHERE 
	fp.date_serv BETWEEN @start_d AND @end_d
);


 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.56885;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:179;a:5:{i:0;s:1249:"CREATE PROCEDURE t_fp()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '25';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-2,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP  TABLE IF EXISTS tmp_fp;
CREATE TABLE IF NOT EXISTS tmp_fp(
  `HOSPCODE` varchar(5) NOT NULL,
  `PID` varchar(15) NOT NULL,
  `SEQ` varchar(16) DEFAULT NULL,
  `DATE_SERV` date NOT NULL,
  `FPTYPE` char(1) NOT NULL,
  `FPPLACE` varchar(5) DEFAULT NULL,
  `PROVIDER` varchar(15) DEFAULT NULL,
  `D_UPDATE` datetime NOT NULL,
	 cid varchar(13) DEFAULT NULL,
	 nation varchar(3)  DEFAULT NULL,
	 age_y int(3)  DEFAULT 0,
  PRIMARY KEY (`HOSPCODE`,`PID`,`DATE_SERV`,`FPTYPE`),
  KEY `idx1` (`HOSPCODE`,`PID`),
  KEY `idx2` (`HOSPCODE`),
  KEY `idx3` (`DATE_SERV`),
  KEY `idx4` (`FPTYPE`),
  KEY `idx5` (`FPPLACE`),
  KEY `idx6` (`HOSPCODE`,`PROVIDER`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT INTO tmp_fp 
(
SELECT SQL_BIG_RESULT 
	fp.HOSPCODE,fp.PID,fp.SEQ,fp.DATE_SERV,fp.FPTYPE,fp.FPPLACE,fp.PROVIDER,fp.D_UPDATE,p.cid,p.nation,age(fp.date_serv,p.birth,'y') age_y
FROM
	fp LEFT JOIN person p ON fp.HOSPCODE=p.HOSPCODE AND fp.PID=p.PID
WHERE 
	fp.date_serv BETWEEN @start_d AND @end_d
);


 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.6156509;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:181;a:5:{i:0;s:37:"DROP PROCEDURE IF EXISTS t_charge_opd";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.6156509;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:182;a:5:{i:0;s:37:"DROP PROCEDURE IF EXISTS t_charge_opd";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.678051;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:184;a:5:{i:0;s:1347:"CREATE PROCEDURE t_charge_opd()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '26';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLES IF EXISTS tmp_charge_opd;
CREATE TABLE IF NOT EXISTS tmp_charge_opd (
KEY(cid),
KEY(hospcode),
KEY(pid),
KEY(date_serv),
KEY(chargeitem),
KEY(hospcode,pid),
KEY(hospcode,pid,seq)
) ENGINE=MyISAM  AS(
		SELECT 
				a.*,p.CID,p.nation,p.sex,p.check_hosp,p.check_vhid,p.check_typearea,p.vhid,p.typearea
		FROM
			charge_opd a LEFT JOIN t_person_db p ON a.HOSPCODE=p.HOSPCODE AND a.PID=p.PID 
		WHERE a.DATE_SERV BETWEEN  @start_d AND @end_d
);

DROP TABLES IF EXISTS t_charge_opd;
CREATE TABLE IF NOT EXISTS t_charge_opd (
KEY(cid),
KEY(hospcode),
KEY(pid),
KEY(date_serv),
KEY(chargeitem),
KEY(hospcode,pid),
KEY(hospcode,pid,seq)
) ENGINE=MyISAM  AS(
		SELECT 
				HOSPCODE,PID,SEQ,DATE_SERV,CLINIC,CHARGEITEM,CHARGELIST
				,INSTYPE
				,SUM(QUANTITY)  QUANTITY
				,SUM(COST) COST
				,SUM(PRICE) PRICE
				,SUM(PAYPRICE) PAYPRICE
				,D_UPDATE
				,CID, nation, sex, check_hosp, check_vhid, check_typearea, vhid, typearea
		FROM
			tmp_charge_opd a
		WHERE a.DATE_SERV BETWEEN  @start_d AND @end_d
		GROUP BY a.HOSPCODE,a.PID,a.SEQ,CLINIC,a.CHARGEITEM,INSTYPE
);


 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.678051;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:185;a:5:{i:0;s:1347:"CREATE PROCEDURE t_charge_opd()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '26';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLES IF EXISTS tmp_charge_opd;
CREATE TABLE IF NOT EXISTS tmp_charge_opd (
KEY(cid),
KEY(hospcode),
KEY(pid),
KEY(date_serv),
KEY(chargeitem),
KEY(hospcode,pid),
KEY(hospcode,pid,seq)
) ENGINE=MyISAM  AS(
		SELECT 
				a.*,p.CID,p.nation,p.sex,p.check_hosp,p.check_vhid,p.check_typearea,p.vhid,p.typearea
		FROM
			charge_opd a LEFT JOIN t_person_db p ON a.HOSPCODE=p.HOSPCODE AND a.PID=p.PID 
		WHERE a.DATE_SERV BETWEEN  @start_d AND @end_d
);

DROP TABLES IF EXISTS t_charge_opd;
CREATE TABLE IF NOT EXISTS t_charge_opd (
KEY(cid),
KEY(hospcode),
KEY(pid),
KEY(date_serv),
KEY(chargeitem),
KEY(hospcode,pid),
KEY(hospcode,pid,seq)
) ENGINE=MyISAM  AS(
		SELECT 
				HOSPCODE,PID,SEQ,DATE_SERV,CLINIC,CHARGEITEM,CHARGELIST
				,INSTYPE
				,SUM(QUANTITY)  QUANTITY
				,SUM(COST) COST
				,SUM(PRICE) PRICE
				,SUM(PAYPRICE) PAYPRICE
				,D_UPDATE
				,CID, nation, sex, check_hosp, check_vhid, check_typearea, vhid, typearea
		FROM
			tmp_charge_opd a
		WHERE a.DATE_SERV BETWEEN  @start_d AND @end_d
		GROUP BY a.HOSPCODE,a.PID,a.SEQ,CLINIC,a.CHARGEITEM,INSTYPE
);


 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.7248509;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:187;a:5:{i:0;s:39:"DROP PROCEDURE IF EXISTS t_nation_labor";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.7248509;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:188;a:5:{i:0;s:39:"DROP PROCEDURE IF EXISTS t_nation_labor";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.802851;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:190;a:5:{i:0;s:4417:"CREATE PROCEDURE t_nation_labor()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '27';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP  TABLE IF EXISTS  t_admission_labor;
CREATE  TABLE IF NOT EXISTS t_admission_labor (INDEX(HOSPCODE,AN)) 
ENGINE=MyISAM  AS 
(
SELECT 
 a.HOSPCODE,a.AN,p.cid,p.sex,a.DATETIME_ADMIT,a.DATETIME_DISCH,a.INSTYPE,a.PRICE,a.PAYPRICE,a.ACTUALPAY,(a.PRICE-a.ACTUALPAY) as fee ,p.LABOR, p.NATION,nationcodeaec,
		IF(LABOR IN('12','14','22','38') ,1
			,IF(LABOR IN('24') ,2
			,IF(LABOR IN('36','37') ,3
			,IF(LABOR IN('22','38') AND SUBSTR(p.CID,1,1) IN(0,3,4,5,6,7,8) ,4
			,IF(LABOR IN('01','02','03','11','15','16','17','18') AND SUBSTR(p.CID,1,1) IN(0,3,4,5,6,7,8) ,5
			,IF(LABOR IN('01','02','03','11','15','16','17','18') ,6,0
		))))))  as labor_group ,'        ' diagcode ,' ' diagtype
FROM tmp_admission a
				INNER JOIN t_person_db p ON a.HOSPCODE =p.HOSPCODE AND a.PID=p.PID
				INNER JOIN cnation n ON a.nation =n.nationcode
WHERE p.nation != 99     AND a.DATETIME_DISCH BETWEEN @start_d AND @end_d  
);
update t_admission_labor	a	LEFT JOIN tmp_diag_ipd d ON a.HOSPCODE =d.HOSPCODE AND a.AN=d.AN   
SET a.diagcode=d.diagcode , a.diagtype=d.diagtype
WHERE d.diagtype in(1);

DROP  TABLE IF EXISTS  t_service_labor;
CREATE  TABLE IF NOT EXISTS t_service_labor (INDEX(HOSPCODE,pid,seq)) 
ENGINE=MyISAM  AS 
(
SELECT 
 a.HOSPCODE,a.pid,p.cid,p.sex,a.seq,a.date_serv,a.INSTYPE,a.PRICE,a.PAYPRICE,a.ACTUALPAY,(a.PRICE-a.ACTUALPAY) as fee ,p.LABOR, p.NATION,nationcodeaec,
		IF(LABOR IN('12','14','22','38') ,1
			,IF(LABOR IN('24') ,2
			,IF(LABOR IN('36','37') ,3
			,IF(LABOR IN('22','38') AND SUBSTR(p.CID,1,1) IN(0,3,4,5,6,7,8) ,4
			,IF(LABOR IN('01','02','03','11','15','16','17','18') AND SUBSTR(p.CID,1,1) IN(0,3,4,5,6,7,8) ,5
			,IF(LABOR IN('01','02','03','11','15','16','17','18') ,6,0
		))))))  as labor_group  ,'        ' diagcode ,' ' diagtype
FROM tmp_service a
					INNER JOIN t_person_db p ON a.HOSPCODE =p.HOSPCODE AND a.PID=p.PID
					INNER JOIN cnation n ON a.nation =n.nationcode
WHERE p.nation != 99     AND a.date_serv BETWEEN @start_d AND @end_d 
);
update t_service_labor	a	LEFT JOIN tmp_diag_opd d ON a.HOSPCODE =d.HOSPCODE AND a.PID=d.PID AND a.SEQ=d.SEQ  
SET a.diagcode=d.diagcode , a.diagtype=d.diagtype
WHERE d.diagtype in(1);



DROP  TABLE IF EXISTS  t_anc_labor;
CREATE  TABLE IF NOT EXISTS t_anc_labor (INDEX(HOSPCODE,pid,seq)) 
ENGINE=MyISAM  AS 
(
SELECT 
 a.HOSPCODE,a.pid,s.cid,s.sex,a.seq,a.date_serv,s.INSTYPE,s.LABOR, s.NATION,nationcodeaec,s.labor_group
FROM tmp_anc a 
				INNER JOIN t_service_labor s ON a.HOSPCODE =s.HOSPCODE AND a.PID=s.PID	AND a.SEQ=s.SEQ	
	WHERE  a.date_serv BETWEEN @start_d AND @end_d 
);


DROP  TABLE IF EXISTS  tmp_postnatal;
CREATE  TABLE IF NOT EXISTS tmp_postnatal (INDEX(HOSPCODE,pid,seq)) 
ENGINE=MyISAM  AS 
(
SELECT po.*,p.cid,p.nation,p.occupation_new occupat,p.birth,p.check_vhid vhid
FROM postnatal po LEFT JOIN t_person_db p ON po.hospcode=p.hospcode and po.pid=p.pid
WHERE po.BDATE BETWEEN @start_d AND @end_d
);

DROP  TABLE IF EXISTS  t_postnatal_labor;
CREATE  TABLE IF NOT EXISTS t_postnatal_labor (INDEX(HOSPCODE,pid,seq)) 
ENGINE=MyISAM  AS 
(
SELECT 
 a.HOSPCODE,a.pid,s.cid,s.sex,a.seq,a.BDATE,s.INSTYPE,s.LABOR, s.NATION,nationcodeaec,s.labor_group
FROM tmp_postnatal a 
				INNER JOIN t_service_labor s ON a.HOSPCODE =s.HOSPCODE AND a.PID=s.PID	AND a.SEQ=s.SEQ	
WHERE a.BDATE BETWEEN @start_d AND @end_d 
);

DROP  TABLE IF EXISTS  t_epi_labor;
CREATE  TABLE IF NOT EXISTS t_epi_labor (INDEX(HOSPCODE,pid,seq)) 
ENGINE=MyISAM  AS 
(
SELECT 
	a.HOSPCODE,a.pid,s.cid,s.sex,a.seq,a.date_serv,s.INSTYPE,s.LABOR, s.NATION,nationcodeaec,s.labor_group
FROM tmp_epi a 
				INNER JOIN t_service_labor s ON a.HOSPCODE =s.HOSPCODE AND a.PID=s.PID	AND a.SEQ=s.SEQ	
	WHERE a.date_serv BETWEEN @start_d AND @end_d 
);

DROP  TABLE IF EXISTS  t_fp_labor;
CREATE  TABLE IF NOT EXISTS t_fp_labor (INDEX(HOSPCODE,pid,seq)) 
ENGINE=MyISAM  AS 
(
SELECT 
 a.HOSPCODE,a.pid,s.cid,s.sex,a.seq,a.date_serv,s.INSTYPE,s.LABOR, s.NATION,nationcodeaec,s.labor_group
FROM tmp_fp a 
				INNER JOIN t_service_labor s ON a.HOSPCODE =s.HOSPCODE AND a.PID=s.PID	AND a.SEQ=s.SEQ	
WHERE a.date_serv BETWEEN @start_d AND @end_d
);
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.802851;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:191;a:5:{i:0;s:4417:"CREATE PROCEDURE t_nation_labor()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '27';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP  TABLE IF EXISTS  t_admission_labor;
CREATE  TABLE IF NOT EXISTS t_admission_labor (INDEX(HOSPCODE,AN)) 
ENGINE=MyISAM  AS 
(
SELECT 
 a.HOSPCODE,a.AN,p.cid,p.sex,a.DATETIME_ADMIT,a.DATETIME_DISCH,a.INSTYPE,a.PRICE,a.PAYPRICE,a.ACTUALPAY,(a.PRICE-a.ACTUALPAY) as fee ,p.LABOR, p.NATION,nationcodeaec,
		IF(LABOR IN('12','14','22','38') ,1
			,IF(LABOR IN('24') ,2
			,IF(LABOR IN('36','37') ,3
			,IF(LABOR IN('22','38') AND SUBSTR(p.CID,1,1) IN(0,3,4,5,6,7,8) ,4
			,IF(LABOR IN('01','02','03','11','15','16','17','18') AND SUBSTR(p.CID,1,1) IN(0,3,4,5,6,7,8) ,5
			,IF(LABOR IN('01','02','03','11','15','16','17','18') ,6,0
		))))))  as labor_group ,'        ' diagcode ,' ' diagtype
FROM tmp_admission a
				INNER JOIN t_person_db p ON a.HOSPCODE =p.HOSPCODE AND a.PID=p.PID
				INNER JOIN cnation n ON a.nation =n.nationcode
WHERE p.nation != 99     AND a.DATETIME_DISCH BETWEEN @start_d AND @end_d  
);
update t_admission_labor	a	LEFT JOIN tmp_diag_ipd d ON a.HOSPCODE =d.HOSPCODE AND a.AN=d.AN   
SET a.diagcode=d.diagcode , a.diagtype=d.diagtype
WHERE d.diagtype in(1);

DROP  TABLE IF EXISTS  t_service_labor;
CREATE  TABLE IF NOT EXISTS t_service_labor (INDEX(HOSPCODE,pid,seq)) 
ENGINE=MyISAM  AS 
(
SELECT 
 a.HOSPCODE,a.pid,p.cid,p.sex,a.seq,a.date_serv,a.INSTYPE,a.PRICE,a.PAYPRICE,a.ACTUALPAY,(a.PRICE-a.ACTUALPAY) as fee ,p.LABOR, p.NATION,nationcodeaec,
		IF(LABOR IN('12','14','22','38') ,1
			,IF(LABOR IN('24') ,2
			,IF(LABOR IN('36','37') ,3
			,IF(LABOR IN('22','38') AND SUBSTR(p.CID,1,1) IN(0,3,4,5,6,7,8) ,4
			,IF(LABOR IN('01','02','03','11','15','16','17','18') AND SUBSTR(p.CID,1,1) IN(0,3,4,5,6,7,8) ,5
			,IF(LABOR IN('01','02','03','11','15','16','17','18') ,6,0
		))))))  as labor_group  ,'        ' diagcode ,' ' diagtype
FROM tmp_service a
					INNER JOIN t_person_db p ON a.HOSPCODE =p.HOSPCODE AND a.PID=p.PID
					INNER JOIN cnation n ON a.nation =n.nationcode
WHERE p.nation != 99     AND a.date_serv BETWEEN @start_d AND @end_d 
);
update t_service_labor	a	LEFT JOIN tmp_diag_opd d ON a.HOSPCODE =d.HOSPCODE AND a.PID=d.PID AND a.SEQ=d.SEQ  
SET a.diagcode=d.diagcode , a.diagtype=d.diagtype
WHERE d.diagtype in(1);



DROP  TABLE IF EXISTS  t_anc_labor;
CREATE  TABLE IF NOT EXISTS t_anc_labor (INDEX(HOSPCODE,pid,seq)) 
ENGINE=MyISAM  AS 
(
SELECT 
 a.HOSPCODE,a.pid,s.cid,s.sex,a.seq,a.date_serv,s.INSTYPE,s.LABOR, s.NATION,nationcodeaec,s.labor_group
FROM tmp_anc a 
				INNER JOIN t_service_labor s ON a.HOSPCODE =s.HOSPCODE AND a.PID=s.PID	AND a.SEQ=s.SEQ	
	WHERE  a.date_serv BETWEEN @start_d AND @end_d 
);


DROP  TABLE IF EXISTS  tmp_postnatal;
CREATE  TABLE IF NOT EXISTS tmp_postnatal (INDEX(HOSPCODE,pid,seq)) 
ENGINE=MyISAM  AS 
(
SELECT po.*,p.cid,p.nation,p.occupation_new occupat,p.birth,p.check_vhid vhid
FROM postnatal po LEFT JOIN t_person_db p ON po.hospcode=p.hospcode and po.pid=p.pid
WHERE po.BDATE BETWEEN @start_d AND @end_d
);

DROP  TABLE IF EXISTS  t_postnatal_labor;
CREATE  TABLE IF NOT EXISTS t_postnatal_labor (INDEX(HOSPCODE,pid,seq)) 
ENGINE=MyISAM  AS 
(
SELECT 
 a.HOSPCODE,a.pid,s.cid,s.sex,a.seq,a.BDATE,s.INSTYPE,s.LABOR, s.NATION,nationcodeaec,s.labor_group
FROM tmp_postnatal a 
				INNER JOIN t_service_labor s ON a.HOSPCODE =s.HOSPCODE AND a.PID=s.PID	AND a.SEQ=s.SEQ	
WHERE a.BDATE BETWEEN @start_d AND @end_d 
);

DROP  TABLE IF EXISTS  t_epi_labor;
CREATE  TABLE IF NOT EXISTS t_epi_labor (INDEX(HOSPCODE,pid,seq)) 
ENGINE=MyISAM  AS 
(
SELECT 
	a.HOSPCODE,a.pid,s.cid,s.sex,a.seq,a.date_serv,s.INSTYPE,s.LABOR, s.NATION,nationcodeaec,s.labor_group
FROM tmp_epi a 
				INNER JOIN t_service_labor s ON a.HOSPCODE =s.HOSPCODE AND a.PID=s.PID	AND a.SEQ=s.SEQ	
	WHERE a.date_serv BETWEEN @start_d AND @end_d 
);

DROP  TABLE IF EXISTS  t_fp_labor;
CREATE  TABLE IF NOT EXISTS t_fp_labor (INDEX(HOSPCODE,pid,seq)) 
ENGINE=MyISAM  AS 
(
SELECT 
 a.HOSPCODE,a.pid,s.cid,s.sex,a.seq,a.date_serv,s.INSTYPE,s.LABOR, s.NATION,nationcodeaec,s.labor_group
FROM tmp_fp a 
				INNER JOIN t_service_labor s ON a.HOSPCODE =s.HOSPCODE AND a.PID=s.PID	AND a.SEQ=s.SEQ	
WHERE a.date_serv BETWEEN @start_d AND @end_d
);
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.8496511;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:193;a:5:{i:0;s:32:"DROP PROCEDURE IF EXISTS t_refer";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.8496511;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:194;a:5:{i:0;s:32:"DROP PROCEDURE IF EXISTS t_refer";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.912051;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:196;a:5:{i:0;s:2406:"CREATE PROCEDURE t_refer()
 BEGIN 
SET @prov_c :='58';
SET	@id:= '28';
SET	@year_start:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@year_start-1,'1001');
SET @end_d:=concat(@year_start,'0930');

DROP TABLE IF EXISTS t_refer;
CREATE TABLE IF NOT EXISTS t_refer (INDEX(HOSPCODE,PID,date_serv)) 
ENGINE=MyISAM  AS 
(SELECT
hospcode,h.provcode prov ,c.zonecode zone,pid,cid,date_serv, 'opd' source,causeout,typeout,referouthosp,ho.provcode referoutprov ,c1.zonecode referzone
FROM
(
SELECT
s.hospcode,s.pid,s.date_serv,s.causeout,s.typeout,s.REFEROUTHOSP,CID
FROM
tmp_service s  
 WHERE s.typeout  in(3) 
AND DATE_FORMAT(s.date_serv,'%Y%m%d') BETWEEN @start_d AND @end_d
) o
INNER JOIN chospital h ON o.hospcode=h.hoscode
LEFT JOIN chospital ho ON o.referouthosp =ho.hoscode
LEFT JOIN cchangwat c ON h.provcode =c.changwatcode
LEFT JOIN cchangwat c1 ON ho.provcode =c1.changwatcode
WHERE
		h.hostype in(5,6,7,11,12,15) AND h.hdc_regist in(1)
);


DROP TABLES IF EXISTS tmpz_admission;
CREATE TABLE IF NOT EXISTS tmpz_admission (
KEY (cid),
KEY (hospcode),
KEY (pid),
KEY (datetime_admit),
KEY (datetime_disch),
KEY (instype),
KEY (TYPEIN),
KEY (REFERINHOSP),
KEY (DISCHSTATUS),
KEY (DISCHTYPE),
KEY (REFEROUTHOSP),
KEY (an),
KEY (hospcode,an)
) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		a.*,IF(DATEDIFF(DATETIME_DISCH,DATETIME_ADMIT)!=0,DATEDIFF(DATETIME_DISCH,DATETIME_ADMIT),1) as day,p.CID,p.nation
FROM
	admission a LEFT JOIN t_person_db p ON a.HOSPCODE=p.HOSPCODE AND a.PID=p.PID
WHERE	(DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d') BETWEEN @start_d1 AND @end_d OR DATE_FORMAT(DATETIME_DISCH,'%Y%m%d') BETWEEN @start_d1 AND @end_d)
);


INSERT IGNORE INTO t_refer(
SELECT
hospcode,h.provcode prov,c.zonecode,pid,cid,date_serv,'ipd',causeout,typeout,referouthosp,ho.provcode referoutprov ,c1.zonecode
FROM
(
SELECT
s.hospcode,s.AN pid,s.DATETIME_DISCH date_serv,s.causeout,s.DISCHTYPE typeout,s.REFEROUTHOSP,CID
FROM
tmpz_admission s  
 WHERE s.DISCHTYPE  in(4) 
AND DATE_FORMAT(s.DATETIME_DISCH,'%Y%m%d') BETWEEN @start_d1 AND @end_d
) o
INNER JOIN chospital h ON o.hospcode=h.hoscode
LEFT JOIN chospital ho ON o.referouthosp =ho.hoscode
LEFT JOIN cchangwat c ON h.provcode =c.changwatcode
LEFT JOIN cchangwat c1 ON ho.provcode =c1.changwatcode
WHERE
		h.hostype in(5,6,7,11,12,15) AND h.hdc_regist in(1)
);

 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.912051;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:197;a:5:{i:0;s:2406:"CREATE PROCEDURE t_refer()
 BEGIN 
SET @prov_c :='58';
SET	@id:= '28';
SET	@year_start:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@year_start-1,'1001');
SET @end_d:=concat(@year_start,'0930');

DROP TABLE IF EXISTS t_refer;
CREATE TABLE IF NOT EXISTS t_refer (INDEX(HOSPCODE,PID,date_serv)) 
ENGINE=MyISAM  AS 
(SELECT
hospcode,h.provcode prov ,c.zonecode zone,pid,cid,date_serv, 'opd' source,causeout,typeout,referouthosp,ho.provcode referoutprov ,c1.zonecode referzone
FROM
(
SELECT
s.hospcode,s.pid,s.date_serv,s.causeout,s.typeout,s.REFEROUTHOSP,CID
FROM
tmp_service s  
 WHERE s.typeout  in(3) 
AND DATE_FORMAT(s.date_serv,'%Y%m%d') BETWEEN @start_d AND @end_d
) o
INNER JOIN chospital h ON o.hospcode=h.hoscode
LEFT JOIN chospital ho ON o.referouthosp =ho.hoscode
LEFT JOIN cchangwat c ON h.provcode =c.changwatcode
LEFT JOIN cchangwat c1 ON ho.provcode =c1.changwatcode
WHERE
		h.hostype in(5,6,7,11,12,15) AND h.hdc_regist in(1)
);


DROP TABLES IF EXISTS tmpz_admission;
CREATE TABLE IF NOT EXISTS tmpz_admission (
KEY (cid),
KEY (hospcode),
KEY (pid),
KEY (datetime_admit),
KEY (datetime_disch),
KEY (instype),
KEY (TYPEIN),
KEY (REFERINHOSP),
KEY (DISCHSTATUS),
KEY (DISCHTYPE),
KEY (REFEROUTHOSP),
KEY (an),
KEY (hospcode,an)
) ENGINE=MyISAM  AS(
SELECT SQL_BIG_RESULT 
		a.*,IF(DATEDIFF(DATETIME_DISCH,DATETIME_ADMIT)!=0,DATEDIFF(DATETIME_DISCH,DATETIME_ADMIT),1) as day,p.CID,p.nation
FROM
	admission a LEFT JOIN t_person_db p ON a.HOSPCODE=p.HOSPCODE AND a.PID=p.PID
WHERE	(DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d') BETWEEN @start_d1 AND @end_d OR DATE_FORMAT(DATETIME_DISCH,'%Y%m%d') BETWEEN @start_d1 AND @end_d)
);


INSERT IGNORE INTO t_refer(
SELECT
hospcode,h.provcode prov,c.zonecode,pid,cid,date_serv,'ipd',causeout,typeout,referouthosp,ho.provcode referoutprov ,c1.zonecode
FROM
(
SELECT
s.hospcode,s.AN pid,s.DATETIME_DISCH date_serv,s.causeout,s.DISCHTYPE typeout,s.REFEROUTHOSP,CID
FROM
tmpz_admission s  
 WHERE s.DISCHTYPE  in(4) 
AND DATE_FORMAT(s.DATETIME_DISCH,'%Y%m%d') BETWEEN @start_d1 AND @end_d
) o
INNER JOIN chospital h ON o.hospcode=h.hoscode
LEFT JOIN chospital ho ON o.referouthosp =ho.hoscode
LEFT JOIN cchangwat c ON h.provcode =c.changwatcode
LEFT JOIN cchangwat c1 ON ho.provcode =c1.changwatcode
WHERE
		h.hostype in(5,6,7,11,12,15) AND h.hdc_regist in(1)
);

 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.9744511;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:199;a:5:{i:0;s:39:"DROP PROCEDURE IF EXISTS t_childdev1830";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988052.9744511;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:200;a:5:{i:0;s:39:"DROP PROCEDURE IF EXISTS t_childdev1830";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.021251;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:202;a:5:{i:0;s:5594:"CREATE PROCEDURE t_childdev1830()
 BEGIN 
SET @prov_c :='58';
SET	@id:= '29';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
SET @begin_d=DATE_ADD(@start_d,INTERVAL -30 month);
SET @begin_d1=DATE_ADD(@start_d,INTERVAL -1 month);
SET @end_d1:=concat(@b_year,'1030');

DROP TABLE IF EXISTS t_childdev1830;
CREATE TABLE  IF NOT EXISTS t_childdev1830(INDEX (hospcode,pid,cid)) ENGINE=MyISAM  AS  
(SELECT
 p.HOSPCODE,p.PID,p.CID,p.BIRTH,p.check_vhid AREACODE,p.check_typearea TYPEAREA
, if(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d) in(18,30),1,0) M10
, IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 1 MONTH) in(18,30),1,0) M11
, if(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 2 MONTH) in(18,30),1,0) M12
, if(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 3 MONTH) in(18,30),1,0) M01
, if(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 4 MONTH) in(18,30),1,0) M02
, if(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 5 MONTH) in(18,30),1,0) M03
, if(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 6 MONTH) in(18,30),1,0) M04
, if(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 7 MONTH) in(18,30),1,0) M05
, if(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 8 MONTH) in(18,30),1,0) M06
, if(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 9 MONTH) in(18,30),1,0) M07
, if(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 10 MONTH) in(18,30),1,0) M08
, if(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 11 MONTH) in(18,30),1,0) M09

,IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d) in(18),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 1 MONTH) in(18),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 2 MONTH) in(18),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 3 MONTH) in(18),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 4 MONTH) in(18),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 5 MONTH) in(18),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 6 MONTH) in(18),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 7 MONTH) in(18),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 8 MONTH) in(18),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 9 MONTH) in(18),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 10 MONTH) in(18),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 11 MONTH) in(18),1,
   0))))))))))))  AGE_18
,IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d) in(30),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 1 MONTH) in(30),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 2 MONTH) in(30),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 3 MONTH) in(30),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 4 MONTH) in(30),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 5 MONTH) in(30),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 6 MONTH) in(30),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 7 MONTH) in(30),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 8 MONTH) in(30),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 9 MONTH) in(30),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 10 MONTH) in(30),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 11 MONTH) in(30),1,
   0))))))))))))  AGE_30

, STR_TO_DATE('0000000','%Y%m%d') DATE_SERV
,0 AGE_SERV
,0 PASS
, STR_TO_DATE('0000000','%Y%m%d') DATE_START
, STR_TO_DATE('0000000','%Y%m%d') DATE_END
FROM t_person_cid  p
WHERE BIRTH BETWEEN @begin_d AND @end_d AND
						check_typearea in('1','3') AND p.DISCHARGE='9' AND LENGTH(trim(p.CID))=13 AND  
						(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d) IN(18,30) OR 
							TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d + INTERVAL 1 MONTH) IN(18,30) OR 
							TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d + INTERVAL 2 MONTH) IN(18,30) OR 
							TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d + INTERVAL 3 MONTH) IN(18,30) OR 
							TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d + INTERVAL 4 MONTH) IN(18,30) OR 
							TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d + INTERVAL 5 MONTH) IN(18,30) OR 
							TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d + INTERVAL 6 MONTH) IN(18,30) OR 
							TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d + INTERVAL 7 MONTH) IN(18,30) OR 
							TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d + INTERVAL 8 MONTH) IN(18,30) OR 
							TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d + INTERVAL 9 MONTH) IN(18,30) OR 
							TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d + INTERVAL 10 MONTH) IN(18,30) OR 
							TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d + INTERVAL 11 MONTH) IN(18,30) 
						)
);
UPDATE t_childdev1830 SET date_serv=NULL , date_start=NULL ,date_end=NULL  WHERE DATE_FORMAT(date_serv,'%Y%m%d')='00000000';
UPDATE  t_childdev1830 SET date_start=DATE_ADD(BIRTH,INTERVAL 18 month) ,date_end=DATE_ADD(DATE_ADD(BIRTH,INTERVAL 19 month),INTERVAL -1 DAY)  WHERE age_18=1;
UPDATE  t_childdev1830 SET date_start=DATE_ADD(BIRTH,INTERVAL 30 month) ,date_end=DATE_ADD(DATE_ADD(BIRTH,INTERVAL 31 month),INTERVAL -1 DAY)  WHERE age_30=1;

DROP TEMPORARY  TABLE IF EXISTS tmz_nutrition;
CREATE TEMPORARY TABLE tmz_nutrition(INDEX (cid)) ENGINE=MyISAM  AS  
(SELECT p.HOSPCODE,p.PID,p.cid,n1.DATE_SERV
		FROM nutrition n1 INNER JOIN person p ON  p.HOSPCODE =n1.HOSPCODE AND p.PID=n1.PID
		WHERE  n1.CHILDDEVELOP in(SELECT id_childdevelop FROM cchilddevelop)  
		AND n1.date_serv  BETWEEN @begin_d1  AND @end_d1
);
UPDATE  t_childdev1830 c INNER JOIN tmz_nutrition	n ON n.cid=c.cid  SET c.date_serv=n.DATE_SERV 
,c.age_serv=TIMESTAMPDIFF(MONTH,c.BIRTH,n.DATE_SERV),c.pass=1
WHERE  TIMESTAMPDIFF(MONTH,c.BIRTH,n.DATE_SERV) IN(18,30) ; 

DROP TEMPORARY TABLE tmz_nutrition;

 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.021251;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:203;a:5:{i:0;s:5594:"CREATE PROCEDURE t_childdev1830()
 BEGIN 
SET @prov_c :='58';
SET	@id:= '29';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
SET @begin_d=DATE_ADD(@start_d,INTERVAL -30 month);
SET @begin_d1=DATE_ADD(@start_d,INTERVAL -1 month);
SET @end_d1:=concat(@b_year,'1030');

DROP TABLE IF EXISTS t_childdev1830;
CREATE TABLE  IF NOT EXISTS t_childdev1830(INDEX (hospcode,pid,cid)) ENGINE=MyISAM  AS  
(SELECT
 p.HOSPCODE,p.PID,p.CID,p.BIRTH,p.check_vhid AREACODE,p.check_typearea TYPEAREA
, if(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d) in(18,30),1,0) M10
, IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 1 MONTH) in(18,30),1,0) M11
, if(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 2 MONTH) in(18,30),1,0) M12
, if(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 3 MONTH) in(18,30),1,0) M01
, if(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 4 MONTH) in(18,30),1,0) M02
, if(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 5 MONTH) in(18,30),1,0) M03
, if(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 6 MONTH) in(18,30),1,0) M04
, if(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 7 MONTH) in(18,30),1,0) M05
, if(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 8 MONTH) in(18,30),1,0) M06
, if(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 9 MONTH) in(18,30),1,0) M07
, if(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 10 MONTH) in(18,30),1,0) M08
, if(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 11 MONTH) in(18,30),1,0) M09

,IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d) in(18),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 1 MONTH) in(18),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 2 MONTH) in(18),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 3 MONTH) in(18),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 4 MONTH) in(18),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 5 MONTH) in(18),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 6 MONTH) in(18),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 7 MONTH) in(18),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 8 MONTH) in(18),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 9 MONTH) in(18),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 10 MONTH) in(18),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 11 MONTH) in(18),1,
   0))))))))))))  AGE_18
,IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d) in(30),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 1 MONTH) in(30),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 2 MONTH) in(30),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 3 MONTH) in(30),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 4 MONTH) in(30),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 5 MONTH) in(30),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 6 MONTH) in(30),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 7 MONTH) in(30),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 8 MONTH) in(30),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 9 MONTH) in(30),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 10 MONTH) in(30),1,
IF(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d+ INTERVAL 11 MONTH) in(30),1,
   0))))))))))))  AGE_30

, STR_TO_DATE('0000000','%Y%m%d') DATE_SERV
,0 AGE_SERV
,0 PASS
, STR_TO_DATE('0000000','%Y%m%d') DATE_START
, STR_TO_DATE('0000000','%Y%m%d') DATE_END
FROM t_person_cid  p
WHERE BIRTH BETWEEN @begin_d AND @end_d AND
						check_typearea in('1','3') AND p.DISCHARGE='9' AND LENGTH(trim(p.CID))=13 AND  
						(TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d) IN(18,30) OR 
							TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d + INTERVAL 1 MONTH) IN(18,30) OR 
							TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d + INTERVAL 2 MONTH) IN(18,30) OR 
							TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d + INTERVAL 3 MONTH) IN(18,30) OR 
							TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d + INTERVAL 4 MONTH) IN(18,30) OR 
							TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d + INTERVAL 5 MONTH) IN(18,30) OR 
							TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d + INTERVAL 6 MONTH) IN(18,30) OR 
							TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d + INTERVAL 7 MONTH) IN(18,30) OR 
							TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d + INTERVAL 8 MONTH) IN(18,30) OR 
							TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d + INTERVAL 9 MONTH) IN(18,30) OR 
							TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d + INTERVAL 10 MONTH) IN(18,30) OR 
							TIMESTAMPDIFF(MONTH,p.BIRTH,@start_d + INTERVAL 11 MONTH) IN(18,30) 
						)
);
UPDATE t_childdev1830 SET date_serv=NULL , date_start=NULL ,date_end=NULL  WHERE DATE_FORMAT(date_serv,'%Y%m%d')='00000000';
UPDATE  t_childdev1830 SET date_start=DATE_ADD(BIRTH,INTERVAL 18 month) ,date_end=DATE_ADD(DATE_ADD(BIRTH,INTERVAL 19 month),INTERVAL -1 DAY)  WHERE age_18=1;
UPDATE  t_childdev1830 SET date_start=DATE_ADD(BIRTH,INTERVAL 30 month) ,date_end=DATE_ADD(DATE_ADD(BIRTH,INTERVAL 31 month),INTERVAL -1 DAY)  WHERE age_30=1;

DROP TEMPORARY  TABLE IF EXISTS tmz_nutrition;
CREATE TEMPORARY TABLE tmz_nutrition(INDEX (cid)) ENGINE=MyISAM  AS  
(SELECT p.HOSPCODE,p.PID,p.cid,n1.DATE_SERV
		FROM nutrition n1 INNER JOIN person p ON  p.HOSPCODE =n1.HOSPCODE AND p.PID=n1.PID
		WHERE  n1.CHILDDEVELOP in(SELECT id_childdevelop FROM cchilddevelop)  
		AND n1.date_serv  BETWEEN @begin_d1  AND @end_d1
);
UPDATE  t_childdev1830 c INNER JOIN tmz_nutrition	n ON n.cid=c.cid  SET c.date_serv=n.DATE_SERV 
,c.age_serv=TIMESTAMPDIFF(MONTH,c.BIRTH,n.DATE_SERV),c.pass=1
WHERE  TIMESTAMPDIFF(MONTH,c.BIRTH,n.DATE_SERV) IN(18,30) ; 

DROP TEMPORARY TABLE tmz_nutrition;

 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.0836511;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:205;a:5:{i:0;s:38:"DROP PROCEDURE IF EXISTS t_cmi_referin";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.0836511;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:206;a:5:{i:0;s:38:"DROP PROCEDURE IF EXISTS t_cmi_referin";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.130451;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:208;a:5:{i:0;s:1231:"CREATE PROCEDURE t_cmi_referin()
 BEGIN 
SET @prov_c :='58';
SET @id:= '30';
SET @year_start:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@year_start-1,'1001');
SET @end_d:=concat(@year_start,'0930');


DROP TABLE IF EXISTS t_cmi_referin;
CREATE TABLE IF NOT EXISTS t_cmi_referin (INDEX(monthly,hospcode,referin,drg)) 
		ENGINE=MyISAM  AS 
		(select @year_start as byear,DATE_FORMAT(t.DATETIME_DISCH,'%Y%m')  as monthly,t.HOSPCODE as hospcode, 
						a.chwcode, a.region, a.splevel, 
						t.REFERINHOSP as referin, b.hostype as refer_hostype, b.provcode as refer_prov, c.zonecode as refer_region,
						t.DRG as drg, count(t.AN) as cases, sum(t.ADJRW) as sum_adjrw,
						sum(if(t.ADJRW=0,1,0)) as adjrw0, t.RW as rw
						from tmp_admission t join (select t.hcode, t.hname, t.chwcode, t.chwname, t.region, t.splevel
										from ccmihosp t where t.byear = @year_start+543) a on t.HOSPCODE = a.hcode
										join chospital b on t.REFERINHOSP = b.hoscode
										join cchangwat c on b.provcode=c.changwatcode
						where t.REFERINHOSP != ''	AND DATE_FORMAT(t.DATETIME_DISCH,'%Y%m%d') BETWEEN @start_d AND @end_d
						group by t.HOSPCODE,monthly, t.REFERINHOSP, t.DRG
) ;

 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.1460509;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:209;a:5:{i:0;s:1231:"CREATE PROCEDURE t_cmi_referin()
 BEGIN 
SET @prov_c :='58';
SET @id:= '30';
SET @year_start:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@year_start-1,'1001');
SET @end_d:=concat(@year_start,'0930');


DROP TABLE IF EXISTS t_cmi_referin;
CREATE TABLE IF NOT EXISTS t_cmi_referin (INDEX(monthly,hospcode,referin,drg)) 
		ENGINE=MyISAM  AS 
		(select @year_start as byear,DATE_FORMAT(t.DATETIME_DISCH,'%Y%m')  as monthly,t.HOSPCODE as hospcode, 
						a.chwcode, a.region, a.splevel, 
						t.REFERINHOSP as referin, b.hostype as refer_hostype, b.provcode as refer_prov, c.zonecode as refer_region,
						t.DRG as drg, count(t.AN) as cases, sum(t.ADJRW) as sum_adjrw,
						sum(if(t.ADJRW=0,1,0)) as adjrw0, t.RW as rw
						from tmp_admission t join (select t.hcode, t.hname, t.chwcode, t.chwname, t.region, t.splevel
										from ccmihosp t where t.byear = @year_start+543) a on t.HOSPCODE = a.hcode
										join chospital b on t.REFERINHOSP = b.hoscode
										join cchangwat c on b.provcode=c.changwatcode
						where t.REFERINHOSP != ''	AND DATE_FORMAT(t.DATETIME_DISCH,'%Y%m%d') BETWEEN @start_d AND @end_d
						group by t.HOSPCODE,monthly, t.REFERINHOSP, t.DRG
) ;

 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.192852;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:211;a:5:{i:0;s:39:"DROP PROCEDURE IF EXISTS ws_person_dmht";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.192852;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:212;a:5:{i:0;s:39:"DROP PROCEDURE IF EXISTS ws_person_dmht";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.2552519;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:214;a:5:{i:0;s:3370:"CREATE PROCEDURE ws_person_dmht()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '31';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

CREATE TABLE IF NOT EXISTS ws_person_dmht(
  provcode varchar(2) not null,
  cid varchar(13) not null,
  flag_sent varchar(1) DEFAULT '0',
  type_dx int(1) DEFAULT '0',
	last_hba1c decimal(10,2) DEFAULT 0.00,
  date_serv_hba1c date,
  hba1c_hosp VARCHAR(5),
	last_fpg decimal(10,2) DEFAULT 0.00,
  date_serv_fpg date,
	fpg_hosp VARCHAR(5),
  last_sbp int(3) DEFAULT 0,
  last_dbp int(3) DEFAULT 0,
  date_serv_bp date,
	bp_hosp VARCHAR(5),
PRIMARY KEY (provcode,cid),
KEY (cid)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

CREATE TABLE IF NOT EXISTS ws_delete(
  provcode varchar(2) not null,
  cid varchar(13) not null,
  flag_sent varchar(1) DEFAULT '0',
  ws_table varchar(150) not null,
PRIMARY KEY (provcode,cid,ws_table),
KEY (provcode),
KEY (cid),
KEY (ws_table)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

DELETE FROM ws_delete WHERE flag_sent='2';

#ลบกรณีเปลี่ยนการวินิจฉัย;
DROP TEMPORARY TABLE IF EXISTS tmz_ws_cid_del;
CREATE TEMPORARY TABLE  IF NOT EXISTS tmz_ws_cid_del (PRIMARY KEY (CID)) 
ENGINE=MyISAM  AS 
(
SELECT
m.cid
FROM ws_person_dmht m LEFT JOIN t_dmht d ON m.cid=d.cid 
WHERE  d.cid is NULL
);

INSERT IGNORE INTO  ws_delete (SELECT @prov_c,cid,'0','ws_person_dmht' FROM  tmz_ws_cid_del);
DELETE FROM ws_person_dmht  WHERE cid in(SELECT cid FROM tmz_ws_cid_del ) ;

#สร้างตัวเปรียบเทียบเฉพาะที่ข้อมูลไม่ตรงกันให้แทนที่ หากเท่ากันทุก filed ไม่ต้องทำอะไร;
DROP TEMPORARY TABLE IF EXISTS tmz_ws_cid_prompt;
CREATE TEMPORARY TABLE  IF NOT EXISTS tmz_ws_cid_prompt (PRIMARY KEY (CID)) 
ENGINE=MyISAM  AS 
(
SELECT SQL_BIG_RESULT 
			@prov_c provcode
			,cid
			,type_dx 
			,rs_hba1c last_hba1c 
			,ld_hba1c date_serv_hba1c 
			,ih_hba1c  hba1c_hosp
			,rs_fpg1 last_fpg 
			,ld_fpg1 date_serv_fpg 
			,ih_fpg1  fpg_hosp
			,rs_bps1 last_sbp
			,rs_bpd1 last_dbp
			,ld_bp1 date_serv_bp
			,ih_bp1  bp_hosp
FROM 
		t_dmht
WHERE mod11(cid)=1 
				AND (SUBSTR(cid,1,6) not in(SELECT CONCAT('0',hoscode) FROM chospital WHERE provcode in(@prov_c))  
				AND SUBSTR(cid,1,5) not in(SELECT hoscode FROM chospital WHERE provcode in(@prov_c)))
);
#REPLACE ON Change OR Not found;
REPLACE  INTO ws_person_dmht (
SELECT SQL_BIG_RESULT
			p.provcode
			,p.cid
			,'0'
			,p.type_dx 
			,p.last_hba1c 
			,p.date_serv_hba1c 
			,p.hba1c_hosp
			,p.last_fpg 
			,p.date_serv_fpg 
			,p.fpg_hosp
			,p.last_sbp
			,p.last_dbp
			,p.date_serv_bp
			,p.bp_hosp
FROM
		tmz_ws_cid_prompt p LEFT JOIN ws_person_dmht d ON p.cid=d.cid
WHERE 
		d.cid IS NULL
		OR p.type_dx != d.type_dx  
		OR p.last_hba1c != d.last_hba1c 
		OR p.date_serv_hba1c != d.date_serv_hba1c 
		OR p.hba1c_hosp != d.hba1c_hosp 		
		OR p.last_fpg != d.last_fpg 
		OR p.date_serv_fpg != d.date_serv_fpg 
		OR p.fpg_hosp != d.fpg_hosp 		
		OR p.last_sbp != d.last_sbp 
		OR p.last_dbp != d.last_dbp
		OR p.date_serv_bp != d.date_serv_bp
		OR p.bp_hosp != d.bp_hosp 		

 );
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.2552519;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:215;a:5:{i:0;s:3370:"CREATE PROCEDURE ws_person_dmht()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '31';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

CREATE TABLE IF NOT EXISTS ws_person_dmht(
  provcode varchar(2) not null,
  cid varchar(13) not null,
  flag_sent varchar(1) DEFAULT '0',
  type_dx int(1) DEFAULT '0',
	last_hba1c decimal(10,2) DEFAULT 0.00,
  date_serv_hba1c date,
  hba1c_hosp VARCHAR(5),
	last_fpg decimal(10,2) DEFAULT 0.00,
  date_serv_fpg date,
	fpg_hosp VARCHAR(5),
  last_sbp int(3) DEFAULT 0,
  last_dbp int(3) DEFAULT 0,
  date_serv_bp date,
	bp_hosp VARCHAR(5),
PRIMARY KEY (provcode,cid),
KEY (cid)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

CREATE TABLE IF NOT EXISTS ws_delete(
  provcode varchar(2) not null,
  cid varchar(13) not null,
  flag_sent varchar(1) DEFAULT '0',
  ws_table varchar(150) not null,
PRIMARY KEY (provcode,cid,ws_table),
KEY (provcode),
KEY (cid),
KEY (ws_table)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

DELETE FROM ws_delete WHERE flag_sent='2';

#ลบกรณีเปลี่ยนการวินิจฉัย;
DROP TEMPORARY TABLE IF EXISTS tmz_ws_cid_del;
CREATE TEMPORARY TABLE  IF NOT EXISTS tmz_ws_cid_del (PRIMARY KEY (CID)) 
ENGINE=MyISAM  AS 
(
SELECT
m.cid
FROM ws_person_dmht m LEFT JOIN t_dmht d ON m.cid=d.cid 
WHERE  d.cid is NULL
);

INSERT IGNORE INTO  ws_delete (SELECT @prov_c,cid,'0','ws_person_dmht' FROM  tmz_ws_cid_del);
DELETE FROM ws_person_dmht  WHERE cid in(SELECT cid FROM tmz_ws_cid_del ) ;

#สร้างตัวเปรียบเทียบเฉพาะที่ข้อมูลไม่ตรงกันให้แทนที่ หากเท่ากันทุก filed ไม่ต้องทำอะไร;
DROP TEMPORARY TABLE IF EXISTS tmz_ws_cid_prompt;
CREATE TEMPORARY TABLE  IF NOT EXISTS tmz_ws_cid_prompt (PRIMARY KEY (CID)) 
ENGINE=MyISAM  AS 
(
SELECT SQL_BIG_RESULT 
			@prov_c provcode
			,cid
			,type_dx 
			,rs_hba1c last_hba1c 
			,ld_hba1c date_serv_hba1c 
			,ih_hba1c  hba1c_hosp
			,rs_fpg1 last_fpg 
			,ld_fpg1 date_serv_fpg 
			,ih_fpg1  fpg_hosp
			,rs_bps1 last_sbp
			,rs_bpd1 last_dbp
			,ld_bp1 date_serv_bp
			,ih_bp1  bp_hosp
FROM 
		t_dmht
WHERE mod11(cid)=1 
				AND (SUBSTR(cid,1,6) not in(SELECT CONCAT('0',hoscode) FROM chospital WHERE provcode in(@prov_c))  
				AND SUBSTR(cid,1,5) not in(SELECT hoscode FROM chospital WHERE provcode in(@prov_c)))
);
#REPLACE ON Change OR Not found;
REPLACE  INTO ws_person_dmht (
SELECT SQL_BIG_RESULT
			p.provcode
			,p.cid
			,'0'
			,p.type_dx 
			,p.last_hba1c 
			,p.date_serv_hba1c 
			,p.hba1c_hosp
			,p.last_fpg 
			,p.date_serv_fpg 
			,p.fpg_hosp
			,p.last_sbp
			,p.last_dbp
			,p.date_serv_bp
			,p.bp_hosp
FROM
		tmz_ws_cid_prompt p LEFT JOIN ws_person_dmht d ON p.cid=d.cid
WHERE 
		d.cid IS NULL
		OR p.type_dx != d.type_dx  
		OR p.last_hba1c != d.last_hba1c 
		OR p.date_serv_hba1c != d.date_serv_hba1c 
		OR p.hba1c_hosp != d.hba1c_hosp 		
		OR p.last_fpg != d.last_fpg 
		OR p.date_serv_fpg != d.date_serv_fpg 
		OR p.fpg_hosp != d.fpg_hosp 		
		OR p.last_sbp != d.last_sbp 
		OR p.last_dbp != d.last_dbp
		OR p.date_serv_bp != d.date_serv_bp
		OR p.bp_hosp != d.bp_hosp 		

 );
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.317652;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:217;a:5:{i:0;s:44:"DROP PROCEDURE IF EXISTS ws_person_nutrition";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.317652;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:218;a:5:{i:0;s:44:"DROP PROCEDURE IF EXISTS ws_person_nutrition";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.3800521;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:220;a:5:{i:0;s:4575:"CREATE PROCEDURE ws_person_nutrition()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '32';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
DROP TABLE IF EXISTS t_obes;
CREATE TABLE IF NOT EXISTS t_obes 
(
cid VARCHAR(13) NOT NULL,
sex VARCHAR(1) NOT NULL DEFAULT '0',
birth date,
age_y VARCHAR(3) NOT NULL DEFAULT '0',
hospcode VARCHAR(5) DEFAULT NULL,
date_serv date ,
weight decimal(5,1) NOT NULL DEFAULT '0',
height int(3) NOT NULL DEFAULT '0',
waist_cm int(3) NOT NULL DEFAULT '0',
bmi decimal(10,1) NOT NULL DEFAULT '0',
nutri_level int(1) NOT NULL DEFAULT '0',
bmi_id int(1) NOT NULL DEFAULT '0',
PRIMARY KEY (cid)
) ENGINE MyISAM DEFAULT CHARACTER SET=utf8 ;

/*INSERT*/
INSERT IGNORE INTO  t_obes(cid)
SELECT
n.cid
FROM
tmp_nutrition n
WHERE
mod11(n.cid) =1 AND TIMESTAMPDIFF(YEAR,DATE_SERV,now()) <6;

INSERT IGNORE INTO  t_obes(cid)
SELECT
n.cid
FROM
t_ncdscreen n
WHERE
mod11(n.cid) =1 AND TIMESTAMPDIFF(YEAR,DATE_SERV,now()) <6;

INSERT IGNORE INTO  t_obes(cid)
SELECT
n.cid
FROM
tmp_chronicfu n
WHERE
mod11(n.cid) =1 AND TIMESTAMPDIFF(YEAR,DATE_SERV,now()) <6;

/*update from nutrition*/
UPDATE  t_obes o , (
SELECT
cid,hospcode,date_serv,height,weight
FROM
tmp_nutrition 
WHERE
mod11(cid) =1 AND TIMESTAMPDIFF(YEAR,DATE_SERV,now()) <6
ORDER BY date_serv DESC 
 )  n  
SET  o.hospcode=n.hospcode ,o.date_serv=n.date_serv,o.height=n.height,o.weight=n.weight
WHERE o.cid=n.cid;


/*UPDATE FROM ncdscreen*/
UPDATE  t_obes o , (
SELECT
cid,hospcode,date_serv,height,weight,waist_cm
FROM
t_ncdscreen 
WHERE
mod11(cid) =1 AND TIMESTAMPDIFF(YEAR,DATE_SERV,now()) <6
ORDER BY date_serv DESC 
 )  n 
SET  o.hospcode=n.hospcode ,o.date_serv=n.date_serv,o.height=n.height,o.weight=n.weight,o.waist_cm=n.waist_cm
WHERE o.cid=n.cid;

/*INSERT FROM chronicfu*/
UPDATE  t_obes o , (
SELECT
cid,hospcode,date_serv,height,weight,waist_cm
FROM
tmp_chronicfu 
WHERE
mod11(cid) =1 AND TIMESTAMPDIFF(YEAR,DATE_SERV,now()) <6
ORDER BY date_serv DESC 
 )  n 
SET  o.hospcode=n.hospcode ,o.date_serv=n.date_serv,o.height=n.height,o.weight=n.weight,o.waist_cm=n.waist_cm
WHERE o.cid=n.cid;

UPDATE t_obes  o INNER JOIN person  p ON o.cid=p.cid SET o.sex=p.sex
,o.age_y=TIMESTAMPDIFF(year,p.BIRTH,o.date_serv)
,o.birth=p.BIRTH
WHERE p.BIRTH < NOW() AND p.DISCHARGE =9;

DELETE FROM t_obes WHERE sex not in(1,2);

UPDATE t_obes o ,(
SELECT
cid
,IFNULL(nutri_cal(TIMESTAMPDIFF(MONTH,birth,date_serv),SEX,3,height,weight),0) nutri_level
FROM
t_obes
WHERE age_y BETWEEN 0 AND 18
) w SET o.nutri_level=w.nutri_level
WHERE o.cid=w.cid;


UPDATE t_obes SET  BMI= IFNULL(round(weight/((height/100)*(height/100)),2),0)
WHERE age_y>18;

UPDATE t_obes SET  BMI= IFNULL(round(weight/((height/100)*(height/100)),2),0)
WHERE nutri_level=0 OR bmi=0;

DELETE FROM t_obes WHERE height=0 OR weight=0;
DELETE FROM t_obes WHERE date_serv < birth;
DELETE FROM t_obes WHERE TIMESTAMPDIFF(YEAR,birth,NOW()) > 120;
DELETE FROM t_obes WHERE bmi >200;
DELETE FROM t_obes WHERE substr(cid,2,5) in(SELECT hoscode FROM chospital WHERE provcode =@prov_c);
DELETE FROM t_obes WHERE substr(cid,1,5) in(SELECT hoscode FROM chospital WHERE provcode =@prov_c);

UPDATE t_obes o , cbmi_result r  SET o.bmi_id = r.bmi_id  WHERE o.bmi BETWEEN  r.min AND r.max ;
CREATE TABLE IF NOT EXISTS ws_person_nutrition
(
provcode VARCHAR(2) NOT NULL,
cid VARCHAR(13) NOT NULL,
flag_sent VARCHAR(1) NOT NULL DEFAULT '0',
sex VARCHAR(1) NOT NULL,
birth date,
age_y VARCHAR(3) NOT NULL,
hospcode VARCHAR(5) DEFAULT NULL,
date_serv date ,
weight decimal(5,1) NOT NULL DEFAULT '0',
height int(3) NOT NULL DEFAULT '0',
waist_cm int(3) NOT NULL DEFAULT '0',
bmi decimal(10,1) NOT NULL DEFAULT '0',
bmi_result varchar(255) NOT NULL DEFAULT '',
nutri_level int(1) NOT NULL DEFAULT '0',
nutri_result varchar(255) NOT NULL DEFAULT '',
PRIMARY KEY (provcode,cid)
) ENGINE MyISAM DEFAULT CHARACTER SET=utf8 ;

DELETE w  FROM ws_person_nutrition w INNER JOIN t_obes o ON w.cid=o.cid 
WHERE o.hospcode !=w.hospcode OR o.date_serv != w.date_serv OR o.bmi !=w.bmi OR o.nutri_level != w.nutri_level;

INSERT IGNORE INTO ws_person_nutrition 
(
SELECT
@prov_c,o.cid,'0',o.sex,o.birth,o.age_y,o.hospcode,o.date_serv,o.weight,o.height,o.waist_cm,o.bmi, b.bmi_result ,o.nutri_level,n.nutri_name
FROM
	t_obes  o 
	LEFT JOIN cbmi_result b on o.bmi_id=b.bmi_id
	LEFT JOIN cnutri_result n on o.nutri_level=n.nutri_level
);

 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.3800521;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:221;a:5:{i:0;s:4575:"CREATE PROCEDURE ws_person_nutrition()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '32';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
DROP TABLE IF EXISTS t_obes;
CREATE TABLE IF NOT EXISTS t_obes 
(
cid VARCHAR(13) NOT NULL,
sex VARCHAR(1) NOT NULL DEFAULT '0',
birth date,
age_y VARCHAR(3) NOT NULL DEFAULT '0',
hospcode VARCHAR(5) DEFAULT NULL,
date_serv date ,
weight decimal(5,1) NOT NULL DEFAULT '0',
height int(3) NOT NULL DEFAULT '0',
waist_cm int(3) NOT NULL DEFAULT '0',
bmi decimal(10,1) NOT NULL DEFAULT '0',
nutri_level int(1) NOT NULL DEFAULT '0',
bmi_id int(1) NOT NULL DEFAULT '0',
PRIMARY KEY (cid)
) ENGINE MyISAM DEFAULT CHARACTER SET=utf8 ;

/*INSERT*/
INSERT IGNORE INTO  t_obes(cid)
SELECT
n.cid
FROM
tmp_nutrition n
WHERE
mod11(n.cid) =1 AND TIMESTAMPDIFF(YEAR,DATE_SERV,now()) <6;

INSERT IGNORE INTO  t_obes(cid)
SELECT
n.cid
FROM
t_ncdscreen n
WHERE
mod11(n.cid) =1 AND TIMESTAMPDIFF(YEAR,DATE_SERV,now()) <6;

INSERT IGNORE INTO  t_obes(cid)
SELECT
n.cid
FROM
tmp_chronicfu n
WHERE
mod11(n.cid) =1 AND TIMESTAMPDIFF(YEAR,DATE_SERV,now()) <6;

/*update from nutrition*/
UPDATE  t_obes o , (
SELECT
cid,hospcode,date_serv,height,weight
FROM
tmp_nutrition 
WHERE
mod11(cid) =1 AND TIMESTAMPDIFF(YEAR,DATE_SERV,now()) <6
ORDER BY date_serv DESC 
 )  n  
SET  o.hospcode=n.hospcode ,o.date_serv=n.date_serv,o.height=n.height,o.weight=n.weight
WHERE o.cid=n.cid;


/*UPDATE FROM ncdscreen*/
UPDATE  t_obes o , (
SELECT
cid,hospcode,date_serv,height,weight,waist_cm
FROM
t_ncdscreen 
WHERE
mod11(cid) =1 AND TIMESTAMPDIFF(YEAR,DATE_SERV,now()) <6
ORDER BY date_serv DESC 
 )  n 
SET  o.hospcode=n.hospcode ,o.date_serv=n.date_serv,o.height=n.height,o.weight=n.weight,o.waist_cm=n.waist_cm
WHERE o.cid=n.cid;

/*INSERT FROM chronicfu*/
UPDATE  t_obes o , (
SELECT
cid,hospcode,date_serv,height,weight,waist_cm
FROM
tmp_chronicfu 
WHERE
mod11(cid) =1 AND TIMESTAMPDIFF(YEAR,DATE_SERV,now()) <6
ORDER BY date_serv DESC 
 )  n 
SET  o.hospcode=n.hospcode ,o.date_serv=n.date_serv,o.height=n.height,o.weight=n.weight,o.waist_cm=n.waist_cm
WHERE o.cid=n.cid;

UPDATE t_obes  o INNER JOIN person  p ON o.cid=p.cid SET o.sex=p.sex
,o.age_y=TIMESTAMPDIFF(year,p.BIRTH,o.date_serv)
,o.birth=p.BIRTH
WHERE p.BIRTH < NOW() AND p.DISCHARGE =9;

DELETE FROM t_obes WHERE sex not in(1,2);

UPDATE t_obes o ,(
SELECT
cid
,IFNULL(nutri_cal(TIMESTAMPDIFF(MONTH,birth,date_serv),SEX,3,height,weight),0) nutri_level
FROM
t_obes
WHERE age_y BETWEEN 0 AND 18
) w SET o.nutri_level=w.nutri_level
WHERE o.cid=w.cid;


UPDATE t_obes SET  BMI= IFNULL(round(weight/((height/100)*(height/100)),2),0)
WHERE age_y>18;

UPDATE t_obes SET  BMI= IFNULL(round(weight/((height/100)*(height/100)),2),0)
WHERE nutri_level=0 OR bmi=0;

DELETE FROM t_obes WHERE height=0 OR weight=0;
DELETE FROM t_obes WHERE date_serv < birth;
DELETE FROM t_obes WHERE TIMESTAMPDIFF(YEAR,birth,NOW()) > 120;
DELETE FROM t_obes WHERE bmi >200;
DELETE FROM t_obes WHERE substr(cid,2,5) in(SELECT hoscode FROM chospital WHERE provcode =@prov_c);
DELETE FROM t_obes WHERE substr(cid,1,5) in(SELECT hoscode FROM chospital WHERE provcode =@prov_c);

UPDATE t_obes o , cbmi_result r  SET o.bmi_id = r.bmi_id  WHERE o.bmi BETWEEN  r.min AND r.max ;
CREATE TABLE IF NOT EXISTS ws_person_nutrition
(
provcode VARCHAR(2) NOT NULL,
cid VARCHAR(13) NOT NULL,
flag_sent VARCHAR(1) NOT NULL DEFAULT '0',
sex VARCHAR(1) NOT NULL,
birth date,
age_y VARCHAR(3) NOT NULL,
hospcode VARCHAR(5) DEFAULT NULL,
date_serv date ,
weight decimal(5,1) NOT NULL DEFAULT '0',
height int(3) NOT NULL DEFAULT '0',
waist_cm int(3) NOT NULL DEFAULT '0',
bmi decimal(10,1) NOT NULL DEFAULT '0',
bmi_result varchar(255) NOT NULL DEFAULT '',
nutri_level int(1) NOT NULL DEFAULT '0',
nutri_result varchar(255) NOT NULL DEFAULT '',
PRIMARY KEY (provcode,cid)
) ENGINE MyISAM DEFAULT CHARACTER SET=utf8 ;

DELETE w  FROM ws_person_nutrition w INNER JOIN t_obes o ON w.cid=o.cid 
WHERE o.hospcode !=w.hospcode OR o.date_serv != w.date_serv OR o.bmi !=w.bmi OR o.nutri_level != w.nutri_level;

INSERT IGNORE INTO ws_person_nutrition 
(
SELECT
@prov_c,o.cid,'0',o.sex,o.birth,o.age_y,o.hospcode,o.date_serv,o.weight,o.height,o.waist_cm,o.bmi, b.bmi_result ,o.nutri_level,n.nutri_name
FROM
	t_obes  o 
	LEFT JOIN cbmi_result b on o.bmi_id=b.bmi_id
	LEFT JOIN cnutri_result n on o.nutri_level=n.nutri_level
);

 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.442452;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:223;a:5:{i:0;s:46:"DROP PROCEDURE IF EXISTS ws_person_drugallergy";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.442452;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:224;a:5:{i:0;s:46:"DROP PROCEDURE IF EXISTS ws_person_drugallergy";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.4892521;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:226;a:5:{i:0;s:2708:"CREATE PROCEDURE ws_person_drugallergy()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '33';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS t_drugallergy;
CREATE TABLE IF NOT EXISTS t_drugallergy (PRIMARY KEY (cid,drugallergy), KEY (cid)) ENGINE MyISAM AS
(SELECT DISTINCT
CID
,DRUGALLERGY
,c.Generic_Name DNAME_STD
/*,IF(INSTR(c.Generic_Name,'MG') ,SUBSTR(c.Generic_Name,1,INSTR(c.Generic_Name,'MG')+1),c.Generic_Name   ) DNAMEP*/
,SPACE(100) DNAMEP
,SPACE(100) DNAME
,DATERECORD
,d.HOSPCODE
FROM
drugallergy d INNER JOIN person p ON d.HOSPCODE=p.HOSPCODE AND d.PID=p.PID
INNER JOIN cdrug_std c ON d.DRUGALLERGY=c.didstd
WHERE mod11(cid)=1  
GROUP BY p.cid,c.didstd
);


UPDATE t_drugallergy SET DNAME_STD = REPLACE(DNAME_STD,' ','#');
UPDATE t_drugallergy SET DNAMEP = IF(INSTR(DNAME_STD,'MG') ,SUBSTR(DNAME_STD,1,INSTR(DNAME_STD,'MG')+1),DNAME_STD );
UPDATE t_drugallergy SET dnamep = repl_digits_pipe(DNAMEP);
UPDATE t_drugallergy SET DNAME = if(INSTR(DNAMEP,'|'),SUBSTR(DNAMEP ,1, INSTR(DNAMEP,'|')-1),DNAMEP);
UPDATE t_drugallergy SET DNAME = if(SUBSTR(DNAME,-1)='(', SUBSTR(DNAME,1,LENGTH(DNAME)-1) ,DNAME);




UPDATE t_drugallergy SET DNAME_STD = REPLACE(DNAME_STD,'#',' ') , DNAME =REPLACE(DNAME,'#',' ');

CREATE TABLE IF NOT EXISTS ws_person_drugallergy
(
provcode VARCHAR(2) NOT NULL,
cid VARCHAR(13) NOT NULL,
flag_sent VARCHAR(1) NOT NULL DEFAULT '0',
hospcode VARCHAR(5) DEFAULT NULL,
daterecode DATE,
didcode VARCHAR(24) NOT NULL DEFAULT ' ',
didname varchar(255) NOT NULL DEFAULT ' ',
PRIMARY KEY (provcode,cid,didcode)
) ENGINE MyISAM DEFAULT CHARACTER SET=utf8 ;

CREATE TABLE IF NOT EXISTS ws_delete(
  provcode varchar(2) not null,
  cid varchar(13) not null,
  flag_sent varchar(1) DEFAULT '0',
  ws_table varchar(150) not null,
PRIMARY KEY (provcode,cid,ws_table),
KEY (provcode),
KEY (cid),
KEY (ws_table)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

DELETE FROM ws_delete WHERE flag_sent='2';

#ลบกรณีลบ;
DROP TEMPORARY TABLE IF EXISTS tmz_ws_cid_del;
CREATE TEMPORARY TABLE  IF NOT EXISTS tmz_ws_cid_del (PRIMARY KEY (CID)) 
ENGINE=MyISAM  AS 
(
SELECT DISTINCT
m.cid
FROM ws_person_drugallergy m LEFT JOIN t_drugallergy d ON m.cid=d.cid 
WHERE  d.cid is NULL
);

INSERT IGNORE INTO  ws_delete (SELECT @prov_c,cid,'0','ws_person_drugallergy' FROM  tmz_ws_cid_del);

DELETE FROM ws_person_drugallergy  WHERE cid in(SELECT cid FROM tmz_ws_cid_del ) ;

INSERT IGNORE INTO ws_person_drugallergy 
(
SELECT
@prov_c,cid,'0',hospcode,DATERECORD,DRUGALLERGY,DNAME
FROM
	t_drugallergy 
);
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.4892521;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:227;a:5:{i:0;s:2708:"CREATE PROCEDURE ws_person_drugallergy()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '33';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS t_drugallergy;
CREATE TABLE IF NOT EXISTS t_drugallergy (PRIMARY KEY (cid,drugallergy), KEY (cid)) ENGINE MyISAM AS
(SELECT DISTINCT
CID
,DRUGALLERGY
,c.Generic_Name DNAME_STD
/*,IF(INSTR(c.Generic_Name,'MG') ,SUBSTR(c.Generic_Name,1,INSTR(c.Generic_Name,'MG')+1),c.Generic_Name   ) DNAMEP*/
,SPACE(100) DNAMEP
,SPACE(100) DNAME
,DATERECORD
,d.HOSPCODE
FROM
drugallergy d INNER JOIN person p ON d.HOSPCODE=p.HOSPCODE AND d.PID=p.PID
INNER JOIN cdrug_std c ON d.DRUGALLERGY=c.didstd
WHERE mod11(cid)=1  
GROUP BY p.cid,c.didstd
);


UPDATE t_drugallergy SET DNAME_STD = REPLACE(DNAME_STD,' ','#');
UPDATE t_drugallergy SET DNAMEP = IF(INSTR(DNAME_STD,'MG') ,SUBSTR(DNAME_STD,1,INSTR(DNAME_STD,'MG')+1),DNAME_STD );
UPDATE t_drugallergy SET dnamep = repl_digits_pipe(DNAMEP);
UPDATE t_drugallergy SET DNAME = if(INSTR(DNAMEP,'|'),SUBSTR(DNAMEP ,1, INSTR(DNAMEP,'|')-1),DNAMEP);
UPDATE t_drugallergy SET DNAME = if(SUBSTR(DNAME,-1)='(', SUBSTR(DNAME,1,LENGTH(DNAME)-1) ,DNAME);




UPDATE t_drugallergy SET DNAME_STD = REPLACE(DNAME_STD,'#',' ') , DNAME =REPLACE(DNAME,'#',' ');

CREATE TABLE IF NOT EXISTS ws_person_drugallergy
(
provcode VARCHAR(2) NOT NULL,
cid VARCHAR(13) NOT NULL,
flag_sent VARCHAR(1) NOT NULL DEFAULT '0',
hospcode VARCHAR(5) DEFAULT NULL,
daterecode DATE,
didcode VARCHAR(24) NOT NULL DEFAULT ' ',
didname varchar(255) NOT NULL DEFAULT ' ',
PRIMARY KEY (provcode,cid,didcode)
) ENGINE MyISAM DEFAULT CHARACTER SET=utf8 ;

CREATE TABLE IF NOT EXISTS ws_delete(
  provcode varchar(2) not null,
  cid varchar(13) not null,
  flag_sent varchar(1) DEFAULT '0',
  ws_table varchar(150) not null,
PRIMARY KEY (provcode,cid,ws_table),
KEY (provcode),
KEY (cid),
KEY (ws_table)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

DELETE FROM ws_delete WHERE flag_sent='2';

#ลบกรณีลบ;
DROP TEMPORARY TABLE IF EXISTS tmz_ws_cid_del;
CREATE TEMPORARY TABLE  IF NOT EXISTS tmz_ws_cid_del (PRIMARY KEY (CID)) 
ENGINE=MyISAM  AS 
(
SELECT DISTINCT
m.cid
FROM ws_person_drugallergy m LEFT JOIN t_drugallergy d ON m.cid=d.cid 
WHERE  d.cid is NULL
);

INSERT IGNORE INTO  ws_delete (SELECT @prov_c,cid,'0','ws_person_drugallergy' FROM  tmz_ws_cid_del);

DELETE FROM ws_person_drugallergy  WHERE cid in(SELECT cid FROM tmz_ws_cid_del ) ;

INSERT IGNORE INTO ws_person_drugallergy 
(
SELECT
@prov_c,cid,'0',hospcode,DATERECORD,DRUGALLERGY,DNAME
FROM
	t_drugallergy 
);
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.551652;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:229;a:5:{i:0;s:35:"DROP PROCEDURE IF EXISTS t_cmi_dead";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.551652;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:230;a:5:{i:0;s:35:"DROP PROCEDURE IF EXISTS t_cmi_dead";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.5984521;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:232;a:5:{i:0;s:1277:"CREATE PROCEDURE t_cmi_dead()
 BEGIN 
SET @prov_c :='58';
SET @id:= '34';
SET @year_start:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@year_start-1,'1001');
SET @end_d:=concat(@year_start,'0930');

DROP TABLE IF EXISTS t_cmi_dead;
CREATE TABLE IF NOT EXISTS t_cmi_dead (INDEX(monthly,hospcode,drg)) 
		ENGINE=MyISAM  AS 
		(select @year_start as byear,DATE_FORMAT(t.DATETIME_DISCH,'%Y%m') as monthly,t.HOSPCODE as hospcode, 
							a.chwcode, a.region, a.splevel, substr(t.drg,1,2) as mdc,
							t.DRG as drg, count(t.AN) as cases, sum(t.ADJRW) as sum_adjrw,
							sum(t.price) as price,sum(if(t.price=0,1,0)) as price0,sum(t.day) as los,
							sum(if(t.ADJRW=0,1,0)) as adjrw0, t.RW as rw,
							sum(if(t.REFERINHOSP != '' ,1,0)) as referin,
							sum(if(t.REFERINHOSP !='' and t.adjrw=0,1,0)) as referin_adjrw0,
							sum(if(t.REFERINHOSP !='',t.adjrw,0)) as referin_adjrw
						from tmp_admission t join (select t.hcode, t.hname, t.chwcode, t.chwname, t.region, t.splevel
										from ccmihosp t where t.byear = @year_start+543) a on t.HOSPCODE = a.hcode
						where DATE_FORMAT(t.DATETIME_DISCH,'%Y%m%d') BETWEEN @start_d AND @end_d
							AND t.DISCHSTATUS in (8,9)
						group by t.HOSPCODE,monthly, t.drg
) ;
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.5984521;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:233;a:5:{i:0;s:1277:"CREATE PROCEDURE t_cmi_dead()
 BEGIN 
SET @prov_c :='58';
SET @id:= '34';
SET @year_start:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@year_start-1,'1001');
SET @end_d:=concat(@year_start,'0930');

DROP TABLE IF EXISTS t_cmi_dead;
CREATE TABLE IF NOT EXISTS t_cmi_dead (INDEX(monthly,hospcode,drg)) 
		ENGINE=MyISAM  AS 
		(select @year_start as byear,DATE_FORMAT(t.DATETIME_DISCH,'%Y%m') as monthly,t.HOSPCODE as hospcode, 
							a.chwcode, a.region, a.splevel, substr(t.drg,1,2) as mdc,
							t.DRG as drg, count(t.AN) as cases, sum(t.ADJRW) as sum_adjrw,
							sum(t.price) as price,sum(if(t.price=0,1,0)) as price0,sum(t.day) as los,
							sum(if(t.ADJRW=0,1,0)) as adjrw0, t.RW as rw,
							sum(if(t.REFERINHOSP != '' ,1,0)) as referin,
							sum(if(t.REFERINHOSP !='' and t.adjrw=0,1,0)) as referin_adjrw0,
							sum(if(t.REFERINHOSP !='',t.adjrw,0)) as referin_adjrw
						from tmp_admission t join (select t.hcode, t.hname, t.chwcode, t.chwname, t.region, t.splevel
										from ccmihosp t where t.byear = @year_start+543) a on t.HOSPCODE = a.hcode
						where DATE_FORMAT(t.DATETIME_DISCH,'%Y%m%d') BETWEEN @start_d AND @end_d
							AND t.DISCHSTATUS in (8,9)
						group by t.HOSPCODE,monthly, t.drg
) ;
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.660852;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:235;a:5:{i:0;s:40:"DROP PROCEDURE IF EXISTS t_procedure_ipd";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.660852;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:236;a:5:{i:0;s:40:"DROP PROCEDURE IF EXISTS t_procedure_ipd";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.7232521;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:238;a:5:{i:0;s:4196:"CREATE PROCEDURE t_procedure_ipd()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '35';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

#รายงานเพื่อใช้ใน Service Plan สาขาการส่งต่อ ใช้ในการพัฒนา Node ให้มีศักยภาพในการรักษาโรคที่ไม่ยากจนเกินไป
DROP TABLES IF EXISTS t_procedure_ipd;
CREATE TABLE IF NOT EXISTS t_procedure_ipd (
	`prov` varchar(2) NOT null,
	`hospcode` varchar(5) NOT null,
	`hosp_level` varchar(2) NOT null,
  `cid` varchar(15) not null,
	`an` varchar(16) NOT null,
  `pid` varchar(15) NOT null,
	`seq` varchar(16) NOT null,
	`sex` TINYINT,
	`age_y` int,
	`age_m` int,
	`typearea` TINYINT,
	`datetime_admit` datetime NOT NULL,
	`datetime_disc` datetime NOT NULL,
	`actlos` INT,
	`procedcode` varchar(8) default null,
  `dischstatus` char(1),
  `dischtype` char(1),
	`typein` char(1),
	`timestart` datetime,
	`timefinish` datetime,
	`timediff` time,
	`timeused` int(6),
	`provider` varchar(16),
	`drg` varchar(5),
	`rw` float,
	`adjrw` float,
	`price` float,
	`referin` VARCHAR(5),
	`ipd_referin` VARCHAR(5),
	`ipd_referout` VARCHAR(5),
	`opd_referin` VARCHAR(5),
	`referin_level` VARCHAR(2),
	`lastupdate` TIMESTAMP,
  KEY `hospcode` (`hospcode`),
  KEY `an` (`an`),
  KEY `pid` (`pid`),
	KEY `cid` (`cid`),
  KEY `seq` (`seq`),
  KEY `referin` (`referin`),
  KEY `datetime_admit` (`datetime_admit`),
	KEY `procedcode` (`procedcode`),
	KEY `timestart` (`timestart`),
  KEY `HOSPCODE_PID` (`hospcode`,`pid`,`seq`)
)ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT INTO t_procedure_ipd 
SELECT @prov_c as prov,op.HOSPCODE, '' as hosplevel, p.CID, op.AN, ipd.PID, ipd.SEQ, p.sex, 
			age(ipd.DATETIME_ADMIT,p.BIRTH,'y') as age_y,
			age(ipd.DATETIME_ADMIT,p.BIRTH,'m') as age_m,
			p.TYPEAREA,
			ipd.DATETIME_ADMIT, ipd.DATETIME_DISCH, ipd.ACTLOS , op.procedcode, 
      ipd.DISCHSTATUS , ipd.DISCHTYPE , ipd.TYPEIN,
      op.TIMESTART, op.TIMEFINISH, TIMEDIFF(op.TIMESTART,ipd.DATETIME_ADMIT) as timediff,
			IF(TIME_TO_SEC(TIMEDIFF(op.TIMESTART,ipd.DATETIME_ADMIT))>0,TIME_TO_SEC(TIMEDIFF(op.TIMESTART,ipd.DATETIME_ADMIT))/60,0) as timeued,
			op.PROVIDER, ipd.DRG, ipd.RW, ipd.ADJRW, ipd.price,
      ipd.REFERINHOSP as ipdreferin, ipd.REFERINHOSP as ipdreferin, ipd.REFEROUTHOSP as ipdreferout,
			'' as opdreferin, '' as referin_level, CURRENT_TIMESTAMP() as lastupdate
	FROM procedure_ipd op
		LEFT JOIN admission ipd on op.HOSPCODE=ipd.HOSPCODE and op.AN=ipd.AN
		LEFT JOIN person p on op.HOSPCODE=p.HOSPCODE and op.PID=p.PID
	WHERE DATE_FORMAT(ipd.DATETIME_DISCH,'%Y%m%d') BETWEEN @start_d and @end_d
 ;

#ค้นสถานพยาบาลที่ส่ง refer มา ในกรณีที่ HIS ไม่ได้บันทึกไว้ใน admission แต่มีใน service
UPDATE t_procedure_ipd op,tmp_service opd SET op.opd_referin=opd.referinhosp
	WHERE op.hospcode = opd.hospcode AND op.seq = opd.seq and substr(op.datetime_admit,1,10)=opd.date_serv and op.pid=opd.pid;

UPDATE t_procedure_ipd op SET op.referin = op.opd_referin
	where op.referin='' and op.opd_referin!='' ;

#กรณีวัน admit=วันจำหน่าย ให้แทนค่าเป็น 1
UPDATE t_procedure_ipd op SET op.actlos = 1 
	where op.actlos=0 and op.datetime_admit=op.datetime_disc ;

#กรณีวัน admit < วันจำหน่าย ให้คำนวณหา DATEDIFF
UPDATE t_procedure_ipd op SET op.actlos = DATEDIFF(op.datetime_disc,op.datetime_admit)
	where op.actlos=0 ;

#ค้นหาประเภทสถานพยาบาล A-F
UPDATE t_procedure_ipd op,ccmihosp h SET op.hosp_level=h.splevel WHERE op.hospcode=h.hcode ;
UPDATE t_procedure_ipd op,ccmihosp h SET op.referin_level=h.splevel WHERE op.referin!='' and op.referin=h.hcode ;
UPDATE t_procedure_ipd op SET op.referin_level='NA' WHERE op.referin!='' and (op.referin_level='' or ISNULL(op.referin_level)) ;

 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.7232521;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:239;a:5:{i:0;s:4196:"CREATE PROCEDURE t_procedure_ipd()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '35';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

#รายงานเพื่อใช้ใน Service Plan สาขาการส่งต่อ ใช้ในการพัฒนา Node ให้มีศักยภาพในการรักษาโรคที่ไม่ยากจนเกินไป
DROP TABLES IF EXISTS t_procedure_ipd;
CREATE TABLE IF NOT EXISTS t_procedure_ipd (
	`prov` varchar(2) NOT null,
	`hospcode` varchar(5) NOT null,
	`hosp_level` varchar(2) NOT null,
  `cid` varchar(15) not null,
	`an` varchar(16) NOT null,
  `pid` varchar(15) NOT null,
	`seq` varchar(16) NOT null,
	`sex` TINYINT,
	`age_y` int,
	`age_m` int,
	`typearea` TINYINT,
	`datetime_admit` datetime NOT NULL,
	`datetime_disc` datetime NOT NULL,
	`actlos` INT,
	`procedcode` varchar(8) default null,
  `dischstatus` char(1),
  `dischtype` char(1),
	`typein` char(1),
	`timestart` datetime,
	`timefinish` datetime,
	`timediff` time,
	`timeused` int(6),
	`provider` varchar(16),
	`drg` varchar(5),
	`rw` float,
	`adjrw` float,
	`price` float,
	`referin` VARCHAR(5),
	`ipd_referin` VARCHAR(5),
	`ipd_referout` VARCHAR(5),
	`opd_referin` VARCHAR(5),
	`referin_level` VARCHAR(2),
	`lastupdate` TIMESTAMP,
  KEY `hospcode` (`hospcode`),
  KEY `an` (`an`),
  KEY `pid` (`pid`),
	KEY `cid` (`cid`),
  KEY `seq` (`seq`),
  KEY `referin` (`referin`),
  KEY `datetime_admit` (`datetime_admit`),
	KEY `procedcode` (`procedcode`),
	KEY `timestart` (`timestart`),
  KEY `HOSPCODE_PID` (`hospcode`,`pid`,`seq`)
)ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT INTO t_procedure_ipd 
SELECT @prov_c as prov,op.HOSPCODE, '' as hosplevel, p.CID, op.AN, ipd.PID, ipd.SEQ, p.sex, 
			age(ipd.DATETIME_ADMIT,p.BIRTH,'y') as age_y,
			age(ipd.DATETIME_ADMIT,p.BIRTH,'m') as age_m,
			p.TYPEAREA,
			ipd.DATETIME_ADMIT, ipd.DATETIME_DISCH, ipd.ACTLOS , op.procedcode, 
      ipd.DISCHSTATUS , ipd.DISCHTYPE , ipd.TYPEIN,
      op.TIMESTART, op.TIMEFINISH, TIMEDIFF(op.TIMESTART,ipd.DATETIME_ADMIT) as timediff,
			IF(TIME_TO_SEC(TIMEDIFF(op.TIMESTART,ipd.DATETIME_ADMIT))>0,TIME_TO_SEC(TIMEDIFF(op.TIMESTART,ipd.DATETIME_ADMIT))/60,0) as timeued,
			op.PROVIDER, ipd.DRG, ipd.RW, ipd.ADJRW, ipd.price,
      ipd.REFERINHOSP as ipdreferin, ipd.REFERINHOSP as ipdreferin, ipd.REFEROUTHOSP as ipdreferout,
			'' as opdreferin, '' as referin_level, CURRENT_TIMESTAMP() as lastupdate
	FROM procedure_ipd op
		LEFT JOIN admission ipd on op.HOSPCODE=ipd.HOSPCODE and op.AN=ipd.AN
		LEFT JOIN person p on op.HOSPCODE=p.HOSPCODE and op.PID=p.PID
	WHERE DATE_FORMAT(ipd.DATETIME_DISCH,'%Y%m%d') BETWEEN @start_d and @end_d
 ;

#ค้นสถานพยาบาลที่ส่ง refer มา ในกรณีที่ HIS ไม่ได้บันทึกไว้ใน admission แต่มีใน service
UPDATE t_procedure_ipd op,tmp_service opd SET op.opd_referin=opd.referinhosp
	WHERE op.hospcode = opd.hospcode AND op.seq = opd.seq and substr(op.datetime_admit,1,10)=opd.date_serv and op.pid=opd.pid;

UPDATE t_procedure_ipd op SET op.referin = op.opd_referin
	where op.referin='' and op.opd_referin!='' ;

#กรณีวัน admit=วันจำหน่าย ให้แทนค่าเป็น 1
UPDATE t_procedure_ipd op SET op.actlos = 1 
	where op.actlos=0 and op.datetime_admit=op.datetime_disc ;

#กรณีวัน admit < วันจำหน่าย ให้คำนวณหา DATEDIFF
UPDATE t_procedure_ipd op SET op.actlos = DATEDIFF(op.datetime_disc,op.datetime_admit)
	where op.actlos=0 ;

#ค้นหาประเภทสถานพยาบาล A-F
UPDATE t_procedure_ipd op,ccmihosp h SET op.hosp_level=h.splevel WHERE op.hospcode=h.hcode ;
UPDATE t_procedure_ipd op,ccmihosp h SET op.referin_level=h.splevel WHERE op.referin!='' and op.referin=h.hcode ;
UPDATE t_procedure_ipd op SET op.referin_level='NA' WHERE op.referin!='' and (op.referin_level='' or ISNULL(op.referin_level)) ;

 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.816853;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:241;a:5:{i:0;s:38:"DROP PROCEDURE IF EXISTS t_ckd_ill_all";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.816853;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:242;a:5:{i:0;s:38:"DROP PROCEDURE IF EXISTS t_ckd_ill_all";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.8948531;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:244;a:5:{i:0;s:3874:"CREATE PROCEDURE t_ckd_ill_all()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '36';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

CREATE TABLE IF NOT EXISTS t_ckd_ill_all (
  cid varchar(13) NOT NULL,
  group_diag text,
  group_date text,
  group_hos_dx text,
  min_date_dx date DEFAULT NULL,
  hospcode varchar(5) NOT NULL DEFAULT '',
  PRIMARY KEY (cid)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO  t_ckd_ill_all (
			SELECT cid 
						,GROUP_CONCAT(trim(diagcode) ORDER BY SUBSTR(diagcode,1,1),date_dx) group_diag
						,GROUP_CONCAT(date_dx ORDER BY SUBSTR(diagcode,1,1),date_dx) group_date
							,GROUP_CONCAT(IF(LENGTH(trim(hosp_dx))=0 OR ISNULL(hosp_dx),input_hosp,hosp_dx) ORDER BY SUBSTR(diagcode,1,1),date_dx)
						,min(date_dx) min_date_dx, space(5) hospcode
  FROM t_chronic 
   WHERE UPPER(diagcode) in('E102', 'E112', 'E122', 'E132', 'E142','I151') 
					OR UPPER(substr(diagcode,1,3)) in('I12','I13','N18')  
	GROUP BY cid
	ORDER BY date_dx  );

UPDATE t_ckd_ill_all  c,t_person_cid p SET c.hospcode=p.check_hosp WHERE c.cid=p.cid;

DROP TABLE IF  EXISTS t_ckd_screen;
CREATE TABLE IF NOT EXISTS t_ckd_screen (
lab12_date date default null,
lab12_hosp VARCHAR(5) DEFAULT NULL,
lab12_result VARCHAR(10) DEFAULT NULL,

lab14_date date default null,
lab14_hosp VARCHAR(5) DEFAULT NULL,
lab14_result VARCHAR(10) DEFAULT NULL,
lab11_date date default null,
lab11_hosp VARCHAR(5) DEFAULT NULL,
lab11_result VARCHAR(10) DEFAULT NULL,
lab15_date date default null,
lab15_hosp VARCHAR(5) DEFAULT NULL,
lab15_result VARCHAR(10) DEFAULT NULL,
lab15_ok_result VARCHAR(10) DEFAULT NULL,
minlab_date date default null,
PRIMARY KEY(cid) ) ENGINE MyIsam as(
SELECT
t.hospcode,t.pid,t.cid,t.vhid,t.typearea,t.birth,t.age_y,t.sex,t.nation,t.mix_dx,t.date_dx,t.hosp_dx
,null as lab12_date 
,null as lab12_hosp
,null as  lab12_result
,null as lab14_date
,null as lab14_hosp
,null as lab14_result
,null as lab11_date
,null as lab11_hosp
,null as lab11_result
,null as lab15_date
,null as lab15_hosp
,null as lab15_result
,null as lab15_ok_result
,null as minlab_date
FROM
t_dmht  t 
	LEFT JOIN (SELECT cid FROM t_ckd_ill_all WHERE min_date_dx < @start_d ) c ON t.cid=c.cid 
WHERE
t.nation in('099') AND t.typearea in(1,3)
AND (c.cid is null ));

UPDATE t_ckd_screen s ,tmp_labfu l SET s.lab12_date=l.DATE_SERV,s.lab12_hosp=l.HOSPCODE ,s.lab12_result=l.LABRESULT
WHERE s.cid=l.cid AND l.LABTEST=12 AND l.DATE_SERV  BETWEEN @start_d AND @end_d;

UPDATE t_ckd_screen s ,tmp_labfu l SET s.lab14_date=l.DATE_SERV,s.lab14_hosp=l.HOSPCODE ,s.lab14_result=l.LABRESULT
WHERE s.cid=l.cid AND l.LABTEST=14 AND l.DATE_SERV  BETWEEN @start_d AND @end_d;

UPDATE t_ckd_screen s ,tmp_labfu l SET s.lab11_date=l.DATE_SERV,s.lab11_hosp=l.HOSPCODE ,s.lab11_result=l.LABRESULT
WHERE s.cid=l.cid AND l.LABTEST=11 AND l.DATE_SERV  BETWEEN @start_d AND @end_d;

UPDATE t_ckd_screen s ,tmp_labfu l SET s.lab15_date=l.DATE_SERV,s.lab15_hosp=l.HOSPCODE ,s.lab15_result=l.LABRESULT
WHERE s.cid=l.cid AND l.LABTEST=15 AND l.DATE_SERV  BETWEEN @start_d AND @end_d;

UPDATE t_ckd_screen SET lab15_ok_result =lab15_result;

UPDATE t_ckd_screen SET lab15_ok_result =egfr_fnc(lab11_result,age_y,sex)
WHERE lab11_result IS NOT NULL AND lab11_result>0 ;

UPDATE t_ckd_screen SET minlab_date =IF(lab12_date is NULL OR lab14_date is NULL 
			,COALESCE(lab12_date,lab14_date),LEAST(lab12_date,lab14_date));

UPDATE t_ckd_screen SET minlab_date =IF(lab15_date is NULL OR minlab_date is NULL 
			,COALESCE(lab15_date,minlab_date),LEAST(lab15_date,minlab_date));

UPDATE t_ckd_screen SET minlab_date =IF(lab11_date is NULL OR minlab_date is NULL 
			,COALESCE(lab11_date,minlab_date),LEAST(lab11_date,minlab_date));

 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.8948531;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:245;a:5:{i:0;s:3874:"CREATE PROCEDURE t_ckd_ill_all()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '36';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

CREATE TABLE IF NOT EXISTS t_ckd_ill_all (
  cid varchar(13) NOT NULL,
  group_diag text,
  group_date text,
  group_hos_dx text,
  min_date_dx date DEFAULT NULL,
  hospcode varchar(5) NOT NULL DEFAULT '',
  PRIMARY KEY (cid)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO  t_ckd_ill_all (
			SELECT cid 
						,GROUP_CONCAT(trim(diagcode) ORDER BY SUBSTR(diagcode,1,1),date_dx) group_diag
						,GROUP_CONCAT(date_dx ORDER BY SUBSTR(diagcode,1,1),date_dx) group_date
							,GROUP_CONCAT(IF(LENGTH(trim(hosp_dx))=0 OR ISNULL(hosp_dx),input_hosp,hosp_dx) ORDER BY SUBSTR(diagcode,1,1),date_dx)
						,min(date_dx) min_date_dx, space(5) hospcode
  FROM t_chronic 
   WHERE UPPER(diagcode) in('E102', 'E112', 'E122', 'E132', 'E142','I151') 
					OR UPPER(substr(diagcode,1,3)) in('I12','I13','N18')  
	GROUP BY cid
	ORDER BY date_dx  );

UPDATE t_ckd_ill_all  c,t_person_cid p SET c.hospcode=p.check_hosp WHERE c.cid=p.cid;

DROP TABLE IF  EXISTS t_ckd_screen;
CREATE TABLE IF NOT EXISTS t_ckd_screen (
lab12_date date default null,
lab12_hosp VARCHAR(5) DEFAULT NULL,
lab12_result VARCHAR(10) DEFAULT NULL,

lab14_date date default null,
lab14_hosp VARCHAR(5) DEFAULT NULL,
lab14_result VARCHAR(10) DEFAULT NULL,
lab11_date date default null,
lab11_hosp VARCHAR(5) DEFAULT NULL,
lab11_result VARCHAR(10) DEFAULT NULL,
lab15_date date default null,
lab15_hosp VARCHAR(5) DEFAULT NULL,
lab15_result VARCHAR(10) DEFAULT NULL,
lab15_ok_result VARCHAR(10) DEFAULT NULL,
minlab_date date default null,
PRIMARY KEY(cid) ) ENGINE MyIsam as(
SELECT
t.hospcode,t.pid,t.cid,t.vhid,t.typearea,t.birth,t.age_y,t.sex,t.nation,t.mix_dx,t.date_dx,t.hosp_dx
,null as lab12_date 
,null as lab12_hosp
,null as  lab12_result
,null as lab14_date
,null as lab14_hosp
,null as lab14_result
,null as lab11_date
,null as lab11_hosp
,null as lab11_result
,null as lab15_date
,null as lab15_hosp
,null as lab15_result
,null as lab15_ok_result
,null as minlab_date
FROM
t_dmht  t 
	LEFT JOIN (SELECT cid FROM t_ckd_ill_all WHERE min_date_dx < @start_d ) c ON t.cid=c.cid 
WHERE
t.nation in('099') AND t.typearea in(1,3)
AND (c.cid is null ));

UPDATE t_ckd_screen s ,tmp_labfu l SET s.lab12_date=l.DATE_SERV,s.lab12_hosp=l.HOSPCODE ,s.lab12_result=l.LABRESULT
WHERE s.cid=l.cid AND l.LABTEST=12 AND l.DATE_SERV  BETWEEN @start_d AND @end_d;

UPDATE t_ckd_screen s ,tmp_labfu l SET s.lab14_date=l.DATE_SERV,s.lab14_hosp=l.HOSPCODE ,s.lab14_result=l.LABRESULT
WHERE s.cid=l.cid AND l.LABTEST=14 AND l.DATE_SERV  BETWEEN @start_d AND @end_d;

UPDATE t_ckd_screen s ,tmp_labfu l SET s.lab11_date=l.DATE_SERV,s.lab11_hosp=l.HOSPCODE ,s.lab11_result=l.LABRESULT
WHERE s.cid=l.cid AND l.LABTEST=11 AND l.DATE_SERV  BETWEEN @start_d AND @end_d;

UPDATE t_ckd_screen s ,tmp_labfu l SET s.lab15_date=l.DATE_SERV,s.lab15_hosp=l.HOSPCODE ,s.lab15_result=l.LABRESULT
WHERE s.cid=l.cid AND l.LABTEST=15 AND l.DATE_SERV  BETWEEN @start_d AND @end_d;

UPDATE t_ckd_screen SET lab15_ok_result =lab15_result;

UPDATE t_ckd_screen SET lab15_ok_result =egfr_fnc(lab11_result,age_y,sex)
WHERE lab11_result IS NOT NULL AND lab11_result>0 ;

UPDATE t_ckd_screen SET minlab_date =IF(lab12_date is NULL OR lab14_date is NULL 
			,COALESCE(lab12_date,lab14_date),LEAST(lab12_date,lab14_date));

UPDATE t_ckd_screen SET minlab_date =IF(lab15_date is NULL OR minlab_date is NULL 
			,COALESCE(lab15_date,minlab_date),LEAST(lab15_date,minlab_date));

UPDATE t_ckd_screen SET minlab_date =IF(lab11_date is NULL OR minlab_date is NULL 
			,COALESCE(lab11_date,minlab_date),LEAST(lab11_date,minlab_date));

 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.941653;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:247;a:5:{i:0;s:32:"DROP PROCEDURE IF EXISTS t_influ";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988053.941653;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:248;a:5:{i:0;s:32:"DROP PROCEDURE IF EXISTS t_influ";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.0040531;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:250;a:5:{i:0;s:2251:"CREATE PROCEDURE t_influ()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '37';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF  EXISTS t_influ;
CREATE TABLE IF NOT EXISTS t_influ(key (cid) ) ENGINE MyISAM as
(SELECT DISTINCT
p.cid,p.sex,p.BIRTH,e.DATE_SERV,e.VACCINETYPE,e.VACCINEPLACE
,'0' type_1,'0' type_2,'0' type_3,'0' type_4,'0' type_5,'0' type_6,'0' type_7,'0' type_8,'0' type_9
FROM
epi e  INNER JOIN person p ON p.HOSPCODE=e.HOSPCODE AND p.PID=e.pid
WHERE 
e.DATE_SERV BETWEEN @start_d AND @end_d
AND VACCINETYPE in('815')
);
UPDATE t_influ i INNER JOIN provider p    SET type_1 =1 WHERE  i.cid=p.CID ;
UPDATE t_influ i INNER JOIN tmp_anc a    SET type_2 =1 WHERE  i.cid=a.cid AND  TIMESTAMPDIFF(week,DATE_ADD(a.DATE_SERV,INTERVAL -(a.GA) WEEK),i.DATE_SERV)>4;
UPDATE t_influ   SET type_3 =1 WHERE TIMESTAMPDIFF(MONTH,BIRTH,DATE_SERV)  BETWEEN 6 and 24;
UPDATE t_influ   SET type_4 =1 WHERE TIMESTAMPDIFF(YEAR,BIRTH,DATE_SERV)  > 65;
UPDATE t_influ i INNER JOIN t_chronic c   SET type_5 =1  WHERE i.cid=c.cid 
	AND (substr(c.diagcode,1,3) in('J44','J45','J46','I20','I21','I22','I23','I24','I25','I60','I61','I62','I63','I64','I65','I66','I67','N17','N18','N19','E10','E11','E12','E13','E14')
or substr(c.diagcode,1,1) in('C')) AND c.date_dx <= i.DATE_SERV;
UPDATE t_influ i INNER JOIN tmp_diag_opd d   SET type_6 =1 WHERE  i.cid=d.CID AND substr(d.diagcode,1,3) in('Q00','Q01','Q02','Q03','Q04','F84') AND d.DATE_SERV <= i.DATE_SERV;
UPDATE t_influ i INNER JOIN t_chronic c   SET type_7 =1  WHERE i.cid=c.cid AND substr(c.diagcode,1,3) in('B20','B21','B22','B23','B24') AND c.date_dx <= i.DATE_SERV;
UPDATE t_influ i INNER JOIN tmp_diag_opd d   SET type_7 =1 WHERE  i.cid=d.CID AND substr(d.diagcode,1,3) in('D56') AND d.DATE_SERV <= i.DATE_SERV;
UPDATE t_influ i INNER JOIN tmp_diag_opd d   SET type_8 =1 WHERE  i.cid=d.CID AND substr(d.diagcode,1,3) in('E66') AND d.DATE_SERV <= i.DATE_SERV;
UPDATE t_influ SET type_4=0 WHERE type_5 =1 OR type_7 =1 OR type_8 =1;
UPDATE t_influ SET type_9=1 WHERE type_1 =0 AND type_2 =0 AND type_3 =0 AND type_4 =0 AND type_5 =0 AND type_6 =0 AND type_7 =0 AND type_8 =0;

 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.0040531;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:251;a:5:{i:0;s:2251:"CREATE PROCEDURE t_influ()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '37';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF  EXISTS t_influ;
CREATE TABLE IF NOT EXISTS t_influ(key (cid) ) ENGINE MyISAM as
(SELECT DISTINCT
p.cid,p.sex,p.BIRTH,e.DATE_SERV,e.VACCINETYPE,e.VACCINEPLACE
,'0' type_1,'0' type_2,'0' type_3,'0' type_4,'0' type_5,'0' type_6,'0' type_7,'0' type_8,'0' type_9
FROM
epi e  INNER JOIN person p ON p.HOSPCODE=e.HOSPCODE AND p.PID=e.pid
WHERE 
e.DATE_SERV BETWEEN @start_d AND @end_d
AND VACCINETYPE in('815')
);
UPDATE t_influ i INNER JOIN provider p    SET type_1 =1 WHERE  i.cid=p.CID ;
UPDATE t_influ i INNER JOIN tmp_anc a    SET type_2 =1 WHERE  i.cid=a.cid AND  TIMESTAMPDIFF(week,DATE_ADD(a.DATE_SERV,INTERVAL -(a.GA) WEEK),i.DATE_SERV)>4;
UPDATE t_influ   SET type_3 =1 WHERE TIMESTAMPDIFF(MONTH,BIRTH,DATE_SERV)  BETWEEN 6 and 24;
UPDATE t_influ   SET type_4 =1 WHERE TIMESTAMPDIFF(YEAR,BIRTH,DATE_SERV)  > 65;
UPDATE t_influ i INNER JOIN t_chronic c   SET type_5 =1  WHERE i.cid=c.cid 
	AND (substr(c.diagcode,1,3) in('J44','J45','J46','I20','I21','I22','I23','I24','I25','I60','I61','I62','I63','I64','I65','I66','I67','N17','N18','N19','E10','E11','E12','E13','E14')
or substr(c.diagcode,1,1) in('C')) AND c.date_dx <= i.DATE_SERV;
UPDATE t_influ i INNER JOIN tmp_diag_opd d   SET type_6 =1 WHERE  i.cid=d.CID AND substr(d.diagcode,1,3) in('Q00','Q01','Q02','Q03','Q04','F84') AND d.DATE_SERV <= i.DATE_SERV;
UPDATE t_influ i INNER JOIN t_chronic c   SET type_7 =1  WHERE i.cid=c.cid AND substr(c.diagcode,1,3) in('B20','B21','B22','B23','B24') AND c.date_dx <= i.DATE_SERV;
UPDATE t_influ i INNER JOIN tmp_diag_opd d   SET type_7 =1 WHERE  i.cid=d.CID AND substr(d.diagcode,1,3) in('D56') AND d.DATE_SERV <= i.DATE_SERV;
UPDATE t_influ i INNER JOIN tmp_diag_opd d   SET type_8 =1 WHERE  i.cid=d.CID AND substr(d.diagcode,1,3) in('E66') AND d.DATE_SERV <= i.DATE_SERV;
UPDATE t_influ SET type_4=0 WHERE type_5 =1 OR type_7 =1 OR type_8 =1;
UPDATE t_influ SET type_9=1 WHERE type_1 =0 AND type_2 =0 AND type_3 =0 AND type_4 =0 AND type_5 =0 AND type_6 =0 AND type_7 =0 AND type_8 =0;

 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.050853;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:253;a:5:{i:0;s:38:"DROP PROCEDURE IF EXISTS t_ckd_service";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.050853;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:254;a:5:{i:0;s:38:"DROP PROCEDURE IF EXISTS t_ckd_service";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.1132531;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:256;a:5:{i:0;s:6112:"CREATE PROCEDURE t_ckd_service()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '38';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF  EXISTS t_ckd_service;
CREATE TABLE IF NOT EXISTS t_ckd_service (
sex varchar(1),
age varchar(3),
nation varchar(3),
sbp int(3),
dbp int(3),
egfr varchar(20),
creatinine varchar(20),
egfr_ok varchar(20),
hb varchar(20),
hba1c varchar(20),
serum_k varchar(20),
serum_hco3 varchar(20),
urine_protein int(1),
upcr varchar(20),
serum_po4 varchar(20),
serum_ipth varchar(20),
acei_arb int(1),
statin int(1),
KEY(hospcode),KEY(PID),KEY(DATE_SERV)
) ENGINE MyISAM as
(SELECT
HOSPCODE,PID,SEQ,DATE_SERV,DIAGCODE,cid
,0 as 'sex'
,'' as 'nation'
,0 as 'age'
,0 as 'sbp'
,0 as 'dbp'
,0 as 'egfr'
,0 as 'creatinine'
,0 as 'egfr_ok'
,0 as 'hb'
,0 as 'hba1c'
,0 as 'serum_k'
,0 as 'serum_hco3'
,0 as 'urine_protein'
,0 as 'upcr'
,0 as 'serum_po4'
,0 as 'serum_ipth'
,0 as 'acei_arb'
,0 as 'statin'
FROM
tmp_diag_opd o LEFT JOIN chospital h ON o.HOSPCODE=h.hoscode
WHERE 
(substr(diagcode,1,4) IN ('N181','N182','N183','N184','N189','E102','E112','E122','E132','E142','I151') OR substr(diagcode,1,3) IN ('I12','I13'))
AND h.hostype in(5,6,7) AND o.DATE_SERV BETWEEN @start_d AND  @end_d
ORDER BY HOSPCODE ASC ,PID ASC, DATE_SERV DESC);


/*up sex for egfr*/
UPDATE  t_ckd_service c INNER JOIN  t_person_db p ON c.HOSPCODE=p.hospcode 	AND c.PID=p.pid
SET c.sex=p.SEX, c.age=TIMESTAMPDIFF(year,p.BIRTH,c.DATE_SERV),c.nation=p.NATION;
/*up bp from service*/
UPDATE t_ckd_service c INNER JOIN  tmp_service s ON c.HOSPCODE=s.hospcode 
							AND c.PID=s.pid AND c.seq=s.seq AND c.DATE_SERV=s.date_serv
SET c.sbp = s.sbp , c.dbp = s.dbp
WHERE s.sbp BETWEEN 10 AND 300 AND s.dbp BETWEEN 10 AND 300; 
/*up bp from chronicfu where bp <10*/
UPDATE t_ckd_service c INNER JOIN  tmp_chronicfu f ON c.HOSPCODE=f.hospcode 
							AND c.PID=f.pid AND c.seq=f.seq AND c.DATE_SERV=f.date_serv
SET c.sbp=f.sbp , c.dbp=f.dbp
WHERE c.sbp <10 AND f.sbp BETWEEN 10 AND 300 AND f.dbp BETWEEN 10 AND 300; 
/*up egfr*/
UPDATE t_ckd_service c INNER JOIN  tmp_labfu l ON c.HOSPCODE=l.hospcode 
							AND c.PID=l.pid AND c.seq=l.seq AND c.DATE_SERV=l.date_serv
SET c.egfr = l.LABRESULT
WHERE l.LABTEST=15;
/*up egfr_ok*/
UPDATE t_ckd_service c SET c.egfr_ok = c.egfr;
/*up creatinine*/
UPDATE t_ckd_service c INNER JOIN  tmp_labfu l ON c.HOSPCODE=l.hospcode 
							AND c.PID=l.pid AND c.seq=l.seq AND c.DATE_SERV=l.date_serv
SET c.creatinine = l.LABRESULT
WHERE l.LABTEST=11;
/*up hb*/
UPDATE t_ckd_service c INNER JOIN  tmp_labfu l ON c.HOSPCODE=l.hospcode 
							AND c.PID=l.pid AND c.seq=l.seq AND c.DATE_SERV=l.date_serv
SET c.hb = l.LABRESULT
WHERE l.LABTEST=16;
/*up hba1c*/
UPDATE t_ckd_service c INNER JOIN  tmp_labfu l ON c.HOSPCODE=l.hospcode 
							AND c.PID=l.pid AND c.seq=l.seq AND c.DATE_SERV=l.date_serv
SET c.hba1c = l.LABRESULT
WHERE l.LABTEST=5;
/*up serum_k*/
UPDATE t_ckd_service c INNER JOIN  tmp_labfu l ON c.HOSPCODE=l.hospcode 
							AND c.PID=l.pid AND c.seq=l.seq AND c.DATE_SERV=l.date_serv
SET c.serum_k = l.LABRESULT
WHERE l.LABTEST=18;
/*up serum_hco3*/
UPDATE t_ckd_service c INNER JOIN  tmp_labfu l ON c.HOSPCODE=l.hospcode 
							AND c.PID=l.pid AND c.seq=l.seq AND c.DATE_SERV=l.date_serv
SET c.serum_hco3 = l.LABRESULT
WHERE l.LABTEST=19;
/*up urine_protein*/
UPDATE t_ckd_service c INNER JOIN  tmp_labfu l ON c.HOSPCODE=l.hospcode 
							AND c.PID=l.pid AND c.seq=l.seq AND c.DATE_SERV=l.date_serv
SET c.urine_protein = 1
WHERE (l.LABTEST=12 AND l.LABRESULT >=0 ) OR (l.LABTEST=14 AND l.LABRESULT >=0 )  ;
/*up upcr*/
UPDATE t_ckd_service c INNER JOIN  tmp_labfu l ON c.HOSPCODE=l.hospcode 
							AND c.PID=l.pid AND c.seq=l.seq AND c.DATE_SERV=l.date_serv
SET c.upcr = l.LABRESULT
WHERE l.LABTEST=17;
/*up serum_po4*/
UPDATE t_ckd_service c INNER JOIN  tmp_labfu l ON c.HOSPCODE=l.hospcode 
							AND c.PID=l.pid AND c.seq=l.seq AND c.DATE_SERV=l.date_serv
SET c.serum_po4 = l.LABRESULT
WHERE l.LABTEST=20;
/*up serum_ipth*/
UPDATE t_ckd_service c INNER JOIN  tmp_labfu l ON c.HOSPCODE=l.hospcode 
							AND c.PID=l.pid AND c.seq=l.seq AND c.DATE_SERV=l.date_serv
SET c.serum_ipth = l.LABRESULT
WHERE l.LABTEST=21;
/*up egfr_ok*/
UPDATE t_ckd_service c SET c.egfr_ok = egfr_fnc(c.creatinine,c.age,c.sex) WHERE c.creatinine > 0 ;
/*up acei_arb*/
UPDATE t_ckd_service c INNER JOIN  tmp_drug_opd d ON c.HOSPCODE=d.hospcode 
							AND c.PID=d.pid AND c.seq=d.seq AND c.DATE_SERV=d.date_serv
SET c.acei_arb = 1
WHERE 
(     d.DIDSTD REGEXP '^[0-9]0061[7-9]'
      OR d.DIDSTD REGEXP '^[0-9]0062[1-3]'
      OR d.DIDSTD REGEXP '^[0-9]23171'
      OR d.DIDSTD REGEXP '^[0-9]24354'
      OR d.DIDSTD REGEXP '^[0-9]24432'
      OR d.DIDSTD REGEXP '^[0-9]24831'
      OR d.DIDSTD REGEXP '^[0-9]24843'
      OR d.DIDSTD REGEXP '^[0-9]24860'
      OR d.DIDSTD REGEXP '^[0-9]24889'
      OR d.DIDSTD REGEXP '^[0-9]24976'
      OR d.DIDSTD REGEXP '^[0-9]44080'
      OR d.DIDSTD REGEXP '^[0-9]030902500[39]'
      OR d.DIDSTD REGEXP '^[0-9]03090[1-2]0001'
      OR d.DIDSTD REGEXP '^[0-9]0309025005'
      OR d.DIDSTD REGEXP '^[0-9]0309040005'
      OR d.DIDSTD REGEXP '^[0-9]0309025007'
      OR d.DIDSTD REGEXP '^[0-9]0309040001'
      OR d.DIDSTD REGEXP '^[0-9]0309025008'
      OR d.DIDSTD REGEXP '^[0-9]030902500[1246]'
      OR d.DIDSTD REGEXP '^[0-9]0309040003'
      OR d.DIDSTD REGEXP '^[0-9]0309023001'
      );
/*up statin*/
UPDATE t_ckd_service c INNER JOIN  tmp_drug_opd d ON c.HOSPCODE=d.hospcode 
							AND c.PID=d.pid AND c.seq=d.seq AND c.DATE_SERV=d.date_serv
SET c.statin = 1
WHERE 
(    d.DIDSTD REGEXP '^[0-9]05573'
     OR d.DIDSTD REGEXP '^[0-9]12482'
     OR d.DIDSTD REGEXP '^[0-9]24868'
     OR d.DIDSTD REGEXP '^[0-9]24922'
     OR d.DIDSTD REGEXP '^[0-9]43383'
     OR d.DIDSTD REGEXP '^[0-9]45714'
     OR d.DIDSTD REGEXP '^[0-9]0204011001'
     OR d.DIDSTD REGEXP '^[0-9]0204011002'
      );
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.1132531;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:257;a:5:{i:0;s:6112:"CREATE PROCEDURE t_ckd_service()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '38';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF  EXISTS t_ckd_service;
CREATE TABLE IF NOT EXISTS t_ckd_service (
sex varchar(1),
age varchar(3),
nation varchar(3),
sbp int(3),
dbp int(3),
egfr varchar(20),
creatinine varchar(20),
egfr_ok varchar(20),
hb varchar(20),
hba1c varchar(20),
serum_k varchar(20),
serum_hco3 varchar(20),
urine_protein int(1),
upcr varchar(20),
serum_po4 varchar(20),
serum_ipth varchar(20),
acei_arb int(1),
statin int(1),
KEY(hospcode),KEY(PID),KEY(DATE_SERV)
) ENGINE MyISAM as
(SELECT
HOSPCODE,PID,SEQ,DATE_SERV,DIAGCODE,cid
,0 as 'sex'
,'' as 'nation'
,0 as 'age'
,0 as 'sbp'
,0 as 'dbp'
,0 as 'egfr'
,0 as 'creatinine'
,0 as 'egfr_ok'
,0 as 'hb'
,0 as 'hba1c'
,0 as 'serum_k'
,0 as 'serum_hco3'
,0 as 'urine_protein'
,0 as 'upcr'
,0 as 'serum_po4'
,0 as 'serum_ipth'
,0 as 'acei_arb'
,0 as 'statin'
FROM
tmp_diag_opd o LEFT JOIN chospital h ON o.HOSPCODE=h.hoscode
WHERE 
(substr(diagcode,1,4) IN ('N181','N182','N183','N184','N189','E102','E112','E122','E132','E142','I151') OR substr(diagcode,1,3) IN ('I12','I13'))
AND h.hostype in(5,6,7) AND o.DATE_SERV BETWEEN @start_d AND  @end_d
ORDER BY HOSPCODE ASC ,PID ASC, DATE_SERV DESC);


/*up sex for egfr*/
UPDATE  t_ckd_service c INNER JOIN  t_person_db p ON c.HOSPCODE=p.hospcode 	AND c.PID=p.pid
SET c.sex=p.SEX, c.age=TIMESTAMPDIFF(year,p.BIRTH,c.DATE_SERV),c.nation=p.NATION;
/*up bp from service*/
UPDATE t_ckd_service c INNER JOIN  tmp_service s ON c.HOSPCODE=s.hospcode 
							AND c.PID=s.pid AND c.seq=s.seq AND c.DATE_SERV=s.date_serv
SET c.sbp = s.sbp , c.dbp = s.dbp
WHERE s.sbp BETWEEN 10 AND 300 AND s.dbp BETWEEN 10 AND 300; 
/*up bp from chronicfu where bp <10*/
UPDATE t_ckd_service c INNER JOIN  tmp_chronicfu f ON c.HOSPCODE=f.hospcode 
							AND c.PID=f.pid AND c.seq=f.seq AND c.DATE_SERV=f.date_serv
SET c.sbp=f.sbp , c.dbp=f.dbp
WHERE c.sbp <10 AND f.sbp BETWEEN 10 AND 300 AND f.dbp BETWEEN 10 AND 300; 
/*up egfr*/
UPDATE t_ckd_service c INNER JOIN  tmp_labfu l ON c.HOSPCODE=l.hospcode 
							AND c.PID=l.pid AND c.seq=l.seq AND c.DATE_SERV=l.date_serv
SET c.egfr = l.LABRESULT
WHERE l.LABTEST=15;
/*up egfr_ok*/
UPDATE t_ckd_service c SET c.egfr_ok = c.egfr;
/*up creatinine*/
UPDATE t_ckd_service c INNER JOIN  tmp_labfu l ON c.HOSPCODE=l.hospcode 
							AND c.PID=l.pid AND c.seq=l.seq AND c.DATE_SERV=l.date_serv
SET c.creatinine = l.LABRESULT
WHERE l.LABTEST=11;
/*up hb*/
UPDATE t_ckd_service c INNER JOIN  tmp_labfu l ON c.HOSPCODE=l.hospcode 
							AND c.PID=l.pid AND c.seq=l.seq AND c.DATE_SERV=l.date_serv
SET c.hb = l.LABRESULT
WHERE l.LABTEST=16;
/*up hba1c*/
UPDATE t_ckd_service c INNER JOIN  tmp_labfu l ON c.HOSPCODE=l.hospcode 
							AND c.PID=l.pid AND c.seq=l.seq AND c.DATE_SERV=l.date_serv
SET c.hba1c = l.LABRESULT
WHERE l.LABTEST=5;
/*up serum_k*/
UPDATE t_ckd_service c INNER JOIN  tmp_labfu l ON c.HOSPCODE=l.hospcode 
							AND c.PID=l.pid AND c.seq=l.seq AND c.DATE_SERV=l.date_serv
SET c.serum_k = l.LABRESULT
WHERE l.LABTEST=18;
/*up serum_hco3*/
UPDATE t_ckd_service c INNER JOIN  tmp_labfu l ON c.HOSPCODE=l.hospcode 
							AND c.PID=l.pid AND c.seq=l.seq AND c.DATE_SERV=l.date_serv
SET c.serum_hco3 = l.LABRESULT
WHERE l.LABTEST=19;
/*up urine_protein*/
UPDATE t_ckd_service c INNER JOIN  tmp_labfu l ON c.HOSPCODE=l.hospcode 
							AND c.PID=l.pid AND c.seq=l.seq AND c.DATE_SERV=l.date_serv
SET c.urine_protein = 1
WHERE (l.LABTEST=12 AND l.LABRESULT >=0 ) OR (l.LABTEST=14 AND l.LABRESULT >=0 )  ;
/*up upcr*/
UPDATE t_ckd_service c INNER JOIN  tmp_labfu l ON c.HOSPCODE=l.hospcode 
							AND c.PID=l.pid AND c.seq=l.seq AND c.DATE_SERV=l.date_serv
SET c.upcr = l.LABRESULT
WHERE l.LABTEST=17;
/*up serum_po4*/
UPDATE t_ckd_service c INNER JOIN  tmp_labfu l ON c.HOSPCODE=l.hospcode 
							AND c.PID=l.pid AND c.seq=l.seq AND c.DATE_SERV=l.date_serv
SET c.serum_po4 = l.LABRESULT
WHERE l.LABTEST=20;
/*up serum_ipth*/
UPDATE t_ckd_service c INNER JOIN  tmp_labfu l ON c.HOSPCODE=l.hospcode 
							AND c.PID=l.pid AND c.seq=l.seq AND c.DATE_SERV=l.date_serv
SET c.serum_ipth = l.LABRESULT
WHERE l.LABTEST=21;
/*up egfr_ok*/
UPDATE t_ckd_service c SET c.egfr_ok = egfr_fnc(c.creatinine,c.age,c.sex) WHERE c.creatinine > 0 ;
/*up acei_arb*/
UPDATE t_ckd_service c INNER JOIN  tmp_drug_opd d ON c.HOSPCODE=d.hospcode 
							AND c.PID=d.pid AND c.seq=d.seq AND c.DATE_SERV=d.date_serv
SET c.acei_arb = 1
WHERE 
(     d.DIDSTD REGEXP '^[0-9]0061[7-9]'
      OR d.DIDSTD REGEXP '^[0-9]0062[1-3]'
      OR d.DIDSTD REGEXP '^[0-9]23171'
      OR d.DIDSTD REGEXP '^[0-9]24354'
      OR d.DIDSTD REGEXP '^[0-9]24432'
      OR d.DIDSTD REGEXP '^[0-9]24831'
      OR d.DIDSTD REGEXP '^[0-9]24843'
      OR d.DIDSTD REGEXP '^[0-9]24860'
      OR d.DIDSTD REGEXP '^[0-9]24889'
      OR d.DIDSTD REGEXP '^[0-9]24976'
      OR d.DIDSTD REGEXP '^[0-9]44080'
      OR d.DIDSTD REGEXP '^[0-9]030902500[39]'
      OR d.DIDSTD REGEXP '^[0-9]03090[1-2]0001'
      OR d.DIDSTD REGEXP '^[0-9]0309025005'
      OR d.DIDSTD REGEXP '^[0-9]0309040005'
      OR d.DIDSTD REGEXP '^[0-9]0309025007'
      OR d.DIDSTD REGEXP '^[0-9]0309040001'
      OR d.DIDSTD REGEXP '^[0-9]0309025008'
      OR d.DIDSTD REGEXP '^[0-9]030902500[1246]'
      OR d.DIDSTD REGEXP '^[0-9]0309040003'
      OR d.DIDSTD REGEXP '^[0-9]0309023001'
      );
/*up statin*/
UPDATE t_ckd_service c INNER JOIN  tmp_drug_opd d ON c.HOSPCODE=d.hospcode 
							AND c.PID=d.pid AND c.seq=d.seq AND c.DATE_SERV=d.date_serv
SET c.statin = 1
WHERE 
(    d.DIDSTD REGEXP '^[0-9]05573'
     OR d.DIDSTD REGEXP '^[0-9]12482'
     OR d.DIDSTD REGEXP '^[0-9]24868'
     OR d.DIDSTD REGEXP '^[0-9]24922'
     OR d.DIDSTD REGEXP '^[0-9]43383'
     OR d.DIDSTD REGEXP '^[0-9]45714'
     OR d.DIDSTD REGEXP '^[0-9]0204011001'
     OR d.DIDSTD REGEXP '^[0-9]0204011002'
      );
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.160053;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:259;a:5:{i:0;s:35:"DROP PROCEDURE IF EXISTS t_ckd_egfr";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.160053;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:260;a:5:{i:0;s:35:"DROP PROCEDURE IF EXISTS t_ckd_egfr";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.2224531;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:262;a:5:{i:0;s:6521:"CREATE PROCEDURE t_ckd_egfr()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '39';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
SET @start_d1:=concat(@b_year-2,'1001');
SET @end_d1:=concat(@b_year-1,'0930');

DROP TABLE IF  EXISTS t_lab_egfr;
CREATE TABLE IF NOT EXISTS t_lab_egfr(
sex varchar(1),
age varchar(3),
nation varchar(3),
egfr varchar(20),
creatinine varchar(20),
egfr_ok varchar(20),
KEY(hospcode),KEY(PID),KEY(DATE_SERV)
) ENGINE MyISAM as
(SELECT
HOSPCODE,PID,SEQ,DATE_SERV,cid
,0 as 'sex'
,'' as 'nation'
,0 as 'age'
,0 as 'egfr'
,0 as 'creatinine'
,0 as 'egfr_ok'
FROM
tmp_labfu
WHERE
LABTEST in(11,15) AND LENGTH(TRIM(LABRESULT)) >0
);
/*up sex for egfr*/
UPDATE  t_lab_egfr c INNER JOIN  t_person_db p ON c.HOSPCODE=p.hospcode 	AND c.PID=p.pid
SET c.sex=p.SEX, c.age=TIMESTAMPDIFF(year,p.BIRTH,c.DATE_SERV),c.nation=p.NATION;

/*up egfr*/
UPDATE t_lab_egfr c INNER JOIN  tmp_labfu l ON c.HOSPCODE=l.hospcode 
							AND c.PID=l.pid AND c.seq=l.seq AND c.DATE_SERV=l.date_serv
SET c.egfr = l.LABRESULT
WHERE l.LABTEST=15;
/*up egfr_ok*/
UPDATE t_lab_egfr c SET c.egfr_ok = c.egfr;
/*up creatinine*/
UPDATE t_lab_egfr c INNER JOIN  tmp_labfu l ON c.HOSPCODE=l.hospcode 
							AND c.PID=l.pid AND c.seq=l.seq AND c.DATE_SERV=l.date_serv
SET c.creatinine = l.LABRESULT
WHERE l.LABTEST=11;
/*up egfr_ok*/
UPDATE t_lab_egfr c SET c.egfr_ok = egfr_fnc(c.creatinine,c.age,c.sex) WHERE c.creatinine > 0 ;

DROP TABLE IF  EXISTS t_ckd_egfr;
CREATE TABLE IF NOT EXISTS t_ckd_egfr (
egfr_r1 varchar(20) default '0',
egfr_d1 date default null,
egfr_r2 varchar(20) default '0',
egfr_d2 date default null,
egfr_r3 varchar(20) default '0',
egfr_d3 date default null,
egfr_r4 varchar(20) default '0',
egfr_d4 date default null,
day1 int(2) default 0,
day2 int(2) default 0,
day3 int(2) default 0,
sumseq int(2) default 0,
egfr_avg VARCHAR(20) DEFAULT null,
KEY(hospcode),
KEY(pid)
) ENGINE MyISAM as
(SELECT
HOSPCODE,PID,cid,sex,nation,
'0' as 'egfr_r1',
null as egfr_d1,
'0' as 'egfr_r2',
null as egfr_d2,
'0' as 'egfr_r3',
null as egfr_d3,
'0' as 'egfr_r4',
null as egfr_d4,
0 as 'day1',
0 as 'day2',
0 as 'day3',
0 as 'sumseq',
null as 'egfr_avg'
FROM
t_ckd_service
WHERE 
(
      DIAGCODE IN ('N181','N182','N183','N184')
		 OR  (DIAGCODE IN ('N189') AND ( egfr_ok=0 OR  egfr_ok>=15))
     OR (( DIAGCODE IN ('E102','E112','E122','E132','E142')
       OR LEFT( DIAGCODE,3) IN ('I12','I13')
       OR  DIAGCODE='I151')
      AND  egfr_ok>=15)
  ) 
AND DATE_SERV BETWEEN @start_d AND  @end_d
GROUP BY HOSPCODE ,PID
);
/*sumseq*/
UPDATE t_ckd_egfr e  
INNER JOIN (
		SELECT HOSPCODE,PID,COUNT(DISTINCT HOSPCODE ,PID,DATE_SERV) as sumseq
		FROM	t_lab_egfr 
	 WHERE egfr_ok>0		
	  GROUP BY HOSPCODE,PID
) c
SET e.sumseq=c.sumseq
WHERE  e.hospcode=c.HOSPCODE AND e.pid=c.PID;
/*egfr_1*/
UPDATE t_ckd_egfr e  
	INNER JOIN (
		SELECT HOSPCODE,PID,DATE_SERV,egfr_ok 
		FROM t_lab_egfr s 
		WHERE egfr_ok>0 
			AND DATE_SERV =(SELECT DATE_SERV FROM t_lab_egfr s1 WHERE s1.egfr_ok>0 AND s1.HOSPCODE=s.HOSPCODE AND s1.PID=s.PID
																		GROUP BY s1.cid,s1.DATE_SERV ORDER BY s1.date_serv DESC LIMIT 0,1)
		GROUP BY HOSPCODE,PID
		) c
SET e.egfr_r1=c.egfr_ok , e.egfr_d1=c.DATE_SERV
WHERE  e.hospcode=c.HOSPCODE AND e.pid=c.PID;
/*egfr_2*/
UPDATE t_ckd_egfr e  
	INNER JOIN (
		SELECT HOSPCODE,PID,DATE_SERV,egfr_ok 
		FROM t_lab_egfr s 
		WHERE egfr_ok>0 
			AND DATE_SERV =(SELECT DATE_SERV FROM t_lab_egfr s1 WHERE s1.egfr_ok>0 AND s1.HOSPCODE=s.HOSPCODE AND s1.PID=s.PID
																		GROUP BY s1.cid,s1.DATE_SERV ORDER BY s1.date_serv DESC LIMIT 1,1)
		GROUP BY HOSPCODE,PID
		) c
SET e.egfr_r2=c.egfr_ok , e.egfr_d2=c.DATE_SERV
WHERE  e.hospcode=c.HOSPCODE AND e.pid=c.PID;
/*egfr_3*/
UPDATE t_ckd_egfr e  
	INNER JOIN (
		SELECT HOSPCODE,PID,DATE_SERV,egfr_ok 
		FROM t_lab_egfr s 
		WHERE egfr_ok>0 
			AND DATE_SERV =(SELECT DATE_SERV FROM t_lab_egfr s1 WHERE s1.egfr_ok>0 AND s1.HOSPCODE=s.HOSPCODE AND s1.PID=s.PID
																		GROUP BY s1.cid,s1.DATE_SERV ORDER BY s1.date_serv DESC LIMIT 2,1)
		GROUP BY HOSPCODE,PID
		) c
SET e.egfr_r3=c.egfr_ok , e.egfr_d3=c.DATE_SERV
WHERE  e.hospcode=c.HOSPCODE AND e.pid=c.PID;
/*egfr_4*/
UPDATE t_ckd_egfr e  
	INNER JOIN (
		SELECT HOSPCODE,PID,DATE_SERV,egfr_ok 
		FROM t_lab_egfr s 
		WHERE egfr_ok>0 
			AND DATE_SERV =(SELECT DATE_SERV FROM t_lab_egfr s1 WHERE s1.egfr_ok>0 AND s1.HOSPCODE=s.HOSPCODE AND s1.PID=s.PID
																		GROUP BY s1.cid,s1.DATE_SERV ORDER BY s1.date_serv DESC LIMIT 3,1)
		GROUP BY HOSPCODE,PID
		) c
SET e.egfr_r4=c.egfr_ok , e.egfr_d4=c.DATE_SERV
WHERE  e.hospcode=c.HOSPCODE AND e.pid=c.PID;
/*day*/
UPDATE  t_ckd_egfr e   SET e.day1=TIMESTAMPDIFF(day,e.egfr_d2,e.egfr_d1)
,e.day2=TIMESTAMPDIFF(day,e.egfr_d3,e.egfr_d2)
,e.day3=TIMESTAMPDIFF(day,e.egfr_d4,e.egfr_d3);
/*egfr_avg*/
UPDATE  t_ckd_egfr e   SET e.egfr_avg= ROUND((((egfr_r2-egfr_r1) /day1))*365,2)
WHERE e.sumseq = 2;

UPDATE  t_ckd_egfr e   SET e.egfr_avg= ROUND(( ( ((egfr_r3-egfr_r2) /day2) + ((egfr_r2-egfr_r1) /day1) )/2 )*365,2)
WHERE e.sumseq = 3;

UPDATE  t_ckd_egfr e   SET e.egfr_avg= ROUND((( ((egfr_r4-egfr_r3) /day3)  + ((egfr_r3-egfr_r2) /day2) + ((egfr_r2-egfr_r1) /day1) )/3)*365,2)
WHERE e.sumseq > 3;

DROP TABLE IF  EXISTS t_ckd_stage;
CREATE TABLE IF NOT EXISTS t_ckd_stage(
egfr_r2 varchar(20) default '0',
egfr_d2 date default null,
stage_now int DEFAULT 0,
stage_lastyear int DEFAULT 0,
PRIMARY KEY(hospcode,pid)
,KEY(hospcode,pid)
,KEY(cid) 
) ENGINE MyISAM as
(
SELECT 
hospcode,pid,cid,sex,nation,egfr_r1,egfr_d1,null as egfr_r2 ,null as egfr_d2,0 as stage_now,0 as stage_lastyear
FROM
t_ckd_egfr
WHERE  egfr_r1 >0
);

UPDATE t_ckd_stage t INNER JOIN (
SELECT * FROM
(SELECT * FROM t_lab_egfr WHERE date_serv BETWEEN @start_d1 AND @end_d1 ORDER BY date_serv DESC) d1
GROUP BY hospcode,pid
) l ON t.hospcode=l.hospcode AND t.pid=l.pid
SET t.egfr_r2=l.egfr_ok,t.egfr_d2=l.date_serv;

UPDATE t_ckd_stage SET stage_now=IF(egfr_r1 >=90,1,
IF(egfr_r1 BETWEEN 60 AND 89.99,2
,IF(egfr_r1 BETWEEN 30 AND 59.99,3
,IF(egfr_r1 BETWEEN 15 AND 29.99,4
,IF(egfr_r1 <15,5,0
)))))
,
stage_lastyear=IF(egfr_r2 >=90,1,
IF(egfr_r2 BETWEEN 60 AND 89.99,2
,IF(egfr_r2 BETWEEN 30 AND 59.99,3
,IF(egfr_r2 BETWEEN 15 AND 29.99,4
,IF(egfr_r2 <15,5,0
)))))
;
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.2380531;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:263;a:5:{i:0;s:6521:"CREATE PROCEDURE t_ckd_egfr()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '39';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
SET @start_d1:=concat(@b_year-2,'1001');
SET @end_d1:=concat(@b_year-1,'0930');

DROP TABLE IF  EXISTS t_lab_egfr;
CREATE TABLE IF NOT EXISTS t_lab_egfr(
sex varchar(1),
age varchar(3),
nation varchar(3),
egfr varchar(20),
creatinine varchar(20),
egfr_ok varchar(20),
KEY(hospcode),KEY(PID),KEY(DATE_SERV)
) ENGINE MyISAM as
(SELECT
HOSPCODE,PID,SEQ,DATE_SERV,cid
,0 as 'sex'
,'' as 'nation'
,0 as 'age'
,0 as 'egfr'
,0 as 'creatinine'
,0 as 'egfr_ok'
FROM
tmp_labfu
WHERE
LABTEST in(11,15) AND LENGTH(TRIM(LABRESULT)) >0
);
/*up sex for egfr*/
UPDATE  t_lab_egfr c INNER JOIN  t_person_db p ON c.HOSPCODE=p.hospcode 	AND c.PID=p.pid
SET c.sex=p.SEX, c.age=TIMESTAMPDIFF(year,p.BIRTH,c.DATE_SERV),c.nation=p.NATION;

/*up egfr*/
UPDATE t_lab_egfr c INNER JOIN  tmp_labfu l ON c.HOSPCODE=l.hospcode 
							AND c.PID=l.pid AND c.seq=l.seq AND c.DATE_SERV=l.date_serv
SET c.egfr = l.LABRESULT
WHERE l.LABTEST=15;
/*up egfr_ok*/
UPDATE t_lab_egfr c SET c.egfr_ok = c.egfr;
/*up creatinine*/
UPDATE t_lab_egfr c INNER JOIN  tmp_labfu l ON c.HOSPCODE=l.hospcode 
							AND c.PID=l.pid AND c.seq=l.seq AND c.DATE_SERV=l.date_serv
SET c.creatinine = l.LABRESULT
WHERE l.LABTEST=11;
/*up egfr_ok*/
UPDATE t_lab_egfr c SET c.egfr_ok = egfr_fnc(c.creatinine,c.age,c.sex) WHERE c.creatinine > 0 ;

DROP TABLE IF  EXISTS t_ckd_egfr;
CREATE TABLE IF NOT EXISTS t_ckd_egfr (
egfr_r1 varchar(20) default '0',
egfr_d1 date default null,
egfr_r2 varchar(20) default '0',
egfr_d2 date default null,
egfr_r3 varchar(20) default '0',
egfr_d3 date default null,
egfr_r4 varchar(20) default '0',
egfr_d4 date default null,
day1 int(2) default 0,
day2 int(2) default 0,
day3 int(2) default 0,
sumseq int(2) default 0,
egfr_avg VARCHAR(20) DEFAULT null,
KEY(hospcode),
KEY(pid)
) ENGINE MyISAM as
(SELECT
HOSPCODE,PID,cid,sex,nation,
'0' as 'egfr_r1',
null as egfr_d1,
'0' as 'egfr_r2',
null as egfr_d2,
'0' as 'egfr_r3',
null as egfr_d3,
'0' as 'egfr_r4',
null as egfr_d4,
0 as 'day1',
0 as 'day2',
0 as 'day3',
0 as 'sumseq',
null as 'egfr_avg'
FROM
t_ckd_service
WHERE 
(
      DIAGCODE IN ('N181','N182','N183','N184')
		 OR  (DIAGCODE IN ('N189') AND ( egfr_ok=0 OR  egfr_ok>=15))
     OR (( DIAGCODE IN ('E102','E112','E122','E132','E142')
       OR LEFT( DIAGCODE,3) IN ('I12','I13')
       OR  DIAGCODE='I151')
      AND  egfr_ok>=15)
  ) 
AND DATE_SERV BETWEEN @start_d AND  @end_d
GROUP BY HOSPCODE ,PID
);
/*sumseq*/
UPDATE t_ckd_egfr e  
INNER JOIN (
		SELECT HOSPCODE,PID,COUNT(DISTINCT HOSPCODE ,PID,DATE_SERV) as sumseq
		FROM	t_lab_egfr 
	 WHERE egfr_ok>0		
	  GROUP BY HOSPCODE,PID
) c
SET e.sumseq=c.sumseq
WHERE  e.hospcode=c.HOSPCODE AND e.pid=c.PID;
/*egfr_1*/
UPDATE t_ckd_egfr e  
	INNER JOIN (
		SELECT HOSPCODE,PID,DATE_SERV,egfr_ok 
		FROM t_lab_egfr s 
		WHERE egfr_ok>0 
			AND DATE_SERV =(SELECT DATE_SERV FROM t_lab_egfr s1 WHERE s1.egfr_ok>0 AND s1.HOSPCODE=s.HOSPCODE AND s1.PID=s.PID
																		GROUP BY s1.cid,s1.DATE_SERV ORDER BY s1.date_serv DESC LIMIT 0,1)
		GROUP BY HOSPCODE,PID
		) c
SET e.egfr_r1=c.egfr_ok , e.egfr_d1=c.DATE_SERV
WHERE  e.hospcode=c.HOSPCODE AND e.pid=c.PID;
/*egfr_2*/
UPDATE t_ckd_egfr e  
	INNER JOIN (
		SELECT HOSPCODE,PID,DATE_SERV,egfr_ok 
		FROM t_lab_egfr s 
		WHERE egfr_ok>0 
			AND DATE_SERV =(SELECT DATE_SERV FROM t_lab_egfr s1 WHERE s1.egfr_ok>0 AND s1.HOSPCODE=s.HOSPCODE AND s1.PID=s.PID
																		GROUP BY s1.cid,s1.DATE_SERV ORDER BY s1.date_serv DESC LIMIT 1,1)
		GROUP BY HOSPCODE,PID
		) c
SET e.egfr_r2=c.egfr_ok , e.egfr_d2=c.DATE_SERV
WHERE  e.hospcode=c.HOSPCODE AND e.pid=c.PID;
/*egfr_3*/
UPDATE t_ckd_egfr e  
	INNER JOIN (
		SELECT HOSPCODE,PID,DATE_SERV,egfr_ok 
		FROM t_lab_egfr s 
		WHERE egfr_ok>0 
			AND DATE_SERV =(SELECT DATE_SERV FROM t_lab_egfr s1 WHERE s1.egfr_ok>0 AND s1.HOSPCODE=s.HOSPCODE AND s1.PID=s.PID
																		GROUP BY s1.cid,s1.DATE_SERV ORDER BY s1.date_serv DESC LIMIT 2,1)
		GROUP BY HOSPCODE,PID
		) c
SET e.egfr_r3=c.egfr_ok , e.egfr_d3=c.DATE_SERV
WHERE  e.hospcode=c.HOSPCODE AND e.pid=c.PID;
/*egfr_4*/
UPDATE t_ckd_egfr e  
	INNER JOIN (
		SELECT HOSPCODE,PID,DATE_SERV,egfr_ok 
		FROM t_lab_egfr s 
		WHERE egfr_ok>0 
			AND DATE_SERV =(SELECT DATE_SERV FROM t_lab_egfr s1 WHERE s1.egfr_ok>0 AND s1.HOSPCODE=s.HOSPCODE AND s1.PID=s.PID
																		GROUP BY s1.cid,s1.DATE_SERV ORDER BY s1.date_serv DESC LIMIT 3,1)
		GROUP BY HOSPCODE,PID
		) c
SET e.egfr_r4=c.egfr_ok , e.egfr_d4=c.DATE_SERV
WHERE  e.hospcode=c.HOSPCODE AND e.pid=c.PID;
/*day*/
UPDATE  t_ckd_egfr e   SET e.day1=TIMESTAMPDIFF(day,e.egfr_d2,e.egfr_d1)
,e.day2=TIMESTAMPDIFF(day,e.egfr_d3,e.egfr_d2)
,e.day3=TIMESTAMPDIFF(day,e.egfr_d4,e.egfr_d3);
/*egfr_avg*/
UPDATE  t_ckd_egfr e   SET e.egfr_avg= ROUND((((egfr_r2-egfr_r1) /day1))*365,2)
WHERE e.sumseq = 2;

UPDATE  t_ckd_egfr e   SET e.egfr_avg= ROUND(( ( ((egfr_r3-egfr_r2) /day2) + ((egfr_r2-egfr_r1) /day1) )/2 )*365,2)
WHERE e.sumseq = 3;

UPDATE  t_ckd_egfr e   SET e.egfr_avg= ROUND((( ((egfr_r4-egfr_r3) /day3)  + ((egfr_r3-egfr_r2) /day2) + ((egfr_r2-egfr_r1) /day1) )/3)*365,2)
WHERE e.sumseq > 3;

DROP TABLE IF  EXISTS t_ckd_stage;
CREATE TABLE IF NOT EXISTS t_ckd_stage(
egfr_r2 varchar(20) default '0',
egfr_d2 date default null,
stage_now int DEFAULT 0,
stage_lastyear int DEFAULT 0,
PRIMARY KEY(hospcode,pid)
,KEY(hospcode,pid)
,KEY(cid) 
) ENGINE MyISAM as
(
SELECT 
hospcode,pid,cid,sex,nation,egfr_r1,egfr_d1,null as egfr_r2 ,null as egfr_d2,0 as stage_now,0 as stage_lastyear
FROM
t_ckd_egfr
WHERE  egfr_r1 >0
);

UPDATE t_ckd_stage t INNER JOIN (
SELECT * FROM
(SELECT * FROM t_lab_egfr WHERE date_serv BETWEEN @start_d1 AND @end_d1 ORDER BY date_serv DESC) d1
GROUP BY hospcode,pid
) l ON t.hospcode=l.hospcode AND t.pid=l.pid
SET t.egfr_r2=l.egfr_ok,t.egfr_d2=l.date_serv;

UPDATE t_ckd_stage SET stage_now=IF(egfr_r1 >=90,1,
IF(egfr_r1 BETWEEN 60 AND 89.99,2
,IF(egfr_r1 BETWEEN 30 AND 59.99,3
,IF(egfr_r1 BETWEEN 15 AND 29.99,4
,IF(egfr_r1 <15,5,0
)))))
,
stage_lastyear=IF(egfr_r2 >=90,1,
IF(egfr_r2 BETWEEN 60 AND 89.99,2
,IF(egfr_r2 BETWEEN 30 AND 59.99,3
,IF(egfr_r2 BETWEEN 15 AND 29.99,4
,IF(egfr_r2 <15,5,0
)))))
;
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.3004529;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:265;a:5:{i:0;s:37:"DROP PROCEDURE IF EXISTS t_death_hosp";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.3004529;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:266;a:5:{i:0;s:37:"DROP PROCEDURE IF EXISTS t_death_hosp";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.347254;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:268;a:5:{i:0;s:1895:"CREATE PROCEDURE t_death_hosp()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '40';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
DROP TABLE IF EXISTS t_death_hosp;
CREATE TABLE IF NOT EXISTS t_death_hosp( 
pt_type VARCHAR(1) DEFAULT NULL,
pdx_opd VARCHAR(7) DEFAULT NULL,
pdx_ipd VARCHAR(7) DEFAULT NULL,
code298 VARCHAR(7) DEFAULT NULL,
PRIMARY KEY(hospcode,pid),
KEY(hospcode),
KEY(pid),
KEY(cid),
KEY(date)
 ) ENGINE=MyISAM  AS(

		SELECT DISTINCT
			s.hospcode,s.pid,s.CID,date_serv as date, '1' as pt_type,NULL as pdx_opd,NULL as pdx_ipd,null as code298
			FROM
			tmp_service s 
			WHERE s.typeout in(4,5,6) AND date_serv BETWEEN @start_d AND @end_d
			GROUP BY s.hospcode,s.pid
);

INSERT IGNORE INTO t_death_hosp (hospcode,pid,CID,DATE,pt_type)
(	SELECT
			a.hospcode,a.pid,a.CID,DATE_FORMAT(DATETIME_DISCH,'%Y%m%d'), '2' as pt_type
			FROM
			tmp_admission a
			WHERE (a.DISCHSTATUS in(8,9)  OR a.DISCHTYPE in(8,9)) 
					AND DATE_FORMAT(DATETIME_DISCH,'%Y%m%d') BETWEEN @start_d AND @end_d 
);

UPDATE t_death_hosp t INNER JOIN (
		SELECT HOSPCODE,PID,DATE_SERV,DIAGCODE
		FROM tmp_diag_opd WHERE DIAGTYPE in(1) 
		GROUP BY HOSPCODE,PID,DATE_SERV
)  d SET pdx_opd=d.DIAGCODE WHERE t.hospcode=d.HOSPCODE and t.pid=d.PID AND t.date=d.DATE_SERV;

UPDATE t_death_hosp t INNER JOIN (
		SELECT HOSPCODE,PID,DATE_FORMAT(datetime_disch,'%Y%m%d') date,DIAGCODE
		FROM tmp_diag_ipd WHERE DIAGTYPE in(1) 
		GROUP BY HOSPCODE,PID,date
)  d SET pdx_ipd=d.DIAGCODE WHERE t.hospcode=d.HOSPCODE and t.pid=d.PID AND t.date=d.date;

UPDATE t_death_hosp t INNER JOIN cicd298group i ON t.pdx_ipd=i.icd10 
SET t.code298=i.groupcode298;

UPDATE t_death_hosp t INNER JOIN cicd298group i ON t.pdx_opd=i.icd10 
SET t.code298=i.groupcode298 
WHERE t.code298 is NULL;

 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.347254;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:269;a:5:{i:0;s:1895:"CREATE PROCEDURE t_death_hosp()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '40';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
DROP TABLE IF EXISTS t_death_hosp;
CREATE TABLE IF NOT EXISTS t_death_hosp( 
pt_type VARCHAR(1) DEFAULT NULL,
pdx_opd VARCHAR(7) DEFAULT NULL,
pdx_ipd VARCHAR(7) DEFAULT NULL,
code298 VARCHAR(7) DEFAULT NULL,
PRIMARY KEY(hospcode,pid),
KEY(hospcode),
KEY(pid),
KEY(cid),
KEY(date)
 ) ENGINE=MyISAM  AS(

		SELECT DISTINCT
			s.hospcode,s.pid,s.CID,date_serv as date, '1' as pt_type,NULL as pdx_opd,NULL as pdx_ipd,null as code298
			FROM
			tmp_service s 
			WHERE s.typeout in(4,5,6) AND date_serv BETWEEN @start_d AND @end_d
			GROUP BY s.hospcode,s.pid
);

INSERT IGNORE INTO t_death_hosp (hospcode,pid,CID,DATE,pt_type)
(	SELECT
			a.hospcode,a.pid,a.CID,DATE_FORMAT(DATETIME_DISCH,'%Y%m%d'), '2' as pt_type
			FROM
			tmp_admission a
			WHERE (a.DISCHSTATUS in(8,9)  OR a.DISCHTYPE in(8,9)) 
					AND DATE_FORMAT(DATETIME_DISCH,'%Y%m%d') BETWEEN @start_d AND @end_d 
);

UPDATE t_death_hosp t INNER JOIN (
		SELECT HOSPCODE,PID,DATE_SERV,DIAGCODE
		FROM tmp_diag_opd WHERE DIAGTYPE in(1) 
		GROUP BY HOSPCODE,PID,DATE_SERV
)  d SET pdx_opd=d.DIAGCODE WHERE t.hospcode=d.HOSPCODE and t.pid=d.PID AND t.date=d.DATE_SERV;

UPDATE t_death_hosp t INNER JOIN (
		SELECT HOSPCODE,PID,DATE_FORMAT(datetime_disch,'%Y%m%d') date,DIAGCODE
		FROM tmp_diag_ipd WHERE DIAGTYPE in(1) 
		GROUP BY HOSPCODE,PID,date
)  d SET pdx_ipd=d.DIAGCODE WHERE t.hospcode=d.HOSPCODE and t.pid=d.PID AND t.date=d.date;

UPDATE t_death_hosp t INNER JOIN cicd298group i ON t.pdx_ipd=i.icd10 
SET t.code298=i.groupcode298;

UPDATE t_death_hosp t INNER JOIN cicd298group i ON t.pdx_opd=i.icd10 
SET t.code298=i.groupcode298 
WHERE t.code298 is NULL;

 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.3940539;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:271;a:5:{i:0;s:38:"DROP PROCEDURE IF EXISTS t_labor_abort";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.3940539;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:272;a:5:{i:0;s:38:"DROP PROCEDURE IF EXISTS t_labor_abort";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.4408541;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:274;a:5:{i:0;s:2784:"CREATE PROCEDURE t_labor_abort()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '41';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS t_labor_abort;
CREATE TABLE IF NOT EXISTS t_labor_abort(
lmp date DEFAULT NULL,
edc date DEFAULT NULL,
nation VARCHAR(3) DEFAULT NULL,
bdate date DEFAULT NULL,
teen VARCHAR(1) DEFAULT NULL,
abort VARCHAR(1) DEFAULT NULL,
date_disch date DEFAULT NULL,
fp_date date DEFAULT NULL,
fp VARCHAR(1) DEFAULT NULL,
fptype VARCHAR(1) DEFAULT NULL,
PRIMARY KEY(hospcode,pid),
KEY(hospcode),
KEY(pid),
KEY(cid),
KEY(bdate),
KEY(bhosp),
KEY(bresult),
KEY(lborn),
KEY(age_y)
) ENGINE MyIsam  as
SELECT 
l.*,null as nation ,null as teen,null as abort,null date_disch,null fp_date,null as fp,null as fptype
FROM
tmp_labor l
WHERE l.BDATE BETWEEN @start_d AND @end_d 
GROUP BY hospcode,pid;

UPDATE t_labor_abort l 
INNER JOIN (
SELECT * FROM tmp_diag_ipd 
WHERE ((SUBSTR(diagcode,1,3)  BETWEEN 'O03' AND 'O07')  
		OR (SUBSTR(diagcode,1,3) BETWEEN 'O62' AND 'O84') 
		OR diagcode in('O601','O602','O603'))
GROUP BY HOSPCODE,PID
) d ON l.hospcode=d.hospcode AND l.pid=d.pid 
SET l.BRESULT=d.diagcode
WHERE ((SUBSTR(diagcode,1,3) not BETWEEN 'O03' AND 'O07')  OR
(SUBSTR(diagcode,1,3) not BETWEEN 'O62' AND 'O84') OR diagcode not in('O601','O602','O603'));

INSERT IGNORE INTO t_labor_abort(
	HOSPCODE,PID,BRESULT, BHOSP,D_UPDATE,cid,birth,age_y ,date_disch,nation
)  
(
SELECT
	d.HOSPCODE,d.PID,DIAGCODE  as BRESULT,d.HOSPCODE as BHOSP,d.D_UPDATE, d.cid , p.birth 
	, TIMESTAMPDIFF(year,BIRTH,datetime_disch)  ,DATE_FORMAT(datetime_disch,'%Y%m%d'),p.NATION
FROM
tmp_diag_ipd d INNER JOIN t_person_db p ON d.HOSPCODE=p.HOSPCODE AND d.PID=p.PID
WHERE ((SUBSTR(diagcode,1,3)  BETWEEN 'O03' AND 'O07')  
		OR (SUBSTR(diagcode,1,3) BETWEEN 'O62' AND 'O84') 
		OR diagcode in('O601','O602','O603'))
GROUP BY HOSPCODE,PID
);

UPDATE t_labor_abort SET LBORN=1 
WHERE LBORN=0 AND SBORN=0 AND SUBSTR(BRESULT,1,3) BETWEEN 'O80' AND 'O84';


UPDATE t_labor_abort l INNER JOIN t_person_db p ON p.HOSPCODE=l.HOSPCODE AND p.PID=l.PID 
SET l.nation=p.NATION;

UPDATE t_labor_abort SET teen=1 WHERE age_y < 19;

UPDATE t_labor_abort SET abort=1  WHERE lborn =0 
AND (bresult in('O021','O364') OR  SUBSTR(bresult,1,3) in('O03','O06','O08')) ;

DELETE FROM t_labor_abort WHERE age_y <10 OR age_y is NULL;

UPDATE t_labor_abort l INNER JOIN tmp_fp f ON f.HOSPCODE=l.HOSPCODE AND f.PID=l.PID   
SET fp_date= f.DATE_SERV, l.fptype=f.fptype;

UPDATE t_labor_abort SET fp=1
WHERE   fp_date BETWEEN BDATE and  date_disch ;

UPDATE t_labor_abort SET fp=1
WHERE   TIMESTAMPDIFF(day,BDATE,fp_date) < 15;
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.4408541;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:275;a:5:{i:0;s:2784:"CREATE PROCEDURE t_labor_abort()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '41';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS t_labor_abort;
CREATE TABLE IF NOT EXISTS t_labor_abort(
lmp date DEFAULT NULL,
edc date DEFAULT NULL,
nation VARCHAR(3) DEFAULT NULL,
bdate date DEFAULT NULL,
teen VARCHAR(1) DEFAULT NULL,
abort VARCHAR(1) DEFAULT NULL,
date_disch date DEFAULT NULL,
fp_date date DEFAULT NULL,
fp VARCHAR(1) DEFAULT NULL,
fptype VARCHAR(1) DEFAULT NULL,
PRIMARY KEY(hospcode,pid),
KEY(hospcode),
KEY(pid),
KEY(cid),
KEY(bdate),
KEY(bhosp),
KEY(bresult),
KEY(lborn),
KEY(age_y)
) ENGINE MyIsam  as
SELECT 
l.*,null as nation ,null as teen,null as abort,null date_disch,null fp_date,null as fp,null as fptype
FROM
tmp_labor l
WHERE l.BDATE BETWEEN @start_d AND @end_d 
GROUP BY hospcode,pid;

UPDATE t_labor_abort l 
INNER JOIN (
SELECT * FROM tmp_diag_ipd 
WHERE ((SUBSTR(diagcode,1,3)  BETWEEN 'O03' AND 'O07')  
		OR (SUBSTR(diagcode,1,3) BETWEEN 'O62' AND 'O84') 
		OR diagcode in('O601','O602','O603'))
GROUP BY HOSPCODE,PID
) d ON l.hospcode=d.hospcode AND l.pid=d.pid 
SET l.BRESULT=d.diagcode
WHERE ((SUBSTR(diagcode,1,3) not BETWEEN 'O03' AND 'O07')  OR
(SUBSTR(diagcode,1,3) not BETWEEN 'O62' AND 'O84') OR diagcode not in('O601','O602','O603'));

INSERT IGNORE INTO t_labor_abort(
	HOSPCODE,PID,BRESULT, BHOSP,D_UPDATE,cid,birth,age_y ,date_disch,nation
)  
(
SELECT
	d.HOSPCODE,d.PID,DIAGCODE  as BRESULT,d.HOSPCODE as BHOSP,d.D_UPDATE, d.cid , p.birth 
	, TIMESTAMPDIFF(year,BIRTH,datetime_disch)  ,DATE_FORMAT(datetime_disch,'%Y%m%d'),p.NATION
FROM
tmp_diag_ipd d INNER JOIN t_person_db p ON d.HOSPCODE=p.HOSPCODE AND d.PID=p.PID
WHERE ((SUBSTR(diagcode,1,3)  BETWEEN 'O03' AND 'O07')  
		OR (SUBSTR(diagcode,1,3) BETWEEN 'O62' AND 'O84') 
		OR diagcode in('O601','O602','O603'))
GROUP BY HOSPCODE,PID
);

UPDATE t_labor_abort SET LBORN=1 
WHERE LBORN=0 AND SBORN=0 AND SUBSTR(BRESULT,1,3) BETWEEN 'O80' AND 'O84';


UPDATE t_labor_abort l INNER JOIN t_person_db p ON p.HOSPCODE=l.HOSPCODE AND p.PID=l.PID 
SET l.nation=p.NATION;

UPDATE t_labor_abort SET teen=1 WHERE age_y < 19;

UPDATE t_labor_abort SET abort=1  WHERE lborn =0 
AND (bresult in('O021','O364') OR  SUBSTR(bresult,1,3) in('O03','O06','O08')) ;

DELETE FROM t_labor_abort WHERE age_y <10 OR age_y is NULL;

UPDATE t_labor_abort l INNER JOIN tmp_fp f ON f.HOSPCODE=l.HOSPCODE AND f.PID=l.PID   
SET fp_date= f.DATE_SERV, l.fptype=f.fptype;

UPDATE t_labor_abort SET fp=1
WHERE   fp_date BETWEEN BDATE and  date_disch ;

UPDATE t_labor_abort SET fp=1
WHERE   TIMESTAMPDIFF(day,BDATE,fp_date) < 15;
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.5032539;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:277;a:5:{i:0;s:38:"DROP PROCEDURE IF EXISTS t_nutrition05";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.5032539;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:278;a:5:{i:0;s:38:"DROP PROCEDURE IF EXISTS t_nutrition05";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.5500541;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:280;a:5:{i:0;s:5814:"CREATE PROCEDURE t_nutrition05()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '42';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
SET @start_t1=concat(@b_year-1,'1001');
SET @start_t2=concat(@b_year,'0101');
SET @start_t3=concat(@b_year,'0401');
SET @start_t4=concat(@b_year,'0701');
SET @end_t1=concat(@b_year-1,'1231');
SET @end_t2=concat(@b_year,'0331');
SET @end_t3=concat(@b_year,'0630');
SET @end_t4=concat(@b_year,'0930');

DROP TABLE IF EXISTS t_nutrition05;
CREATE TABLE IF NOT EXISTS t_nutrition05( 
		CID VARCHAR(13) NOT NULL,
		SEX VARCHAR(1) NOT NULL,
		BIRTH DATE  DEFAULT NULL,
		AGE_T1 VARCHAR(5)  DEFAULT NULL,
		AGE_T2 VARCHAR(5)  DEFAULT NULL,
		AGE_T3 VARCHAR(5)  DEFAULT NULL,
		AGE_T4 VARCHAR(5)  DEFAULT NULL,
		DATE_SERV1 DATE DEFAULT NULL,
		DATE_SERV2 DATE DEFAULT NULL,
		DATE_SERV3 DATE DEFAULT NULL,
		DATE_SERV4 DATE DEFAULT NULL,
		AGE_MS1 VARCHAR(5)  DEFAULT NULL,
		AGE_MS2 VARCHAR(5)  DEFAULT NULL,
		AGE_MS3 VARCHAR(5)  DEFAULT NULL,
		AGE_MS4 VARCHAR(5)  DEFAULT NULL,
		WEIGHT1 DECIMAL(5,1)  DEFAULT 0,
		WEIGHT2 DECIMAL(5,1)  DEFAULT 0,
		WEIGHT3 DECIMAL(5,1)  DEFAULT 0,
		WEIGHT4 DECIMAL(5,1)  DEFAULT 0,
		HEIGHT1 INT(3)  DEFAULT 0,
		HEIGHT2 INT(3)  DEFAULT 0,
		HEIGHT3 INT(3)  DEFAULT 0,
		HEIGHT4 INT(3)  DEFAULT 0,
		W_S1 VARCHAR(1)  DEFAULT NULL,
		W_S2 VARCHAR(1)  DEFAULT NULL,
		W_S3 VARCHAR(1)  DEFAULT NULL,
		W_S4 VARCHAR(1)  DEFAULT NULL,
		H_S1 VARCHAR(1)  DEFAULT NULL,
		H_S2 VARCHAR(1)  DEFAULT NULL,
		H_S3 VARCHAR(1)  DEFAULT NULL,
		H_S4 VARCHAR(1)  DEFAULT NULL,
		WH1 VARCHAR(1)  DEFAULT NULL,
		WH2 VARCHAR(1)  DEFAULT NULL,
		WH3 VARCHAR(1)  DEFAULT NULL,
		WH4 VARCHAR(1)  DEFAULT NULL,
		hospcode VARCHAR(5)  DEFAULT NULL,
		typearea VARCHAR(1)  DEFAULT NULL,
		PRIMARY KEY (CID)
) ENGINE MyISAM DEFAULT CHARACTER SET=utf8;
/*เพิ่มข้อมูลคน*/
INSERT IGNORE INTO t_nutrition05 (cid,birth,sex,AGE_T1,AGE_T2,AGE_T3,AGE_T4,hospcode,typearea)
SELECT
		p.cid,p.BIRTH,p.SEX
		,TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@end_t1,'%Y%m%d')) AGE_T1
		,TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@end_t2,'%Y%m%d')) AGE_T2
		,TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@end_t3,'%Y%m%d')) AGE_T3
		,TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@end_t4,'%Y%m%d')) AGE_T4
		,check_hosp,check_typearea
FROM  t_person_cid p 
WHERE   TIMESTAMPDIFF(day,p.BIRTH,NOW())>1  AND 
		(
			TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@end_t1,'%Y%m%d'))  <6 OR
			TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@end_t2,'%Y%m%d'))  <6 OR
			TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@end_t3,'%Y%m%d'))  <6 OR
			TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@end_t4,'%Y%m%d'))  <6 
		)
GROUP BY p.cid;

/*เพิ่มบริการตามไตรมาส*/
UPDATE t_nutrition05 p INNER JOIN 
(SELECT * FROM 
			(SELECT cid,DATE_SERV,WEIGHT,HEIGHT FROM tmp_nutrition 
				WHERE DATE_SERV BETWEEN @start_t1 AND @end_t1 
				ORDER BY DATE_SERV DESC ) as t1 GROUP BY cid) as n
ON p.cid=n.cid  SET p.DATE_SERV1=n.DATE_SERV ,p.HEIGHT1=n.height ,p.WEIGHT1=n.weight;

UPDATE t_nutrition05 p INNER JOIN 
(SELECT * FROM 
			(SELECT cid,DATE_SERV,WEIGHT,HEIGHT FROM tmp_nutrition 
				WHERE DATE_SERV BETWEEN @start_t2 AND @end_t2
				ORDER BY DATE_SERV DESC ) as t1 GROUP BY cid) as n
ON p.cid=n.cid  SET p.DATE_SERV2=n.DATE_SERV ,p.HEIGHT2=n.height ,p.WEIGHT2=n.weight;

UPDATE t_nutrition05 p INNER JOIN 
(SELECT * FROM 
			(SELECT cid,DATE_SERV,WEIGHT,HEIGHT FROM tmp_nutrition 
				WHERE DATE_SERV BETWEEN @start_t3 AND @end_t3
				ORDER BY DATE_SERV DESC ) as t1 GROUP BY cid) as n
ON p.cid=n.cid  SET p.DATE_SERV3=n.DATE_SERV ,p.HEIGHT3=n.height ,p.WEIGHT3=n.weight;

UPDATE t_nutrition05 p INNER JOIN 
(SELECT * FROM 
			(SELECT cid,DATE_SERV,WEIGHT,HEIGHT FROM tmp_nutrition 
				WHERE DATE_SERV BETWEEN @start_t4 AND @end_t4
				ORDER BY DATE_SERV DESC ) as t1 GROUP BY cid) as n
ON p.cid=n.cid  SET p.DATE_SERV4=n.DATE_SERV ,p.HEIGHT4=n.height ,p.WEIGHT4=n.weight;
/*คำนวนอายุเป็นเดือนณวันรับบริการ*/
UPDATE t_nutrition05  SET AGE_MS1 = TIMESTAMPDIFF(MONTH,BIRTH,DATE_SERV1)
		,AGE_MS2 = TIMESTAMPDIFF(MONTH,BIRTH,DATE_SERV2)
		,AGE_MS3 = TIMESTAMPDIFF(MONTH,BIRTH,DATE_SERV3)
		,AGE_MS4 = TIMESTAMPDIFF(MONTH,BIRTH,DATE_SERV4);
/*คำนวน Nutrition_CAL*/
UPDATE t_nutrition05 SET W_S1=nutri_cal(AGE_MS1,SEX,'1',HEIGHT1,WEIGHT1) WHERE AGE_MS1 >0 AND WEIGHT1 >0;
UPDATE t_nutrition05 SET W_S2=nutri_cal(AGE_MS2,SEX,'1',HEIGHT2,WEIGHT2) WHERE AGE_MS2 >0 AND WEIGHT2 >0;
UPDATE t_nutrition05 SET W_S3=nutri_cal(AGE_MS3,SEX,'1',HEIGHT3,WEIGHT3) WHERE AGE_MS3 >0 AND WEIGHT3 >0;
UPDATE t_nutrition05 SET W_S4=nutri_cal(AGE_MS4,SEX,'1',HEIGHT4,WEIGHT4) WHERE AGE_MS4 >0 AND WEIGHT4 >0;

UPDATE t_nutrition05 SET H_S1=nutri_cal(AGE_MS1,SEX,'2',HEIGHT1,WEIGHT1) WHERE AGE_MS1 >0  AND HEIGHT1 >0;
UPDATE t_nutrition05 SET H_S2=nutri_cal(AGE_MS2,SEX,'2',HEIGHT2,WEIGHT2) WHERE AGE_MS2 >0  AND HEIGHT2 >0;
UPDATE t_nutrition05 SET H_S3=nutri_cal(AGE_MS3,SEX,'2',HEIGHT3,WEIGHT3) WHERE AGE_MS3 >0  AND HEIGHT3 >0;
UPDATE t_nutrition05 SET H_S4=nutri_cal(AGE_MS4,SEX,'2',HEIGHT4,WEIGHT4) WHERE AGE_MS4 >0  AND HEIGHT4 >0;

UPDATE t_nutrition05 SET WH1=nutri_cal(AGE_MS1,SEX,'3',HEIGHT1,WEIGHT1) WHERE AGE_MS1 >0 AND WEIGHT1 >0 AND HEIGHT1 >0 ; 
UPDATE t_nutrition05 SET WH2=nutri_cal(AGE_MS2,SEX,'3',HEIGHT2,WEIGHT2) WHERE AGE_MS2 >0 AND WEIGHT2 >0 AND HEIGHT2 >0 ; 
UPDATE t_nutrition05 SET WH3=nutri_cal(AGE_MS3,SEX,'3',HEIGHT3,WEIGHT3) WHERE AGE_MS3 >0 AND WEIGHT3 >0 AND HEIGHT3 >0 ; 
UPDATE t_nutrition05 SET WH4=nutri_cal(AGE_MS4,SEX,'3',HEIGHT4,WEIGHT4) WHERE AGE_MS4 >0 AND WEIGHT4 >0 AND HEIGHT4 >0 ; 

 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.5500541;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:281;a:5:{i:0;s:5814:"CREATE PROCEDURE t_nutrition05()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '42';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
SET @start_t1=concat(@b_year-1,'1001');
SET @start_t2=concat(@b_year,'0101');
SET @start_t3=concat(@b_year,'0401');
SET @start_t4=concat(@b_year,'0701');
SET @end_t1=concat(@b_year-1,'1231');
SET @end_t2=concat(@b_year,'0331');
SET @end_t3=concat(@b_year,'0630');
SET @end_t4=concat(@b_year,'0930');

DROP TABLE IF EXISTS t_nutrition05;
CREATE TABLE IF NOT EXISTS t_nutrition05( 
		CID VARCHAR(13) NOT NULL,
		SEX VARCHAR(1) NOT NULL,
		BIRTH DATE  DEFAULT NULL,
		AGE_T1 VARCHAR(5)  DEFAULT NULL,
		AGE_T2 VARCHAR(5)  DEFAULT NULL,
		AGE_T3 VARCHAR(5)  DEFAULT NULL,
		AGE_T4 VARCHAR(5)  DEFAULT NULL,
		DATE_SERV1 DATE DEFAULT NULL,
		DATE_SERV2 DATE DEFAULT NULL,
		DATE_SERV3 DATE DEFAULT NULL,
		DATE_SERV4 DATE DEFAULT NULL,
		AGE_MS1 VARCHAR(5)  DEFAULT NULL,
		AGE_MS2 VARCHAR(5)  DEFAULT NULL,
		AGE_MS3 VARCHAR(5)  DEFAULT NULL,
		AGE_MS4 VARCHAR(5)  DEFAULT NULL,
		WEIGHT1 DECIMAL(5,1)  DEFAULT 0,
		WEIGHT2 DECIMAL(5,1)  DEFAULT 0,
		WEIGHT3 DECIMAL(5,1)  DEFAULT 0,
		WEIGHT4 DECIMAL(5,1)  DEFAULT 0,
		HEIGHT1 INT(3)  DEFAULT 0,
		HEIGHT2 INT(3)  DEFAULT 0,
		HEIGHT3 INT(3)  DEFAULT 0,
		HEIGHT4 INT(3)  DEFAULT 0,
		W_S1 VARCHAR(1)  DEFAULT NULL,
		W_S2 VARCHAR(1)  DEFAULT NULL,
		W_S3 VARCHAR(1)  DEFAULT NULL,
		W_S4 VARCHAR(1)  DEFAULT NULL,
		H_S1 VARCHAR(1)  DEFAULT NULL,
		H_S2 VARCHAR(1)  DEFAULT NULL,
		H_S3 VARCHAR(1)  DEFAULT NULL,
		H_S4 VARCHAR(1)  DEFAULT NULL,
		WH1 VARCHAR(1)  DEFAULT NULL,
		WH2 VARCHAR(1)  DEFAULT NULL,
		WH3 VARCHAR(1)  DEFAULT NULL,
		WH4 VARCHAR(1)  DEFAULT NULL,
		hospcode VARCHAR(5)  DEFAULT NULL,
		typearea VARCHAR(1)  DEFAULT NULL,
		PRIMARY KEY (CID)
) ENGINE MyISAM DEFAULT CHARACTER SET=utf8;
/*เพิ่มข้อมูลคน*/
INSERT IGNORE INTO t_nutrition05 (cid,birth,sex,AGE_T1,AGE_T2,AGE_T3,AGE_T4,hospcode,typearea)
SELECT
		p.cid,p.BIRTH,p.SEX
		,TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@end_t1,'%Y%m%d')) AGE_T1
		,TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@end_t2,'%Y%m%d')) AGE_T2
		,TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@end_t3,'%Y%m%d')) AGE_T3
		,TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@end_t4,'%Y%m%d')) AGE_T4
		,check_hosp,check_typearea
FROM  t_person_cid p 
WHERE   TIMESTAMPDIFF(day,p.BIRTH,NOW())>1  AND 
		(
			TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@end_t1,'%Y%m%d'))  <6 OR
			TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@end_t2,'%Y%m%d'))  <6 OR
			TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@end_t3,'%Y%m%d'))  <6 OR
			TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@end_t4,'%Y%m%d'))  <6 
		)
GROUP BY p.cid;

/*เพิ่มบริการตามไตรมาส*/
UPDATE t_nutrition05 p INNER JOIN 
(SELECT * FROM 
			(SELECT cid,DATE_SERV,WEIGHT,HEIGHT FROM tmp_nutrition 
				WHERE DATE_SERV BETWEEN @start_t1 AND @end_t1 
				ORDER BY DATE_SERV DESC ) as t1 GROUP BY cid) as n
ON p.cid=n.cid  SET p.DATE_SERV1=n.DATE_SERV ,p.HEIGHT1=n.height ,p.WEIGHT1=n.weight;

UPDATE t_nutrition05 p INNER JOIN 
(SELECT * FROM 
			(SELECT cid,DATE_SERV,WEIGHT,HEIGHT FROM tmp_nutrition 
				WHERE DATE_SERV BETWEEN @start_t2 AND @end_t2
				ORDER BY DATE_SERV DESC ) as t1 GROUP BY cid) as n
ON p.cid=n.cid  SET p.DATE_SERV2=n.DATE_SERV ,p.HEIGHT2=n.height ,p.WEIGHT2=n.weight;

UPDATE t_nutrition05 p INNER JOIN 
(SELECT * FROM 
			(SELECT cid,DATE_SERV,WEIGHT,HEIGHT FROM tmp_nutrition 
				WHERE DATE_SERV BETWEEN @start_t3 AND @end_t3
				ORDER BY DATE_SERV DESC ) as t1 GROUP BY cid) as n
ON p.cid=n.cid  SET p.DATE_SERV3=n.DATE_SERV ,p.HEIGHT3=n.height ,p.WEIGHT3=n.weight;

UPDATE t_nutrition05 p INNER JOIN 
(SELECT * FROM 
			(SELECT cid,DATE_SERV,WEIGHT,HEIGHT FROM tmp_nutrition 
				WHERE DATE_SERV BETWEEN @start_t4 AND @end_t4
				ORDER BY DATE_SERV DESC ) as t1 GROUP BY cid) as n
ON p.cid=n.cid  SET p.DATE_SERV4=n.DATE_SERV ,p.HEIGHT4=n.height ,p.WEIGHT4=n.weight;
/*คำนวนอายุเป็นเดือนณวันรับบริการ*/
UPDATE t_nutrition05  SET AGE_MS1 = TIMESTAMPDIFF(MONTH,BIRTH,DATE_SERV1)
		,AGE_MS2 = TIMESTAMPDIFF(MONTH,BIRTH,DATE_SERV2)
		,AGE_MS3 = TIMESTAMPDIFF(MONTH,BIRTH,DATE_SERV3)
		,AGE_MS4 = TIMESTAMPDIFF(MONTH,BIRTH,DATE_SERV4);
/*คำนวน Nutrition_CAL*/
UPDATE t_nutrition05 SET W_S1=nutri_cal(AGE_MS1,SEX,'1',HEIGHT1,WEIGHT1) WHERE AGE_MS1 >0 AND WEIGHT1 >0;
UPDATE t_nutrition05 SET W_S2=nutri_cal(AGE_MS2,SEX,'1',HEIGHT2,WEIGHT2) WHERE AGE_MS2 >0 AND WEIGHT2 >0;
UPDATE t_nutrition05 SET W_S3=nutri_cal(AGE_MS3,SEX,'1',HEIGHT3,WEIGHT3) WHERE AGE_MS3 >0 AND WEIGHT3 >0;
UPDATE t_nutrition05 SET W_S4=nutri_cal(AGE_MS4,SEX,'1',HEIGHT4,WEIGHT4) WHERE AGE_MS4 >0 AND WEIGHT4 >0;

UPDATE t_nutrition05 SET H_S1=nutri_cal(AGE_MS1,SEX,'2',HEIGHT1,WEIGHT1) WHERE AGE_MS1 >0  AND HEIGHT1 >0;
UPDATE t_nutrition05 SET H_S2=nutri_cal(AGE_MS2,SEX,'2',HEIGHT2,WEIGHT2) WHERE AGE_MS2 >0  AND HEIGHT2 >0;
UPDATE t_nutrition05 SET H_S3=nutri_cal(AGE_MS3,SEX,'2',HEIGHT3,WEIGHT3) WHERE AGE_MS3 >0  AND HEIGHT3 >0;
UPDATE t_nutrition05 SET H_S4=nutri_cal(AGE_MS4,SEX,'2',HEIGHT4,WEIGHT4) WHERE AGE_MS4 >0  AND HEIGHT4 >0;

UPDATE t_nutrition05 SET WH1=nutri_cal(AGE_MS1,SEX,'3',HEIGHT1,WEIGHT1) WHERE AGE_MS1 >0 AND WEIGHT1 >0 AND HEIGHT1 >0 ; 
UPDATE t_nutrition05 SET WH2=nutri_cal(AGE_MS2,SEX,'3',HEIGHT2,WEIGHT2) WHERE AGE_MS2 >0 AND WEIGHT2 >0 AND HEIGHT2 >0 ; 
UPDATE t_nutrition05 SET WH3=nutri_cal(AGE_MS3,SEX,'3',HEIGHT3,WEIGHT3) WHERE AGE_MS3 >0 AND WEIGHT3 >0 AND HEIGHT3 >0 ; 
UPDATE t_nutrition05 SET WH4=nutri_cal(AGE_MS4,SEX,'3',HEIGHT4,WEIGHT4) WHERE AGE_MS4 >0 AND WEIGHT4 >0 AND HEIGHT4 >0 ; 

 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.6124539;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:283;a:5:{i:0;s:37:"DROP PROCEDURE IF EXISTS t_nutrition6";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.6124539;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:284;a:5:{i:0;s:37:"DROP PROCEDURE IF EXISTS t_nutrition6";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.6592541;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:286;a:5:{i:0;s:3318:"CREATE PROCEDURE t_nutrition6()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '43';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
SET @start_te1=concat(@b_year-1,'1001');
SET @start_te2=concat(@b_year,'0501');
SET @end_te1=concat(@b_year-1,'1231');
SET @end_te2=concat(@b_year,'0731');

DROP TABLE IF EXISTS t_nutrition6up;
CREATE TABLE IF NOT EXISTS t_nutrition6up( 
		CID VARCHAR(13) NOT NULL,
		SEX VARCHAR(1) NOT NULL,
		BIRTH DATE  DEFAULT NULL,
		AGE_T1 VARCHAR(5)  DEFAULT NULL,
		AGE_T2 VARCHAR(5)  DEFAULT NULL,
		DATE_SERV1 DATE DEFAULT NULL,
		DATE_SERV2 DATE DEFAULT NULL,
		AGE_MS1 VARCHAR(5)  DEFAULT NULL,
		AGE_MS2 VARCHAR(5)  DEFAULT NULL,
		WEIGHT1 DECIMAL(5,1)  DEFAULT 0,
		WEIGHT2 DECIMAL(5,1)  DEFAULT 0,
		HEIGHT1 INT(3)  DEFAULT 0,
		HEIGHT2 INT(3)  DEFAULT 0,
		W_S1 VARCHAR(1)  DEFAULT NULL,
		W_S2 VARCHAR(1)  DEFAULT NULL,
		H_S1 VARCHAR(1)  DEFAULT NULL,
		H_S2 VARCHAR(1)  DEFAULT NULL,
		WH1 VARCHAR(1)  DEFAULT NULL,
		WH2 VARCHAR(1)  DEFAULT NULL,
		hospcode VARCHAR(5)  DEFAULT NULL,
		typearea VARCHAR(1)  DEFAULT NULL,
		PRIMARY KEY (CID)
) ENGINE MyISAM DEFAULT CHARACTER SET=utf8;
/*เพิ่มข้อมูลคน*/
INSERT IGNORE INTO t_nutrition6up (cid,birth,sex,AGE_T1,AGE_T2,hospcode,typearea)
SELECT
		p.cid,p.BIRTH,p.SEX
		,TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@end_te1,'%Y%m%d')) AGE_T1
		,TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@end_te2,'%Y%m%d')) AGE_T2
		,check_hosp,check_typearea
FROM  t_person_cid p 
WHERE  
		(
			TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@end_te1,'%Y%m%d'))  BETWEEN 6 AND 18 OR
			TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@end_te2,'%Y%m%d'))  BETWEEN 6 AND 18 
		)
 GROUP BY p.cid;

/*เพิ่มบริการตามไตรมาส*/
UPDATE t_nutrition6up p INNER JOIN 
(SELECT * FROM 
			(SELECT cid,DATE_SERV,WEIGHT,HEIGHT FROM tmp_nutrition 
				WHERE DATE_SERV BETWEEN @start_te1 AND @end_te1 
				ORDER BY DATE_SERV DESC ) as t1 GROUP BY cid) as n
ON p.cid=n.cid  SET p.DATE_SERV1=n.DATE_SERV ,p.HEIGHT1=n.height ,p.WEIGHT1=n.weight ;


UPDATE t_nutrition6up p INNER JOIN 
(SELECT * FROM 
			(SELECT cid,DATE_SERV,WEIGHT,HEIGHT FROM tmp_nutrition 
				WHERE DATE_SERV BETWEEN @start_te2 AND @end_te2
				ORDER BY DATE_SERV DESC ) as t1 GROUP BY cid) as n
ON p.cid=n.cid  SET p.DATE_SERV2=n.DATE_SERV ,p.HEIGHT2=n.height ,p.WEIGHT2=n.weight;

/*คำนวนอายุเป็นเดือนณวันรับบริการ*/
UPDATE t_nutrition6up  SET AGE_MS1 = TIMESTAMPDIFF(MONTH,BIRTH,DATE_SERV1)
		,AGE_MS2 = TIMESTAMPDIFF(MONTH,BIRTH,DATE_SERV2);
/*คำนวน Nutrition_CAL*/
UPDATE t_nutrition6up SET W_S1=nutri_cal(AGE_MS1,SEX,'1',HEIGHT1,WEIGHT1) WHERE AGE_MS1 >1;
UPDATE t_nutrition6up SET W_S2=nutri_cal(AGE_MS2,SEX,'1',HEIGHT2,WEIGHT2) WHERE AGE_MS2 >1;

UPDATE t_nutrition6up SET H_S1=nutri_cal(AGE_MS1,SEX,'2',HEIGHT1,WEIGHT1) WHERE AGE_MS1 >1;
UPDATE t_nutrition6up SET H_S2=nutri_cal(AGE_MS2,SEX,'2',HEIGHT2,WEIGHT2) WHERE AGE_MS2 >1;

UPDATE t_nutrition6up SET WH1=nutri_cal(AGE_MS1,SEX,'3',HEIGHT1,WEIGHT1) WHERE AGE_MS1 >1;
UPDATE t_nutrition6up SET WH2=nutri_cal(AGE_MS2,SEX,'3',HEIGHT2,WEIGHT2) WHERE AGE_MS2 >1;

 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.6592541;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:287;a:5:{i:0;s:3318:"CREATE PROCEDURE t_nutrition6()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '43';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
SET @start_te1=concat(@b_year-1,'1001');
SET @start_te2=concat(@b_year,'0501');
SET @end_te1=concat(@b_year-1,'1231');
SET @end_te2=concat(@b_year,'0731');

DROP TABLE IF EXISTS t_nutrition6up;
CREATE TABLE IF NOT EXISTS t_nutrition6up( 
		CID VARCHAR(13) NOT NULL,
		SEX VARCHAR(1) NOT NULL,
		BIRTH DATE  DEFAULT NULL,
		AGE_T1 VARCHAR(5)  DEFAULT NULL,
		AGE_T2 VARCHAR(5)  DEFAULT NULL,
		DATE_SERV1 DATE DEFAULT NULL,
		DATE_SERV2 DATE DEFAULT NULL,
		AGE_MS1 VARCHAR(5)  DEFAULT NULL,
		AGE_MS2 VARCHAR(5)  DEFAULT NULL,
		WEIGHT1 DECIMAL(5,1)  DEFAULT 0,
		WEIGHT2 DECIMAL(5,1)  DEFAULT 0,
		HEIGHT1 INT(3)  DEFAULT 0,
		HEIGHT2 INT(3)  DEFAULT 0,
		W_S1 VARCHAR(1)  DEFAULT NULL,
		W_S2 VARCHAR(1)  DEFAULT NULL,
		H_S1 VARCHAR(1)  DEFAULT NULL,
		H_S2 VARCHAR(1)  DEFAULT NULL,
		WH1 VARCHAR(1)  DEFAULT NULL,
		WH2 VARCHAR(1)  DEFAULT NULL,
		hospcode VARCHAR(5)  DEFAULT NULL,
		typearea VARCHAR(1)  DEFAULT NULL,
		PRIMARY KEY (CID)
) ENGINE MyISAM DEFAULT CHARACTER SET=utf8;
/*เพิ่มข้อมูลคน*/
INSERT IGNORE INTO t_nutrition6up (cid,birth,sex,AGE_T1,AGE_T2,hospcode,typearea)
SELECT
		p.cid,p.BIRTH,p.SEX
		,TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@end_te1,'%Y%m%d')) AGE_T1
		,TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@end_te2,'%Y%m%d')) AGE_T2
		,check_hosp,check_typearea
FROM  t_person_cid p 
WHERE  
		(
			TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@end_te1,'%Y%m%d'))  BETWEEN 6 AND 18 OR
			TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@end_te2,'%Y%m%d'))  BETWEEN 6 AND 18 
		)
 GROUP BY p.cid;

/*เพิ่มบริการตามไตรมาส*/
UPDATE t_nutrition6up p INNER JOIN 
(SELECT * FROM 
			(SELECT cid,DATE_SERV,WEIGHT,HEIGHT FROM tmp_nutrition 
				WHERE DATE_SERV BETWEEN @start_te1 AND @end_te1 
				ORDER BY DATE_SERV DESC ) as t1 GROUP BY cid) as n
ON p.cid=n.cid  SET p.DATE_SERV1=n.DATE_SERV ,p.HEIGHT1=n.height ,p.WEIGHT1=n.weight ;


UPDATE t_nutrition6up p INNER JOIN 
(SELECT * FROM 
			(SELECT cid,DATE_SERV,WEIGHT,HEIGHT FROM tmp_nutrition 
				WHERE DATE_SERV BETWEEN @start_te2 AND @end_te2
				ORDER BY DATE_SERV DESC ) as t1 GROUP BY cid) as n
ON p.cid=n.cid  SET p.DATE_SERV2=n.DATE_SERV ,p.HEIGHT2=n.height ,p.WEIGHT2=n.weight;

/*คำนวนอายุเป็นเดือนณวันรับบริการ*/
UPDATE t_nutrition6up  SET AGE_MS1 = TIMESTAMPDIFF(MONTH,BIRTH,DATE_SERV1)
		,AGE_MS2 = TIMESTAMPDIFF(MONTH,BIRTH,DATE_SERV2);
/*คำนวน Nutrition_CAL*/
UPDATE t_nutrition6up SET W_S1=nutri_cal(AGE_MS1,SEX,'1',HEIGHT1,WEIGHT1) WHERE AGE_MS1 >1;
UPDATE t_nutrition6up SET W_S2=nutri_cal(AGE_MS2,SEX,'1',HEIGHT2,WEIGHT2) WHERE AGE_MS2 >1;

UPDATE t_nutrition6up SET H_S1=nutri_cal(AGE_MS1,SEX,'2',HEIGHT1,WEIGHT1) WHERE AGE_MS1 >1;
UPDATE t_nutrition6up SET H_S2=nutri_cal(AGE_MS2,SEX,'2',HEIGHT2,WEIGHT2) WHERE AGE_MS2 >1;

UPDATE t_nutrition6up SET WH1=nutri_cal(AGE_MS1,SEX,'3',HEIGHT1,WEIGHT1) WHERE AGE_MS1 >1;
UPDATE t_nutrition6up SET WH2=nutri_cal(AGE_MS2,SEX,'3',HEIGHT2,WEIGHT2) WHERE AGE_MS2 >1;

 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.7216539;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:289;a:5:{i:0;s:38:"DROP PROCEDURE IF EXISTS t_nutrition15";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.7216539;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:290;a:5:{i:0;s:38:"DROP PROCEDURE IF EXISTS t_nutrition15";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.784054;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:292;a:5:{i:0;s:2321:"CREATE PROCEDURE t_nutrition15()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '44';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS t_nutrition15up;
CREATE TABLE IF NOT EXISTS t_nutrition15up( 
		CID VARCHAR(13) NOT NULL,
		SEX VARCHAR(1) NOT NULL,
		BIRTH DATE  DEFAULT NULL,
		AGE_Y VARCHAR(5)  DEFAULT NULL,
		AGE_YS VARCHAR(5)  DEFAULT NULL,
		DATE_SERV DATE DEFAULT NULL,		
		WEIGHT DECIMAL(5,1)  DEFAULT 0,
		HEIGHT INT(3)  DEFAULT 0,
		L_BMI DECIMAL(10,1)  DEFAULT 0,
		L_WAIST INT(3)  DEFAULT 0,
		hospcode VARCHAR(5)  DEFAULT NULL,
		typearea VARCHAR(1)  DEFAULT NULL,
		PRIMARY KEY (CID)
) ENGINE MyISAM DEFAULT CHARACTER SET=utf8;
/*เพิ่มข้อมูลคน*/
INSERT IGNORE INTO t_nutrition15up (cid,birth,sex,age_y,hospcode,typearea)
SELECT
		p.cid,p.BIRTH,p.SEX,age_y	,check_hosp,check_typearea
FROM  t_person_cid p 
WHERE  TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@start_d,'%Y%m%d'))  >=15 
 GROUP BY p.cid;

UPDATE t_nutrition15up p INNER JOIN 
(SELECT * FROM 
			(SELECT cid,DATE_SERV,WEIGHT,HEIGHT FROM tmp_nutrition 
				WHERE DATE_SERV BETWEEN @start_d AND @end_d
				ORDER BY DATE_SERV DESC ) as t1 GROUP BY cid) as n
ON p.cid=n.cid  SET p.DATE_SERV=n.DATE_SERV , p.HEIGHT=n.height , p.WEIGHT=n.weight;

UPDATE t_nutrition15up p INNER JOIN 
(SELECT * FROM 
			(SELECT cid,DATE_SERV,WEIGHT,HEIGHT,WAIST_CM FROM tmp_ncdscreen 
				WHERE DATE_SERV BETWEEN @start_d AND @end_d
				ORDER BY DATE_SERV DESC ) as t1 GROUP BY cid) as n
ON p.cid=n.cid  SET p.DATE_SERV=n.DATE_SERV ,p.HEIGHT=n.height ,p.WEIGHT=n.weight,p.L_WAIST=n.WAIST_CM
WHERE p.WEIGHT in(0) OR p.HEIGHT in(0) OR p.date_serv < n.date_serv;


UPDATE t_nutrition15up p INNER JOIN 
(SELECT * FROM 
			(SELECT cid,DATE_SERV,WEIGHT,HEIGHT,WAIST_CM FROM tmp_ncdscreen 
				WHERE DATE_SERV BETWEEN @start_d AND @end_d
				ORDER BY DATE_SERV DESC ) as t1 GROUP BY cid) as n
ON p.cid=n.cid  SET p.DATE_SERV=n.DATE_SERV ,p.HEIGHT=n.height ,p.WEIGHT=n.weight,p.L_WAIST=n.WAIST_CM
WHERE p.L_WAIST in(0) AND n.WAIST_CM >0;

UPDATE t_nutrition15up SET AGE_YS=TIMESTAMPDIFF(YEAR,birth,date_serv);

UPDATE t_nutrition15up SET L_BMI=round(WEIGHT/((HEIGHT/100)*(HEIGHT/100)),2) ;
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.784054;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:293;a:5:{i:0;s:2321:"CREATE PROCEDURE t_nutrition15()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '44';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS t_nutrition15up;
CREATE TABLE IF NOT EXISTS t_nutrition15up( 
		CID VARCHAR(13) NOT NULL,
		SEX VARCHAR(1) NOT NULL,
		BIRTH DATE  DEFAULT NULL,
		AGE_Y VARCHAR(5)  DEFAULT NULL,
		AGE_YS VARCHAR(5)  DEFAULT NULL,
		DATE_SERV DATE DEFAULT NULL,		
		WEIGHT DECIMAL(5,1)  DEFAULT 0,
		HEIGHT INT(3)  DEFAULT 0,
		L_BMI DECIMAL(10,1)  DEFAULT 0,
		L_WAIST INT(3)  DEFAULT 0,
		hospcode VARCHAR(5)  DEFAULT NULL,
		typearea VARCHAR(1)  DEFAULT NULL,
		PRIMARY KEY (CID)
) ENGINE MyISAM DEFAULT CHARACTER SET=utf8;
/*เพิ่มข้อมูลคน*/
INSERT IGNORE INTO t_nutrition15up (cid,birth,sex,age_y,hospcode,typearea)
SELECT
		p.cid,p.BIRTH,p.SEX,age_y	,check_hosp,check_typearea
FROM  t_person_cid p 
WHERE  TIMESTAMPDIFF(YEAR,p.birth,DATE_FORMAT(@start_d,'%Y%m%d'))  >=15 
 GROUP BY p.cid;

UPDATE t_nutrition15up p INNER JOIN 
(SELECT * FROM 
			(SELECT cid,DATE_SERV,WEIGHT,HEIGHT FROM tmp_nutrition 
				WHERE DATE_SERV BETWEEN @start_d AND @end_d
				ORDER BY DATE_SERV DESC ) as t1 GROUP BY cid) as n
ON p.cid=n.cid  SET p.DATE_SERV=n.DATE_SERV , p.HEIGHT=n.height , p.WEIGHT=n.weight;

UPDATE t_nutrition15up p INNER JOIN 
(SELECT * FROM 
			(SELECT cid,DATE_SERV,WEIGHT,HEIGHT,WAIST_CM FROM tmp_ncdscreen 
				WHERE DATE_SERV BETWEEN @start_d AND @end_d
				ORDER BY DATE_SERV DESC ) as t1 GROUP BY cid) as n
ON p.cid=n.cid  SET p.DATE_SERV=n.DATE_SERV ,p.HEIGHT=n.height ,p.WEIGHT=n.weight,p.L_WAIST=n.WAIST_CM
WHERE p.WEIGHT in(0) OR p.HEIGHT in(0) OR p.date_serv < n.date_serv;


UPDATE t_nutrition15up p INNER JOIN 
(SELECT * FROM 
			(SELECT cid,DATE_SERV,WEIGHT,HEIGHT,WAIST_CM FROM tmp_ncdscreen 
				WHERE DATE_SERV BETWEEN @start_d AND @end_d
				ORDER BY DATE_SERV DESC ) as t1 GROUP BY cid) as n
ON p.cid=n.cid  SET p.DATE_SERV=n.DATE_SERV ,p.HEIGHT=n.height ,p.WEIGHT=n.weight,p.L_WAIST=n.WAIST_CM
WHERE p.L_WAIST in(0) AND n.WAIST_CM >0;

UPDATE t_nutrition15up SET AGE_YS=TIMESTAMPDIFF(YEAR,birth,date_serv);

UPDATE t_nutrition15up SET L_BMI=round(WEIGHT/((HEIGHT/100)*(HEIGHT/100)),2) ;
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.8308539;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:295;a:5:{i:0;s:29:"DROP PROCEDURE IF EXISTS t_tb";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.8308539;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:296;a:5:{i:0;s:29:"DROP PROCEDURE IF EXISTS t_tb";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.893255;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:298;a:5:{i:0;s:5636:"CREATE PROCEDURE t_tb()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '45';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d1:=concat(@b_year-1,'0701');
SET @end_d1:=concat(@b_year-1,'0930');
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF  EXISTS tmp_tb;
CREATE TABLE IF NOT EXISTS tmp_tb (
  HOSPCODE varchar(5) NOT NULL,
  PID varchar(15) NOT NULL,
  CID varchar(13) DEFAULT NULL,
  BIRTH date,
  SEX varchar(1),
  NATION varchar(3),
	date_dx date,
  DIAGCODE varchar(6),
  DIAGTYPE char(1) NOT NULL,
	PERIOD VARCHAR(1),
	source_tb VARCHAR(20) DEFAULT NULL,
	group_tb VARCHAR(1) DEFAULT NULL,
PRIMARY KEY (hospcode,pid,date_dx,diagcode),
KEY (hospcode),
KEY (pid),
KEY (cid),
KEY (date_dx),
KEY (diagcode),
KEY (source_tb)
)ENGINE=MyISAM  AS(
SELECT
 i.HOSPCODE,i.PID,p.CID,p.BIRTH,p.SEX,p.NATION,DATE_FORMAT(i.datetime_disch,'%Y%m%d') date_dx
 ,i.DIAGCODE,i.DIAGTYPE,'diag_ipd' as source_tb,NULL as PERIOD,NULL as group_tb
FROM
tmp_diag_ipd i 
 LEFT JOIN tmp_admission a ON a.HOSPCODE=i.HOSPCODE AND a.AN=i.AN
 LEFT JOIN person p ON  i.HOSPCODE=p.HOSPCODE AND i.PID=p.PID
WHERE
	substr(diagcode,1,3)  in('A15','A16','A17','A18','A19','U88','U89')
AND DATE_FORMAT(i.datetime_disch,'%Y%m%d')  BETWEEN @start_d1 AND @end_d
GROUP BY hospcode,pid,date_dx,diagcode
);

INSERT IGNORE INTO tmp_tb (
SELECT
 o.HOSPCODE,o.PID,p.CID,p.BIRTH,p.SEX,p.NATION,o.date_serv date_dx
 ,o.DIAGCODE,o.DIAGTYPE,'diag_opd' as source_tb,NULL as PERIOD,NULL as group_tb
FROM
tmp_diag_opd o 
 LEFT JOIN person p ON  o.HOSPCODE=p.HOSPCODE AND o.PID=p.PID
WHERE
	substr(diagcode,1,3)  in('A15','A16','A17','A18','A19','U88','U89')
AND o.DATE_SERV  BETWEEN @start_d1 AND @end_d
GROUP BY hospcode,pid,date_dx,diagcode
);

/*up period*/
UPDATE tmp_tb SET PERIOD='0'
WHERE date_dx BETWEEN @start_d1 AND  @end_d1;
UPDATE tmp_tb SET PERIOD='1'
WHERE date_dx BETWEEN  concat(@b_year-1,'1001') AND  concat(@b_year-1,'1231');
UPDATE tmp_tb SET PERIOD='2'
WHERE date_dx BETWEEN  concat(@b_year,'0101') AND  concat(@b_year,'0331');
UPDATE tmp_tb SET PERIOD='3'
WHERE date_dx BETWEEN  concat(@b_year,'0401') AND  concat(@b_year,'0630');
UPDATE tmp_tb SET PERIOD='4'
WHERE date_dx BETWEEN  concat(@b_year,'0701') AND  concat(@b_year,'0930');

/*upgroup*/
UPDATE tmp_tb SET group_tb='1'
WHERE diagcode in('A150','A151','A157');
UPDATE tmp_tb SET group_tb='2'
WHERE diagcode in('A160','A161','A152','A153','A162','A169');
UPDATE tmp_tb SET group_tb='3'
WHERE diagcode in('A154','A155','A156','A158','A159','A163','A164','A165','A167','A168') 
		OR substr(diagcode,1,3) in('A17','A18');

/*ทะเบียน TB สะสม*/
CREATE TABLE IF NOT EXISTS t_person_tb (
HOSPCODE  VARCHAR(5) DEFAULT NULL,
PID  VARCHAR(20) DEFAULT NULL,
CID  VARCHAR(13),
BIRTH DATE DEFAULT NULL,
SEX VARCHAR(1) DEFAULT NULL,
NATION VARCHAR(3) DEFAULT NULL,
DATE_DX DATE DEFAULT NULL,
DIAGCODE VARCHAR(7),
SOURCE_TB VARCHAR(20) DEFAULT NULL,
GROUP_tb  VARCHAR(1) DEFAULT NULL,
HOSP_DX  VARCHAR(5) DEFAULT NULL,
PRIMARY KEY (cid,diagcode),
KEY (hospcode),
KEY (pid),
KEY (cid),
KEY (date_dx),
KEY (diagcode),
KEY (GROUP_tb),
KEY (source_tb)
)ENGINE=MyISAM DEFAULT CHARSET=utf8;
REPLACE  INTO t_person_tb (
SELECT
 input_hosp,input_pid,cid,birth,sex,nation,date_dx 
,diagcode, source_tb,'0' as group_tb,hosp_dx
FROM
t_chronic
WHERE substr(diagcode,1,3)  in('A15','A16','A17','A18','A19','U88','U89') 
);
/*upgroup*/
UPDATE t_person_tb SET group_tb='1'
WHERE diagcode in('A150','A151','A157');
UPDATE t_person_tb SET group_tb='2'
WHERE diagcode in('A160','A161','A152','A153','A162','A169');
UPDATE t_person_tb SET group_tb='3'
WHERE diagcode in('A154','A155','A156','A158','A159','A163','A164','A165','A167','A168') 
		OR substr(diagcode,1,3) in('A17','A18');

/*ทะเบียนผู้ป่วยใหม่*/
DROP TABLE IF  EXISTS t_tb;
CREATE TABLE IF NOT EXISTS t_tb (
HOSPCODE  VARCHAR(5) DEFAULT NULL,
PID  VARCHAR(20) DEFAULT NULL,
CID  VARCHAR(13),
BIRTH DATE DEFAULT NULL,
SEX VARCHAR(1) DEFAULT NULL,
NATION VARCHAR(3) DEFAULT NULL,
DATE_DX DATE DEFAULT NULL,
DIAGCODE VARCHAR(7) DEFAULT NULL,
DIAGTYPE VARCHAR(1) DEFAULT NULL,
SOURCE_TB VARCHAR(20) DEFAULT NULL,
PERIOD VARCHAR(1),
GROUP_tb  VARCHAR(1) DEFAULT NULL,
PRIMARY KEY (cid,PERIOD),
KEY (hospcode),
KEY (pid),
KEY (cid),
KEY (date_dx),
KEY (diagcode),
KEY (GROUP_tb),
KEY (source_tb)
)ENGINE=MyISAM DEFAULT CHARSET=utf8;
/*จากผู้ป่วยเดิมที่มีอยู่เพื่อตัดรายเก่าออกมาเป็นกลับเป็นซ้ำ*/
INSERT IGNORE INTO t_tb (
SELECT
 hospcode,pid,cid,birth,sex,nation,date_dx 
,diagcode, null DIAGTYPE, source_tb,'0' as PERIOD ,group_tb
FROM
t_person_tb
WHERE  date_dx <  @end_d1
);
/*นำเข้า โดยให้ความสำคัญ diag_ipd ก่อน*/
INSERT IGNORE INTO t_tb (
SELECT
HOSPCODE,PID,CID,BIRTH,SEX,NATION,date_dx
 ,DIAGCODE,DIAGTYPE,source_tb,PERIOD,group_tb
FROM
tmp_tb
WHERE  date_dx BETWEEN  @start_d AND  @end_d AND source_tb='diag_ipd' AND group_tb in(1,2,3)
ORDER BY PERIOD,DATE_DX,CID
);

/*นำเข้า โดยให้ความสำคัญ diag_ipd ก่อน*/
INSERT IGNORE INTO t_tb (
SELECT
HOSPCODE,PID,CID,BIRTH,SEX,NATION,date_dx
 ,DIAGCODE,DIAGTYPE,source_tb,PERIOD,group_tb
FROM
tmp_tb
WHERE  date_dx BETWEEN  @start_d AND  @end_d AND source_tb='diag_opd' AND group_tb in(1,2,3)
ORDER BY PERIOD,DATE_DX,CID
);
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.893255;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:299;a:5:{i:0;s:5636:"CREATE PROCEDURE t_tb()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '45';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d1:=concat(@b_year-1,'0701');
SET @end_d1:=concat(@b_year-1,'0930');
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF  EXISTS tmp_tb;
CREATE TABLE IF NOT EXISTS tmp_tb (
  HOSPCODE varchar(5) NOT NULL,
  PID varchar(15) NOT NULL,
  CID varchar(13) DEFAULT NULL,
  BIRTH date,
  SEX varchar(1),
  NATION varchar(3),
	date_dx date,
  DIAGCODE varchar(6),
  DIAGTYPE char(1) NOT NULL,
	PERIOD VARCHAR(1),
	source_tb VARCHAR(20) DEFAULT NULL,
	group_tb VARCHAR(1) DEFAULT NULL,
PRIMARY KEY (hospcode,pid,date_dx,diagcode),
KEY (hospcode),
KEY (pid),
KEY (cid),
KEY (date_dx),
KEY (diagcode),
KEY (source_tb)
)ENGINE=MyISAM  AS(
SELECT
 i.HOSPCODE,i.PID,p.CID,p.BIRTH,p.SEX,p.NATION,DATE_FORMAT(i.datetime_disch,'%Y%m%d') date_dx
 ,i.DIAGCODE,i.DIAGTYPE,'diag_ipd' as source_tb,NULL as PERIOD,NULL as group_tb
FROM
tmp_diag_ipd i 
 LEFT JOIN tmp_admission a ON a.HOSPCODE=i.HOSPCODE AND a.AN=i.AN
 LEFT JOIN person p ON  i.HOSPCODE=p.HOSPCODE AND i.PID=p.PID
WHERE
	substr(diagcode,1,3)  in('A15','A16','A17','A18','A19','U88','U89')
AND DATE_FORMAT(i.datetime_disch,'%Y%m%d')  BETWEEN @start_d1 AND @end_d
GROUP BY hospcode,pid,date_dx,diagcode
);

INSERT IGNORE INTO tmp_tb (
SELECT
 o.HOSPCODE,o.PID,p.CID,p.BIRTH,p.SEX,p.NATION,o.date_serv date_dx
 ,o.DIAGCODE,o.DIAGTYPE,'diag_opd' as source_tb,NULL as PERIOD,NULL as group_tb
FROM
tmp_diag_opd o 
 LEFT JOIN person p ON  o.HOSPCODE=p.HOSPCODE AND o.PID=p.PID
WHERE
	substr(diagcode,1,3)  in('A15','A16','A17','A18','A19','U88','U89')
AND o.DATE_SERV  BETWEEN @start_d1 AND @end_d
GROUP BY hospcode,pid,date_dx,diagcode
);

/*up period*/
UPDATE tmp_tb SET PERIOD='0'
WHERE date_dx BETWEEN @start_d1 AND  @end_d1;
UPDATE tmp_tb SET PERIOD='1'
WHERE date_dx BETWEEN  concat(@b_year-1,'1001') AND  concat(@b_year-1,'1231');
UPDATE tmp_tb SET PERIOD='2'
WHERE date_dx BETWEEN  concat(@b_year,'0101') AND  concat(@b_year,'0331');
UPDATE tmp_tb SET PERIOD='3'
WHERE date_dx BETWEEN  concat(@b_year,'0401') AND  concat(@b_year,'0630');
UPDATE tmp_tb SET PERIOD='4'
WHERE date_dx BETWEEN  concat(@b_year,'0701') AND  concat(@b_year,'0930');

/*upgroup*/
UPDATE tmp_tb SET group_tb='1'
WHERE diagcode in('A150','A151','A157');
UPDATE tmp_tb SET group_tb='2'
WHERE diagcode in('A160','A161','A152','A153','A162','A169');
UPDATE tmp_tb SET group_tb='3'
WHERE diagcode in('A154','A155','A156','A158','A159','A163','A164','A165','A167','A168') 
		OR substr(diagcode,1,3) in('A17','A18');

/*ทะเบียน TB สะสม*/
CREATE TABLE IF NOT EXISTS t_person_tb (
HOSPCODE  VARCHAR(5) DEFAULT NULL,
PID  VARCHAR(20) DEFAULT NULL,
CID  VARCHAR(13),
BIRTH DATE DEFAULT NULL,
SEX VARCHAR(1) DEFAULT NULL,
NATION VARCHAR(3) DEFAULT NULL,
DATE_DX DATE DEFAULT NULL,
DIAGCODE VARCHAR(7),
SOURCE_TB VARCHAR(20) DEFAULT NULL,
GROUP_tb  VARCHAR(1) DEFAULT NULL,
HOSP_DX  VARCHAR(5) DEFAULT NULL,
PRIMARY KEY (cid,diagcode),
KEY (hospcode),
KEY (pid),
KEY (cid),
KEY (date_dx),
KEY (diagcode),
KEY (GROUP_tb),
KEY (source_tb)
)ENGINE=MyISAM DEFAULT CHARSET=utf8;
REPLACE  INTO t_person_tb (
SELECT
 input_hosp,input_pid,cid,birth,sex,nation,date_dx 
,diagcode, source_tb,'0' as group_tb,hosp_dx
FROM
t_chronic
WHERE substr(diagcode,1,3)  in('A15','A16','A17','A18','A19','U88','U89') 
);
/*upgroup*/
UPDATE t_person_tb SET group_tb='1'
WHERE diagcode in('A150','A151','A157');
UPDATE t_person_tb SET group_tb='2'
WHERE diagcode in('A160','A161','A152','A153','A162','A169');
UPDATE t_person_tb SET group_tb='3'
WHERE diagcode in('A154','A155','A156','A158','A159','A163','A164','A165','A167','A168') 
		OR substr(diagcode,1,3) in('A17','A18');

/*ทะเบียนผู้ป่วยใหม่*/
DROP TABLE IF  EXISTS t_tb;
CREATE TABLE IF NOT EXISTS t_tb (
HOSPCODE  VARCHAR(5) DEFAULT NULL,
PID  VARCHAR(20) DEFAULT NULL,
CID  VARCHAR(13),
BIRTH DATE DEFAULT NULL,
SEX VARCHAR(1) DEFAULT NULL,
NATION VARCHAR(3) DEFAULT NULL,
DATE_DX DATE DEFAULT NULL,
DIAGCODE VARCHAR(7) DEFAULT NULL,
DIAGTYPE VARCHAR(1) DEFAULT NULL,
SOURCE_TB VARCHAR(20) DEFAULT NULL,
PERIOD VARCHAR(1),
GROUP_tb  VARCHAR(1) DEFAULT NULL,
PRIMARY KEY (cid,PERIOD),
KEY (hospcode),
KEY (pid),
KEY (cid),
KEY (date_dx),
KEY (diagcode),
KEY (GROUP_tb),
KEY (source_tb)
)ENGINE=MyISAM DEFAULT CHARSET=utf8;
/*จากผู้ป่วยเดิมที่มีอยู่เพื่อตัดรายเก่าออกมาเป็นกลับเป็นซ้ำ*/
INSERT IGNORE INTO t_tb (
SELECT
 hospcode,pid,cid,birth,sex,nation,date_dx 
,diagcode, null DIAGTYPE, source_tb,'0' as PERIOD ,group_tb
FROM
t_person_tb
WHERE  date_dx <  @end_d1
);
/*นำเข้า โดยให้ความสำคัญ diag_ipd ก่อน*/
INSERT IGNORE INTO t_tb (
SELECT
HOSPCODE,PID,CID,BIRTH,SEX,NATION,date_dx
 ,DIAGCODE,DIAGTYPE,source_tb,PERIOD,group_tb
FROM
tmp_tb
WHERE  date_dx BETWEEN  @start_d AND  @end_d AND source_tb='diag_ipd' AND group_tb in(1,2,3)
ORDER BY PERIOD,DATE_DX,CID
);

/*นำเข้า โดยให้ความสำคัญ diag_ipd ก่อน*/
INSERT IGNORE INTO t_tb (
SELECT
HOSPCODE,PID,CID,BIRTH,SEX,NATION,date_dx
 ,DIAGCODE,DIAGTYPE,source_tb,PERIOD,group_tb
FROM
tmp_tb
WHERE  date_dx BETWEEN  @start_d AND  @end_d AND source_tb='diag_opd' AND group_tb in(1,2,3)
ORDER BY PERIOD,DATE_DX,CID
);
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.9556551;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:301;a:5:{i:0;s:36:"DROP PROCEDURE IF EXISTS t_refer_sp5";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988054.9556551;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:302;a:5:{i:0;s:36:"DROP PROCEDURE IF EXISTS t_refer_sp5";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.018055;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:304;a:5:{i:0;s:3868:"CREATE PROCEDURE t_refer_sp5()
 BEGIN 
SET @prov_c := '58';
SET @id := '46';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-2,'1001');
SET @end_d:=concat(@b_year,'0930');
DROP TABLE IF EXISTS t_refer_sp5;
CREATE TABLE IF NOT EXISTS t_refer_sp5 (
hospcode VARCHAR(5),
splevel VARCHAR(2) DEFAULT NULL,
pid VARCHAR(15),
cid VARCHAR(13) DEFAULT NULL,
seq VARCHAR(15) DEFAULT NULL,
an VARCHAR(15) DEFAULT NULL,
date_serv date,
sp_code VARCHAR(7) DEFAULT NULL,
source VARCHAR(15) DEFAULT NULL,
referin_hospcode VARCHAR(5) DEFAULT NULL,
referin_splevel VARCHAR(2) DEFAULT NULL,
typein VARCHAR(2) DEFAULT NULL,
clinic VARCHAR(3) DEFAULT NULL,
PRIMARY KEY (hospcode,pid,date_serv),
KEY (sp_code),
KEY (referin_hospcode),
KEY (typein)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;
/*สูติกรรม  */
INSERT IGNORE INTO  t_refer_sp5 
( 
hospcode,pid,an,date_serv,sp_code,source,clinic
)
(
SELECT HOSPCODE,PID,AN,DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d'),PROCEDCODE,'proced_ipd','1'
FROM procedure_ipd
WHERE DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d')  BETWEEN @start_d AND @end_d
	AND (SUBSTR(PROCEDCODE,1,3) BETWEEN '740' AND '744' 
	OR PROCEDCODE in('7491','7499'))
);
/*ศัลยกรรม*/
INSERT IGNORE INTO  t_refer_sp5 
( 
hospcode,pid,an,date_serv,sp_code,source,clinic
)
(
SELECT HOSPCODE,PID,AN,DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d'),PROCEDCODE,'proced_ipd','2'
FROM procedure_ipd
WHERE DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d')  BETWEEN @start_d AND @end_d
	AND PROCEDCODE BETWEEN '4701' AND '4719'
);

/*อายุรกรรม*/
INSERT IGNORE INTO  t_refer_sp5 
( 
hospcode,pid,an,date_serv,sp_code,source,clinic
)
(
SELECT HOSPCODE,PID,AN,DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d'),DIAGCODE,'diag_ipd','3'
FROM diagnosis_ipd
WHERE DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d')  BETWEEN @start_d AND @end_d
	AND (SUBSTR(DIAGCODE,1,3) BETWEEN 'A40' AND 'A41' 
	OR SUBSTR(DIAGCODE,1,3) in('R65'))
);

/*กุมารเวชกรรม*/
INSERT IGNORE INTO  t_refer_sp5 
( 
hospcode,pid,an,date_serv,sp_code,source,clinic
)
(
SELECT HOSPCODE,PID,AN,DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d'),PROCEDCODE,'proced_ipd','4'
FROM procedure_ipd
WHERE DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d')  BETWEEN @start_d AND @end_d
	AND PROCEDCODE in('9671','9672','939')
	);

/*ออโธปิดิกส์*/
INSERT IGNORE INTO  t_refer_sp5 
( 
hospcode,pid,an,date_serv,sp_code,source,clinic
)
(
SELECT HOSPCODE,PID,AN,DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d'),DIAGCODE,'diag_ipd','5'
FROM diagnosis_ipd
WHERE DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d')  BETWEEN @start_d AND @end_d
	AND DIAGCODE in('S42000','S42100','S42200','S42300','S42400','S42700','S42800','S42900'
	,'S52000','S52100','S52200','S52300','S52400','S52500','S52600','S52700','S52800','S52900'
	,'S62000','S62100','S62200','S62300','S62400','S6250','S6260','S6270','S6280','S9200','S9210'
	,'S9220','S9230','S9240','S9250','S9270','S9290')
);
/*update cid*/
UPDATE t_refer_sp5 s INNER JOIN person p ON s.hospcode=p.hospcode AND s.pid=p.pid 
SET s.cid=p.cid;
/*update refer*/
UPDATE t_refer_sp5 s INNER JOIN admission a ON a.hospcode=s.hospcode AND a.an=s.an
SET s.referin_hospcode=a.referinhosp , s.typein=a.TYPEIN;
/*update refer*/
UPDATE t_refer_sp5 s INNER JOIN service a ON a.hospcode=s.hospcode AND a.pid=s.pid AND a.DATE_SERV=s.date_serv
SET s.referin_hospcode=a.referinhosp, s.typein=a.TYPEIN,s.seq=a.seq ;

/*update level*/
UPDATE t_refer_sp5 s INNER JOIN (SELECT hcode,splevel FROM ccmihosp WHERE byear = (@b_year+543) GROUP BY hcode) a 
	ON a.hcode=s.hospcode SET s.splevel=a.splevel;

/*update level*/
UPDATE t_refer_sp5 s INNER JOIN (SELECT hcode,splevel FROM ccmihosp WHERE byear = (@b_year+543) GROUP BY hcode) a 
	ON a.hcode=s.referin_hospcode SET s.referin_splevel=a.splevel;

 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.018055;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:305;a:5:{i:0;s:3868:"CREATE PROCEDURE t_refer_sp5()
 BEGIN 
SET @prov_c := '58';
SET @id := '46';
SET @b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-2,'1001');
SET @end_d:=concat(@b_year,'0930');
DROP TABLE IF EXISTS t_refer_sp5;
CREATE TABLE IF NOT EXISTS t_refer_sp5 (
hospcode VARCHAR(5),
splevel VARCHAR(2) DEFAULT NULL,
pid VARCHAR(15),
cid VARCHAR(13) DEFAULT NULL,
seq VARCHAR(15) DEFAULT NULL,
an VARCHAR(15) DEFAULT NULL,
date_serv date,
sp_code VARCHAR(7) DEFAULT NULL,
source VARCHAR(15) DEFAULT NULL,
referin_hospcode VARCHAR(5) DEFAULT NULL,
referin_splevel VARCHAR(2) DEFAULT NULL,
typein VARCHAR(2) DEFAULT NULL,
clinic VARCHAR(3) DEFAULT NULL,
PRIMARY KEY (hospcode,pid,date_serv),
KEY (sp_code),
KEY (referin_hospcode),
KEY (typein)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;
/*สูติกรรม  */
INSERT IGNORE INTO  t_refer_sp5 
( 
hospcode,pid,an,date_serv,sp_code,source,clinic
)
(
SELECT HOSPCODE,PID,AN,DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d'),PROCEDCODE,'proced_ipd','1'
FROM procedure_ipd
WHERE DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d')  BETWEEN @start_d AND @end_d
	AND (SUBSTR(PROCEDCODE,1,3) BETWEEN '740' AND '744' 
	OR PROCEDCODE in('7491','7499'))
);
/*ศัลยกรรม*/
INSERT IGNORE INTO  t_refer_sp5 
( 
hospcode,pid,an,date_serv,sp_code,source,clinic
)
(
SELECT HOSPCODE,PID,AN,DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d'),PROCEDCODE,'proced_ipd','2'
FROM procedure_ipd
WHERE DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d')  BETWEEN @start_d AND @end_d
	AND PROCEDCODE BETWEEN '4701' AND '4719'
);

/*อายุรกรรม*/
INSERT IGNORE INTO  t_refer_sp5 
( 
hospcode,pid,an,date_serv,sp_code,source,clinic
)
(
SELECT HOSPCODE,PID,AN,DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d'),DIAGCODE,'diag_ipd','3'
FROM diagnosis_ipd
WHERE DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d')  BETWEEN @start_d AND @end_d
	AND (SUBSTR(DIAGCODE,1,3) BETWEEN 'A40' AND 'A41' 
	OR SUBSTR(DIAGCODE,1,3) in('R65'))
);

/*กุมารเวชกรรม*/
INSERT IGNORE INTO  t_refer_sp5 
( 
hospcode,pid,an,date_serv,sp_code,source,clinic
)
(
SELECT HOSPCODE,PID,AN,DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d'),PROCEDCODE,'proced_ipd','4'
FROM procedure_ipd
WHERE DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d')  BETWEEN @start_d AND @end_d
	AND PROCEDCODE in('9671','9672','939')
	);

/*ออโธปิดิกส์*/
INSERT IGNORE INTO  t_refer_sp5 
( 
hospcode,pid,an,date_serv,sp_code,source,clinic
)
(
SELECT HOSPCODE,PID,AN,DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d'),DIAGCODE,'diag_ipd','5'
FROM diagnosis_ipd
WHERE DATE_FORMAT(DATETIME_ADMIT,'%Y%m%d')  BETWEEN @start_d AND @end_d
	AND DIAGCODE in('S42000','S42100','S42200','S42300','S42400','S42700','S42800','S42900'
	,'S52000','S52100','S52200','S52300','S52400','S52500','S52600','S52700','S52800','S52900'
	,'S62000','S62100','S62200','S62300','S62400','S6250','S6260','S6270','S6280','S9200','S9210'
	,'S9220','S9230','S9240','S9250','S9270','S9290')
);
/*update cid*/
UPDATE t_refer_sp5 s INNER JOIN person p ON s.hospcode=p.hospcode AND s.pid=p.pid 
SET s.cid=p.cid;
/*update refer*/
UPDATE t_refer_sp5 s INNER JOIN admission a ON a.hospcode=s.hospcode AND a.an=s.an
SET s.referin_hospcode=a.referinhosp , s.typein=a.TYPEIN;
/*update refer*/
UPDATE t_refer_sp5 s INNER JOIN service a ON a.hospcode=s.hospcode AND a.pid=s.pid AND a.DATE_SERV=s.date_serv
SET s.referin_hospcode=a.referinhosp, s.typein=a.TYPEIN,s.seq=a.seq ;

/*update level*/
UPDATE t_refer_sp5 s INNER JOIN (SELECT hcode,splevel FROM ccmihosp WHERE byear = (@b_year+543) GROUP BY hcode) a 
	ON a.hcode=s.hospcode SET s.splevel=a.splevel;

/*update level*/
UPDATE t_refer_sp5 s INNER JOIN (SELECT hcode,splevel FROM ccmihosp WHERE byear = (@b_year+543) GROUP BY hcode) a 
	ON a.hcode=s.referin_hospcode SET s.referin_splevel=a.splevel;

 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.0804551;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:307;a:5:{i:0;s:35:"DROP PROCEDURE IF EXISTS t_accident";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.0804551;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:308;a:5:{i:0;s:35:"DROP PROCEDURE IF EXISTS t_accident";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.127255;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:310;a:5:{i:0;s:602:"CREATE PROCEDURE t_accident()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '47';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF  EXISTS tmp_accident;
CREATE TABLE IF NOT EXISTS tmp_accident (
KEY (cid),
KEY (hospcode,pid),
KEY (hospcode,pid,seq),
KEY (DATETIME_SERV)
)ENGINE=MyISAM  AS(
SELECT
a.*,p.CID,p.BIRTH,p.SEX,p.NATION
FROM
accident a 
LEFT JOIN person p ON a.HOSPCODE=p.HOSPCODE AND a.PID=p.PID
WHERE DATE_FORMAT(a.DATETIME_SERV,'%Y%m%d') BETWEEN @start_d AND @end_d
);
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.127255;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:311;a:5:{i:0;s:602:"CREATE PROCEDURE t_accident()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '47';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF  EXISTS tmp_accident;
CREATE TABLE IF NOT EXISTS tmp_accident (
KEY (cid),
KEY (hospcode,pid),
KEY (hospcode,pid,seq),
KEY (DATETIME_SERV)
)ENGINE=MyISAM  AS(
SELECT
a.*,p.CID,p.BIRTH,p.SEX,p.NATION
FROM
accident a 
LEFT JOIN person p ON a.HOSPCODE=p.HOSPCODE AND a.PID=p.PID
WHERE DATE_FORMAT(a.DATETIME_SERV,'%Y%m%d') BETWEEN @start_d AND @end_d
);
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.190655;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:313;a:5:{i:0;s:33:"DROP PROCEDURE IF EXISTS t_dental";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.190655;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:314;a:5:{i:0;s:33:"DROP PROCEDURE IF EXISTS t_dental";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.2374549;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:316;a:5:{i:0;s:2160:"CREATE PROCEDURE t_dental()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '48';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-2,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF  EXISTS tmp_dental;
CREATE TABLE IF NOT EXISTS tmp_dental 
(
PRIMARY KEY (HOSPCODE,PID,SEQ),
KEY (HOSPCODE ,PID),
KEY (HOSPCODE),
KEY (DATE_SERV),
KEY (DENTTYPE),
KEY (CLASS),
KEY (HOSPCODE,PROVIDER),
KEY (CID)
)ENGINE=MyISAM  AS(
SELECT
		d.*,p.cid
FROM
		dental d 
		LEFT JOIN person p ON d.HOSPCODE=p.HOSPCODE AND d.PID=p.PID
 WHERE
			DATE_FORMAT(d.date_serv,'%Y%m%d')  BETWEEN @start_d AND @end_d
GROUP BY HOSPCODE,PID,SEQ
);

DROP TABLE IF  EXISTS tmp_dental_last;
CREATE TABLE IF NOT EXISTS tmp_dental_last 
(
 HOSPCODE varchar(5) NOT NULL,
  PID varchar(15) NOT NULL,
  SEQ varchar(16) NOT NULL,
  DATE_SERV date NOT NULL,
  DENTTYPE varchar(1) NOT NULL,
  SERVPLACE varchar(1) NOT NULL,
  PTEETH int(2) DEFAULT NULL,
  PCARIES int(2) DEFAULT NULL,
  PFILLING int(2) DEFAULT NULL,
  PEXTRACT int(2) DEFAULT NULL,
  DTEETH int(2) DEFAULT NULL,
  DCARIES int(2) DEFAULT NULL,
  DFILLING int(2) DEFAULT NULL,
  DEXTRACT int(2) DEFAULT NULL,
  NEED_FLUORIDE char(1) DEFAULT NULL,
  NEED_SCALING char(1) DEFAULT NULL,
  NEED_SEALANT int(2) DEFAULT NULL,
  NEED_PFILLING int(2) DEFAULT NULL,
  NEED_DFILLING int(2) DEFAULT NULL,
  NEED_PEXTRACT int(2) DEFAULT NULL,
  NEED_DEXTRACT int(2) DEFAULT NULL,
  NPROSTHESIS char(1) DEFAULT NULL,
  PERMANENT_PERMANENT smallint(6) DEFAULT NULL,
  PERMANENT_PROSTHESIS smallint(6) DEFAULT NULL,
  PROSTHESIS_PROSTHESIS smallint(6) DEFAULT NULL,
  GUM varchar(6) DEFAULT NULL,
  SCHOOLTYPE char(1) DEFAULT NULL,
  CLASS char(1) DEFAULT NULL,
  PROVIDER varchar(15) DEFAULT NULL,
  D_UPDATE datetime NOT NULL,
CID varchar(13) DEFAULT NULL,
PRIMARY KEY (HOSPCODE,PID),
KEY (HOSPCODE ,PID),
KEY (HOSPCODE),
KEY (DATE_SERV),
KEY (DENTTYPE),
KEY (CLASS),
KEY (HOSPCODE,PROVIDER),
KEY (CID)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO tmp_dental_last (
	SELECT * FROM tmp_dental ORDER BY DATE_SERV DESC
);
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.2374549;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:317;a:5:{i:0;s:2160:"CREATE PROCEDURE t_dental()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '48';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-2,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF  EXISTS tmp_dental;
CREATE TABLE IF NOT EXISTS tmp_dental 
(
PRIMARY KEY (HOSPCODE,PID,SEQ),
KEY (HOSPCODE ,PID),
KEY (HOSPCODE),
KEY (DATE_SERV),
KEY (DENTTYPE),
KEY (CLASS),
KEY (HOSPCODE,PROVIDER),
KEY (CID)
)ENGINE=MyISAM  AS(
SELECT
		d.*,p.cid
FROM
		dental d 
		LEFT JOIN person p ON d.HOSPCODE=p.HOSPCODE AND d.PID=p.PID
 WHERE
			DATE_FORMAT(d.date_serv,'%Y%m%d')  BETWEEN @start_d AND @end_d
GROUP BY HOSPCODE,PID,SEQ
);

DROP TABLE IF  EXISTS tmp_dental_last;
CREATE TABLE IF NOT EXISTS tmp_dental_last 
(
 HOSPCODE varchar(5) NOT NULL,
  PID varchar(15) NOT NULL,
  SEQ varchar(16) NOT NULL,
  DATE_SERV date NOT NULL,
  DENTTYPE varchar(1) NOT NULL,
  SERVPLACE varchar(1) NOT NULL,
  PTEETH int(2) DEFAULT NULL,
  PCARIES int(2) DEFAULT NULL,
  PFILLING int(2) DEFAULT NULL,
  PEXTRACT int(2) DEFAULT NULL,
  DTEETH int(2) DEFAULT NULL,
  DCARIES int(2) DEFAULT NULL,
  DFILLING int(2) DEFAULT NULL,
  DEXTRACT int(2) DEFAULT NULL,
  NEED_FLUORIDE char(1) DEFAULT NULL,
  NEED_SCALING char(1) DEFAULT NULL,
  NEED_SEALANT int(2) DEFAULT NULL,
  NEED_PFILLING int(2) DEFAULT NULL,
  NEED_DFILLING int(2) DEFAULT NULL,
  NEED_PEXTRACT int(2) DEFAULT NULL,
  NEED_DEXTRACT int(2) DEFAULT NULL,
  NPROSTHESIS char(1) DEFAULT NULL,
  PERMANENT_PERMANENT smallint(6) DEFAULT NULL,
  PERMANENT_PROSTHESIS smallint(6) DEFAULT NULL,
  PROSTHESIS_PROSTHESIS smallint(6) DEFAULT NULL,
  GUM varchar(6) DEFAULT NULL,
  SCHOOLTYPE char(1) DEFAULT NULL,
  CLASS char(1) DEFAULT NULL,
  PROVIDER varchar(15) DEFAULT NULL,
  D_UPDATE datetime NOT NULL,
CID varchar(13) DEFAULT NULL,
PRIMARY KEY (HOSPCODE,PID),
KEY (HOSPCODE ,PID),
KEY (HOSPCODE),
KEY (DATE_SERV),
KEY (DENTTYPE),
KEY (CLASS),
KEY (HOSPCODE,PROVIDER),
KEY (CID)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO tmp_dental_last (
	SELECT * FROM tmp_dental ORDER BY DATE_SERV DESC
);
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.299855;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:319;a:5:{i:0;s:36:"DROP PROCEDURE IF EXISTS t_all_alien";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.299855;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:320;a:5:{i:0;s:36:"DROP PROCEDURE IF EXISTS t_all_alien";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.3466549;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:322;a:5:{i:0;s:1672:"CREATE PROCEDURE t_all_alien()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '49';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
DROP TABLE IF EXISTS t_all_labor;
CREATE TABLE IF NOT EXISTS t_all_labor(
  HOSPCODE varchar(5) NOT NULL,
  PID varchar(15) NOT NULL,
	SEQ_AN varchar(15) NOT NULL,
  cid varchar(13) DEFAULT NULL,
  sex varchar(1) NOT NULL DEFAULT '',
  DATE_SERV date NOT NULL,
  INSTYPE varchar(4) NOT NULL,
  PRICE decimal(11,2) NOT NULL,
  PAYPRICE decimal(11,2) NOT NULL,
  ACTUALPAY decimal(11,2) NOT NULL,
  fee decimal(12,2) NOT NULL DEFAULT '0.00',
  LABOR varchar(2) DEFAULT NULL,
  NATION varchar(3) NOT NULL DEFAULT '',
	NATIONCODEAEC varchar(3) NOT NULL DEFAULT '',
  labor_group int(1) NOT NULL DEFAULT '0',
  diagcode varchar(8) NOT NULL DEFAULT '',
  diagtype varchar(1) NOT NULL DEFAULT '',
	source VARCHAR(50) DEFAULT NULL,
  KEY  (HOSPCODE,PID,SEQ_AN,DATE_SERV)
) ENGINE = myisam DEFAULT CHARSET=utf8;

INSERT IGNORE INTO t_all_labor (
SELECT
HOSPCODE,pid,seq,cid,sex,date_serv,INSTYPE,PRICE,PAYPRICE,ACTUALPAY,fee,LABOR,NATION,nationcodeaec,labor_group,diagcode,diagtype,'service' as 'source'
FROM t_service_labor 
);
INSERT IGNORE INTO  t_all_labor (
SELECT
HOSPCODE,'' as 'pid',an,cid,sex,DATE_FORMAT(DATETIME_DISCH,'%Y%m%d'),INSTYPE,PRICE,PAYPRICE,ACTUALPAY,fee,LABOR,NATION,nationcodeaec,labor_group,diagcode,diagtype,'admission' as 'source'
FROM t_admission_labor  
);
UPDATE t_all_labor l INNER JOIN tmp_admission a ON l.hospcode=a.hospcode AND l.seq_an=a.an 
SET l.pid=a.pid
WHERE l.source='admission';

 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.3466549;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:323;a:5:{i:0;s:1672:"CREATE PROCEDURE t_all_alien()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '49';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
DROP TABLE IF EXISTS t_all_labor;
CREATE TABLE IF NOT EXISTS t_all_labor(
  HOSPCODE varchar(5) NOT NULL,
  PID varchar(15) NOT NULL,
	SEQ_AN varchar(15) NOT NULL,
  cid varchar(13) DEFAULT NULL,
  sex varchar(1) NOT NULL DEFAULT '',
  DATE_SERV date NOT NULL,
  INSTYPE varchar(4) NOT NULL,
  PRICE decimal(11,2) NOT NULL,
  PAYPRICE decimal(11,2) NOT NULL,
  ACTUALPAY decimal(11,2) NOT NULL,
  fee decimal(12,2) NOT NULL DEFAULT '0.00',
  LABOR varchar(2) DEFAULT NULL,
  NATION varchar(3) NOT NULL DEFAULT '',
	NATIONCODEAEC varchar(3) NOT NULL DEFAULT '',
  labor_group int(1) NOT NULL DEFAULT '0',
  diagcode varchar(8) NOT NULL DEFAULT '',
  diagtype varchar(1) NOT NULL DEFAULT '',
	source VARCHAR(50) DEFAULT NULL,
  KEY  (HOSPCODE,PID,SEQ_AN,DATE_SERV)
) ENGINE = myisam DEFAULT CHARSET=utf8;

INSERT IGNORE INTO t_all_labor (
SELECT
HOSPCODE,pid,seq,cid,sex,date_serv,INSTYPE,PRICE,PAYPRICE,ACTUALPAY,fee,LABOR,NATION,nationcodeaec,labor_group,diagcode,diagtype,'service' as 'source'
FROM t_service_labor 
);
INSERT IGNORE INTO  t_all_labor (
SELECT
HOSPCODE,'' as 'pid',an,cid,sex,DATE_FORMAT(DATETIME_DISCH,'%Y%m%d'),INSTYPE,PRICE,PAYPRICE,ACTUALPAY,fee,LABOR,NATION,nationcodeaec,labor_group,diagcode,diagtype,'admission' as 'source'
FROM t_admission_labor  
);
UPDATE t_all_labor l INNER JOIN tmp_admission a ON l.hospcode=a.hospcode AND l.seq_an=a.an 
SET l.pid=a.pid
WHERE l.source='admission';

 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.393455;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:325;a:5:{i:0;s:36:"DROP PROCEDURE IF EXISTS t_alcoholic";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.393455;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:326;a:5:{i:0;s:36:"DROP PROCEDURE IF EXISTS t_alcoholic";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.4402561;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:328;a:5:{i:0;s:710:"CREATE PROCEDURE t_alcoholic()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '50';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS t_alcoholic;
CREATE TABLE IF NOT EXISTS t_alcoholic (province varchar(2),PRIMARY KEY (province,hospcode,cid,date_serv,diagcode) ,KEY (cid)) ENGINE=myisam as (
SELECT
@prov_c province,HOSPCODE,pid,cid,DATE_SERV,DIAGCODE
FROM
tmp_diag_opd
WHERE substr(DIAGCODE,1,3) in('F10') OR DIAGCODE in('F171','F172') OR DIAGCODE in('Z508')
AND DATE_SERV BETWEEN @start_d AND  @end_d
GROUP BY province,hospcode,cid,date_serv,diagcode
ORDER BY HOSPCODE,CID,DIAGCODE
);
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.4402561;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:329;a:5:{i:0;s:710:"CREATE PROCEDURE t_alcoholic()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '50';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS t_alcoholic;
CREATE TABLE IF NOT EXISTS t_alcoholic (province varchar(2),PRIMARY KEY (province,hospcode,cid,date_serv,diagcode) ,KEY (cid)) ENGINE=myisam as (
SELECT
@prov_c province,HOSPCODE,pid,cid,DATE_SERV,DIAGCODE
FROM
tmp_diag_opd
WHERE substr(DIAGCODE,1,3) in('F10') OR DIAGCODE in('F171','F172') OR DIAGCODE in('Z508')
AND DATE_SERV BETWEEN @start_d AND  @end_d
GROUP BY province,hospcode,cid,date_serv,diagcode
ORDER BY HOSPCODE,CID,DIAGCODE
);
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.487056;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:331;a:5:{i:0;s:33:"DROP PROCEDURE IF EXISTS t_envocc";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.487056;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:332;a:5:{i:0;s:33:"DROP PROCEDURE IF EXISTS t_envocc";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.5338559;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:334;a:5:{i:0;s:6444:"CREATE PROCEDURE t_envocc()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '51';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

/*external cause*/
DROP TABLE  IF EXISTS t_envocc_ext;
CREATE TABLE  IF NOT EXISTS t_envocc_ext(
PRIMARY KEY (hospcode,pid,seq_an,date_serv,DIAGCODE)
,KEY(cid)
,KEY (hospcode,pid)
,KEY (hospcode,pid,seq_an)
,KEY (date_serv)
,KEY (DIAGCODE)
) ENGINE = MyISAM as (
SELECT
HOSPCODE,PID,CID,SEQ as seq_an,DATE_SERV,DIAGCODE,DIAGTYPE,'diag_opd' as 'source'
FROM
tmp_diag_opd
WHERE DIAGCODE IN('Y96') 
   OR (SUBSTR(DIAGCODE,1,1) IN('V','W','X')  AND SUBSTR(DIAGCODE,5,1) in('2')) AND DATE_SERV BETWEEN @start_d AND @end_d
);
INSERT IGNORE INTO t_envocc_ext(
SELECT
HOSPCODE,PID,CID,AN as seq_an,DATE_FORMAT(datetime_disch,'%Y%m%d') as DATE_SERV
,DIAGCODE,DIAGTYPE,'diag_ipd' as 'source'
FROM
tmp_diag_ipd
WHERE DIAGCODE IN('Y96') 
   OR (SUBSTR(DIAGCODE,1,1) IN('V','W','X')  AND SUBSTR(DIAGCODE,5,1) in('2'))  AND DATE_FORMAT(datetime_disch,'%Y%m%d') BETWEEN @start_d AND @end_d
);
/*envocc_diag*/
DROP TABLE  IF EXISTS t_envocc;
CREATE TABLE  IF NOT EXISTS t_envocc(
PRIMARY KEY (hospcode,pid,seq_an,date_serv,DIAGCODE)
,KEY(cid)
,KEY (hospcode,pid)
,KEY (hospcode,pid,seq_an)
,KEY (date_serv)
,KEY (DIAGCODE)
) ENGINE = MyISAM as (
SELECT
HOSPCODE,PID,CID,SEQ as seq_an,DATE_SERV,DIAGCODE,DIAGTYPE,'diag_opd' as 'source'
FROM
tmp_diag_opd
WHERE  DATE_SERV BETWEEN @start_d AND @end_d 
AND (DIAGCODE  IN('J628','J61','J920','H833','H903','H904' ,'H905')
OR SUBSTR(DIAGCODE,1,3) IN('I20','I28')
OR SUBSTR(DIAGCODE,1,3) IN('C45','T52','T67')
OR SUBSTR(DIAGCODE,1,3)  BETWEEN  'J00' AND 'J39' 
OR SUBSTR(DIAGCODE,1,3)  BETWEEN  'J40' AND 'J47' 
OR SUBSTR(DIAGCODE,1,3)  BETWEEN  'J60' AND 'J99' )
);


INSERT IGNORE INTO  t_envocc (
SELECT
HOSPCODE,PID,CID,SEQ as seq_an,DATE_SERV,DIAGCODE,DIAGTYPE,'diag_opd' as 'source'
FROM
tmp_diag_opd
WHERE DATE_SERV BETWEEN @start_d AND  @end_d 
AND  DIAGCODE  IN('T600','T601','T602','T603','T604','T608','T609','T560')
AND CONCAT(HOSPCODE,'-',PID,'-',SEQ)  not in(
					SELECT
					CONCAT(HOSPCODE,'-',PID,'-',SEQ_an) 
					FROM t_envocc_ext 
					WHERE DIAGCODE in('X68') AND source in('diag_opd')
					)
);

INSERT IGNORE INTO  t_envocc (
SELECT
HOSPCODE,PID,CID,SEQ as seq_an,DATE_SERV,DIAGCODE,DIAGTYPE,'diag_opd' as 'source'
FROM
tmp_diag_opd
WHERE DATE_SERV BETWEEN @start_d AND  @end_d 
AND SUBSTR(DIAGCODE,1,3)  BETWEEN 'M00' AND 'M99'  
AND CONCAT(HOSPCODE,'-',PID,'-',SEQ)  in(
					SELECT
					CONCAT(HOSPCODE,'-',PID,'-',SEQ_an) 
					FROM t_envocc_ext 
					WHERE DIAGCODE in('Y96') AND source in('diag_opd')
					)
);
INSERT IGNORE INTO  t_envocc (
SELECT
HOSPCODE,PID,CID,SEQ as seq_an,DATE_SERV,DIAGCODE,DIAGTYPE,'diag_opd' as 'source'
FROM
tmp_diag_opd
WHERE DATE_SERV BETWEEN @start_d AND  @end_d 
AND SUBSTR(DIAGCODE,1,3)  IN('G56')
AND CONCAT(HOSPCODE,'-',PID,'-',SEQ)  in(
					SELECT
					CONCAT(HOSPCODE,'-',PID,'-',SEQ_an) 
					FROM t_envocc_ext 
					WHERE DIAGCODE in('Y96') AND source in('diag_opd')
					)
);


INSERT IGNORE INTO  t_envocc (
SELECT
HOSPCODE,PID,CID,SEQ as seq_an,DATE_SERV,DIAGCODE,DIAGTYPE,'diag_opd' as 'source'
FROM
tmp_diag_opd
WHERE DATE_SERV BETWEEN @start_d AND @end_d 
AND (SUBSTR(DIAGCODE,1,1)  IN('S') OR  SUBSTR(DIAGCODE,1,2)  IN('T0','T1','T2') )
AND CONCAT(HOSPCODE,'-',PID,'-',SEQ)  in(
					SELECT
					CONCAT(HOSPCODE,'-',PID,'-',SEQ_an) 
					FROM t_envocc_ext 
					WHERE (SUBSTR(DIAGCODE,1,1) IN('V','W','X')  AND SUBSTR(DIAGCODE,5,1) in('2'))
						AND source in('diag_opd')
					)
);

/*insert from diag_ipd*/
INSERT IGNORE INTO  t_envocc (
SELECT
HOSPCODE,PID,CID,AN as seq_an,DATE_FORMAT(datetime_disch,'%Y%m%d') as DATE_SERV
,DIAGCODE,DIAGTYPE,'diag_ipd' as 'source'
FROM
tmp_diag_ipd
WHERE DATE_FORMAT(datetime_disch,'%Y%m%d') BETWEEN @start_d AND @end_d 
AND (DIAGCODE  IN('J628','J61','J920','H833','H903','H904' ,'H905')
OR SUBSTR(DIAGCODE,1,3) IN('I20','I28')
OR SUBSTR(DIAGCODE,1,3) IN('C45','T52','T67')
OR SUBSTR(DIAGCODE,1,3)  BETWEEN  'J00' AND 'J39' 
OR SUBSTR(DIAGCODE,1,3)  BETWEEN  'J40' AND 'J47' 
OR SUBSTR(DIAGCODE,1,3)  BETWEEN  'J60' AND 'J99' )
);

INSERT IGNORE INTO  t_envocc (
SELECT
HOSPCODE,PID,CID,AN as seq_an,DATE_FORMAT(datetime_disch,'%Y%m%d') as DATE_SERV
,DIAGCODE,DIAGTYPE,'diag_ipd' as 'source'
FROM
tmp_diag_ipd
WHERE DATE_FORMAT(datetime_disch,'%Y%m%d') BETWEEN @start_d AND @end_d 
AND DIAGCODE  IN('T600','T601','T602','T603','T604','T608','T609','T560')
AND CONCAT(HOSPCODE,'-',PID,'-',AN)  not in(
					SELECT
					CONCAT(HOSPCODE,'-',PID,'-',SEQ_an) 
					FROM t_envocc_ext 
					WHERE DIAGCODE in('X68') AND source in('diag_ipd')
					)
);

INSERT IGNORE INTO  t_envocc (
SELECT
HOSPCODE,PID,CID,AN as seq_an,DATE_FORMAT(datetime_disch,'%Y%m%d') as DATE_SERV
,DIAGCODE,DIAGTYPE,'diag_ipd' as 'source'
FROM
tmp_diag_ipd
WHERE DATE_FORMAT(datetime_disch,'%Y%m%d') BETWEEN @start_d AND @end_d 
AND SUBSTR(DIAGCODE,1,3)  BETWEEN 'M00' AND 'M99'  
AND CONCAT(HOSPCODE,'-',PID,'-',AN)  in(
					SELECT
					CONCAT(HOSPCODE,'-',PID,'-',SEQ_an) 
					FROM t_envocc_ext 
					WHERE DIAGCODE in('Y96') AND source in('diag_ipd')
					)
);

INSERT IGNORE INTO  t_envocc (
SELECT
HOSPCODE,PID,CID,AN as seq_an,DATE_FORMAT(datetime_disch,'%Y%m%d') as DATE_SERV
,DIAGCODE,DIAGTYPE,'diag_ipd' as 'source'
FROM
tmp_diag_ipd
WHERE DATE_FORMAT(datetime_disch,'%Y%m%d') BETWEEN @start_d AND @end_d 
AND SUBSTR(DIAGCODE,1,3)  IN('G56')  
AND CONCAT(HOSPCODE,'-',PID,'-',AN)  in(
					SELECT
					CONCAT(HOSPCODE,'-',PID,'-',SEQ_an) 
					FROM t_envocc_ext 
					WHERE DIAGCODE in('Y96') AND source in('diag_ipd')
					)
);

INSERT IGNORE INTO  t_envocc (
SELECT
HOSPCODE,PID,CID,AN as seq_an,DATE_FORMAT(datetime_disch,'%Y%m%d') as DATE_SERV
,DIAGCODE,DIAGTYPE,'diag_ipd' as 'source'
FROM
tmp_diag_ipd
WHERE DATE_FORMAT(datetime_disch,'%Y%m%d') BETWEEN @start_d AND @end_d 
AND (SUBSTR(DIAGCODE,1,2)  IN('T0','T1','T2')  OR SUBSTR(DIAGCODE,1,1)  IN('S')   )
AND CONCAT(HOSPCODE,'-',PID,'-',AN)  in(
					SELECT
					CONCAT(HOSPCODE,'-',PID,'-',SEQ_an) 
					FROM t_envocc_ext 
					WHERE (SUBSTR(DIAGCODE,1,1) IN('V','W','X')  AND SUBSTR(DIAGCODE,5,1) in('2'))
						AND source in('diag_ipd')
					)
);

 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.5494559;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:335;a:5:{i:0;s:6444:"CREATE PROCEDURE t_envocc()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '51';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

/*external cause*/
DROP TABLE  IF EXISTS t_envocc_ext;
CREATE TABLE  IF NOT EXISTS t_envocc_ext(
PRIMARY KEY (hospcode,pid,seq_an,date_serv,DIAGCODE)
,KEY(cid)
,KEY (hospcode,pid)
,KEY (hospcode,pid,seq_an)
,KEY (date_serv)
,KEY (DIAGCODE)
) ENGINE = MyISAM as (
SELECT
HOSPCODE,PID,CID,SEQ as seq_an,DATE_SERV,DIAGCODE,DIAGTYPE,'diag_opd' as 'source'
FROM
tmp_diag_opd
WHERE DIAGCODE IN('Y96') 
   OR (SUBSTR(DIAGCODE,1,1) IN('V','W','X')  AND SUBSTR(DIAGCODE,5,1) in('2')) AND DATE_SERV BETWEEN @start_d AND @end_d
);
INSERT IGNORE INTO t_envocc_ext(
SELECT
HOSPCODE,PID,CID,AN as seq_an,DATE_FORMAT(datetime_disch,'%Y%m%d') as DATE_SERV
,DIAGCODE,DIAGTYPE,'diag_ipd' as 'source'
FROM
tmp_diag_ipd
WHERE DIAGCODE IN('Y96') 
   OR (SUBSTR(DIAGCODE,1,1) IN('V','W','X')  AND SUBSTR(DIAGCODE,5,1) in('2'))  AND DATE_FORMAT(datetime_disch,'%Y%m%d') BETWEEN @start_d AND @end_d
);
/*envocc_diag*/
DROP TABLE  IF EXISTS t_envocc;
CREATE TABLE  IF NOT EXISTS t_envocc(
PRIMARY KEY (hospcode,pid,seq_an,date_serv,DIAGCODE)
,KEY(cid)
,KEY (hospcode,pid)
,KEY (hospcode,pid,seq_an)
,KEY (date_serv)
,KEY (DIAGCODE)
) ENGINE = MyISAM as (
SELECT
HOSPCODE,PID,CID,SEQ as seq_an,DATE_SERV,DIAGCODE,DIAGTYPE,'diag_opd' as 'source'
FROM
tmp_diag_opd
WHERE  DATE_SERV BETWEEN @start_d AND @end_d 
AND (DIAGCODE  IN('J628','J61','J920','H833','H903','H904' ,'H905')
OR SUBSTR(DIAGCODE,1,3) IN('I20','I28')
OR SUBSTR(DIAGCODE,1,3) IN('C45','T52','T67')
OR SUBSTR(DIAGCODE,1,3)  BETWEEN  'J00' AND 'J39' 
OR SUBSTR(DIAGCODE,1,3)  BETWEEN  'J40' AND 'J47' 
OR SUBSTR(DIAGCODE,1,3)  BETWEEN  'J60' AND 'J99' )
);


INSERT IGNORE INTO  t_envocc (
SELECT
HOSPCODE,PID,CID,SEQ as seq_an,DATE_SERV,DIAGCODE,DIAGTYPE,'diag_opd' as 'source'
FROM
tmp_diag_opd
WHERE DATE_SERV BETWEEN @start_d AND  @end_d 
AND  DIAGCODE  IN('T600','T601','T602','T603','T604','T608','T609','T560')
AND CONCAT(HOSPCODE,'-',PID,'-',SEQ)  not in(
					SELECT
					CONCAT(HOSPCODE,'-',PID,'-',SEQ_an) 
					FROM t_envocc_ext 
					WHERE DIAGCODE in('X68') AND source in('diag_opd')
					)
);

INSERT IGNORE INTO  t_envocc (
SELECT
HOSPCODE,PID,CID,SEQ as seq_an,DATE_SERV,DIAGCODE,DIAGTYPE,'diag_opd' as 'source'
FROM
tmp_diag_opd
WHERE DATE_SERV BETWEEN @start_d AND  @end_d 
AND SUBSTR(DIAGCODE,1,3)  BETWEEN 'M00' AND 'M99'  
AND CONCAT(HOSPCODE,'-',PID,'-',SEQ)  in(
					SELECT
					CONCAT(HOSPCODE,'-',PID,'-',SEQ_an) 
					FROM t_envocc_ext 
					WHERE DIAGCODE in('Y96') AND source in('diag_opd')
					)
);
INSERT IGNORE INTO  t_envocc (
SELECT
HOSPCODE,PID,CID,SEQ as seq_an,DATE_SERV,DIAGCODE,DIAGTYPE,'diag_opd' as 'source'
FROM
tmp_diag_opd
WHERE DATE_SERV BETWEEN @start_d AND  @end_d 
AND SUBSTR(DIAGCODE,1,3)  IN('G56')
AND CONCAT(HOSPCODE,'-',PID,'-',SEQ)  in(
					SELECT
					CONCAT(HOSPCODE,'-',PID,'-',SEQ_an) 
					FROM t_envocc_ext 
					WHERE DIAGCODE in('Y96') AND source in('diag_opd')
					)
);


INSERT IGNORE INTO  t_envocc (
SELECT
HOSPCODE,PID,CID,SEQ as seq_an,DATE_SERV,DIAGCODE,DIAGTYPE,'diag_opd' as 'source'
FROM
tmp_diag_opd
WHERE DATE_SERV BETWEEN @start_d AND @end_d 
AND (SUBSTR(DIAGCODE,1,1)  IN('S') OR  SUBSTR(DIAGCODE,1,2)  IN('T0','T1','T2') )
AND CONCAT(HOSPCODE,'-',PID,'-',SEQ)  in(
					SELECT
					CONCAT(HOSPCODE,'-',PID,'-',SEQ_an) 
					FROM t_envocc_ext 
					WHERE (SUBSTR(DIAGCODE,1,1) IN('V','W','X')  AND SUBSTR(DIAGCODE,5,1) in('2'))
						AND source in('diag_opd')
					)
);

/*insert from diag_ipd*/
INSERT IGNORE INTO  t_envocc (
SELECT
HOSPCODE,PID,CID,AN as seq_an,DATE_FORMAT(datetime_disch,'%Y%m%d') as DATE_SERV
,DIAGCODE,DIAGTYPE,'diag_ipd' as 'source'
FROM
tmp_diag_ipd
WHERE DATE_FORMAT(datetime_disch,'%Y%m%d') BETWEEN @start_d AND @end_d 
AND (DIAGCODE  IN('J628','J61','J920','H833','H903','H904' ,'H905')
OR SUBSTR(DIAGCODE,1,3) IN('I20','I28')
OR SUBSTR(DIAGCODE,1,3) IN('C45','T52','T67')
OR SUBSTR(DIAGCODE,1,3)  BETWEEN  'J00' AND 'J39' 
OR SUBSTR(DIAGCODE,1,3)  BETWEEN  'J40' AND 'J47' 
OR SUBSTR(DIAGCODE,1,3)  BETWEEN  'J60' AND 'J99' )
);

INSERT IGNORE INTO  t_envocc (
SELECT
HOSPCODE,PID,CID,AN as seq_an,DATE_FORMAT(datetime_disch,'%Y%m%d') as DATE_SERV
,DIAGCODE,DIAGTYPE,'diag_ipd' as 'source'
FROM
tmp_diag_ipd
WHERE DATE_FORMAT(datetime_disch,'%Y%m%d') BETWEEN @start_d AND @end_d 
AND DIAGCODE  IN('T600','T601','T602','T603','T604','T608','T609','T560')
AND CONCAT(HOSPCODE,'-',PID,'-',AN)  not in(
					SELECT
					CONCAT(HOSPCODE,'-',PID,'-',SEQ_an) 
					FROM t_envocc_ext 
					WHERE DIAGCODE in('X68') AND source in('diag_ipd')
					)
);

INSERT IGNORE INTO  t_envocc (
SELECT
HOSPCODE,PID,CID,AN as seq_an,DATE_FORMAT(datetime_disch,'%Y%m%d') as DATE_SERV
,DIAGCODE,DIAGTYPE,'diag_ipd' as 'source'
FROM
tmp_diag_ipd
WHERE DATE_FORMAT(datetime_disch,'%Y%m%d') BETWEEN @start_d AND @end_d 
AND SUBSTR(DIAGCODE,1,3)  BETWEEN 'M00' AND 'M99'  
AND CONCAT(HOSPCODE,'-',PID,'-',AN)  in(
					SELECT
					CONCAT(HOSPCODE,'-',PID,'-',SEQ_an) 
					FROM t_envocc_ext 
					WHERE DIAGCODE in('Y96') AND source in('diag_ipd')
					)
);

INSERT IGNORE INTO  t_envocc (
SELECT
HOSPCODE,PID,CID,AN as seq_an,DATE_FORMAT(datetime_disch,'%Y%m%d') as DATE_SERV
,DIAGCODE,DIAGTYPE,'diag_ipd' as 'source'
FROM
tmp_diag_ipd
WHERE DATE_FORMAT(datetime_disch,'%Y%m%d') BETWEEN @start_d AND @end_d 
AND SUBSTR(DIAGCODE,1,3)  IN('G56')  
AND CONCAT(HOSPCODE,'-',PID,'-',AN)  in(
					SELECT
					CONCAT(HOSPCODE,'-',PID,'-',SEQ_an) 
					FROM t_envocc_ext 
					WHERE DIAGCODE in('Y96') AND source in('diag_ipd')
					)
);

INSERT IGNORE INTO  t_envocc (
SELECT
HOSPCODE,PID,CID,AN as seq_an,DATE_FORMAT(datetime_disch,'%Y%m%d') as DATE_SERV
,DIAGCODE,DIAGTYPE,'diag_ipd' as 'source'
FROM
tmp_diag_ipd
WHERE DATE_FORMAT(datetime_disch,'%Y%m%d') BETWEEN @start_d AND @end_d 
AND (SUBSTR(DIAGCODE,1,2)  IN('T0','T1','T2')  OR SUBSTR(DIAGCODE,1,1)  IN('S')   )
AND CONCAT(HOSPCODE,'-',PID,'-',AN)  in(
					SELECT
					CONCAT(HOSPCODE,'-',PID,'-',SEQ_an) 
					FROM t_envocc_ext 
					WHERE (SUBSTR(DIAGCODE,1,1) IN('V','W','X')  AND SUBSTR(DIAGCODE,5,1) in('2'))
						AND source in('diag_ipd')
					)
);

 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.596256;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:337;a:5:{i:0;s:36:"DROP PROCEDURE IF EXISTS t_refer_4pa";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.596256;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:338;a:5:{i:0;s:36:"DROP PROCEDURE IF EXISTS t_refer_4pa";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.6586559;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:340;a:5:{i:0;s:4403:"CREATE PROCEDURE t_refer_4pa()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '52';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
SET @my_zone:=(SELECT zonecode FROM sys_config LIMIT 1);

DROP TABLE IF EXISTS tmz_person;
CREATE TEMPORARY TABLE IF NOT EXISTS tmz_person (PRIMARY KEY (hospcode,pid,birth),KEY (birth)  ) ENGINE=myisam as
(
SELECT * FROM person WHERE BIRTH BETWEEN concat(@b_year-1,'0701') AND @end_d
);
/*opdcase typeout=3*/
DROP TABLE IF  EXISTS t_refer_4pa;
CREATE TABLE IF NOT EXISTS t_refer_4pa (PRIMARY KEY(hospcode,pid,seq_an,diagcode) ,KEY (causeout),KEY (typeout) ) ENGINE=myisam as
(SELECT
s.HOSPCODE,s.pid,s.seq seq_an,s.date_serv,s.typeout,s.causeout,referouthosp,d.DIAGCODE,d.DIAGTYPE, 'opdcase' source
FROM tmp_service s 
	INNER JOIN tmp_diag_opd d ON s.HOSPCODE=d.HOSPCODE AND s.pid=d.PID AND s.seq=d.SEQ
	INNER JOIN (
		SELECT hcode FROM ccmihosp 
		WHERE byear in(@b_year+543)  AND chwcode in(@prov_c) 	AND hcode NOT IN (SELECT HOSPCODE FROM chospital_boat)
		GROUP BY hcode 
	) c ON s.HOSPCODE=c.hcode
	INNER JOIN (
		SELECT hcode FROM ccmihosp WHERE byear in(@b_year+543)  AND region NOT in(@my_zone) GROUP BY hcode 
	) z ON s.referouthosp=z.hcode
WHERE s.date_serv BETWEEN @start_d AND @end_d AND LENGTH(TRIM(s.referouthosp)) = 5 
		AND ( SUBSTR(DIAGCODE,1,1) in('C')
			OR SUBSTR(DIAGCODE,1,2) in('D0')
			OR SUBSTR(DIAGCODE,1,3) BETWEEN 'I20' AND 'I25'
			OR SUBSTR(DIAGCODE,1,3) BETWEEN 'V01' AND 'Y98'
		)
);

INSERT IGNORE INTO t_refer_4pa (
SELECT
s.HOSPCODE,s.pid,s.seq,s.date_serv,s.typeout,s.causeout,referouthosp,d.DIAGCODE,d.DIAGTYPE, 'opdcase' source
FROM tmp_service s 
	INNER JOIN tmp_diag_opd d ON s.HOSPCODE=d.HOSPCODE AND s.pid=d.PID AND s.seq=d.SEQ
	INNER JOIN (
		SELECT hcode FROM ccmihosp 
		WHERE byear in(@b_year+543)  AND chwcode in(@prov_c) 	AND hcode NOT IN (SELECT HOSPCODE FROM chospital_boat)
		GROUP BY hcode 
	) c ON s.HOSPCODE=c.hcode
	INNER JOIN (
		SELECT hcode FROM ccmihosp WHERE byear in(@b_year+543)  AND region NOT in(@my_zone) GROUP BY hcode 
	) z ON s.referouthosp=z.hcode
  INNER JOIN tmz_person p ON s.hospcode=p.HOSPCODE AND s.pid=p.PID
WHERE s.date_serv BETWEEN @start_d AND @end_d AND LENGTH(TRIM(s.referouthosp)) = 5 
	AND TIMESTAMPDIFF(day,p.BIRTH,s.date_serv) <= 28
	);

/*ipdcase DISCHTYPE=4*/
INSERT IGNORE INTO t_refer_4pa (
SELECT
s.HOSPCODE,s.pid,s.AN,DATE_FORMAT(s.DATETIME_DISCH,'%Y%m%d'),s.DISCHTYPE,s.causeout,referouthosp,d.DIAGCODE,d.DIAGTYPE, 'ipdcase' source
FROM tmp_admission s 
	INNER JOIN tmp_diag_ipd d ON s.HOSPCODE=d.HOSPCODE AND s.AN=d.AN
	INNER JOIN (
		SELECT hcode FROM ccmihosp 
		WHERE byear in(@b_year+543)  AND chwcode in(@prov_c) 	AND hcode NOT IN (SELECT HOSPCODE FROM chospital_boat)
		GROUP BY hcode 
	) c ON s.HOSPCODE=c.hcode
	INNER JOIN (
		SELECT hcode FROM ccmihosp WHERE byear in(@b_year+543)  AND region NOT in(@my_zone) GROUP BY hcode 
	) z ON s.referouthosp=z.hcode
WHERE DATE_FORMAT(s.DATETIME_DISCH,'%Y%m%d') BETWEEN @start_d AND @end_d AND LENGTH(TRIM(s.referouthosp)) = 5 
		AND ( SUBSTR(DIAGCODE,1,1) in('C')
			OR SUBSTR(DIAGCODE,1,2) in('D0')
			OR SUBSTR(DIAGCODE,1,3) BETWEEN 'I20' AND 'I25'
			OR SUBSTR(DIAGCODE,1,3) BETWEEN 'V01' AND 'Y98'
		)
);

INSERT IGNORE INTO t_refer_4pa (
SELECT
s.HOSPCODE,s.pid,s.AN,DATE_FORMAT(s.DATETIME_DISCH,'%Y%m%d'),s.DISCHTYPE,s.causeout,referouthosp,d.DIAGCODE,d.DIAGTYPE, 'ipdcase' source
FROM tmp_admission s 
	INNER JOIN tmp_diag_ipd d ON s.HOSPCODE=d.HOSPCODE AND s.AN=d.AN
	INNER JOIN (
		SELECT hcode FROM ccmihosp 
		WHERE byear in(@b_year+543)  AND chwcode in(@prov_c) 	AND hcode NOT IN (SELECT HOSPCODE FROM chospital_boat)
		GROUP BY hcode 
	) c ON s.HOSPCODE=c.hcode
	INNER JOIN (
		SELECT hcode FROM ccmihosp WHERE byear in(@b_year+543)  AND region NOT in(@my_zone) GROUP BY hcode 
	) z ON s.referouthosp=z.hcode
	INNER JOIN tmz_person p ON s.hospcode=p.HOSPCODE AND s.pid=p.PID
WHERE DATE_FORMAT(s.DATETIME_DISCH,'%Y%m%d') BETWEEN @start_d AND @end_d AND LENGTH(TRIM(s.referouthosp)) = 5 
	AND TIMESTAMPDIFF(day,p.BIRTH,s.DATETIME_DISCH) <= 28
	);

DELETE FROM t_refer_4pa WHERE hospcode in(
SELECT hcode  FROM ccmihosp WHERE byear in(@b_year+543)  AND region in(3) GROUP BY hcode 
) AND SUBSTR(DIAGCODE,1,3) BETWEEN 'I20' AND 'I25' ;

 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.6586559;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:341;a:5:{i:0;s:4403:"CREATE PROCEDURE t_refer_4pa()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '52';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
SET @my_zone:=(SELECT zonecode FROM sys_config LIMIT 1);

DROP TABLE IF EXISTS tmz_person;
CREATE TEMPORARY TABLE IF NOT EXISTS tmz_person (PRIMARY KEY (hospcode,pid,birth),KEY (birth)  ) ENGINE=myisam as
(
SELECT * FROM person WHERE BIRTH BETWEEN concat(@b_year-1,'0701') AND @end_d
);
/*opdcase typeout=3*/
DROP TABLE IF  EXISTS t_refer_4pa;
CREATE TABLE IF NOT EXISTS t_refer_4pa (PRIMARY KEY(hospcode,pid,seq_an,diagcode) ,KEY (causeout),KEY (typeout) ) ENGINE=myisam as
(SELECT
s.HOSPCODE,s.pid,s.seq seq_an,s.date_serv,s.typeout,s.causeout,referouthosp,d.DIAGCODE,d.DIAGTYPE, 'opdcase' source
FROM tmp_service s 
	INNER JOIN tmp_diag_opd d ON s.HOSPCODE=d.HOSPCODE AND s.pid=d.PID AND s.seq=d.SEQ
	INNER JOIN (
		SELECT hcode FROM ccmihosp 
		WHERE byear in(@b_year+543)  AND chwcode in(@prov_c) 	AND hcode NOT IN (SELECT HOSPCODE FROM chospital_boat)
		GROUP BY hcode 
	) c ON s.HOSPCODE=c.hcode
	INNER JOIN (
		SELECT hcode FROM ccmihosp WHERE byear in(@b_year+543)  AND region NOT in(@my_zone) GROUP BY hcode 
	) z ON s.referouthosp=z.hcode
WHERE s.date_serv BETWEEN @start_d AND @end_d AND LENGTH(TRIM(s.referouthosp)) = 5 
		AND ( SUBSTR(DIAGCODE,1,1) in('C')
			OR SUBSTR(DIAGCODE,1,2) in('D0')
			OR SUBSTR(DIAGCODE,1,3) BETWEEN 'I20' AND 'I25'
			OR SUBSTR(DIAGCODE,1,3) BETWEEN 'V01' AND 'Y98'
		)
);

INSERT IGNORE INTO t_refer_4pa (
SELECT
s.HOSPCODE,s.pid,s.seq,s.date_serv,s.typeout,s.causeout,referouthosp,d.DIAGCODE,d.DIAGTYPE, 'opdcase' source
FROM tmp_service s 
	INNER JOIN tmp_diag_opd d ON s.HOSPCODE=d.HOSPCODE AND s.pid=d.PID AND s.seq=d.SEQ
	INNER JOIN (
		SELECT hcode FROM ccmihosp 
		WHERE byear in(@b_year+543)  AND chwcode in(@prov_c) 	AND hcode NOT IN (SELECT HOSPCODE FROM chospital_boat)
		GROUP BY hcode 
	) c ON s.HOSPCODE=c.hcode
	INNER JOIN (
		SELECT hcode FROM ccmihosp WHERE byear in(@b_year+543)  AND region NOT in(@my_zone) GROUP BY hcode 
	) z ON s.referouthosp=z.hcode
  INNER JOIN tmz_person p ON s.hospcode=p.HOSPCODE AND s.pid=p.PID
WHERE s.date_serv BETWEEN @start_d AND @end_d AND LENGTH(TRIM(s.referouthosp)) = 5 
	AND TIMESTAMPDIFF(day,p.BIRTH,s.date_serv) <= 28
	);

/*ipdcase DISCHTYPE=4*/
INSERT IGNORE INTO t_refer_4pa (
SELECT
s.HOSPCODE,s.pid,s.AN,DATE_FORMAT(s.DATETIME_DISCH,'%Y%m%d'),s.DISCHTYPE,s.causeout,referouthosp,d.DIAGCODE,d.DIAGTYPE, 'ipdcase' source
FROM tmp_admission s 
	INNER JOIN tmp_diag_ipd d ON s.HOSPCODE=d.HOSPCODE AND s.AN=d.AN
	INNER JOIN (
		SELECT hcode FROM ccmihosp 
		WHERE byear in(@b_year+543)  AND chwcode in(@prov_c) 	AND hcode NOT IN (SELECT HOSPCODE FROM chospital_boat)
		GROUP BY hcode 
	) c ON s.HOSPCODE=c.hcode
	INNER JOIN (
		SELECT hcode FROM ccmihosp WHERE byear in(@b_year+543)  AND region NOT in(@my_zone) GROUP BY hcode 
	) z ON s.referouthosp=z.hcode
WHERE DATE_FORMAT(s.DATETIME_DISCH,'%Y%m%d') BETWEEN @start_d AND @end_d AND LENGTH(TRIM(s.referouthosp)) = 5 
		AND ( SUBSTR(DIAGCODE,1,1) in('C')
			OR SUBSTR(DIAGCODE,1,2) in('D0')
			OR SUBSTR(DIAGCODE,1,3) BETWEEN 'I20' AND 'I25'
			OR SUBSTR(DIAGCODE,1,3) BETWEEN 'V01' AND 'Y98'
		)
);

INSERT IGNORE INTO t_refer_4pa (
SELECT
s.HOSPCODE,s.pid,s.AN,DATE_FORMAT(s.DATETIME_DISCH,'%Y%m%d'),s.DISCHTYPE,s.causeout,referouthosp,d.DIAGCODE,d.DIAGTYPE, 'ipdcase' source
FROM tmp_admission s 
	INNER JOIN tmp_diag_ipd d ON s.HOSPCODE=d.HOSPCODE AND s.AN=d.AN
	INNER JOIN (
		SELECT hcode FROM ccmihosp 
		WHERE byear in(@b_year+543)  AND chwcode in(@prov_c) 	AND hcode NOT IN (SELECT HOSPCODE FROM chospital_boat)
		GROUP BY hcode 
	) c ON s.HOSPCODE=c.hcode
	INNER JOIN (
		SELECT hcode FROM ccmihosp WHERE byear in(@b_year+543)  AND region NOT in(@my_zone) GROUP BY hcode 
	) z ON s.referouthosp=z.hcode
	INNER JOIN tmz_person p ON s.hospcode=p.HOSPCODE AND s.pid=p.PID
WHERE DATE_FORMAT(s.DATETIME_DISCH,'%Y%m%d') BETWEEN @start_d AND @end_d AND LENGTH(TRIM(s.referouthosp)) = 5 
	AND TIMESTAMPDIFF(day,p.BIRTH,s.DATETIME_DISCH) <= 28
	);

DELETE FROM t_refer_4pa WHERE hospcode in(
SELECT hcode  FROM ccmihosp WHERE byear in(@b_year+543)  AND region in(3) GROUP BY hcode 
) AND SUBSTR(DIAGCODE,1,3) BETWEEN 'I20' AND 'I25' ;

 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.721056;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:343;a:5:{i:0;s:36:"DROP PROCEDURE IF EXISTS t_death28pa";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.721056;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:344;a:5:{i:0;s:36:"DROP PROCEDURE IF EXISTS t_death28pa";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.7678559;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:346;a:5:{i:0;s:2015:"CREATE PROCEDURE t_death28pa()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '53';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');


DROP TABLE IF EXISTS tmp_labor_hosp;
CREATE  TABLE IF NOT EXISTS tmp_labor_hosp(PRIMARY KEY (cid,bdate)) ENGINE= myisam as
(SELECT l.HOSPCODE,l.PID,l.BDATE,l.BHOSP,l.LBORN,p.NATION,p.CID
FROM tmp_labor l 
			INNER JOIN chospital c ON l.HOSPCODE=c.hoscode and c.hostype IN(5,6,7,11)
			INNER JOIN person p ON l.HOSPCODE=p.HOSPCODE AND l.pid=p.PID
WHERE l.BDATE BETWEEN @start_d AND @end_d 
AND  l.BHOSP IN(SELECT hoscode FROM chospital WHERE hostype IN(5,6,7,11) )
GROUP BY p.cid,l.bdate
);

INSERT IGNORE INTO tmp_labor_hosp (
SELECT l.HOSPCODE,l.PID,l.BDATE,l.BHOSP,l.LBORN,p.NATION,p.CID
FROM tmp_labor l 
			INNER JOIN person p ON l.HOSPCODE=p.HOSPCODE AND l.pid=p.PID
WHERE l.BDATE BETWEEN @start_d AND @end_d 
AND  l.BHOSP IN(SELECT hoscode FROM chospital WHERE hostype IN(5,6,7,11) ) 
GROUP BY p.cid,l.bdate
);


DROP TABLE IF EXISTS t_death28;
CREATE  TABLE IF NOT EXISTS t_death28(
date_death date,
DISCHARGE VARCHAR(2),
source VARCHAR(20),
PRIMARY KEY (hospcode,pid)) ENGINE= myisam as
(
SELECT s.HOSPCODE,s.pid,s.CID,p.`NAME`,p.LNAME,p.BIRTH,DATE_FORMAT(s.DATETIME_DISCH,'%Y%m%d') date_death 
,s.DISCHTYPE as DISCHARGE, 'admission' as source
FROM  tmp_admission s INNER JOIN person p ON s.HOSPCODE=p.HOSPCODE AND s.pid=p.PID
WHERE DATE_FORMAT(s.DATETIME_DISCH,'%Y%m%d') BETWEEN @start_d AND @end_d  
AND (s.DISCHTYPE in(8,9) OR s.DISCHSTATUS in(8,9))
AND TIMESTAMPDIFF(day,p.BIRTH,s.DATETIME_DISCH) <=28
);
INSERT IGNORE INTO t_death28 (
SELECT s.HOSPCODE,s.pid,s.CID,p.`NAME`,p.LNAME,p.BIRTH,date_serv,typeout, 'service' as source
FROM  tmp_service s INNER JOIN person p ON s.HOSPCODE=p.HOSPCODE AND s.pid=p.PID
WHERE s.date_serv BETWEEN @start_d AND @end_d  AND s.typeout in(4,5,6) 
AND TIMESTAMPDIFF(day,p.BIRTH,s.date_serv) <=28
);

 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.7678559;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:347;a:5:{i:0;s:2015:"CREATE PROCEDURE t_death28pa()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '53';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');


DROP TABLE IF EXISTS tmp_labor_hosp;
CREATE  TABLE IF NOT EXISTS tmp_labor_hosp(PRIMARY KEY (cid,bdate)) ENGINE= myisam as
(SELECT l.HOSPCODE,l.PID,l.BDATE,l.BHOSP,l.LBORN,p.NATION,p.CID
FROM tmp_labor l 
			INNER JOIN chospital c ON l.HOSPCODE=c.hoscode and c.hostype IN(5,6,7,11)
			INNER JOIN person p ON l.HOSPCODE=p.HOSPCODE AND l.pid=p.PID
WHERE l.BDATE BETWEEN @start_d AND @end_d 
AND  l.BHOSP IN(SELECT hoscode FROM chospital WHERE hostype IN(5,6,7,11) )
GROUP BY p.cid,l.bdate
);

INSERT IGNORE INTO tmp_labor_hosp (
SELECT l.HOSPCODE,l.PID,l.BDATE,l.BHOSP,l.LBORN,p.NATION,p.CID
FROM tmp_labor l 
			INNER JOIN person p ON l.HOSPCODE=p.HOSPCODE AND l.pid=p.PID
WHERE l.BDATE BETWEEN @start_d AND @end_d 
AND  l.BHOSP IN(SELECT hoscode FROM chospital WHERE hostype IN(5,6,7,11) ) 
GROUP BY p.cid,l.bdate
);


DROP TABLE IF EXISTS t_death28;
CREATE  TABLE IF NOT EXISTS t_death28(
date_death date,
DISCHARGE VARCHAR(2),
source VARCHAR(20),
PRIMARY KEY (hospcode,pid)) ENGINE= myisam as
(
SELECT s.HOSPCODE,s.pid,s.CID,p.`NAME`,p.LNAME,p.BIRTH,DATE_FORMAT(s.DATETIME_DISCH,'%Y%m%d') date_death 
,s.DISCHTYPE as DISCHARGE, 'admission' as source
FROM  tmp_admission s INNER JOIN person p ON s.HOSPCODE=p.HOSPCODE AND s.pid=p.PID
WHERE DATE_FORMAT(s.DATETIME_DISCH,'%Y%m%d') BETWEEN @start_d AND @end_d  
AND (s.DISCHTYPE in(8,9) OR s.DISCHSTATUS in(8,9))
AND TIMESTAMPDIFF(day,p.BIRTH,s.DATETIME_DISCH) <=28
);
INSERT IGNORE INTO t_death28 (
SELECT s.HOSPCODE,s.pid,s.CID,p.`NAME`,p.LNAME,p.BIRTH,date_serv,typeout, 'service' as source
FROM  tmp_service s INNER JOIN person p ON s.HOSPCODE=p.HOSPCODE AND s.pid=p.PID
WHERE s.date_serv BETWEEN @start_d AND @end_d  AND s.typeout in(4,5,6) 
AND TIMESTAMPDIFF(day,p.BIRTH,s.date_serv) <=28
);

 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.830256;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:349;a:5:{i:0;s:38:"DROP PROCEDURE IF EXISTS t_occupat_new";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.830256;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:350;a:5:{i:0;s:38:"DROP PROCEDURE IF EXISTS t_occupat_new";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.8770559;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:352;a:5:{i:0;s:1206:"CREATE PROCEDURE t_occupat_new()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '54';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF  EXISTS t_occupat_new;
CREATE TABLE IF NOT EXISTS t_occupat_new(
  id varchar(32) NOT NULL,
  hospcode varchar(5) NOT NULL,
  areacode varchar(8) NOT NULL,
  b_year varchar(4) NOT NULL,
	occupation_new varchar(4) NOT NULL,
	result int(9) DEFAULT 0,
	PRIMARY KEY (id,hospcode,areacode,b_year,occupation_new),
	KEY (hospcode),
	KEY (areacode),
	KEY (b_year)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO t_occupat_new (
SELECT @id,p.check_hosp hospcode ,p.check_vhid  areacode	
	  ,@b_year+543 as b_year
		,p.OCCUPATION_NEW
		,COUNT(DISTINCT p.cid) target
		FROM  t_person_cid p
	  WHERE SUBSTR(p.check_vhid,1,2) in(@prov_c)  
       AND p.check_typearea in(1,3) AND p.NATION in(99) 
       AND (p.DISCHARGE  in(2,3,9) OR (p.DISCHARGE  in(1)  AND p.DDISCHARGE > @start_d))
       AND TIMESTAMPDIFF(year,p.birth,CONCAT(@b_year,'0101')) BETWEEN 0 AND 199
		GROUP BY CONCAT(p.check_hosp ,'-' , p.check_vhid ,'-',p.OCCUPATION_NEW)
);
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.8770559;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:353;a:5:{i:0;s:1206:"CREATE PROCEDURE t_occupat_new()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '54';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF  EXISTS t_occupat_new;
CREATE TABLE IF NOT EXISTS t_occupat_new(
  id varchar(32) NOT NULL,
  hospcode varchar(5) NOT NULL,
  areacode varchar(8) NOT NULL,
  b_year varchar(4) NOT NULL,
	occupation_new varchar(4) NOT NULL,
	result int(9) DEFAULT 0,
	PRIMARY KEY (id,hospcode,areacode,b_year,occupation_new),
	KEY (hospcode),
	KEY (areacode),
	KEY (b_year)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO t_occupat_new (
SELECT @id,p.check_hosp hospcode ,p.check_vhid  areacode	
	  ,@b_year+543 as b_year
		,p.OCCUPATION_NEW
		,COUNT(DISTINCT p.cid) target
		FROM  t_person_cid p
	  WHERE SUBSTR(p.check_vhid,1,2) in(@prov_c)  
       AND p.check_typearea in(1,3) AND p.NATION in(99) 
       AND (p.DISCHARGE  in(2,3,9) OR (p.DISCHARGE  in(1)  AND p.DDISCHARGE > @start_d))
       AND TIMESTAMPDIFF(year,p.birth,CONCAT(@b_year,'0101')) BETWEEN 0 AND 199
		GROUP BY CONCAT(p.check_hosp ,'-' , p.check_vhid ,'-',p.OCCUPATION_NEW)
);
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.939456;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:355;a:5:{i:0;s:40:"DROP PROCEDURE IF EXISTS t_person_envocc";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.939456;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:356;a:5:{i:0;s:40:"DROP PROCEDURE IF EXISTS t_person_envocc";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988055.9862559;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:358;a:5:{i:0;s:1372:"CREATE PROCEDURE t_person_envocc()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '55';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF  EXISTS t_person_envocc;
CREATE TABLE IF NOT EXISTS t_person_envocc(
PRIMARY KEY (hospcode,areacode)
,KEY (hospcode)
,KEY (areacode)
) ENGINE = myisam AS
(SELECT
	p.check_hosp hospcode,p.vhid areacode
	,COUNT(DISTINCT IF(TIMESTAMPDIFF(year,p.birth,CONCAT(@b_year,'0101')) BETWEEN 0 AND  4,  p.CID,NULL)) result04
	,COUNT(DISTINCT IF(TIMESTAMPDIFF(year,p.birth,CONCAT(@b_year,'0101')) BETWEEN 5 AND  9,  p.CID,NULL)) result59
	,COUNT(DISTINCT IF(TIMESTAMPDIFF(year,p.birth,CONCAT(@b_year,'0101')) BETWEEN 10 AND  14,  p.CID,NULL)) result1014
	,COUNT(DISTINCT IF(TIMESTAMPDIFF(year,p.birth,CONCAT(@b_year,'0101')) BETWEEN 15 AND  59,  p.CID,NULL)) result1559
	,COUNT(DISTINCT IF(TIMESTAMPDIFF(year,p.birth,CONCAT(@b_year,'0101')) BETWEEN 60 AND  199,  p.CID,NULL)) result60
FROM
t_person_cid p
WHERE SUBSTR(p.vhid,1,2) in(@prov_c)  AND (p.cid is null OR p.cid is not null) 
AND p.check_typearea in(1,3) AND p.NATION in(99) 
AND (p.DISCHARGE  in(2,3,9) OR (p.DISCHARGE  in(1)  AND p.DDISCHARGE > @start_d))
AND TIMESTAMPDIFF(year,p.birth,CONCAT(@b_year,'0101')) BETWEEN 0 AND 199
GROUP BY p.check_hosp,p.vhid
);
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.001857;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:359;a:5:{i:0;s:1372:"CREATE PROCEDURE t_person_envocc()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '55';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF  EXISTS t_person_envocc;
CREATE TABLE IF NOT EXISTS t_person_envocc(
PRIMARY KEY (hospcode,areacode)
,KEY (hospcode)
,KEY (areacode)
) ENGINE = myisam AS
(SELECT
	p.check_hosp hospcode,p.vhid areacode
	,COUNT(DISTINCT IF(TIMESTAMPDIFF(year,p.birth,CONCAT(@b_year,'0101')) BETWEEN 0 AND  4,  p.CID,NULL)) result04
	,COUNT(DISTINCT IF(TIMESTAMPDIFF(year,p.birth,CONCAT(@b_year,'0101')) BETWEEN 5 AND  9,  p.CID,NULL)) result59
	,COUNT(DISTINCT IF(TIMESTAMPDIFF(year,p.birth,CONCAT(@b_year,'0101')) BETWEEN 10 AND  14,  p.CID,NULL)) result1014
	,COUNT(DISTINCT IF(TIMESTAMPDIFF(year,p.birth,CONCAT(@b_year,'0101')) BETWEEN 15 AND  59,  p.CID,NULL)) result1559
	,COUNT(DISTINCT IF(TIMESTAMPDIFF(year,p.birth,CONCAT(@b_year,'0101')) BETWEEN 60 AND  199,  p.CID,NULL)) result60
FROM
t_person_cid p
WHERE SUBSTR(p.vhid,1,2) in(@prov_c)  AND (p.cid is null OR p.cid is not null) 
AND p.check_typearea in(1,3) AND p.NATION in(99) 
AND (p.DISCHARGE  in(2,3,9) OR (p.DISCHARGE  in(1)  AND p.DDISCHARGE > @start_d))
AND TIMESTAMPDIFF(year,p.birth,CONCAT(@b_year,'0101')) BETWEEN 0 AND 199
GROUP BY p.check_hosp,p.vhid
);
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.0642569;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:361;a:5:{i:0;s:38:"DROP PROCEDURE IF EXISTS tmp_specialpp";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.0642569;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:362;a:5:{i:0;s:38:"DROP PROCEDURE IF EXISTS tmp_specialpp";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.111057;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:364;a:5:{i:0;s:11130:"CREATE PROCEDURE tmp_specialpp()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '56';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
SET @begin_d=DATE_ADD(@start_d,INTERVAL -43 month);
SET @begin_d1=DATE_ADD(@start_d,INTERVAL -1 month);
SET @end_d1:=concat(@b_year,'1030');


/*เตรียมข้อมูล*/
DROP TABLE IF EXISTS tmp_specialpp;
CREATE TABLE IF NOT EXISTS tmp_specialpp(
PRIMARY KEY (HOSPCODE,PID,DATE_SERV,PPSPECIAL) 
,KEY (cid)
,KEY (hospcode,pid)
,KEY (date_serv)
,KEY (ppspecial)
)(
SELECT 
s.*,p.CID
FROM specialpp s LEFT JOIN person p ON s.HOSPCODE=p.HOSPCODE AND s.PID=p.PID
WHERE DATE_SERV BETWEEN @begin_d1 AND @end_d1
);

/*หาเด็กกลุ่มเป้าหมาย*/
DROP TABLE IF EXISTS t_childdev;
CREATE TABLE  IF NOT EXISTS t_childdev(
  `HOSPCODE` varchar(5) NOT NULL DEFAULT '',
  `PID` varchar(15) NOT NULL DEFAULT '',
  `CID` varchar(13) NOT NULL,
  `BIRTH` date  DEFAULT NULL,
  `SEX` varchar(1) NOT NULL DEFAULT '',
  `AREACODE` varchar(8) DEFAULT NULL,
  `TYPEAREA` varchar(1) NOT NULL DEFAULT '',
  `AGE_9` int(1) NOT NULL DEFAULT '0',
  `AGE_18` int(1) NOT NULL DEFAULT '0',
  `AGE_30` int(1) NOT NULL DEFAULT '0',
  `AGE_42` int(1) NOT NULL DEFAULT '0',
PRIMARY KEY (`HOSPCODE`,`PID`),
 KEY (`HOSPCODE`,`PID`,`CID`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;
INSERT IGNORE INTO t_childdev (SELECT
 p.HOSPCODE,p.PID,p.CID,p.BIRTH,p.SEX,p.check_vhid AREACODE,p.check_typearea TYPEAREA,0,0,0,0
FROM t_person_cid  p
WHERE BIRTH BETWEEN @begin_d AND @end_d AND
						check_typearea in('1','3') AND p.DISCHARGE='9' AND LENGTH(trim(p.CID))=13 AND  NATION in(99) 
);

UPDATE t_childdev SET AGE_9=1 WHERE (DATE_ADD(BIRTH,INTERVAL 9 month)  BETWEEN @start_d AND @end_d) 
			OR (DATE_ADD(BIRTH,INTERVAL 10 month)  BETWEEN @start_d AND @end_d);
UPDATE t_childdev SET AGE_18=1 WHERE (DATE_ADD(BIRTH,INTERVAL 18 month)  BETWEEN @start_d AND @end_d)
			OR (DATE_ADD(BIRTH,INTERVAL 19 month)  BETWEEN @start_d AND @end_d);
UPDATE t_childdev SET AGE_30=1 WHERE (DATE_ADD(BIRTH,INTERVAL 30 month)  BETWEEN @start_d AND @end_d)
			OR (DATE_ADD(BIRTH,INTERVAL 31 month)  BETWEEN @start_d AND @end_d);
UPDATE t_childdev SET AGE_42=1 WHERE (DATE_ADD(BIRTH,INTERVAL 42 month)  BETWEEN @start_d AND @end_d)
			OR (DATE_ADD(BIRTH,INTERVAL 43 month)  BETWEEN @start_d AND @end_d);

/*นำเด็กกลุ่มเป้าหมายเข้าตารางคำนวน*/
DROP TABLE IF EXISTS t_childdev_specialpp;
CREATE TABLE  IF NOT EXISTS t_childdev_specialpp(
hospcode VARCHAR(5) NOT NULL,
pid VARCHAR(15) NOT NULL,
cid VARCHAR(15) NOT NULL DEFAULT '',
birth date,
sex VARCHAR(1) NOT NULL,
areacode VARCHAR(8) NOT NULL,
typearea VARCHAR(1) DEFAULT NULL,
agemonth VARCHAR(3) NOT NULL DEFAULT '',
date_start date,
date_end date,
date_serv_first date,
status1 VARCHAR(1) DEFAULT NULL,
date_serv2 date,
sp_first text,
sp_last text,
date_serv_last date,
status2 VARCHAR(1) DEFAULT NULL,
status21 VARCHAR(1) DEFAULT NULL,
status22 VARCHAR(1) DEFAULT NULL,
status23 VARCHAR(1) DEFAULT NULL,
status24 VARCHAR(1) DEFAULT NULL,
status25 VARCHAR(1) DEFAULT NULL,
 PRIMARY KEY(hospcode,pid,cid,agemonth)
,KEY (hospcode,pid,cid)
) ENGINE=MyISAM ;

INSERT IGNORE INTO t_childdev_specialpp (hospcode,pid,cid,birth,sex,areacode,typearea,agemonth)
(
SELECT
p.hospcode,p.pid,p.cid,p.birth,p.sex,p.areacode,p.typearea,'42'
FROM t_childdev p
WHERE AGE_42=1
);
INSERT IGNORE INTO t_childdev_specialpp (hospcode,pid,cid,birth,sex,areacode,typearea,agemonth)
(
SELECT
p.hospcode,p.pid,p.cid,p.birth,p.sex,p.areacode,p.typearea,'30'
FROM t_childdev p
WHERE AGE_30=1
);
INSERT IGNORE INTO t_childdev_specialpp (hospcode,pid,cid,birth,sex,areacode,typearea,agemonth)
(
SELECT
p.hospcode,p.pid,p.cid,p.birth,p.sex,p.areacode,p.typearea,'18'
FROM t_childdev p
WHERE AGE_18=1
);
INSERT IGNORE INTO t_childdev_specialpp (hospcode,pid,cid,birth,sex,areacode,typearea,agemonth)
(
SELECT
p.hospcode,p.pid,p.cid,p.birth,p.sex,p.areacode,p.typearea,'9'
FROM t_childdev p
WHERE AGE_9=1
);



INSERT IGNORE INTO t_childdev_specialpp (hospcode,pid,cid,birth,sex,areacode,typearea,agemonth)
(SELECT
p.hospcode,p.pid,p.cid,p.birth,p.sex,p.areacode,p.typearea
,IF(age_18=1 AND age_9=1 , 18 ,0)
FROM t_childdev p
);
INSERT IGNORE INTO t_childdev_specialpp (hospcode,pid,cid,birth,sex,areacode,typearea,agemonth)
(SELECT
p.hospcode,p.pid,p.cid,p.birth,p.sex,p.areacode,p.typearea
,IF(age_18=1 AND age_9=1 , 9 ,0)
FROM t_childdev p
);
DELETE FROM t_childdev_specialpp WHERE agemonth=0;

/*อัพเดทช่วงวันที่ที่ทำแล้วถือว่าได้รับการคัดกรอง*/
UPDATE  t_childdev_specialpp SET date_start=DATE_ADD(BIRTH,INTERVAL 9 month) ,date_end=DATE_ADD(DATE_ADD(BIRTH,INTERVAL 10 month),INTERVAL -1 DAY)  WHERE agemonth=9;
UPDATE  t_childdev_specialpp SET date_start=DATE_ADD(BIRTH,INTERVAL 18 month) ,date_end=DATE_ADD(DATE_ADD(BIRTH,INTERVAL 19 month),INTERVAL -1 DAY)  WHERE agemonth=18;
UPDATE  t_childdev_specialpp SET date_start=DATE_ADD(BIRTH,INTERVAL 30 month) ,date_end=DATE_ADD(DATE_ADD(BIRTH,INTERVAL 31 month),INTERVAL -1 DAY)  WHERE agemonth=30;
UPDATE  t_childdev_specialpp SET date_start=DATE_ADD(BIRTH,INTERVAL 42 month) ,date_end=DATE_ADD(DATE_ADD(BIRTH,INTERVAL 43 month),INTERVAL -1 DAY)  WHERE agemonth=42;

/*หาวันที่วันแรกที่ได้รับการตรวจเอาวันน้อยที่สุดจากวันเกิดที่มีรหัสที่กำหนด*/
UPDATE t_childdev_specialpp s INNER JOIN 
(
			SELECT s1.cid,s1.date_start, s1.date_end ,MIN(t1.date_serv) min_date_serv
			FROM tmp_specialpp  t1 INNER JOIN t_childdev_specialpp s1 ON  t1.cid=s1.cid
			WHERE t1.date_serv BETWEEN s1.date_start AND s1.date_end 
			AND PPSPECIAL in('1B260','1B261','1B262' ,'1B200'
			,'1B201','1B202','1B209','1B210','1B211','1B212'
			,'1B219','1B220','1B221','1B222','1B229','1B230'
			,'1B231','1B232','1B239','1B240','1B241','1B242','1B249')
			GROUP BY t1.cid,s1.date_start
)
t  ON s.cid=t.cid   AND s.date_start=t.date_start
SET s.date_serv_first= t.min_date_serv
WHERE t.min_date_serv BETWEEN s.date_start AND s.date_end ;

/*อัพเดททgroup รหัสที่ทำวันแรกทั้งหมด*/
UPDATE t_childdev_specialpp s INNER JOIN 
(
			SELECT s1.cid,s1.date_serv_first ,GROUP_CONCAT(t1.PPSPECIAL ORDER BY t1.PPSPECIAL) gr_sp
			FROM tmp_specialpp  t1 INNER JOIN t_childdev_specialpp s1 ON  t1.cid=s1.cid
			WHERE t1.date_serv in(s1.date_serv_first)
			GROUP BY t1.cid,s1.date_serv_first
)
t  ON s.cid=t.cid  AND s.date_serv_first=t.date_serv_first
SET s.sp_first= t.gr_sp	 ;

/*สรุปผลครั้งแรกตามเงื่อนไข*/
UPDATE t_childdev_specialpp SET status1=IF(INSTR(sp_first,'1B260'),1
,IF(INSTR(sp_first,'1B261'),2
,IF(INSTR(sp_first,'1B262'),3
,NULL
)))
WHERE date_serv_first IS NOT NULL;

/*สรุปผลครั้งแรกถ้าลงรหัสแบบที่ละด้านแบบเดิม*/
UPDATE t_childdev_specialpp SET status1=IF(INSTR(sp_first,'1B200,1B210,1B220,1B230,1B240'),1,NULL)
WHERE date_serv_first IS NOT NULL AND status1 IS NULL;

UPDATE t_childdev_specialpp SET status1=IF(
instr(sp_first,'1B201') 
OR instr(sp_first,'1B211') 
OR instr(sp_first,'1B221') 
OR instr(sp_first,'1B231') 
OR instr(sp_first,'1B241') 
,2,NULL)
WHERE date_serv_first IS NOT NULL AND status1 IS NULL;

UPDATE t_childdev_specialpp SET status1=IF(
instr(sp_first,'1B202') 
OR instr(sp_first,'1B212') 
OR instr(sp_first,'1B222') 
OR instr(sp_first,'1B232') 
OR instr(sp_first,'1B242') 
,3,NULL)
WHERE date_serv_first IS NOT NULL AND status1 IS NULL;


/*อัพเดทวันที่ติดตามนับจากวันครั้งแรกถึงวันสุดท้ายที่ไม่เกิน 30 วันที่เป็นไปได้ กรณีผิดปกติ*/
UPDATE  t_childdev_specialpp SET date_serv2=DATE_ADD(date_serv_first,INTERVAL 30 day) 
WHERE date_serv_first  IS NOT NULL AND status1 in(2) ;


/*หาวันที่วันสุดท้ายที่มาตรวจ  ตามช่วง 30 วันที่กำหนด เปลี่ยนได้ตลอดจนกว่าจะเลย 30 วัน*/
UPDATE t_childdev_specialpp s INNER JOIN 
(
			SELECT s1.cid,s1.date_serv_first, s1.date_serv2 ,MAX(t1.date_serv) max_date_serv
			FROM tmp_specialpp  t1 INNER JOIN t_childdev_specialpp s1 ON  t1.cid=s1.cid
			WHERE t1.date_serv BETWEEN s1.date_serv_first AND s1.date_serv2 
			AND PPSPECIAL in('1B260','1B261','1B262' ,'1B200'
			,'1B201','1B202','1B209','1B210','1B211','1B212'
			,'1B219','1B220','1B221','1B222','1B229','1B230'
			,'1B231','1B232','1B239','1B240','1B241','1B242','1B249')
			GROUP BY t1.cid,s1.date_serv2
)
t  ON s.cid=t.cid  AND s.date_serv2=t.date_serv2
SET s.date_serv_last= t.max_date_serv
WHERE t.max_date_serv BETWEEN s.date_serv_first AND s.date_serv2 
AND t.max_date_serv > s.date_serv_first AND s.date_serv2 is not null;


/*อัพเดททgroup รหัสวันสุดท้ายกรณีที่ติดตาม จะเปลี่ยนแปลงได้ตลอดจนกว่าจะเลย 30 วันจึงจะสรุปได้จริง*/
UPDATE t_childdev_specialpp s INNER JOIN 
(
			SELECT s1.cid,s1.date_serv_last ,GROUP_CONCAT(t1.PPSPECIAL) gr_sp
			FROM tmp_specialpp  t1 INNER JOIN t_childdev_specialpp s1 ON  t1.cid=s1.cid
			WHERE t1.date_serv in(s1.date_serv_last)
			GROUP BY t1.cid,s1.date_serv_last
)
t  ON s.cid=t.cid   AND s.date_serv_last=t.date_serv_last
SET s.sp_last= t.gr_sp
WHERE  s.date_serv2 is not null	 ;
/*สรุปผลครั้งสุดท้าย*/
UPDATE t_childdev_specialpp SET status21=IF(INSTR(sp_last,'1B202'),1,null),
status22=IF(INSTR(sp_last,'1B212'),1,null),
status23=IF(INSTR(sp_last,'1B222'),1,null),
status24=IF(INSTR(sp_last,'1B232'),1,null),
status25= IF(INSTR(sp_last,'1B242'),1,null)
WHERE date_serv_last IS NOT NULL AND  INSTR(sp_last,'1B260')=0  
AND date_serv_last > date_serv_first  
AND NOW() > date_serv2 
AND date_serv2 is not null;

UPDATE t_childdev_specialpp SET status2=IF(INSTR(sp_last,'1B260'),1,NULL)
 WHERE date_serv_last IS NOT NULL AND date_serv_last > date_serv_first AND status2 IS NULL
AND date_serv2 is not null;

/*สรุปผลครั้งสุดท้ายถ้าลงรหัสแบบที่ละด้านแบบเดิม*/
UPDATE t_childdev_specialpp SET status2=IF(INSTR(sp_first,'1B200,1B210,1B220,1B230,1B240'),1,NULL)
WHERE date_serv_last IS NOT NULL AND date_serv_last > date_serv_first AND status2 IS NULL
AND date_serv2 is not null;
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.111057;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:365;a:5:{i:0;s:11130:"CREATE PROCEDURE tmp_specialpp()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '56';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
SET @begin_d=DATE_ADD(@start_d,INTERVAL -43 month);
SET @begin_d1=DATE_ADD(@start_d,INTERVAL -1 month);
SET @end_d1:=concat(@b_year,'1030');


/*เตรียมข้อมูล*/
DROP TABLE IF EXISTS tmp_specialpp;
CREATE TABLE IF NOT EXISTS tmp_specialpp(
PRIMARY KEY (HOSPCODE,PID,DATE_SERV,PPSPECIAL) 
,KEY (cid)
,KEY (hospcode,pid)
,KEY (date_serv)
,KEY (ppspecial)
)(
SELECT 
s.*,p.CID
FROM specialpp s LEFT JOIN person p ON s.HOSPCODE=p.HOSPCODE AND s.PID=p.PID
WHERE DATE_SERV BETWEEN @begin_d1 AND @end_d1
);

/*หาเด็กกลุ่มเป้าหมาย*/
DROP TABLE IF EXISTS t_childdev;
CREATE TABLE  IF NOT EXISTS t_childdev(
  `HOSPCODE` varchar(5) NOT NULL DEFAULT '',
  `PID` varchar(15) NOT NULL DEFAULT '',
  `CID` varchar(13) NOT NULL,
  `BIRTH` date  DEFAULT NULL,
  `SEX` varchar(1) NOT NULL DEFAULT '',
  `AREACODE` varchar(8) DEFAULT NULL,
  `TYPEAREA` varchar(1) NOT NULL DEFAULT '',
  `AGE_9` int(1) NOT NULL DEFAULT '0',
  `AGE_18` int(1) NOT NULL DEFAULT '0',
  `AGE_30` int(1) NOT NULL DEFAULT '0',
  `AGE_42` int(1) NOT NULL DEFAULT '0',
PRIMARY KEY (`HOSPCODE`,`PID`),
 KEY (`HOSPCODE`,`PID`,`CID`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;
INSERT IGNORE INTO t_childdev (SELECT
 p.HOSPCODE,p.PID,p.CID,p.BIRTH,p.SEX,p.check_vhid AREACODE,p.check_typearea TYPEAREA,0,0,0,0
FROM t_person_cid  p
WHERE BIRTH BETWEEN @begin_d AND @end_d AND
						check_typearea in('1','3') AND p.DISCHARGE='9' AND LENGTH(trim(p.CID))=13 AND  NATION in(99) 
);

UPDATE t_childdev SET AGE_9=1 WHERE (DATE_ADD(BIRTH,INTERVAL 9 month)  BETWEEN @start_d AND @end_d) 
			OR (DATE_ADD(BIRTH,INTERVAL 10 month)  BETWEEN @start_d AND @end_d);
UPDATE t_childdev SET AGE_18=1 WHERE (DATE_ADD(BIRTH,INTERVAL 18 month)  BETWEEN @start_d AND @end_d)
			OR (DATE_ADD(BIRTH,INTERVAL 19 month)  BETWEEN @start_d AND @end_d);
UPDATE t_childdev SET AGE_30=1 WHERE (DATE_ADD(BIRTH,INTERVAL 30 month)  BETWEEN @start_d AND @end_d)
			OR (DATE_ADD(BIRTH,INTERVAL 31 month)  BETWEEN @start_d AND @end_d);
UPDATE t_childdev SET AGE_42=1 WHERE (DATE_ADD(BIRTH,INTERVAL 42 month)  BETWEEN @start_d AND @end_d)
			OR (DATE_ADD(BIRTH,INTERVAL 43 month)  BETWEEN @start_d AND @end_d);

/*นำเด็กกลุ่มเป้าหมายเข้าตารางคำนวน*/
DROP TABLE IF EXISTS t_childdev_specialpp;
CREATE TABLE  IF NOT EXISTS t_childdev_specialpp(
hospcode VARCHAR(5) NOT NULL,
pid VARCHAR(15) NOT NULL,
cid VARCHAR(15) NOT NULL DEFAULT '',
birth date,
sex VARCHAR(1) NOT NULL,
areacode VARCHAR(8) NOT NULL,
typearea VARCHAR(1) DEFAULT NULL,
agemonth VARCHAR(3) NOT NULL DEFAULT '',
date_start date,
date_end date,
date_serv_first date,
status1 VARCHAR(1) DEFAULT NULL,
date_serv2 date,
sp_first text,
sp_last text,
date_serv_last date,
status2 VARCHAR(1) DEFAULT NULL,
status21 VARCHAR(1) DEFAULT NULL,
status22 VARCHAR(1) DEFAULT NULL,
status23 VARCHAR(1) DEFAULT NULL,
status24 VARCHAR(1) DEFAULT NULL,
status25 VARCHAR(1) DEFAULT NULL,
 PRIMARY KEY(hospcode,pid,cid,agemonth)
,KEY (hospcode,pid,cid)
) ENGINE=MyISAM ;

INSERT IGNORE INTO t_childdev_specialpp (hospcode,pid,cid,birth,sex,areacode,typearea,agemonth)
(
SELECT
p.hospcode,p.pid,p.cid,p.birth,p.sex,p.areacode,p.typearea,'42'
FROM t_childdev p
WHERE AGE_42=1
);
INSERT IGNORE INTO t_childdev_specialpp (hospcode,pid,cid,birth,sex,areacode,typearea,agemonth)
(
SELECT
p.hospcode,p.pid,p.cid,p.birth,p.sex,p.areacode,p.typearea,'30'
FROM t_childdev p
WHERE AGE_30=1
);
INSERT IGNORE INTO t_childdev_specialpp (hospcode,pid,cid,birth,sex,areacode,typearea,agemonth)
(
SELECT
p.hospcode,p.pid,p.cid,p.birth,p.sex,p.areacode,p.typearea,'18'
FROM t_childdev p
WHERE AGE_18=1
);
INSERT IGNORE INTO t_childdev_specialpp (hospcode,pid,cid,birth,sex,areacode,typearea,agemonth)
(
SELECT
p.hospcode,p.pid,p.cid,p.birth,p.sex,p.areacode,p.typearea,'9'
FROM t_childdev p
WHERE AGE_9=1
);



INSERT IGNORE INTO t_childdev_specialpp (hospcode,pid,cid,birth,sex,areacode,typearea,agemonth)
(SELECT
p.hospcode,p.pid,p.cid,p.birth,p.sex,p.areacode,p.typearea
,IF(age_18=1 AND age_9=1 , 18 ,0)
FROM t_childdev p
);
INSERT IGNORE INTO t_childdev_specialpp (hospcode,pid,cid,birth,sex,areacode,typearea,agemonth)
(SELECT
p.hospcode,p.pid,p.cid,p.birth,p.sex,p.areacode,p.typearea
,IF(age_18=1 AND age_9=1 , 9 ,0)
FROM t_childdev p
);
DELETE FROM t_childdev_specialpp WHERE agemonth=0;

/*อัพเดทช่วงวันที่ที่ทำแล้วถือว่าได้รับการคัดกรอง*/
UPDATE  t_childdev_specialpp SET date_start=DATE_ADD(BIRTH,INTERVAL 9 month) ,date_end=DATE_ADD(DATE_ADD(BIRTH,INTERVAL 10 month),INTERVAL -1 DAY)  WHERE agemonth=9;
UPDATE  t_childdev_specialpp SET date_start=DATE_ADD(BIRTH,INTERVAL 18 month) ,date_end=DATE_ADD(DATE_ADD(BIRTH,INTERVAL 19 month),INTERVAL -1 DAY)  WHERE agemonth=18;
UPDATE  t_childdev_specialpp SET date_start=DATE_ADD(BIRTH,INTERVAL 30 month) ,date_end=DATE_ADD(DATE_ADD(BIRTH,INTERVAL 31 month),INTERVAL -1 DAY)  WHERE agemonth=30;
UPDATE  t_childdev_specialpp SET date_start=DATE_ADD(BIRTH,INTERVAL 42 month) ,date_end=DATE_ADD(DATE_ADD(BIRTH,INTERVAL 43 month),INTERVAL -1 DAY)  WHERE agemonth=42;

/*หาวันที่วันแรกที่ได้รับการตรวจเอาวันน้อยที่สุดจากวันเกิดที่มีรหัสที่กำหนด*/
UPDATE t_childdev_specialpp s INNER JOIN 
(
			SELECT s1.cid,s1.date_start, s1.date_end ,MIN(t1.date_serv) min_date_serv
			FROM tmp_specialpp  t1 INNER JOIN t_childdev_specialpp s1 ON  t1.cid=s1.cid
			WHERE t1.date_serv BETWEEN s1.date_start AND s1.date_end 
			AND PPSPECIAL in('1B260','1B261','1B262' ,'1B200'
			,'1B201','1B202','1B209','1B210','1B211','1B212'
			,'1B219','1B220','1B221','1B222','1B229','1B230'
			,'1B231','1B232','1B239','1B240','1B241','1B242','1B249')
			GROUP BY t1.cid,s1.date_start
)
t  ON s.cid=t.cid   AND s.date_start=t.date_start
SET s.date_serv_first= t.min_date_serv
WHERE t.min_date_serv BETWEEN s.date_start AND s.date_end ;

/*อัพเดททgroup รหัสที่ทำวันแรกทั้งหมด*/
UPDATE t_childdev_specialpp s INNER JOIN 
(
			SELECT s1.cid,s1.date_serv_first ,GROUP_CONCAT(t1.PPSPECIAL ORDER BY t1.PPSPECIAL) gr_sp
			FROM tmp_specialpp  t1 INNER JOIN t_childdev_specialpp s1 ON  t1.cid=s1.cid
			WHERE t1.date_serv in(s1.date_serv_first)
			GROUP BY t1.cid,s1.date_serv_first
)
t  ON s.cid=t.cid  AND s.date_serv_first=t.date_serv_first
SET s.sp_first= t.gr_sp	 ;

/*สรุปผลครั้งแรกตามเงื่อนไข*/
UPDATE t_childdev_specialpp SET status1=IF(INSTR(sp_first,'1B260'),1
,IF(INSTR(sp_first,'1B261'),2
,IF(INSTR(sp_first,'1B262'),3
,NULL
)))
WHERE date_serv_first IS NOT NULL;

/*สรุปผลครั้งแรกถ้าลงรหัสแบบที่ละด้านแบบเดิม*/
UPDATE t_childdev_specialpp SET status1=IF(INSTR(sp_first,'1B200,1B210,1B220,1B230,1B240'),1,NULL)
WHERE date_serv_first IS NOT NULL AND status1 IS NULL;

UPDATE t_childdev_specialpp SET status1=IF(
instr(sp_first,'1B201') 
OR instr(sp_first,'1B211') 
OR instr(sp_first,'1B221') 
OR instr(sp_first,'1B231') 
OR instr(sp_first,'1B241') 
,2,NULL)
WHERE date_serv_first IS NOT NULL AND status1 IS NULL;

UPDATE t_childdev_specialpp SET status1=IF(
instr(sp_first,'1B202') 
OR instr(sp_first,'1B212') 
OR instr(sp_first,'1B222') 
OR instr(sp_first,'1B232') 
OR instr(sp_first,'1B242') 
,3,NULL)
WHERE date_serv_first IS NOT NULL AND status1 IS NULL;


/*อัพเดทวันที่ติดตามนับจากวันครั้งแรกถึงวันสุดท้ายที่ไม่เกิน 30 วันที่เป็นไปได้ กรณีผิดปกติ*/
UPDATE  t_childdev_specialpp SET date_serv2=DATE_ADD(date_serv_first,INTERVAL 30 day) 
WHERE date_serv_first  IS NOT NULL AND status1 in(2) ;


/*หาวันที่วันสุดท้ายที่มาตรวจ  ตามช่วง 30 วันที่กำหนด เปลี่ยนได้ตลอดจนกว่าจะเลย 30 วัน*/
UPDATE t_childdev_specialpp s INNER JOIN 
(
			SELECT s1.cid,s1.date_serv_first, s1.date_serv2 ,MAX(t1.date_serv) max_date_serv
			FROM tmp_specialpp  t1 INNER JOIN t_childdev_specialpp s1 ON  t1.cid=s1.cid
			WHERE t1.date_serv BETWEEN s1.date_serv_first AND s1.date_serv2 
			AND PPSPECIAL in('1B260','1B261','1B262' ,'1B200'
			,'1B201','1B202','1B209','1B210','1B211','1B212'
			,'1B219','1B220','1B221','1B222','1B229','1B230'
			,'1B231','1B232','1B239','1B240','1B241','1B242','1B249')
			GROUP BY t1.cid,s1.date_serv2
)
t  ON s.cid=t.cid  AND s.date_serv2=t.date_serv2
SET s.date_serv_last= t.max_date_serv
WHERE t.max_date_serv BETWEEN s.date_serv_first AND s.date_serv2 
AND t.max_date_serv > s.date_serv_first AND s.date_serv2 is not null;


/*อัพเดททgroup รหัสวันสุดท้ายกรณีที่ติดตาม จะเปลี่ยนแปลงได้ตลอดจนกว่าจะเลย 30 วันจึงจะสรุปได้จริง*/
UPDATE t_childdev_specialpp s INNER JOIN 
(
			SELECT s1.cid,s1.date_serv_last ,GROUP_CONCAT(t1.PPSPECIAL) gr_sp
			FROM tmp_specialpp  t1 INNER JOIN t_childdev_specialpp s1 ON  t1.cid=s1.cid
			WHERE t1.date_serv in(s1.date_serv_last)
			GROUP BY t1.cid,s1.date_serv_last
)
t  ON s.cid=t.cid   AND s.date_serv_last=t.date_serv_last
SET s.sp_last= t.gr_sp
WHERE  s.date_serv2 is not null	 ;
/*สรุปผลครั้งสุดท้าย*/
UPDATE t_childdev_specialpp SET status21=IF(INSTR(sp_last,'1B202'),1,null),
status22=IF(INSTR(sp_last,'1B212'),1,null),
status23=IF(INSTR(sp_last,'1B222'),1,null),
status24=IF(INSTR(sp_last,'1B232'),1,null),
status25= IF(INSTR(sp_last,'1B242'),1,null)
WHERE date_serv_last IS NOT NULL AND  INSTR(sp_last,'1B260')=0  
AND date_serv_last > date_serv_first  
AND NOW() > date_serv2 
AND date_serv2 is not null;

UPDATE t_childdev_specialpp SET status2=IF(INSTR(sp_last,'1B260'),1,NULL)
 WHERE date_serv_last IS NOT NULL AND date_serv_last > date_serv_first AND status2 IS NULL
AND date_serv2 is not null;

/*สรุปผลครั้งสุดท้ายถ้าลงรหัสแบบที่ละด้านแบบเดิม*/
UPDATE t_childdev_specialpp SET status2=IF(INSTR(sp_first,'1B200,1B210,1B220,1B230,1B240'),1,NULL)
WHERE date_serv_last IS NOT NULL AND date_serv_last > date_serv_first AND status2 IS NULL
AND date_serv2 is not null;
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.1734569;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:367;a:5:{i:0;s:44:"DROP PROCEDURE IF EXISTS t_nutrition_service";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.1734569;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:368;a:5:{i:0;s:44:"DROP PROCEDURE IF EXISTS t_nutrition_service";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.251457;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:370;a:5:{i:0;s:3554:"CREATE PROCEDURE t_nutrition_service()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '57';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS t_nutrition_service;
CREATE TABLE IF NOT EXISTS t_nutrition_service(
hospcode VARCHAR(5) NOT NULL,
pid VARCHAR(15) NOT NULL,
seq VARCHAR(16) NOT NULL,
date_serv date,
weight decimal(5,1) NOT NULL,
height  int(3) NOT NULL,
HEADCIRCUM int(3) DEFAULT NULL,
FOOD varchar(1) DEFAULT NULL,
BOTTLE varchar(1) DEFAULT NULL,
BIRTH date,
SEX varchar(1) NOT NULL,
NATION varchar(3) DEFAULT NULL,
quarter_m int(1) DEFAULT 0,
nutri1 int(1) DEFAULT 0,
nutri2 int(1) DEFAULT 0,
nutri3 int(1) DEFAULT 0,
PRIMARY KEY (hospcode,pid,quarter_m)
)  ENGINE MyISAM DEFAULT CHARACTER SET=utf8;

INSERT IGNORE INTO t_nutrition_service (HOSPCODE,PID,SEQ,DATE_SERV,WEIGHT,HEIGHT,HEADCIRCUM,FOOD,BOTTLE
,BIRTH,SEX,NATION,quarter_m)
(
SELECT n.HOSPCODE,n.PID,n.SEQ,n.DATE_SERV,n.WEIGHT,n.HEIGHT,n.HEADCIRCUM,FOOD,BOTTLE
,p.BIRTH,p.SEX,p.NATION, IF(DATE_FORMAT(n.DATE_SERV,'%m') BETWEEN 10 AND 12,1,
IF(DATE_FORMAT(n.DATE_SERV,'%m') BETWEEN 1 AND 3,2,
IF(DATE_FORMAT(n.DATE_SERV,'%m') BETWEEN 4 AND 6,3,
IF(DATE_FORMAT(n.DATE_SERV,'%m') BETWEEN 7 AND 9,4,0
 )))) as quarter_m
FROM
tmp_nutrition n INNER JOIN t_person_db p ON n.HOSPCODE=p.HOSPCODE AND n.PID=p.PID
WHERE WEIGHT BETWEEN 0.1  AND 300 AND HEIGHT   BETWEEN 40 AND 250 
AND n.DATE_SERV >= p.birth
AND n.DATE_SERV BETWEEN  @start_d AND @end_d
AND p.NATION in(99) 
ORDER BY n.HOSPCODE ASC ,n.PID ASC ,n.DATE_SERV DESC 
);

UPDATE t_nutrition_service SET nutri1=nutri_cal(TIMESTAMPDIFF(month,birth,date_serv),sex,1,height,weight)
,nutri2=nutri_cal(TIMESTAMPDIFF(month,birth,date_serv),sex,2,height,weight)
,nutri3=nutri_cal(TIMESTAMPDIFF(month,birth,date_serv),sex,3,height,weight);

DROP TABLE IF EXISTS t_nutrition_service6_14;
CREATE TABLE IF NOT EXISTS t_nutrition_service6_14(
hospcode VARCHAR(5) NOT NULL,
pid VARCHAR(15) NOT NULL,
seq VARCHAR(16) NOT NULL,
date_serv date,
weight decimal(5,1) NOT NULL,
height  int(3) NOT NULL,
HEADCIRCUM int(3) DEFAULT NULL,
FOOD varchar(1) DEFAULT NULL,
BOTTLE varchar(1) DEFAULT NULL,
BIRTH date,
SEX varchar(1) NOT NULL,
NATION varchar(3) DEFAULT NULL,
quarter_m int(1) DEFAULT 0,
nutri1 int(1) DEFAULT 0,
nutri2 int(1) DEFAULT 0,
nutri3 int(1) DEFAULT 0,
PRIMARY KEY (hospcode,pid,quarter_m)
)  ENGINE MyISAM DEFAULT CHARACTER SET=utf8;

INSERT IGNORE INTO t_nutrition_service6_14 (HOSPCODE,PID,SEQ,DATE_SERV,WEIGHT,HEIGHT,HEADCIRCUM,FOOD,BOTTLE
,BIRTH,SEX,NATION,quarter_m)
(
SELECT n.HOSPCODE,n.PID,n.SEQ,n.DATE_SERV,n.WEIGHT,n.HEIGHT,n.HEADCIRCUM,FOOD,BOTTLE
,p.BIRTH,p.SEX,p.NATION, IF(DATE_FORMAT(n.DATE_SERV,'%m') BETWEEN 10 AND 11,2,
IF(DATE_FORMAT(n.DATE_SERV,'%m') BETWEEN 5 AND 6,1,0
 )) as quarter_m
FROM
tmp_nutrition n INNER JOIN t_person_db p ON n.HOSPCODE=p.HOSPCODE AND n.PID=p.PID
WHERE WEIGHT BETWEEN 0.1  AND 300 AND HEIGHT   BETWEEN 40 AND 250 
AND n.DATE_SERV >= p.birth AND TIMESTAMPDIFF(YEAR,p.BIRTH,n.DATE_SERV) BETWEEN 6 AND 14
AND  n.DATE_SERV BETWEEN  @start_d AND @end_d
AND p.NATION in(99) 
ORDER BY n.HOSPCODE ASC ,n.PID ASC ,n.DATE_SERV DESC 
);

UPDATE t_nutrition_service6_14 SET nutri1=nutri_cal(TIMESTAMPDIFF(month,birth,date_serv),sex,1,height,weight)
,nutri2=nutri_cal(TIMESTAMPDIFF(month,birth,date_serv),sex,2,height,weight)
,nutri3=nutri_cal(TIMESTAMPDIFF(month,birth,date_serv),sex,3,height,weight);


 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.251457;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:371;a:5:{i:0;s:3554:"CREATE PROCEDURE t_nutrition_service()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '57';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS t_nutrition_service;
CREATE TABLE IF NOT EXISTS t_nutrition_service(
hospcode VARCHAR(5) NOT NULL,
pid VARCHAR(15) NOT NULL,
seq VARCHAR(16) NOT NULL,
date_serv date,
weight decimal(5,1) NOT NULL,
height  int(3) NOT NULL,
HEADCIRCUM int(3) DEFAULT NULL,
FOOD varchar(1) DEFAULT NULL,
BOTTLE varchar(1) DEFAULT NULL,
BIRTH date,
SEX varchar(1) NOT NULL,
NATION varchar(3) DEFAULT NULL,
quarter_m int(1) DEFAULT 0,
nutri1 int(1) DEFAULT 0,
nutri2 int(1) DEFAULT 0,
nutri3 int(1) DEFAULT 0,
PRIMARY KEY (hospcode,pid,quarter_m)
)  ENGINE MyISAM DEFAULT CHARACTER SET=utf8;

INSERT IGNORE INTO t_nutrition_service (HOSPCODE,PID,SEQ,DATE_SERV,WEIGHT,HEIGHT,HEADCIRCUM,FOOD,BOTTLE
,BIRTH,SEX,NATION,quarter_m)
(
SELECT n.HOSPCODE,n.PID,n.SEQ,n.DATE_SERV,n.WEIGHT,n.HEIGHT,n.HEADCIRCUM,FOOD,BOTTLE
,p.BIRTH,p.SEX,p.NATION, IF(DATE_FORMAT(n.DATE_SERV,'%m') BETWEEN 10 AND 12,1,
IF(DATE_FORMAT(n.DATE_SERV,'%m') BETWEEN 1 AND 3,2,
IF(DATE_FORMAT(n.DATE_SERV,'%m') BETWEEN 4 AND 6,3,
IF(DATE_FORMAT(n.DATE_SERV,'%m') BETWEEN 7 AND 9,4,0
 )))) as quarter_m
FROM
tmp_nutrition n INNER JOIN t_person_db p ON n.HOSPCODE=p.HOSPCODE AND n.PID=p.PID
WHERE WEIGHT BETWEEN 0.1  AND 300 AND HEIGHT   BETWEEN 40 AND 250 
AND n.DATE_SERV >= p.birth
AND n.DATE_SERV BETWEEN  @start_d AND @end_d
AND p.NATION in(99) 
ORDER BY n.HOSPCODE ASC ,n.PID ASC ,n.DATE_SERV DESC 
);

UPDATE t_nutrition_service SET nutri1=nutri_cal(TIMESTAMPDIFF(month,birth,date_serv),sex,1,height,weight)
,nutri2=nutri_cal(TIMESTAMPDIFF(month,birth,date_serv),sex,2,height,weight)
,nutri3=nutri_cal(TIMESTAMPDIFF(month,birth,date_serv),sex,3,height,weight);

DROP TABLE IF EXISTS t_nutrition_service6_14;
CREATE TABLE IF NOT EXISTS t_nutrition_service6_14(
hospcode VARCHAR(5) NOT NULL,
pid VARCHAR(15) NOT NULL,
seq VARCHAR(16) NOT NULL,
date_serv date,
weight decimal(5,1) NOT NULL,
height  int(3) NOT NULL,
HEADCIRCUM int(3) DEFAULT NULL,
FOOD varchar(1) DEFAULT NULL,
BOTTLE varchar(1) DEFAULT NULL,
BIRTH date,
SEX varchar(1) NOT NULL,
NATION varchar(3) DEFAULT NULL,
quarter_m int(1) DEFAULT 0,
nutri1 int(1) DEFAULT 0,
nutri2 int(1) DEFAULT 0,
nutri3 int(1) DEFAULT 0,
PRIMARY KEY (hospcode,pid,quarter_m)
)  ENGINE MyISAM DEFAULT CHARACTER SET=utf8;

INSERT IGNORE INTO t_nutrition_service6_14 (HOSPCODE,PID,SEQ,DATE_SERV,WEIGHT,HEIGHT,HEADCIRCUM,FOOD,BOTTLE
,BIRTH,SEX,NATION,quarter_m)
(
SELECT n.HOSPCODE,n.PID,n.SEQ,n.DATE_SERV,n.WEIGHT,n.HEIGHT,n.HEADCIRCUM,FOOD,BOTTLE
,p.BIRTH,p.SEX,p.NATION, IF(DATE_FORMAT(n.DATE_SERV,'%m') BETWEEN 10 AND 11,2,
IF(DATE_FORMAT(n.DATE_SERV,'%m') BETWEEN 5 AND 6,1,0
 )) as quarter_m
FROM
tmp_nutrition n INNER JOIN t_person_db p ON n.HOSPCODE=p.HOSPCODE AND n.PID=p.PID
WHERE WEIGHT BETWEEN 0.1  AND 300 AND HEIGHT   BETWEEN 40 AND 250 
AND n.DATE_SERV >= p.birth AND TIMESTAMPDIFF(YEAR,p.BIRTH,n.DATE_SERV) BETWEEN 6 AND 14
AND  n.DATE_SERV BETWEEN  @start_d AND @end_d
AND p.NATION in(99) 
ORDER BY n.HOSPCODE ASC ,n.PID ASC ,n.DATE_SERV DESC 
);

UPDATE t_nutrition_service6_14 SET nutri1=nutri_cal(TIMESTAMPDIFF(month,birth,date_serv),sex,1,height,weight)
,nutri2=nutri_cal(TIMESTAMPDIFF(month,birth,date_serv),sex,2,height,weight)
,nutri3=nutri_cal(TIMESTAMPDIFF(month,birth,date_serv),sex,3,height,weight);


 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.3138571;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:373;a:5:{i:0;s:34:"DROP PROCEDURE IF EXISTS t_cvdrisk";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.3138571;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:374;a:5:{i:0;s:34:"DROP PROCEDURE IF EXISTS t_cvdrisk";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.3918569;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:376;a:5:{i:0;s:18289:"CREATE PROCEDURE t_cvdrisk()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '58';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'0701');
SET	@start_d10:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
SET @end_d12:=concat(@b_year-1,'1231');

DROP TABLE IF EXISTS t_cvd_ill;
CREATE TABLE IF NOT EXISTS t_cvd_ill(
 CID varchar(13) NOT NULL
 ,`BIRTH` date
 ,`SEX` varchar(1) NOT NULL
 ,source_tb VARCHAR(255) DEFAULT NULL 
 ,mix_dx VARCHAR(255) DEFAULT NULL 	
 ,date_dx VARCHAR(255) DEFAULT NULL 
 ,hosp_dx varchar(255) DEFAULT NULL 
 ,hosp_input varchar(255) DEFAULT NULL 
,PRIMARY KEY (`CID`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;
INSERT IGNORE INTO 	t_cvd_ill (
SELECT cid,birth,sex
,GROUP_CONCAT(source_tb ORDER BY date_dx)
,GROUP_CONCAT(diagcode ORDER BY date_dx)
,GROUP_CONCAT(date_dx ORDER BY date_dx)
,GROUP_CONCAT(IFNULL(hosp_dx,input_hosp) ORDER BY date_dx)
,GROUP_CONCAT(input_hosp ORDER BY date_dx)
FROM t_chronic WHERE SUBSTR(UPPER(diagcode),1,4) IN ('E105','E115','E125','E135','E145','I110','I119') 
OR SUBSTR(UPPER(diagcode),1,3) BETWEEN  'I60' AND 'I64' 
OR SUBSTR(UPPER(diagcode),1,3) IN ('I13') 
GROUP BY cid
);

DROP TABLE IF EXISTS tmp_fu_screen;
CREATE TABLE IF NOT EXISTS tmp_fu_screen(
 `HOSPCODE` varchar(5) NOT NULL,
 `CID` varchar(13) DEFAULT NULL,
 `PID` varchar(15) NOT NULL,
	`SEQ` varchar(16) NOT NULL,
 `DATE_SERV` date NOT NULL,
 `SBP` int(3) NOT NULL DEFAULT  0,
 `SBP_SOURCE` VARCHAR(20) DEFAULT NULL,
 `WAIST_CM` int(3) NOT NULL DEFAULT 0,
 `WAIST_SOURCE` VARCHAR(20) DEFAULT NULL,
 `HEIGHT` int(3) NOT NULL DEFAULT 0,
 `HEIGHT_SOURCE` VARCHAR(20) DEFAULT NULL,
 `QUARTERM` VARCHAR(1) DEFAULT NULL,
PRIMARY KEY (`HOSPCODE`,`PID`,`DATE_SERV`),
  KEY  (`HOSPCODE`,`PID`),
  KEY  (`HOSPCODE`),
  KEY  (`DATE_SERV`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO tmp_fu_screen (
SELECT  HOSPCODE,CID,PID,SEQ,DATE_SERV,SBP,'CHRONICFU',WAIST_CM,'CHRONICFU',HEIGHT,'CHRONICFU',NULL
FROM tmp_chronicfu
WHERE date_serv BETWEEN @start_d AND @end_d
);
INSERT IGNORE INTO tmp_fu_screen (
SELECT  HOSPCODE,CID,PID,SEQ,DATE_SERV,IF(SBP_2>0,SBP_2,SBP_1) SBP,'NCDSCREEN',WAIST_CM,'NCDSCREEN',HEIGHT,'NCDSCREEN',NULL
FROM tmp_ncdscreen
WHERE date_serv BETWEEN @start_d AND @end_d
);
UPDATE tmp_fu_screen SET QUARTERM=IF( DATE_SERV < concat(@b_year-1,'1001'),0,
IF(DATE_SERV BETWEEN concat(@b_year-1,'1001') AND concat(@b_year-1,'1231'),1,
IF(DATE_SERV BETWEEN concat(@b_year,'0101') AND concat(@b_year,'0331'),2,
IF(DATE_SERV BETWEEN concat(@b_year,'0401') AND concat(@b_year,'0630'),3,
IF(DATE_SERV BETWEEN concat(@b_year,'0701') AND concat(@b_year,'0930'),4,null
)))));

/*LAB TOTAL CHOL*/
DROP TABLE IF EXISTS tmz_labcvd;
CREATE TABLE IF NOT EXISTS tmz_labcvd(
 `QUARTERM` VARCHAR(1) DEFAULT NULL,
PRIMARY KEY (HOSPCODE,PID,SEQ,LABTEST),KEY (CID) ,KEY (DATE_SERV), KEY (HOSPCODE,PID,DATE_SERV)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 AS
(SELECT *,null as QUARTERM FROM tmp_labfu WHERE LABTEST in(7) AND LABRESULT >0 GROUP BY HOSPCODE,PID,SEQ,LABTEST);

UPDATE tmz_labcvd SET QUARTERM=IF( DATE_SERV < concat(@b_year-1,'1001'),0,
IF(DATE_SERV BETWEEN concat(@b_year-1,'1001') AND concat(@b_year-1,'1231'),1,
IF(DATE_SERV BETWEEN concat(@b_year,'0101') AND concat(@b_year,'0331'),2,
IF(DATE_SERV BETWEEN concat(@b_year,'0401') AND concat(@b_year,'0630'),3,
IF(DATE_SERV BETWEEN concat(@b_year,'0701') AND concat(@b_year,'0930'),4,null
)))));

/*SMOKE */
DROP TABLE IF EXISTS tmp_smoke;
CREATE TABLE IF NOT EXISTS tmp_smoke(
 `HOSPCODE` varchar(5) NOT NULL,
 `PID` varchar(15) NOT NULL,
 `CID` varchar(13) DEFAULT NULL,
 `DATE_SERV` date NOT NULL,
 `SMOKE_SOURCE`  VARCHAR(50) DEFAULT NULL,
 `RESULT` VARCHAR(1) DEFAULT NULL COMMENT '1=สูบ,0=ไม่สูบ',
 `QUARTERM` VARCHAR(1) DEFAULT NULL,
PRIMARY KEY (HOSPCODE,PID,DATE_SERV),KEY (CID) ,KEY (DATE_SERV), KEY (HOSPCODE,PID,DATE_SERV)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 ;

INSERT IGNORE INTO tmp_smoke(
SELECT HOSPCODE,PID,CID,DATE_SERV,'NCDSCREEN',IF(SMOKE=1,0,1) ,NULL 
FROM tmp_ncdscreen WHERE SMOKE in(1,2,3,4)
);
INSERT IGNORE INTO tmp_smoke(
SELECT  HOSPCODE,PID,CID,DATE_SERV,'SPECIALPP',1 ,NULL 
FROM tmp_specialpp 
WHERE SUBSTR(PPSPECIAL,1,4) IN('1B50','1B53','1B54','1B55','1B56')
);
INSERT IGNORE INTO tmp_smoke(
SELECT  HOSPCODE,PID,CID,DATE_SERV,'SPECIALPP',0 ,NULL 
FROM tmp_specialpp WHERE PPSPECIAL in('1B51','1B52') 
);
UPDATE tmp_smoke SET QUARTERM=IF( DATE_SERV < concat(@b_year-1,'1001'),0,
IF(DATE_SERV BETWEEN concat(@b_year-1,'1001') AND concat(@b_year-1,'1231'),1,
IF(DATE_SERV BETWEEN concat(@b_year,'0101') AND concat(@b_year,'0331'),2,
IF(DATE_SERV BETWEEN concat(@b_year,'0401') AND concat(@b_year,'0630'),3,
IF(DATE_SERV BETWEEN concat(@b_year,'0701') AND concat(@b_year,'0930'),4,null
)))));

/*T_CVD*/
DROP TABLE IF EXISTS t_cvdrisk;
CREATE TABLE IF NOT EXISTS t_cvdrisk(
 `CID` varchar(13) DEFAULT NULL
 ,`BIRTH` date
 ,`SEX` varchar(1) NOT NULL
 ,`TYPEAREA` varchar(1) NOT NULL
 ,`nation` varchar(3) DEFAULT NULL
,source_tb VARCHAR(255) DEFAULT NULL 
 ,mix_dx VARCHAR(255) DEFAULT NULL 	
 ,t_mix_dx VARCHAR(255) DEFAULT NULL 	
 ,type_dx VARCHAR(2) DEFAULT NULL 
 ,date_dx VARCHAR(255) DEFAULT NULL 
 ,hosp_dx varchar(255) DEFAULT NULL 
	,`AGE_Y` int(3) NOT NULL DEFAULT '0' 
	,`SEX_CVD` varchar(1) DEFAULT NULL
 ,`QUARTERM` VARCHAR(1) DEFAULT NULL
 ,`SMOKING` varchar(1) DEFAULT NULL
 ,`SMOKE_DATE` date DEFAULT NULL
 ,`SMOKE_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`SMOKE_SOURCE` VARCHAR(20) DEFAULT NULL
 ,`DM` varchar(1) DEFAULT NULL
 ,`SBP` int(3) NOT NULL DEFAULT  0
 ,`SBP_DATE` date DEFAULT NULL
 ,`SBP_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`SBP_SOURCE` VARCHAR(20) DEFAULT NULL
 ,`CHOL` double(6,2) NOT NULL DEFAULT 0
 ,`CHOL_DATE` date DEFAULT NULL
 ,`CHOL_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`WAIST_CM` int(3) NOT NULL DEFAULT 0
 ,`WAIST_DATE` date DEFAULT NULL
 ,`WAIST_HOSPCODE` VARCHAR(5) DEFAULT NULL
  ,`WAIST_SOURCE` VARCHAR(20) DEFAULT NULL
 ,`HEIGHT` int(3) NOT NULL DEFAULT 0
 ,`HEIGHT_DATE` date DEFAULT NULL
 ,`HEIGHT_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`HEIGHT_SOURCE` VARCHAR(20) DEFAULT NULL
 ,`RISK_SCORE` DECIMAL(5,2) NOT NULL DEFAULT 0.00
,PRIMARY KEY (`CID`, `QUARTERM` )
	,KEY  (`CID`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

SET @x=0;
SET @max= 5;
WHILE @x<@max DO
INSERT IGNORE INTO t_cvdrisk(
	cid,birth,sex,typearea,age_y,nation,source_tb,hosp_dx,mix_dx,t_mix_dx,date_dx,QUARTERM
)
(
	SELECT SQL_BIG_RESULT 
			p.cid,p.birth,p.sex,p.typearea, p.age_y,p.nation
			,GROUP_CONCAT(c.source_tb order by date_dx) source_tb
			,GROUP_CONCAT(hosp_dx order by date_dx) hosp_dx
			,GROUP_CONCAT(diagcode order by date_dx ) diagcode
			,GROUP_CONCAT(DISTINCT  substr(diagcode,1,1) order by  substr(diagcode,1,1) ) 
			,GROUP_CONCAT(date_dx order by date_dx) date_dx
			,@x
FROM
(SELECT c.* FROM t_chronic c LEFT JOIN t_cvd_ill i ON c.cid=i.cid
WHERE  (SUBSTR(UPPER(c.diagcode),1,3) BETWEEN  'E10' and 'E14'  OR 	SUBSTR(UPPER(c.diagcode),1,3) BETWEEN  'I10' and 'I15')  
AND ISNULL(i.cid)
GROUP BY concat(c.cid,'-',c.diagcode) ) c 
INNER JOIN t_person_cid  p ON c.cid = p.cid
WHERE p.nation in(99) AND p.DISCHARGE in(9) AND c.typedisch NOT in(2)
GROUP BY p.cid
);

SET  @x = @x + 1; 
END WHILE;
/*up_mixdiag*/
UPDATE t_cvdrisk 
	SET type_dx = if(t_mix_dx ='I' ,'01'  
							,if(t_mix_dx ='E' ,'02'
							,if(t_mix_dx ='E,I','03',NULL)));
/*up sex cvd*/
UPDATE t_cvdrisk SET SEX_CVD = IF(SEX=2,0,1);
/*up DM*/
UPDATE  t_cvdrisk SET DM=IF(type_dx in(2,3),1,0);
/*dele QUARTER BEFORE date_dx*/
DELETE FROM t_cvdrisk 
WHERE DATE_FORMAT(SUBSTR(date_dx,1,10),'%Y%m') > DATE_FORMAT(concat(@b_year,'0630'),'%Y%m')
AND QUARTERM < 4;

DELETE FROM t_cvdrisk 
WHERE DATE_FORMAT(SUBSTR(date_dx,1,10),'%Y%m') > DATE_FORMAT(concat(@b_year,'0331'),'%Y%m')
AND QUARTERM < 3;

DELETE FROM t_cvdrisk 
WHERE DATE_FORMAT(SUBSTR(date_dx,1,10),'%Y%m') > DATE_FORMAT(concat((@b_year-1),'1231'),'%Y%m')
AND QUARTERM < 2;

DELETE FROM t_cvdrisk 
WHERE DATE_FORMAT(SUBSTR(date_dx,1,10),'%Y%m') > DATE_FORMAT(concat((@b_year-1),'0930'),'%Y%m')
AND QUARTERM < 1;

/*last date sbp*/
SET @x=0;
SET @max= 5;
WHILE @x<@max DO
UPDATE  t_cvdrisk c INNER JOIN 
(SELECT cid,MAX(DATE_SERV) date_serv 
FROM tmp_fu_screen  WHERE SBP BETWEEN 50 AND 300 AND QUARTERM in(@x) GROUP BY CID)  f ON c.cid=f.cid 
SET c.SBP_DATE=f.DATE_SERV WHERE c.QUARTERM in(@x);
SET  @x = @x + 1; 
END WHILE;
/*up last sbp*/
UPDATE  t_cvdrisk c INNER JOIN tmp_fu_screen f ON c.cid=f.cid AND c.SBP_DATE=f.DATE_SERV  
SET c.SBP=f.SBP ,c.SBP_SOURCE=f.SBP_SOURCE,c.SBP_HOSPCODE=f.HOSPCODE
WHERE f.SBP BETWEEN 50 AND 300 ;
/*last date height*/
SET @x=0;
SET @max= 5;
WHILE @x<@max DO
UPDATE  t_cvdrisk c INNER JOIN 
(SELECT cid,MAX(DATE_SERV) date_serv 
FROM tmp_fu_screen  WHERE HEIGHT BETWEEN 90 AND 300 AND QUARTERM in(@x) GROUP BY CID)  f ON c.cid=f.cid 
SET c.HEIGHT_DATE=f.DATE_SERV WHERE c.QUARTERM in(@x);
SET  @x = @x + 1; 
END WHILE;
/*up last height*/
UPDATE  t_cvdrisk c INNER JOIN tmp_fu_screen f ON c.cid=f.cid AND c.HEIGHT_DATE=f.DATE_SERV  
SET c.HEIGHT=f.HEIGHT ,c.HEIGHT_SOURCE=f.HEIGHT_SOURCE,c.HEIGHT_HOSPCODE=f.HOSPCODE
WHERE f.HEIGHT BETWEEN 90 AND 300 ;
/*last date waist*/
SET @x=0;
SET @max= 5;
WHILE @x<@max DO
UPDATE  t_cvdrisk c INNER JOIN 
(SELECT cid,MAX(DATE_SERV) date_serv 
FROM tmp_fu_screen  WHERE WAIST_CM  BETWEEN 40 AND 300 AND QUARTERM in(@x) GROUP BY CID)  f ON c.cid=f.cid 
SET c.WAIST_DATE=f.DATE_SERV WHERE c.QUARTERM in(@x);
SET  @x = @x + 1; 
END WHILE;
/*up last waist*/
UPDATE  t_cvdrisk c INNER JOIN tmp_fu_screen f ON c.cid=f.cid AND c.WAIST_DATE=f.DATE_SERV  
SET c.WAIST_CM=f.WAIST_CM ,c.WAIST_SOURCE=f.WAIST_SOURCE,c.WAIST_HOSPCODE=f.HOSPCODE
WHERE f.WAIST_CM  BETWEEN 40 AND 300 ;

/*last date CHOL*/
SET @x=0;
SET @max= 5;
WHILE @x<@max DO
UPDATE  t_cvdrisk c INNER JOIN 
(SELECT cid,MAX(DATE_SERV) date_serv 
FROM tmz_labcvd  WHERE  QUARTERM in(@x) GROUP BY CID)  f ON c.cid=f.cid 
SET c.CHOL_DATE=f.DATE_SERV WHERE c.QUARTERM in(@x);
SET  @x = @x + 1; 
END WHILE;
/*up last CHOL*/
UPDATE  t_cvdrisk c INNER JOIN tmz_labcvd f ON c.cid=f.cid AND c.CHOL_DATE=f.DATE_SERV  
SET c.CHOL=f.labresult ,c.CHOL_HOSPCODE=f.HOSPCODE;

/*SMOKE*/
UPDATE t_cvdrisk c INNER JOIN (
SELECT cid,RESULT,SMOKE_SOURCE ,HOSPCODE,DATE_SERV
FROM tmp_smoke WHERE DATE_SERV BETWEEN @start_d AND @end_d AND RESULT IN(1)
GROUP BY cid
) f ON c.cid=f.cid
SET c.SMOKE_DATE=f.DATE_SERV,c.SMOKING=f.RESULT ,c.SMOKE_SOURCE=f.SMOKE_SOURCE,c.SMOKE_HOSPCODE=f.HOSPCODE;

UPDATE t_cvdrisk c INNER JOIN (
SELECT cid,RESULT,SMOKE_SOURCE ,HOSPCODE,DATE_SERV
FROM tmp_smoke WHERE DATE_SERV BETWEEN @start_d AND @end_d AND RESULT IN(0)
GROUP BY cid
) f ON c.cid=f.cid
SET c.SMOKE_DATE=f.DATE_SERV,c.SMOKING=f.RESULT ,c.SMOKE_SOURCE=f.SMOKE_SOURCE,c.SMOKE_HOSPCODE=f.HOSPCODE
WHERE ISNULL(c.SMOKING);

/*calc*/
UPDATE t_cvdrisk SET RISK_SCORE=cvd_func(AGE_Y,SEX_CVD,SBP,DM,SMOKING,CHOL,WAIST_CM,HEIGHT)
WHERE AGE_Y >0 AND SEX_CVD is not null  AND DM is not null  AND SMOKING is not null  AND SBP >0 
AND (CHOL >0 OR (WAIST_CM >0 AND HEIGHT >0)) ;

DROP TABLE IF EXISTS t_cvdrisk_fl;
CREATE TABLE IF NOT EXISTS t_cvdrisk_fl(
 `CID` varchar(13) DEFAULT NULL
 ,`BIRTH` date
 ,`SEX` varchar(1) NOT NULL
 ,`TYPEAREA` varchar(1) NOT NULL
 ,`nation` varchar(3) DEFAULT NULL
 ,source_tb VARCHAR(255) DEFAULT NULL 
 ,mix_dx VARCHAR(255) DEFAULT NULL 	
 ,t_mix_dx VARCHAR(255) DEFAULT NULL 	
 ,type_dx VARCHAR(2) DEFAULT NULL 
 ,date_dx VARCHAR(255) DEFAULT NULL 
 ,hosp_dx varchar(255) DEFAULT NULL 
	,`AGE_Y` int(3) NOT NULL DEFAULT '0' 
	,`SEX_CVD` varchar(1) DEFAULT NULL
,`DM` varchar(1) DEFAULT NULL
 ,`F_SMOKING` varchar(1) DEFAULT NULL
 ,`F_SMOKE_DATE` date DEFAULT NULL
 ,`F_SMOKE_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`F_SMOKE_SOURCE` VARCHAR(20) DEFAULT NULL
 ,`L_SMOKING` varchar(1) DEFAULT NULL
 ,`L_SMOKE_DATE` date DEFAULT NULL
 ,`L_SMOKE_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`L_SMOKE_SOURCE` VARCHAR(20) DEFAULT NULL
 ,`F_SBP` int(3) NOT NULL DEFAULT  0
 ,`F_SBP_DATE` date DEFAULT NULL
 ,`F_SBP_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`F_SBP_SOURCE` VARCHAR(20) DEFAULT NULL
 ,`L_SBP` int(3) NOT NULL DEFAULT  0
 ,`L_SBP_DATE` date DEFAULT NULL
 ,`L_SBP_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`L_SBP_SOURCE` VARCHAR(20) DEFAULT NULL
 ,`F_CHOL` double(6,2) NOT NULL DEFAULT 0
 ,`F_CHOL_DATE` date DEFAULT NULL
 ,`F_CHOL_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`L_CHOL` double(6,2) NOT NULL DEFAULT 0
 ,`L_CHOL_DATE` date DEFAULT NULL
 ,`L_CHOL_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`F_WAIST_CM` int(3) NOT NULL DEFAULT 0
 ,`F_WAIST_DATE` date DEFAULT NULL
 ,`F_WAIST_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`F_WAIST_SOURCE` VARCHAR(20) DEFAULT NULL
,`L_WAIST_CM` int(3) NOT NULL DEFAULT 0
 ,`L_WAIST_DATE` date DEFAULT NULL
 ,`L_WAIST_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`L_WAIST_SOURCE` VARCHAR(20) DEFAULT NULL
 ,`F_HEIGHT` int(3) NOT NULL DEFAULT 0
 ,`F_HEIGHT_DATE` date DEFAULT NULL
 ,`F_HEIGHT_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`F_HEIGHT_SOURCE` VARCHAR(20) DEFAULT NULL
 ,`L_HEIGHT` int(3) NOT NULL DEFAULT 0
 ,`L_HEIGHT_DATE` date DEFAULT NULL
 ,`L_HEIGHT_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`L_HEIGHT_SOURCE` VARCHAR(20) DEFAULT NULL
 ,`F_RISK_SCORE` DECIMAL(5,2) NOT NULL DEFAULT 0.00
 ,`L_RISK_SCORE` DECIMAL(5,2) NOT NULL DEFAULT 0.00
,PRIMARY KEY (`CID`)
	,KEY  (`CID`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;
INSERT IGNORE INTO t_cvdrisk_fl (cid,birth,sex,typearea,age_y,nation,source_tb,hosp_dx,mix_dx,t_mix_dx,date_dx,dm,sex_cvd,type_dx)
(
SELECT cid,birth,sex,typearea,age_y,nation,source_tb,hosp_dx,mix_dx,t_mix_dx,date_dx,dm,sex_cvd,type_dx
FROM t_cvdrisk 
);

UPDATE  t_cvdrisk_fl c INNER JOIN 
(SELECT cid,MIN(SMOKE_DATE) date_serv 
FROM t_cvdrisk  WHERE SMOKE_DATE BETWEEN @start_d AND @end_d
 GROUP BY CID)  f ON c.cid=f.cid 
SET c.F_SMOKE_DATE=f.DATE_SERV;
UPDATE  t_cvdrisk_fl c INNER JOIN t_cvdrisk f ON c.cid=f.cid AND c.F_SMOKE_DATE=f.SMOKE_DATE  
SET c.F_SMOKING=f.SMOKING ,c.F_SMOKE_SOURCE=f.SMOKE_SOURCE,c.F_SMOKE_HOSPCODE=f.SMOKE_HOSPCODE;

UPDATE  t_cvdrisk_fl c INNER JOIN 
(SELECT cid,MAX(SMOKE_DATE) date_serv 
FROM t_cvdrisk  WHERE SMOKE_DATE BETWEEN @start_d AND @end_d
GROUP BY CID)  f ON c.cid=f.cid 
SET c.L_SMOKE_DATE=f.DATE_SERV;
UPDATE  t_cvdrisk_fl c INNER JOIN t_cvdrisk f ON c.cid=f.cid AND c.L_SMOKE_DATE=f.SMOKE_DATE  
SET c.L_SMOKING=f.SMOKING ,c.L_SMOKE_SOURCE=f.SMOKE_SOURCE,c.L_SMOKE_HOSPCODE=f.SMOKE_HOSPCODE;

UPDATE  t_cvdrisk_fl c INNER JOIN 
(SELECT cid,MIN(SBP_DATE) date_serv 
FROM t_cvdrisk  WHERE SBP_DATE  BETWEEN @start_d AND @end_d12
GROUP BY CID)  f ON c.cid=f.cid 
SET c.F_SBP_DATE=f.DATE_SERV;
UPDATE  t_cvdrisk_fl c INNER JOIN t_cvdrisk f ON c.cid=f.cid AND c.F_SBP_DATE=f.SBP_DATE  
SET c.F_SBP=f.SBP ,c.F_SBP_SOURCE=f.SBP_SOURCE,c.F_SBP_HOSPCODE=f.SBP_HOSPCODE;

UPDATE  t_cvdrisk_fl c INNER JOIN 
(SELECT cid,MAX(SBP_DATE) date_serv 
FROM t_cvdrisk  WHERE  SBP_DATE BETWEEN @start_d10 AND @end_d
GROUP BY CID)  f ON c.cid=f.cid 
SET c.L_SBP_DATE=f.DATE_SERV;
UPDATE  t_cvdrisk_fl c INNER JOIN t_cvdrisk f ON c.cid=f.cid AND c.L_SBP_DATE=f.SBP_DATE  
SET c.L_SBP=f.SBP ,c.L_SBP_SOURCE=f.SBP_SOURCE,c.L_SBP_HOSPCODE=f.SBP_HOSPCODE;

UPDATE  t_cvdrisk_fl c INNER JOIN 
(SELECT cid,MIN(CHOL_DATE) date_serv 
FROM t_cvdrisk  WHERE CHOL_DATE BETWEEN @start_d AND @end_d12
GROUP BY CID)  f ON c.cid=f.cid 
SET c.F_CHOL_DATE=f.DATE_SERV;
UPDATE  t_cvdrisk_fl c INNER JOIN t_cvdrisk f ON c.cid=f.cid AND c.F_CHOL_DATE=f.CHOL_DATE  
SET c.F_CHOL=f.CHOL ,c.F_CHOL_HOSPCODE=f.CHOL_HOSPCODE;

UPDATE  t_cvdrisk_fl c INNER JOIN 
(SELECT cid,MAX(CHOL_DATE) date_serv 
FROM t_cvdrisk  WHERE  CHOL_DATE BETWEEN @start_d10 AND @end_d
GROUP BY CID)  f ON c.cid=f.cid 
SET c.L_CHOL_DATE=f.DATE_SERV;
UPDATE  t_cvdrisk_fl c INNER JOIN t_cvdrisk f ON c.cid=f.cid AND c.L_CHOL_DATE=f.CHOL_DATE  
SET c.L_CHOL=f.CHOL ,c.L_CHOL_HOSPCODE=f.CHOL_HOSPCODE;

UPDATE  t_cvdrisk_fl c INNER JOIN 
(SELECT cid,MIN(WAIST_DATE) date_serv 
FROM t_cvdrisk  WHERE WAIST_DATE BETWEEN @start_d AND @end_d12
GROUP BY CID)  f ON c.cid=f.cid 
SET c.F_WAIST_DATE=f.DATE_SERV;
UPDATE  t_cvdrisk_fl c INNER JOIN t_cvdrisk f ON c.cid=f.cid AND c.F_WAIST_DATE=f.WAIST_DATE  
SET c.F_WAIST_CM=f.WAIST_CM ,c.F_WAIST_SOURCE=f.WAIST_SOURCE,c.F_WAIST_HOSPCODE=f.WAIST_HOSPCODE;

UPDATE  t_cvdrisk_fl c INNER JOIN 
(SELECT cid,MAX(WAIST_DATE) date_serv 
FROM t_cvdrisk  WHERE WAIST_DATE BETWEEN @start_d10 AND @end_d 
GROUP BY CID)  f ON c.cid=f.cid 
SET c.L_WAIST_DATE=f.DATE_SERV;
UPDATE  t_cvdrisk_fl c INNER JOIN t_cvdrisk f ON c.cid=f.cid AND c.L_WAIST_DATE=f.WAIST_DATE  
SET c.L_WAIST_CM=f.WAIST_CM ,c.L_WAIST_SOURCE=f.WAIST_SOURCE,c.L_WAIST_HOSPCODE=f.WAIST_HOSPCODE;

UPDATE  t_cvdrisk_fl c INNER JOIN 
(SELECT cid,MIN(HEIGHT_DATE) date_serv 
FROM t_cvdrisk  WHERE HEIGHT_DATE BETWEEN @start_d AND @end_d12
GROUP BY CID)  f ON c.cid=f.cid 
SET c.F_HEIGHT_DATE=f.DATE_SERV;
UPDATE  t_cvdrisk_fl c INNER JOIN t_cvdrisk f ON c.cid=f.cid AND c.F_HEIGHT_DATE=f.HEIGHT_DATE  
SET c.F_HEIGHT=f.HEIGHT ,c.F_HEIGHT_SOURCE=f.HEIGHT_SOURCE,c.F_HEIGHT_HOSPCODE=f.HEIGHT_HOSPCODE;

UPDATE  t_cvdrisk_fl c INNER JOIN 
(SELECT cid,MAX(HEIGHT_DATE) date_serv 
FROM t_cvdrisk  WHERE HEIGHT_DATE BETWEEN @start_d AND @end_d
GROUP BY CID)  f ON c.cid=f.cid 
SET c.L_HEIGHT_DATE=f.DATE_SERV;
UPDATE  t_cvdrisk_fl c INNER JOIN t_cvdrisk f ON c.cid=f.cid AND c.L_HEIGHT_DATE=f.HEIGHT_DATE  
SET c.L_HEIGHT=f.HEIGHT ,c.L_HEIGHT_SOURCE=f.HEIGHT_SOURCE,c.L_HEIGHT_HOSPCODE=f.HEIGHT_HOSPCODE;

UPDATE t_cvdrisk_fl SET F_RISK_SCORE=cvd_func(AGE_Y,SEX_CVD,F_SBP,DM,F_SMOKING,F_CHOL,F_WAIST_CM,F_HEIGHT)
WHERE AGE_Y >0 AND SEX_CVD is not null  AND DM is not null  AND F_SMOKING is not null  AND F_SBP >0 
AND (F_CHOL >0 OR (F_WAIST_CM >0 AND F_HEIGHT >0)) ;

UPDATE t_cvdrisk_fl SET L_RISK_SCORE=cvd_func(AGE_Y,SEX_CVD,L_SBP,DM,L_SMOKING,L_CHOL,L_WAIST_CM,L_HEIGHT) 
WHERE AGE_Y >0 AND SEX_CVD is not null  AND DM is not null  AND L_SMOKING is not null  AND L_SBP >0 
AND (L_CHOL >0 OR (L_WAIST_CM >0 AND L_HEIGHT >0)) ;

 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.3918569;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:377;a:5:{i:0;s:18289:"CREATE PROCEDURE t_cvdrisk()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '58';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'0701');
SET	@start_d10:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
SET @end_d12:=concat(@b_year-1,'1231');

DROP TABLE IF EXISTS t_cvd_ill;
CREATE TABLE IF NOT EXISTS t_cvd_ill(
 CID varchar(13) NOT NULL
 ,`BIRTH` date
 ,`SEX` varchar(1) NOT NULL
 ,source_tb VARCHAR(255) DEFAULT NULL 
 ,mix_dx VARCHAR(255) DEFAULT NULL 	
 ,date_dx VARCHAR(255) DEFAULT NULL 
 ,hosp_dx varchar(255) DEFAULT NULL 
 ,hosp_input varchar(255) DEFAULT NULL 
,PRIMARY KEY (`CID`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;
INSERT IGNORE INTO 	t_cvd_ill (
SELECT cid,birth,sex
,GROUP_CONCAT(source_tb ORDER BY date_dx)
,GROUP_CONCAT(diagcode ORDER BY date_dx)
,GROUP_CONCAT(date_dx ORDER BY date_dx)
,GROUP_CONCAT(IFNULL(hosp_dx,input_hosp) ORDER BY date_dx)
,GROUP_CONCAT(input_hosp ORDER BY date_dx)
FROM t_chronic WHERE SUBSTR(UPPER(diagcode),1,4) IN ('E105','E115','E125','E135','E145','I110','I119') 
OR SUBSTR(UPPER(diagcode),1,3) BETWEEN  'I60' AND 'I64' 
OR SUBSTR(UPPER(diagcode),1,3) IN ('I13') 
GROUP BY cid
);

DROP TABLE IF EXISTS tmp_fu_screen;
CREATE TABLE IF NOT EXISTS tmp_fu_screen(
 `HOSPCODE` varchar(5) NOT NULL,
 `CID` varchar(13) DEFAULT NULL,
 `PID` varchar(15) NOT NULL,
	`SEQ` varchar(16) NOT NULL,
 `DATE_SERV` date NOT NULL,
 `SBP` int(3) NOT NULL DEFAULT  0,
 `SBP_SOURCE` VARCHAR(20) DEFAULT NULL,
 `WAIST_CM` int(3) NOT NULL DEFAULT 0,
 `WAIST_SOURCE` VARCHAR(20) DEFAULT NULL,
 `HEIGHT` int(3) NOT NULL DEFAULT 0,
 `HEIGHT_SOURCE` VARCHAR(20) DEFAULT NULL,
 `QUARTERM` VARCHAR(1) DEFAULT NULL,
PRIMARY KEY (`HOSPCODE`,`PID`,`DATE_SERV`),
  KEY  (`HOSPCODE`,`PID`),
  KEY  (`HOSPCODE`),
  KEY  (`DATE_SERV`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO tmp_fu_screen (
SELECT  HOSPCODE,CID,PID,SEQ,DATE_SERV,SBP,'CHRONICFU',WAIST_CM,'CHRONICFU',HEIGHT,'CHRONICFU',NULL
FROM tmp_chronicfu
WHERE date_serv BETWEEN @start_d AND @end_d
);
INSERT IGNORE INTO tmp_fu_screen (
SELECT  HOSPCODE,CID,PID,SEQ,DATE_SERV,IF(SBP_2>0,SBP_2,SBP_1) SBP,'NCDSCREEN',WAIST_CM,'NCDSCREEN',HEIGHT,'NCDSCREEN',NULL
FROM tmp_ncdscreen
WHERE date_serv BETWEEN @start_d AND @end_d
);
UPDATE tmp_fu_screen SET QUARTERM=IF( DATE_SERV < concat(@b_year-1,'1001'),0,
IF(DATE_SERV BETWEEN concat(@b_year-1,'1001') AND concat(@b_year-1,'1231'),1,
IF(DATE_SERV BETWEEN concat(@b_year,'0101') AND concat(@b_year,'0331'),2,
IF(DATE_SERV BETWEEN concat(@b_year,'0401') AND concat(@b_year,'0630'),3,
IF(DATE_SERV BETWEEN concat(@b_year,'0701') AND concat(@b_year,'0930'),4,null
)))));

/*LAB TOTAL CHOL*/
DROP TABLE IF EXISTS tmz_labcvd;
CREATE TABLE IF NOT EXISTS tmz_labcvd(
 `QUARTERM` VARCHAR(1) DEFAULT NULL,
PRIMARY KEY (HOSPCODE,PID,SEQ,LABTEST),KEY (CID) ,KEY (DATE_SERV), KEY (HOSPCODE,PID,DATE_SERV)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 AS
(SELECT *,null as QUARTERM FROM tmp_labfu WHERE LABTEST in(7) AND LABRESULT >0 GROUP BY HOSPCODE,PID,SEQ,LABTEST);

UPDATE tmz_labcvd SET QUARTERM=IF( DATE_SERV < concat(@b_year-1,'1001'),0,
IF(DATE_SERV BETWEEN concat(@b_year-1,'1001') AND concat(@b_year-1,'1231'),1,
IF(DATE_SERV BETWEEN concat(@b_year,'0101') AND concat(@b_year,'0331'),2,
IF(DATE_SERV BETWEEN concat(@b_year,'0401') AND concat(@b_year,'0630'),3,
IF(DATE_SERV BETWEEN concat(@b_year,'0701') AND concat(@b_year,'0930'),4,null
)))));

/*SMOKE */
DROP TABLE IF EXISTS tmp_smoke;
CREATE TABLE IF NOT EXISTS tmp_smoke(
 `HOSPCODE` varchar(5) NOT NULL,
 `PID` varchar(15) NOT NULL,
 `CID` varchar(13) DEFAULT NULL,
 `DATE_SERV` date NOT NULL,
 `SMOKE_SOURCE`  VARCHAR(50) DEFAULT NULL,
 `RESULT` VARCHAR(1) DEFAULT NULL COMMENT '1=สูบ,0=ไม่สูบ',
 `QUARTERM` VARCHAR(1) DEFAULT NULL,
PRIMARY KEY (HOSPCODE,PID,DATE_SERV),KEY (CID) ,KEY (DATE_SERV), KEY (HOSPCODE,PID,DATE_SERV)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 ;

INSERT IGNORE INTO tmp_smoke(
SELECT HOSPCODE,PID,CID,DATE_SERV,'NCDSCREEN',IF(SMOKE=1,0,1) ,NULL 
FROM tmp_ncdscreen WHERE SMOKE in(1,2,3,4)
);
INSERT IGNORE INTO tmp_smoke(
SELECT  HOSPCODE,PID,CID,DATE_SERV,'SPECIALPP',1 ,NULL 
FROM tmp_specialpp 
WHERE SUBSTR(PPSPECIAL,1,4) IN('1B50','1B53','1B54','1B55','1B56')
);
INSERT IGNORE INTO tmp_smoke(
SELECT  HOSPCODE,PID,CID,DATE_SERV,'SPECIALPP',0 ,NULL 
FROM tmp_specialpp WHERE PPSPECIAL in('1B51','1B52') 
);
UPDATE tmp_smoke SET QUARTERM=IF( DATE_SERV < concat(@b_year-1,'1001'),0,
IF(DATE_SERV BETWEEN concat(@b_year-1,'1001') AND concat(@b_year-1,'1231'),1,
IF(DATE_SERV BETWEEN concat(@b_year,'0101') AND concat(@b_year,'0331'),2,
IF(DATE_SERV BETWEEN concat(@b_year,'0401') AND concat(@b_year,'0630'),3,
IF(DATE_SERV BETWEEN concat(@b_year,'0701') AND concat(@b_year,'0930'),4,null
)))));

/*T_CVD*/
DROP TABLE IF EXISTS t_cvdrisk;
CREATE TABLE IF NOT EXISTS t_cvdrisk(
 `CID` varchar(13) DEFAULT NULL
 ,`BIRTH` date
 ,`SEX` varchar(1) NOT NULL
 ,`TYPEAREA` varchar(1) NOT NULL
 ,`nation` varchar(3) DEFAULT NULL
,source_tb VARCHAR(255) DEFAULT NULL 
 ,mix_dx VARCHAR(255) DEFAULT NULL 	
 ,t_mix_dx VARCHAR(255) DEFAULT NULL 	
 ,type_dx VARCHAR(2) DEFAULT NULL 
 ,date_dx VARCHAR(255) DEFAULT NULL 
 ,hosp_dx varchar(255) DEFAULT NULL 
	,`AGE_Y` int(3) NOT NULL DEFAULT '0' 
	,`SEX_CVD` varchar(1) DEFAULT NULL
 ,`QUARTERM` VARCHAR(1) DEFAULT NULL
 ,`SMOKING` varchar(1) DEFAULT NULL
 ,`SMOKE_DATE` date DEFAULT NULL
 ,`SMOKE_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`SMOKE_SOURCE` VARCHAR(20) DEFAULT NULL
 ,`DM` varchar(1) DEFAULT NULL
 ,`SBP` int(3) NOT NULL DEFAULT  0
 ,`SBP_DATE` date DEFAULT NULL
 ,`SBP_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`SBP_SOURCE` VARCHAR(20) DEFAULT NULL
 ,`CHOL` double(6,2) NOT NULL DEFAULT 0
 ,`CHOL_DATE` date DEFAULT NULL
 ,`CHOL_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`WAIST_CM` int(3) NOT NULL DEFAULT 0
 ,`WAIST_DATE` date DEFAULT NULL
 ,`WAIST_HOSPCODE` VARCHAR(5) DEFAULT NULL
  ,`WAIST_SOURCE` VARCHAR(20) DEFAULT NULL
 ,`HEIGHT` int(3) NOT NULL DEFAULT 0
 ,`HEIGHT_DATE` date DEFAULT NULL
 ,`HEIGHT_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`HEIGHT_SOURCE` VARCHAR(20) DEFAULT NULL
 ,`RISK_SCORE` DECIMAL(5,2) NOT NULL DEFAULT 0.00
,PRIMARY KEY (`CID`, `QUARTERM` )
	,KEY  (`CID`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

SET @x=0;
SET @max= 5;
WHILE @x<@max DO
INSERT IGNORE INTO t_cvdrisk(
	cid,birth,sex,typearea,age_y,nation,source_tb,hosp_dx,mix_dx,t_mix_dx,date_dx,QUARTERM
)
(
	SELECT SQL_BIG_RESULT 
			p.cid,p.birth,p.sex,p.typearea, p.age_y,p.nation
			,GROUP_CONCAT(c.source_tb order by date_dx) source_tb
			,GROUP_CONCAT(hosp_dx order by date_dx) hosp_dx
			,GROUP_CONCAT(diagcode order by date_dx ) diagcode
			,GROUP_CONCAT(DISTINCT  substr(diagcode,1,1) order by  substr(diagcode,1,1) ) 
			,GROUP_CONCAT(date_dx order by date_dx) date_dx
			,@x
FROM
(SELECT c.* FROM t_chronic c LEFT JOIN t_cvd_ill i ON c.cid=i.cid
WHERE  (SUBSTR(UPPER(c.diagcode),1,3) BETWEEN  'E10' and 'E14'  OR 	SUBSTR(UPPER(c.diagcode),1,3) BETWEEN  'I10' and 'I15')  
AND ISNULL(i.cid)
GROUP BY concat(c.cid,'-',c.diagcode) ) c 
INNER JOIN t_person_cid  p ON c.cid = p.cid
WHERE p.nation in(99) AND p.DISCHARGE in(9) AND c.typedisch NOT in(2)
GROUP BY p.cid
);

SET  @x = @x + 1; 
END WHILE;
/*up_mixdiag*/
UPDATE t_cvdrisk 
	SET type_dx = if(t_mix_dx ='I' ,'01'  
							,if(t_mix_dx ='E' ,'02'
							,if(t_mix_dx ='E,I','03',NULL)));
/*up sex cvd*/
UPDATE t_cvdrisk SET SEX_CVD = IF(SEX=2,0,1);
/*up DM*/
UPDATE  t_cvdrisk SET DM=IF(type_dx in(2,3),1,0);
/*dele QUARTER BEFORE date_dx*/
DELETE FROM t_cvdrisk 
WHERE DATE_FORMAT(SUBSTR(date_dx,1,10),'%Y%m') > DATE_FORMAT(concat(@b_year,'0630'),'%Y%m')
AND QUARTERM < 4;

DELETE FROM t_cvdrisk 
WHERE DATE_FORMAT(SUBSTR(date_dx,1,10),'%Y%m') > DATE_FORMAT(concat(@b_year,'0331'),'%Y%m')
AND QUARTERM < 3;

DELETE FROM t_cvdrisk 
WHERE DATE_FORMAT(SUBSTR(date_dx,1,10),'%Y%m') > DATE_FORMAT(concat((@b_year-1),'1231'),'%Y%m')
AND QUARTERM < 2;

DELETE FROM t_cvdrisk 
WHERE DATE_FORMAT(SUBSTR(date_dx,1,10),'%Y%m') > DATE_FORMAT(concat((@b_year-1),'0930'),'%Y%m')
AND QUARTERM < 1;

/*last date sbp*/
SET @x=0;
SET @max= 5;
WHILE @x<@max DO
UPDATE  t_cvdrisk c INNER JOIN 
(SELECT cid,MAX(DATE_SERV) date_serv 
FROM tmp_fu_screen  WHERE SBP BETWEEN 50 AND 300 AND QUARTERM in(@x) GROUP BY CID)  f ON c.cid=f.cid 
SET c.SBP_DATE=f.DATE_SERV WHERE c.QUARTERM in(@x);
SET  @x = @x + 1; 
END WHILE;
/*up last sbp*/
UPDATE  t_cvdrisk c INNER JOIN tmp_fu_screen f ON c.cid=f.cid AND c.SBP_DATE=f.DATE_SERV  
SET c.SBP=f.SBP ,c.SBP_SOURCE=f.SBP_SOURCE,c.SBP_HOSPCODE=f.HOSPCODE
WHERE f.SBP BETWEEN 50 AND 300 ;
/*last date height*/
SET @x=0;
SET @max= 5;
WHILE @x<@max DO
UPDATE  t_cvdrisk c INNER JOIN 
(SELECT cid,MAX(DATE_SERV) date_serv 
FROM tmp_fu_screen  WHERE HEIGHT BETWEEN 90 AND 300 AND QUARTERM in(@x) GROUP BY CID)  f ON c.cid=f.cid 
SET c.HEIGHT_DATE=f.DATE_SERV WHERE c.QUARTERM in(@x);
SET  @x = @x + 1; 
END WHILE;
/*up last height*/
UPDATE  t_cvdrisk c INNER JOIN tmp_fu_screen f ON c.cid=f.cid AND c.HEIGHT_DATE=f.DATE_SERV  
SET c.HEIGHT=f.HEIGHT ,c.HEIGHT_SOURCE=f.HEIGHT_SOURCE,c.HEIGHT_HOSPCODE=f.HOSPCODE
WHERE f.HEIGHT BETWEEN 90 AND 300 ;
/*last date waist*/
SET @x=0;
SET @max= 5;
WHILE @x<@max DO
UPDATE  t_cvdrisk c INNER JOIN 
(SELECT cid,MAX(DATE_SERV) date_serv 
FROM tmp_fu_screen  WHERE WAIST_CM  BETWEEN 40 AND 300 AND QUARTERM in(@x) GROUP BY CID)  f ON c.cid=f.cid 
SET c.WAIST_DATE=f.DATE_SERV WHERE c.QUARTERM in(@x);
SET  @x = @x + 1; 
END WHILE;
/*up last waist*/
UPDATE  t_cvdrisk c INNER JOIN tmp_fu_screen f ON c.cid=f.cid AND c.WAIST_DATE=f.DATE_SERV  
SET c.WAIST_CM=f.WAIST_CM ,c.WAIST_SOURCE=f.WAIST_SOURCE,c.WAIST_HOSPCODE=f.HOSPCODE
WHERE f.WAIST_CM  BETWEEN 40 AND 300 ;

/*last date CHOL*/
SET @x=0;
SET @max= 5;
WHILE @x<@max DO
UPDATE  t_cvdrisk c INNER JOIN 
(SELECT cid,MAX(DATE_SERV) date_serv 
FROM tmz_labcvd  WHERE  QUARTERM in(@x) GROUP BY CID)  f ON c.cid=f.cid 
SET c.CHOL_DATE=f.DATE_SERV WHERE c.QUARTERM in(@x);
SET  @x = @x + 1; 
END WHILE;
/*up last CHOL*/
UPDATE  t_cvdrisk c INNER JOIN tmz_labcvd f ON c.cid=f.cid AND c.CHOL_DATE=f.DATE_SERV  
SET c.CHOL=f.labresult ,c.CHOL_HOSPCODE=f.HOSPCODE;

/*SMOKE*/
UPDATE t_cvdrisk c INNER JOIN (
SELECT cid,RESULT,SMOKE_SOURCE ,HOSPCODE,DATE_SERV
FROM tmp_smoke WHERE DATE_SERV BETWEEN @start_d AND @end_d AND RESULT IN(1)
GROUP BY cid
) f ON c.cid=f.cid
SET c.SMOKE_DATE=f.DATE_SERV,c.SMOKING=f.RESULT ,c.SMOKE_SOURCE=f.SMOKE_SOURCE,c.SMOKE_HOSPCODE=f.HOSPCODE;

UPDATE t_cvdrisk c INNER JOIN (
SELECT cid,RESULT,SMOKE_SOURCE ,HOSPCODE,DATE_SERV
FROM tmp_smoke WHERE DATE_SERV BETWEEN @start_d AND @end_d AND RESULT IN(0)
GROUP BY cid
) f ON c.cid=f.cid
SET c.SMOKE_DATE=f.DATE_SERV,c.SMOKING=f.RESULT ,c.SMOKE_SOURCE=f.SMOKE_SOURCE,c.SMOKE_HOSPCODE=f.HOSPCODE
WHERE ISNULL(c.SMOKING);

/*calc*/
UPDATE t_cvdrisk SET RISK_SCORE=cvd_func(AGE_Y,SEX_CVD,SBP,DM,SMOKING,CHOL,WAIST_CM,HEIGHT)
WHERE AGE_Y >0 AND SEX_CVD is not null  AND DM is not null  AND SMOKING is not null  AND SBP >0 
AND (CHOL >0 OR (WAIST_CM >0 AND HEIGHT >0)) ;

DROP TABLE IF EXISTS t_cvdrisk_fl;
CREATE TABLE IF NOT EXISTS t_cvdrisk_fl(
 `CID` varchar(13) DEFAULT NULL
 ,`BIRTH` date
 ,`SEX` varchar(1) NOT NULL
 ,`TYPEAREA` varchar(1) NOT NULL
 ,`nation` varchar(3) DEFAULT NULL
 ,source_tb VARCHAR(255) DEFAULT NULL 
 ,mix_dx VARCHAR(255) DEFAULT NULL 	
 ,t_mix_dx VARCHAR(255) DEFAULT NULL 	
 ,type_dx VARCHAR(2) DEFAULT NULL 
 ,date_dx VARCHAR(255) DEFAULT NULL 
 ,hosp_dx varchar(255) DEFAULT NULL 
	,`AGE_Y` int(3) NOT NULL DEFAULT '0' 
	,`SEX_CVD` varchar(1) DEFAULT NULL
,`DM` varchar(1) DEFAULT NULL
 ,`F_SMOKING` varchar(1) DEFAULT NULL
 ,`F_SMOKE_DATE` date DEFAULT NULL
 ,`F_SMOKE_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`F_SMOKE_SOURCE` VARCHAR(20) DEFAULT NULL
 ,`L_SMOKING` varchar(1) DEFAULT NULL
 ,`L_SMOKE_DATE` date DEFAULT NULL
 ,`L_SMOKE_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`L_SMOKE_SOURCE` VARCHAR(20) DEFAULT NULL
 ,`F_SBP` int(3) NOT NULL DEFAULT  0
 ,`F_SBP_DATE` date DEFAULT NULL
 ,`F_SBP_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`F_SBP_SOURCE` VARCHAR(20) DEFAULT NULL
 ,`L_SBP` int(3) NOT NULL DEFAULT  0
 ,`L_SBP_DATE` date DEFAULT NULL
 ,`L_SBP_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`L_SBP_SOURCE` VARCHAR(20) DEFAULT NULL
 ,`F_CHOL` double(6,2) NOT NULL DEFAULT 0
 ,`F_CHOL_DATE` date DEFAULT NULL
 ,`F_CHOL_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`L_CHOL` double(6,2) NOT NULL DEFAULT 0
 ,`L_CHOL_DATE` date DEFAULT NULL
 ,`L_CHOL_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`F_WAIST_CM` int(3) NOT NULL DEFAULT 0
 ,`F_WAIST_DATE` date DEFAULT NULL
 ,`F_WAIST_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`F_WAIST_SOURCE` VARCHAR(20) DEFAULT NULL
,`L_WAIST_CM` int(3) NOT NULL DEFAULT 0
 ,`L_WAIST_DATE` date DEFAULT NULL
 ,`L_WAIST_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`L_WAIST_SOURCE` VARCHAR(20) DEFAULT NULL
 ,`F_HEIGHT` int(3) NOT NULL DEFAULT 0
 ,`F_HEIGHT_DATE` date DEFAULT NULL
 ,`F_HEIGHT_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`F_HEIGHT_SOURCE` VARCHAR(20) DEFAULT NULL
 ,`L_HEIGHT` int(3) NOT NULL DEFAULT 0
 ,`L_HEIGHT_DATE` date DEFAULT NULL
 ,`L_HEIGHT_HOSPCODE` VARCHAR(5) DEFAULT NULL
 ,`L_HEIGHT_SOURCE` VARCHAR(20) DEFAULT NULL
 ,`F_RISK_SCORE` DECIMAL(5,2) NOT NULL DEFAULT 0.00
 ,`L_RISK_SCORE` DECIMAL(5,2) NOT NULL DEFAULT 0.00
,PRIMARY KEY (`CID`)
	,KEY  (`CID`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;
INSERT IGNORE INTO t_cvdrisk_fl (cid,birth,sex,typearea,age_y,nation,source_tb,hosp_dx,mix_dx,t_mix_dx,date_dx,dm,sex_cvd,type_dx)
(
SELECT cid,birth,sex,typearea,age_y,nation,source_tb,hosp_dx,mix_dx,t_mix_dx,date_dx,dm,sex_cvd,type_dx
FROM t_cvdrisk 
);

UPDATE  t_cvdrisk_fl c INNER JOIN 
(SELECT cid,MIN(SMOKE_DATE) date_serv 
FROM t_cvdrisk  WHERE SMOKE_DATE BETWEEN @start_d AND @end_d
 GROUP BY CID)  f ON c.cid=f.cid 
SET c.F_SMOKE_DATE=f.DATE_SERV;
UPDATE  t_cvdrisk_fl c INNER JOIN t_cvdrisk f ON c.cid=f.cid AND c.F_SMOKE_DATE=f.SMOKE_DATE  
SET c.F_SMOKING=f.SMOKING ,c.F_SMOKE_SOURCE=f.SMOKE_SOURCE,c.F_SMOKE_HOSPCODE=f.SMOKE_HOSPCODE;

UPDATE  t_cvdrisk_fl c INNER JOIN 
(SELECT cid,MAX(SMOKE_DATE) date_serv 
FROM t_cvdrisk  WHERE SMOKE_DATE BETWEEN @start_d AND @end_d
GROUP BY CID)  f ON c.cid=f.cid 
SET c.L_SMOKE_DATE=f.DATE_SERV;
UPDATE  t_cvdrisk_fl c INNER JOIN t_cvdrisk f ON c.cid=f.cid AND c.L_SMOKE_DATE=f.SMOKE_DATE  
SET c.L_SMOKING=f.SMOKING ,c.L_SMOKE_SOURCE=f.SMOKE_SOURCE,c.L_SMOKE_HOSPCODE=f.SMOKE_HOSPCODE;

UPDATE  t_cvdrisk_fl c INNER JOIN 
(SELECT cid,MIN(SBP_DATE) date_serv 
FROM t_cvdrisk  WHERE SBP_DATE  BETWEEN @start_d AND @end_d12
GROUP BY CID)  f ON c.cid=f.cid 
SET c.F_SBP_DATE=f.DATE_SERV;
UPDATE  t_cvdrisk_fl c INNER JOIN t_cvdrisk f ON c.cid=f.cid AND c.F_SBP_DATE=f.SBP_DATE  
SET c.F_SBP=f.SBP ,c.F_SBP_SOURCE=f.SBP_SOURCE,c.F_SBP_HOSPCODE=f.SBP_HOSPCODE;

UPDATE  t_cvdrisk_fl c INNER JOIN 
(SELECT cid,MAX(SBP_DATE) date_serv 
FROM t_cvdrisk  WHERE  SBP_DATE BETWEEN @start_d10 AND @end_d
GROUP BY CID)  f ON c.cid=f.cid 
SET c.L_SBP_DATE=f.DATE_SERV;
UPDATE  t_cvdrisk_fl c INNER JOIN t_cvdrisk f ON c.cid=f.cid AND c.L_SBP_DATE=f.SBP_DATE  
SET c.L_SBP=f.SBP ,c.L_SBP_SOURCE=f.SBP_SOURCE,c.L_SBP_HOSPCODE=f.SBP_HOSPCODE;

UPDATE  t_cvdrisk_fl c INNER JOIN 
(SELECT cid,MIN(CHOL_DATE) date_serv 
FROM t_cvdrisk  WHERE CHOL_DATE BETWEEN @start_d AND @end_d12
GROUP BY CID)  f ON c.cid=f.cid 
SET c.F_CHOL_DATE=f.DATE_SERV;
UPDATE  t_cvdrisk_fl c INNER JOIN t_cvdrisk f ON c.cid=f.cid AND c.F_CHOL_DATE=f.CHOL_DATE  
SET c.F_CHOL=f.CHOL ,c.F_CHOL_HOSPCODE=f.CHOL_HOSPCODE;

UPDATE  t_cvdrisk_fl c INNER JOIN 
(SELECT cid,MAX(CHOL_DATE) date_serv 
FROM t_cvdrisk  WHERE  CHOL_DATE BETWEEN @start_d10 AND @end_d
GROUP BY CID)  f ON c.cid=f.cid 
SET c.L_CHOL_DATE=f.DATE_SERV;
UPDATE  t_cvdrisk_fl c INNER JOIN t_cvdrisk f ON c.cid=f.cid AND c.L_CHOL_DATE=f.CHOL_DATE  
SET c.L_CHOL=f.CHOL ,c.L_CHOL_HOSPCODE=f.CHOL_HOSPCODE;

UPDATE  t_cvdrisk_fl c INNER JOIN 
(SELECT cid,MIN(WAIST_DATE) date_serv 
FROM t_cvdrisk  WHERE WAIST_DATE BETWEEN @start_d AND @end_d12
GROUP BY CID)  f ON c.cid=f.cid 
SET c.F_WAIST_DATE=f.DATE_SERV;
UPDATE  t_cvdrisk_fl c INNER JOIN t_cvdrisk f ON c.cid=f.cid AND c.F_WAIST_DATE=f.WAIST_DATE  
SET c.F_WAIST_CM=f.WAIST_CM ,c.F_WAIST_SOURCE=f.WAIST_SOURCE,c.F_WAIST_HOSPCODE=f.WAIST_HOSPCODE;

UPDATE  t_cvdrisk_fl c INNER JOIN 
(SELECT cid,MAX(WAIST_DATE) date_serv 
FROM t_cvdrisk  WHERE WAIST_DATE BETWEEN @start_d10 AND @end_d 
GROUP BY CID)  f ON c.cid=f.cid 
SET c.L_WAIST_DATE=f.DATE_SERV;
UPDATE  t_cvdrisk_fl c INNER JOIN t_cvdrisk f ON c.cid=f.cid AND c.L_WAIST_DATE=f.WAIST_DATE  
SET c.L_WAIST_CM=f.WAIST_CM ,c.L_WAIST_SOURCE=f.WAIST_SOURCE,c.L_WAIST_HOSPCODE=f.WAIST_HOSPCODE;

UPDATE  t_cvdrisk_fl c INNER JOIN 
(SELECT cid,MIN(HEIGHT_DATE) date_serv 
FROM t_cvdrisk  WHERE HEIGHT_DATE BETWEEN @start_d AND @end_d12
GROUP BY CID)  f ON c.cid=f.cid 
SET c.F_HEIGHT_DATE=f.DATE_SERV;
UPDATE  t_cvdrisk_fl c INNER JOIN t_cvdrisk f ON c.cid=f.cid AND c.F_HEIGHT_DATE=f.HEIGHT_DATE  
SET c.F_HEIGHT=f.HEIGHT ,c.F_HEIGHT_SOURCE=f.HEIGHT_SOURCE,c.F_HEIGHT_HOSPCODE=f.HEIGHT_HOSPCODE;

UPDATE  t_cvdrisk_fl c INNER JOIN 
(SELECT cid,MAX(HEIGHT_DATE) date_serv 
FROM t_cvdrisk  WHERE HEIGHT_DATE BETWEEN @start_d AND @end_d
GROUP BY CID)  f ON c.cid=f.cid 
SET c.L_HEIGHT_DATE=f.DATE_SERV;
UPDATE  t_cvdrisk_fl c INNER JOIN t_cvdrisk f ON c.cid=f.cid AND c.L_HEIGHT_DATE=f.HEIGHT_DATE  
SET c.L_HEIGHT=f.HEIGHT ,c.L_HEIGHT_SOURCE=f.HEIGHT_SOURCE,c.L_HEIGHT_HOSPCODE=f.HEIGHT_HOSPCODE;

UPDATE t_cvdrisk_fl SET F_RISK_SCORE=cvd_func(AGE_Y,SEX_CVD,F_SBP,DM,F_SMOKING,F_CHOL,F_WAIST_CM,F_HEIGHT)
WHERE AGE_Y >0 AND SEX_CVD is not null  AND DM is not null  AND F_SMOKING is not null  AND F_SBP >0 
AND (F_CHOL >0 OR (F_WAIST_CM >0 AND F_HEIGHT >0)) ;

UPDATE t_cvdrisk_fl SET L_RISK_SCORE=cvd_func(AGE_Y,SEX_CVD,L_SBP,DM,L_SMOKING,L_CHOL,L_WAIST_CM,L_HEIGHT) 
WHERE AGE_Y >0 AND SEX_CVD is not null  AND DM is not null  AND L_SMOKING is not null  AND L_SBP >0 
AND (L_CHOL >0 OR (L_WAIST_CM >0 AND L_HEIGHT >0)) ;

 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.454257;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:379;a:5:{i:0;s:38:"DROP PROCEDURE IF EXISTS t_screen_last";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.454257;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:380;a:5:{i:0;s:38:"DROP PROCEDURE IF EXISTS t_screen_last";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.5166571;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:382;a:5:{i:0;s:1902:"CREATE PROCEDURE t_screen_last()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '59';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS t_screen_last;
CREATE TABLE IF NOT EXISTS t_screen_last(
 `HOSPCODE` varchar(5) NOT NULL,
 `CID` varchar(13) DEFAULT NULL,
 `PID` varchar(15) NOT NULL,
	`SEQ` varchar(16) NOT NULL,
 `DATE_SERV` date NOT NULL,
 `WAIST_CM` int(3) NOT NULL DEFAULT 0,
	weight decimal(5,1) NOT NULL DEFAULT '0',
 `HEIGHT` int(3) NOT NULL DEFAULT 0,
  `SMOKE` varchar(1) DEFAULT NULL,
  `ALCOHOL` varchar(1) DEFAULT NULL,
 `SBP_1` int(3) NOT NULL,
  `DBP_1` int(3) NOT NULL,
  `SBP_2` int(3) DEFAULT NULL,
  `DBP_2` int(3) DEFAULT NULL,
  `BSLEVEL` int(6) DEFAULT NULL,
  `BSTEST` char(1) DEFAULT NULL,
  `SCREENPLACE` varchar(5) DEFAULT NULL,
 `QUARTERM` VARCHAR(1) DEFAULT NULL,
	bmi decimal(10,1) NOT NULL DEFAULT '0',
PRIMARY KEY (`HOSPCODE`,`PID`,`QUARTERM`),
  KEY  (`HOSPCODE`,`PID`),
  KEY  (`HOSPCODE`),
  KEY  (`DATE_SERV`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;


INSERT IGNORE INTO t_screen_last (
SELECT  
HOSPCODE,CID,PID,SEQ,DATE_SERV,WAIST_CM,WEIGHT,HEIGHT,SMOKE,ALCOHOL,SBP_1,DBP_1,SBP_2,DBP_2,BSLEVEL,BSTEST,SCREENPLACE
,IF( DATE_SERV < concat(@b_year-1,'1001'),0,
IF(DATE_SERV BETWEEN concat(@b_year-1,'1001') AND concat(@b_year-1,'1231'),1,
IF(DATE_SERV BETWEEN concat(@b_year,'0101') AND concat(@b_year,'0331'),2,
IF(DATE_SERV BETWEEN concat(@b_year,'0401') AND concat(@b_year,'0630'),3,
IF(DATE_SERV BETWEEN concat(@b_year,'0701') AND concat(@b_year,'0930'),4,null
))))),0
FROM tmp_ncdscreen
WHERE date_serv BETWEEN @start_d AND @end_d
ORDER BY DATE_SERV DESC
);
UPDATE t_screen_last SET  BMI= IFNULL(round(weight/((height/100)*(height/100)),2),0)
WHERE weight BETWEEN 10 AND 300 AND height BETWEEN 30 AND 250;

 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.5166571;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:383;a:5:{i:0;s:1902:"CREATE PROCEDURE t_screen_last()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '59';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS t_screen_last;
CREATE TABLE IF NOT EXISTS t_screen_last(
 `HOSPCODE` varchar(5) NOT NULL,
 `CID` varchar(13) DEFAULT NULL,
 `PID` varchar(15) NOT NULL,
	`SEQ` varchar(16) NOT NULL,
 `DATE_SERV` date NOT NULL,
 `WAIST_CM` int(3) NOT NULL DEFAULT 0,
	weight decimal(5,1) NOT NULL DEFAULT '0',
 `HEIGHT` int(3) NOT NULL DEFAULT 0,
  `SMOKE` varchar(1) DEFAULT NULL,
  `ALCOHOL` varchar(1) DEFAULT NULL,
 `SBP_1` int(3) NOT NULL,
  `DBP_1` int(3) NOT NULL,
  `SBP_2` int(3) DEFAULT NULL,
  `DBP_2` int(3) DEFAULT NULL,
  `BSLEVEL` int(6) DEFAULT NULL,
  `BSTEST` char(1) DEFAULT NULL,
  `SCREENPLACE` varchar(5) DEFAULT NULL,
 `QUARTERM` VARCHAR(1) DEFAULT NULL,
	bmi decimal(10,1) NOT NULL DEFAULT '0',
PRIMARY KEY (`HOSPCODE`,`PID`,`QUARTERM`),
  KEY  (`HOSPCODE`,`PID`),
  KEY  (`HOSPCODE`),
  KEY  (`DATE_SERV`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;


INSERT IGNORE INTO t_screen_last (
SELECT  
HOSPCODE,CID,PID,SEQ,DATE_SERV,WAIST_CM,WEIGHT,HEIGHT,SMOKE,ALCOHOL,SBP_1,DBP_1,SBP_2,DBP_2,BSLEVEL,BSTEST,SCREENPLACE
,IF( DATE_SERV < concat(@b_year-1,'1001'),0,
IF(DATE_SERV BETWEEN concat(@b_year-1,'1001') AND concat(@b_year-1,'1231'),1,
IF(DATE_SERV BETWEEN concat(@b_year,'0101') AND concat(@b_year,'0331'),2,
IF(DATE_SERV BETWEEN concat(@b_year,'0401') AND concat(@b_year,'0630'),3,
IF(DATE_SERV BETWEEN concat(@b_year,'0701') AND concat(@b_year,'0930'),4,null
))))),0
FROM tmp_ncdscreen
WHERE date_serv BETWEEN @start_d AND @end_d
ORDER BY DATE_SERV DESC
);
UPDATE t_screen_last SET  BMI= IFNULL(round(weight/((height/100)*(height/100)),2),0)
WHERE weight BETWEEN 10 AND 300 AND height BETWEEN 30 AND 250;

 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.5790579;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:385;a:5:{i:0;s:30:"DROP PROCEDURE IF EXISTS t_adl";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.5790579;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:386;a:5:{i:0;s:30:"DROP PROCEDURE IF EXISTS t_adl";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.641458;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:388;a:5:{i:0;s:9324:"CREATE PROCEDURE t_adl()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '60';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
/*ประวัติการรับบริการตรวจ ADL ประชากรทุกคนไม่เฉพาะในเขต*/
#DROP TABLE IF EXISTS t_adl_last_regist;
CREATE TABLE IF NOT EXISTS t_adl_last_regist(
 `CID` varchar(13) DEFAULT NULL,
 `DATE_SERV` date DEFAULT NULL,
 `PPSPECIAL` VARCHAR(6) DEFAULT NULL,
  `PPSPLACE` VARCHAR(5) DEFAULT NULL,	
PRIMARY KEY (`CID`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

REPLACE INTO t_adl_last_regist 
(SELECT CID,NULL,NULL,NULL
FROM
tmp_specialpp 
WHERE LENGTH(cid)=13 AND PPSPECIAL IN('1B1280','1B1281','1B1282') 
GROUP BY CID
);

UPDATE t_adl_last_regist  t INNER JOIN
(
SELECT s1.hospcode,s1.CID,s1.DATE_SERV,s1.PPSPECIAL,s1.PPSPLACE
FROM tmp_specialpp s1 INNER JOIN tmp_specialpp s2 ON s1.CID=s2.CID AND s2.DATE_SERV >= s1.DATE_SERV
WHERE s1.PPSPECIAL  IN('1B1280','1B1281','1B1282') AND s2.PPSPECIAL  IN('1B1280','1B1281','1B1282')
		AND s1.DATE_SERV BETWEEN @start_d AND @end_d
		AND s2.DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY s1.CID,s1.DATE_SERV
HAVING COUNT(*) = 1
) s ON t.cid = s.cid AND s.date_serv BETWEEN @start_d AND @end_d
SET t.DATE_SERV = s.date_serv , t.PPSPECIAL= s.PPSPECIAL
, t.PPSPLACE=IF(ISNULL(s.PPSPLACE) OR LENGTH(s.PPSPLACE) !=5 ,s.hospcode,s.PPSPLACE);

/*ประวัติการรับบริการตรวจ ADL ประชากรทุกคนเฉพาะในเขตและผลครั้งสุดท้ายของรอบนั้นๆ*/
DROP TABLE IF EXISTS t_adl;
CREATE TABLE IF NOT EXISTS t_adl(
 `HOSPCODE` varchar(5) NOT NULL,
 `CID` varchar(13) DEFAULT NULL,
 `PID` varchar(15) NOT NULL,
 `BIRTH` DATE,
 `AGE_Y` varchar(3) DEFAULT '0',
 `TYPEAREA` varchar(1) DEFAULT NULL,
 `DATE_SERV1` date DEFAULT NULL,
 `PPSPECIAL1` VARCHAR(6) DEFAULT NULL,
  `PP_HOSP1` VARCHAR(5) DEFAULT NULL,	
 `DATE_SERV2` date DEFAULT NULL,
 `PPSPECIAL2` VARCHAR(6) DEFAULT NULL,
  `PP_HOSP2` VARCHAR(5) DEFAULT NULL,	
PRIMARY KEY (`CID`),
  KEY  (`HOSPCODE`,`PID`),
  KEY  (`HOSPCODE`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO t_adl (HOSPCODE,CID,PID,BIRTH,AGE_Y,TYPEAREA)
(
SELECT check_hosp,CID,PID,BIRTH,AGE_Y,check_typearea 
FROM t_person_cid 
WHERE LENGTH(cid)=13  AND check_typearea in(1,3) AND NATION in(99) AND age_y >=60 AND age_y < 200 AND DISCHARGE in(9)
);
/*max date_serv1*/
UPDATE t_adl t INNER JOIN
(SELECT s1.hospcode,s1.CID,s1.DATE_SERV,s1.PPSPECIAL
FROM tmp_specialpp s1 INNER JOIN tmp_specialpp s2 ON s1.CID=s2.CID AND s2.DATE_SERV >= s1.DATE_SERV
WHERE s1.PPSPECIAL  IN('1B1280','1B1281','1B1282') AND s2.PPSPECIAL  IN('1B1280','1B1281','1B1282')
		AND s1.DATE_SERV BETWEEN  CONCAT(@b_year-1,'1001') AND CONCAT(@b_year,'0331') 
		AND s2.DATE_SERV BETWEEN  CONCAT(@b_year-1,'1001') AND CONCAT(@b_year,'0331') 
GROUP BY s1.CID,s1.DATE_SERV
HAVING COUNT(*) = 1
)
s ON t.cid=s.cid SET t.DATE_SERV1=s.date_serv ,t.PPSPECIAL1=s.PPSPECIAL ,t.PP_HOSP1=s.hospcode;

UPDATE t_adl t INNER JOIN
(SELECT s1.hospcode,s1.CID,s1.DATE_SERV,s1.PPSPECIAL
FROM tmp_specialpp s1 INNER JOIN tmp_specialpp s2 ON s1.CID=s2.CID AND s2.DATE_SERV >= s1.DATE_SERV
WHERE s1.PPSPECIAL  IN('1B1280','1B1281','1B1282') AND s2.PPSPECIAL  IN('1B1280','1B1281','1B1282')
		AND s1.DATE_SERV BETWEEN   CONCAT(@b_year,'0401') AND CONCAT(@b_year,'0930') 
		AND s2.DATE_SERV BETWEEN   CONCAT(@b_year,'0401') AND CONCAT(@b_year,'0930')  
GROUP BY s1.CID,s1.DATE_SERV
HAVING COUNT(*) = 1
)
s ON t.cid=s.cid SET t.DATE_SERV2=s.date_serv ,t.PPSPECIAL2=s.PPSPECIAL ,t.PP_HOSP2=s.hospcode;

DROP  TABLE IF EXISTS t_aged;
CREATE  TABLE IF NOT EXISTS t_aged(
  `HOSPCODE` varchar(5) NOT NULL,
  `PID` varchar(15) NOT NULL,
  `CID` varchar(13) NOT NULL,
  `SEX` varchar(1) NOT NULL ,
  `BIRTH` date  DEFAULT NULL,
	`NATION` varchar(3)  DEFAULT NULL,
	`DISCHARGE` varchar(1) DEFAULT NULL,
	`TYPEAREA` varchar(1)  DEFAULT NULL,
	`AGE_Y` int(3) DEFAULT NULL,
	`VHID` varchar(8) DEFAULT NULL,
	 ht_date DATE,
	 ht_risk int(1) DEFAULT NULL,
	 dm_date DATE DEFAULT NULL,
	 dm_risk int(1) DEFAULT NULL,
	 cvd_score decimal(5,2) NOT NULL DEFAULT '0.00',
	 dent_date DATE DEFAULT NULL,
	 dent_code varchar(6) DEFAULT NULL,
	 amt_date DATE DEFAULT NULL,
	 amt_code varchar(6) DEFAULT NULL,
	 2q_date DATE DEFAULT NULL,
	 2q_code varchar(6) DEFAULT NULL,
	 knee_date DATE DEFAULT NULL,
	 knee_code varchar(6) DEFAULT NULL,
	 fall_date DATE DEFAULT NULL,
	 fall_code varchar(6) DEFAULT NULL,
	 adl_date DATE DEFAULT NULL,
	 adl_code varchar(6) DEFAULT NULL,
	 bmi_date DATE DEFAULT NULL,
	 bmi decimal(5,2) NOT NULL DEFAULT '0.00',
		PRIMARY KEY (cid),
		KEY (cid),
		KEY (hospcode,pid)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;
INSERT IGNORE INTO t_aged (hospcode,pid,cid,sex,birth,nation,discharge,typearea,age_y,vhid)
SELECT
check_hosp,pid,cid , sex,birth ,nation,discharge, check_typearea,age_y ,check_vhid
FROM t_person_cid p  
WHERE  p.check_typearea in(1,3) AND p.NATION in(99) AND p.DISCHARGE in(9) AND LENGTH(TRIM(p.CID)) = 13
AND p.age_y >= 60 AND p.age_y < 200;
/**ht**/
UPDATE t_aged t INNER JOIN t_person_ht_screen s ON t.cid = s.cid AND s.date_screen BETWEEN @start_d AND @end_d
SET t.ht_date = s.date_screen , t.ht_risk= s.risk;
/**dm**/
UPDATE t_aged t INNER JOIN t_person_dm_screen s ON t.cid = s.cid AND s.date_screen BETWEEN @start_d AND @end_d
SET t.dm_date = s.date_screen , t.dm_risk= s.risk;
/**cvd**/
UPDATE t_aged t INNER JOIN t_cvdrisk_fl s ON t.cid = s.cid 
SET  t.cvd_score= s.L_RISK_SCORE;
/**dental**/
UPDATE t_aged t INNER JOIN 
(
SELECT
s1.CID,s1.DATE_SERV,s1.PPSPECIAL
FROM
tmp_specialpp s1 INNER JOIN tmp_specialpp s2 ON s1.CID=s2.CID AND s2.DATE_SERV >= s1.DATE_SERV
WHERE s1.PPSPECIAL  IN('1B1260','1B1261','1B1269') AND s2.PPSPECIAL  IN('1B1260','1B1261','1B1269')
AND s1.DATE_SERV BETWEEN @start_d AND @end_d
AND s2.DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY s1.CID,s1.DATE_SERV
HAVING COUNT(*) = 1
)
s ON t.cid = s.cid AND s.date_serv BETWEEN @start_d AND @end_d
SET t.dent_date = s.date_serv , t.dent_code= s.PPSPECIAL;
/**amt**/
UPDATE t_aged t INNER JOIN 
(
SELECT
s1.CID,s1.DATE_SERV,s1.PPSPECIAL
FROM
tmp_specialpp s1 INNER JOIN tmp_specialpp s2 ON s1.CID=s2.CID AND s2.DATE_SERV >= s1.DATE_SERV
WHERE s1.PPSPECIAL  IN('1B1220','1B1221','1B1223','1B1229') AND s2.PPSPECIAL  IN('1B1220','1B1221','1B1223','1B1229')
AND s1.DATE_SERV BETWEEN @start_d AND @end_d
AND s2.DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY s1.CID,s1.DATE_SERV
HAVING COUNT(*) = 1
)
s ON t.cid = s.cid AND s.date_serv BETWEEN @start_d AND @end_d
SET t.amt_date = s.date_serv , t.amt_code= s.PPSPECIAL;
/**2q**/
UPDATE t_aged t INNER JOIN 
(
SELECT s1.CID,s1.DATE_SERV,s1.PPSPECIAL
FROM tmp_specialpp s1 INNER JOIN tmp_specialpp s2 ON s1.CID=s2.CID AND s2.DATE_SERV >= s1.DATE_SERV
WHERE s1.PPSPECIAL  IN('1B0280','1B0281') AND s2.PPSPECIAL  IN('1B0280','1B0281')
		AND s1.DATE_SERV BETWEEN @start_d AND @end_d
		AND s2.DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY s1.CID,s1.DATE_SERV
HAVING COUNT(*) = 1
) s ON t.cid = s.cid AND s.date_serv BETWEEN @start_d AND @end_d
SET t.2q_date = s.date_serv , t.2q_code= s.PPSPECIAL;
/**knee**/
UPDATE t_aged t INNER JOIN 
(
SELECT s1.CID,s1.DATE_SERV,s1.PPSPECIAL
FROM tmp_specialpp s1 INNER JOIN tmp_specialpp s2 ON s1.CID=s2.CID AND s2.DATE_SERV >= s1.DATE_SERV
WHERE s1.PPSPECIAL  IN('1B1270','1B1271','1B1272','1B1279') AND s2.PPSPECIAL  IN('1B1270','1B1271','1B1272','1B1279')
		AND s1.DATE_SERV BETWEEN @start_d AND @end_d
		AND s2.DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY s1.CID,s1.DATE_SERV
HAVING COUNT(*) = 1
) s ON t.cid = s.cid AND s.date_serv BETWEEN @start_d AND @end_d
SET t.knee_date = s.date_serv , t.knee_code= s.PPSPECIAL;
/**fall**/
UPDATE t_aged t INNER JOIN 
(
SELECT s1.CID,s1.DATE_SERV,s1.PPSPECIAL
FROM tmp_specialpp s1 INNER JOIN tmp_specialpp s2 ON s1.CID=s2.CID AND s2.DATE_SERV >= s1.DATE_SERV
WHERE s1.PPSPECIAL  IN('1B1200','1B1201','1B1202','1B1209') AND s2.PPSPECIAL  IN('1B1200','1B1201','1B1202','1B1209')
		AND s1.DATE_SERV BETWEEN @start_d AND @end_d
		AND s2.DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY s1.CID,s1.DATE_SERV
HAVING COUNT(*) = 1
) s ON t.cid = s.cid AND s.date_serv BETWEEN @start_d AND @end_d
SET t.fall_date = s.date_serv , t.fall_code= s.PPSPECIAL;
/**adl**/
UPDATE t_aged t INNER JOIN 
(
SELECT s1.CID,s1.DATE_SERV,s1.PPSPECIAL
FROM tmp_specialpp s1 INNER JOIN tmp_specialpp s2 ON s1.CID=s2.CID AND s2.DATE_SERV >= s1.DATE_SERV
WHERE s1.PPSPECIAL  IN('1B1280','1B1281','1B1282') AND s2.PPSPECIAL  IN('1B1280','1B1281','1B1282')
		AND s1.DATE_SERV BETWEEN @start_d AND @end_d
		AND s2.DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY s1.CID,s1.DATE_SERV
HAVING COUNT(*) = 1
) s ON t.cid = s.cid AND s.date_serv BETWEEN @start_d AND @end_d
SET t.adl_date = s.date_serv , t.adl_code= s.PPSPECIAL;
/**bmi**/
UPDATE  t_aged t INNER JOIN  ws_person_nutrition n ON t.cid=n.cid  AND n.date_serv BETWEEN @start_d AND @end_d
SET  t.bmi_date = n.date_serv , t.bmi= n.bmi;

 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.641458;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:389;a:5:{i:0;s:9324:"CREATE PROCEDURE t_adl()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '60';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');
/*ประวัติการรับบริการตรวจ ADL ประชากรทุกคนไม่เฉพาะในเขต*/
#DROP TABLE IF EXISTS t_adl_last_regist;
CREATE TABLE IF NOT EXISTS t_adl_last_regist(
 `CID` varchar(13) DEFAULT NULL,
 `DATE_SERV` date DEFAULT NULL,
 `PPSPECIAL` VARCHAR(6) DEFAULT NULL,
  `PPSPLACE` VARCHAR(5) DEFAULT NULL,	
PRIMARY KEY (`CID`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

REPLACE INTO t_adl_last_regist 
(SELECT CID,NULL,NULL,NULL
FROM
tmp_specialpp 
WHERE LENGTH(cid)=13 AND PPSPECIAL IN('1B1280','1B1281','1B1282') 
GROUP BY CID
);

UPDATE t_adl_last_regist  t INNER JOIN
(
SELECT s1.hospcode,s1.CID,s1.DATE_SERV,s1.PPSPECIAL,s1.PPSPLACE
FROM tmp_specialpp s1 INNER JOIN tmp_specialpp s2 ON s1.CID=s2.CID AND s2.DATE_SERV >= s1.DATE_SERV
WHERE s1.PPSPECIAL  IN('1B1280','1B1281','1B1282') AND s2.PPSPECIAL  IN('1B1280','1B1281','1B1282')
		AND s1.DATE_SERV BETWEEN @start_d AND @end_d
		AND s2.DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY s1.CID,s1.DATE_SERV
HAVING COUNT(*) = 1
) s ON t.cid = s.cid AND s.date_serv BETWEEN @start_d AND @end_d
SET t.DATE_SERV = s.date_serv , t.PPSPECIAL= s.PPSPECIAL
, t.PPSPLACE=IF(ISNULL(s.PPSPLACE) OR LENGTH(s.PPSPLACE) !=5 ,s.hospcode,s.PPSPLACE);

/*ประวัติการรับบริการตรวจ ADL ประชากรทุกคนเฉพาะในเขตและผลครั้งสุดท้ายของรอบนั้นๆ*/
DROP TABLE IF EXISTS t_adl;
CREATE TABLE IF NOT EXISTS t_adl(
 `HOSPCODE` varchar(5) NOT NULL,
 `CID` varchar(13) DEFAULT NULL,
 `PID` varchar(15) NOT NULL,
 `BIRTH` DATE,
 `AGE_Y` varchar(3) DEFAULT '0',
 `TYPEAREA` varchar(1) DEFAULT NULL,
 `DATE_SERV1` date DEFAULT NULL,
 `PPSPECIAL1` VARCHAR(6) DEFAULT NULL,
  `PP_HOSP1` VARCHAR(5) DEFAULT NULL,	
 `DATE_SERV2` date DEFAULT NULL,
 `PPSPECIAL2` VARCHAR(6) DEFAULT NULL,
  `PP_HOSP2` VARCHAR(5) DEFAULT NULL,	
PRIMARY KEY (`CID`),
  KEY  (`HOSPCODE`,`PID`),
  KEY  (`HOSPCODE`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO t_adl (HOSPCODE,CID,PID,BIRTH,AGE_Y,TYPEAREA)
(
SELECT check_hosp,CID,PID,BIRTH,AGE_Y,check_typearea 
FROM t_person_cid 
WHERE LENGTH(cid)=13  AND check_typearea in(1,3) AND NATION in(99) AND age_y >=60 AND age_y < 200 AND DISCHARGE in(9)
);
/*max date_serv1*/
UPDATE t_adl t INNER JOIN
(SELECT s1.hospcode,s1.CID,s1.DATE_SERV,s1.PPSPECIAL
FROM tmp_specialpp s1 INNER JOIN tmp_specialpp s2 ON s1.CID=s2.CID AND s2.DATE_SERV >= s1.DATE_SERV
WHERE s1.PPSPECIAL  IN('1B1280','1B1281','1B1282') AND s2.PPSPECIAL  IN('1B1280','1B1281','1B1282')
		AND s1.DATE_SERV BETWEEN  CONCAT(@b_year-1,'1001') AND CONCAT(@b_year,'0331') 
		AND s2.DATE_SERV BETWEEN  CONCAT(@b_year-1,'1001') AND CONCAT(@b_year,'0331') 
GROUP BY s1.CID,s1.DATE_SERV
HAVING COUNT(*) = 1
)
s ON t.cid=s.cid SET t.DATE_SERV1=s.date_serv ,t.PPSPECIAL1=s.PPSPECIAL ,t.PP_HOSP1=s.hospcode;

UPDATE t_adl t INNER JOIN
(SELECT s1.hospcode,s1.CID,s1.DATE_SERV,s1.PPSPECIAL
FROM tmp_specialpp s1 INNER JOIN tmp_specialpp s2 ON s1.CID=s2.CID AND s2.DATE_SERV >= s1.DATE_SERV
WHERE s1.PPSPECIAL  IN('1B1280','1B1281','1B1282') AND s2.PPSPECIAL  IN('1B1280','1B1281','1B1282')
		AND s1.DATE_SERV BETWEEN   CONCAT(@b_year,'0401') AND CONCAT(@b_year,'0930') 
		AND s2.DATE_SERV BETWEEN   CONCAT(@b_year,'0401') AND CONCAT(@b_year,'0930')  
GROUP BY s1.CID,s1.DATE_SERV
HAVING COUNT(*) = 1
)
s ON t.cid=s.cid SET t.DATE_SERV2=s.date_serv ,t.PPSPECIAL2=s.PPSPECIAL ,t.PP_HOSP2=s.hospcode;

DROP  TABLE IF EXISTS t_aged;
CREATE  TABLE IF NOT EXISTS t_aged(
  `HOSPCODE` varchar(5) NOT NULL,
  `PID` varchar(15) NOT NULL,
  `CID` varchar(13) NOT NULL,
  `SEX` varchar(1) NOT NULL ,
  `BIRTH` date  DEFAULT NULL,
	`NATION` varchar(3)  DEFAULT NULL,
	`DISCHARGE` varchar(1) DEFAULT NULL,
	`TYPEAREA` varchar(1)  DEFAULT NULL,
	`AGE_Y` int(3) DEFAULT NULL,
	`VHID` varchar(8) DEFAULT NULL,
	 ht_date DATE,
	 ht_risk int(1) DEFAULT NULL,
	 dm_date DATE DEFAULT NULL,
	 dm_risk int(1) DEFAULT NULL,
	 cvd_score decimal(5,2) NOT NULL DEFAULT '0.00',
	 dent_date DATE DEFAULT NULL,
	 dent_code varchar(6) DEFAULT NULL,
	 amt_date DATE DEFAULT NULL,
	 amt_code varchar(6) DEFAULT NULL,
	 2q_date DATE DEFAULT NULL,
	 2q_code varchar(6) DEFAULT NULL,
	 knee_date DATE DEFAULT NULL,
	 knee_code varchar(6) DEFAULT NULL,
	 fall_date DATE DEFAULT NULL,
	 fall_code varchar(6) DEFAULT NULL,
	 adl_date DATE DEFAULT NULL,
	 adl_code varchar(6) DEFAULT NULL,
	 bmi_date DATE DEFAULT NULL,
	 bmi decimal(5,2) NOT NULL DEFAULT '0.00',
		PRIMARY KEY (cid),
		KEY (cid),
		KEY (hospcode,pid)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;
INSERT IGNORE INTO t_aged (hospcode,pid,cid,sex,birth,nation,discharge,typearea,age_y,vhid)
SELECT
check_hosp,pid,cid , sex,birth ,nation,discharge, check_typearea,age_y ,check_vhid
FROM t_person_cid p  
WHERE  p.check_typearea in(1,3) AND p.NATION in(99) AND p.DISCHARGE in(9) AND LENGTH(TRIM(p.CID)) = 13
AND p.age_y >= 60 AND p.age_y < 200;
/**ht**/
UPDATE t_aged t INNER JOIN t_person_ht_screen s ON t.cid = s.cid AND s.date_screen BETWEEN @start_d AND @end_d
SET t.ht_date = s.date_screen , t.ht_risk= s.risk;
/**dm**/
UPDATE t_aged t INNER JOIN t_person_dm_screen s ON t.cid = s.cid AND s.date_screen BETWEEN @start_d AND @end_d
SET t.dm_date = s.date_screen , t.dm_risk= s.risk;
/**cvd**/
UPDATE t_aged t INNER JOIN t_cvdrisk_fl s ON t.cid = s.cid 
SET  t.cvd_score= s.L_RISK_SCORE;
/**dental**/
UPDATE t_aged t INNER JOIN 
(
SELECT
s1.CID,s1.DATE_SERV,s1.PPSPECIAL
FROM
tmp_specialpp s1 INNER JOIN tmp_specialpp s2 ON s1.CID=s2.CID AND s2.DATE_SERV >= s1.DATE_SERV
WHERE s1.PPSPECIAL  IN('1B1260','1B1261','1B1269') AND s2.PPSPECIAL  IN('1B1260','1B1261','1B1269')
AND s1.DATE_SERV BETWEEN @start_d AND @end_d
AND s2.DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY s1.CID,s1.DATE_SERV
HAVING COUNT(*) = 1
)
s ON t.cid = s.cid AND s.date_serv BETWEEN @start_d AND @end_d
SET t.dent_date = s.date_serv , t.dent_code= s.PPSPECIAL;
/**amt**/
UPDATE t_aged t INNER JOIN 
(
SELECT
s1.CID,s1.DATE_SERV,s1.PPSPECIAL
FROM
tmp_specialpp s1 INNER JOIN tmp_specialpp s2 ON s1.CID=s2.CID AND s2.DATE_SERV >= s1.DATE_SERV
WHERE s1.PPSPECIAL  IN('1B1220','1B1221','1B1223','1B1229') AND s2.PPSPECIAL  IN('1B1220','1B1221','1B1223','1B1229')
AND s1.DATE_SERV BETWEEN @start_d AND @end_d
AND s2.DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY s1.CID,s1.DATE_SERV
HAVING COUNT(*) = 1
)
s ON t.cid = s.cid AND s.date_serv BETWEEN @start_d AND @end_d
SET t.amt_date = s.date_serv , t.amt_code= s.PPSPECIAL;
/**2q**/
UPDATE t_aged t INNER JOIN 
(
SELECT s1.CID,s1.DATE_SERV,s1.PPSPECIAL
FROM tmp_specialpp s1 INNER JOIN tmp_specialpp s2 ON s1.CID=s2.CID AND s2.DATE_SERV >= s1.DATE_SERV
WHERE s1.PPSPECIAL  IN('1B0280','1B0281') AND s2.PPSPECIAL  IN('1B0280','1B0281')
		AND s1.DATE_SERV BETWEEN @start_d AND @end_d
		AND s2.DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY s1.CID,s1.DATE_SERV
HAVING COUNT(*) = 1
) s ON t.cid = s.cid AND s.date_serv BETWEEN @start_d AND @end_d
SET t.2q_date = s.date_serv , t.2q_code= s.PPSPECIAL;
/**knee**/
UPDATE t_aged t INNER JOIN 
(
SELECT s1.CID,s1.DATE_SERV,s1.PPSPECIAL
FROM tmp_specialpp s1 INNER JOIN tmp_specialpp s2 ON s1.CID=s2.CID AND s2.DATE_SERV >= s1.DATE_SERV
WHERE s1.PPSPECIAL  IN('1B1270','1B1271','1B1272','1B1279') AND s2.PPSPECIAL  IN('1B1270','1B1271','1B1272','1B1279')
		AND s1.DATE_SERV BETWEEN @start_d AND @end_d
		AND s2.DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY s1.CID,s1.DATE_SERV
HAVING COUNT(*) = 1
) s ON t.cid = s.cid AND s.date_serv BETWEEN @start_d AND @end_d
SET t.knee_date = s.date_serv , t.knee_code= s.PPSPECIAL;
/**fall**/
UPDATE t_aged t INNER JOIN 
(
SELECT s1.CID,s1.DATE_SERV,s1.PPSPECIAL
FROM tmp_specialpp s1 INNER JOIN tmp_specialpp s2 ON s1.CID=s2.CID AND s2.DATE_SERV >= s1.DATE_SERV
WHERE s1.PPSPECIAL  IN('1B1200','1B1201','1B1202','1B1209') AND s2.PPSPECIAL  IN('1B1200','1B1201','1B1202','1B1209')
		AND s1.DATE_SERV BETWEEN @start_d AND @end_d
		AND s2.DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY s1.CID,s1.DATE_SERV
HAVING COUNT(*) = 1
) s ON t.cid = s.cid AND s.date_serv BETWEEN @start_d AND @end_d
SET t.fall_date = s.date_serv , t.fall_code= s.PPSPECIAL;
/**adl**/
UPDATE t_aged t INNER JOIN 
(
SELECT s1.CID,s1.DATE_SERV,s1.PPSPECIAL
FROM tmp_specialpp s1 INNER JOIN tmp_specialpp s2 ON s1.CID=s2.CID AND s2.DATE_SERV >= s1.DATE_SERV
WHERE s1.PPSPECIAL  IN('1B1280','1B1281','1B1282') AND s2.PPSPECIAL  IN('1B1280','1B1281','1B1282')
		AND s1.DATE_SERV BETWEEN @start_d AND @end_d
		AND s2.DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY s1.CID,s1.DATE_SERV
HAVING COUNT(*) = 1
) s ON t.cid = s.cid AND s.date_serv BETWEEN @start_d AND @end_d
SET t.adl_date = s.date_serv , t.adl_code= s.PPSPECIAL;
/**bmi**/
UPDATE  t_aged t INNER JOIN  ws_person_nutrition n ON t.cid=n.cid  AND n.date_serv BETWEEN @start_d AND @end_d
SET  t.bmi_date = n.date_serv , t.bmi= n.bmi;

 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.7194581;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:391;a:5:{i:0;s:36:"DROP PROCEDURE IF EXISTS t_postnatal";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.7194581;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:392;a:5:{i:0;s:36:"DROP PROCEDURE IF EXISTS t_postnatal";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.781858;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:394;a:5:{i:0;s:2793:"CREATE PROCEDURE t_postnatal()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '61';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS t_postnatal;
CREATE TABLE IF NOT EXISTS t_postnatal(
`HOSPCODE` varchar(5) NOT NULL,
  `PID` varchar(15) NOT NULL,
  `GRAVIDA` varchar(2) NOT NULL,
  `BDATE` date NOT NULL,
  `cid` varchar(13) DEFAULT NULL,
  `nation` varchar(3) DEFAULT '',
  `occupat` varchar(4) DEFAULT NULL,
  `birth` date DEFAULT NULL,
  `vhid` varchar(8) DEFAULT NULL,
  `ppcare1` date DEFAULT NULL,
  `ppcare1_hosp` varchar(5) DEFAULT NULL,
	`ppcare1_input_hosp` varchar(5) DEFAULT NULL,
  `ppcare2` date DEFAULT NULL,
  `ppcare2_hosp` varchar(5) DEFAULT NULL,
	`ppcare2_input_hosp` varchar(5) DEFAULT NULL,
  `ppcare3` date DEFAULT NULL,
  `ppcare3_hosp` varchar(5) DEFAULT NULL,
	`ppcare3_input_hosp` varchar(5) DEFAULT NULL,
  PRIMARY KEY (`CID`,bdate),
  KEY  (`cid`),
	KEY `HOSPCODE` (`HOSPCODE`,`PID`),
  KEY `BDATE` (`BDATE`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO t_postnatal (HOSPCODE,PID,GRAVIDA,BDATE,cid,nation,occupat,birth,vhid)
(SELECT 
HOSPCODE,PID,GRAVIDA,BDATE,cid,nation,occupat,birth,vhid
FROM	tmp_postnatal p
WHERE  p.BDATE BETWEEN @start_d AND @end_d
GROUP BY cid,BDATE
);

UPDATE IGNORE  t_postnatal p INNER JOIN (
SELECT min(PPCARE) PPCARE,BDATE,cid 
FROM tmp_postnatal WHERE TIMESTAMPDIFF(day,bdate,ppcare) <=7
GROUP BY cid,BDATE
) l ON p.cid=l.cid AND p.bdate=l.bdate 
SET p.ppcare1=l.ppcare;

UPDATE IGNORE  t_postnatal p INNER JOIN (
SELECT PPCARE,PPPLACE,BDATE,HOSPCODE,cid FROM tmp_postnatal 
) l ON p.cid=l.cid AND p.bdate=l.bdate AND  p.ppcare1=l.ppcare
SET p.ppcare1_hosp=l.PPPLACE , p.ppcare1_input_hosp=l.HOSPCODE;

UPDATE IGNORE  t_postnatal p INNER JOIN (
SELECT min(PPCARE) PPCARE,BDATE,cid 
FROM tmp_postnatal WHERE TIMESTAMPDIFF(day,bdate,ppcare) BETWEEN 8 AND 15
GROUP BY cid,BDATE
) l ON p.cid=l.cid AND p.bdate=l.bdate 
SET p.ppcare2=l.ppcare;

UPDATE IGNORE  t_postnatal p INNER JOIN (
SELECT PPCARE,PPPLACE,BDATE,HOSPCODE,cid FROM tmp_postnatal 
) l ON p.cid=l.cid AND p.bdate=l.bdate AND  p.ppcare2=l.ppcare
SET p.ppcare2_hosp=l.PPPLACE , p.ppcare2_input_hosp=l.HOSPCODE;

UPDATE IGNORE  t_postnatal p INNER JOIN (
SELECT min(PPCARE) PPCARE,BDATE,cid 
FROM tmp_postnatal WHERE TIMESTAMPDIFF(day,bdate,ppcare) BETWEEN 16 AND 42
GROUP BY cid,BDATE
) l ON p.cid=l.cid AND p.bdate=l.bdate 
SET p.ppcare3=l.ppcare;

UPDATE IGNORE  t_postnatal p INNER JOIN (
SELECT PPCARE,PPPLACE,BDATE,HOSPCODE,cid FROM tmp_postnatal 
) l ON p.cid=l.cid AND p.bdate=l.bdate AND  p.ppcare3=l.ppcare
SET p.ppcare3_hosp=l.PPPLACE , p.ppcare3_input_hosp=l.HOSPCODE;
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.781858;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:395;a:5:{i:0;s:2793:"CREATE PROCEDURE t_postnatal()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '61';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS t_postnatal;
CREATE TABLE IF NOT EXISTS t_postnatal(
`HOSPCODE` varchar(5) NOT NULL,
  `PID` varchar(15) NOT NULL,
  `GRAVIDA` varchar(2) NOT NULL,
  `BDATE` date NOT NULL,
  `cid` varchar(13) DEFAULT NULL,
  `nation` varchar(3) DEFAULT '',
  `occupat` varchar(4) DEFAULT NULL,
  `birth` date DEFAULT NULL,
  `vhid` varchar(8) DEFAULT NULL,
  `ppcare1` date DEFAULT NULL,
  `ppcare1_hosp` varchar(5) DEFAULT NULL,
	`ppcare1_input_hosp` varchar(5) DEFAULT NULL,
  `ppcare2` date DEFAULT NULL,
  `ppcare2_hosp` varchar(5) DEFAULT NULL,
	`ppcare2_input_hosp` varchar(5) DEFAULT NULL,
  `ppcare3` date DEFAULT NULL,
  `ppcare3_hosp` varchar(5) DEFAULT NULL,
	`ppcare3_input_hosp` varchar(5) DEFAULT NULL,
  PRIMARY KEY (`CID`,bdate),
  KEY  (`cid`),
	KEY `HOSPCODE` (`HOSPCODE`,`PID`),
  KEY `BDATE` (`BDATE`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO t_postnatal (HOSPCODE,PID,GRAVIDA,BDATE,cid,nation,occupat,birth,vhid)
(SELECT 
HOSPCODE,PID,GRAVIDA,BDATE,cid,nation,occupat,birth,vhid
FROM	tmp_postnatal p
WHERE  p.BDATE BETWEEN @start_d AND @end_d
GROUP BY cid,BDATE
);

UPDATE IGNORE  t_postnatal p INNER JOIN (
SELECT min(PPCARE) PPCARE,BDATE,cid 
FROM tmp_postnatal WHERE TIMESTAMPDIFF(day,bdate,ppcare) <=7
GROUP BY cid,BDATE
) l ON p.cid=l.cid AND p.bdate=l.bdate 
SET p.ppcare1=l.ppcare;

UPDATE IGNORE  t_postnatal p INNER JOIN (
SELECT PPCARE,PPPLACE,BDATE,HOSPCODE,cid FROM tmp_postnatal 
) l ON p.cid=l.cid AND p.bdate=l.bdate AND  p.ppcare1=l.ppcare
SET p.ppcare1_hosp=l.PPPLACE , p.ppcare1_input_hosp=l.HOSPCODE;

UPDATE IGNORE  t_postnatal p INNER JOIN (
SELECT min(PPCARE) PPCARE,BDATE,cid 
FROM tmp_postnatal WHERE TIMESTAMPDIFF(day,bdate,ppcare) BETWEEN 8 AND 15
GROUP BY cid,BDATE
) l ON p.cid=l.cid AND p.bdate=l.bdate 
SET p.ppcare2=l.ppcare;

UPDATE IGNORE  t_postnatal p INNER JOIN (
SELECT PPCARE,PPPLACE,BDATE,HOSPCODE,cid FROM tmp_postnatal 
) l ON p.cid=l.cid AND p.bdate=l.bdate AND  p.ppcare2=l.ppcare
SET p.ppcare2_hosp=l.PPPLACE , p.ppcare2_input_hosp=l.HOSPCODE;

UPDATE IGNORE  t_postnatal p INNER JOIN (
SELECT min(PPCARE) PPCARE,BDATE,cid 
FROM tmp_postnatal WHERE TIMESTAMPDIFF(day,bdate,ppcare) BETWEEN 16 AND 42
GROUP BY cid,BDATE
) l ON p.cid=l.cid AND p.bdate=l.bdate 
SET p.ppcare3=l.ppcare;

UPDATE IGNORE  t_postnatal p INNER JOIN (
SELECT PPCARE,PPPLACE,BDATE,HOSPCODE,cid FROM tmp_postnatal 
) l ON p.cid=l.cid AND p.bdate=l.bdate AND  p.ppcare3=l.ppcare
SET p.ppcare3_hosp=l.PPPLACE , p.ppcare3_input_hosp=l.HOSPCODE;
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.8286581;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:397;a:5:{i:0;s:36:"DROP PROCEDURE IF EXISTS t_cigarette";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.8286581;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:398;a:5:{i:0;s:36:"DROP PROCEDURE IF EXISTS t_cigarette";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.891058;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:400;a:5:{i:0;s:909:"CREATE PROCEDURE t_cigarette()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '62';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'0701');
SET @end_d:=concat(@b_year,'0930');


DROP TABLE IF EXISTS t_cigarette;
CREATE TABLE IF NOT EXISTS t_cigarette(
 `CID` varchar(13) NOT NULL,
 `HOSPCODE` varchar(5) NOT NULL,
 `PID` varchar(15) NOT NULL,
 `DATE_SERV` date NOT NULL,
 `SOURCE` varchar(30) NOT NULL,
PRIMARY KEY (cid)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO t_cigarette (
SELECT CID,HOSPCODE,PID,DATE_SERV,'SPECIALPP'
FROM tmp_specialpp 
WHERE DATE_SERV BETWEEN @start_d AND @end_d
AND SUBSTR(PPSPECIAL,1,4) IN('1B50','1B53','1B54','1B55','1B56')
);

INSERT IGNORE INTO t_cigarette (
SELECT CID,HOSPCODE,PID,DATE_SERV,'NCDSCREEN'
FROM tmp_ncdscreen 
WHERE DATE_SERV BETWEEN @start_d AND @end_d
AND smoke in(2,3,4)
);
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.891058;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:401;a:5:{i:0;s:909:"CREATE PROCEDURE t_cigarette()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '62';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'0701');
SET @end_d:=concat(@b_year,'0930');


DROP TABLE IF EXISTS t_cigarette;
CREATE TABLE IF NOT EXISTS t_cigarette(
 `CID` varchar(13) NOT NULL,
 `HOSPCODE` varchar(5) NOT NULL,
 `PID` varchar(15) NOT NULL,
 `DATE_SERV` date NOT NULL,
 `SOURCE` varchar(30) NOT NULL,
PRIMARY KEY (cid)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

INSERT IGNORE INTO t_cigarette (
SELECT CID,HOSPCODE,PID,DATE_SERV,'SPECIALPP'
FROM tmp_specialpp 
WHERE DATE_SERV BETWEEN @start_d AND @end_d
AND SUBSTR(PPSPECIAL,1,4) IN('1B50','1B53','1B54','1B55','1B56')
);

INSERT IGNORE INTO t_cigarette (
SELECT CID,HOSPCODE,PID,DATE_SERV,'NCDSCREEN'
FROM tmp_ncdscreen 
WHERE DATE_SERV BETWEEN @start_d AND @end_d
AND smoke in(2,3,4)
);
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.9378581;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:403;a:5:{i:0;s:40:"DROP PROCEDURE IF EXISTS t_breast_screen";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988056.9378581;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:404;a:5:{i:0;s:40:"DROP PROCEDURE IF EXISTS t_breast_screen";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.000258;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:406;a:5:{i:0;s:2217:"CREATE PROCEDURE t_breast_screen()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '63';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');


DROP TABLE IF EXISTS tmp_breast_screen;
CREATE TABLE IF NOT EXISTS tmp_breast_screen(
PRIMARY KEY (HOSPCODE,PID,DATE_SERV,PPSPECIAL) 
,KEY (cid)
,KEY (hospcode,pid)
,KEY (date_serv)
,KEY (ppspecial)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 AS (
SELECT 
*
FROM tmp_specialpp s 
WHERE s.DATE_SERV BETWEEN @start_d AND @end_d AND SUBSTR(s.ppspecial,1,5) IN('1B003')
);

DROP TABLE IF EXISTS tmp_breast_screen_doctor;
CREATE TABLE IF NOT EXISTS tmp_breast_screen_doctor(
PRIMARY KEY (HOSPCODE,PID,DATE_SERV,DIAGCODE) 
,KEY (cid)
,KEY (hospcode,pid)
,KEY (date_serv)
,KEY (DIAGCODE)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 AS (
SELECT hospcode,pid,seq,date_serv,diagcode,cid 
FROM tmp_diag_opd 
WHERE date_serv BETWEEN @start_d AND @end_d AND SUBSTR(DIAGCODE,1,4) IN('Z123')
GROUP BY HOSPCODE,PID,DATE_SERV,DIAGCODE
);

DROP TABLE IF EXISTS t_breast_screen;
CREATE TABLE IF NOT EXISTS t_breast_screen(
CID varchar(13) NOT NULL,
self_screen varchar(6) DEFAULT NULL,
self_screen_date date DEFAULT NULL,
self_screen_hospcode varchar(5) DEFAULT NULL,
self_screen_input varchar(5) DEFAULT NULL,
doctor_screen varchar(7) DEFAULT NULL,
doctor_screen_date date DEFAULT NULL,
doctor_screen_hospcode varchar(5) DEFAULT NULL,
PRIMARY KEY (CID) 
) ENGINE=MyISAM DEFAULT CHARSET=utf8 ;

INSERT IGNORE INTO t_breast_screen (cid)
(SELECT cid FROM tmp_breast_screen GROUP BY cid);

INSERT IGNORE INTO t_breast_screen (cid)
(SELECT cid FROM tmp_breast_screen_doctor GROUP BY cid);

UPDATE IGNORE t_breast_screen t INNER JOIN (SELECT * FROM tmp_breast_screen ORDER BY DATE_SERV DESC) s ON  t.cid=s.cid
SET t.self_screen=s.PPSPECIAL ,t.self_screen_date =s.date_serv , t.self_screen_hospcode=s.PPSPLACE,t.self_screen_input=s.hospcode;

UPDATE IGNORE t_breast_screen t INNER JOIN (SELECT * FROM tmp_breast_screen_doctor ORDER BY DATE_SERV DESC) s ON  t.cid=s.cid
SET t.doctor_screen=s.diagcode ,t.doctor_screen_date =s.date_serv , t.doctor_screen_hospcode=s.hospcode;
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.000258;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:407;a:5:{i:0;s:2217:"CREATE PROCEDURE t_breast_screen()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '63';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');


DROP TABLE IF EXISTS tmp_breast_screen;
CREATE TABLE IF NOT EXISTS tmp_breast_screen(
PRIMARY KEY (HOSPCODE,PID,DATE_SERV,PPSPECIAL) 
,KEY (cid)
,KEY (hospcode,pid)
,KEY (date_serv)
,KEY (ppspecial)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 AS (
SELECT 
*
FROM tmp_specialpp s 
WHERE s.DATE_SERV BETWEEN @start_d AND @end_d AND SUBSTR(s.ppspecial,1,5) IN('1B003')
);

DROP TABLE IF EXISTS tmp_breast_screen_doctor;
CREATE TABLE IF NOT EXISTS tmp_breast_screen_doctor(
PRIMARY KEY (HOSPCODE,PID,DATE_SERV,DIAGCODE) 
,KEY (cid)
,KEY (hospcode,pid)
,KEY (date_serv)
,KEY (DIAGCODE)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 AS (
SELECT hospcode,pid,seq,date_serv,diagcode,cid 
FROM tmp_diag_opd 
WHERE date_serv BETWEEN @start_d AND @end_d AND SUBSTR(DIAGCODE,1,4) IN('Z123')
GROUP BY HOSPCODE,PID,DATE_SERV,DIAGCODE
);

DROP TABLE IF EXISTS t_breast_screen;
CREATE TABLE IF NOT EXISTS t_breast_screen(
CID varchar(13) NOT NULL,
self_screen varchar(6) DEFAULT NULL,
self_screen_date date DEFAULT NULL,
self_screen_hospcode varchar(5) DEFAULT NULL,
self_screen_input varchar(5) DEFAULT NULL,
doctor_screen varchar(7) DEFAULT NULL,
doctor_screen_date date DEFAULT NULL,
doctor_screen_hospcode varchar(5) DEFAULT NULL,
PRIMARY KEY (CID) 
) ENGINE=MyISAM DEFAULT CHARSET=utf8 ;

INSERT IGNORE INTO t_breast_screen (cid)
(SELECT cid FROM tmp_breast_screen GROUP BY cid);

INSERT IGNORE INTO t_breast_screen (cid)
(SELECT cid FROM tmp_breast_screen_doctor GROUP BY cid);

UPDATE IGNORE t_breast_screen t INNER JOIN (SELECT * FROM tmp_breast_screen ORDER BY DATE_SERV DESC) s ON  t.cid=s.cid
SET t.self_screen=s.PPSPECIAL ,t.self_screen_date =s.date_serv , t.self_screen_hospcode=s.PPSPLACE,t.self_screen_input=s.hospcode;

UPDATE IGNORE t_breast_screen t INNER JOIN (SELECT * FROM tmp_breast_screen_doctor ORDER BY DATE_SERV DESC) s ON  t.cid=s.cid
SET t.doctor_screen=s.diagcode ,t.doctor_screen_date =s.date_serv , t.doctor_screen_hospcode=s.hospcode;
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.0470581;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:409;a:5:{i:0;s:40:"DROP PROCEDURE IF EXISTS t_cervix_screen";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.0470581;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:410;a:5:{i:0;s:40:"DROP PROCEDURE IF EXISTS t_cervix_screen";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.093858;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:412;a:5:{i:0;s:1658:"CREATE PROCEDURE t_cervix_screen()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '64';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @year_start:=(SELECT `year` FROM ccervix_year WHERE  `year` <= @b_year LIMIT 1);
SET @start_d:=concat(@year_start,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS tmp_cervix_diag5;
CREATE TABLE IF NOT EXISTS tmp_cervix_diag5(
PRIMARY KEY (HOSPCODE,PID,SEQ)
,KEY (cid)
,KEY (date_serv)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 AS
(SELECT o.hospcode,o.pid,o.seq,o.date_serv,o.diagcode,p.cid
FROM diagnosis_opd o  INNER JOIN person p ON o.hospcode=p.hospcode AND o.pid=p.pid
WHERE o.DATE_SERV  BETWEEN @start_d AND @end_d 
AND SUBSTR(o.DIAGCODE,1,4) IN('Z014','Z124')
GROUP BY o.HOSPCODE,o.PID,o.SEQ
);

DROP TABLE IF EXISTS t_cervix_screen;
CREATE TABLE IF NOT EXISTS t_cervix_screen(
CID varchar(13) NOT NULL,
screen_code varchar(7) DEFAULT NULL,
screen_date date DEFAULT NULL,
screen_source varchar(30) DEFAULT NULL,
screen_hospcode varchar(5) DEFAULT NULL,
screen_input varchar(5) DEFAULT NULL,
PRIMARY KEY (CID,screen_date) 
,KEY (cid)
,KEY (screen_date)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 ;

INSERT IGNORE INTO t_cervix_screen (
SELECT cid,PPSPECIAL,DATE_SERV,'SPECIALPP',PPSPLACE,HOSPCODE
FROM tmp_specialpp s 
WHERE s.DATE_SERV BETWEEN @start_d AND @end_d 
AND SUBSTR(s.ppspecial,1,5) IN('1B004') AND LENGTH(cid)=13
GROUP BY CID
);

INSERT IGNORE INTO t_cervix_screen (
SELECT cid,DIAGCODE,DATE_SERV,'DIAGNOSIS_OPD',HOSPCODE,HOSPCODE
FROM tmp_cervix_diag5 s 
WHERE s.DATE_SERV BETWEEN @start_d AND @end_d  AND LENGTH(cid)=13
GROUP BY CID
);
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.109458;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:413;a:5:{i:0;s:1658:"CREATE PROCEDURE t_cervix_screen()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '64';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @year_start:=(SELECT `year` FROM ccervix_year WHERE  `year` <= @b_year LIMIT 1);
SET @start_d:=concat(@year_start,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS tmp_cervix_diag5;
CREATE TABLE IF NOT EXISTS tmp_cervix_diag5(
PRIMARY KEY (HOSPCODE,PID,SEQ)
,KEY (cid)
,KEY (date_serv)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 AS
(SELECT o.hospcode,o.pid,o.seq,o.date_serv,o.diagcode,p.cid
FROM diagnosis_opd o  INNER JOIN person p ON o.hospcode=p.hospcode AND o.pid=p.pid
WHERE o.DATE_SERV  BETWEEN @start_d AND @end_d 
AND SUBSTR(o.DIAGCODE,1,4) IN('Z014','Z124')
GROUP BY o.HOSPCODE,o.PID,o.SEQ
);

DROP TABLE IF EXISTS t_cervix_screen;
CREATE TABLE IF NOT EXISTS t_cervix_screen(
CID varchar(13) NOT NULL,
screen_code varchar(7) DEFAULT NULL,
screen_date date DEFAULT NULL,
screen_source varchar(30) DEFAULT NULL,
screen_hospcode varchar(5) DEFAULT NULL,
screen_input varchar(5) DEFAULT NULL,
PRIMARY KEY (CID,screen_date) 
,KEY (cid)
,KEY (screen_date)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 ;

INSERT IGNORE INTO t_cervix_screen (
SELECT cid,PPSPECIAL,DATE_SERV,'SPECIALPP',PPSPLACE,HOSPCODE
FROM tmp_specialpp s 
WHERE s.DATE_SERV BETWEEN @start_d AND @end_d 
AND SUBSTR(s.ppspecial,1,5) IN('1B004') AND LENGTH(cid)=13
GROUP BY CID
);

INSERT IGNORE INTO t_cervix_screen (
SELECT cid,DIAGCODE,DATE_SERV,'DIAGNOSIS_OPD',HOSPCODE,HOSPCODE
FROM tmp_cervix_diag5 s 
WHERE s.DATE_SERV BETWEEN @start_d AND @end_d  AND LENGTH(cid)=13
GROUP BY CID
);
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.1562591;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:415;a:5:{i:0;s:33:"DROP PROCEDURE IF EXISTS t_ttm1_5";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.1562591;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:416;a:5:{i:0;s:33:"DROP PROCEDURE IF EXISTS t_ttm1_5";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.2154601;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:418;a:5:{i:0;s:12670:"CREATE PROCEDURE t_ttm1_5()
 BEGIN 
SET @provid = '58';
SET@id:= '65';
SET @rep_year = (SELECT yearprocess FROM sys_config LIMIT 1);

/**********ttm1*****************/
DROP TEMPORARY TABLE IF  EXISTS mother_service;
CREATE TEMPORARY TABLE IF NOT EXISTS 
mother_service (INDEX(CID)) 
ENGINE=MYISAM IGNORE AS 
SELECT 
e.HOSPCODE, 
e.PID, 
e.SEQ, 
e.DATE_SERV,
s.INSTYPE,
GROUP_CONCAT(e.PROCEDCODE) PROCEDCODE,
p.BIRTH,
p.CID,
LENGTH(GROUP_CONCAT(e.PROCEDCODE)) length_str
FROM tmp_procedure_opd e 
LEFT JOIN tmp_service s ON e.HOSPCODE = s.HOSPCODE AND e.PID = s.PID AND e.SEQ = s.SEQ 
LEFT JOIN person p ON e.HOSPCODE = p.HOSPCODE AND e.PID = p.PID AND s.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
WHERE e.PROCEDCODE IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND 
e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') AND 
p.SEX = 2 
GROUP BY e.HOSPCODE, e.PID, e.SEQ 
;

DROP TEMPORARY TABLE IF  EXISTS labor_rep;
CREATE TEMPORARY TABLE IF NOT EXISTS 
labor_rep (INDEX(CID)) 
ENGINE=MYISAM IGNORE AS 
SELECT 
p.CID,
l.BDATE
FROM 
tmp_labor l
LEFT JOIN person p ON l.HOSPCODE = p.HOSPCODE AND l.PID = p.PID  
WHERE 
l.BDATE BETWEEN CONCAT((@rep_year-1),'0701') AND CONCAT(@rep_year,'0930') AND 
p.CID IS NOT NULL 
GROUP BY p.CID 
;

DROP TABLE IF  EXISTS t_ttm_opd_1;
CREATE TABLE IF NOT EXISTS t_ttm_opd_1( 
PRIMARY KEY (hospcode,code_rep ),
KEY (hospcode)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT SQL_BIG_RESULT
e.HOSPCODE ,
CONCAT(e.HOSPCODE,'-',e.PID) code_rep,
@rep_year year_rep,
TIMESTAMPDIFF(YEAR,e.BIRTH,e.DATE_SERV) age,
MIN(e.DATE_SERV) begin_date_serv,
COUNT(DISTINCT   l.CID) all_mother,
COUNT(IF(e.length_str=39,1,NULL)) have_service,
COUNT(1) all_service,
COUNT(IF(e.PROCEDCODE LIKE '%9007712%',1,NULL)) ttm_service,
IF(DATEDIFF(MIN(e.DATE_SERV),l.BDATE) BETWEEN 0 AND 45,0,1) not_in_time,
IF(DATEDIFF(MAX(e.DATE_SERV),MIN(e.DATE_SERV)) BETWEEN 0 AND 90,0,1) not_less90days,

COUNT(DISTINCT IF(e.INSTYPE='0100',l.CID,NULL)) all_uc_mother,
COUNT(IF(e.length_str=39 AND e.INSTYPE='0100',1,NULL)) uc_have_service,
COUNT(IF(e.INSTYPE='0100',1,NULL)) uc_all_service,
IF(e.INSTYPE='0100',IF(DATEDIFF(MIN(e.DATE_SERV),l.BDATE) BETWEEN 0 AND 45,0,1),0) uc_not_in_time,
IF(e.INSTYPE='0100',IF(DATEDIFF(MAX(e.DATE_SERV),MIN(e.DATE_SERV)) BETWEEN 0 AND 90,0,1),0) uc_not_less90days 
FROM mother_service e 
LEFT JOIN labor_rep l ON l.CID = e.CID
LEFT JOIN chospital i ON e.HOSPCODE = i.hoscode 
WHERE 
i.provcode=@provid 
GROUP BY e.HOSPCODE, e.PID ;

/**********ttm2*****************/
DROP TABLE IF  EXISTS tmp_planthai_drug_use;
CREATE  TABLE IF NOT EXISTS 
tmp_planthai_drug_use (INDEX(HOSPCODE),INDEX(PID),INDEX(SEQ)) 
ENGINE=MYISAM IGNORE AS 
SELECT
e.HOSPCODE,
e.PID,
e.SEQ,
e.DATE_SERV,
e.DIDSTD,
e.AMOUNT,
e.DRUGPRICE,
e.DRUGCOST,
d.didstd PASS,
d.drug_name,
d.drug_type ,
d.ed
FROM 
tmp_drug_opd e 
LEFT JOIN cdrug_planthai d ON d.didstd=e.DIDSTD 
WHERE
e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIDSTD,2) IN ('41','42') 
;

DROP TABLE IF  EXISTS t_ttm_opd_2;
CREATE TABLE IF NOT EXISTS t_ttm_opd_2( 
PRIMARY KEY (hospcode,code_rep ),
KEY (hospcode)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
e.HOSPCODE ,
IFNULL(e.code_rep,CONCAT(@rep_year,'-07')) code_rep,
IFNULL(
IF(e.code_name=1,'มกราคม',
IF(e.code_name=2,'กุมภาพันธ์',
IF(e.code_name=3,'มีนาคม',
IF(e.code_name=4,'เมษายน',
IF(e.code_name=5,'พฤษภาคม',
IF(e.code_name=6,'มิถุนายน',
IF(e.code_name=7,'กรกฏาคม',
IF(e.code_name=8,'สิงหาคม',
IF(e.code_name=9,'กันยายน',
IF(e.code_name=10,'ตุลาคม',
IF(e.code_name=11,'พฤศจิกายน',
'ธันวาคม')))))))))))
,'กรกฏาคม') code_name,
IFNULL(e.year_rep,@rep_year) year_rep,
IFNULL(e.all_visit,0) all_visit,
IFNULL(e.all_drug,0) all_drug,
IFNULL(e.uc_visit,0) uc_visit,
IFNULL(e.uc_drug,0) uc_drug,
IFNULL(e.all_visit_error,0) all_visit_error,
IFNULL(e.all_drug_error,0) all_drug_error,
IFNULL(e.uc_visit_error,0) uc_visit_error,
IFNULL(e.uc_drug_error,0) uc_drug_error
FROM chospital o 
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE, 
LEFT(DATE(e.DATE_SERV),7) code_rep,
MONTH(e.DATE_SERV) code_name,
@rep_year year_rep, 
COUNT(DISTINCT CONCAT(e.PID,'-',e.SEQ)) as all_visit, 
COUNT(*) as all_drug, 
COUNT(DISTINCT (IF(s.INSTYPE='0100',CONCAT(e.PID,'-',e.SEQ),NULL))) as uc_visit , 
COUNT(IF(s.INSTYPE='0100',1,NULL)) as uc_drug,
COUNT(DISTINCT IF(e.PASS IS NULL,CONCAT(e.PID,'-',e.SEQ),NULL)) as all_visit_error, 
COUNT(IF(e.PASS IS NULL,CONCAT(e.PID,'-',e.SEQ),NULL)) as all_drug_error, 
COUNT(DISTINCT (IF(s.INSTYPE='0100' AND e.PASS IS NULL,CONCAT(e.PID,'-',e.SEQ),NULL))) as uc_visit_error , 
COUNT(IF(s.INSTYPE='0100' AND e.PASS IS NULL,1,NULL)) as uc_drug_error  
FROM 
tmp_planthai_drug_use e
LEFT JOIN tmp_service s ON e.HOSPCODE = s.HOSPCODE AND e.PID = s.PID AND e.SEQ = s.SEQ 
GROUP BY e.HOSPCODE, MONTH(e.DATE_SERV) 
) e ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid  AND e.code_rep IS NOT NULL ;

/***************ttm3****************/
DROP TABLE IF  EXISTS t_ttm_opd_3;
CREATE TABLE IF NOT EXISTS t_ttm_opd_3( 
PRIMARY KEY (hospcode,servplace,age,sex),
KEY (hospcode),
KEY (servplace),
KEY (age),
KEY (sex)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
e.HOSPCODE ,
e.servplace,
e.age,
e.sex,
@rep_year year_rep,
IFNULL(e.total_pt_q1,0) total_pt_q1,	
IFNULL(e.total_q1,0) total_q1,
IFNULL(e.didstd_q1,0) didstd_q1,
IFNULL(e.total_pt_q2,0) total_pt_q2,	
IFNULL(e.total_q2,0) total_q2,
IFNULL(e.didstd_q2,0) didstd_q2,
IFNULL(e.total_pt_q3,0) total_pt_q3,	
IFNULL(e.total_q3,0) total_q3,
IFNULL(e.didstd_q3,0) didstd_q3,	
IFNULL(e.total_pt_q4,0) total_pt_q4,	
IFNULL(e.total_q4,0) total_q4,
IFNULL(e.didstd_q4,0) didstd_q4
FROM chospital o 
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE, 
e.DATE_SERV,
s.SERVPLACE servplace,
TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'1001')) age,
p.SEX sex,
@rep_year year_rep, 
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) total_pt_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ,'-',e.DIDSTD),NULL)) didstd_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) total_pt_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ,'-',e.DIDSTD),NULL)) didstd_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) total_pt_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ,'-',e.DIDSTD),NULL)) didstd_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) total_pt_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ,'-',e.DIDSTD),NULL)) didstd_q4 
FROM 
tmp_planthai_drug_use e
LEFT JOIN tmp_service s ON e.HOSPCODE = s.HOSPCODE AND e.PID = s.PID AND e.SEQ = s.SEQ 
LEFT JOIN person p ON e.HOSPCODE = p.HOSPCODE AND e.PID = p.PID 
GROUP BY e.HOSPCODE, s.SERVPLACE, p.SEX, TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'1001'))
) e ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.servplace IN ('1','2') AND e.HOSPCODE IS NOT NULL ;

/*********************ttm4**************/
DROP TABLE IF  EXISTS t_ttm_opd_4;
CREATE TABLE IF NOT EXISTS t_ttm_opd_4( 
PRIMARY KEY (hospcode,didstd),
KEY (hospcode),
KEY (didstd)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
o.hoscode hospcode ,
e.didstd,
IFNULL(CONCAT(e.drug_name,', ',e.drug_type),e.didstd) code_name,
@rep_year year_rep,
IFNULL(e.all_visit,0) all_visit,
IFNULL(e.all_drug,0) all_drug,
IFNULL(e.uc_visit,0) uc_visit,
IFNULL(e.uc_drug,0) uc_drug,
IFNULL(e.all_visit_error,0) all_visit_error,
IFNULL(e.all_drug_error,0) all_drug_error,
IFNULL(e.uc_visit_error,0) uc_visit_error,
IFNULL(e.uc_drug_error,0) uc_drug_error
FROM chospital o 
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE, 
e.DIDSTD didstd,
e.drug_name, 
e.drug_type,
@rep_year year_rep, 
COUNT(DISTINCT CONCAT(e.PID,'-',e.SEQ)) as all_visit, 
COUNT(*) as all_drug, 
COUNT(DISTINCT (IF(s.INSTYPE='0100',CONCAT(e.PID,'-',e.SEQ),NULL))) as uc_visit , 
COUNT(IF(s.INSTYPE='0100',1,NULL)) as uc_drug,
COUNT(DISTINCT IF(e.PASS IS NULL,CONCAT(e.PID,'-',e.SEQ),NULL)) as all_visit_error, 
COUNT(IF(e.PASS IS NULL,CONCAT(e.PID,'-',e.SEQ),NULL)) as all_drug_error, 
COUNT(DISTINCT (IF(s.INSTYPE='0100' AND e.PASS IS NULL,CONCAT(e.PID,'-',e.SEQ),NULL))) as uc_visit_error , 
COUNT(IF(s.INSTYPE='0100' AND e.PASS IS NULL,1,NULL)) as uc_drug_error  
FROM 
tmp_planthai_drug_use e
LEFT JOIN tmp_service s ON e.HOSPCODE = s.HOSPCODE AND e.PID = s.PID AND e.SEQ = s.SEQ 
GROUP BY e.HOSPCODE, e.DIDSTD ) e ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.didstd IS NOT NULL ;

/**************ttm5**********************/
DROP TABLE IF  EXISTS t_ttm_opd_5;
CREATE TABLE IF NOT EXISTS t_ttm_opd_5( 
PRIMARY KEY (hospcode,didstd,instype),
KEY (hospcode),
KEY (didstd),
KEY (instype)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
o.hoscode hospcode , 
e.didstd, 
IFNULL(CONCAT(e.drug_name,', ',e.drug_type),e.didstd) code_name, 
IF(e.INSTYPE='0100','UC','OTHER') instype, 
@rep_year year_rep, 
IFNULL(e.total_pt_q1,0) total_pt_q1, 
IFNULL(e.total_q1,0) total_q1, 
IFNULL(e.total_amount_q1,0) total_amount_q1, 
IFNULL(e.total_price_q1,0) total_price_q1, 
IFNULL(e.total_cost_q1,0) total_cost_q1, 
IFNULL(e.total_pt_q2,0) total_pt_q2, 
IFNULL(e.total_q2,0) total_q2, 
IFNULL(e.total_amount_q2,0) total_amount_q2, 
IFNULL(e.total_price_q2,0) total_price_q2, 
IFNULL(e.total_cost_q2,0) total_cost_q2, 
IFNULL(e.total_pt_q3,0) total_pt_q3, 
IFNULL(e.total_q3,0) total_q3, 
IFNULL(e.total_amount_q3,0) total_amount_q3, 
IFNULL(e.total_price_q3,0) total_price_q3, 
IFNULL(e.total_cost_q3,0) total_cost_q3, 
IFNULL(e.total_pt_q4,0) total_pt_q4, 
IFNULL(e.total_q4,0) total_q4, 
IFNULL(e.total_amount_q4,0) total_amount_q4, 
IFNULL(e.total_price_q4,0) total_price_q4, 
IFNULL(e.total_cost_q4,0) total_cost_q4 
FROM chospital o 
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE, 
e.DIDSTD didstd,
e.drug_name, 
e.drug_type,
s.INSTYPE,
@rep_year year_rep, 
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) total_pt_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q1,
SUM(IF(MONTH(e.DATE_SERV) IN (10,11,12),e.AMOUNT,0)) total_amount_q1,
SUM(IF(MONTH(e.DATE_SERV) IN (10,11,12),e.AMOUNT*e.DRUGPRICE,0)) total_price_q1,
SUM(IF(MONTH(e.DATE_SERV) IN (10,11,12),e.AMOUNT*e.DRUGCOST,0)) total_cost_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) total_pt_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q2,
SUM(IF(MONTH(e.DATE_SERV) IN (1,2,3),e.AMOUNT,0)) total_amount_q2,
SUM(IF(MONTH(e.DATE_SERV) IN (1,2,3),e.AMOUNT*e.DRUGPRICE,0)) total_price_q2,
SUM(IF(MONTH(e.DATE_SERV) IN (1,2,3),e.AMOUNT*e.DRUGCOST,0)) total_cost_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) total_pt_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q3,
SUM(IF(MONTH(e.DATE_SERV) IN (4,5,6),e.AMOUNT,0)) total_amount_q3,
SUM(IF(MONTH(e.DATE_SERV) IN (4,5,6),e.AMOUNT*e.DRUGPRICE,0)) total_price_q3,
SUM(IF(MONTH(e.DATE_SERV) IN (4,5,6),e.AMOUNT*e.DRUGCOST,0)) total_cost_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) total_pt_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q4,
SUM(IF(MONTH(e.DATE_SERV) IN (7,8,9),e.AMOUNT,0)) total_amount_q4,
SUM(IF(MONTH(e.DATE_SERV) IN (7,8,9),e.AMOUNT*e.DRUGPRICE,0)) total_price_q4,
SUM(IF(MONTH(e.DATE_SERV) IN (7,8,9),e.AMOUNT*e.DRUGCOST,0)) total_cost_q4
FROM 
tmp_planthai_drug_use e
LEFT JOIN tmp_service s ON e.HOSPCODE = s.HOSPCODE AND e.PID = s.PID AND e.SEQ = s.SEQ 
GROUP BY e.HOSPCODE,IF(s.INSTYPE='0100','UC','OTHER'), e.DIDSTD ) e ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.HOSPCODE IS NOT NULL  AND e.didstd IS NOT NULL ;

 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.23106;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:419;a:5:{i:0;s:12670:"CREATE PROCEDURE t_ttm1_5()
 BEGIN 
SET @provid = '58';
SET@id:= '65';
SET @rep_year = (SELECT yearprocess FROM sys_config LIMIT 1);

/**********ttm1*****************/
DROP TEMPORARY TABLE IF  EXISTS mother_service;
CREATE TEMPORARY TABLE IF NOT EXISTS 
mother_service (INDEX(CID)) 
ENGINE=MYISAM IGNORE AS 
SELECT 
e.HOSPCODE, 
e.PID, 
e.SEQ, 
e.DATE_SERV,
s.INSTYPE,
GROUP_CONCAT(e.PROCEDCODE) PROCEDCODE,
p.BIRTH,
p.CID,
LENGTH(GROUP_CONCAT(e.PROCEDCODE)) length_str
FROM tmp_procedure_opd e 
LEFT JOIN tmp_service s ON e.HOSPCODE = s.HOSPCODE AND e.PID = s.PID AND e.SEQ = s.SEQ 
LEFT JOIN person p ON e.HOSPCODE = p.HOSPCODE AND e.PID = p.PID AND s.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
WHERE e.PROCEDCODE IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND 
e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') AND 
p.SEX = 2 
GROUP BY e.HOSPCODE, e.PID, e.SEQ 
;

DROP TEMPORARY TABLE IF  EXISTS labor_rep;
CREATE TEMPORARY TABLE IF NOT EXISTS 
labor_rep (INDEX(CID)) 
ENGINE=MYISAM IGNORE AS 
SELECT 
p.CID,
l.BDATE
FROM 
tmp_labor l
LEFT JOIN person p ON l.HOSPCODE = p.HOSPCODE AND l.PID = p.PID  
WHERE 
l.BDATE BETWEEN CONCAT((@rep_year-1),'0701') AND CONCAT(@rep_year,'0930') AND 
p.CID IS NOT NULL 
GROUP BY p.CID 
;

DROP TABLE IF  EXISTS t_ttm_opd_1;
CREATE TABLE IF NOT EXISTS t_ttm_opd_1( 
PRIMARY KEY (hospcode,code_rep ),
KEY (hospcode)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT SQL_BIG_RESULT
e.HOSPCODE ,
CONCAT(e.HOSPCODE,'-',e.PID) code_rep,
@rep_year year_rep,
TIMESTAMPDIFF(YEAR,e.BIRTH,e.DATE_SERV) age,
MIN(e.DATE_SERV) begin_date_serv,
COUNT(DISTINCT   l.CID) all_mother,
COUNT(IF(e.length_str=39,1,NULL)) have_service,
COUNT(1) all_service,
COUNT(IF(e.PROCEDCODE LIKE '%9007712%',1,NULL)) ttm_service,
IF(DATEDIFF(MIN(e.DATE_SERV),l.BDATE) BETWEEN 0 AND 45,0,1) not_in_time,
IF(DATEDIFF(MAX(e.DATE_SERV),MIN(e.DATE_SERV)) BETWEEN 0 AND 90,0,1) not_less90days,

COUNT(DISTINCT IF(e.INSTYPE='0100',l.CID,NULL)) all_uc_mother,
COUNT(IF(e.length_str=39 AND e.INSTYPE='0100',1,NULL)) uc_have_service,
COUNT(IF(e.INSTYPE='0100',1,NULL)) uc_all_service,
IF(e.INSTYPE='0100',IF(DATEDIFF(MIN(e.DATE_SERV),l.BDATE) BETWEEN 0 AND 45,0,1),0) uc_not_in_time,
IF(e.INSTYPE='0100',IF(DATEDIFF(MAX(e.DATE_SERV),MIN(e.DATE_SERV)) BETWEEN 0 AND 90,0,1),0) uc_not_less90days 
FROM mother_service e 
LEFT JOIN labor_rep l ON l.CID = e.CID
LEFT JOIN chospital i ON e.HOSPCODE = i.hoscode 
WHERE 
i.provcode=@provid 
GROUP BY e.HOSPCODE, e.PID ;

/**********ttm2*****************/
DROP TABLE IF  EXISTS tmp_planthai_drug_use;
CREATE  TABLE IF NOT EXISTS 
tmp_planthai_drug_use (INDEX(HOSPCODE),INDEX(PID),INDEX(SEQ)) 
ENGINE=MYISAM IGNORE AS 
SELECT
e.HOSPCODE,
e.PID,
e.SEQ,
e.DATE_SERV,
e.DIDSTD,
e.AMOUNT,
e.DRUGPRICE,
e.DRUGCOST,
d.didstd PASS,
d.drug_name,
d.drug_type ,
d.ed
FROM 
tmp_drug_opd e 
LEFT JOIN cdrug_planthai d ON d.didstd=e.DIDSTD 
WHERE
e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIDSTD,2) IN ('41','42') 
;

DROP TABLE IF  EXISTS t_ttm_opd_2;
CREATE TABLE IF NOT EXISTS t_ttm_opd_2( 
PRIMARY KEY (hospcode,code_rep ),
KEY (hospcode)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
e.HOSPCODE ,
IFNULL(e.code_rep,CONCAT(@rep_year,'-07')) code_rep,
IFNULL(
IF(e.code_name=1,'มกราคม',
IF(e.code_name=2,'กุมภาพันธ์',
IF(e.code_name=3,'มีนาคม',
IF(e.code_name=4,'เมษายน',
IF(e.code_name=5,'พฤษภาคม',
IF(e.code_name=6,'มิถุนายน',
IF(e.code_name=7,'กรกฏาคม',
IF(e.code_name=8,'สิงหาคม',
IF(e.code_name=9,'กันยายน',
IF(e.code_name=10,'ตุลาคม',
IF(e.code_name=11,'พฤศจิกายน',
'ธันวาคม')))))))))))
,'กรกฏาคม') code_name,
IFNULL(e.year_rep,@rep_year) year_rep,
IFNULL(e.all_visit,0) all_visit,
IFNULL(e.all_drug,0) all_drug,
IFNULL(e.uc_visit,0) uc_visit,
IFNULL(e.uc_drug,0) uc_drug,
IFNULL(e.all_visit_error,0) all_visit_error,
IFNULL(e.all_drug_error,0) all_drug_error,
IFNULL(e.uc_visit_error,0) uc_visit_error,
IFNULL(e.uc_drug_error,0) uc_drug_error
FROM chospital o 
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE, 
LEFT(DATE(e.DATE_SERV),7) code_rep,
MONTH(e.DATE_SERV) code_name,
@rep_year year_rep, 
COUNT(DISTINCT CONCAT(e.PID,'-',e.SEQ)) as all_visit, 
COUNT(*) as all_drug, 
COUNT(DISTINCT (IF(s.INSTYPE='0100',CONCAT(e.PID,'-',e.SEQ),NULL))) as uc_visit , 
COUNT(IF(s.INSTYPE='0100',1,NULL)) as uc_drug,
COUNT(DISTINCT IF(e.PASS IS NULL,CONCAT(e.PID,'-',e.SEQ),NULL)) as all_visit_error, 
COUNT(IF(e.PASS IS NULL,CONCAT(e.PID,'-',e.SEQ),NULL)) as all_drug_error, 
COUNT(DISTINCT (IF(s.INSTYPE='0100' AND e.PASS IS NULL,CONCAT(e.PID,'-',e.SEQ),NULL))) as uc_visit_error , 
COUNT(IF(s.INSTYPE='0100' AND e.PASS IS NULL,1,NULL)) as uc_drug_error  
FROM 
tmp_planthai_drug_use e
LEFT JOIN tmp_service s ON e.HOSPCODE = s.HOSPCODE AND e.PID = s.PID AND e.SEQ = s.SEQ 
GROUP BY e.HOSPCODE, MONTH(e.DATE_SERV) 
) e ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid  AND e.code_rep IS NOT NULL ;

/***************ttm3****************/
DROP TABLE IF  EXISTS t_ttm_opd_3;
CREATE TABLE IF NOT EXISTS t_ttm_opd_3( 
PRIMARY KEY (hospcode,servplace,age,sex),
KEY (hospcode),
KEY (servplace),
KEY (age),
KEY (sex)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
e.HOSPCODE ,
e.servplace,
e.age,
e.sex,
@rep_year year_rep,
IFNULL(e.total_pt_q1,0) total_pt_q1,	
IFNULL(e.total_q1,0) total_q1,
IFNULL(e.didstd_q1,0) didstd_q1,
IFNULL(e.total_pt_q2,0) total_pt_q2,	
IFNULL(e.total_q2,0) total_q2,
IFNULL(e.didstd_q2,0) didstd_q2,
IFNULL(e.total_pt_q3,0) total_pt_q3,	
IFNULL(e.total_q3,0) total_q3,
IFNULL(e.didstd_q3,0) didstd_q3,	
IFNULL(e.total_pt_q4,0) total_pt_q4,	
IFNULL(e.total_q4,0) total_q4,
IFNULL(e.didstd_q4,0) didstd_q4
FROM chospital o 
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE, 
e.DATE_SERV,
s.SERVPLACE servplace,
TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'1001')) age,
p.SEX sex,
@rep_year year_rep, 
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) total_pt_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ,'-',e.DIDSTD),NULL)) didstd_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) total_pt_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ,'-',e.DIDSTD),NULL)) didstd_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) total_pt_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ,'-',e.DIDSTD),NULL)) didstd_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) total_pt_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ,'-',e.DIDSTD),NULL)) didstd_q4 
FROM 
tmp_planthai_drug_use e
LEFT JOIN tmp_service s ON e.HOSPCODE = s.HOSPCODE AND e.PID = s.PID AND e.SEQ = s.SEQ 
LEFT JOIN person p ON e.HOSPCODE = p.HOSPCODE AND e.PID = p.PID 
GROUP BY e.HOSPCODE, s.SERVPLACE, p.SEX, TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'1001'))
) e ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.servplace IN ('1','2') AND e.HOSPCODE IS NOT NULL ;

/*********************ttm4**************/
DROP TABLE IF  EXISTS t_ttm_opd_4;
CREATE TABLE IF NOT EXISTS t_ttm_opd_4( 
PRIMARY KEY (hospcode,didstd),
KEY (hospcode),
KEY (didstd)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
o.hoscode hospcode ,
e.didstd,
IFNULL(CONCAT(e.drug_name,', ',e.drug_type),e.didstd) code_name,
@rep_year year_rep,
IFNULL(e.all_visit,0) all_visit,
IFNULL(e.all_drug,0) all_drug,
IFNULL(e.uc_visit,0) uc_visit,
IFNULL(e.uc_drug,0) uc_drug,
IFNULL(e.all_visit_error,0) all_visit_error,
IFNULL(e.all_drug_error,0) all_drug_error,
IFNULL(e.uc_visit_error,0) uc_visit_error,
IFNULL(e.uc_drug_error,0) uc_drug_error
FROM chospital o 
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE, 
e.DIDSTD didstd,
e.drug_name, 
e.drug_type,
@rep_year year_rep, 
COUNT(DISTINCT CONCAT(e.PID,'-',e.SEQ)) as all_visit, 
COUNT(*) as all_drug, 
COUNT(DISTINCT (IF(s.INSTYPE='0100',CONCAT(e.PID,'-',e.SEQ),NULL))) as uc_visit , 
COUNT(IF(s.INSTYPE='0100',1,NULL)) as uc_drug,
COUNT(DISTINCT IF(e.PASS IS NULL,CONCAT(e.PID,'-',e.SEQ),NULL)) as all_visit_error, 
COUNT(IF(e.PASS IS NULL,CONCAT(e.PID,'-',e.SEQ),NULL)) as all_drug_error, 
COUNT(DISTINCT (IF(s.INSTYPE='0100' AND e.PASS IS NULL,CONCAT(e.PID,'-',e.SEQ),NULL))) as uc_visit_error , 
COUNT(IF(s.INSTYPE='0100' AND e.PASS IS NULL,1,NULL)) as uc_drug_error  
FROM 
tmp_planthai_drug_use e
LEFT JOIN tmp_service s ON e.HOSPCODE = s.HOSPCODE AND e.PID = s.PID AND e.SEQ = s.SEQ 
GROUP BY e.HOSPCODE, e.DIDSTD ) e ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.didstd IS NOT NULL ;

/**************ttm5**********************/
DROP TABLE IF  EXISTS t_ttm_opd_5;
CREATE TABLE IF NOT EXISTS t_ttm_opd_5( 
PRIMARY KEY (hospcode,didstd,instype),
KEY (hospcode),
KEY (didstd),
KEY (instype)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
o.hoscode hospcode , 
e.didstd, 
IFNULL(CONCAT(e.drug_name,', ',e.drug_type),e.didstd) code_name, 
IF(e.INSTYPE='0100','UC','OTHER') instype, 
@rep_year year_rep, 
IFNULL(e.total_pt_q1,0) total_pt_q1, 
IFNULL(e.total_q1,0) total_q1, 
IFNULL(e.total_amount_q1,0) total_amount_q1, 
IFNULL(e.total_price_q1,0) total_price_q1, 
IFNULL(e.total_cost_q1,0) total_cost_q1, 
IFNULL(e.total_pt_q2,0) total_pt_q2, 
IFNULL(e.total_q2,0) total_q2, 
IFNULL(e.total_amount_q2,0) total_amount_q2, 
IFNULL(e.total_price_q2,0) total_price_q2, 
IFNULL(e.total_cost_q2,0) total_cost_q2, 
IFNULL(e.total_pt_q3,0) total_pt_q3, 
IFNULL(e.total_q3,0) total_q3, 
IFNULL(e.total_amount_q3,0) total_amount_q3, 
IFNULL(e.total_price_q3,0) total_price_q3, 
IFNULL(e.total_cost_q3,0) total_cost_q3, 
IFNULL(e.total_pt_q4,0) total_pt_q4, 
IFNULL(e.total_q4,0) total_q4, 
IFNULL(e.total_amount_q4,0) total_amount_q4, 
IFNULL(e.total_price_q4,0) total_price_q4, 
IFNULL(e.total_cost_q4,0) total_cost_q4 
FROM chospital o 
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE, 
e.DIDSTD didstd,
e.drug_name, 
e.drug_type,
s.INSTYPE,
@rep_year year_rep, 
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) total_pt_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q1,
SUM(IF(MONTH(e.DATE_SERV) IN (10,11,12),e.AMOUNT,0)) total_amount_q1,
SUM(IF(MONTH(e.DATE_SERV) IN (10,11,12),e.AMOUNT*e.DRUGPRICE,0)) total_price_q1,
SUM(IF(MONTH(e.DATE_SERV) IN (10,11,12),e.AMOUNT*e.DRUGCOST,0)) total_cost_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) total_pt_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q2,
SUM(IF(MONTH(e.DATE_SERV) IN (1,2,3),e.AMOUNT,0)) total_amount_q2,
SUM(IF(MONTH(e.DATE_SERV) IN (1,2,3),e.AMOUNT*e.DRUGPRICE,0)) total_price_q2,
SUM(IF(MONTH(e.DATE_SERV) IN (1,2,3),e.AMOUNT*e.DRUGCOST,0)) total_cost_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) total_pt_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q3,
SUM(IF(MONTH(e.DATE_SERV) IN (4,5,6),e.AMOUNT,0)) total_amount_q3,
SUM(IF(MONTH(e.DATE_SERV) IN (4,5,6),e.AMOUNT*e.DRUGPRICE,0)) total_price_q3,
SUM(IF(MONTH(e.DATE_SERV) IN (4,5,6),e.AMOUNT*e.DRUGCOST,0)) total_cost_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) total_pt_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q4,
SUM(IF(MONTH(e.DATE_SERV) IN (7,8,9),e.AMOUNT,0)) total_amount_q4,
SUM(IF(MONTH(e.DATE_SERV) IN (7,8,9),e.AMOUNT*e.DRUGPRICE,0)) total_price_q4,
SUM(IF(MONTH(e.DATE_SERV) IN (7,8,9),e.AMOUNT*e.DRUGCOST,0)) total_cost_q4
FROM 
tmp_planthai_drug_use e
LEFT JOIN tmp_service s ON e.HOSPCODE = s.HOSPCODE AND e.PID = s.PID AND e.SEQ = s.SEQ 
GROUP BY e.HOSPCODE,IF(s.INSTYPE='0100','UC','OTHER'), e.DIDSTD ) e ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.HOSPCODE IS NOT NULL  AND e.didstd IS NOT NULL ;

 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.2778599;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:421;a:5:{i:0;s:34:"DROP PROCEDURE IF EXISTS t_ttm6_10";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.2778599;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:422;a:5:{i:0;s:34:"DROP PROCEDURE IF EXISTS t_ttm6_10";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.34026;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:424;a:5:{i:0;s:40399:"CREATE PROCEDURE t_ttm6_10()
 BEGIN 
SET @provid = '58';
SET@id:= '66';
SET @rep_year = (SELECT yearprocess FROM sys_config LIMIT 1);
/*************ttm6*************/
DROP TEMPORARY TABLE IF  EXISTS tmp_planthai_diag_clinic;
CREATE TEMPORARY TABLE IF NOT EXISTS 
tmp_planthai_diag_clinic (INDEX(HOSPCODE),INDEX(PID),INDEX(SEQ)) 
ENGINE=MYISAM IGNORE AS 
SELECT 
e.HOSPCODE, 
e.PID, 
e.SEQ, 
e.DATE_SERV, 
e.DIAGCODE
FROM 
tmp_diag_opd e 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND (e.DIAGCODE IN ('U5750', 'U5752', 'U5753', 'U5755', 'U5759', 'U7141', 'U7142', 'U610', 'U611', 'U6110', 'U6111', 'U6112', 'U6113', 'U6114', 'U6115', 'U6118', 'U6119', 'U612', 'U743', 'U5943')
OR e.DIAGCODE BETWEEN 'M17' AND 'M179'
OR e.DIAGCODE BETWEEN 'G81' AND 'G839'
OR e.DIAGCODE BETWEEN 'J301' AND 'J304'
OR e.DIAGCODE BETWEEN 'G43' AND 'G439')
;

DROP TEMPORARY TABLE IF  EXISTS tmp_planthai_diag_clinic_u;
CREATE TEMPORARY TABLE IF NOT EXISTS 
tmp_planthai_diag_clinic_u (INDEX(HOSPCODE),INDEX(PID),INDEX(SEQ)) 
ENGINE=MYISAM IGNORE AS 
SELECT 
e.HOSPCODE, 
e.PID, 
e.SEQ, 
e.DATE_SERV, 
e.DIAGCODE
FROM 
tmp_diag_opd e 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND e.DIAGCODE IN ('U5750', 'U5752', 'U5753', 'U5755', 'U5759', 'U7141', 'U7142', 'U610', 'U611', 'U6110', 'U6111', 'U6112', 'U6113', 'U6114', 'U6115', 'U6118', 'U6119', 'U612', 'U743', 'U5943')
;

DROP TABLE IF  EXISTS t_ttm_opd_6;
CREATE TABLE IF NOT EXISTS t_ttm_opd_6( 
PRIMARY KEY (hospcode,instype),
KEY (hospcode),
KEY (instype)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT SQL_BIG_RESULT 
e.HOSPCODE , 
IF(s.INSTYPE='0100','UC','OTHER') instype,
@rep_year year_rep,  

COUNT(DISTINCT IF(e.DIAGCODE='U5750' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u5750_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U5750' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u5750_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U5750' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u5750_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U5750' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u5750_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U5752' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u5752_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U5752' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u5752_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U5752' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u5752_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U5752' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u5752_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U5753' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u5753_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U5753' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u5753_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U5753' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u5753_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U5753' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u5753_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U5755' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u5755_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U5755' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u5755_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U5755' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u5755_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U5755' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u5755_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U5759' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u5759_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U5759' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u5759_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U5759' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u5759_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U5759' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u5759_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U7141' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u7141_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U7141' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u7141_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U7141' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u7141_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U7141' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u7141_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U7142' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u7142_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U7142' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u7142_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U7142' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u7142_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U7142' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u7142_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U612' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u612_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U612' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u612_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U612' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u612_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U612' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u612_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U743' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u743_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U743' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u743_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U743' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u743_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U743' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u743_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U5943' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u5943_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U5943' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u5943_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U5943' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u5943_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U5943' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u5943_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U610' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u610_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U610' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u610_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U610' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u610_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U610' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u610_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U611' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u611_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U611' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u611_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U611' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u611_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U611' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u611_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U6110' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u6110_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U6110' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u6110_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U6110' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u6110_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U6110' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u6110_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U6111' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u6111_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U6111' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u6111_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U6111' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u6111_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U6111' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u6111_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U6112' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u6112_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U6112' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u6112_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U6112' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u6112_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U6112' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u6112_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U6113' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u6113_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U6113' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u6113_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U6113' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u6113_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U6113' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u6113_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U6114' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u6114_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U6114' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u6114_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U6114' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u6114_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U6114' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u6114_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U6115' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u6115_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U6115' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u6115_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U6115' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u6115_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U6115' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u6115_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U6118' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u6118_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U6118' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u6118_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U6118' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u6118_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U6118' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u6118_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U6119' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u6119_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U6119' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u6119_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U6119' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u6119_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U6119' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u6119_q4,

COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'M17' AND 'M179' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) m179_q1,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'M17' AND 'M179' AND e2.DIAGCODE IN ('U5750', 'U5752', 'U5753', 'U5755', 'U5759', 'U7141', 'U7142') AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_m179_q1,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'M17' AND 'M179' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) m179_q2,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'M17' AND 'M179' AND e2.DIAGCODE IN ('U5750', 'U5752', 'U5753', 'U5755', 'U5759', 'U7141', 'U7142') AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_m179_q2,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'M17' AND 'M179' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) m179_q3,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'M17' AND 'M179' AND e2.DIAGCODE IN ('U5750', 'U5752', 'U5753', 'U5755', 'U5759', 'U7141', 'U7142') AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_m179_q3,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'M17' AND 'M179' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) m179_q4,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'M17' AND 'M179' AND e2.DIAGCODE IN ('U5750', 'U5752', 'U5753', 'U5755', 'U5759', 'U7141', 'U7142') AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_m179_q4,


COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G81' AND 'G839' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) g431_q1,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G81' AND 'G839' AND e2.DIAGCODE = 'U612' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_g431_q1,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G81' AND 'G839' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) g431_q2,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G81' AND 'G839' AND e2.DIAGCODE = 'U612' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_g431_q2,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G81' AND 'G839' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) g431_q3,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G81' AND 'G839' AND e2.DIAGCODE = 'U612' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_g431_q3,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G81' AND 'G839' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) g431_q4,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G81' AND 'G839' AND e2.DIAGCODE = 'U612' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_g431_q4,

COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'J301' AND 'J304' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) j304_q1,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'J301' AND 'J304' AND e2.DIAGCODE IN ('U743','UU5943') AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_j304_q1,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'J301' AND 'J304' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) j304_q2,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'J301' AND 'J304' AND e2.DIAGCODE IN ('U743','UU5943') AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_j304_q2,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'J301' AND 'J304' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) j304_q3,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'J301' AND 'J304' AND e2.DIAGCODE IN ('U743','UU5943') AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_j304_q3,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'J301' AND 'J304' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) j304_q4,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'J301' AND 'J304' AND e2.DIAGCODE IN ('U743','UU5943') AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_j304_q4,

COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G43' AND 'G439' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) g819_q1,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G43' AND 'G439' AND e2.DIAGCODE IN ('U610', 'U611', 'U6110', 'U6111', 'U6112', 'U6113', 'U6114', 'U6115', 'U6118', 'U6119') AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_g819_q1,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G43' AND 'G439' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) g819_q2,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G43' AND 'G439' AND e2.DIAGCODE IN ('U610', 'U611', 'U6110', 'U6111', 'U6112', 'U6113', 'U6114', 'U6115', 'U6118', 'U6119') AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_g819_q2,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G43' AND 'G439' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) g819_q3,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G43' AND 'G439' AND e2.DIAGCODE IN ('U610', 'U611', 'U6110', 'U6111', 'U6112', 'U6113', 'U6114', 'U6115', 'U6118', 'U6119') AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_g819_q3,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G43' AND 'G439' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) g819_q4,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G43' AND 'G439' AND e2.DIAGCODE IN ('U610', 'U611', 'U6110', 'U6111', 'U6112', 'U6113', 'U6114', 'U6115', 'U6118', 'U6119') AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_g819_q4
FROM 
tmp_planthai_diag_clinic e 
LEFT JOIN tmp_service s ON s.HOSPCODE = e.HOSPCODE AND s.PID = e.PID AND s.SEQ = e.SEQ 
LEFT JOIN tmp_planthai_diag_clinic_u e2 ON e.HOSPCODE = e2.HOSPCODE AND e.PID = e2.PID AND e.SEQ = e2.SEQ 
LEFT JOIN chospital o ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.HOSPCODE IS NOT NULL 
GROUP BY e.HOSPCODE, IF(s.INSTYPE='0100','UC','OTHER') ;

/****************ttm7*************/
DROP TABLE IF  EXISTS t_ttm_opd_7;
CREATE TABLE IF NOT EXISTS t_ttm_opd_7( 
PRIMARY KEY (hospcode,code_rep),
KEY (hospcode),
KEY (code_rep),
KEY (code_name)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS

SELECT SQL_BIG_RESULT
e.HOSPCODE ,
LEFT(DATE(e.DATE_SERV),7) code_rep,
IF(MONTH(e.DATE_SERV)=1,'มกราคม',
IF(MONTH(e.DATE_SERV)=2,'กุมภาพันธ์',
IF(MONTH(e.DATE_SERV)=3,'มีนาคม',
IF(MONTH(e.DATE_SERV)=4,'เมษายน',
IF(MONTH(e.DATE_SERV)=5,'พฤษภาคม',
IF(MONTH(e.DATE_SERV)=6,'มิถุนายน',
IF(MONTH(e.DATE_SERV)=7,'กรกฏาคม',
IF(MONTH(e.DATE_SERV)=8,'สิงหาคม',
IF(MONTH(e.DATE_SERV)=9,'กันยายน',
IF(MONTH(e.DATE_SERV)=10,'ตุลาคม',
IF(MONTH(e.DATE_SERV)=11,'พฤศจิกายน',
'ธันวาคม'))))))))))) code_name,
@rep_year year_rep,
SUM(IF(LEFT(e.DIDSTD,2) <> '41' AND LEFT(e.DIDSTD,2) <> '42',e.AMOUNT*e.DRUGPRICE,0))  price_drug ,
SUM(IF(LEFT(e.DIDSTD,2) = '41' OR LEFT(e.DIDSTD,2) = '42',e.AMOUNT*e.DRUGPRICE,0))  price_planthai_drug
FROM 
tmp_drug_opd e 
LEFT JOIN chospital i ON e.HOSPCODE = i.hoscode 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930')  AND i.provcode=@provid 
GROUP BY e.HOSPCODE, MONTH(e.DATE_SERV);

/*************ttm8*****************/
DROP TEMPORARY TABLE IF  EXISTS tmp_planthai_procedure;
CREATE TEMPORARY TABLE IF NOT EXISTS 
tmp_planthai_procedure (INDEX(HOSPCODE),INDEX(PID),INDEX(SEQ)) 
ENGINE=MYISAM IGNORE AS 
SELECT 
e.HOSPCODE, 
e.PID, 
e.SEQ, 
e.DATE_SERV, 
e.PROCEDCODE, 
icd.tmtype 
FROM 
tmp_procedure_opd e 
LEFT JOIN cicd9ttm_planthai icd ON icd.`code` = e.PROCEDCODE 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND icd.`code`IS NOT NULL 
;

DROP TABLE IF  EXISTS t_ttm_opd_8;
CREATE TABLE IF NOT EXISTS t_ttm_opd_8( 
PRIMARY KEY (hospcode,instype),
KEY (hospcode),
KEY (instype)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
e.HOSPCODE ,
IF(e.INSTYPE='0100','UC','OTHER') instype,
IFNULL(e.year_rep,@rep_year) year_rep,

IFNULL(e.pt_nod_q1,0) pt_nod_q1,
IFNULL(e.service_nod_q1,0) service_nod_q1,
IFNULL(e.pt_obb_q1,0) pt_obb_q1,
IFNULL(e.service_obb_q1,0) service_obb_q1,
IFNULL(e.pt_cop_q1,0) pt_cop_q1,
IFNULL(e.service_cop_q1,0) service_cop_q1,
IFNULL(e.pt_other_q1,0) pt_other_q1,
IFNULL(e.service_other_q1,0) service_other_q1,
IFNULL(e.pt_total_q1,0) pt_total_q1,
IFNULL(e.service_total_q1,0) service_total_q1,

IFNULL(e.out_pt_nod_q1,0) out_pt_nod_q1,
IFNULL(e.out_service_nod_q1,0) out_service_nod_q1,
IFNULL(e.out_pt_obb_q1,0) out_pt_obb_q1,
IFNULL(e.out_service_obb_q1,0) out_service_obb_q1,
IFNULL(e.out_pt_cop_q1,0) out_pt_cop_q1,
IFNULL(e.out_service_cop_q1,0) out_service_cop_q1,
IFNULL(e.out_pt_other_q1,0) out_pt_other_q1,
IFNULL(e.out_service_other_q1,0) out_service_other_q1,
IFNULL(e.out_pt_total_q1,0) out_pt_total_q1,
IFNULL(e.out_service_total_q1,0) out_service_total_q1,

IFNULL(e.pt_nod_q2,0) pt_nod_q2,
IFNULL(e.service_nod_q2,0) service_nod_q2,
IFNULL(e.pt_obb_q2,0) pt_obb_q2,
IFNULL(e.service_obb_q2,0) service_obb_q2,
IFNULL(e.pt_cop_q2,0) pt_cop_q2,
IFNULL(e.service_cop_q2,0) service_cop_q2,
IFNULL(e.pt_other_q2,0) pt_other_q2,
IFNULL(e.service_other_q2,0) service_other_q2,
IFNULL(e.pt_total_q2,0) pt_total_q2,
IFNULL(e.service_total_q2,0) service_total_q2,

IFNULL(e.out_pt_nod_q2,0) out_pt_nod_q2,
IFNULL(e.out_service_nod_q2,0) out_service_nod_q2,
IFNULL(e.out_pt_obb_q2,0) out_pt_obb_q2,
IFNULL(e.out_service_obb_q2,0) out_service_obb_q2,
IFNULL(e.out_pt_cop_q2,0) out_pt_cop_q2,
IFNULL(e.out_service_cop_q2,0) out_service_cop_q2,
IFNULL(e.out_pt_other_q2,0) out_pt_other_q2,
IFNULL(e.out_service_other_q2,0) out_service_other_q2,
IFNULL(e.out_pt_total_q2,0) out_pt_total_q2,
IFNULL(e.out_service_total_q2,0) out_service_total_q2,

IFNULL(e.pt_nod_q3,0) pt_nod_q3,
IFNULL(e.service_nod_q3,0) service_nod_q3,
IFNULL(e.pt_obb_q3,0) pt_obb_q3,
IFNULL(e.service_obb_q3,0) service_obb_q3,
IFNULL(e.pt_cop_q3,0) pt_cop_q3,
IFNULL(e.service_cop_q3,0) service_cop_q3,
IFNULL(e.pt_other_q3,0) pt_other_q3,
IFNULL(e.service_other_q3,0) service_other_q3,
IFNULL(e.pt_total_q3,0) pt_total_q3,
IFNULL(e.service_total_q3,0) service_total_q3,

IFNULL(e.out_pt_nod_q3,0) out_pt_nod_q3,
IFNULL(e.out_service_nod_q3,0) out_service_nod_q3,
IFNULL(e.out_pt_obb_q3,0) out_pt_obb_q3,
IFNULL(e.out_service_obb_q3,0) out_service_obb_q3,
IFNULL(e.out_pt_cop_q3,0) out_pt_cop_q3,
IFNULL(e.out_service_cop_q3,0) out_service_cop_q3,
IFNULL(e.out_pt_other_q3,0) out_pt_other_q3,
IFNULL(e.out_service_other_q3,0) out_service_other_q3,
IFNULL(e.out_pt_total_q3,0) out_pt_total_q3,
IFNULL(e.out_service_total_q3,0) out_service_total_q3,

IFNULL(e.pt_nod_q4,0) pt_nod_q4,
IFNULL(e.service_nod_q4,0) service_nod_q4,
IFNULL(e.pt_obb_q4,0) pt_obb_q4,
IFNULL(e.service_obb_q4,0) service_obb_q4,
IFNULL(e.pt_cop_q4,0) pt_cop_q4,
IFNULL(e.service_cop_q4,0) service_cop_q4,
IFNULL(e.pt_other_q4,0) pt_other_q4,
IFNULL(e.service_other_q4,0) service_other_q4,
IFNULL(e.pt_total_q4,0) pt_total_q4,
IFNULL(e.service_total_q4,0) service_total_q4,

IFNULL(e.out_pt_nod_q4,0) out_pt_nod_q4,
IFNULL(e.out_service_nod_q4,0) out_service_nod_q4,
IFNULL(e.out_pt_obb_q4,0) out_pt_obb_q4,
IFNULL(e.out_service_obb_q4,0) out_service_obb_q4,
IFNULL(e.out_pt_cop_q4,0) out_pt_cop_q4,
IFNULL(e.out_service_cop_q4,0) out_service_cop_q4,
IFNULL(e.out_pt_other_q4,0) out_pt_other_q4,
IFNULL(e.out_service_other_q4,0) out_service_other_q4,
IFNULL(e.out_pt_total_q4,0) out_pt_total_q4,
IFNULL(e.out_service_total_q4,0) out_service_total_q4
FROM chospital o
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE, 
s.INSTYPE,
s.SERVPLACE,
@rep_year year_rep,  

COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) pt_nod_q1,
COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) service_nod_q1,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) pt_obb_q1,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) service_obb_q1,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) pt_cop_q1,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) service_cop_q1,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) pt_other_q1,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) service_other_q1,
COUNT(DISTINCT IF(s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) pt_total_q1,
COUNT(DISTINCT IF(s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) service_total_q1,

COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) out_pt_nod_q1,
COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_nod_q1,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) out_pt_obb_q1,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_obb_q1,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) out_pt_cop_q1,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_cop_q1,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) out_pt_other_q1,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_other_q1,
COUNT(DISTINCT IF(s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) out_pt_total_q1,
COUNT(DISTINCT IF(s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_total_q1,

COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) pt_nod_q2,
COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) service_nod_q2,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) pt_obb_q2,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) service_obb_q2,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) pt_cop_q2,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) service_cop_q2,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) pt_other_q2,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) service_other_q2,
COUNT(DISTINCT IF(s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) pt_total_q2,
COUNT(DISTINCT IF(s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) service_total_q2,

COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) out_pt_nod_q2,
COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_nod_q2,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) out_pt_obb_q2,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_obb_q2,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) out_pt_cop_q2,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_cop_q2,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) out_pt_other_q2,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_other_q2,
COUNT(DISTINCT IF(s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) out_pt_total_q2,
COUNT(DISTINCT IF(s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_total_q2,

COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) pt_nod_q3,
COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) service_nod_q3,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) pt_obb_q3,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) service_obb_q3,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) pt_cop_q3,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) service_cop_q3,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) pt_other_q3,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) service_other_q3,
COUNT(DISTINCT IF(s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) pt_total_q3,
COUNT(DISTINCT IF(s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) service_total_q3,

COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) out_pt_nod_q3,
COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_nod_q3,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) out_pt_obb_q3,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_obb_q3,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) out_pt_cop_q3,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_cop_q3,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) out_pt_other_q3,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_other_q3,
COUNT(DISTINCT IF(s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) out_pt_total_q3,
COUNT(DISTINCT IF(s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_total_q3,

COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) pt_nod_q4,
COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) service_nod_q4,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) pt_obb_q4,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) service_obb_q4,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) pt_cop_q4,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) service_cop_q4,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) pt_other_q4,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) service_other_q4,
COUNT(DISTINCT IF(s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) pt_total_q4,
COUNT(DISTINCT IF(s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) service_total_q4,

COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) out_pt_nod_q4,
COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_nod_q4,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) out_pt_obb_q4,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_obb_q4,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) out_pt_cop_q4,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_cop_q4,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) out_pt_other_q4,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_other_q4,
COUNT(DISTINCT IF(s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) out_pt_total_q4,
COUNT(DISTINCT IF(s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_total_q4,
NOW() 
FROM 
tmp_planthai_procedure e 
LEFT JOIN tmp_service s ON s.HOSPCODE = e.HOSPCODE AND s.PID = e.PID AND s.SEQ = e.SEQ 
WHERE s.SERVPLACE IN ('1','2') 
GROUP BY e.HOSPCODE,  IF(s.INSTYPE='0100','UC','OTHER') 
) e ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.HOSPCODE IS NOT NULL ;

/*********************ttm9**************************/
DROP TEMPORARY TABLE IF  EXISTS tmp_planthai_diag_u;
CREATE TEMPORARY TABLE IF NOT EXISTS 
tmp_planthai_diag_u (INDEX(HOSPCODE),INDEX(PID),INDEX(SEQ)) 
ENGINE=MYISAM IGNORE AS 
SELECT 
e.HOSPCODE, 
e.PID, 
e.SEQ, 
e.DATE_SERV, 
e.DIAGCODE, 
d.SEQ DRUG ,
TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'1001')) age,
p.SEX 
FROM 
tmp_diag_opd e 
LEFT JOIN person p ON e.HOSPCODE = p.HOSPCODE AND e.PID = p.PID 
LEFT JOIN tmp_drug_opd d ON d.HOSPCODE = e.HOSPCODE AND d.PID = e.PID AND d.SEQ = e.SEQ AND LEFT(d.DIDSTD,2) IN ('41','42') 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIAGCODE,1) = 'U' AND LEFT(e.DIAGCODE,3)<>'U77' 
;

DROP TABLE IF  EXISTS t_ttm_opd_9;
CREATE TABLE IF NOT EXISTS t_ttm_opd_9( 
PRIMARY KEY (hospcode,instype,diagcode,age,sex),
KEY (hospcode),
KEY (instype),
KEY (diagcode),
KEY (age),
KEY (sex)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS

SELECT 
e.HOSPCODE ,
IF(e.INSTYPE='0100','UC','OTHER') instype,
e.DIAGCODE diagcode,
e.diseasename,
IFNULL(e.year_rep,@rep_year) year_rep,
IFNULL(e.age,0) age,
e.sex,

IFNULL(e.total_pt_q1,0) total_pt_q1,	
IFNULL(e.total_q1,0) total_q1,

IFNULL(e.total_pt_q2,0) total_pt_q2,	
IFNULL(e.total_q2,0) total_q2,

IFNULL(e.total_pt_q3,0) total_pt_q3,	
IFNULL(e.total_q3,0) total_q3,

IFNULL(e.total_pt_q4,0) total_pt_q4,	
IFNULL(e.total_q4,0) total_q4,
IFNULL(e.total_drug,0) total_drug
FROM chospital o
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE, 
s.INSTYPE,
e.DIAGCODE,
IFNULL(d.diseasethai,e.DIAGCODE) diseasename,
@rep_year year_rep,  
e.age age,
e.SEX sex,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) total_pt_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q1,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) total_pt_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q2,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) total_pt_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q3,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) total_pt_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q4,

COUNT(DISTINCT e.DRUG) total_drug
FROM 
tmp_planthai_diag_u e 
LEFT JOIN tmp_service s ON s.HOSPCODE = e.HOSPCODE AND s.PID = e.PID AND s.SEQ = e.SEQ 
LEFT JOIN cdisease d ON d.diagcode = e.DIAGCODE 
WHERE e.SEX IN (1,2)
GROUP BY e.HOSPCODE, IF(s.INSTYPE='0100','UC','OTHER'), e.DIAGCODE , e.age , e.SEX 
) e ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.HOSPCODE IS NOT NULL ;

/***********************ttm10******************/
DROP TABLE IF  EXISTS t_ttm_opd_10;
CREATE TABLE IF NOT EXISTS t_ttm_opd_10( 
PRIMARY KEY (hospcode,instype),
KEY (hospcode),
KEY (instype)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS

SELECT SQL_BIG_RESULT 
e.HOSPCODE ,
IF(s.INSTYPE='0100','UC','OTHER') instype,
@rep_year year_rep,

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) ed_pt_q1,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) non_ed_pt_q1,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) other_pt_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) total_pt_q1,	

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) ed_q1,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) non_ed_q1,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) other_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q1,	

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) ed_pt_q2,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) non_ed_pt_q2,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) other_pt_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) total_pt_q2,	

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) ed_q2,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) non_ed_q2,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) other_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q2,	

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) ed_pt_q3,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) non_ed_pt_q3,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) other_pt_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) total_pt_q3,	

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) ed_q3,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) non_ed_q3,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) other_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q3,	
 
COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) ed_pt_q4,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) non_ed_pt_q4,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) other_pt_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) total_pt_q4,	

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) ed_q4,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) non_ed_q4,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) other_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q4 
FROM 
tmp_planthai_drug_use e
LEFT JOIN tmp_service s ON e.HOSPCODE = s.HOSPCODE AND e.PID = s.PID AND e.SEQ = s.SEQ 
LEFT JOIN chospital o ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.HOSPCODE IS NOT NULL  AND e.DIDSTD IS NOT NULL 
GROUP BY e.HOSPCODE, IF(s.INSTYPE='0100','UC','OTHER');


 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.34026;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:425;a:5:{i:0;s:40399:"CREATE PROCEDURE t_ttm6_10()
 BEGIN 
SET @provid = '58';
SET@id:= '66';
SET @rep_year = (SELECT yearprocess FROM sys_config LIMIT 1);
/*************ttm6*************/
DROP TEMPORARY TABLE IF  EXISTS tmp_planthai_diag_clinic;
CREATE TEMPORARY TABLE IF NOT EXISTS 
tmp_planthai_diag_clinic (INDEX(HOSPCODE),INDEX(PID),INDEX(SEQ)) 
ENGINE=MYISAM IGNORE AS 
SELECT 
e.HOSPCODE, 
e.PID, 
e.SEQ, 
e.DATE_SERV, 
e.DIAGCODE
FROM 
tmp_diag_opd e 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND (e.DIAGCODE IN ('U5750', 'U5752', 'U5753', 'U5755', 'U5759', 'U7141', 'U7142', 'U610', 'U611', 'U6110', 'U6111', 'U6112', 'U6113', 'U6114', 'U6115', 'U6118', 'U6119', 'U612', 'U743', 'U5943')
OR e.DIAGCODE BETWEEN 'M17' AND 'M179'
OR e.DIAGCODE BETWEEN 'G81' AND 'G839'
OR e.DIAGCODE BETWEEN 'J301' AND 'J304'
OR e.DIAGCODE BETWEEN 'G43' AND 'G439')
;

DROP TEMPORARY TABLE IF  EXISTS tmp_planthai_diag_clinic_u;
CREATE TEMPORARY TABLE IF NOT EXISTS 
tmp_planthai_diag_clinic_u (INDEX(HOSPCODE),INDEX(PID),INDEX(SEQ)) 
ENGINE=MYISAM IGNORE AS 
SELECT 
e.HOSPCODE, 
e.PID, 
e.SEQ, 
e.DATE_SERV, 
e.DIAGCODE
FROM 
tmp_diag_opd e 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND e.DIAGCODE IN ('U5750', 'U5752', 'U5753', 'U5755', 'U5759', 'U7141', 'U7142', 'U610', 'U611', 'U6110', 'U6111', 'U6112', 'U6113', 'U6114', 'U6115', 'U6118', 'U6119', 'U612', 'U743', 'U5943')
;

DROP TABLE IF  EXISTS t_ttm_opd_6;
CREATE TABLE IF NOT EXISTS t_ttm_opd_6( 
PRIMARY KEY (hospcode,instype),
KEY (hospcode),
KEY (instype)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT SQL_BIG_RESULT 
e.HOSPCODE , 
IF(s.INSTYPE='0100','UC','OTHER') instype,
@rep_year year_rep,  

COUNT(DISTINCT IF(e.DIAGCODE='U5750' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u5750_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U5750' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u5750_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U5750' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u5750_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U5750' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u5750_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U5752' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u5752_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U5752' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u5752_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U5752' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u5752_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U5752' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u5752_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U5753' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u5753_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U5753' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u5753_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U5753' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u5753_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U5753' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u5753_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U5755' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u5755_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U5755' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u5755_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U5755' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u5755_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U5755' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u5755_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U5759' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u5759_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U5759' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u5759_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U5759' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u5759_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U5759' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u5759_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U7141' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u7141_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U7141' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u7141_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U7141' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u7141_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U7141' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u7141_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U7142' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u7142_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U7142' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u7142_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U7142' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u7142_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U7142' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u7142_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U612' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u612_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U612' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u612_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U612' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u612_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U612' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u612_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U743' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u743_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U743' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u743_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U743' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u743_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U743' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u743_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U5943' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u5943_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U5943' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u5943_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U5943' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u5943_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U5943' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u5943_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U610' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u610_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U610' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u610_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U610' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u610_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U610' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u610_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U611' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u611_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U611' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u611_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U611' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u611_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U611' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u611_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U6110' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u6110_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U6110' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u6110_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U6110' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u6110_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U6110' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u6110_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U6111' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u6111_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U6111' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u6111_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U6111' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u6111_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U6111' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u6111_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U6112' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u6112_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U6112' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u6112_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U6112' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u6112_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U6112' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u6112_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U6113' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u6113_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U6113' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u6113_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U6113' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u6113_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U6113' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u6113_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U6114' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u6114_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U6114' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u6114_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U6114' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u6114_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U6114' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u6114_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U6115' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u6115_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U6115' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u6115_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U6115' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u6115_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U6115' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u6115_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U6118' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u6118_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U6118' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u6118_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U6118' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u6118_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U6118' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u6118_q4,

COUNT(DISTINCT IF(e.DIAGCODE='U6119' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) u6119_q1,
COUNT(DISTINCT IF(e.DIAGCODE='U6119' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) u6119_q2,
COUNT(DISTINCT IF(e.DIAGCODE='U6119' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) u6119_q3,
COUNT(DISTINCT IF(e.DIAGCODE='U6119' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) u6119_q4,

COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'M17' AND 'M179' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) m179_q1,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'M17' AND 'M179' AND e2.DIAGCODE IN ('U5750', 'U5752', 'U5753', 'U5755', 'U5759', 'U7141', 'U7142') AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_m179_q1,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'M17' AND 'M179' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) m179_q2,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'M17' AND 'M179' AND e2.DIAGCODE IN ('U5750', 'U5752', 'U5753', 'U5755', 'U5759', 'U7141', 'U7142') AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_m179_q2,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'M17' AND 'M179' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) m179_q3,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'M17' AND 'M179' AND e2.DIAGCODE IN ('U5750', 'U5752', 'U5753', 'U5755', 'U5759', 'U7141', 'U7142') AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_m179_q3,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'M17' AND 'M179' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) m179_q4,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'M17' AND 'M179' AND e2.DIAGCODE IN ('U5750', 'U5752', 'U5753', 'U5755', 'U5759', 'U7141', 'U7142') AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_m179_q4,


COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G81' AND 'G839' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) g431_q1,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G81' AND 'G839' AND e2.DIAGCODE = 'U612' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_g431_q1,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G81' AND 'G839' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) g431_q2,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G81' AND 'G839' AND e2.DIAGCODE = 'U612' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_g431_q2,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G81' AND 'G839' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) g431_q3,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G81' AND 'G839' AND e2.DIAGCODE = 'U612' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_g431_q3,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G81' AND 'G839' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) g431_q4,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G81' AND 'G839' AND e2.DIAGCODE = 'U612' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_g431_q4,

COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'J301' AND 'J304' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) j304_q1,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'J301' AND 'J304' AND e2.DIAGCODE IN ('U743','UU5943') AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_j304_q1,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'J301' AND 'J304' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) j304_q2,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'J301' AND 'J304' AND e2.DIAGCODE IN ('U743','UU5943') AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_j304_q2,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'J301' AND 'J304' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) j304_q3,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'J301' AND 'J304' AND e2.DIAGCODE IN ('U743','UU5943') AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_j304_q3,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'J301' AND 'J304' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) j304_q4,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'J301' AND 'J304' AND e2.DIAGCODE IN ('U743','UU5943') AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_j304_q4,

COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G43' AND 'G439' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) g819_q1,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G43' AND 'G439' AND e2.DIAGCODE IN ('U610', 'U611', 'U6110', 'U6111', 'U6112', 'U6113', 'U6114', 'U6115', 'U6118', 'U6119') AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_g819_q1,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G43' AND 'G439' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) g819_q2,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G43' AND 'G439' AND e2.DIAGCODE IN ('U610', 'U611', 'U6110', 'U6111', 'U6112', 'U6113', 'U6114', 'U6115', 'U6118', 'U6119') AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_g819_q2,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G43' AND 'G439' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) g819_q3,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G43' AND 'G439' AND e2.DIAGCODE IN ('U610', 'U611', 'U6110', 'U6111', 'U6112', 'U6113', 'U6114', 'U6115', 'U6118', 'U6119') AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_g819_q3,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G43' AND 'G439' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) g819_q4,
COUNT(DISTINCT IF(e.DIAGCODE BETWEEN 'G43' AND 'G439' AND e2.DIAGCODE IN ('U610', 'U611', 'U6110', 'U6111', 'U6112', 'U6113', 'U6114', 'U6115', 'U6118', 'U6119') AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) mix_g819_q4
FROM 
tmp_planthai_diag_clinic e 
LEFT JOIN tmp_service s ON s.HOSPCODE = e.HOSPCODE AND s.PID = e.PID AND s.SEQ = e.SEQ 
LEFT JOIN tmp_planthai_diag_clinic_u e2 ON e.HOSPCODE = e2.HOSPCODE AND e.PID = e2.PID AND e.SEQ = e2.SEQ 
LEFT JOIN chospital o ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.HOSPCODE IS NOT NULL 
GROUP BY e.HOSPCODE, IF(s.INSTYPE='0100','UC','OTHER') ;

/****************ttm7*************/
DROP TABLE IF  EXISTS t_ttm_opd_7;
CREATE TABLE IF NOT EXISTS t_ttm_opd_7( 
PRIMARY KEY (hospcode,code_rep),
KEY (hospcode),
KEY (code_rep),
KEY (code_name)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS

SELECT SQL_BIG_RESULT
e.HOSPCODE ,
LEFT(DATE(e.DATE_SERV),7) code_rep,
IF(MONTH(e.DATE_SERV)=1,'มกราคม',
IF(MONTH(e.DATE_SERV)=2,'กุมภาพันธ์',
IF(MONTH(e.DATE_SERV)=3,'มีนาคม',
IF(MONTH(e.DATE_SERV)=4,'เมษายน',
IF(MONTH(e.DATE_SERV)=5,'พฤษภาคม',
IF(MONTH(e.DATE_SERV)=6,'มิถุนายน',
IF(MONTH(e.DATE_SERV)=7,'กรกฏาคม',
IF(MONTH(e.DATE_SERV)=8,'สิงหาคม',
IF(MONTH(e.DATE_SERV)=9,'กันยายน',
IF(MONTH(e.DATE_SERV)=10,'ตุลาคม',
IF(MONTH(e.DATE_SERV)=11,'พฤศจิกายน',
'ธันวาคม'))))))))))) code_name,
@rep_year year_rep,
SUM(IF(LEFT(e.DIDSTD,2) <> '41' AND LEFT(e.DIDSTD,2) <> '42',e.AMOUNT*e.DRUGPRICE,0))  price_drug ,
SUM(IF(LEFT(e.DIDSTD,2) = '41' OR LEFT(e.DIDSTD,2) = '42',e.AMOUNT*e.DRUGPRICE,0))  price_planthai_drug
FROM 
tmp_drug_opd e 
LEFT JOIN chospital i ON e.HOSPCODE = i.hoscode 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930')  AND i.provcode=@provid 
GROUP BY e.HOSPCODE, MONTH(e.DATE_SERV);

/*************ttm8*****************/
DROP TEMPORARY TABLE IF  EXISTS tmp_planthai_procedure;
CREATE TEMPORARY TABLE IF NOT EXISTS 
tmp_planthai_procedure (INDEX(HOSPCODE),INDEX(PID),INDEX(SEQ)) 
ENGINE=MYISAM IGNORE AS 
SELECT 
e.HOSPCODE, 
e.PID, 
e.SEQ, 
e.DATE_SERV, 
e.PROCEDCODE, 
icd.tmtype 
FROM 
tmp_procedure_opd e 
LEFT JOIN cicd9ttm_planthai icd ON icd.`code` = e.PROCEDCODE 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND icd.`code`IS NOT NULL 
;

DROP TABLE IF  EXISTS t_ttm_opd_8;
CREATE TABLE IF NOT EXISTS t_ttm_opd_8( 
PRIMARY KEY (hospcode,instype),
KEY (hospcode),
KEY (instype)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
e.HOSPCODE ,
IF(e.INSTYPE='0100','UC','OTHER') instype,
IFNULL(e.year_rep,@rep_year) year_rep,

IFNULL(e.pt_nod_q1,0) pt_nod_q1,
IFNULL(e.service_nod_q1,0) service_nod_q1,
IFNULL(e.pt_obb_q1,0) pt_obb_q1,
IFNULL(e.service_obb_q1,0) service_obb_q1,
IFNULL(e.pt_cop_q1,0) pt_cop_q1,
IFNULL(e.service_cop_q1,0) service_cop_q1,
IFNULL(e.pt_other_q1,0) pt_other_q1,
IFNULL(e.service_other_q1,0) service_other_q1,
IFNULL(e.pt_total_q1,0) pt_total_q1,
IFNULL(e.service_total_q1,0) service_total_q1,

IFNULL(e.out_pt_nod_q1,0) out_pt_nod_q1,
IFNULL(e.out_service_nod_q1,0) out_service_nod_q1,
IFNULL(e.out_pt_obb_q1,0) out_pt_obb_q1,
IFNULL(e.out_service_obb_q1,0) out_service_obb_q1,
IFNULL(e.out_pt_cop_q1,0) out_pt_cop_q1,
IFNULL(e.out_service_cop_q1,0) out_service_cop_q1,
IFNULL(e.out_pt_other_q1,0) out_pt_other_q1,
IFNULL(e.out_service_other_q1,0) out_service_other_q1,
IFNULL(e.out_pt_total_q1,0) out_pt_total_q1,
IFNULL(e.out_service_total_q1,0) out_service_total_q1,

IFNULL(e.pt_nod_q2,0) pt_nod_q2,
IFNULL(e.service_nod_q2,0) service_nod_q2,
IFNULL(e.pt_obb_q2,0) pt_obb_q2,
IFNULL(e.service_obb_q2,0) service_obb_q2,
IFNULL(e.pt_cop_q2,0) pt_cop_q2,
IFNULL(e.service_cop_q2,0) service_cop_q2,
IFNULL(e.pt_other_q2,0) pt_other_q2,
IFNULL(e.service_other_q2,0) service_other_q2,
IFNULL(e.pt_total_q2,0) pt_total_q2,
IFNULL(e.service_total_q2,0) service_total_q2,

IFNULL(e.out_pt_nod_q2,0) out_pt_nod_q2,
IFNULL(e.out_service_nod_q2,0) out_service_nod_q2,
IFNULL(e.out_pt_obb_q2,0) out_pt_obb_q2,
IFNULL(e.out_service_obb_q2,0) out_service_obb_q2,
IFNULL(e.out_pt_cop_q2,0) out_pt_cop_q2,
IFNULL(e.out_service_cop_q2,0) out_service_cop_q2,
IFNULL(e.out_pt_other_q2,0) out_pt_other_q2,
IFNULL(e.out_service_other_q2,0) out_service_other_q2,
IFNULL(e.out_pt_total_q2,0) out_pt_total_q2,
IFNULL(e.out_service_total_q2,0) out_service_total_q2,

IFNULL(e.pt_nod_q3,0) pt_nod_q3,
IFNULL(e.service_nod_q3,0) service_nod_q3,
IFNULL(e.pt_obb_q3,0) pt_obb_q3,
IFNULL(e.service_obb_q3,0) service_obb_q3,
IFNULL(e.pt_cop_q3,0) pt_cop_q3,
IFNULL(e.service_cop_q3,0) service_cop_q3,
IFNULL(e.pt_other_q3,0) pt_other_q3,
IFNULL(e.service_other_q3,0) service_other_q3,
IFNULL(e.pt_total_q3,0) pt_total_q3,
IFNULL(e.service_total_q3,0) service_total_q3,

IFNULL(e.out_pt_nod_q3,0) out_pt_nod_q3,
IFNULL(e.out_service_nod_q3,0) out_service_nod_q3,
IFNULL(e.out_pt_obb_q3,0) out_pt_obb_q3,
IFNULL(e.out_service_obb_q3,0) out_service_obb_q3,
IFNULL(e.out_pt_cop_q3,0) out_pt_cop_q3,
IFNULL(e.out_service_cop_q3,0) out_service_cop_q3,
IFNULL(e.out_pt_other_q3,0) out_pt_other_q3,
IFNULL(e.out_service_other_q3,0) out_service_other_q3,
IFNULL(e.out_pt_total_q3,0) out_pt_total_q3,
IFNULL(e.out_service_total_q3,0) out_service_total_q3,

IFNULL(e.pt_nod_q4,0) pt_nod_q4,
IFNULL(e.service_nod_q4,0) service_nod_q4,
IFNULL(e.pt_obb_q4,0) pt_obb_q4,
IFNULL(e.service_obb_q4,0) service_obb_q4,
IFNULL(e.pt_cop_q4,0) pt_cop_q4,
IFNULL(e.service_cop_q4,0) service_cop_q4,
IFNULL(e.pt_other_q4,0) pt_other_q4,
IFNULL(e.service_other_q4,0) service_other_q4,
IFNULL(e.pt_total_q4,0) pt_total_q4,
IFNULL(e.service_total_q4,0) service_total_q4,

IFNULL(e.out_pt_nod_q4,0) out_pt_nod_q4,
IFNULL(e.out_service_nod_q4,0) out_service_nod_q4,
IFNULL(e.out_pt_obb_q4,0) out_pt_obb_q4,
IFNULL(e.out_service_obb_q4,0) out_service_obb_q4,
IFNULL(e.out_pt_cop_q4,0) out_pt_cop_q4,
IFNULL(e.out_service_cop_q4,0) out_service_cop_q4,
IFNULL(e.out_pt_other_q4,0) out_pt_other_q4,
IFNULL(e.out_service_other_q4,0) out_service_other_q4,
IFNULL(e.out_pt_total_q4,0) out_pt_total_q4,
IFNULL(e.out_service_total_q4,0) out_service_total_q4
FROM chospital o
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE, 
s.INSTYPE,
s.SERVPLACE,
@rep_year year_rep,  

COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) pt_nod_q1,
COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) service_nod_q1,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) pt_obb_q1,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) service_obb_q1,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) pt_cop_q1,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) service_cop_q1,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) pt_other_q1,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) service_other_q1,
COUNT(DISTINCT IF(s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) pt_total_q1,
COUNT(DISTINCT IF(s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) service_total_q1,

COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) out_pt_nod_q1,
COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_nod_q1,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) out_pt_obb_q1,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_obb_q1,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) out_pt_cop_q1,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_cop_q1,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) out_pt_other_q1,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_other_q1,
COUNT(DISTINCT IF(s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) out_pt_total_q1,
COUNT(DISTINCT IF(s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_total_q1,

COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) pt_nod_q2,
COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) service_nod_q2,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) pt_obb_q2,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) service_obb_q2,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) pt_cop_q2,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) service_cop_q2,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) pt_other_q2,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) service_other_q2,
COUNT(DISTINCT IF(s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) pt_total_q2,
COUNT(DISTINCT IF(s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) service_total_q2,

COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) out_pt_nod_q2,
COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_nod_q2,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) out_pt_obb_q2,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_obb_q2,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) out_pt_cop_q2,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_cop_q2,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) out_pt_other_q2,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_other_q2,
COUNT(DISTINCT IF(s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) out_pt_total_q2,
COUNT(DISTINCT IF(s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_total_q2,

COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) pt_nod_q3,
COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) service_nod_q3,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) pt_obb_q3,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) service_obb_q3,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) pt_cop_q3,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) service_cop_q3,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) pt_other_q3,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) service_other_q3,
COUNT(DISTINCT IF(s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) pt_total_q3,
COUNT(DISTINCT IF(s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) service_total_q3,

COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) out_pt_nod_q3,
COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_nod_q3,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) out_pt_obb_q3,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_obb_q3,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) out_pt_cop_q3,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_cop_q3,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) out_pt_other_q3,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_other_q3,
COUNT(DISTINCT IF(s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) out_pt_total_q3,
COUNT(DISTINCT IF(s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_total_q3,

COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) pt_nod_q4,
COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) service_nod_q4,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) pt_obb_q4,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) service_obb_q4,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) pt_cop_q4,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) service_cop_q4,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) pt_other_q4,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) service_other_q4,
COUNT(DISTINCT IF(s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) pt_total_q4,
COUNT(DISTINCT IF(s.SERVPLACE =1 AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) service_total_q4,

COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) out_pt_nod_q4,
COUNT(DISTINCT IF(e.tmtype=1 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_nod_q4,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) out_pt_obb_q4,
COUNT(DISTINCT IF(e.tmtype=2 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_obb_q4,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) out_pt_cop_q4,
COUNT(DISTINCT IF(e.tmtype=3 AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_cop_q4,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) out_pt_other_q4,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_other_q4,
COUNT(DISTINCT IF(s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) out_pt_total_q4,
COUNT(DISTINCT IF(s.SERVPLACE =2 AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) out_service_total_q4,
NOW() 
FROM 
tmp_planthai_procedure e 
LEFT JOIN tmp_service s ON s.HOSPCODE = e.HOSPCODE AND s.PID = e.PID AND s.SEQ = e.SEQ 
WHERE s.SERVPLACE IN ('1','2') 
GROUP BY e.HOSPCODE,  IF(s.INSTYPE='0100','UC','OTHER') 
) e ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.HOSPCODE IS NOT NULL ;

/*********************ttm9**************************/
DROP TEMPORARY TABLE IF  EXISTS tmp_planthai_diag_u;
CREATE TEMPORARY TABLE IF NOT EXISTS 
tmp_planthai_diag_u (INDEX(HOSPCODE),INDEX(PID),INDEX(SEQ)) 
ENGINE=MYISAM IGNORE AS 
SELECT 
e.HOSPCODE, 
e.PID, 
e.SEQ, 
e.DATE_SERV, 
e.DIAGCODE, 
d.SEQ DRUG ,
TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'1001')) age,
p.SEX 
FROM 
tmp_diag_opd e 
LEFT JOIN person p ON e.HOSPCODE = p.HOSPCODE AND e.PID = p.PID 
LEFT JOIN tmp_drug_opd d ON d.HOSPCODE = e.HOSPCODE AND d.PID = e.PID AND d.SEQ = e.SEQ AND LEFT(d.DIDSTD,2) IN ('41','42') 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIAGCODE,1) = 'U' AND LEFT(e.DIAGCODE,3)<>'U77' 
;

DROP TABLE IF  EXISTS t_ttm_opd_9;
CREATE TABLE IF NOT EXISTS t_ttm_opd_9( 
PRIMARY KEY (hospcode,instype,diagcode,age,sex),
KEY (hospcode),
KEY (instype),
KEY (diagcode),
KEY (age),
KEY (sex)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS

SELECT 
e.HOSPCODE ,
IF(e.INSTYPE='0100','UC','OTHER') instype,
e.DIAGCODE diagcode,
e.diseasename,
IFNULL(e.year_rep,@rep_year) year_rep,
IFNULL(e.age,0) age,
e.sex,

IFNULL(e.total_pt_q1,0) total_pt_q1,	
IFNULL(e.total_q1,0) total_q1,

IFNULL(e.total_pt_q2,0) total_pt_q2,	
IFNULL(e.total_q2,0) total_q2,

IFNULL(e.total_pt_q3,0) total_pt_q3,	
IFNULL(e.total_q3,0) total_q3,

IFNULL(e.total_pt_q4,0) total_pt_q4,	
IFNULL(e.total_q4,0) total_q4,
IFNULL(e.total_drug,0) total_drug
FROM chospital o
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE, 
s.INSTYPE,
e.DIAGCODE,
IFNULL(d.diseasethai,e.DIAGCODE) diseasename,
@rep_year year_rep,  
e.age age,
e.SEX sex,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) total_pt_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q1,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) total_pt_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q2,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) total_pt_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q3,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) total_pt_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q4,

COUNT(DISTINCT e.DRUG) total_drug
FROM 
tmp_planthai_diag_u e 
LEFT JOIN tmp_service s ON s.HOSPCODE = e.HOSPCODE AND s.PID = e.PID AND s.SEQ = e.SEQ 
LEFT JOIN cdisease d ON d.diagcode = e.DIAGCODE 
WHERE e.SEX IN (1,2)
GROUP BY e.HOSPCODE, IF(s.INSTYPE='0100','UC','OTHER'), e.DIAGCODE , e.age , e.SEX 
) e ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.HOSPCODE IS NOT NULL ;

/***********************ttm10******************/
DROP TABLE IF  EXISTS t_ttm_opd_10;
CREATE TABLE IF NOT EXISTS t_ttm_opd_10( 
PRIMARY KEY (hospcode,instype),
KEY (hospcode),
KEY (instype)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS

SELECT SQL_BIG_RESULT 
e.HOSPCODE ,
IF(s.INSTYPE='0100','UC','OTHER') instype,
@rep_year year_rep,

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) ed_pt_q1,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) non_ed_pt_q1,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) other_pt_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) total_pt_q1,	

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) ed_q1,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) non_ed_q1,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) other_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q1,	

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) ed_pt_q2,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) non_ed_pt_q2,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) other_pt_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) total_pt_q2,	

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) ed_q2,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) non_ed_q2,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) other_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q2,	

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) ed_pt_q3,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) non_ed_pt_q3,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) other_pt_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) total_pt_q3,	

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) ed_q3,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) non_ed_q3,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) other_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q3,	
 
COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) ed_pt_q4,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) non_ed_pt_q4,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) other_pt_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) total_pt_q4,	

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) ed_q4,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) non_ed_q4,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) other_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q4 
FROM 
tmp_planthai_drug_use e
LEFT JOIN tmp_service s ON e.HOSPCODE = s.HOSPCODE AND e.PID = s.PID AND e.SEQ = s.SEQ 
LEFT JOIN chospital o ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.HOSPCODE IS NOT NULL  AND e.DIDSTD IS NOT NULL 
GROUP BY e.HOSPCODE, IF(s.INSTYPE='0100','UC','OTHER');


 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.406863;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:427;a:5:{i:0;s:35:"DROP PROCEDURE IF EXISTS t_ttm11_15";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.406863;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:428;a:5:{i:0;s:35:"DROP PROCEDURE IF EXISTS t_ttm11_15";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.4586639;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:430;a:5:{i:0;s:18100:"CREATE PROCEDURE t_ttm11_15()
 BEGIN 
SET @provid = '58';
SET@id:= '67';
SET @rep_year = (SELECT yearprocess FROM sys_config LIMIT 1);
/**********************ttm11***************/
DROP TEMPORARY TABLE IF  EXISTS diag_u77;
CREATE TEMPORARY TABLE IF NOT EXISTS 
diag_u77 (INDEX(pcucode,instype,age)) 
ENGINE=MYISAM IGNORE AS 
SELECT SQL_BIG_RESULT
e.HOSPCODE pcucode, 
IF(s.INSTYPE='0100','UC','OTHER') instype, 
TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'1001')) age,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12) ,CONCAT(e.PID,'-',e.SEQ),NULL)) total_u77_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3) ,CONCAT(e.PID,'-',e.SEQ),NULL)) total_u77_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6) ,CONCAT(e.PID,'-',e.SEQ),NULL)) total_u77_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9) ,CONCAT(e.PID,'-',e.SEQ),NULL)) total_u77_q4,
COUNT(DISTINCT CONCAT(e.PID,'-',e.SEQ)) total_u77
FROM 
tmp_diag_opd e 
LEFT JOIN tmp_service s ON s.HOSPCODE = e.HOSPCODE AND s.PID = e.PID AND s.SEQ = e.SEQ 
LEFT JOIN person p ON e.HOSPCODE = p.HOSPCODE AND e.PID = p.PID 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIAGCODE,3) = 'U77' 
GROUP BY e.HOSPCODE,  IF(s.INSTYPE='0100','UC','OTHER'), TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'1001'))
;

DROP TEMPORARY TABLE IF  EXISTS proced_u77;
CREATE TEMPORARY TABLE IF NOT EXISTS 
proced_u77 (INDEX(pcucode,instype,age)) 
ENGINE=MYISAM  IGNORE AS 
SELECT SQL_BIG_RESULT 
e.HOSPCODE pcucode, 
IF(s.INSTYPE='0100','UC','OTHER') instype, 
TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'-10-01')) age,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,e.PID,NULL)) total_planthai_pt_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,CONCAT(e.PID,'-',e.SEQ),NULL)) total_planthai_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),e.PID,NULL)) total_pt_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,e.PID,NULL)) total_planthai_pt_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,CONCAT(e.PID,'-',e.SEQ),NULL)) total_planthai_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),e.PID,NULL)) total_pt_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,e.PID,NULL)) total_planthai_pt_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,CONCAT(e.PID,'-',e.SEQ),NULL)) total_planthai_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),e.PID,NULL)) total_pt_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,e.PID,NULL)) total_planthai_pt_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,CONCAT(e.PID,'-',e.SEQ),NULL)) total_planthai_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),e.PID,NULL)) total_pt_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q4
FROM 
(
SELECT 
e.HOSPCODE, 
e.PID, 
e.SEQ, 
e.DATE_SERV, 
e.PROCEDCODE 
FROM 
tmp_procedure_opd e 
LEFT JOIN tmp_diag_opd d ON d.HOSPCODE = e.HOSPCODE AND d.PID = e.PID AND d.SEQ = e.SEQ 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007903','9007904','9007998','9007999') 
AND LEFT(d.DIAGCODE,3) = 'U77' 
) e 
LEFT JOIN tmp_service s ON s.HOSPCODE = e.HOSPCODE AND s.PID = e.PID AND s.SEQ = e.SEQ 
LEFT JOIN person p ON e.HOSPCODE = p.HOSPCODE AND e.PID = p.PID 
WHERE e.HOSPCODE IS NOT NULL 
GROUP BY e.HOSPCODE,  IF(s.INSTYPE='0100','UC','OTHER'), TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'1001'))
;

DROP TABLE IF  EXISTS t_ttm_opd_11;
CREATE TABLE IF NOT EXISTS t_ttm_opd_11( 
PRIMARY KEY (hospcode,instype,age),
KEY (hospcode),
KEY (instype),
KEY (age)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE  AS

SELECT SQL_BIG_RESULT 
e.pcucode hospcode, 
e.instype, 
e.age,
@rep_year year_rep, 
e.total_u77_q1,
IFNULL(p.total_planthai_pt_q1,0) total_planthai_pt_q1,
IFNULL(p.total_planthai_q1,0) total_planthai_q1,
IFNULL(p.total_pt_q1,0) total_pt_q1,
IFNULL(p.total_q1,0) total_q1,
e.total_u77_q2,
IFNULL(p.total_planthai_pt_q2,0) total_planthai_pt_q2,
IFNULL(p.total_planthai_q2,0) total_planthai_q2,
IFNULL(p.total_pt_q2,0) total_pt_q2,
IFNULL(p.total_q2,0) total_q2,
e.total_u77_q3,
IFNULL(p.total_planthai_pt_q3,0) total_planthai_pt_q3,
IFNULL(p.total_planthai_q3,0) total_planthai_q3,
IFNULL(p.total_pt_q3,0) total_pt_q3,
IFNULL(p.total_q3,0) total_q3,
e.total_u77_q4,
IFNULL(p.total_planthai_pt_q4,0) total_planthai_pt_q4,
IFNULL(p.total_planthai_q4,0) total_planthai_q4,
IFNULL(p.total_pt_q4,0) total_pt_q4,
IFNULL(p.total_q4,0) total_q4,
(IFNULL(p.total_planthai_q1,0)+IFNULL(p.total_planthai_q2,0)+IFNULL(p.total_planthai_q3,0)+IFNULL(p.total_planthai_q4,0)) total_planthai,
(IFNULL(p.total_q1,0)+IFNULL(p.total_q2,0)+IFNULL(p.total_q3,0)+IFNULL(p.total_q4,0)) total_choice,
e.total_u77
FROM 
diag_u77 e 
LEFT JOIN proced_u77 p ON p.pcucode = e.pcucode AND p.instype = e.instype AND p.age = e.age 
LEFT JOIN chospital o ON e.pcucode = o.hoscode 
WHERE o.provcode=@provid ;

/***********************ttm12*******************/

DROP TEMPORARY TABLE IF  EXISTS tmp_planthai_opd_no_z;
CREATE TEMPORARY TABLE IF NOT EXISTS 
tmp_planthai_opd_no_z (INDEX(HOSPCODE),INDEX(code_rep)) 
ENGINE=MYISAM IGNORE AS
SELECT SQL_BIG_RESULT
e.HOSPCODE,
LEFT(DATE(e.DATE_SERV),7) code_rep,
COUNT(DISTINCT CONCAT(e.PID,'-',e.SEQ)) OP_SERVICE,
COUNT(DISTINCT e.PID) OP_SERVICE_PT
FROM tmp_service e 
LEFT JOIN tmp_diag_opd d ON d.HOSPCODE = e.HOSPCODE AND d.PID = e.PID AND d.SEQ = e.SEQ AND d.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(d.DIAGCODE,1) <> 'Z' 
GROUP BY e.HOSPCODE, MONTH(e.DATE_SERV)
;

DROP TEMPORARY TABLE IF  EXISTS tmp_ttm_service;
CREATE TEMPORARY TABLE IF NOT EXISTS 
tmp_ttm_service (
`HOSPCODE`  char(5) NOT NULL ,
`PID`  varchar(16) NOT NULL ,
`SEQ`  varchar(16) NOT NULL ,
`DATE_SERV`  date NULL ,
PRIMARY KEY (`HOSPCODE`, `PID`, `SEQ`)
);

REPLACE INTO tmp_ttm_service 
SELECT e.HOSPCODE, 
e.PID,
e.SEQ, 
e.DATE_SERV 
FROM tmp_diag_opd e 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIAGCODE,1) = 'U';

REPLACE INTO tmp_ttm_service
SELECT e.HOSPCODE, 
e.PID,
e.SEQ, 
e.DATE_SERV 
FROM tmp_drug_opd e 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIDSTD,2) IN ('41','42') ;

REPLACE INTO tmp_ttm_service
SELECT e.HOSPCODE, 
e.PID,
e.SEQ, 
e.DATE_SERV 
FROM tmp_procedure_opd  e 
LEFT JOIN cicd9ttm_planthai p ON e.PROCEDCODE=p.`code` 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND p.code IS NOT NULL ;


DROP TABLE IF  EXISTS t_ttm_opd_12;
CREATE TABLE IF NOT EXISTS t_ttm_opd_12( 
PRIMARY KEY (hospcode),
KEY (hospcode)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
o.hoscode hospcode,
e.code_rep quarterly,
@rep_year year_rep,
IFNULL(e.OP_SERVICE_PT,0) op_service_pt,
IFNULL(e.OP_SERVICE,0) op_service,
IFNULL(t.TM_SERVICE_PT,0) tm_service_pt,
IFNULL(t.TM_SERVICE,0) tm_service
FROM chospital o 
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE,
'' code_rep,
SUM(e.OP_SERVICE_PT) OP_SERVICE_PT, 
SUM(e.OP_SERVICE) OP_SERVICE  
FROM tmp_planthai_opd_no_z e 
GROUP BY e.HOSPCODE 
) e ON e.HOSPCODE = o.hoscode 

LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE,
e.PID,
'' code_rep,
COUNT(DISTINCT e.PID) TM_SERVICE_PT, 
COUNT(DISTINCT CONCAT(e.PID,'-',e.SEQ)) TM_SERVICE 
FROM
tmp_ttm_service e
GROUP BY e.HOSPCODE 
) t ON t.HOSPCODE = e.HOSPCODE AND t.code_rep = e.code_rep
WHERE o.provcode=@provid AND e.HOSPCODE IS NOT NULL;

/******************************ttm13*******************/
DROP TEMPORARY TABLE IF  EXISTS tmp_planthai_opd_no_z;
CREATE TEMPORARY TABLE IF NOT EXISTS 
tmp_planthai_opd_no_z (INDEX(HOSPCODE),INDEX(code_rep)) 
ENGINE=MYISAM IGNORE AS 
SELECT SQL_BIG_RESULT
e.HOSPCODE,
LEFT(DATE(e.DATE_SERV),7) code_rep,
IF(MONTH(e.DATE_SERV)=1,'มกราคม',
IF(MONTH(e.DATE_SERV)=2,'กุมภาพันธ์',
IF(MONTH(e.DATE_SERV)=3,'มีนาคม',
IF(MONTH(e.DATE_SERV)=4,'เมษายน',
IF(MONTH(e.DATE_SERV)=5,'พฤษภาคม',
IF(MONTH(e.DATE_SERV)=6,'มิถุนายน',
IF(MONTH(e.DATE_SERV)=7,'กรกฏาคม',
IF(MONTH(e.DATE_SERV)=8,'สิงหาคม',
IF(MONTH(e.DATE_SERV)=9,'กันยายน',
IF(MONTH(e.DATE_SERV)=10,'ตุลาคม',
IF(MONTH(e.DATE_SERV)=11,'พฤศจิกายน',
'ธันวาคม'))))))))))) code_name, 
COUNT(DISTINCT CONCAT(e.PID,'-',e.SEQ)) OP_SERVICE,
COUNT(DISTINCT e.PID) OP_SERVICE_PT
FROM tmp_service e 
LEFT JOIN tmp_diag_opd d ON d.HOSPCODE = e.HOSPCODE AND d.PID = e.PID AND d.SEQ = e.SEQ AND d.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(d.DIAGCODE,1) <> 'Z'
GROUP BY e.HOSPCODE, MONTH(e.DATE_SERV)
;

DROP TEMPORARY TABLE IF  EXISTS tmp_ttm_service;
CREATE TEMPORARY TABLE IF NOT EXISTS 
tmp_ttm_service (
`HOSPCODE`  char(5) NOT NULL ,
`PID`  varchar(16) NOT NULL ,
`SEQ`  varchar(16) NOT NULL ,
`DATE_SERV`  date NULL ,
PRIMARY KEY (`HOSPCODE`, `PID`, `SEQ`)
);

INSERT IGNORE INTO tmp_ttm_service 
SELECT e.HOSPCODE, 
e.PID,
e.SEQ, 
e.DATE_SERV 
FROM tmp_diag_opd e 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIAGCODE,1) = 'U';

INSERT IGNORE INTO tmp_ttm_service
SELECT e.HOSPCODE, 
e.PID,
e.SEQ, 
e.DATE_SERV 
FROM tmp_drug_opd e 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIDSTD,2) IN ('41','42') ;

INSERT IGNORE INTO tmp_ttm_service
SELECT e.HOSPCODE, 
e.PID,
e.SEQ, 
e.DATE_SERV 
FROM tmp_procedure_opd e 
LEFT JOIN cicd9ttm_planthai p ON e.PROCEDCODE=p.`code` 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND p.code IS NOT NULL ;

DROP TABLE IF  EXISTS t_ttm_opd_13;
CREATE TABLE IF NOT EXISTS t_ttm_opd_13( 
PRIMARY KEY (hospcode,code_rep),
KEY (hospcode),
KEY (code_rep)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
o.hoscode hospcode,
IFNULL(e.code_rep,CONCAT(@rep_year,'-10')) code_rep,
IFNULL(e.code_name,'ตุลาคม') code_name,
@rep_year year_rep,
IFNULL(e.OP_SERVICE_PT,0) op_service_pt,
IFNULL(e.OP_SERVICE,0) op_service,
IFNULL(t.TM_SERVICE_PT,0) tm_service_pt,
IFNULL(t.TM_SERVICE,0) tm_service
FROM chospital o 
LEFT JOIN 
tmp_planthai_opd_no_z e ON e.HOSPCODE = o.hoscode 
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE,
LEFT(DATE(e.DATE_SERV),7) code_rep,
COUNT(DISTINCT CONCAT(e.PID,'-',e.SEQ)) TM_SERVICE, 
COUNT(DISTINCT e.PID) TM_SERVICE_PT 
FROM
tmp_ttm_service e
GROUP BY e.HOSPCODE, LEFT(DATE(e.DATE_SERV),7)
) t ON t.HOSPCODE = e.HOSPCODE AND t.code_rep = e.code_rep
WHERE o.provcode=@provid 
HAVING op_service<>0  ; 

/***********************ttm14*****************/
DROP TEMPORARY TABLE IF  EXISTS ttm_service_tmp;
CREATE TEMPORARY TABLE IF NOT EXISTS 
ttm_service_tmp (
`HOSPCODE`  char(5) NOT NULL ,
`SEQ`  varchar(16) NOT NULL ,
`DATE_SERV`  date NULL ,
PRIMARY KEY (`HOSPCODE`, `SEQ`)
);

REPLACE INTO ttm_service_tmp 
SELECT e.HOSPCODE, 
e.SEQ, 
e.DATE_SERV 
FROM tmp_diag_opd e 
LEFT JOIN tmp_service s ON  s.HOSPCODE = e.HOSPCODE AND s.PID = e.PID AND s.SEQ = e.SEQ 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIAGCODE,1) = 'U' AND e.DIAGCODE<>'U77' AND s.INSTYPE='0100';

REPLACE INTO ttm_service_tmp
SELECT e.HOSPCODE, 
e.SEQ, 
e.DATE_SERV 
FROM tmp_drug_opd e 
LEFT JOIN tmp_service s ON  s.HOSPCODE = e.HOSPCODE AND s.PID = e.PID AND s.SEQ = e.SEQ 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIDSTD,2) IN ('41','42') AND s.INSTYPE='0100' ;

REPLACE INTO ttm_service_tmp
SELECT e.HOSPCODE, 
e.SEQ, 
e.DATE_SERV 
FROM tmp_procedure_opd e 
LEFT JOIN tmp_service s ON  s.HOSPCODE = e.HOSPCODE AND s.PID = e.PID AND s.SEQ = e.SEQ 
LEFT JOIN cicd9ttm_planthai p ON e.PROCEDCODE=p.`code` AND p.code NOT IN ('9007900','9007901','9007902','9007903','9007904','9007998','9007999')
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND p.code IS NOT NULL AND s.INSTYPE='0100' ;


DROP TABLE IF  EXISTS t_ttm_opd_14;
CREATE TABLE IF NOT EXISTS t_ttm_opd_14( 
PRIMARY KEY (hospcode,code_rep),
KEY (hospcode),
KEY (code_rep)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
o.hoscode hospcode,
IFNULL(e.code_rep,CONCAT(@rep_year,'-10')) code_rep,
IFNULL(e.code_name,'ตุลาคม') code_name,
@rep_year year_rep,
IFNULL(e.OP_SERVICE,0) op_service,
IFNULL(t.TM_SERVICE,0) tm_service
FROM chospital o 
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE,
LEFT(DATE(e.DATE_SERV),7) code_rep,
IF(MONTH(e.DATE_SERV)=1,'มกราคม',
IF(MONTH(e.DATE_SERV)=2,'กุมภาพันธ์',
IF(MONTH(e.DATE_SERV)=3,'มีนาคม',
IF(MONTH(e.DATE_SERV)=4,'เมษายน',
IF(MONTH(e.DATE_SERV)=5,'พฤษภาคม',
IF(MONTH(e.DATE_SERV)=6,'มิถุนายน',
IF(MONTH(e.DATE_SERV)=7,'กรกฏาคม',
IF(MONTH(e.DATE_SERV)=8,'สิงหาคม',
IF(MONTH(e.DATE_SERV)=9,'กันยายน',
IF(MONTH(e.DATE_SERV)=10,'ตุลาคม',
IF(MONTH(e.DATE_SERV)=11,'พฤศจิกายน',
'ธันวาคม'))))))))))) code_name, 
COUNT(DISTINCT CONCAT(e.PID,'-',e.SEQ)) OP_SERVICE 
FROM tmp_service e 
LEFT JOIN tmp_diag_opd d ON d.HOSPCODE = e.HOSPCODE AND d.PID = e.PID AND d.SEQ = e.SEQ AND d.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(d.DIAGCODE,1) <> 'Z' AND e.INSTYPE='0100'
GROUP BY e.HOSPCODE, MONTH(e.DATE_SERV)
) e ON e.HOSPCODE = o.hoscode 

LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE,
LEFT(DATE(e.DATE_SERV),7) code_rep,
COUNT(e.SEQ) TM_SERVICE 
FROM ttm_service_tmp e
GROUP BY e.HOSPCODE, MONTH(e.DATE_SERV)
) t ON t.HOSPCODE = e.HOSPCODE AND t.code_rep = e.code_rep

WHERE o.provcode=@provid 
HAVING op_service<>0  ;

/***********************ttm15*****************/
DROP TEMPORARY TABLE IF  EXISTS mother_service_ipd;
CREATE TEMPORARY TABLE IF NOT EXISTS 
mother_service_ipd (INDEX(CID)) 
ENGINE=MYISAM IGNORE AS 
SELECT 
e.HOSPCODE, 
e.PID, 
e.AN SEQ, 
DATE(e.TIMESTART) DATE_SERV,
a.INSTYPE,
GROUP_CONCAT(e.PROCEDCODE) PROCEDCODE,
p.BIRTH,
p.CID,
LENGTH(GROUP_CONCAT(e.PROCEDCODE)) length_str
FROM tmp_procedure_ipd e 
LEFT JOIN tmp_admission a ON e.HOSPCODE = a.HOSPCODE AND e.PID = a.PID AND e.AN = a.AN 
LEFT JOIN person p ON e.HOSPCODE = p.HOSPCODE AND e.PID = p.PID 
WHERE e.PROCEDCODE IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND 
DATE(e.TIMESTART) BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') AND 
p.SEX = 2 
GROUP BY e.HOSPCODE, e.PID, e.AN 
;

DROP TEMPORARY TABLE IF  EXISTS labor_rep;
CREATE TEMPORARY TABLE IF NOT EXISTS 
labor_rep (INDEX(CID)) 
ENGINE=MYISAM  IGNORE AS 
SELECT 
p.CID,
l.BDATE
FROM 
tmp_labor l
LEFT JOIN person p ON l.HOSPCODE = p.HOSPCODE AND l.PID = p.PID  
WHERE 
l.BDATE BETWEEN CONCAT((@rep_year-1),'0701') AND CONCAT(@rep_year,'0930') AND 
p.CID IS NOT NULL 
GROUP BY p.CID 
;

DROP TABLE IF  EXISTS t_ttm_ipd_15;
CREATE TABLE IF NOT EXISTS t_ttm_ipd_15( 
PRIMARY KEY (hospcode,code_rep),
KEY (hospcode),
KEY (code_rep)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT SQL_BIG_RESULT
e.HOSPCODE ,
CONCAT(e.HOSPCODE,'-',e.PID) code_rep,
@rep_year year_rep,
TIMESTAMPDIFF(YEAR,e.BIRTH,e.DATE_SERV) age,
MIN(e.DATE_SERV) begin_date_serv,
COUNT(DISTINCT l.CID) all_mother,
COUNT(IF(e.length_str=39,1,NULL)) have_service,
COUNT(1) all_service,
COUNT(IF(e.PROCEDCODE LIKE '%9007712%',1,NULL)) ttm_service,
IF(DATEDIFF(MIN(e.DATE_SERV),l.BDATE) BETWEEN 0 AND 45,0,1) not_in_time,
IF(DATEDIFF(MAX(e.DATE_SERV),MIN(e.DATE_SERV)) BETWEEN 0 AND 90,0,1) not_less90days,

COUNT(DISTINCT IF(e.INSTYPE='0100',l.CID,NULL)) all_uc_mother,
COUNT(IF(e.length_str=39 AND e.INSTYPE='0100',1,NULL)) uc_have_service,
COUNT(IF(e.INSTYPE='0100',1,NULL)) uc_all_service,
IF(e.INSTYPE='0100',IF(DATEDIFF(MIN(e.DATE_SERV),l.BDATE) BETWEEN 0 AND 45,0,1),0) uc_not_in_time,
IF(e.INSTYPE='0100',IF(DATEDIFF(MAX(e.DATE_SERV),MIN(e.DATE_SERV)) BETWEEN 0 AND 90,0,1),0) uc_not_less90days 
FROM mother_service_ipd e 
LEFT JOIN labor_rep l ON l.CID = e.CID
LEFT JOIN chospital i ON e.HOSPCODE = i.hoscode 
WHERE 
i.provcode=@provid 
GROUP BY e.HOSPCODE, e.PID ;


 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.4586639;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:431;a:5:{i:0;s:18100:"CREATE PROCEDURE t_ttm11_15()
 BEGIN 
SET @provid = '58';
SET@id:= '67';
SET @rep_year = (SELECT yearprocess FROM sys_config LIMIT 1);
/**********************ttm11***************/
DROP TEMPORARY TABLE IF  EXISTS diag_u77;
CREATE TEMPORARY TABLE IF NOT EXISTS 
diag_u77 (INDEX(pcucode,instype,age)) 
ENGINE=MYISAM IGNORE AS 
SELECT SQL_BIG_RESULT
e.HOSPCODE pcucode, 
IF(s.INSTYPE='0100','UC','OTHER') instype, 
TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'1001')) age,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12) ,CONCAT(e.PID,'-',e.SEQ),NULL)) total_u77_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3) ,CONCAT(e.PID,'-',e.SEQ),NULL)) total_u77_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6) ,CONCAT(e.PID,'-',e.SEQ),NULL)) total_u77_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9) ,CONCAT(e.PID,'-',e.SEQ),NULL)) total_u77_q4,
COUNT(DISTINCT CONCAT(e.PID,'-',e.SEQ)) total_u77
FROM 
tmp_diag_opd e 
LEFT JOIN tmp_service s ON s.HOSPCODE = e.HOSPCODE AND s.PID = e.PID AND s.SEQ = e.SEQ 
LEFT JOIN person p ON e.HOSPCODE = p.HOSPCODE AND e.PID = p.PID 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIAGCODE,3) = 'U77' 
GROUP BY e.HOSPCODE,  IF(s.INSTYPE='0100','UC','OTHER'), TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'1001'))
;

DROP TEMPORARY TABLE IF  EXISTS proced_u77;
CREATE TEMPORARY TABLE IF NOT EXISTS 
proced_u77 (INDEX(pcucode,instype,age)) 
ENGINE=MYISAM  IGNORE AS 
SELECT SQL_BIG_RESULT 
e.HOSPCODE pcucode, 
IF(s.INSTYPE='0100','UC','OTHER') instype, 
TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'-10-01')) age,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,e.PID,NULL)) total_planthai_pt_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,CONCAT(e.PID,'-',e.SEQ),NULL)) total_planthai_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),e.PID,NULL)) total_pt_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,e.PID,NULL)) total_planthai_pt_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,CONCAT(e.PID,'-',e.SEQ),NULL)) total_planthai_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),e.PID,NULL)) total_pt_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,e.PID,NULL)) total_planthai_pt_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,CONCAT(e.PID,'-',e.SEQ),NULL)) total_planthai_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),e.PID,NULL)) total_pt_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,e.PID,NULL)) total_planthai_pt_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,CONCAT(e.PID,'-',e.SEQ),NULL)) total_planthai_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),e.PID,NULL)) total_pt_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),CONCAT(e.PID,'-',e.SEQ),NULL)) total_q4
FROM 
(
SELECT 
e.HOSPCODE, 
e.PID, 
e.SEQ, 
e.DATE_SERV, 
e.PROCEDCODE 
FROM 
tmp_procedure_opd e 
LEFT JOIN tmp_diag_opd d ON d.HOSPCODE = e.HOSPCODE AND d.PID = e.PID AND d.SEQ = e.SEQ 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007903','9007904','9007998','9007999') 
AND LEFT(d.DIAGCODE,3) = 'U77' 
) e 
LEFT JOIN tmp_service s ON s.HOSPCODE = e.HOSPCODE AND s.PID = e.PID AND s.SEQ = e.SEQ 
LEFT JOIN person p ON e.HOSPCODE = p.HOSPCODE AND e.PID = p.PID 
WHERE e.HOSPCODE IS NOT NULL 
GROUP BY e.HOSPCODE,  IF(s.INSTYPE='0100','UC','OTHER'), TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'1001'))
;

DROP TABLE IF  EXISTS t_ttm_opd_11;
CREATE TABLE IF NOT EXISTS t_ttm_opd_11( 
PRIMARY KEY (hospcode,instype,age),
KEY (hospcode),
KEY (instype),
KEY (age)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE  AS

SELECT SQL_BIG_RESULT 
e.pcucode hospcode, 
e.instype, 
e.age,
@rep_year year_rep, 
e.total_u77_q1,
IFNULL(p.total_planthai_pt_q1,0) total_planthai_pt_q1,
IFNULL(p.total_planthai_q1,0) total_planthai_q1,
IFNULL(p.total_pt_q1,0) total_pt_q1,
IFNULL(p.total_q1,0) total_q1,
e.total_u77_q2,
IFNULL(p.total_planthai_pt_q2,0) total_planthai_pt_q2,
IFNULL(p.total_planthai_q2,0) total_planthai_q2,
IFNULL(p.total_pt_q2,0) total_pt_q2,
IFNULL(p.total_q2,0) total_q2,
e.total_u77_q3,
IFNULL(p.total_planthai_pt_q3,0) total_planthai_pt_q3,
IFNULL(p.total_planthai_q3,0) total_planthai_q3,
IFNULL(p.total_pt_q3,0) total_pt_q3,
IFNULL(p.total_q3,0) total_q3,
e.total_u77_q4,
IFNULL(p.total_planthai_pt_q4,0) total_planthai_pt_q4,
IFNULL(p.total_planthai_q4,0) total_planthai_q4,
IFNULL(p.total_pt_q4,0) total_pt_q4,
IFNULL(p.total_q4,0) total_q4,
(IFNULL(p.total_planthai_q1,0)+IFNULL(p.total_planthai_q2,0)+IFNULL(p.total_planthai_q3,0)+IFNULL(p.total_planthai_q4,0)) total_planthai,
(IFNULL(p.total_q1,0)+IFNULL(p.total_q2,0)+IFNULL(p.total_q3,0)+IFNULL(p.total_q4,0)) total_choice,
e.total_u77
FROM 
diag_u77 e 
LEFT JOIN proced_u77 p ON p.pcucode = e.pcucode AND p.instype = e.instype AND p.age = e.age 
LEFT JOIN chospital o ON e.pcucode = o.hoscode 
WHERE o.provcode=@provid ;

/***********************ttm12*******************/

DROP TEMPORARY TABLE IF  EXISTS tmp_planthai_opd_no_z;
CREATE TEMPORARY TABLE IF NOT EXISTS 
tmp_planthai_opd_no_z (INDEX(HOSPCODE),INDEX(code_rep)) 
ENGINE=MYISAM IGNORE AS
SELECT SQL_BIG_RESULT
e.HOSPCODE,
LEFT(DATE(e.DATE_SERV),7) code_rep,
COUNT(DISTINCT CONCAT(e.PID,'-',e.SEQ)) OP_SERVICE,
COUNT(DISTINCT e.PID) OP_SERVICE_PT
FROM tmp_service e 
LEFT JOIN tmp_diag_opd d ON d.HOSPCODE = e.HOSPCODE AND d.PID = e.PID AND d.SEQ = e.SEQ AND d.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(d.DIAGCODE,1) <> 'Z' 
GROUP BY e.HOSPCODE, MONTH(e.DATE_SERV)
;

DROP TEMPORARY TABLE IF  EXISTS tmp_ttm_service;
CREATE TEMPORARY TABLE IF NOT EXISTS 
tmp_ttm_service (
`HOSPCODE`  char(5) NOT NULL ,
`PID`  varchar(16) NOT NULL ,
`SEQ`  varchar(16) NOT NULL ,
`DATE_SERV`  date NULL ,
PRIMARY KEY (`HOSPCODE`, `PID`, `SEQ`)
);

REPLACE INTO tmp_ttm_service 
SELECT e.HOSPCODE, 
e.PID,
e.SEQ, 
e.DATE_SERV 
FROM tmp_diag_opd e 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIAGCODE,1) = 'U';

REPLACE INTO tmp_ttm_service
SELECT e.HOSPCODE, 
e.PID,
e.SEQ, 
e.DATE_SERV 
FROM tmp_drug_opd e 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIDSTD,2) IN ('41','42') ;

REPLACE INTO tmp_ttm_service
SELECT e.HOSPCODE, 
e.PID,
e.SEQ, 
e.DATE_SERV 
FROM tmp_procedure_opd  e 
LEFT JOIN cicd9ttm_planthai p ON e.PROCEDCODE=p.`code` 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND p.code IS NOT NULL ;


DROP TABLE IF  EXISTS t_ttm_opd_12;
CREATE TABLE IF NOT EXISTS t_ttm_opd_12( 
PRIMARY KEY (hospcode),
KEY (hospcode)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
o.hoscode hospcode,
e.code_rep quarterly,
@rep_year year_rep,
IFNULL(e.OP_SERVICE_PT,0) op_service_pt,
IFNULL(e.OP_SERVICE,0) op_service,
IFNULL(t.TM_SERVICE_PT,0) tm_service_pt,
IFNULL(t.TM_SERVICE,0) tm_service
FROM chospital o 
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE,
'' code_rep,
SUM(e.OP_SERVICE_PT) OP_SERVICE_PT, 
SUM(e.OP_SERVICE) OP_SERVICE  
FROM tmp_planthai_opd_no_z e 
GROUP BY e.HOSPCODE 
) e ON e.HOSPCODE = o.hoscode 

LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE,
e.PID,
'' code_rep,
COUNT(DISTINCT e.PID) TM_SERVICE_PT, 
COUNT(DISTINCT CONCAT(e.PID,'-',e.SEQ)) TM_SERVICE 
FROM
tmp_ttm_service e
GROUP BY e.HOSPCODE 
) t ON t.HOSPCODE = e.HOSPCODE AND t.code_rep = e.code_rep
WHERE o.provcode=@provid AND e.HOSPCODE IS NOT NULL;

/******************************ttm13*******************/
DROP TEMPORARY TABLE IF  EXISTS tmp_planthai_opd_no_z;
CREATE TEMPORARY TABLE IF NOT EXISTS 
tmp_planthai_opd_no_z (INDEX(HOSPCODE),INDEX(code_rep)) 
ENGINE=MYISAM IGNORE AS 
SELECT SQL_BIG_RESULT
e.HOSPCODE,
LEFT(DATE(e.DATE_SERV),7) code_rep,
IF(MONTH(e.DATE_SERV)=1,'มกราคม',
IF(MONTH(e.DATE_SERV)=2,'กุมภาพันธ์',
IF(MONTH(e.DATE_SERV)=3,'มีนาคม',
IF(MONTH(e.DATE_SERV)=4,'เมษายน',
IF(MONTH(e.DATE_SERV)=5,'พฤษภาคม',
IF(MONTH(e.DATE_SERV)=6,'มิถุนายน',
IF(MONTH(e.DATE_SERV)=7,'กรกฏาคม',
IF(MONTH(e.DATE_SERV)=8,'สิงหาคม',
IF(MONTH(e.DATE_SERV)=9,'กันยายน',
IF(MONTH(e.DATE_SERV)=10,'ตุลาคม',
IF(MONTH(e.DATE_SERV)=11,'พฤศจิกายน',
'ธันวาคม'))))))))))) code_name, 
COUNT(DISTINCT CONCAT(e.PID,'-',e.SEQ)) OP_SERVICE,
COUNT(DISTINCT e.PID) OP_SERVICE_PT
FROM tmp_service e 
LEFT JOIN tmp_diag_opd d ON d.HOSPCODE = e.HOSPCODE AND d.PID = e.PID AND d.SEQ = e.SEQ AND d.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(d.DIAGCODE,1) <> 'Z'
GROUP BY e.HOSPCODE, MONTH(e.DATE_SERV)
;

DROP TEMPORARY TABLE IF  EXISTS tmp_ttm_service;
CREATE TEMPORARY TABLE IF NOT EXISTS 
tmp_ttm_service (
`HOSPCODE`  char(5) NOT NULL ,
`PID`  varchar(16) NOT NULL ,
`SEQ`  varchar(16) NOT NULL ,
`DATE_SERV`  date NULL ,
PRIMARY KEY (`HOSPCODE`, `PID`, `SEQ`)
);

INSERT IGNORE INTO tmp_ttm_service 
SELECT e.HOSPCODE, 
e.PID,
e.SEQ, 
e.DATE_SERV 
FROM tmp_diag_opd e 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIAGCODE,1) = 'U';

INSERT IGNORE INTO tmp_ttm_service
SELECT e.HOSPCODE, 
e.PID,
e.SEQ, 
e.DATE_SERV 
FROM tmp_drug_opd e 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIDSTD,2) IN ('41','42') ;

INSERT IGNORE INTO tmp_ttm_service
SELECT e.HOSPCODE, 
e.PID,
e.SEQ, 
e.DATE_SERV 
FROM tmp_procedure_opd e 
LEFT JOIN cicd9ttm_planthai p ON e.PROCEDCODE=p.`code` 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND p.code IS NOT NULL ;

DROP TABLE IF  EXISTS t_ttm_opd_13;
CREATE TABLE IF NOT EXISTS t_ttm_opd_13( 
PRIMARY KEY (hospcode,code_rep),
KEY (hospcode),
KEY (code_rep)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
o.hoscode hospcode,
IFNULL(e.code_rep,CONCAT(@rep_year,'-10')) code_rep,
IFNULL(e.code_name,'ตุลาคม') code_name,
@rep_year year_rep,
IFNULL(e.OP_SERVICE_PT,0) op_service_pt,
IFNULL(e.OP_SERVICE,0) op_service,
IFNULL(t.TM_SERVICE_PT,0) tm_service_pt,
IFNULL(t.TM_SERVICE,0) tm_service
FROM chospital o 
LEFT JOIN 
tmp_planthai_opd_no_z e ON e.HOSPCODE = o.hoscode 
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE,
LEFT(DATE(e.DATE_SERV),7) code_rep,
COUNT(DISTINCT CONCAT(e.PID,'-',e.SEQ)) TM_SERVICE, 
COUNT(DISTINCT e.PID) TM_SERVICE_PT 
FROM
tmp_ttm_service e
GROUP BY e.HOSPCODE, LEFT(DATE(e.DATE_SERV),7)
) t ON t.HOSPCODE = e.HOSPCODE AND t.code_rep = e.code_rep
WHERE o.provcode=@provid 
HAVING op_service<>0  ; 

/***********************ttm14*****************/
DROP TEMPORARY TABLE IF  EXISTS ttm_service_tmp;
CREATE TEMPORARY TABLE IF NOT EXISTS 
ttm_service_tmp (
`HOSPCODE`  char(5) NOT NULL ,
`SEQ`  varchar(16) NOT NULL ,
`DATE_SERV`  date NULL ,
PRIMARY KEY (`HOSPCODE`, `SEQ`)
);

REPLACE INTO ttm_service_tmp 
SELECT e.HOSPCODE, 
e.SEQ, 
e.DATE_SERV 
FROM tmp_diag_opd e 
LEFT JOIN tmp_service s ON  s.HOSPCODE = e.HOSPCODE AND s.PID = e.PID AND s.SEQ = e.SEQ 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIAGCODE,1) = 'U' AND e.DIAGCODE<>'U77' AND s.INSTYPE='0100';

REPLACE INTO ttm_service_tmp
SELECT e.HOSPCODE, 
e.SEQ, 
e.DATE_SERV 
FROM tmp_drug_opd e 
LEFT JOIN tmp_service s ON  s.HOSPCODE = e.HOSPCODE AND s.PID = e.PID AND s.SEQ = e.SEQ 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIDSTD,2) IN ('41','42') AND s.INSTYPE='0100' ;

REPLACE INTO ttm_service_tmp
SELECT e.HOSPCODE, 
e.SEQ, 
e.DATE_SERV 
FROM tmp_procedure_opd e 
LEFT JOIN tmp_service s ON  s.HOSPCODE = e.HOSPCODE AND s.PID = e.PID AND s.SEQ = e.SEQ 
LEFT JOIN cicd9ttm_planthai p ON e.PROCEDCODE=p.`code` AND p.code NOT IN ('9007900','9007901','9007902','9007903','9007904','9007998','9007999')
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND p.code IS NOT NULL AND s.INSTYPE='0100' ;


DROP TABLE IF  EXISTS t_ttm_opd_14;
CREATE TABLE IF NOT EXISTS t_ttm_opd_14( 
PRIMARY KEY (hospcode,code_rep),
KEY (hospcode),
KEY (code_rep)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
o.hoscode hospcode,
IFNULL(e.code_rep,CONCAT(@rep_year,'-10')) code_rep,
IFNULL(e.code_name,'ตุลาคม') code_name,
@rep_year year_rep,
IFNULL(e.OP_SERVICE,0) op_service,
IFNULL(t.TM_SERVICE,0) tm_service
FROM chospital o 
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE,
LEFT(DATE(e.DATE_SERV),7) code_rep,
IF(MONTH(e.DATE_SERV)=1,'มกราคม',
IF(MONTH(e.DATE_SERV)=2,'กุมภาพันธ์',
IF(MONTH(e.DATE_SERV)=3,'มีนาคม',
IF(MONTH(e.DATE_SERV)=4,'เมษายน',
IF(MONTH(e.DATE_SERV)=5,'พฤษภาคม',
IF(MONTH(e.DATE_SERV)=6,'มิถุนายน',
IF(MONTH(e.DATE_SERV)=7,'กรกฏาคม',
IF(MONTH(e.DATE_SERV)=8,'สิงหาคม',
IF(MONTH(e.DATE_SERV)=9,'กันยายน',
IF(MONTH(e.DATE_SERV)=10,'ตุลาคม',
IF(MONTH(e.DATE_SERV)=11,'พฤศจิกายน',
'ธันวาคม'))))))))))) code_name, 
COUNT(DISTINCT CONCAT(e.PID,'-',e.SEQ)) OP_SERVICE 
FROM tmp_service e 
LEFT JOIN tmp_diag_opd d ON d.HOSPCODE = e.HOSPCODE AND d.PID = e.PID AND d.SEQ = e.SEQ AND d.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
WHERE e.DATE_SERV BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(d.DIAGCODE,1) <> 'Z' AND e.INSTYPE='0100'
GROUP BY e.HOSPCODE, MONTH(e.DATE_SERV)
) e ON e.HOSPCODE = o.hoscode 

LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE,
LEFT(DATE(e.DATE_SERV),7) code_rep,
COUNT(e.SEQ) TM_SERVICE 
FROM ttm_service_tmp e
GROUP BY e.HOSPCODE, MONTH(e.DATE_SERV)
) t ON t.HOSPCODE = e.HOSPCODE AND t.code_rep = e.code_rep

WHERE o.provcode=@provid 
HAVING op_service<>0  ;

/***********************ttm15*****************/
DROP TEMPORARY TABLE IF  EXISTS mother_service_ipd;
CREATE TEMPORARY TABLE IF NOT EXISTS 
mother_service_ipd (INDEX(CID)) 
ENGINE=MYISAM IGNORE AS 
SELECT 
e.HOSPCODE, 
e.PID, 
e.AN SEQ, 
DATE(e.TIMESTART) DATE_SERV,
a.INSTYPE,
GROUP_CONCAT(e.PROCEDCODE) PROCEDCODE,
p.BIRTH,
p.CID,
LENGTH(GROUP_CONCAT(e.PROCEDCODE)) length_str
FROM tmp_procedure_ipd e 
LEFT JOIN tmp_admission a ON e.HOSPCODE = a.HOSPCODE AND e.PID = a.PID AND e.AN = a.AN 
LEFT JOIN person p ON e.HOSPCODE = p.HOSPCODE AND e.PID = p.PID 
WHERE e.PROCEDCODE IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND 
DATE(e.TIMESTART) BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') AND 
p.SEX = 2 
GROUP BY e.HOSPCODE, e.PID, e.AN 
;

DROP TEMPORARY TABLE IF  EXISTS labor_rep;
CREATE TEMPORARY TABLE IF NOT EXISTS 
labor_rep (INDEX(CID)) 
ENGINE=MYISAM  IGNORE AS 
SELECT 
p.CID,
l.BDATE
FROM 
tmp_labor l
LEFT JOIN person p ON l.HOSPCODE = p.HOSPCODE AND l.PID = p.PID  
WHERE 
l.BDATE BETWEEN CONCAT((@rep_year-1),'0701') AND CONCAT(@rep_year,'0930') AND 
p.CID IS NOT NULL 
GROUP BY p.CID 
;

DROP TABLE IF  EXISTS t_ttm_ipd_15;
CREATE TABLE IF NOT EXISTS t_ttm_ipd_15( 
PRIMARY KEY (hospcode,code_rep),
KEY (hospcode),
KEY (code_rep)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT SQL_BIG_RESULT
e.HOSPCODE ,
CONCAT(e.HOSPCODE,'-',e.PID) code_rep,
@rep_year year_rep,
TIMESTAMPDIFF(YEAR,e.BIRTH,e.DATE_SERV) age,
MIN(e.DATE_SERV) begin_date_serv,
COUNT(DISTINCT l.CID) all_mother,
COUNT(IF(e.length_str=39,1,NULL)) have_service,
COUNT(1) all_service,
COUNT(IF(e.PROCEDCODE LIKE '%9007712%',1,NULL)) ttm_service,
IF(DATEDIFF(MIN(e.DATE_SERV),l.BDATE) BETWEEN 0 AND 45,0,1) not_in_time,
IF(DATEDIFF(MAX(e.DATE_SERV),MIN(e.DATE_SERV)) BETWEEN 0 AND 90,0,1) not_less90days,

COUNT(DISTINCT IF(e.INSTYPE='0100',l.CID,NULL)) all_uc_mother,
COUNT(IF(e.length_str=39 AND e.INSTYPE='0100',1,NULL)) uc_have_service,
COUNT(IF(e.INSTYPE='0100',1,NULL)) uc_all_service,
IF(e.INSTYPE='0100',IF(DATEDIFF(MIN(e.DATE_SERV),l.BDATE) BETWEEN 0 AND 45,0,1),0) uc_not_in_time,
IF(e.INSTYPE='0100',IF(DATEDIFF(MAX(e.DATE_SERV),MIN(e.DATE_SERV)) BETWEEN 0 AND 90,0,1),0) uc_not_less90days 
FROM mother_service_ipd e 
LEFT JOIN labor_rep l ON l.CID = e.CID
LEFT JOIN chospital i ON e.HOSPCODE = i.hoscode 
WHERE 
i.provcode=@provid 
GROUP BY e.HOSPCODE, e.PID ;


 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.521064;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:433;a:5:{i:0;s:35:"DROP PROCEDURE IF EXISTS t_ttm16_20";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.521064;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:434;a:5:{i:0;s:35:"DROP PROCEDURE IF EXISTS t_ttm16_20";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.5678639;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:436;a:5:{i:0;s:15882:"CREATE PROCEDURE t_ttm16_20()
 BEGIN 
SET @provid = '58';
SET @id:= '68';
SET @rep_year = (SELECT yearprocess FROM sys_config LIMIT 1);
/*************************ttmp16***************/

DROP TABLE IF  EXISTS tmp_drug_ipd;
CREATE TABLE IF NOT EXISTS tmp_drug_ipd(
PRIMARY KEY (`HOSPCODE`,`PID`,`AN`,`DATETIME_ADMIT`,`TYPEDRUG`,`DIDSTD`),
  KEY  (`HOSPCODE`,`PID`),
  KEY (`HOSPCODE`),
  KEY (`DATETIME_ADMIT`),
  KEY (`WARDSTAY`),
  KEY (`TYPEDRUG`),
  KEY (`DIDSTD`),
  KEY (`DATESTART`),
  KEY  (`DATEFINISH`),
  KEY  (`HOSPCODE`,`AN`),
  KEY  (`AN`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT i.*,p.cid FROM drug_ipd i INNER JOIN person p ON i.HOSPCODE=p.HOSPCODE AND i.PID=p.PID
WHERE  DATESTART BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') ;

DROP TABLE IF  EXISTS tmp_planthai_drug_use_ipd;
CREATE  TABLE IF NOT EXISTS 
tmp_planthai_drug_use_ipd (INDEX(HOSPCODE),INDEX(PID),INDEX(SEQ)) 
ENGINE=MYISAM IGNORE AS 
SELECT
e.HOSPCODE,
e.PID,
e.AN SEQ,
e.DATESTART DATE_SERV,
e.DIDSTD,
e.AMOUNT,
e.DRUGPRICE,
e.DRUGCOST,
d.didstd PASS,
d.drug_name,
d.drug_type ,
d.ed
FROM 
tmp_drug_ipd  e 
LEFT JOIN cdrug_planthai d ON d.didstd=e.DIDSTD 
WHERE
e.DATESTART BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIDSTD,2) IN ('41','42') 
;

DROP TABLE IF  EXISTS t_ttm_ipd_16;
CREATE TABLE IF NOT EXISTS t_ttm_ipd_16( 
PRIMARY KEY (hospcode,code_rep),
KEY (hospcode),
KEY (code_rep)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
e.HOSPCODE ,
IFNULL(e.code_rep,CONCAT(@rep_year,'-07')) code_rep,
IFNULL(
IF(e.code_name=1,'มกราคม',
IF(e.code_name=2,'กุมภาพันธ์',
IF(e.code_name=3,'มีนาคม',
IF(e.code_name=4,'เมษายน',
IF(e.code_name=5,'พฤษภาคม',
IF(e.code_name=6,'มิถุนายน',
IF(e.code_name=7,'กรกฏาคม',
IF(e.code_name=8,'สิงหาคม',
IF(e.code_name=9,'กันยายน',
IF(e.code_name=10,'ตุลาคม',
IF(e.code_name=11,'พฤศจิกายน',
'ธันวาคม')))))))))))
,'กรกฏาคม') code_name,
IFNULL(e.year_rep,@rep_year) year_rep,
IFNULL(e.all_visit,0) all_visit,
IFNULL(e.all_drug,0) all_drug,
IFNULL(e.uc_visit,0) uc_visit,
IFNULL(e.uc_drug,0) uc_drug,
IFNULL(e.all_visit_error,0) all_visit_error,
IFNULL(e.all_drug_error,0) all_drug_error,
IFNULL(e.uc_visit_error,0) uc_visit_error,
IFNULL(e.uc_drug_error,0) uc_drug_error
FROM chospital o 
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE, 
LEFT(DATE(e.DATE_SERV),7) code_rep,
MONTH(e.DATE_SERV) code_name,
@rep_year year_rep, 
COUNT(DISTINCT e.SEQ) as all_visit, 
COUNT(*) as all_drug, 
COUNT(DISTINCT (IF(s.INSTYPE='0100',e.SEQ,NULL))) as uc_visit , 
COUNT(IF(s.INSTYPE='0100',1,NULL)) as uc_drug,
COUNT(DISTINCT IF(e.PASS IS NULL,e.SEQ,NULL)) as all_visit_error, 
COUNT(IF(e.PASS IS NULL,e.SEQ,NULL)) as all_drug_error, 
COUNT(DISTINCT (IF(s.INSTYPE='0100' AND e.PASS IS NULL,e.SEQ,NULL))) as uc_visit_error , 
COUNT(IF(s.INSTYPE='0100' AND e.PASS IS NULL,1,NULL)) as uc_drug_error  
FROM 
tmp_planthai_drug_use_ipd e
LEFT JOIN tmp_admission s ON e.HOSPCODE = s.HOSPCODE AND e.PID = s.PID AND e.SEQ = s.AN 
GROUP BY e.HOSPCODE, MONTH(e.DATE_SERV) ) e ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid  AND e.code_rep IS NOT NULL ;

/*************************ttmp17***************/
DROP TABLE IF  EXISTS t_ttm_ipd_17;
CREATE TABLE IF NOT EXISTS t_ttm_ipd_17( 
PRIMARY KEY (hospcode,servplace,age,sex),
KEY (hospcode),
KEY (servplace),
KEY (age),
KEY (sex)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
e.HOSPCODE ,
e.servplace,
e.age,
e.sex,
@rep_year year_rep,

IFNULL(e.total_pt_q1,0) total_pt_q1,	
IFNULL(e.total_q1,0) total_q1,
IFNULL(e.didstd_q1,0) didstd_q1,

IFNULL(e.total_pt_q2,0) total_pt_q2,	
IFNULL(e.total_q2,0) total_q2,
IFNULL(e.didstd_q2,0) didstd_q2,

IFNULL(e.total_pt_q3,0) total_pt_q3,	
IFNULL(e.total_q3,0) total_q3,
IFNULL(e.didstd_q3,0) didstd_q3,	

IFNULL(e.total_pt_q4,0) total_pt_q4,	
IFNULL(e.total_q4,0) total_q4,
IFNULL(e.didstd_q4,0) didstd_q4
FROM chospital o 
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE, 
e.DATE_SERV,
1 servplace,
TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'1001')) age,
p.SEX sex,
@rep_year year_rep, 

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) total_pt_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.SEQ,NULL)) total_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.SEQ,'-',e.DIDSTD),NULL)) didstd_q1,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) total_pt_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.SEQ,NULL)) total_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.SEQ,'-',e.DIDSTD),NULL)) didstd_q2,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) total_pt_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.SEQ,NULL)) total_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.SEQ,'-',e.DIDSTD),NULL)) didstd_q3,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) total_pt_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.SEQ,NULL)) total_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.SEQ,'-',e.DIDSTD),NULL)) didstd_q4 
FROM 
tmp_planthai_drug_use_ipd e
LEFT JOIN tmp_admission s ON e.HOSPCODE = s.HOSPCODE AND e.PID = s.PID AND e.SEQ = s.AN 
INNER JOIN person p ON e.HOSPCODE = p.HOSPCODE AND e.PID = p.PID 
GROUP BY e.HOSPCODE, p.SEX, TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'1001'))
) e ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.HOSPCODE IS NOT NULL ;

/*************************ttmp18***************/
DROP TABLE IF  EXISTS t_ttm_ipd_18;
CREATE TABLE IF NOT EXISTS t_ttm_ipd_18( 
PRIMARY KEY (hospcode,code_rep),
KEY (hospcode),
KEY (code_rep)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
o.hoscode hospcode,
e.didstd code_rep,
IFNULL(CONCAT(e.drug_name,', ',e.drug_type),e.didstd) code_name,
@rep_year year_rep,
IFNULL(e.all_visit,0) all_visit,
IFNULL(e.all_drug,0) all_drug,
IFNULL(e.uc_visit,0) uc_visit,
IFNULL(e.uc_drug,0) uc_drug,
IFNULL(e.all_visit_error,0) all_visit_error,
IFNULL(e.all_drug_error,0) all_drug_error,
IFNULL(e.uc_visit_error,0) uc_visit_error,
IFNULL(e.uc_drug_error,0) uc_drug_error
FROM chospital o 
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE, 
e.DIDSTD didstd,
e.drug_name, 
e.drug_type,
@rep_year year_rep, 
COUNT(DISTINCT e.SEQ) as all_visit, 
COUNT(*) as all_drug, 
COUNT(DISTINCT (IF(s.INSTYPE='0100',e.SEQ,NULL))) as uc_visit , 
COUNT(IF(s.INSTYPE='0100',1,NULL)) as uc_drug,
COUNT(DISTINCT IF(e.PASS IS NULL,e.SEQ,NULL)) as all_visit_error, 
COUNT(IF(e.PASS IS NULL,e.SEQ,NULL)) as all_drug_error, 
COUNT(DISTINCT (IF(s.INSTYPE='0100' AND e.PASS IS NULL,e.SEQ,NULL))) as uc_visit_error , 
COUNT(IF(s.INSTYPE='0100' AND e.PASS IS NULL,1,NULL)) as uc_drug_error  
FROM 
tmp_planthai_drug_use_ipd e
LEFT JOIN tmp_admission s ON e.HOSPCODE = s.HOSPCODE AND e.PID = s.PID AND e.SEQ = s.AN 
GROUP BY e.HOSPCODE, e.DIDSTD 
) e ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.didstd IS NOT NULL ;

/****************ttm19******************/
DROP TABLE IF  EXISTS t_ttm_ipd_19;
CREATE TABLE IF NOT EXISTS t_ttm_ipd_19( 
PRIMARY KEY (hospcode,code_rep),
KEY (hospcode),
KEY (code_rep)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT SQL_BIG_RESULT
e.HOSPCODE ,
LEFT(DATE(e.DATESTART),7) code_rep,
IF(MONTH(e.DATESTART)=1,'มกราคม',
IF(MONTH(e.DATESTART)=2,'กุมภาพันธ์',
IF(MONTH(e.DATESTART)=3,'มีนาคม',
IF(MONTH(e.DATESTART)=4,'เมษายน',
IF(MONTH(e.DATESTART)=5,'พฤษภาคม',
IF(MONTH(e.DATESTART)=6,'มิถุนายน',
IF(MONTH(e.DATESTART)=7,'กรกฏาคม',
IF(MONTH(e.DATESTART)=8,'สิงหาคม',
IF(MONTH(e.DATESTART)=9,'กันยายน',
IF(MONTH(e.DATESTART)=10,'ตุลาคม',
IF(MONTH(e.DATESTART)=11,'พฤศจิกายน',
'ธันวาคม'))))))))))) code_name,
@rep_year year_rep,
SUM(IF(LEFT(e.DIDSTD,2) <> '41' AND LEFT(e.DIDSTD,2) <> '42',e.AMOUNT*e.DRUGPRICE,0))  price_drug ,
SUM(IF(LEFT(e.DIDSTD,2) = '41' OR LEFT(e.DIDSTD,2) = '42',e.AMOUNT*e.DRUGPRICE,0))  price_planthai_drug
FROM 
tmp_drug_ipd e 
LEFT JOIN chospital i ON e.HOSPCODE = i.hoscode 
WHERE e.DATESTART BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930')  AND i.provcode=@provid 
GROUP BY e.HOSPCODE, MONTH(e.DATESTART);

/******************************ttm20******************/
DROP TEMPORARY TABLE IF  EXISTS tmp_planthai_procedure_ipd;
CREATE TEMPORARY TABLE IF NOT EXISTS 
tmp_planthai_procedure_ipd (INDEX(HOSPCODE),INDEX(PID),INDEX(SEQ)) 
ENGINE=MYISAM IGNORE  AS 
SELECT 
e.HOSPCODE, 
e.PID, 
e.AN SEQ, 
DATE(e.TIMESTART) DATE_SERV, 
e.PROCEDCODE, 
icd.tmtype 
FROM 
tmp_procedure_ipd e 
LEFT JOIN cicd9ttm_planthai icd ON icd.`code` = e.PROCEDCODE 
WHERE DATE(e.TIMESTART) BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND icd.`code`IS NOT NULL 
;

DROP TABLE IF  EXISTS t_ttm_ipd_20;
CREATE TABLE IF NOT EXISTS t_ttm_ipd_20( 
PRIMARY KEY (hospcode,instype),
KEY (hospcode),
KEY (instype)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
e.HOSPCODE ,
IF(e.INSTYPE='0100','UC','OTHER') instype,
IFNULL(e.year_rep,@rep_year) year_rep,

IFNULL(e.pt_nod_q1,0) pt_nod_q1,
IFNULL(e.service_nod_q1,0) service_nod_q1,
IFNULL(e.pt_obb_q1,0) pt_obb_q1,
IFNULL(e.service_obb_q1,0) service_obb_q1,
IFNULL(e.pt_cop_q1,0) pt_cop_q1,
IFNULL(e.service_cop_q1,0) service_cop_q1,
IFNULL(e.pt_other_q1,0) pt_other_q1,
IFNULL(e.service_other_q1,0) service_other_q1,
IFNULL(e.pt_total_q1,0) pt_total_q1,
IFNULL(e.service_total_q1,0) service_total_q1,

IFNULL(e.pt_nod_q2,0) pt_nod_q2,
IFNULL(e.service_nod_q2,0) service_nod_q2,
IFNULL(e.pt_obb_q2,0) pt_obb_q2,
IFNULL(e.service_obb_q2,0) service_obb_q2,
IFNULL(e.pt_cop_q2,0) pt_cop_q2,
IFNULL(e.service_cop_q2,0) service_cop_q2,
IFNULL(e.pt_other_q2,0) pt_other_q2,
IFNULL(e.service_other_q2,0) service_other_q2,
IFNULL(e.pt_total_q2,0) pt_total_q2,
IFNULL(e.service_total_q2,0) service_total_q2,

IFNULL(e.pt_nod_q3,0) pt_nod_q3,
IFNULL(e.service_nod_q3,0) service_nod_q3,
IFNULL(e.pt_obb_q3,0) pt_obb_q3,
IFNULL(e.service_obb_q3,0) service_obb_q3,
IFNULL(e.pt_cop_q3,0) pt_cop_q3,
IFNULL(e.service_cop_q3,0) service_cop_q3,
IFNULL(e.pt_other_q3,0) pt_other_q3,
IFNULL(e.service_other_q3,0) service_other_q3,
IFNULL(e.pt_total_q3,0) pt_total_q3,
IFNULL(e.service_total_q3,0) service_total_q3,

IFNULL(e.pt_nod_q4,0) pt_nod_q4,
IFNULL(e.service_nod_q4,0) service_nod_q4,
IFNULL(e.pt_obb_q4,0) pt_obb_q4,
IFNULL(e.service_obb_q4,0) service_obb_q4,
IFNULL(e.pt_cop_q4,0) pt_cop_q4,
IFNULL(e.service_cop_q4,0) service_cop_q4,
IFNULL(e.pt_other_q4,0) pt_other_q4,
IFNULL(e.service_other_q4,0) service_other_q4,
IFNULL(e.pt_total_q4,0) pt_total_q4,
IFNULL(e.service_total_q4,0) service_total_q4
FROM chospital o
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE, 
s.INSTYPE,
1 SERVPLACE,
@rep_year year_rep,  

COUNT(DISTINCT IF(e.tmtype=1 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) pt_nod_q1,
COUNT(DISTINCT IF(e.tmtype=1 AND MONTH(e.DATE_SERV) IN (10,11,12),e.SEQ,NULL)) service_nod_q1,
COUNT(DISTINCT IF(e.tmtype=2 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) pt_obb_q1,
COUNT(DISTINCT IF(e.tmtype=2 AND MONTH(e.DATE_SERV) IN (10,11,12),e.SEQ,NULL)) service_obb_q1,
COUNT(DISTINCT IF(e.tmtype=3 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) pt_cop_q1,
COUNT(DISTINCT IF(e.tmtype=3 AND MONTH(e.DATE_SERV) IN (10,11,12),e.SEQ,NULL)) service_cop_q1,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) pt_other_q1,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND MONTH(e.DATE_SERV) IN (10,11,12),e.SEQ,NULL)) service_other_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) pt_total_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.SEQ,NULL)) service_total_q1,


COUNT(DISTINCT IF(e.tmtype=1 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) pt_nod_q2,
COUNT(DISTINCT IF(e.tmtype=1 AND MONTH(e.DATE_SERV) IN (1,2,3),e.SEQ,NULL)) service_nod_q2,
COUNT(DISTINCT IF(e.tmtype=2 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) pt_obb_q2,
COUNT(DISTINCT IF(e.tmtype=2 AND MONTH(e.DATE_SERV) IN (1,2,3),e.SEQ,NULL)) service_obb_q2,
COUNT(DISTINCT IF(e.tmtype=3 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) pt_cop_q2,
COUNT(DISTINCT IF(e.tmtype=3 AND MONTH(e.DATE_SERV) IN (1,2,3),e.SEQ,NULL)) service_cop_q2,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) pt_other_q2,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND MONTH(e.DATE_SERV) IN (1,2,3),e.SEQ,NULL)) service_other_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) pt_total_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.SEQ,NULL)) service_total_q2,


COUNT(DISTINCT IF(e.tmtype=1 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) pt_nod_q3,
COUNT(DISTINCT IF(e.tmtype=1 AND MONTH(e.DATE_SERV) IN (4,5,6),e.SEQ,NULL)) service_nod_q3,
COUNT(DISTINCT IF(e.tmtype=2 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) pt_obb_q3,
COUNT(DISTINCT IF(e.tmtype=2 AND MONTH(e.DATE_SERV) IN (4,5,6),e.SEQ,NULL)) service_obb_q3,
COUNT(DISTINCT IF(e.tmtype=3 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) pt_cop_q3,
COUNT(DISTINCT IF(e.tmtype=3 AND MONTH(e.DATE_SERV) IN (4,5,6),e.SEQ,NULL)) service_cop_q3,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) pt_other_q3,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND MONTH(e.DATE_SERV) IN (4,5,6),e.SEQ,NULL)) service_other_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) pt_total_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.SEQ,NULL)) service_total_q3,


COUNT(DISTINCT IF(e.tmtype=1 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) pt_nod_q4,
COUNT(DISTINCT IF(e.tmtype=1 AND MONTH(e.DATE_SERV) IN (7,8,9),e.SEQ,NULL)) service_nod_q4,
COUNT(DISTINCT IF(e.tmtype=2 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) pt_obb_q4,
COUNT(DISTINCT IF(e.tmtype=2 AND MONTH(e.DATE_SERV) IN (7,8,9),e.SEQ,NULL)) service_obb_q4,
COUNT(DISTINCT IF(e.tmtype=3 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) pt_cop_q4,
COUNT(DISTINCT IF(e.tmtype=3 AND MONTH(e.DATE_SERV) IN (7,8,9),e.SEQ,NULL)) service_cop_q4,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) pt_other_q4,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND MONTH(e.DATE_SERV) IN (7,8,9),e.SEQ,NULL)) service_other_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) pt_total_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.SEQ,NULL)) service_total_q4,

NOW() 
FROM 
tmp_planthai_procedure_ipd e 
LEFT JOIN tmp_admission s ON s.HOSPCODE = e.HOSPCODE AND s.PID = e.PID AND s.AN = e.SEQ 
GROUP BY e.HOSPCODE,  IF(s.INSTYPE='0100','UC','OTHER') 
) e ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.HOSPCODE IS NOT NULL;


 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.5834639;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:437;a:5:{i:0;s:15882:"CREATE PROCEDURE t_ttm16_20()
 BEGIN 
SET @provid = '58';
SET @id:= '68';
SET @rep_year = (SELECT yearprocess FROM sys_config LIMIT 1);
/*************************ttmp16***************/

DROP TABLE IF  EXISTS tmp_drug_ipd;
CREATE TABLE IF NOT EXISTS tmp_drug_ipd(
PRIMARY KEY (`HOSPCODE`,`PID`,`AN`,`DATETIME_ADMIT`,`TYPEDRUG`,`DIDSTD`),
  KEY  (`HOSPCODE`,`PID`),
  KEY (`HOSPCODE`),
  KEY (`DATETIME_ADMIT`),
  KEY (`WARDSTAY`),
  KEY (`TYPEDRUG`),
  KEY (`DIDSTD`),
  KEY (`DATESTART`),
  KEY  (`DATEFINISH`),
  KEY  (`HOSPCODE`,`AN`),
  KEY  (`AN`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT i.*,p.cid FROM drug_ipd i INNER JOIN person p ON i.HOSPCODE=p.HOSPCODE AND i.PID=p.PID
WHERE  DATESTART BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') ;

DROP TABLE IF  EXISTS tmp_planthai_drug_use_ipd;
CREATE  TABLE IF NOT EXISTS 
tmp_planthai_drug_use_ipd (INDEX(HOSPCODE),INDEX(PID),INDEX(SEQ)) 
ENGINE=MYISAM IGNORE AS 
SELECT
e.HOSPCODE,
e.PID,
e.AN SEQ,
e.DATESTART DATE_SERV,
e.DIDSTD,
e.AMOUNT,
e.DRUGPRICE,
e.DRUGCOST,
d.didstd PASS,
d.drug_name,
d.drug_type ,
d.ed
FROM 
tmp_drug_ipd  e 
LEFT JOIN cdrug_planthai d ON d.didstd=e.DIDSTD 
WHERE
e.DATESTART BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIDSTD,2) IN ('41','42') 
;

DROP TABLE IF  EXISTS t_ttm_ipd_16;
CREATE TABLE IF NOT EXISTS t_ttm_ipd_16( 
PRIMARY KEY (hospcode,code_rep),
KEY (hospcode),
KEY (code_rep)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
e.HOSPCODE ,
IFNULL(e.code_rep,CONCAT(@rep_year,'-07')) code_rep,
IFNULL(
IF(e.code_name=1,'มกราคม',
IF(e.code_name=2,'กุมภาพันธ์',
IF(e.code_name=3,'มีนาคม',
IF(e.code_name=4,'เมษายน',
IF(e.code_name=5,'พฤษภาคม',
IF(e.code_name=6,'มิถุนายน',
IF(e.code_name=7,'กรกฏาคม',
IF(e.code_name=8,'สิงหาคม',
IF(e.code_name=9,'กันยายน',
IF(e.code_name=10,'ตุลาคม',
IF(e.code_name=11,'พฤศจิกายน',
'ธันวาคม')))))))))))
,'กรกฏาคม') code_name,
IFNULL(e.year_rep,@rep_year) year_rep,
IFNULL(e.all_visit,0) all_visit,
IFNULL(e.all_drug,0) all_drug,
IFNULL(e.uc_visit,0) uc_visit,
IFNULL(e.uc_drug,0) uc_drug,
IFNULL(e.all_visit_error,0) all_visit_error,
IFNULL(e.all_drug_error,0) all_drug_error,
IFNULL(e.uc_visit_error,0) uc_visit_error,
IFNULL(e.uc_drug_error,0) uc_drug_error
FROM chospital o 
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE, 
LEFT(DATE(e.DATE_SERV),7) code_rep,
MONTH(e.DATE_SERV) code_name,
@rep_year year_rep, 
COUNT(DISTINCT e.SEQ) as all_visit, 
COUNT(*) as all_drug, 
COUNT(DISTINCT (IF(s.INSTYPE='0100',e.SEQ,NULL))) as uc_visit , 
COUNT(IF(s.INSTYPE='0100',1,NULL)) as uc_drug,
COUNT(DISTINCT IF(e.PASS IS NULL,e.SEQ,NULL)) as all_visit_error, 
COUNT(IF(e.PASS IS NULL,e.SEQ,NULL)) as all_drug_error, 
COUNT(DISTINCT (IF(s.INSTYPE='0100' AND e.PASS IS NULL,e.SEQ,NULL))) as uc_visit_error , 
COUNT(IF(s.INSTYPE='0100' AND e.PASS IS NULL,1,NULL)) as uc_drug_error  
FROM 
tmp_planthai_drug_use_ipd e
LEFT JOIN tmp_admission s ON e.HOSPCODE = s.HOSPCODE AND e.PID = s.PID AND e.SEQ = s.AN 
GROUP BY e.HOSPCODE, MONTH(e.DATE_SERV) ) e ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid  AND e.code_rep IS NOT NULL ;

/*************************ttmp17***************/
DROP TABLE IF  EXISTS t_ttm_ipd_17;
CREATE TABLE IF NOT EXISTS t_ttm_ipd_17( 
PRIMARY KEY (hospcode,servplace,age,sex),
KEY (hospcode),
KEY (servplace),
KEY (age),
KEY (sex)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
e.HOSPCODE ,
e.servplace,
e.age,
e.sex,
@rep_year year_rep,

IFNULL(e.total_pt_q1,0) total_pt_q1,	
IFNULL(e.total_q1,0) total_q1,
IFNULL(e.didstd_q1,0) didstd_q1,

IFNULL(e.total_pt_q2,0) total_pt_q2,	
IFNULL(e.total_q2,0) total_q2,
IFNULL(e.didstd_q2,0) didstd_q2,

IFNULL(e.total_pt_q3,0) total_pt_q3,	
IFNULL(e.total_q3,0) total_q3,
IFNULL(e.didstd_q3,0) didstd_q3,	

IFNULL(e.total_pt_q4,0) total_pt_q4,	
IFNULL(e.total_q4,0) total_q4,
IFNULL(e.didstd_q4,0) didstd_q4
FROM chospital o 
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE, 
e.DATE_SERV,
1 servplace,
TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'1001')) age,
p.SEX sex,
@rep_year year_rep, 

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) total_pt_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.SEQ,NULL)) total_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),CONCAT(e.SEQ,'-',e.DIDSTD),NULL)) didstd_q1,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) total_pt_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.SEQ,NULL)) total_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),CONCAT(e.SEQ,'-',e.DIDSTD),NULL)) didstd_q2,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) total_pt_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.SEQ,NULL)) total_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),CONCAT(e.SEQ,'-',e.DIDSTD),NULL)) didstd_q3,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) total_pt_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.SEQ,NULL)) total_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),CONCAT(e.SEQ,'-',e.DIDSTD),NULL)) didstd_q4 
FROM 
tmp_planthai_drug_use_ipd e
LEFT JOIN tmp_admission s ON e.HOSPCODE = s.HOSPCODE AND e.PID = s.PID AND e.SEQ = s.AN 
INNER JOIN person p ON e.HOSPCODE = p.HOSPCODE AND e.PID = p.PID 
GROUP BY e.HOSPCODE, p.SEX, TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'1001'))
) e ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.HOSPCODE IS NOT NULL ;

/*************************ttmp18***************/
DROP TABLE IF  EXISTS t_ttm_ipd_18;
CREATE TABLE IF NOT EXISTS t_ttm_ipd_18( 
PRIMARY KEY (hospcode,code_rep),
KEY (hospcode),
KEY (code_rep)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
o.hoscode hospcode,
e.didstd code_rep,
IFNULL(CONCAT(e.drug_name,', ',e.drug_type),e.didstd) code_name,
@rep_year year_rep,
IFNULL(e.all_visit,0) all_visit,
IFNULL(e.all_drug,0) all_drug,
IFNULL(e.uc_visit,0) uc_visit,
IFNULL(e.uc_drug,0) uc_drug,
IFNULL(e.all_visit_error,0) all_visit_error,
IFNULL(e.all_drug_error,0) all_drug_error,
IFNULL(e.uc_visit_error,0) uc_visit_error,
IFNULL(e.uc_drug_error,0) uc_drug_error
FROM chospital o 
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE, 
e.DIDSTD didstd,
e.drug_name, 
e.drug_type,
@rep_year year_rep, 
COUNT(DISTINCT e.SEQ) as all_visit, 
COUNT(*) as all_drug, 
COUNT(DISTINCT (IF(s.INSTYPE='0100',e.SEQ,NULL))) as uc_visit , 
COUNT(IF(s.INSTYPE='0100',1,NULL)) as uc_drug,
COUNT(DISTINCT IF(e.PASS IS NULL,e.SEQ,NULL)) as all_visit_error, 
COUNT(IF(e.PASS IS NULL,e.SEQ,NULL)) as all_drug_error, 
COUNT(DISTINCT (IF(s.INSTYPE='0100' AND e.PASS IS NULL,e.SEQ,NULL))) as uc_visit_error , 
COUNT(IF(s.INSTYPE='0100' AND e.PASS IS NULL,1,NULL)) as uc_drug_error  
FROM 
tmp_planthai_drug_use_ipd e
LEFT JOIN tmp_admission s ON e.HOSPCODE = s.HOSPCODE AND e.PID = s.PID AND e.SEQ = s.AN 
GROUP BY e.HOSPCODE, e.DIDSTD 
) e ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.didstd IS NOT NULL ;

/****************ttm19******************/
DROP TABLE IF  EXISTS t_ttm_ipd_19;
CREATE TABLE IF NOT EXISTS t_ttm_ipd_19( 
PRIMARY KEY (hospcode,code_rep),
KEY (hospcode),
KEY (code_rep)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT SQL_BIG_RESULT
e.HOSPCODE ,
LEFT(DATE(e.DATESTART),7) code_rep,
IF(MONTH(e.DATESTART)=1,'มกราคม',
IF(MONTH(e.DATESTART)=2,'กุมภาพันธ์',
IF(MONTH(e.DATESTART)=3,'มีนาคม',
IF(MONTH(e.DATESTART)=4,'เมษายน',
IF(MONTH(e.DATESTART)=5,'พฤษภาคม',
IF(MONTH(e.DATESTART)=6,'มิถุนายน',
IF(MONTH(e.DATESTART)=7,'กรกฏาคม',
IF(MONTH(e.DATESTART)=8,'สิงหาคม',
IF(MONTH(e.DATESTART)=9,'กันยายน',
IF(MONTH(e.DATESTART)=10,'ตุลาคม',
IF(MONTH(e.DATESTART)=11,'พฤศจิกายน',
'ธันวาคม'))))))))))) code_name,
@rep_year year_rep,
SUM(IF(LEFT(e.DIDSTD,2) <> '41' AND LEFT(e.DIDSTD,2) <> '42',e.AMOUNT*e.DRUGPRICE,0))  price_drug ,
SUM(IF(LEFT(e.DIDSTD,2) = '41' OR LEFT(e.DIDSTD,2) = '42',e.AMOUNT*e.DRUGPRICE,0))  price_planthai_drug
FROM 
tmp_drug_ipd e 
LEFT JOIN chospital i ON e.HOSPCODE = i.hoscode 
WHERE e.DATESTART BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930')  AND i.provcode=@provid 
GROUP BY e.HOSPCODE, MONTH(e.DATESTART);

/******************************ttm20******************/
DROP TEMPORARY TABLE IF  EXISTS tmp_planthai_procedure_ipd;
CREATE TEMPORARY TABLE IF NOT EXISTS 
tmp_planthai_procedure_ipd (INDEX(HOSPCODE),INDEX(PID),INDEX(SEQ)) 
ENGINE=MYISAM IGNORE  AS 
SELECT 
e.HOSPCODE, 
e.PID, 
e.AN SEQ, 
DATE(e.TIMESTART) DATE_SERV, 
e.PROCEDCODE, 
icd.tmtype 
FROM 
tmp_procedure_ipd e 
LEFT JOIN cicd9ttm_planthai icd ON icd.`code` = e.PROCEDCODE 
WHERE DATE(e.TIMESTART) BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND icd.`code`IS NOT NULL 
;

DROP TABLE IF  EXISTS t_ttm_ipd_20;
CREATE TABLE IF NOT EXISTS t_ttm_ipd_20( 
PRIMARY KEY (hospcode,instype),
KEY (hospcode),
KEY (instype)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
e.HOSPCODE ,
IF(e.INSTYPE='0100','UC','OTHER') instype,
IFNULL(e.year_rep,@rep_year) year_rep,

IFNULL(e.pt_nod_q1,0) pt_nod_q1,
IFNULL(e.service_nod_q1,0) service_nod_q1,
IFNULL(e.pt_obb_q1,0) pt_obb_q1,
IFNULL(e.service_obb_q1,0) service_obb_q1,
IFNULL(e.pt_cop_q1,0) pt_cop_q1,
IFNULL(e.service_cop_q1,0) service_cop_q1,
IFNULL(e.pt_other_q1,0) pt_other_q1,
IFNULL(e.service_other_q1,0) service_other_q1,
IFNULL(e.pt_total_q1,0) pt_total_q1,
IFNULL(e.service_total_q1,0) service_total_q1,

IFNULL(e.pt_nod_q2,0) pt_nod_q2,
IFNULL(e.service_nod_q2,0) service_nod_q2,
IFNULL(e.pt_obb_q2,0) pt_obb_q2,
IFNULL(e.service_obb_q2,0) service_obb_q2,
IFNULL(e.pt_cop_q2,0) pt_cop_q2,
IFNULL(e.service_cop_q2,0) service_cop_q2,
IFNULL(e.pt_other_q2,0) pt_other_q2,
IFNULL(e.service_other_q2,0) service_other_q2,
IFNULL(e.pt_total_q2,0) pt_total_q2,
IFNULL(e.service_total_q2,0) service_total_q2,

IFNULL(e.pt_nod_q3,0) pt_nod_q3,
IFNULL(e.service_nod_q3,0) service_nod_q3,
IFNULL(e.pt_obb_q3,0) pt_obb_q3,
IFNULL(e.service_obb_q3,0) service_obb_q3,
IFNULL(e.pt_cop_q3,0) pt_cop_q3,
IFNULL(e.service_cop_q3,0) service_cop_q3,
IFNULL(e.pt_other_q3,0) pt_other_q3,
IFNULL(e.service_other_q3,0) service_other_q3,
IFNULL(e.pt_total_q3,0) pt_total_q3,
IFNULL(e.service_total_q3,0) service_total_q3,

IFNULL(e.pt_nod_q4,0) pt_nod_q4,
IFNULL(e.service_nod_q4,0) service_nod_q4,
IFNULL(e.pt_obb_q4,0) pt_obb_q4,
IFNULL(e.service_obb_q4,0) service_obb_q4,
IFNULL(e.pt_cop_q4,0) pt_cop_q4,
IFNULL(e.service_cop_q4,0) service_cop_q4,
IFNULL(e.pt_other_q4,0) pt_other_q4,
IFNULL(e.service_other_q4,0) service_other_q4,
IFNULL(e.pt_total_q4,0) pt_total_q4,
IFNULL(e.service_total_q4,0) service_total_q4
FROM chospital o
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE, 
s.INSTYPE,
1 SERVPLACE,
@rep_year year_rep,  

COUNT(DISTINCT IF(e.tmtype=1 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) pt_nod_q1,
COUNT(DISTINCT IF(e.tmtype=1 AND MONTH(e.DATE_SERV) IN (10,11,12),e.SEQ,NULL)) service_nod_q1,
COUNT(DISTINCT IF(e.tmtype=2 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) pt_obb_q1,
COUNT(DISTINCT IF(e.tmtype=2 AND MONTH(e.DATE_SERV) IN (10,11,12),e.SEQ,NULL)) service_obb_q1,
COUNT(DISTINCT IF(e.tmtype=3 AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) pt_cop_q1,
COUNT(DISTINCT IF(e.tmtype=3 AND MONTH(e.DATE_SERV) IN (10,11,12),e.SEQ,NULL)) service_cop_q1,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) pt_other_q1,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND MONTH(e.DATE_SERV) IN (10,11,12),e.SEQ,NULL)) service_other_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) pt_total_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.SEQ,NULL)) service_total_q1,


COUNT(DISTINCT IF(e.tmtype=1 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) pt_nod_q2,
COUNT(DISTINCT IF(e.tmtype=1 AND MONTH(e.DATE_SERV) IN (1,2,3),e.SEQ,NULL)) service_nod_q2,
COUNT(DISTINCT IF(e.tmtype=2 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) pt_obb_q2,
COUNT(DISTINCT IF(e.tmtype=2 AND MONTH(e.DATE_SERV) IN (1,2,3),e.SEQ,NULL)) service_obb_q2,
COUNT(DISTINCT IF(e.tmtype=3 AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) pt_cop_q2,
COUNT(DISTINCT IF(e.tmtype=3 AND MONTH(e.DATE_SERV) IN (1,2,3),e.SEQ,NULL)) service_cop_q2,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) pt_other_q2,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND MONTH(e.DATE_SERV) IN (1,2,3),e.SEQ,NULL)) service_other_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) pt_total_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.SEQ,NULL)) service_total_q2,


COUNT(DISTINCT IF(e.tmtype=1 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) pt_nod_q3,
COUNT(DISTINCT IF(e.tmtype=1 AND MONTH(e.DATE_SERV) IN (4,5,6),e.SEQ,NULL)) service_nod_q3,
COUNT(DISTINCT IF(e.tmtype=2 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) pt_obb_q3,
COUNT(DISTINCT IF(e.tmtype=2 AND MONTH(e.DATE_SERV) IN (4,5,6),e.SEQ,NULL)) service_obb_q3,
COUNT(DISTINCT IF(e.tmtype=3 AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) pt_cop_q3,
COUNT(DISTINCT IF(e.tmtype=3 AND MONTH(e.DATE_SERV) IN (4,5,6),e.SEQ,NULL)) service_cop_q3,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) pt_other_q3,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND MONTH(e.DATE_SERV) IN (4,5,6),e.SEQ,NULL)) service_other_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) pt_total_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.SEQ,NULL)) service_total_q3,


COUNT(DISTINCT IF(e.tmtype=1 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) pt_nod_q4,
COUNT(DISTINCT IF(e.tmtype=1 AND MONTH(e.DATE_SERV) IN (7,8,9),e.SEQ,NULL)) service_nod_q4,
COUNT(DISTINCT IF(e.tmtype=2 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) pt_obb_q4,
COUNT(DISTINCT IF(e.tmtype=2 AND MONTH(e.DATE_SERV) IN (7,8,9),e.SEQ,NULL)) service_obb_q4,
COUNT(DISTINCT IF(e.tmtype=3 AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) pt_cop_q4,
COUNT(DISTINCT IF(e.tmtype=3 AND MONTH(e.DATE_SERV) IN (7,8,9),e.SEQ,NULL)) service_cop_q4,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) pt_other_q4,
COUNT(DISTINCT IF(e.tmtype NOT IN (1,2,3) AND e.PROCEDCODE NOT IN ('9007712', '9007713', '9007714', '9007716', '9007730') AND MONTH(e.DATE_SERV) IN (7,8,9),e.SEQ,NULL)) service_other_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) pt_total_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.SEQ,NULL)) service_total_q4,

NOW() 
FROM 
tmp_planthai_procedure_ipd e 
LEFT JOIN tmp_admission s ON s.HOSPCODE = e.HOSPCODE AND s.PID = e.PID AND s.AN = e.SEQ 
GROUP BY e.HOSPCODE,  IF(s.INSTYPE='0100','UC','OTHER') 
) e ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.HOSPCODE IS NOT NULL;


 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.630264;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:439;a:5:{i:0;s:35:"DROP PROCEDURE IF EXISTS t_ttm21_25";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.630264;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:440;a:5:{i:0;s:35:"DROP PROCEDURE IF EXISTS t_ttm21_25";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.6926639;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:442;a:5:{i:0;s:19458:"CREATE PROCEDURE t_ttm21_25()
 BEGIN 
SET @provid = '58';
SET @id:= '69';
SET @rep_year = (SELECT yearprocess FROM sys_config LIMIT 1);

/*******************ttm21***********************/
DROP TEMPORARY TABLE IF  EXISTS tmp_planthai_diag_u_ipd;
CREATE TEMPORARY TABLE IF NOT EXISTS 
tmp_planthai_diag_u_ipd (INDEX(HOSPCODE),INDEX(PID),INDEX(SEQ)) 
ENGINE=MYISAM  IGNORE AS 
SELECT 
e.HOSPCODE, 
e.PID, 
e.AN SEQ, 
DATE(e.DATETIME_ADMIT) DATE_SERV, 
e.DIAGCODE, 
d.AN DRUG ,
TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'1001')) age,
p.SEX 
FROM 
tmp_diag_ipd e 
LEFT JOIN person p ON e.HOSPCODE = p.HOSPCODE AND e.PID = p.PID 
LEFT JOIN tmp_drug_ipd d ON d.HOSPCODE = e.HOSPCODE AND d.PID = e.PID AND d.AN = e.AN AND LEFT(d.DIDSTD,2) IN ('41','42') 
WHERE DATE(e.DATETIME_ADMIT) BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIAGCODE,1) = 'U' AND LEFT(e.DIAGCODE,3)<>'U77' 
;

DROP TABLE IF  EXISTS t_ttm_ipd_21;
CREATE TABLE IF NOT EXISTS t_ttm_ipd_21( 
PRIMARY KEY (hospcode,instype,diagcode,age,sex),
KEY (hospcode),
KEY (instype),
KEY (diagcode),
KEY (age),
KEY (sex)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
e.HOSPCODE ,
IF(e.INSTYPE='0100','UC','OTHER') instype,
e.DIAGCODE diagcode,
e.diseasename,
IFNULL(e.year_rep,@rep_year) year_rep,
IFNULL(e.age,0) age,
e.sex,

IFNULL(e.total_pt_q1,0) total_pt_q1,	
IFNULL(e.total_q1,0) total_q1,

IFNULL(e.total_pt_q2,0) total_pt_q2,	
IFNULL(e.total_q2,0) total_q2,

IFNULL(e.total_pt_q3,0) total_pt_q3,	
IFNULL(e.total_q3,0) total_q3,

IFNULL(e.total_pt_q4,0) total_pt_q4,	
IFNULL(e.total_q4,0) total_q4,
IFNULL(e.total_drug,0) total_drug
FROM chospital o
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE, 
s.INSTYPE,
e.DIAGCODE,
IFNULL(d.diseasethai,e.DIAGCODE) diseasename,
@rep_year year_rep,  
e.age age,
e.SEX sex,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) total_pt_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.SEQ,NULL)) total_q1,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) total_pt_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.SEQ,NULL)) total_q2,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) total_pt_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.SEQ,NULL)) total_q3,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) total_pt_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.SEQ,NULL)) total_q4,

COUNT(DISTINCT e.DRUG) total_drug
FROM 
tmp_planthai_diag_u_ipd e 
LEFT JOIN tmp_admission s ON s.HOSPCODE = e.HOSPCODE AND s.PID = e.PID AND s.AN = e.SEQ 
LEFT JOIN cdisease d ON d.diagcode = e.DIAGCODE 
WHERE e.SEX IN (1,2)
GROUP BY e.HOSPCODE, IF(s.INSTYPE='0100','UC','OTHER'), e.DIAGCODE , e.age , e.SEX 
) e ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.HOSPCODE IS NOT NULL ;

/****************************ttm22*********************/
DROP TABLE IF  EXISTS t_ttm_ipd_22;
CREATE TABLE IF NOT EXISTS t_ttm_ipd_22( 
PRIMARY KEY (hospcode,instype),
KEY (hospcode),
KEY (instype)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT SQL_BIG_RESULT 
e.HOSPCODE ,
IF(s.INSTYPE='0100','UC','OTHER') instype,
@rep_year year_rep,

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) ed_pt_q1,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) non_ed_pt_q1,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) other_pt_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) total_pt_q1,	

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (10,11,12),e.SEQ,NULL)) ed_q1,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (10,11,12),e.SEQ,NULL)) non_ed_q1,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (10,11,12),e.SEQ,NULL)) other_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.SEQ,NULL)) total_q1,	

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) ed_pt_q2,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) non_ed_pt_q2,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) other_pt_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) total_pt_q2,	

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (1,2,3),e.SEQ,NULL)) ed_q2,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (1,2,3),e.SEQ,NULL)) non_ed_q2,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (1,2,3),e.SEQ,NULL)) other_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.SEQ,NULL)) total_q2,	

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) ed_pt_q3,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) non_ed_pt_q3,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) other_pt_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) total_pt_q3,	

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (4,5,6),e.SEQ,NULL)) ed_q3,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (4,5,6),e.SEQ,NULL)) non_ed_q3,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (4,5,6),e.SEQ,NULL)) other_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.SEQ,NULL)) total_q3,	
 
COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) ed_pt_q4,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) non_ed_pt_q4,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) other_pt_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) total_pt_q4,	

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (7,8,9),e.SEQ,NULL)) ed_q4,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (7,8,9),e.SEQ,NULL)) non_ed_q4,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (7,8,9),e.SEQ,NULL)) other_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.SEQ,NULL)) total_q4 
FROM 
(
SELECT
e.HOSPCODE,
e.PID,
e.AN SEQ,
e.DATESTART DATE_SERV,
e.DIDSTD,
d.didstd PASS,
d.drug_name,
d.drug_type,
d.ed   
FROM 
tmp_drug_ipd e 
LEFT JOIN cdrug_planthai d ON d.didstd=e.DIDSTD 
WHERE 
e.DATESTART BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIDSTD,2) IN ('41','42') 
) e
LEFT JOIN tmp_admission s ON e.HOSPCODE = s.HOSPCODE AND e.PID = s.PID AND e.SEQ = s.AN 
LEFT JOIN chospital o ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.HOSPCODE IS NOT NULL  AND e.DIDSTD IS NOT NULL 
GROUP BY e.HOSPCODE, IF(s.INSTYPE='0100','UC','OTHER');

/**************************ttm23********************/
DROP TEMPORARY TABLE IF  EXISTS diag_u77_ipd;
CREATE TEMPORARY TABLE IF NOT EXISTS 
diag_u77_ipd (INDEX(pcucode,instype,age)) 
ENGINE=MYISAM IGNORE AS 
SELECT SQL_BIG_RESULT
e.HOSPCODE pcucode, 
IF(s.INSTYPE='0100','UC','OTHER') instype, 
TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'1001')) age,
COUNT(DISTINCT IF(MONTH(e.DATETIME_ADMIT) IN (10,11,12) ,e.AN,NULL)) total_u77_q1,
COUNT(DISTINCT IF(MONTH(e.DATETIME_ADMIT) IN (1,2,3) ,e.AN,NULL)) total_u77_q2,
COUNT(DISTINCT IF(MONTH(e.DATETIME_ADMIT) IN (4,5,6) ,e.AN,NULL)) total_u77_q3,
COUNT(DISTINCT IF(MONTH(e.DATETIME_ADMIT) IN (7,8,9) ,e.AN,NULL)) total_u77_q4,
COUNT(DISTINCT e.AN) total_u77
FROM 
tmp_diag_ipd e 
LEFT JOIN tmp_admission s ON s.HOSPCODE = e.HOSPCODE AND s.PID = e.PID AND s.AN = e.AN 
LEFT JOIN person p ON e.HOSPCODE = p.HOSPCODE AND e.PID = p.PID 
WHERE DATE(e.DATETIME_ADMIT) BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIAGCODE,3) = 'U77' 
GROUP BY e.HOSPCODE,  IF(s.INSTYPE='0100','UC','OTHER'), TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'1001'))
;

DROP TEMPORARY TABLE IF  EXISTS proced_u77_ipd;
CREATE TEMPORARY TABLE IF NOT EXISTS 
proced_u77_ipd (INDEX(pcucode,instype,age)) 
ENGINE=MYISAM IGNORE AS 
SELECT SQL_BIG_RESULT 
e.HOSPCODE pcucode, 
IF(s.INSTYPE='0100','UC','OTHER') instype, 
TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'-10-01')) age,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,e.PID,NULL)) total_planthai_pt_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,e.SEQ,NULL)) total_planthai_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),e.PID,NULL)) total_pt_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),e.SEQ,NULL)) total_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,e.PID,NULL)) total_planthai_pt_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,e.SEQ,NULL)) total_planthai_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),e.PID,NULL)) total_pt_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),e.SEQ,NULL)) total_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,e.PID,NULL)) total_planthai_pt_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,e.SEQ,NULL)) total_planthai_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),e.PID,NULL)) total_pt_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),e.SEQ,NULL)) total_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,e.PID,NULL)) total_planthai_pt_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,e.SEQ,NULL)) total_planthai_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),e.PID,NULL)) total_pt_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),e.SEQ,NULL)) total_q4
FROM 
(
SELECT 
e.HOSPCODE, 
e.PID, 
e.AN SEQ, 
DATE(e.TIMESTART) DATE_SERV, 
e.PROCEDCODE 
FROM 
tmp_procedure_ipd e 
LEFT JOIN tmp_diag_ipd d ON d.HOSPCODE = e.HOSPCODE AND d.PID = e.PID AND d.AN = e.AN 
WHERE DATE(e.TIMESTART) BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007903','9007904','9007998','9007999') 
AND LEFT(d.DIAGCODE,3) = 'U77' 
) e 
LEFT JOIN tmp_admission s ON s.HOSPCODE = e.HOSPCODE AND s.PID = e.PID AND s.AN = e.SEQ 
LEFT JOIN person p ON e.HOSPCODE = p.HOSPCODE AND e.PID = p.PID 
WHERE e.HOSPCODE IS NOT NULL 
GROUP BY e.HOSPCODE,  IF(s.INSTYPE='0100','UC','OTHER'), TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'1001'))
;

DROP TABLE IF  EXISTS t_ttm_ipd_23;
CREATE TABLE IF NOT EXISTS t_ttm_ipd_23( 
PRIMARY KEY (hospcode,instype,age),
KEY (hospcode),
KEY (instype),
KEY (age)
) ENGINE=MyISAM DEFAULT CHARSET=utf8  IGNORE AS
SELECT SQL_BIG_RESULT 
e.pcucode hospcode, 
e.instype, 
e.age,
@rep_year year_rep, 
e.total_u77_q1,
IFNULL(p.total_planthai_pt_q1,0) total_planthai_pt_q1,
IFNULL(p.total_planthai_q1,0) total_planthai_q1,
IFNULL(p.total_pt_q1,0) total_pt_q1,
IFNULL(p.total_q1,0) total_q1,
e.total_u77_q2,
IFNULL(p.total_planthai_pt_q2,0) total_planthai_pt_q2,
IFNULL(p.total_planthai_q2,0) total_planthai_q2,
IFNULL(p.total_pt_q2,0) total_pt_q2,
IFNULL(p.total_q2,0) total_q2,
e.total_u77_q3,
IFNULL(p.total_planthai_pt_q3,0) total_planthai_pt_q3,
IFNULL(p.total_planthai_q3,0) total_planthai_q3,
IFNULL(p.total_pt_q3,0) total_pt_q3,
IFNULL(p.total_q3,0) total_q3,
e.total_u77_q4,
IFNULL(p.total_planthai_pt_q4,0) total_planthai_pt_q4,
IFNULL(p.total_planthai_q4,0) total_planthai_q4,
IFNULL(p.total_pt_q4,0) total_pt_q4,
IFNULL(p.total_q4,0) total_q4,
(IFNULL(p.total_planthai_q1,0)+IFNULL(p.total_planthai_q2,0)+IFNULL(p.total_planthai_q3,0)+IFNULL(p.total_planthai_q4,0)) total_planthai,
(IFNULL(p.total_q1,0)+IFNULL(p.total_q2,0)+IFNULL(p.total_q3,0)+IFNULL(p.total_q4,0)) total_choice,
e.total_u77
FROM 
diag_u77_ipd e 
LEFT JOIN proced_u77_ipd p ON p.pcucode = e.pcucode AND p.instype = e.instype AND p.age = e.age 
LEFT JOIN chospital o ON e.pcucode = o.hoscode 
WHERE o.provcode=@provid ;

/**********************ttm24***************************/
DROP TEMPORARY TABLE IF  EXISTS tmp_planthai_ipd_no_z;
CREATE TEMPORARY TABLE IF NOT EXISTS 
tmp_planthai_ipd_no_z (INDEX(HOSPCODE),INDEX(code_rep)) 
ENGINE=MYISAM IGNORE AS 
SELECT SQL_BIG_RESULT
e.HOSPCODE,
LEFT(DATE(e.DATETIME_ADMIT),7) code_rep,
IF(MONTH(e.DATETIME_ADMIT)=1,'มกราคม',
IF(MONTH(e.DATETIME_ADMIT)=2,'กุมภาพันธ์',
IF(MONTH(e.DATETIME_ADMIT)=3,'มีนาคม',
IF(MONTH(e.DATETIME_ADMIT)=4,'เมษายน',
IF(MONTH(e.DATETIME_ADMIT)=5,'พฤษภาคม',
IF(MONTH(e.DATETIME_ADMIT)=6,'มิถุนายน',
IF(MONTH(e.DATETIME_ADMIT)=7,'กรกฏาคม',
IF(MONTH(e.DATETIME_ADMIT)=8,'สิงหาคม',
IF(MONTH(e.DATETIME_ADMIT)=9,'กันยายน',
IF(MONTH(e.DATETIME_ADMIT)=10,'ตุลาคม',
IF(MONTH(e.DATETIME_ADMIT)=11,'พฤศจิกายน',
'ธันวาคม'))))))))))) code_name, 
COUNT(DISTINCT e.SEQ) OP_SERVICE,
COUNT(DISTINCT e.PID) OP_SERVICE_PT
FROM tmp_admission e 
LEFT JOIN tmp_diag_ipd d ON d.HOSPCODE = e.HOSPCODE AND d.PID = e.PID AND d.AN = e.AN AND DATE(d.DATETIME_ADMIT) BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
WHERE DATE(e.DATETIME_ADMIT) BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(d.DIAGCODE,1) <> 'Z'
GROUP BY e.HOSPCODE, MONTH(e.DATETIME_ADMIT)
;

DROP TEMPORARY TABLE IF  EXISTS tmp_ttm_service_ipd;
CREATE TEMPORARY TABLE IF NOT EXISTS 
tmp_ttm_service_ipd (
`HOSPCODE`  char(5) NOT NULL ,
`PID`  varchar(16) NOT NULL ,
`SEQ`  varchar(16) NOT NULL ,
`DATE_SERV`  date NULL ,
PRIMARY KEY (`HOSPCODE`, `PID`, `SEQ`)
);

INSERT IGNORE INTO tmp_ttm_service_ipd 
SELECT e.HOSPCODE, 
e.PID,
e.AN SEQ, 
DATE(e.DATETIME_ADMIT) DATE_SERV 
FROM tmp_diag_ipd e 
WHERE DATE(e.DATETIME_ADMIT) BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIAGCODE,1) = 'U';

INSERT IGNORE INTO tmp_ttm_service_ipd
SELECT e.HOSPCODE, 
e.PID,
e.AN SEQ, 
e.DATESTART DATE_SERV 
FROM drug_ipd e 
WHERE e.DATESTART BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIDSTD,2) IN ('41','42') ;

INSERT IGNORE INTO tmp_ttm_service_ipd
SELECT e.HOSPCODE, 
e.PID,
e.AN SEQ, 
DATE(e.TIMESTART) DATE_SERV 
FROM tmp_procedure_ipd  e 
LEFT JOIN cicd9ttm_planthai p ON e.PROCEDCODE=p.`code` 
WHERE DATE(e.TIMESTART) BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND p.code IS NOT NULL ;

DROP TABLE IF  EXISTS t_ttm_ipd_24;
CREATE TABLE IF NOT EXISTS t_ttm_ipd_24( 
PRIMARY KEY (hospcode,code_rep),
KEY (hospcode),
KEY (code_rep)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
o.hoscode hospcode,
IFNULL(e.code_rep,CONCAT(@rep_year,'-10')) code_rep,
IFNULL(e.code_name,'ตุลาคม') code_name,
@rep_year year_rep,
IFNULL(e.OP_SERVICE_PT,0) op_service_pt,
IFNULL(e.OP_SERVICE,0) op_service,
IFNULL(t.TM_SERVICE_PT,0) tm_service_pt,
IFNULL(t.TM_SERVICE,0) tm_service
FROM chospital o 
LEFT JOIN 
tmp_planthai_ipd_no_z e ON e.HOSPCODE = o.hoscode 
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE,
LEFT(DATE(e.DATE_SERV),7) code_rep,
COUNT(DISTINCT e.SEQ) TM_SERVICE, 
COUNT(DISTINCT e.PID) TM_SERVICE_PT 
FROM
tmp_ttm_service_ipd e
GROUP BY e.HOSPCODE, LEFT(DATE(e.DATE_SERV),7)
) t ON t.HOSPCODE = e.HOSPCODE AND t.code_rep = e.code_rep

WHERE o.provcode=@provid 
HAVING op_service<>0  ; 

/****************************************ttm25********************/
DROP TABLE IF  EXISTS t_ttm_ipd_25;
CREATE TABLE IF NOT EXISTS t_ttm_ipd_25( 
PRIMARY KEY (hospcode,instype,didstd),
KEY (hospcode),
KEY (instype),
KEY (didstd)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS

SELECT 
o.hoscode hospcode, 
e.didstd, 
IFNULL(CONCAT(e.drug_name,', ',e.drug_type),e.didstd) code_name, 
IF(e.INSTYPE='0100','UC','OTHER') instype, 
@rep_year year_rep, 

IFNULL(e.total_pt_q1,0) total_pt_q1, 
IFNULL(e.total_q1,0) total_q1, 
IFNULL(e.total_amount_q1,0) total_amount_q1, 
IFNULL(e.total_price_q1,0) total_price_q1, 
IFNULL(e.total_cost_q1,0) total_cost_q1, 

IFNULL(e.total_pt_q2,0) total_pt_q2, 
IFNULL(e.total_q2,0) total_q2, 
IFNULL(e.total_amount_q2,0) total_amount_q2, 
IFNULL(e.total_price_q2,0) total_price_q2, 
IFNULL(e.total_cost_q2,0) total_cost_q2, 

IFNULL(e.total_pt_q3,0) total_pt_q3, 
IFNULL(e.total_q3,0) total_q3, 
IFNULL(e.total_amount_q3,0) total_amount_q3, 
IFNULL(e.total_price_q3,0) total_price_q3, 
IFNULL(e.total_cost_q3,0) total_cost_q3, 

IFNULL(e.total_pt_q4,0) total_pt_q4, 
IFNULL(e.total_q4,0) total_q4, 
IFNULL(e.total_amount_q4,0) total_amount_q4, 
IFNULL(e.total_price_q4,0) total_price_q4, 
IFNULL(e.total_cost_q4,0) total_cost_q4 
FROM chospital o 
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE, 
e.DIDSTD didstd,
e.drug_name, 
e.drug_type,
s.INSTYPE,
@rep_year year_rep, 

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) total_pt_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.SEQ,NULL)) total_q1,
SUM(IF(MONTH(e.DATE_SERV) IN (10,11,12),e.AMOUNT,0)) total_amount_q1,
SUM(IF(MONTH(e.DATE_SERV) IN (10,11,12),e.AMOUNT*e.DRUGPRICE,0)) total_price_q1,
SUM(IF(MONTH(e.DATE_SERV) IN (10,11,12),e.AMOUNT*e.DRUGCOST,0)) total_cost_q1,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) total_pt_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.SEQ,NULL)) total_q2,
SUM(IF(MONTH(e.DATE_SERV) IN (1,2,3),e.AMOUNT,0)) total_amount_q2,
SUM(IF(MONTH(e.DATE_SERV) IN (1,2,3),e.AMOUNT*e.DRUGPRICE,0)) total_price_q2,
SUM(IF(MONTH(e.DATE_SERV) IN (1,2,3),e.AMOUNT*e.DRUGCOST,0)) total_cost_q2,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) total_pt_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.SEQ,NULL)) total_q3,
SUM(IF(MONTH(e.DATE_SERV) IN (4,5,6),e.AMOUNT,0)) total_amount_q3,
SUM(IF(MONTH(e.DATE_SERV) IN (4,5,6),e.AMOUNT*e.DRUGPRICE,0)) total_price_q3,
SUM(IF(MONTH(e.DATE_SERV) IN (4,5,6),e.AMOUNT*e.DRUGCOST,0)) total_cost_q3,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) total_pt_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.SEQ,NULL)) total_q4,
SUM(IF(MONTH(e.DATE_SERV) IN (7,8,9),e.AMOUNT,0)) total_amount_q4,
SUM(IF(MONTH(e.DATE_SERV) IN (7,8,9),e.AMOUNT*e.DRUGPRICE,0)) total_price_q4,
SUM(IF(MONTH(e.DATE_SERV) IN (7,8,9),e.AMOUNT*e.DRUGCOST,0)) total_cost_q4

FROM 
 tmp_planthai_drug_use_ipd e
LEFT JOIN tmp_admission s ON e.HOSPCODE = s.HOSPCODE AND e.PID = s.PID AND e.SEQ = s.AN 
GROUP BY e.HOSPCODE,IF(s.INSTYPE='0100','UC','OTHER'), e.DIDSTD 
) e ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.HOSPCODE IS NOT NULL  AND e.didstd IS NOT NULL 



;
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.6926639;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:443;a:5:{i:0;s:19458:"CREATE PROCEDURE t_ttm21_25()
 BEGIN 
SET @provid = '58';
SET @id:= '69';
SET @rep_year = (SELECT yearprocess FROM sys_config LIMIT 1);

/*******************ttm21***********************/
DROP TEMPORARY TABLE IF  EXISTS tmp_planthai_diag_u_ipd;
CREATE TEMPORARY TABLE IF NOT EXISTS 
tmp_planthai_diag_u_ipd (INDEX(HOSPCODE),INDEX(PID),INDEX(SEQ)) 
ENGINE=MYISAM  IGNORE AS 
SELECT 
e.HOSPCODE, 
e.PID, 
e.AN SEQ, 
DATE(e.DATETIME_ADMIT) DATE_SERV, 
e.DIAGCODE, 
d.AN DRUG ,
TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'1001')) age,
p.SEX 
FROM 
tmp_diag_ipd e 
LEFT JOIN person p ON e.HOSPCODE = p.HOSPCODE AND e.PID = p.PID 
LEFT JOIN tmp_drug_ipd d ON d.HOSPCODE = e.HOSPCODE AND d.PID = e.PID AND d.AN = e.AN AND LEFT(d.DIDSTD,2) IN ('41','42') 
WHERE DATE(e.DATETIME_ADMIT) BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIAGCODE,1) = 'U' AND LEFT(e.DIAGCODE,3)<>'U77' 
;

DROP TABLE IF  EXISTS t_ttm_ipd_21;
CREATE TABLE IF NOT EXISTS t_ttm_ipd_21( 
PRIMARY KEY (hospcode,instype,diagcode,age,sex),
KEY (hospcode),
KEY (instype),
KEY (diagcode),
KEY (age),
KEY (sex)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
e.HOSPCODE ,
IF(e.INSTYPE='0100','UC','OTHER') instype,
e.DIAGCODE diagcode,
e.diseasename,
IFNULL(e.year_rep,@rep_year) year_rep,
IFNULL(e.age,0) age,
e.sex,

IFNULL(e.total_pt_q1,0) total_pt_q1,	
IFNULL(e.total_q1,0) total_q1,

IFNULL(e.total_pt_q2,0) total_pt_q2,	
IFNULL(e.total_q2,0) total_q2,

IFNULL(e.total_pt_q3,0) total_pt_q3,	
IFNULL(e.total_q3,0) total_q3,

IFNULL(e.total_pt_q4,0) total_pt_q4,	
IFNULL(e.total_q4,0) total_q4,
IFNULL(e.total_drug,0) total_drug
FROM chospital o
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE, 
s.INSTYPE,
e.DIAGCODE,
IFNULL(d.diseasethai,e.DIAGCODE) diseasename,
@rep_year year_rep,  
e.age age,
e.SEX sex,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) total_pt_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.SEQ,NULL)) total_q1,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) total_pt_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.SEQ,NULL)) total_q2,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) total_pt_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.SEQ,NULL)) total_q3,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) total_pt_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.SEQ,NULL)) total_q4,

COUNT(DISTINCT e.DRUG) total_drug
FROM 
tmp_planthai_diag_u_ipd e 
LEFT JOIN tmp_admission s ON s.HOSPCODE = e.HOSPCODE AND s.PID = e.PID AND s.AN = e.SEQ 
LEFT JOIN cdisease d ON d.diagcode = e.DIAGCODE 
WHERE e.SEX IN (1,2)
GROUP BY e.HOSPCODE, IF(s.INSTYPE='0100','UC','OTHER'), e.DIAGCODE , e.age , e.SEX 
) e ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.HOSPCODE IS NOT NULL ;

/****************************ttm22*********************/
DROP TABLE IF  EXISTS t_ttm_ipd_22;
CREATE TABLE IF NOT EXISTS t_ttm_ipd_22( 
PRIMARY KEY (hospcode,instype),
KEY (hospcode),
KEY (instype)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT SQL_BIG_RESULT 
e.HOSPCODE ,
IF(s.INSTYPE='0100','UC','OTHER') instype,
@rep_year year_rep,

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) ed_pt_q1,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) non_ed_pt_q1,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) other_pt_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) total_pt_q1,	

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (10,11,12),e.SEQ,NULL)) ed_q1,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (10,11,12),e.SEQ,NULL)) non_ed_q1,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (10,11,12),e.SEQ,NULL)) other_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.SEQ,NULL)) total_q1,	

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) ed_pt_q2,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) non_ed_pt_q2,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) other_pt_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) total_pt_q2,	

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (1,2,3),e.SEQ,NULL)) ed_q2,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (1,2,3),e.SEQ,NULL)) non_ed_q2,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (1,2,3),e.SEQ,NULL)) other_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.SEQ,NULL)) total_q2,	

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) ed_pt_q3,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) non_ed_pt_q3,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) other_pt_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) total_pt_q3,	

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (4,5,6),e.SEQ,NULL)) ed_q3,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (4,5,6),e.SEQ,NULL)) non_ed_q3,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (4,5,6),e.SEQ,NULL)) other_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.SEQ,NULL)) total_q3,	
 
COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) ed_pt_q4,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) non_ed_pt_q4,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) other_pt_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) total_pt_q4,	

COUNT(DISTINCT IF(e.ed='1' AND MONTH(e.DATE_SERV) IN (7,8,9),e.SEQ,NULL)) ed_q4,
COUNT(DISTINCT IF(e.ed IN ('2','3','4','5','6') AND MONTH(e.DATE_SERV) IN (7,8,9),e.SEQ,NULL)) non_ed_q4,
COUNT(DISTINCT IF(e.ed IS NULL AND MONTH(e.DATE_SERV) IN (7,8,9),e.SEQ,NULL)) other_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.SEQ,NULL)) total_q4 
FROM 
(
SELECT
e.HOSPCODE,
e.PID,
e.AN SEQ,
e.DATESTART DATE_SERV,
e.DIDSTD,
d.didstd PASS,
d.drug_name,
d.drug_type,
d.ed   
FROM 
tmp_drug_ipd e 
LEFT JOIN cdrug_planthai d ON d.didstd=e.DIDSTD 
WHERE 
e.DATESTART BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIDSTD,2) IN ('41','42') 
) e
LEFT JOIN tmp_admission s ON e.HOSPCODE = s.HOSPCODE AND e.PID = s.PID AND e.SEQ = s.AN 
LEFT JOIN chospital o ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.HOSPCODE IS NOT NULL  AND e.DIDSTD IS NOT NULL 
GROUP BY e.HOSPCODE, IF(s.INSTYPE='0100','UC','OTHER');

/**************************ttm23********************/
DROP TEMPORARY TABLE IF  EXISTS diag_u77_ipd;
CREATE TEMPORARY TABLE IF NOT EXISTS 
diag_u77_ipd (INDEX(pcucode,instype,age)) 
ENGINE=MYISAM IGNORE AS 
SELECT SQL_BIG_RESULT
e.HOSPCODE pcucode, 
IF(s.INSTYPE='0100','UC','OTHER') instype, 
TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'1001')) age,
COUNT(DISTINCT IF(MONTH(e.DATETIME_ADMIT) IN (10,11,12) ,e.AN,NULL)) total_u77_q1,
COUNT(DISTINCT IF(MONTH(e.DATETIME_ADMIT) IN (1,2,3) ,e.AN,NULL)) total_u77_q2,
COUNT(DISTINCT IF(MONTH(e.DATETIME_ADMIT) IN (4,5,6) ,e.AN,NULL)) total_u77_q3,
COUNT(DISTINCT IF(MONTH(e.DATETIME_ADMIT) IN (7,8,9) ,e.AN,NULL)) total_u77_q4,
COUNT(DISTINCT e.AN) total_u77
FROM 
tmp_diag_ipd e 
LEFT JOIN tmp_admission s ON s.HOSPCODE = e.HOSPCODE AND s.PID = e.PID AND s.AN = e.AN 
LEFT JOIN person p ON e.HOSPCODE = p.HOSPCODE AND e.PID = p.PID 
WHERE DATE(e.DATETIME_ADMIT) BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIAGCODE,3) = 'U77' 
GROUP BY e.HOSPCODE,  IF(s.INSTYPE='0100','UC','OTHER'), TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'1001'))
;

DROP TEMPORARY TABLE IF  EXISTS proced_u77_ipd;
CREATE TEMPORARY TABLE IF NOT EXISTS 
proced_u77_ipd (INDEX(pcucode,instype,age)) 
ENGINE=MYISAM IGNORE AS 
SELECT SQL_BIG_RESULT 
e.HOSPCODE pcucode, 
IF(s.INSTYPE='0100','UC','OTHER') instype, 
TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'-10-01')) age,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,e.PID,NULL)) total_planthai_pt_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,e.SEQ,NULL)) total_planthai_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),e.PID,NULL)) total_pt_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),e.SEQ,NULL)) total_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,e.PID,NULL)) total_planthai_pt_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,e.SEQ,NULL)) total_planthai_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),e.PID,NULL)) total_pt_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),e.SEQ,NULL)) total_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,e.PID,NULL)) total_planthai_pt_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,e.SEQ,NULL)) total_planthai_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),e.PID,NULL)) total_pt_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),e.SEQ,NULL)) total_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,e.PID,NULL)) total_planthai_pt_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9) AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007904') ,e.SEQ,NULL)) total_planthai_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),e.PID,NULL)) total_pt_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9) AND e.PROCEDCODE IN ('9007903','9007998','9007999'),e.SEQ,NULL)) total_q4
FROM 
(
SELECT 
e.HOSPCODE, 
e.PID, 
e.AN SEQ, 
DATE(e.TIMESTART) DATE_SERV, 
e.PROCEDCODE 
FROM 
tmp_procedure_ipd e 
LEFT JOIN tmp_diag_ipd d ON d.HOSPCODE = e.HOSPCODE AND d.PID = e.PID AND d.AN = e.AN 
WHERE DATE(e.TIMESTART) BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND e.PROCEDCODE IN ('9007900','9007901','9007902','9007903','9007904','9007998','9007999') 
AND LEFT(d.DIAGCODE,3) = 'U77' 
) e 
LEFT JOIN tmp_admission s ON s.HOSPCODE = e.HOSPCODE AND s.PID = e.PID AND s.AN = e.SEQ 
LEFT JOIN person p ON e.HOSPCODE = p.HOSPCODE AND e.PID = p.PID 
WHERE e.HOSPCODE IS NOT NULL 
GROUP BY e.HOSPCODE,  IF(s.INSTYPE='0100','UC','OTHER'), TIMESTAMPDIFF(YEAR,p.BIRTH,CONCAT((@rep_year-1),'1001'))
;

DROP TABLE IF  EXISTS t_ttm_ipd_23;
CREATE TABLE IF NOT EXISTS t_ttm_ipd_23( 
PRIMARY KEY (hospcode,instype,age),
KEY (hospcode),
KEY (instype),
KEY (age)
) ENGINE=MyISAM DEFAULT CHARSET=utf8  IGNORE AS
SELECT SQL_BIG_RESULT 
e.pcucode hospcode, 
e.instype, 
e.age,
@rep_year year_rep, 
e.total_u77_q1,
IFNULL(p.total_planthai_pt_q1,0) total_planthai_pt_q1,
IFNULL(p.total_planthai_q1,0) total_planthai_q1,
IFNULL(p.total_pt_q1,0) total_pt_q1,
IFNULL(p.total_q1,0) total_q1,
e.total_u77_q2,
IFNULL(p.total_planthai_pt_q2,0) total_planthai_pt_q2,
IFNULL(p.total_planthai_q2,0) total_planthai_q2,
IFNULL(p.total_pt_q2,0) total_pt_q2,
IFNULL(p.total_q2,0) total_q2,
e.total_u77_q3,
IFNULL(p.total_planthai_pt_q3,0) total_planthai_pt_q3,
IFNULL(p.total_planthai_q3,0) total_planthai_q3,
IFNULL(p.total_pt_q3,0) total_pt_q3,
IFNULL(p.total_q3,0) total_q3,
e.total_u77_q4,
IFNULL(p.total_planthai_pt_q4,0) total_planthai_pt_q4,
IFNULL(p.total_planthai_q4,0) total_planthai_q4,
IFNULL(p.total_pt_q4,0) total_pt_q4,
IFNULL(p.total_q4,0) total_q4,
(IFNULL(p.total_planthai_q1,0)+IFNULL(p.total_planthai_q2,0)+IFNULL(p.total_planthai_q3,0)+IFNULL(p.total_planthai_q4,0)) total_planthai,
(IFNULL(p.total_q1,0)+IFNULL(p.total_q2,0)+IFNULL(p.total_q3,0)+IFNULL(p.total_q4,0)) total_choice,
e.total_u77
FROM 
diag_u77_ipd e 
LEFT JOIN proced_u77_ipd p ON p.pcucode = e.pcucode AND p.instype = e.instype AND p.age = e.age 
LEFT JOIN chospital o ON e.pcucode = o.hoscode 
WHERE o.provcode=@provid ;

/**********************ttm24***************************/
DROP TEMPORARY TABLE IF  EXISTS tmp_planthai_ipd_no_z;
CREATE TEMPORARY TABLE IF NOT EXISTS 
tmp_planthai_ipd_no_z (INDEX(HOSPCODE),INDEX(code_rep)) 
ENGINE=MYISAM IGNORE AS 
SELECT SQL_BIG_RESULT
e.HOSPCODE,
LEFT(DATE(e.DATETIME_ADMIT),7) code_rep,
IF(MONTH(e.DATETIME_ADMIT)=1,'มกราคม',
IF(MONTH(e.DATETIME_ADMIT)=2,'กุมภาพันธ์',
IF(MONTH(e.DATETIME_ADMIT)=3,'มีนาคม',
IF(MONTH(e.DATETIME_ADMIT)=4,'เมษายน',
IF(MONTH(e.DATETIME_ADMIT)=5,'พฤษภาคม',
IF(MONTH(e.DATETIME_ADMIT)=6,'มิถุนายน',
IF(MONTH(e.DATETIME_ADMIT)=7,'กรกฏาคม',
IF(MONTH(e.DATETIME_ADMIT)=8,'สิงหาคม',
IF(MONTH(e.DATETIME_ADMIT)=9,'กันยายน',
IF(MONTH(e.DATETIME_ADMIT)=10,'ตุลาคม',
IF(MONTH(e.DATETIME_ADMIT)=11,'พฤศจิกายน',
'ธันวาคม'))))))))))) code_name, 
COUNT(DISTINCT e.SEQ) OP_SERVICE,
COUNT(DISTINCT e.PID) OP_SERVICE_PT
FROM tmp_admission e 
LEFT JOIN tmp_diag_ipd d ON d.HOSPCODE = e.HOSPCODE AND d.PID = e.PID AND d.AN = e.AN AND DATE(d.DATETIME_ADMIT) BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
WHERE DATE(e.DATETIME_ADMIT) BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(d.DIAGCODE,1) <> 'Z'
GROUP BY e.HOSPCODE, MONTH(e.DATETIME_ADMIT)
;

DROP TEMPORARY TABLE IF  EXISTS tmp_ttm_service_ipd;
CREATE TEMPORARY TABLE IF NOT EXISTS 
tmp_ttm_service_ipd (
`HOSPCODE`  char(5) NOT NULL ,
`PID`  varchar(16) NOT NULL ,
`SEQ`  varchar(16) NOT NULL ,
`DATE_SERV`  date NULL ,
PRIMARY KEY (`HOSPCODE`, `PID`, `SEQ`)
);

INSERT IGNORE INTO tmp_ttm_service_ipd 
SELECT e.HOSPCODE, 
e.PID,
e.AN SEQ, 
DATE(e.DATETIME_ADMIT) DATE_SERV 
FROM tmp_diag_ipd e 
WHERE DATE(e.DATETIME_ADMIT) BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIAGCODE,1) = 'U';

INSERT IGNORE INTO tmp_ttm_service_ipd
SELECT e.HOSPCODE, 
e.PID,
e.AN SEQ, 
e.DATESTART DATE_SERV 
FROM drug_ipd e 
WHERE e.DATESTART BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND LEFT(e.DIDSTD,2) IN ('41','42') ;

INSERT IGNORE INTO tmp_ttm_service_ipd
SELECT e.HOSPCODE, 
e.PID,
e.AN SEQ, 
DATE(e.TIMESTART) DATE_SERV 
FROM tmp_procedure_ipd  e 
LEFT JOIN cicd9ttm_planthai p ON e.PROCEDCODE=p.`code` 
WHERE DATE(e.TIMESTART) BETWEEN CONCAT((@rep_year-1),'1001') AND CONCAT(@rep_year,'0930') 
AND p.code IS NOT NULL ;

DROP TABLE IF  EXISTS t_ttm_ipd_24;
CREATE TABLE IF NOT EXISTS t_ttm_ipd_24( 
PRIMARY KEY (hospcode,code_rep),
KEY (hospcode),
KEY (code_rep)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS
SELECT 
o.hoscode hospcode,
IFNULL(e.code_rep,CONCAT(@rep_year,'-10')) code_rep,
IFNULL(e.code_name,'ตุลาคม') code_name,
@rep_year year_rep,
IFNULL(e.OP_SERVICE_PT,0) op_service_pt,
IFNULL(e.OP_SERVICE,0) op_service,
IFNULL(t.TM_SERVICE_PT,0) tm_service_pt,
IFNULL(t.TM_SERVICE,0) tm_service
FROM chospital o 
LEFT JOIN 
tmp_planthai_ipd_no_z e ON e.HOSPCODE = o.hoscode 
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE,
LEFT(DATE(e.DATE_SERV),7) code_rep,
COUNT(DISTINCT e.SEQ) TM_SERVICE, 
COUNT(DISTINCT e.PID) TM_SERVICE_PT 
FROM
tmp_ttm_service_ipd e
GROUP BY e.HOSPCODE, LEFT(DATE(e.DATE_SERV),7)
) t ON t.HOSPCODE = e.HOSPCODE AND t.code_rep = e.code_rep

WHERE o.provcode=@provid 
HAVING op_service<>0  ; 

/****************************************ttm25********************/
DROP TABLE IF  EXISTS t_ttm_ipd_25;
CREATE TABLE IF NOT EXISTS t_ttm_ipd_25( 
PRIMARY KEY (hospcode,instype,didstd),
KEY (hospcode),
KEY (instype),
KEY (didstd)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 IGNORE AS

SELECT 
o.hoscode hospcode, 
e.didstd, 
IFNULL(CONCAT(e.drug_name,', ',e.drug_type),e.didstd) code_name, 
IF(e.INSTYPE='0100','UC','OTHER') instype, 
@rep_year year_rep, 

IFNULL(e.total_pt_q1,0) total_pt_q1, 
IFNULL(e.total_q1,0) total_q1, 
IFNULL(e.total_amount_q1,0) total_amount_q1, 
IFNULL(e.total_price_q1,0) total_price_q1, 
IFNULL(e.total_cost_q1,0) total_cost_q1, 

IFNULL(e.total_pt_q2,0) total_pt_q2, 
IFNULL(e.total_q2,0) total_q2, 
IFNULL(e.total_amount_q2,0) total_amount_q2, 
IFNULL(e.total_price_q2,0) total_price_q2, 
IFNULL(e.total_cost_q2,0) total_cost_q2, 

IFNULL(e.total_pt_q3,0) total_pt_q3, 
IFNULL(e.total_q3,0) total_q3, 
IFNULL(e.total_amount_q3,0) total_amount_q3, 
IFNULL(e.total_price_q3,0) total_price_q3, 
IFNULL(e.total_cost_q3,0) total_cost_q3, 

IFNULL(e.total_pt_q4,0) total_pt_q4, 
IFNULL(e.total_q4,0) total_q4, 
IFNULL(e.total_amount_q4,0) total_amount_q4, 
IFNULL(e.total_price_q4,0) total_price_q4, 
IFNULL(e.total_cost_q4,0) total_cost_q4 
FROM chospital o 
LEFT JOIN 
(
SELECT SQL_BIG_RESULT 
e.HOSPCODE, 
e.DIDSTD didstd,
e.drug_name, 
e.drug_type,
s.INSTYPE,
@rep_year year_rep, 

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.PID,NULL)) total_pt_q1,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (10,11,12),e.SEQ,NULL)) total_q1,
SUM(IF(MONTH(e.DATE_SERV) IN (10,11,12),e.AMOUNT,0)) total_amount_q1,
SUM(IF(MONTH(e.DATE_SERV) IN (10,11,12),e.AMOUNT*e.DRUGPRICE,0)) total_price_q1,
SUM(IF(MONTH(e.DATE_SERV) IN (10,11,12),e.AMOUNT*e.DRUGCOST,0)) total_cost_q1,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.PID,NULL)) total_pt_q2,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (1,2,3),e.SEQ,NULL)) total_q2,
SUM(IF(MONTH(e.DATE_SERV) IN (1,2,3),e.AMOUNT,0)) total_amount_q2,
SUM(IF(MONTH(e.DATE_SERV) IN (1,2,3),e.AMOUNT*e.DRUGPRICE,0)) total_price_q2,
SUM(IF(MONTH(e.DATE_SERV) IN (1,2,3),e.AMOUNT*e.DRUGCOST,0)) total_cost_q2,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.PID,NULL)) total_pt_q3,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (4,5,6),e.SEQ,NULL)) total_q3,
SUM(IF(MONTH(e.DATE_SERV) IN (4,5,6),e.AMOUNT,0)) total_amount_q3,
SUM(IF(MONTH(e.DATE_SERV) IN (4,5,6),e.AMOUNT*e.DRUGPRICE,0)) total_price_q3,
SUM(IF(MONTH(e.DATE_SERV) IN (4,5,6),e.AMOUNT*e.DRUGCOST,0)) total_cost_q3,

COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.PID,NULL)) total_pt_q4,
COUNT(DISTINCT IF(MONTH(e.DATE_SERV) IN (7,8,9),e.SEQ,NULL)) total_q4,
SUM(IF(MONTH(e.DATE_SERV) IN (7,8,9),e.AMOUNT,0)) total_amount_q4,
SUM(IF(MONTH(e.DATE_SERV) IN (7,8,9),e.AMOUNT*e.DRUGPRICE,0)) total_price_q4,
SUM(IF(MONTH(e.DATE_SERV) IN (7,8,9),e.AMOUNT*e.DRUGCOST,0)) total_cost_q4

FROM 
 tmp_planthai_drug_use_ipd e
LEFT JOIN tmp_admission s ON e.HOSPCODE = s.HOSPCODE AND e.PID = s.PID AND e.SEQ = s.AN 
GROUP BY e.HOSPCODE,IF(s.INSTYPE='0100','UC','OTHER'), e.DIDSTD 
) e ON e.HOSPCODE = o.hoscode 
WHERE o.provcode=@provid AND e.HOSPCODE IS NOT NULL  AND e.didstd IS NOT NULL 



;
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.8018639;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:445;a:5:{i:0;s:30:"DROP PROCEDURE IF EXISTS t_rdu";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.8018639;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:446;a:5:{i:0;s:30:"DROP PROCEDURE IF EXISTS t_rdu";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.848664;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:448;a:5:{i:0;s:2531:"CREATE PROCEDURE t_rdu()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '70';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS tmp_diag_asu;
CREATE TABLE IF NOT EXISTS tmp_diag_asu (
PRIMARY KEY (`HOSPCODE`,`PID`,`SEQ`,`GROUP_ASU_PROJECT`),
KEY(hospcode,pid,seq),
KEY (GROUP_ASU_PROJECT),
KEY(cid),KEY(hospcode),KEY(pid),KEY(seq),KEY(date_serv),KEY(diagcode),KEY(diagtype)
) ENGINE=MyISAM IGNORE  AS
SELECT o.*,a.GROUP_ASU_PROJECT FROM	tmp_diag_opd o INNER JOIN cdiag_asu a 
   ON (SUBSTR(o.DIAGCODE,1,3)=a.`CODE` OR SUBSTR(o.DIAGCODE,1,4)=a.`CODE`)
WHERE	DATE_SERV BETWEEN  @start_d AND @end_d 
GROUP BY HOSPCODE,PID,SEQ,GROUP_ASU_PROJECT;

/***ตรวจสอบการจ่ายยา ไม่มีไม่นับ****/
DELETE o  FROM tmp_diag_asu o LEFT JOIN tmp_drug_opd d ON o.hospcode=d.HOSPCODE AND o.pid=d.pid AND o.seq=d.SEQ
WHERE  d.HOSPCODE is NULL;
/**หาเฉพาะ visit ที่มีการจ่ายยาปฏิชีวนะจะมีกี่ตัวก็แล้วแต่นับมา 1 visit**/
DROP TABLE IF EXISTS tmp_drug_asu;
CREATE TABLE IF NOT EXISTS tmp_drug_asu (
	cid VARCHAR(13) DEFAULT NULL,
	PRIMARY KEY (`HOSPCODE`,`PID`,`SEQ`), 
  KEY (`HOSPCODE`,`PID`,`SEQ`),
  KEY `idx1` (`HOSPCODE`,`PID`),
  KEY `idx2` (`DATE_SERV`),
  KEY `idx4` (`DIDSTD`),
	KEY (cid)
	) ENGINE=MyISAM  AS(
SELECT y.* FROM	tmp_drug_opd y INNER JOIN cdrug_asu s ON SUBSTR(y.DIDSTD,1,19) =SUBSTR(s.drugcode,1,19)
WHERE	DATE_SERV BETWEEN  @start_d AND @end_d
GROUP BY HOSPCODE,PID,SEQ
);

/**หาเฉพาะ AN ที่มีการจ่ายยาปฏิชีวนะตามวันที่จ่ายเพื่อไป mapping กับวันที่คลอด**/
DROP TABLE IF EXISTS tmp_drug_asu_ipd;
CREATE TABLE IF NOT EXISTS tmp_drug_asu_ipd (
	cid VARCHAR(13) DEFAULT NULL,
	PRIMARY KEY (`HOSPCODE`,`PID`,`AN`,`DATETIME_ADMIT`,`TYPEDRUG`,`DIDSTD`),
  KEY (`HOSPCODE`,`PID`,`AN`),
	KEY (`HOSPCODE`,`AN`),
  KEY  (`HOSPCODE`,`PID`),
  KEY  (`DATESTART`),
  KEY  (`DATEFINISH`),
  KEY  (`DIDSTD`),
	KEY (cid)
	) ENGINE=MyISAM  AS(
SELECT y.* FROM	tmp_drug_ipd y INNER JOIN cdrug_asu s ON SUBSTR(y.DIDSTD,1,19) =SUBSTR(s.drugcode,1,19)
WHERE	(DATETIME_ADMIT BETWEEN  @start_d AND @end_d) OR (DATEFINISH  BETWEEN  @start_d AND @end_d)
GROUP BY HOSPCODE,PID,AN,DATETIME_ADMIT,TYPEDRUG,DIDSTD
);

 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.848664;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:449;a:5:{i:0;s:2531:"CREATE PROCEDURE t_rdu()
 BEGIN 
SET @prov_c := '58';
SET	@id:= '70';
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET @start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS tmp_diag_asu;
CREATE TABLE IF NOT EXISTS tmp_diag_asu (
PRIMARY KEY (`HOSPCODE`,`PID`,`SEQ`,`GROUP_ASU_PROJECT`),
KEY(hospcode,pid,seq),
KEY (GROUP_ASU_PROJECT),
KEY(cid),KEY(hospcode),KEY(pid),KEY(seq),KEY(date_serv),KEY(diagcode),KEY(diagtype)
) ENGINE=MyISAM IGNORE  AS
SELECT o.*,a.GROUP_ASU_PROJECT FROM	tmp_diag_opd o INNER JOIN cdiag_asu a 
   ON (SUBSTR(o.DIAGCODE,1,3)=a.`CODE` OR SUBSTR(o.DIAGCODE,1,4)=a.`CODE`)
WHERE	DATE_SERV BETWEEN  @start_d AND @end_d 
GROUP BY HOSPCODE,PID,SEQ,GROUP_ASU_PROJECT;

/***ตรวจสอบการจ่ายยา ไม่มีไม่นับ****/
DELETE o  FROM tmp_diag_asu o LEFT JOIN tmp_drug_opd d ON o.hospcode=d.HOSPCODE AND o.pid=d.pid AND o.seq=d.SEQ
WHERE  d.HOSPCODE is NULL;
/**หาเฉพาะ visit ที่มีการจ่ายยาปฏิชีวนะจะมีกี่ตัวก็แล้วแต่นับมา 1 visit**/
DROP TABLE IF EXISTS tmp_drug_asu;
CREATE TABLE IF NOT EXISTS tmp_drug_asu (
	cid VARCHAR(13) DEFAULT NULL,
	PRIMARY KEY (`HOSPCODE`,`PID`,`SEQ`), 
  KEY (`HOSPCODE`,`PID`,`SEQ`),
  KEY `idx1` (`HOSPCODE`,`PID`),
  KEY `idx2` (`DATE_SERV`),
  KEY `idx4` (`DIDSTD`),
	KEY (cid)
	) ENGINE=MyISAM  AS(
SELECT y.* FROM	tmp_drug_opd y INNER JOIN cdrug_asu s ON SUBSTR(y.DIDSTD,1,19) =SUBSTR(s.drugcode,1,19)
WHERE	DATE_SERV BETWEEN  @start_d AND @end_d
GROUP BY HOSPCODE,PID,SEQ
);

/**หาเฉพาะ AN ที่มีการจ่ายยาปฏิชีวนะตามวันที่จ่ายเพื่อไป mapping กับวันที่คลอด**/
DROP TABLE IF EXISTS tmp_drug_asu_ipd;
CREATE TABLE IF NOT EXISTS tmp_drug_asu_ipd (
	cid VARCHAR(13) DEFAULT NULL,
	PRIMARY KEY (`HOSPCODE`,`PID`,`AN`,`DATETIME_ADMIT`,`TYPEDRUG`,`DIDSTD`),
  KEY (`HOSPCODE`,`PID`,`AN`),
	KEY (`HOSPCODE`,`AN`),
  KEY  (`HOSPCODE`,`PID`),
  KEY  (`DATESTART`),
  KEY  (`DATEFINISH`),
  KEY  (`DIDSTD`),
	KEY (cid)
	) ENGINE=MyISAM  AS(
SELECT y.* FROM	tmp_drug_ipd y INNER JOIN cdrug_asu s ON SUBSTR(y.DIDSTD,1,19) =SUBSTR(s.drugcode,1,19)
WHERE	(DATETIME_ADMIT BETWEEN  @start_d AND @end_d) OR (DATEFINISH  BETWEEN  @start_d AND @end_d)
GROUP BY HOSPCODE,PID,AN,DATETIME_ADMIT,TYPEDRUG,DIDSTD
);

 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.9110651;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:451;a:5:{i:0;s:38:"DROP PROCEDURE IF EXISTS t_person_home";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988057.9110651;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:452;a:5:{i:0;s:38:"DROP PROCEDURE IF EXISTS t_person_home";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.051465;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:454;a:5:{i:0;s:414:"CREATE PROCEDURE t_person_home()
 BEGIN 
DROP TABLE IF EXISTS t_person_home;

CREATE TABLE t_person_home (
KEY (cid),
KEY (hospcode,cid),
KEY (hid)
)ENGINE=MyISAM  AS(
SELECT  SQL_BIG_RESULT 
 t.HOSPCODE,t.PID,t.CID ,CONCAT(t.HOSPCODE,t.HID) HID ,h.HOUSE_ID,h.LATITUDE,h.LONGITUDE
FROM t_person_cid t 
LEFT JOIN home h ON t.HOSPCODE = h.HOSPCODE AND t.HID = h.HID
WHERE t.TYPEAREA in (1,3,5)
);
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.051465;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:455;a:5:{i:0;s:414:"CREATE PROCEDURE t_person_home()
 BEGIN 
DROP TABLE IF EXISTS t_person_home;

CREATE TABLE t_person_home (
KEY (cid),
KEY (hospcode,cid),
KEY (hid)
)ENGINE=MyISAM  AS(
SELECT  SQL_BIG_RESULT 
 t.HOSPCODE,t.PID,t.CID ,CONCAT(t.HOSPCODE,t.HID) HID ,h.HOUSE_ID,h.LATITUDE,h.LONGITUDE
FROM t_person_cid t 
LEFT JOIN home h ON t.HOSPCODE = h.HOSPCODE AND t.HID = h.HID
WHERE t.TYPEAREA in (1,3,5)
);
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.0982649;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:457;a:5:{i:0;s:36:"DROP PROCEDURE IF EXISTS t_house_gis";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.0982649;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:458;a:5:{i:0;s:36:"DROP PROCEDURE IF EXISTS t_house_gis";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.1450651;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:460;a:5:{i:0;s:533:"CREATE PROCEDURE t_house_gis()
 BEGIN 
DROP TABLE IF EXISTS t_house_gis;
CREATE TABLE IF NOT EXISTS t_house_gis (
SELECT h.HOSPCODE,h.HID,h.HOUSE_ID,CONCAT(h.CHANGWAT,h.AMPUR,h.TAMBON,h.VILLAGE) AREACODE,h.HEADID
,'' HEAD_NAME,h.HOUSE,h.VILLAGE,h.TAMBON,tmb.tambonname TAMBON_NAMT,h.LATITUDE,h.LONGITUDE 
,if((h.LATITUDE BETWEEN 4 AND 25) and (h.LONGITUDE BETWEEN 95 AND 108),'Y',NULL) GIS
from home h 
LEFT JOIN ctambon_amp tmb on tmb.tamboncodefull = CONCAT(h.CHANGWAT,h.AMPUR,h.TAMBON)
GROUP BY h.HOSPCODE,h.HID
);
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.1450651;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:461;a:5:{i:0;s:533:"CREATE PROCEDURE t_house_gis()
 BEGIN 
DROP TABLE IF EXISTS t_house_gis;
CREATE TABLE IF NOT EXISTS t_house_gis (
SELECT h.HOSPCODE,h.HID,h.HOUSE_ID,CONCAT(h.CHANGWAT,h.AMPUR,h.TAMBON,h.VILLAGE) AREACODE,h.HEADID
,'' HEAD_NAME,h.HOUSE,h.VILLAGE,h.TAMBON,tmb.tambonname TAMBON_NAMT,h.LATITUDE,h.LONGITUDE 
,if((h.LATITUDE BETWEEN 4 AND 25) and (h.LONGITUDE BETWEEN 95 AND 108),'Y',NULL) GIS
from home h 
LEFT JOIN ctambon_amp tmb on tmb.tamboncodefull = CONCAT(h.CHANGWAT,h.AMPUR,h.TAMBON)
GROUP BY h.HOSPCODE,h.HID
);
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.191865;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:463;a:5:{i:0;s:35:"DROP PROCEDURE IF EXISTS t_home_gis";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.191865;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:464;a:5:{i:0;s:35:"DROP PROCEDURE IF EXISTS t_home_gis";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.2386651;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:466;a:5:{i:0;s:197:"CREATE PROCEDURE t_home_gis()
 BEGIN 
REPLACE INTO t_home_gis (
SELECT t.HOSPCODE,CONCAT(t.CHANGWAT,t.AMPUR,t.TAMBON,t.VILLAGE) VCODE,t.HID,t.HOUSE,t.LATITUDE,t.LONGITUDE 
FROM home t
);
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.2386651;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:467;a:5:{i:0;s:197:"CREATE PROCEDURE t_home_gis()
 BEGIN 
REPLACE INTO t_home_gis (
SELECT t.HOSPCODE,CONCAT(t.CHANGWAT,t.AMPUR,t.TAMBON,t.VILLAGE) VCODE,t.HID,t.HOUSE,t.LATITUDE,t.LONGITUDE 
FROM home t
);
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.301065;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:469;a:5:{i:0;s:32:"DROP PROCEDURE IF EXISTS tst_pop";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.301065;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:470;a:5:{i:0;s:32:"DROP PROCEDURE IF EXISTS tst_pop";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.3654649;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:472;a:5:{i:0;s:5601:"CREATE PROCEDURE tst_pop()
 BEGIN 
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS tst_pop;

CREATE TABLE `tst_pop` (
  `cid` varchar(255) NOT NULL,
  `birth` varchar(255) DEFAULT NULL,
  `sex` varchar(255) DEFAULT NULL,
  `s_age` decimal(11,2) DEFAULT NULL,
  `e_age` decimal(11,2) DEFAULT NULL,
  `pop_group` varchar(255) DEFAULT NULL,
  PRIMARY KEY (`cid`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;


REPLACE INTO tst_pop (
SELECT t.CID,t.BIRTH,t.SEX
,TIMESTAMPDIFF(MONTH,t.BIRTH,@start_d)/12
,TIMESTAMPDIFF(MONTH,t.BIRTH,@end_d)/12
,'' FROM t_person_cid t WHERE t.TYPEAREA in (1,3)
AND t.DISCHARGE =9
);

#1
UPDATE tst_pop t,tmp_labor a set t.pop_group = CONCAT(t.pop_group,',',1)
WHERE (a.cid = t.cid) AND (a.BDATE BETWEEN @start_d AND @end_d);

#2
UPDATE tst_pop t,tmp_labor a set t.pop_group = CONCAT(t.pop_group,',',2)
WHERE (a.cid = t.cid) AND a.BTYPE <> '6' AND  (a.BDATE BETWEEN @start_d AND @end_d);

#3
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',3)
WHERE  t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 6 MONTH) AND DATE_SUB(@end_d,INTERVAL 0 MONTH);

#4
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',4)
WHERE  t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 4 MONTH) AND DATE_SUB(@end_d,INTERVAL 4 MONTH);

#5
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',5)
WHERE  t.birth BETWEEN DATE_SUB(@start_d,INTERVAL 5 YEAR) AND DATE_SUB(@end_d,INTERVAL 0 YEAR);

#6
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',6)
WHERE  t.birth > DATE_SUB(@start_d,INTERVAL 7 YEAR);

#7
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',7)
WHERE  t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 1 YEAR) AND DATE_SUB(@end_d,INTERVAL 1 YEAR);

#8
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',8)
WHERE  t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 2 YEAR) AND DATE_SUB(@end_d,INTERVAL 2 YEAR);

#9
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',9)
WHERE  t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 3 YEAR) AND DATE_SUB(@end_d,INTERVAL 3 YEAR);

#10
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',10)
WHERE  t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 5 YEAR) AND DATE_SUB(@end_d,INTERVAL 5 YEAR);

#11
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',11)
WHERE   t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 12 YEAR) AND DATE_SUB(@end_d,INTERVAL 6 YEAR);

#12
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',12)
WHERE   t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 7 YEAR) AND DATE_SUB(@end_d,INTERVAL 7 YEAR);

#13
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',13)
WHERE   t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 8 YEAR) AND DATE_SUB(@end_d,INTERVAL 8 YEAR);

#14
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',14)
WHERE   t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 12 YEAR) AND DATE_SUB(@end_d,INTERVAL 12 YEAR);

#15
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',15)
WHERE   t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 12 YEAR) AND DATE_SUB(@end_d,INTERVAL 6 YEAR);

#16
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',16)
WHERE   t.birth >  DATE_SUB(@start_d,INTERVAL 12 YEAR);

#17
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',17)
WHERE   t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 18 YEAR) AND DATE_SUB(@end_d,INTERVAL 18 YEAR);

#18
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',18)
WHERE   t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 19 YEAR) AND DATE_SUB(@end_d,INTERVAL 15 YEAR)
AND t.sex=2;

#19
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',19)
WHERE   t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 20 YEAR) AND DATE_SUB(@end_d,INTERVAL 15 YEAR)
AND t.sex=2;

#20
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',20)
WHERE   t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 60 YEAR) AND DATE_SUB(@end_d,INTERVAL 30 YEAR)
AND t.sex=2;

#21
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',21)
WHERE   t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 70 YEAR) AND DATE_SUB(@end_d,INTERVAL 30 YEAR)
AND t.sex=2;

#22
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',22)
WHERE   t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 120 YEAR) AND DATE_SUB(@end_d,INTERVAL 35 YEAR);

#23
UPDATE tst_pop t,(
SELECT o.CID,d.codemental FROM tmp_diag_opd o, cdisease d WHERE o.diagcode= d.diagcode AND d.codemental is not NULL
) a SET t.pop_group = CONCAT(t.pop_group,',',23)
WHERE t.cid = a.CID;

#24
UPDATE tst_pop t,(
SELECT t.cid from t_dmht t WHERE  FIND_IN_SET('E',t.t_mix_dx) AND NOT FIND_IN_SET('I',t.t_mix_dx)
) a SET t.pop_group = CONCAT(t.pop_group,',',24)
WHERE t.cid = a.CID;

#25
UPDATE tst_pop t,(
SELECT t.cid from t_dmht t WHERE  FIND_IN_SET('I',t.t_mix_dx) AND NOT FIND_IN_SET('E',t.t_mix_dx)
) a SET t.pop_group = CONCAT(t.pop_group,',',25)
WHERE t.cid = a.CID;

#26
UPDATE tst_pop t,(
SELECT t.cid from t_dmht t WHERE  FIND_IN_SET('E',t.t_mix_dx) AND  FIND_IN_SET('I',t.t_mix_dx)
) a SET t.pop_group = CONCAT(t.pop_group,',',26)
WHERE t.cid = a.CID;

#27
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',27)
WHERE   t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 120 YEAR) AND DATE_SUB(@end_d,INTERVAL 60 YEAR);

#28
UPDATE tst_pop t,(

SELECT t.HOSPCODE,t.PID,p.CID from disability t
LEFT JOIN t_person_cid p on p.HOSPCODE = t.HOSPCODE AND p.PID = t.PID

) a SET t.pop_group = CONCAT(t.pop_group,',',28)
WHERE t.cid = a.CID;
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.3654649;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:473;a:5:{i:0;s:5601:"CREATE PROCEDURE tst_pop()
 BEGIN 
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

DROP TABLE IF EXISTS tst_pop;

CREATE TABLE `tst_pop` (
  `cid` varchar(255) NOT NULL,
  `birth` varchar(255) DEFAULT NULL,
  `sex` varchar(255) DEFAULT NULL,
  `s_age` decimal(11,2) DEFAULT NULL,
  `e_age` decimal(11,2) DEFAULT NULL,
  `pop_group` varchar(255) DEFAULT NULL,
  PRIMARY KEY (`cid`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;


REPLACE INTO tst_pop (
SELECT t.CID,t.BIRTH,t.SEX
,TIMESTAMPDIFF(MONTH,t.BIRTH,@start_d)/12
,TIMESTAMPDIFF(MONTH,t.BIRTH,@end_d)/12
,'' FROM t_person_cid t WHERE t.TYPEAREA in (1,3)
AND t.DISCHARGE =9
);

#1
UPDATE tst_pop t,tmp_labor a set t.pop_group = CONCAT(t.pop_group,',',1)
WHERE (a.cid = t.cid) AND (a.BDATE BETWEEN @start_d AND @end_d);

#2
UPDATE tst_pop t,tmp_labor a set t.pop_group = CONCAT(t.pop_group,',',2)
WHERE (a.cid = t.cid) AND a.BTYPE <> '6' AND  (a.BDATE BETWEEN @start_d AND @end_d);

#3
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',3)
WHERE  t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 6 MONTH) AND DATE_SUB(@end_d,INTERVAL 0 MONTH);

#4
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',4)
WHERE  t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 4 MONTH) AND DATE_SUB(@end_d,INTERVAL 4 MONTH);

#5
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',5)
WHERE  t.birth BETWEEN DATE_SUB(@start_d,INTERVAL 5 YEAR) AND DATE_SUB(@end_d,INTERVAL 0 YEAR);

#6
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',6)
WHERE  t.birth > DATE_SUB(@start_d,INTERVAL 7 YEAR);

#7
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',7)
WHERE  t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 1 YEAR) AND DATE_SUB(@end_d,INTERVAL 1 YEAR);

#8
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',8)
WHERE  t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 2 YEAR) AND DATE_SUB(@end_d,INTERVAL 2 YEAR);

#9
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',9)
WHERE  t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 3 YEAR) AND DATE_SUB(@end_d,INTERVAL 3 YEAR);

#10
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',10)
WHERE  t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 5 YEAR) AND DATE_SUB(@end_d,INTERVAL 5 YEAR);

#11
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',11)
WHERE   t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 12 YEAR) AND DATE_SUB(@end_d,INTERVAL 6 YEAR);

#12
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',12)
WHERE   t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 7 YEAR) AND DATE_SUB(@end_d,INTERVAL 7 YEAR);

#13
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',13)
WHERE   t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 8 YEAR) AND DATE_SUB(@end_d,INTERVAL 8 YEAR);

#14
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',14)
WHERE   t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 12 YEAR) AND DATE_SUB(@end_d,INTERVAL 12 YEAR);

#15
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',15)
WHERE   t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 12 YEAR) AND DATE_SUB(@end_d,INTERVAL 6 YEAR);

#16
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',16)
WHERE   t.birth >  DATE_SUB(@start_d,INTERVAL 12 YEAR);

#17
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',17)
WHERE   t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 18 YEAR) AND DATE_SUB(@end_d,INTERVAL 18 YEAR);

#18
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',18)
WHERE   t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 19 YEAR) AND DATE_SUB(@end_d,INTERVAL 15 YEAR)
AND t.sex=2;

#19
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',19)
WHERE   t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 20 YEAR) AND DATE_SUB(@end_d,INTERVAL 15 YEAR)
AND t.sex=2;

#20
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',20)
WHERE   t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 60 YEAR) AND DATE_SUB(@end_d,INTERVAL 30 YEAR)
AND t.sex=2;

#21
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',21)
WHERE   t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 70 YEAR) AND DATE_SUB(@end_d,INTERVAL 30 YEAR)
AND t.sex=2;

#22
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',22)
WHERE   t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 120 YEAR) AND DATE_SUB(@end_d,INTERVAL 35 YEAR);

#23
UPDATE tst_pop t,(
SELECT o.CID,d.codemental FROM tmp_diag_opd o, cdisease d WHERE o.diagcode= d.diagcode AND d.codemental is not NULL
) a SET t.pop_group = CONCAT(t.pop_group,',',23)
WHERE t.cid = a.CID;

#24
UPDATE tst_pop t,(
SELECT t.cid from t_dmht t WHERE  FIND_IN_SET('E',t.t_mix_dx) AND NOT FIND_IN_SET('I',t.t_mix_dx)
) a SET t.pop_group = CONCAT(t.pop_group,',',24)
WHERE t.cid = a.CID;

#25
UPDATE tst_pop t,(
SELECT t.cid from t_dmht t WHERE  FIND_IN_SET('I',t.t_mix_dx) AND NOT FIND_IN_SET('E',t.t_mix_dx)
) a SET t.pop_group = CONCAT(t.pop_group,',',25)
WHERE t.cid = a.CID;

#26
UPDATE tst_pop t,(
SELECT t.cid from t_dmht t WHERE  FIND_IN_SET('E',t.t_mix_dx) AND  FIND_IN_SET('I',t.t_mix_dx)
) a SET t.pop_group = CONCAT(t.pop_group,',',26)
WHERE t.cid = a.CID;

#27
UPDATE tst_pop t SET t.pop_group = CONCAT(t.pop_group,',',27)
WHERE   t.birth BETWEEN  DATE_SUB(@start_d,INTERVAL 120 YEAR) AND DATE_SUB(@end_d,INTERVAL 60 YEAR);

#28
UPDATE tst_pop t,(

SELECT t.HOSPCODE,t.PID,p.CID from disability t
LEFT JOIN t_person_cid p on p.HOSPCODE = t.HOSPCODE AND p.PID = t.PID

) a SET t.pop_group = CONCAT(t.pop_group,',',28)
WHERE t.cid = a.CID;
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.427866;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:475;a:5:{i:0;s:43:"DROP PROCEDURE IF EXISTS tst_add_cid_to_kpi";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.427866;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:476;a:5:{i:0;s:43:"DROP PROCEDURE IF EXISTS tst_add_cid_to_kpi";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.4902661;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:478;a:5:{i:0;s:12947:"CREATE PROCEDURE tst_add_cid_to_kpi()
 BEGIN 
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

#1
DROP TABLE IF EXISTS tst_kpi1;
CREATE TABLE tst_kpi1 (
SELECT @b_year+543 as byear,l.cid ,CURDATE() dupdate
FROM	tmp_labor l  INNER JOIN t_person_anc a ON l.cid=a.cid AND l.bdate =a.bdate AND a.g1_ga <=12
WHERE l.BDATE BETWEEN @start_d AND @end_d  GROUP BY l.cid
);

#2
DROP TABLE IF EXISTS tst_kpi2;
CREATE TABLE tst_kpi2 (
SELECT @b_year+543 as byear,l.cid ,CURDATE() dupdate
FROM	tmp_labor l  INNER JOIN t_person_anc a ON l.cid=a.cid AND l.bdate =a.bdate 
AND a.g1_date is not null AND a.g2_date is not null AND a.g3_date is not null 
AND a.g4_date is not null AND a.g5_date is not null
WHERE l.BDATE BETWEEN @start_d AND @end_d  GROUP BY l.cid
);

#3
DROP TABLE IF EXISTS tst_kpi3;
CREATE TABLE tst_kpi3 (
SELECT @b_year+543 as byear,a.cid ,CURDATE() dupdate
FROM tmp_anc a 
INNER JOIN tmp_drug_opd d on a.cid = d.CID 
AND d.DIDSTD in('201120320037726221781506','201110100019999920381199','101110000003082121781506'
,'201110100019999920381341','201110100019999921881341')
WHERE a.DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY a.cid
);

#4
DROP TABLE IF EXISTS tst_kpi4;
CREATE TABLE tst_kpi4 (
SELECT @b_year+543 as byear,'' cid ,CURDATE() dupdate
);

#5
DROP TABLE IF EXISTS tst_kpi5;
CREATE TABLE tst_kpi5 (
SELECT @b_year+543 as byear,p.cid ,CURDATE() dupdate
FROM prenatal t 
INNER JOIN t_person_cid p ON p.hospcode = t.hospcode AND p.pid = t.pid
WHERE t.HCT_RESULT <= 33  AND t.DATE_HCT BETWEEN @start_d AND @end_d
GROUP BY p.CID
);

#6
DROP TABLE IF EXISTS tst_kpi6;
CREATE TABLE tst_kpi6 (
SELECT @b_year+543 as byear,a.cid ,CURDATE() dupdate
FROM  t_postnatal a 
INNER JOIN tmp_labor l on l.cid = a.cid AND l.BDATE BETWEEN @start_d AND @end_d AND l.BTYPE NOT IN(6)
WHERE a.ppcare1 is not null AND a.ppcare2 is not null AND a.ppcare3 is not null 
GROUP BY l.cid
);

#7
DROP TABLE IF EXISTS tst_kpi7;
CREATE TABLE tst_kpi7 (
SELECT @b_year+543 as byear,t.cid ,CURDATE() dupdate
FROM (
SELECT n.HOSPCODE,n.PID,p.CID,p.BIRTH,n.DATE_SERV,n.FOOD,DATE_FORMAT(n.DATE_SERV,'%m') m
FROM nutrition n INNER JOIN person p ON n.HOSPCODE=p.HOSPCODE AND n.PID=p.PID 
WHERE n.DATE_SERV BETWEEN @start_d AND @end_d AND n.FOOD in('1')
GROUP BY n.HOSPCODE,n.PID
HAVING TIMESTAMPDIFF(MONTH,p.BIRTH,n.DATE_SERV) BETWEEN 0 AND 6 
ORDER BY n.DATE_SERV DESC
) t GROUP BY t.CID
);

#8
DROP TABLE IF EXISTS tst_kpi8;
CREATE TABLE tst_kpi8 (
SELECT @b_year+543 as byear,e.cid ,CURDATE() dupdate
FROM tmp_epi e WHERE e.VACCINETYPE in('401')
AND e.DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY e.cid
);

#9
DROP TABLE IF EXISTS tst_kpi9;
CREATE TABLE tst_kpi9 (
SELECT @b_year+543 as byear,t.cid ,CURDATE() dupdate
FROM t_childdev_specialpp t WHERE (INSTR(t.status1,'1') or INSTR(t.status2,'1'))
AND t.date_serv_first BETWEEN @start_d AND @end_d 
GROUP BY t.cid

);

#10
DROP TABLE IF EXISTS tst_kpi10;
CREATE TABLE tst_kpi10 (
SELECT @b_year+543 as byear,p.cid ,CURDATE() dupdate
FROM t_nutrition_service n 
INNER JOIN t_person_cid p ON p.HOSPCODE = n.hospcode AND p.PID = n.pid
WHERE TIMESTAMPDIFF(YEAR,n.birth,n.DATE_SERV) <= 5
AND nutri2 in(3,4,5) AND nutri3 in(3)
);

#11
DROP TABLE IF EXISTS tst_kpi11;
CREATE TABLE tst_kpi11 (
SELECT @b_year+543 as byear,t.cid ,CURDATE() dupdate
FROM t_childdev_specialpp t 
WHERE t.sp_first ='1B261'
AND t.status2 is not NULL AND t.date_serv_first BETWEEN @start_d AND @end_d 
);

#12
DROP TABLE IF EXISTS tst_kpi12;
CREATE TABLE tst_kpi12 (
SELECT @b_year+543 as byear,n.cid ,CURDATE() dupdate
from t_nutrition05 n
WHERE n.DATE_SERV1  BETWEEN @start_d AND @end_d 
);

#13
DROP TABLE IF EXISTS tst_kpi13;
CREATE TABLE tst_kpi13 (
SELECT @b_year+543 as byear,'' cid ,CURDATE() dupdate
);

#14
DROP TABLE IF EXISTS tst_kpi14;
CREATE TABLE tst_kpi14 (
SELECT @b_year+543 as byear,t1.cid ,CURDATE() dupdate
FROM t_person_epi t1
WHERE t1.bcg_date is not null AND t1.hbv1_date is not null AND t1.opv3_date is not null AND t1.dtp3_date is not null 
AND t1.mmr1_date is not null AND t1.hbv3_date is not null AND t1.ipv2_date is not null
);

#15
DROP TABLE IF EXISTS tst_kpi15;
CREATE TABLE tst_kpi15 (
SELECT @b_year+543 as byear,t1.cid ,CURDATE() dupdate
 FROM t_person_epi t1
WHERE t1.dtp4_date is not null AND t1.opv4_date is not null 
AND ((je1_date is not null and je2_date is not null and je2_date > je1_date) or (j11_date is not null)) 
);

#16
DROP TABLE IF EXISTS tst_kpi16;
CREATE TABLE tst_kpi16 (
SELECT @b_year+543 as byear,t1.cid ,CURDATE() dupdate
 FROM t_person_epi t1
WHERE t1.mmr2_date is not null 
AND ((je1_date is not null AND je2_date is not null AND je3_date is not null 
AND je3_date > je2_date AND je2_date > je1_date)
or (je1_date is not null AND je2_date is not null AND j11_date is not null AND je2_date > je1_date AND j11_date > je2_date)
or (j11_date is not null AND j12_date is not null AND j12_date > j11_date)
or (j11_date is not null AND je1_date is not null AND je1_date > j11_date ))
);

#17
DROP TABLE IF EXISTS tst_kpi17;
CREATE TABLE tst_kpi17 (
SELECT @b_year+543 as byear,t1.cid ,CURDATE() dupdate
 FROM t_person_epi t1
WHERE t1.opv5_date is not null AND t1.dtp5_date is not null 
);

#18
DROP TABLE IF EXISTS tst_kpi18;
CREATE TABLE tst_kpi18 (
SELECT @b_year+543 as byear,p.cid ,CURDATE() dupdate
FROM t_nutrition_service n
INNER JOIN t_person_cid p on p.HOSPCODE= n.hospcode AND p.PID = n.pid
WHERE n.nutri3 in (6)
);

#19
DROP TABLE IF EXISTS tst_kpi19;
CREATE TABLE tst_kpi19 (
SELECT @b_year+543 as byear,p.cid ,CURDATE() dupdate
FROM t_nutrition_service n
INNER JOIN t_person_cid p on p.HOSPCODE= n.hospcode AND p.PID = n.pid
WHERE  nutri2 in(3,4,5) AND nutri3 in(3)

);

#20
DROP TABLE IF EXISTS tst_kpi20;
CREATE TABLE tst_kpi20 (
SELECT @b_year+543 as byear,p.cid ,CURDATE() dupdate
from dental t
INNER JOIN t_person_cid p on p.HOSPCODE = t.HOSPCODE AND p.PID = t.PID
WHERE t.DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY p.CID
);

#21
DROP TABLE IF EXISTS tst_kpi21;
CREATE TABLE tst_kpi21 (
SELECT @b_year+543 as byear,p.cid ,CURDATE() dupdate
FROM procedure_opd t
INNER JOIN t_person_cid p on p.HOSPCODE = t.HOSPCODE AND p.PID = t.PID
WHERE t.DATE_SERV BETWEEN @start_d AND @end_d  
AND t.PROCEDCODE = '2387030'
GROUP BY p.CID
);

#22
DROP TABLE IF EXISTS tst_kpi22;
CREATE TABLE tst_kpi22 (
SELECT @b_year+543 as byear,t1.cid ,CURDATE() dupdate
FROM t_person_epi t1
WHERE t1.mmrs_date IS NOT NULL
);

#23
DROP TABLE IF EXISTS tst_kpi23;
CREATE TABLE tst_kpi23(
SELECT @b_year+543 as byear,'' cid ,CURDATE() dupdate

);

#24
DROP TABLE IF EXISTS tst_kpi24;
CREATE TABLE tst_kpi24(
SELECT @b_year+543 as byear,t1.cid ,CURDATE() dupdate
FROM t_person_epi t1
WHERE t1.dts4_date IS NOT NULL
);

#25
DROP TABLE IF EXISTS tst_kpi25;
CREATE TABLE tst_kpi25(
SELECT @b_year+543 as byear,p.cid ,CURDATE() dupdate
FROM tmp_procedure_opd p
INNER JOIN cwh_dent_icd10tm i ON p.PROCEDCODE=i.ICD10TM 
WHERE DATE_SERV BETWEEN @start_d AND @end_d AND p.CID is not NULL
GROUP BY p.CID 
);

#26
DROP TABLE IF EXISTS tst_kpi26;
CREATE TABLE tst_kpi26(
SELECT @b_year+543 as byear,t.cid ,CURDATE() dupdate
from tmp_diag_opd t WHERE t.DIAGCODE LIKE 'K02%'
AND DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY t.CID
);

#27
DROP TABLE IF EXISTS tst_kpi27;
CREATE TABLE tst_kpi27(
SELECT @b_year+543 as byear,cid ,CURDATE() dupdate
from t_nutrition6up n
WHERE age_ms1 BETWEEN 72 AND 228
AND DATE_SERV1 BETWEEN @start_d AND @end_d
GROUP BY CID
);

#28
DROP TABLE IF EXISTS tst_kpi28;
CREATE TABLE tst_kpi28(
SELECT @b_year+543 as byear,'' cid ,CURDATE() dupdate

);

#29
DROP TABLE IF EXISTS tst_kpi29;
CREATE TABLE tst_kpi29(
SELECT @b_year+543 as byear,'' cid ,CURDATE() dupdate

);

#30
DROP TABLE IF EXISTS tst_kpi30;
CREATE TABLE tst_kpi30(
SELECT @b_year+543 as byear,cid ,CURDATE() dupdate
from (
SELECT d.HOSPCODE,d.PID,d.DIAGCODE,d.DATE_SERV from diagnosis_opd d WHERE LEFT(d.DIAGCODE,4) in ('Z014','Z124') 
AND d.DATE_SERV  BETWEEN DATE_SUB(@start_d,INTERVAL 5 YEAR) AND DATE_SUB(@end_d,INTERVAL 0 YEAR)
) t  INNER JOIN t_person_cid p ON p.HOSPCODE = t.hospcode AND p.PID = t.pid
GROUP BY p.CID
);

#31
DROP TABLE IF EXISTS tst_kpi31;
CREATE TABLE tst_kpi31(
SELECT @b_year+543 as byear,cid ,CURDATE() dupdate
 from (
SELECT d.HOSPCODE,d.PID,d.DIAGCODE,d.DATE_SERV from diagnosis_opd d WHERE LEFT(d.DIAGCODE,4) in ('Z123') 
AND d.DATE_SERV  BETWEEN DATE_SUB(@start_d,INTERVAL 0 YEAR) AND DATE_SUB(@end_d,INTERVAL 0 YEAR)
) t  INNER JOIN t_person_cid p ON p.HOSPCODE = t.hospcode AND p.PID = t.pid
GROUP BY p.CID
);

#32
DROP TABLE IF EXISTS tst_kpi32;
CREATE TABLE tst_kpi32(
SELECT @b_year+543 as byear,cid ,CURDATE() dupdate
from (
SELECT p.HOSPCODE,p.PID,p.CID,p.SEX,n.DATE_SERV,round(n.WAIST_CM) WAIST_CM
,n.WEIGHT,n.HEIGHT,round(n.WEIGHT/((n.HEIGHT/100)*(n.HEIGHT/100)),2) bmi
,if(p.sex='1' AND round(n.WAIST_CM)<=90,1,if(p.sex='2' AND round(n.WAIST_CM)<=80,1,0)) fat
,DATE_FORMAT(n.DATE_SERV,'%m') m
FROM t_ncdscreen n 
INNER JOIN t_person_db p ON n.HOSPCODE=p.HOSPCODE AND n.PID=p.PID 
WHERE 
n.DATE_SERV BETWEEN @start_d AND @end_d 
AND TIMESTAMPDIFF(YEAR,p.BIRTH,n.DATE_SERV)>=35 
GROUP BY p.HOSPCODE,p.PID 
HAVING fat=1
ORDER BY n.DATE_SERV
) t GROUP BY cid
);

#33
DROP TABLE IF EXISTS tst_kpi33;
CREATE TABLE tst_kpi33(
SELECT @b_year+543 as byear,cid ,CURDATE() dupdate
FROM t_person_dm_screen 
WHERE date_screen is not null AND bslevel >70
AND date_screen BETWEEN @start_d AND @end_d
GROUP BY cid
);

#34
DROP TABLE IF EXISTS tst_kpi34;
CREATE TABLE tst_kpi34(
SELECT @b_year+543 as byear,cid ,CURDATE() dupdate
FROM t_person_ht_screen   
WHERE sbp_1>50 AND dbp_1 >50
AND date_screen BETWEEN @start_d AND @end_d
GROUP BY cid
);

#35
DROP TABLE IF EXISTS tst_kpi35;
CREATE TABLE tst_kpi35(
SELECT @b_year+543 as byear,t.cid ,CURDATE() dupdate
FROM tst_pop t 
INNER JOIN tmp_diag_opd d on d.CID = t.cid  AND d.DATE_SERV BETWEEN @start_d AND @end_d
INNER JOIN cdisease c ON d.DIAGCODE = c.diagcode AND c.codemental IS NOT NULL
WHERE FIND_IN_SET('23',t.pop_group)
GROUP BY t.cid
);


#36
DROP TABLE IF EXISTS tst_kpi36;
CREATE TABLE tst_kpi36(
SELECT @b_year+543 as byear,t.cid ,CURDATE() dupdate
from t_chronic t
WHERE date_dx BETWEEN @start_d AND @end_d
AND t.diagcode LIKE 'E%'
GROUP BY t.cid
);

#37
DROP TABLE IF EXISTS tst_kpi37;
CREATE TABLE tst_kpi37(
SELECT @b_year+543 as byear,f.cid ,CURDATE() dupdate
FROM t_chronicfu f 
INNER JOIN t_dmht d ON f.cid=d.cid
WHERE  f.control_dm IN(1) AND f.ld_hba1c BETWEEN @start_d AND @end_d
GROUP BY f.cid
);

#38
DROP TABLE IF EXISTS tst_kpi38;
CREATE TABLE tst_kpi38(
SELECT @b_year+543 as byear,p.cid ,CURDATE() dupdate
FROM tmp_procedure_opd p
INNER JOIN cwh_dent_icd10tm i ON p.PROCEDCODE=i.ICD10TM 
INNER JOIN tst_pop tp ON tp.cid = p.CID AND  FIND_IN_SET('24',tp.pop_group)
WHERE DATE_SERV BETWEEN @start_d AND @end_d AND p.CID is not NULL
GROUP BY p.CID 
);

#39
DROP TABLE IF EXISTS tst_kpi39;
CREATE TABLE tst_kpi39(
SELECT @b_year+543 as byear,t.cid ,CURDATE() dupdate
 FROM t_chronicfu t
INNER JOIN tst_pop p ON p.cid = t.cid AND FIND_IN_SET('24',p.pop_group)
AND t.ld_foot BETWEEN @start_d AND @end_d
GROUP BY t.cid
);


#40
DROP TABLE IF EXISTS tst_kpi40;
CREATE TABLE tst_kpi40(
SELECT @b_year+543 as byear,t.cid ,CURDATE() dupdate
FROM t_chronicfu t
INNER JOIN tst_pop p ON p.cid = t.cid AND FIND_IN_SET('24',p.pop_group)
AND t.ld_retina BETWEEN @start_d AND @end_d
GROUP BY t.cid
);

#41
DROP TABLE IF EXISTS tst_kpi41;
CREATE TABLE tst_kpi41(
SELECT @b_year+543 as byear,t.cid ,CURDATE() dupdate
from t_chronic t
WHERE date_dx BETWEEN @start_d AND @end_d
AND t.diagcode LIKE 'I%'
GROUP BY t.cid
);

#42
DROP TABLE IF EXISTS tst_kpi42;
CREATE TABLE tst_kpi42(
SELECT @b_year+543 as byear,f.cid ,CURDATE() dupdate
FROM t_chronicfu f 
INNER JOIN t_dmht d ON f.cid=d.cid
WHERE  f.control_ht IN(1) AND f.ld_bp1 BETWEEN @start_d AND @end_d
GROUP BY f.cid
);

#43
DROP TABLE IF EXISTS tst_kpi43;
CREATE TABLE tst_kpi43(
SELECT @b_year+543 as byear,t.CID ,CURDATE() dupdate

from t_cvdrisk_fl t WHERE t.L_RISK_SCORE > 0
GROUP BY t.CID

);

#44
DROP TABLE IF EXISTS tst_kpi44;
CREATE TABLE tst_kpi44(
SELECT @b_year+543 as byear,t.CID ,CURDATE() dupdate
FROM t_adl_last_regist t
WHERE t.DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY t.CID

);

#45
DROP TABLE IF EXISTS tst_kpi45;
CREATE TABLE tst_kpi45(
SELECT @b_year+543 as byear,''CID ,CURDATE() dupdate


);

#46
DROP TABLE IF EXISTS tst_kpi46;
CREATE TABLE tst_kpi46(
SELECT @b_year+543 as byear,'' CID ,CURDATE() dupdate


);
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.4902661;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:479;a:5:{i:0;s:12947:"CREATE PROCEDURE tst_add_cid_to_kpi()
 BEGIN 
SET	@b_year:=(SELECT yearprocess FROM sys_config LIMIT 1);
SET	@start_d:=concat(@b_year-1,'1001');
SET @end_d:=concat(@b_year,'0930');

#1
DROP TABLE IF EXISTS tst_kpi1;
CREATE TABLE tst_kpi1 (
SELECT @b_year+543 as byear,l.cid ,CURDATE() dupdate
FROM	tmp_labor l  INNER JOIN t_person_anc a ON l.cid=a.cid AND l.bdate =a.bdate AND a.g1_ga <=12
WHERE l.BDATE BETWEEN @start_d AND @end_d  GROUP BY l.cid
);

#2
DROP TABLE IF EXISTS tst_kpi2;
CREATE TABLE tst_kpi2 (
SELECT @b_year+543 as byear,l.cid ,CURDATE() dupdate
FROM	tmp_labor l  INNER JOIN t_person_anc a ON l.cid=a.cid AND l.bdate =a.bdate 
AND a.g1_date is not null AND a.g2_date is not null AND a.g3_date is not null 
AND a.g4_date is not null AND a.g5_date is not null
WHERE l.BDATE BETWEEN @start_d AND @end_d  GROUP BY l.cid
);

#3
DROP TABLE IF EXISTS tst_kpi3;
CREATE TABLE tst_kpi3 (
SELECT @b_year+543 as byear,a.cid ,CURDATE() dupdate
FROM tmp_anc a 
INNER JOIN tmp_drug_opd d on a.cid = d.CID 
AND d.DIDSTD in('201120320037726221781506','201110100019999920381199','101110000003082121781506'
,'201110100019999920381341','201110100019999921881341')
WHERE a.DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY a.cid
);

#4
DROP TABLE IF EXISTS tst_kpi4;
CREATE TABLE tst_kpi4 (
SELECT @b_year+543 as byear,'' cid ,CURDATE() dupdate
);

#5
DROP TABLE IF EXISTS tst_kpi5;
CREATE TABLE tst_kpi5 (
SELECT @b_year+543 as byear,p.cid ,CURDATE() dupdate
FROM prenatal t 
INNER JOIN t_person_cid p ON p.hospcode = t.hospcode AND p.pid = t.pid
WHERE t.HCT_RESULT <= 33  AND t.DATE_HCT BETWEEN @start_d AND @end_d
GROUP BY p.CID
);

#6
DROP TABLE IF EXISTS tst_kpi6;
CREATE TABLE tst_kpi6 (
SELECT @b_year+543 as byear,a.cid ,CURDATE() dupdate
FROM  t_postnatal a 
INNER JOIN tmp_labor l on l.cid = a.cid AND l.BDATE BETWEEN @start_d AND @end_d AND l.BTYPE NOT IN(6)
WHERE a.ppcare1 is not null AND a.ppcare2 is not null AND a.ppcare3 is not null 
GROUP BY l.cid
);

#7
DROP TABLE IF EXISTS tst_kpi7;
CREATE TABLE tst_kpi7 (
SELECT @b_year+543 as byear,t.cid ,CURDATE() dupdate
FROM (
SELECT n.HOSPCODE,n.PID,p.CID,p.BIRTH,n.DATE_SERV,n.FOOD,DATE_FORMAT(n.DATE_SERV,'%m') m
FROM nutrition n INNER JOIN person p ON n.HOSPCODE=p.HOSPCODE AND n.PID=p.PID 
WHERE n.DATE_SERV BETWEEN @start_d AND @end_d AND n.FOOD in('1')
GROUP BY n.HOSPCODE,n.PID
HAVING TIMESTAMPDIFF(MONTH,p.BIRTH,n.DATE_SERV) BETWEEN 0 AND 6 
ORDER BY n.DATE_SERV DESC
) t GROUP BY t.CID
);

#8
DROP TABLE IF EXISTS tst_kpi8;
CREATE TABLE tst_kpi8 (
SELECT @b_year+543 as byear,e.cid ,CURDATE() dupdate
FROM tmp_epi e WHERE e.VACCINETYPE in('401')
AND e.DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY e.cid
);

#9
DROP TABLE IF EXISTS tst_kpi9;
CREATE TABLE tst_kpi9 (
SELECT @b_year+543 as byear,t.cid ,CURDATE() dupdate
FROM t_childdev_specialpp t WHERE (INSTR(t.status1,'1') or INSTR(t.status2,'1'))
AND t.date_serv_first BETWEEN @start_d AND @end_d 
GROUP BY t.cid

);

#10
DROP TABLE IF EXISTS tst_kpi10;
CREATE TABLE tst_kpi10 (
SELECT @b_year+543 as byear,p.cid ,CURDATE() dupdate
FROM t_nutrition_service n 
INNER JOIN t_person_cid p ON p.HOSPCODE = n.hospcode AND p.PID = n.pid
WHERE TIMESTAMPDIFF(YEAR,n.birth,n.DATE_SERV) <= 5
AND nutri2 in(3,4,5) AND nutri3 in(3)
);

#11
DROP TABLE IF EXISTS tst_kpi11;
CREATE TABLE tst_kpi11 (
SELECT @b_year+543 as byear,t.cid ,CURDATE() dupdate
FROM t_childdev_specialpp t 
WHERE t.sp_first ='1B261'
AND t.status2 is not NULL AND t.date_serv_first BETWEEN @start_d AND @end_d 
);

#12
DROP TABLE IF EXISTS tst_kpi12;
CREATE TABLE tst_kpi12 (
SELECT @b_year+543 as byear,n.cid ,CURDATE() dupdate
from t_nutrition05 n
WHERE n.DATE_SERV1  BETWEEN @start_d AND @end_d 
);

#13
DROP TABLE IF EXISTS tst_kpi13;
CREATE TABLE tst_kpi13 (
SELECT @b_year+543 as byear,'' cid ,CURDATE() dupdate
);

#14
DROP TABLE IF EXISTS tst_kpi14;
CREATE TABLE tst_kpi14 (
SELECT @b_year+543 as byear,t1.cid ,CURDATE() dupdate
FROM t_person_epi t1
WHERE t1.bcg_date is not null AND t1.hbv1_date is not null AND t1.opv3_date is not null AND t1.dtp3_date is not null 
AND t1.mmr1_date is not null AND t1.hbv3_date is not null AND t1.ipv2_date is not null
);

#15
DROP TABLE IF EXISTS tst_kpi15;
CREATE TABLE tst_kpi15 (
SELECT @b_year+543 as byear,t1.cid ,CURDATE() dupdate
 FROM t_person_epi t1
WHERE t1.dtp4_date is not null AND t1.opv4_date is not null 
AND ((je1_date is not null and je2_date is not null and je2_date > je1_date) or (j11_date is not null)) 
);

#16
DROP TABLE IF EXISTS tst_kpi16;
CREATE TABLE tst_kpi16 (
SELECT @b_year+543 as byear,t1.cid ,CURDATE() dupdate
 FROM t_person_epi t1
WHERE t1.mmr2_date is not null 
AND ((je1_date is not null AND je2_date is not null AND je3_date is not null 
AND je3_date > je2_date AND je2_date > je1_date)
or (je1_date is not null AND je2_date is not null AND j11_date is not null AND je2_date > je1_date AND j11_date > je2_date)
or (j11_date is not null AND j12_date is not null AND j12_date > j11_date)
or (j11_date is not null AND je1_date is not null AND je1_date > j11_date ))
);

#17
DROP TABLE IF EXISTS tst_kpi17;
CREATE TABLE tst_kpi17 (
SELECT @b_year+543 as byear,t1.cid ,CURDATE() dupdate
 FROM t_person_epi t1
WHERE t1.opv5_date is not null AND t1.dtp5_date is not null 
);

#18
DROP TABLE IF EXISTS tst_kpi18;
CREATE TABLE tst_kpi18 (
SELECT @b_year+543 as byear,p.cid ,CURDATE() dupdate
FROM t_nutrition_service n
INNER JOIN t_person_cid p on p.HOSPCODE= n.hospcode AND p.PID = n.pid
WHERE n.nutri3 in (6)
);

#19
DROP TABLE IF EXISTS tst_kpi19;
CREATE TABLE tst_kpi19 (
SELECT @b_year+543 as byear,p.cid ,CURDATE() dupdate
FROM t_nutrition_service n
INNER JOIN t_person_cid p on p.HOSPCODE= n.hospcode AND p.PID = n.pid
WHERE  nutri2 in(3,4,5) AND nutri3 in(3)

);

#20
DROP TABLE IF EXISTS tst_kpi20;
CREATE TABLE tst_kpi20 (
SELECT @b_year+543 as byear,p.cid ,CURDATE() dupdate
from dental t
INNER JOIN t_person_cid p on p.HOSPCODE = t.HOSPCODE AND p.PID = t.PID
WHERE t.DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY p.CID
);

#21
DROP TABLE IF EXISTS tst_kpi21;
CREATE TABLE tst_kpi21 (
SELECT @b_year+543 as byear,p.cid ,CURDATE() dupdate
FROM procedure_opd t
INNER JOIN t_person_cid p on p.HOSPCODE = t.HOSPCODE AND p.PID = t.PID
WHERE t.DATE_SERV BETWEEN @start_d AND @end_d  
AND t.PROCEDCODE = '2387030'
GROUP BY p.CID
);

#22
DROP TABLE IF EXISTS tst_kpi22;
CREATE TABLE tst_kpi22 (
SELECT @b_year+543 as byear,t1.cid ,CURDATE() dupdate
FROM t_person_epi t1
WHERE t1.mmrs_date IS NOT NULL
);

#23
DROP TABLE IF EXISTS tst_kpi23;
CREATE TABLE tst_kpi23(
SELECT @b_year+543 as byear,'' cid ,CURDATE() dupdate

);

#24
DROP TABLE IF EXISTS tst_kpi24;
CREATE TABLE tst_kpi24(
SELECT @b_year+543 as byear,t1.cid ,CURDATE() dupdate
FROM t_person_epi t1
WHERE t1.dts4_date IS NOT NULL
);

#25
DROP TABLE IF EXISTS tst_kpi25;
CREATE TABLE tst_kpi25(
SELECT @b_year+543 as byear,p.cid ,CURDATE() dupdate
FROM tmp_procedure_opd p
INNER JOIN cwh_dent_icd10tm i ON p.PROCEDCODE=i.ICD10TM 
WHERE DATE_SERV BETWEEN @start_d AND @end_d AND p.CID is not NULL
GROUP BY p.CID 
);

#26
DROP TABLE IF EXISTS tst_kpi26;
CREATE TABLE tst_kpi26(
SELECT @b_year+543 as byear,t.cid ,CURDATE() dupdate
from tmp_diag_opd t WHERE t.DIAGCODE LIKE 'K02%'
AND DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY t.CID
);

#27
DROP TABLE IF EXISTS tst_kpi27;
CREATE TABLE tst_kpi27(
SELECT @b_year+543 as byear,cid ,CURDATE() dupdate
from t_nutrition6up n
WHERE age_ms1 BETWEEN 72 AND 228
AND DATE_SERV1 BETWEEN @start_d AND @end_d
GROUP BY CID
);

#28
DROP TABLE IF EXISTS tst_kpi28;
CREATE TABLE tst_kpi28(
SELECT @b_year+543 as byear,'' cid ,CURDATE() dupdate

);

#29
DROP TABLE IF EXISTS tst_kpi29;
CREATE TABLE tst_kpi29(
SELECT @b_year+543 as byear,'' cid ,CURDATE() dupdate

);

#30
DROP TABLE IF EXISTS tst_kpi30;
CREATE TABLE tst_kpi30(
SELECT @b_year+543 as byear,cid ,CURDATE() dupdate
from (
SELECT d.HOSPCODE,d.PID,d.DIAGCODE,d.DATE_SERV from diagnosis_opd d WHERE LEFT(d.DIAGCODE,4) in ('Z014','Z124') 
AND d.DATE_SERV  BETWEEN DATE_SUB(@start_d,INTERVAL 5 YEAR) AND DATE_SUB(@end_d,INTERVAL 0 YEAR)
) t  INNER JOIN t_person_cid p ON p.HOSPCODE = t.hospcode AND p.PID = t.pid
GROUP BY p.CID
);

#31
DROP TABLE IF EXISTS tst_kpi31;
CREATE TABLE tst_kpi31(
SELECT @b_year+543 as byear,cid ,CURDATE() dupdate
 from (
SELECT d.HOSPCODE,d.PID,d.DIAGCODE,d.DATE_SERV from diagnosis_opd d WHERE LEFT(d.DIAGCODE,4) in ('Z123') 
AND d.DATE_SERV  BETWEEN DATE_SUB(@start_d,INTERVAL 0 YEAR) AND DATE_SUB(@end_d,INTERVAL 0 YEAR)
) t  INNER JOIN t_person_cid p ON p.HOSPCODE = t.hospcode AND p.PID = t.pid
GROUP BY p.CID
);

#32
DROP TABLE IF EXISTS tst_kpi32;
CREATE TABLE tst_kpi32(
SELECT @b_year+543 as byear,cid ,CURDATE() dupdate
from (
SELECT p.HOSPCODE,p.PID,p.CID,p.SEX,n.DATE_SERV,round(n.WAIST_CM) WAIST_CM
,n.WEIGHT,n.HEIGHT,round(n.WEIGHT/((n.HEIGHT/100)*(n.HEIGHT/100)),2) bmi
,if(p.sex='1' AND round(n.WAIST_CM)<=90,1,if(p.sex='2' AND round(n.WAIST_CM)<=80,1,0)) fat
,DATE_FORMAT(n.DATE_SERV,'%m') m
FROM t_ncdscreen n 
INNER JOIN t_person_db p ON n.HOSPCODE=p.HOSPCODE AND n.PID=p.PID 
WHERE 
n.DATE_SERV BETWEEN @start_d AND @end_d 
AND TIMESTAMPDIFF(YEAR,p.BIRTH,n.DATE_SERV)>=35 
GROUP BY p.HOSPCODE,p.PID 
HAVING fat=1
ORDER BY n.DATE_SERV
) t GROUP BY cid
);

#33
DROP TABLE IF EXISTS tst_kpi33;
CREATE TABLE tst_kpi33(
SELECT @b_year+543 as byear,cid ,CURDATE() dupdate
FROM t_person_dm_screen 
WHERE date_screen is not null AND bslevel >70
AND date_screen BETWEEN @start_d AND @end_d
GROUP BY cid
);

#34
DROP TABLE IF EXISTS tst_kpi34;
CREATE TABLE tst_kpi34(
SELECT @b_year+543 as byear,cid ,CURDATE() dupdate
FROM t_person_ht_screen   
WHERE sbp_1>50 AND dbp_1 >50
AND date_screen BETWEEN @start_d AND @end_d
GROUP BY cid
);

#35
DROP TABLE IF EXISTS tst_kpi35;
CREATE TABLE tst_kpi35(
SELECT @b_year+543 as byear,t.cid ,CURDATE() dupdate
FROM tst_pop t 
INNER JOIN tmp_diag_opd d on d.CID = t.cid  AND d.DATE_SERV BETWEEN @start_d AND @end_d
INNER JOIN cdisease c ON d.DIAGCODE = c.diagcode AND c.codemental IS NOT NULL
WHERE FIND_IN_SET('23',t.pop_group)
GROUP BY t.cid
);


#36
DROP TABLE IF EXISTS tst_kpi36;
CREATE TABLE tst_kpi36(
SELECT @b_year+543 as byear,t.cid ,CURDATE() dupdate
from t_chronic t
WHERE date_dx BETWEEN @start_d AND @end_d
AND t.diagcode LIKE 'E%'
GROUP BY t.cid
);

#37
DROP TABLE IF EXISTS tst_kpi37;
CREATE TABLE tst_kpi37(
SELECT @b_year+543 as byear,f.cid ,CURDATE() dupdate
FROM t_chronicfu f 
INNER JOIN t_dmht d ON f.cid=d.cid
WHERE  f.control_dm IN(1) AND f.ld_hba1c BETWEEN @start_d AND @end_d
GROUP BY f.cid
);

#38
DROP TABLE IF EXISTS tst_kpi38;
CREATE TABLE tst_kpi38(
SELECT @b_year+543 as byear,p.cid ,CURDATE() dupdate
FROM tmp_procedure_opd p
INNER JOIN cwh_dent_icd10tm i ON p.PROCEDCODE=i.ICD10TM 
INNER JOIN tst_pop tp ON tp.cid = p.CID AND  FIND_IN_SET('24',tp.pop_group)
WHERE DATE_SERV BETWEEN @start_d AND @end_d AND p.CID is not NULL
GROUP BY p.CID 
);

#39
DROP TABLE IF EXISTS tst_kpi39;
CREATE TABLE tst_kpi39(
SELECT @b_year+543 as byear,t.cid ,CURDATE() dupdate
 FROM t_chronicfu t
INNER JOIN tst_pop p ON p.cid = t.cid AND FIND_IN_SET('24',p.pop_group)
AND t.ld_foot BETWEEN @start_d AND @end_d
GROUP BY t.cid
);


#40
DROP TABLE IF EXISTS tst_kpi40;
CREATE TABLE tst_kpi40(
SELECT @b_year+543 as byear,t.cid ,CURDATE() dupdate
FROM t_chronicfu t
INNER JOIN tst_pop p ON p.cid = t.cid AND FIND_IN_SET('24',p.pop_group)
AND t.ld_retina BETWEEN @start_d AND @end_d
GROUP BY t.cid
);

#41
DROP TABLE IF EXISTS tst_kpi41;
CREATE TABLE tst_kpi41(
SELECT @b_year+543 as byear,t.cid ,CURDATE() dupdate
from t_chronic t
WHERE date_dx BETWEEN @start_d AND @end_d
AND t.diagcode LIKE 'I%'
GROUP BY t.cid
);

#42
DROP TABLE IF EXISTS tst_kpi42;
CREATE TABLE tst_kpi42(
SELECT @b_year+543 as byear,f.cid ,CURDATE() dupdate
FROM t_chronicfu f 
INNER JOIN t_dmht d ON f.cid=d.cid
WHERE  f.control_ht IN(1) AND f.ld_bp1 BETWEEN @start_d AND @end_d
GROUP BY f.cid
);

#43
DROP TABLE IF EXISTS tst_kpi43;
CREATE TABLE tst_kpi43(
SELECT @b_year+543 as byear,t.CID ,CURDATE() dupdate

from t_cvdrisk_fl t WHERE t.L_RISK_SCORE > 0
GROUP BY t.CID

);

#44
DROP TABLE IF EXISTS tst_kpi44;
CREATE TABLE tst_kpi44(
SELECT @b_year+543 as byear,t.CID ,CURDATE() dupdate
FROM t_adl_last_regist t
WHERE t.DATE_SERV BETWEEN @start_d AND @end_d
GROUP BY t.CID

);

#45
DROP TABLE IF EXISTS tst_kpi45;
CREATE TABLE tst_kpi45(
SELECT @b_year+543 as byear,''CID ,CURDATE() dupdate


);

#46
DROP TABLE IF EXISTS tst_kpi46;
CREATE TABLE tst_kpi46(
SELECT @b_year+543 as byear,'' CID ,CURDATE() dupdate


);
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.537066;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:481;a:5:{i:0;s:41:"DROP PROCEDURE IF EXISTS t_version_update";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.537066;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:482;a:5:{i:0;s:41:"DROP PROCEDURE IF EXISTS t_version_update";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.5994661;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:124;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:484;a:5:{i:0;s:102:"CREATE PROCEDURE t_version_update()
 BEGIN 
UPDATE sys_version t SET t.version = '2017.01.27';
 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.5994661;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:485;a:5:{i:0;s:102:"CREATE PROCEDURE t_version_update()
 BEGIN 
UPDATE sys_version t SET t.version = '2017.01.27';
 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.646266;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:131;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:487;a:5:{i:0;s:35:"DROP PROCEDURE IF EXISTS hdc_all_t;";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.646266;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:150;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:488;a:5:{i:0;s:35:"DROP PROCEDURE IF EXISTS hdc_all_t;";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.7086661;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:150;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:490;a:5:{i:0;s:6477:"CREATE PROCEDURE hdc_all_t()
 BEGIN
# build at 2017-05-17 09:27:29
CALL start_process;
UPDATE sys_check_process t set t.fnc_name = 'hdc_all_t' , t.time = NOW();
TRUNCATE hdc_log;
INSERT INTO hdc_log(p_date,p_name)values(now(),'start');
#start here

INSERT INTO hdc_log(p_date,p_name)values(now(),'t_person');
CALL t_person;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_person_anc');
CALL t_person_anc;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_person_epi');
CALL t_person_epi;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_village');
CALL t_village;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_surveil');
CALL t_surveil;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_pt_surveil');
CALL t_pt_surveil;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_person_sex_age');
CALL t_person_sex_age;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_diagopd');
CALL t_diagopd;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_diagipd');
CALL t_diagipd;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_chronic');
CALL t_chronic;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_dmht');
CALL t_dmht;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_ncdscreen');
CALL t_ncdscreen;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_service');
CALL t_service;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_admission');
CALL t_admission;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_death');
CALL t_death;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_newborn');
CALL t_newborn;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_card');
CALL t_card;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_drug_opd');
CALL t_drug_opd;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_planthai');
CALL t_planthai;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_planthai1');
CALL t_planthai1;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_cmi1');
CALL t_cmi1;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_bp');
CALL t_bp;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_fp');
CALL t_fp;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_charge_opd');
CALL t_charge_opd;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_nation_labor');
CALL t_nation_labor;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_refer');
CALL t_refer;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_childdev1830');
CALL t_childdev1830;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_cmi_referin');
CALL t_cmi_referin;
INSERT INTO hdc_log(p_date,p_name)values(now(),'ws_person_dmht');
CALL ws_person_dmht;
INSERT INTO hdc_log(p_date,p_name)values(now(),'ws_person_nutrition');
CALL ws_person_nutrition;
INSERT INTO hdc_log(p_date,p_name)values(now(),'ws_person_drugallergy');
CALL ws_person_drugallergy;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_cmi_dead');
CALL t_cmi_dead;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_procedure_ipd');
CALL t_procedure_ipd;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_ckd_ill_all');
CALL t_ckd_ill_all;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_influ');
CALL t_influ;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_ckd_service');
CALL t_ckd_service;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_ckd_egfr');
CALL t_ckd_egfr;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_death_hosp');
CALL t_death_hosp;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_labor_abort');
CALL t_labor_abort;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_nutrition05');
CALL t_nutrition05;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_nutrition6');
CALL t_nutrition6;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_nutrition15');
CALL t_nutrition15;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_tb');
CALL t_tb;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_refer_sp5');
CALL t_refer_sp5;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_accident');
CALL t_accident;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_dental');
CALL t_dental;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_all_alien');
CALL t_all_alien;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_alcoholic');
CALL t_alcoholic;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_envocc');
CALL t_envocc;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_refer_4pa');
CALL t_refer_4pa;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_death28pa');
CALL t_death28pa;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_occupat_new');
CALL t_occupat_new;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_person_envocc');
CALL t_person_envocc;
INSERT INTO hdc_log(p_date,p_name)values(now(),'tmp_specialpp');
CALL tmp_specialpp;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_nutrition_service');
CALL t_nutrition_service;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_cvdrisk');
CALL t_cvdrisk;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_screen_last');
CALL t_screen_last;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_adl');
CALL t_adl;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_postnatal');
CALL t_postnatal;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_cigarette');
CALL t_cigarette;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_breast_screen');
CALL t_breast_screen;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_cervix_screen');
CALL t_cervix_screen;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_ttm1_5');
CALL t_ttm1_5;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_ttm6_10');
CALL t_ttm6_10;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_ttm11_15');
CALL t_ttm11_15;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_ttm16_20');
CALL t_ttm16_20;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_ttm21_25');
CALL t_ttm21_25;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_rdu');
CALL t_rdu;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_person_home');
CALL t_person_home;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_house_gis');
CALL t_house_gis;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_home_gis');
CALL t_home_gis;
INSERT INTO hdc_log(p_date,p_name)values(now(),'tst_pop');
CALL tst_pop;
INSERT INTO hdc_log(p_date,p_name)values(now(),'tst_add_cid_to_kpi');
CALL tst_add_cid_to_kpi;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_version_update');
CALL t_version_update;

#end here
INSERT INTO hdc_log(p_date,p_name)values(now(),'end');
CALL end_process; 

 END";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.7086661;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:151;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:491;a:5:{i:0;s:6477:"CREATE PROCEDURE hdc_all_t()
 BEGIN
# build at 2017-05-17 09:27:29
CALL start_process;
UPDATE sys_check_process t set t.fnc_name = 'hdc_all_t' , t.time = NOW();
TRUNCATE hdc_log;
INSERT INTO hdc_log(p_date,p_name)values(now(),'start');
#start here

INSERT INTO hdc_log(p_date,p_name)values(now(),'t_person');
CALL t_person;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_person_anc');
CALL t_person_anc;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_person_epi');
CALL t_person_epi;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_village');
CALL t_village;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_surveil');
CALL t_surveil;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_pt_surveil');
CALL t_pt_surveil;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_person_sex_age');
CALL t_person_sex_age;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_diagopd');
CALL t_diagopd;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_diagipd');
CALL t_diagipd;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_chronic');
CALL t_chronic;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_dmht');
CALL t_dmht;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_ncdscreen');
CALL t_ncdscreen;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_service');
CALL t_service;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_admission');
CALL t_admission;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_death');
CALL t_death;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_newborn');
CALL t_newborn;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_card');
CALL t_card;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_drug_opd');
CALL t_drug_opd;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_planthai');
CALL t_planthai;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_planthai1');
CALL t_planthai1;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_cmi1');
CALL t_cmi1;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_bp');
CALL t_bp;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_fp');
CALL t_fp;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_charge_opd');
CALL t_charge_opd;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_nation_labor');
CALL t_nation_labor;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_refer');
CALL t_refer;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_childdev1830');
CALL t_childdev1830;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_cmi_referin');
CALL t_cmi_referin;
INSERT INTO hdc_log(p_date,p_name)values(now(),'ws_person_dmht');
CALL ws_person_dmht;
INSERT INTO hdc_log(p_date,p_name)values(now(),'ws_person_nutrition');
CALL ws_person_nutrition;
INSERT INTO hdc_log(p_date,p_name)values(now(),'ws_person_drugallergy');
CALL ws_person_drugallergy;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_cmi_dead');
CALL t_cmi_dead;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_procedure_ipd');
CALL t_procedure_ipd;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_ckd_ill_all');
CALL t_ckd_ill_all;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_influ');
CALL t_influ;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_ckd_service');
CALL t_ckd_service;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_ckd_egfr');
CALL t_ckd_egfr;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_death_hosp');
CALL t_death_hosp;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_labor_abort');
CALL t_labor_abort;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_nutrition05');
CALL t_nutrition05;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_nutrition6');
CALL t_nutrition6;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_nutrition15');
CALL t_nutrition15;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_tb');
CALL t_tb;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_refer_sp5');
CALL t_refer_sp5;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_accident');
CALL t_accident;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_dental');
CALL t_dental;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_all_alien');
CALL t_all_alien;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_alcoholic');
CALL t_alcoholic;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_envocc');
CALL t_envocc;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_refer_4pa');
CALL t_refer_4pa;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_death28pa');
CALL t_death28pa;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_occupat_new');
CALL t_occupat_new;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_person_envocc');
CALL t_person_envocc;
INSERT INTO hdc_log(p_date,p_name)values(now(),'tmp_specialpp');
CALL tmp_specialpp;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_nutrition_service');
CALL t_nutrition_service;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_cvdrisk');
CALL t_cvdrisk;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_screen_last');
CALL t_screen_last;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_adl');
CALL t_adl;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_postnatal');
CALL t_postnatal;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_cigarette');
CALL t_cigarette;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_breast_screen');
CALL t_breast_screen;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_cervix_screen');
CALL t_cervix_screen;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_ttm1_5');
CALL t_ttm1_5;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_ttm6_10');
CALL t_ttm6_10;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_ttm11_15');
CALL t_ttm11_15;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_ttm16_20');
CALL t_ttm16_20;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_ttm21_25');
CALL t_ttm21_25;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_rdu');
CALL t_rdu;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_person_home');
CALL t_person_home;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_house_gis');
CALL t_house_gis;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_home_gis');
CALL t_home_gis;
INSERT INTO hdc_log(p_date,p_name)values(now(),'tst_pop');
CALL tst_pop;
INSERT INTO hdc_log(p_date,p_name)values(now(),'tst_add_cid_to_kpi');
CALL tst_add_cid_to_kpi;
INSERT INTO hdc_log(p_date,p_name)values(now(),'t_version_update');
CALL t_version_update;

#end here
INSERT INTO hdc_log(p_date,p_name)values(now(),'end');
CALL end_process; 

 END";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.755466;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:151;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:493;a:5:{i:0;s:34:"CALL zz_sys_process_running_false;";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.755466;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:152;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:494;a:5:{i:0;s:34:"CALL zz_sys_process_running_false;";i:1;i:96;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988058.755466;i:4;a:3:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:158;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}i:1;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:152;s:8:"function";s:8:"exec_sql";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}i:2;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:44;s:8:"function";s:8:"hdc_init";s:5:"class";s:36:"backend\controllers\HdcsqlController";s:4:"type";s:2:"->";}}}i:496;a:5:{i:0;s:17:"call hdc_all_t();";i:1;i:80;i:2;s:23:"yii\db\Command::execute";i:3;d:1494988063.76948;i:4;a:1:{i:0;a:5:{s:4:"file";s:62:"D:\xampp\htdocs\dhdc2\backend\controllers\HdcsqlController.php";s:4:"line";i:49;s:8:"function";s:7:"execute";s:5:"class";s:14:"yii\db\Command";s:4:"type";s:2:"->";}}}}}s:6:"assets";a:0:{}s:4:"mail";a:0:{}s:8:"timeline";a:2:{s:5:"start";d:1494988044.281805;s:3:"end";d:1494988167.0296879;}s:7:"summary";a:9:{s:3:"tag";s:13:"591bb50c4aa8e";s:3:"url";s:65:"http://localhost:8000/dhdc2/backend/web/index.php?r=hdcsql%2Fexec";s:4:"ajax";i:1;s:6:"method";s:3:"GET";s:2:"ip";s:3:"::1";s:4:"time";i:1494988167;s:10:"statusCode";i:500;s:8:"sqlCount";d:161.5;s:9:"mailCount";i:0;}}